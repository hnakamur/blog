<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Riot.jsでタグエディターのサンプルを作ってみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2015/02/28/riot-tag-editor-example/" rel="bookmark"
           title="Permalink to Riot.jsでタグエディターのサンプルを作ってみた">Riot.jsでタグエディターのサンプルを作ってみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-02-28T21:12:00+09:00">
                Published: 2015-02-28
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/javascript.html">javascript</a> <a href="../../../../tag/riotjs.html">riot.js</a> </p>
</footer><!-- /.post-info -->      <h2>Riot.js</h2>
<p>Riot.jsについては<a href="http://qiita.com/cognitom/items/54ae38c9a50dbbe28367">Riot.js 2.0 情報まとめ - Qiita</a>に良いまとめがありますのでそちらをどうぞ。良いまとめをありがとうございます。</p>
<h2>本家が提供しているToDoアプリをgoemonでライブリロードして開発を高速化するサンプル</h2>
<p>今回のタグエディターの前に、環境整備ということで本家が提供しているToDoアプリをgoemonでライブリロードして開発を高速化するサンプルを作ってみました。</p>
<p><a href="https://github.com/hnakamur/riotjs-todo-goemon-livereload-example">hnakamur/riotjs-todo-goemon-livereload-example</a></p>
<p><a href="https://muut.com/riotjs/guide/">Riot developer guide</a>にあるアプリからどのように変更したかはgitのコミットを小分けにしてあるので、そちらをご参照ください。
<a href="https://github.com/hnakamur/riotjs-todo-goemon-livereload-example/commits/master">Commits · hnakamur/riotjs-todo-goemon-livereload-example</a></p>
<h2>タグエディターのサンプルをRiot.jsでも作ってみた</h2>
<p>で、本題のタグエディターのサンプルです。以前にjQuery, Backbone.js, Vue.jsで同じものを作っていました。</p>
<ul>
<li><a href="http://qiita.com/hnakamur/items/ac5f04930d0c08f141e5">jQuery - タグ・エディターを作ってみた - Qiita</a></li>
<li><a href="http://qiita.com/hnakamur/items/bfdade12bc5db21fa771">Backbone.jsでタグ・エディターを作ってみた - Qiita</a></li>
<li><a href="http://qiita.com/hnakamur/items/a73ff28621e06193a228">vue.jsでタグ・エディターを作ってみた - Qiita</a></li>
</ul>
<p>今回はRiot.jsで作ってみました。</p>
<p>ソース: <a href="https://github.com/hnakamur/riot-tag-editor-live-reload-example-with-goemon">hnakamur/riot-tag-editor-live-reload-example-with-goemon</a>
コンパイル済みのデモ: <a href="https://hnakamur.github.io/riot-tag-editor-live-reload-example-with-goemon/demo/">Riot tag editor example</a></p>
<p>セットアップ手順はソースの<a href="https://github.com/hnakamur/riot-tag-editor-live-reload-example-with-goemon/blob/master/README.md">README</a>を参照してください。</p>
<p>タグエディターのタグのソースは<a href="https://github.com/hnakamur/riot-tag-editor-live-reload-example-with-goemon/blob/master/assets/tag-editor.tag">tag-editor.tag</a>です。</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="nv">tag</span><span class="o">-</span><span class="nv">editor</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="nv">div</span> <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tag-editor-field</span><span class="s2">&quot;</span> <span class="nv">onclick</span><span class="o">=</span>{ <span class="nv">click</span> }<span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">div</span> <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tag-editor-tag tag-editor-tag-measure</span><span class="s2">&quot;</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nv">div</span> <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">measure</span><span class="s2">&quot;</span> <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tag-editor-text</span><span class="s2">&quot;</span><span class="o">&gt;&lt;/</span><span class="nv">div</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nv">a</span> <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tag-editor-delete</span><span class="s2">&quot;</span><span class="o">&gt;</span><span class="nv">x</span><span class="o">&lt;/</span><span class="nv">a</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">div</span> <span class="nv">each</span><span class="o">=</span>{ <span class="nv">tags</span> } <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tag-editor-tag</span><span class="s2">&quot;</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nv">div</span> <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tag-editor-text</span><span class="s2">&quot;</span><span class="o">&gt;</span>{ <span class="nv">name</span> }<span class="o">&lt;/</span><span class="nv">div</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nv">a</span> <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tag-editor-delete</span><span class="s2">&quot;</span> <span class="nv">onclick</span><span class="o">=</span>{ <span class="nv">parent</span>.<span class="nv">clickDelete</span> }<span class="o">&gt;</span><span class="nv">x</span><span class="o">&lt;/</span><span class="nv">a</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="nv">div</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nv">input</span> <span class="nv">name</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">editor</span><span class="s2">&quot;</span> <span class="nv">class</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">tag-editor-input</span><span class="s2">&quot;</span> <span class="nv">style</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">width: 0</span><span class="s2">&quot;</span> <span class="nv">onkeyup</span><span class="o">=</span>{ <span class="nv">keyup</span> } <span class="nv">onkeydown</span><span class="o">=</span>{ <span class="nv">keydown</span> } <span class="nv">onblur</span><span class="o">=</span>{ <span class="nv">blur</span> }<span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="nv">div</span><span class="o">&gt;</span>

  <span class="o">&lt;</span><span class="nv">script</span><span class="o">&gt;</span>
    <span class="nv">this</span>.<span class="nv">tags</span> <span class="o">=</span> <span class="nv">opts</span>.<span class="nv">tags</span>
    <span class="nv">this</span>.<span class="nv">separator</span> <span class="o">=</span> <span class="o">/</span>[, ]<span class="o">+/</span>

    <span class="nv">click</span><span class="ss">(</span><span class="nv">e</span><span class="ss">)</span> {
      <span class="nv">adjustEditorWidth</span><span class="ss">(</span><span class="nv">this</span><span class="ss">)</span>
      <span class="nv">this</span>.<span class="nv">editor</span>.<span class="nv">focus</span><span class="ss">()</span>
      <span class="k">return</span> <span class="nv">false</span>
    }

    <span class="nv">keyup</span><span class="ss">(</span><span class="nv">e</span><span class="ss">)</span> {
      <span class="nv">var</span> <span class="nv">val</span> <span class="o">=</span> <span class="nv">this</span>.<span class="nv">editor</span>.<span class="nv">value</span>
      <span class="k">if</span> <span class="ss">(</span><span class="nv">this</span>.<span class="nv">separator</span>.<span class="nv">test</span><span class="ss">(</span><span class="nv">val</span><span class="ss">))</span> {
        <span class="nv">mayInsertTags</span><span class="ss">(</span><span class="nv">this</span><span class="ss">)</span>
      } <span class="k">else</span> {
        <span class="nv">adjustEditorWidth</span><span class="ss">(</span><span class="nv">this</span><span class="ss">)</span>
      }
      <span class="k">return</span> <span class="nv">false</span>
    }

    <span class="nv">keydown</span><span class="ss">(</span><span class="nv">e</span><span class="ss">)</span> {
      <span class="k">if</span> <span class="ss">(</span><span class="nv">e</span>.<span class="nv">which</span> <span class="o">==</span> <span class="mi">13</span> <span class="cm">/* Enter */</span> <span class="o">&amp;&amp;</span> <span class="nv">this</span>.<span class="nv">editor</span>.<span class="nv">value</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="ss">)</span> {
        <span class="nv">mayInsertTags</span><span class="ss">(</span><span class="nv">this</span><span class="ss">)</span>
        <span class="k">return</span> <span class="nv">true</span>
      } <span class="k">else</span> <span class="k">if</span> <span class="ss">(</span><span class="nv">e</span>.<span class="nv">which</span> <span class="o">==</span> <span class="mi">8</span> <span class="cm">/* Backspace */</span> <span class="o">&amp;&amp;</span> <span class="nv">this</span>.<span class="nv">editor</span>.<span class="nv">value</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">this</span>.<span class="nv">tags</span>.<span class="nv">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="ss">)</span> {
        <span class="nv">this</span>.<span class="nv">tags</span>.<span class="nv">pop</span><span class="ss">()</span>
      }
      <span class="k">return</span> <span class="nv">true</span>
    }

    <span class="nv">blur</span><span class="ss">(</span><span class="nv">e</span><span class="ss">)</span> {
      <span class="nv">mayInsertTags</span><span class="ss">(</span><span class="nv">this</span><span class="ss">)</span>
      <span class="k">return</span> <span class="nv">true</span>
    }

    <span class="nv">clickDelete</span><span class="ss">(</span><span class="nv">e</span><span class="ss">)</span> {
      <span class="nv">e</span>.<span class="nv">stopPropagation</span><span class="ss">()</span>
      <span class="nv">this</span>.<span class="nv">tags</span>.<span class="nv">splice</span><span class="ss">(</span><span class="nv">this</span>.<span class="nv">tags</span>.<span class="nv">indexOf</span><span class="ss">(</span><span class="nv">e</span>.<span class="nv">item</span><span class="ss">)</span>, <span class="mi">1</span><span class="ss">)</span>
      <span class="k">return</span> <span class="nv">false</span>
    }

    <span class="nv">function</span> <span class="nv">adjustEditorWidth</span><span class="ss">(</span><span class="nv">elem</span><span class="ss">)</span> {
      <span class="nv">elem</span>.<span class="nv">measure</span>.<span class="nv">innerText</span> <span class="o">=</span> <span class="nv">elem</span>.<span class="nv">editor</span>.<span class="nv">value</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="s">WW</span><span class="s1">&#39;</span>
      <span class="nv">elem</span>.<span class="nv">editor</span>.<span class="nv">style</span>.<span class="nv">width</span> <span class="o">=</span> <span class="nv">elem</span>.<span class="nv">measure</span>.<span class="nv">offsetWidth</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="s">px</span><span class="s1">&#39;</span>
    }

    <span class="nv">function</span> <span class="nv">mayInsertTags</span><span class="ss">(</span><span class="nv">elem</span><span class="ss">)</span> {
      <span class="nv">var</span> <span class="nv">values</span> <span class="o">=</span> <span class="nv">elem</span>.<span class="nv">editor</span>.<span class="nv">value</span>.<span class="nv">split</span><span class="ss">(</span><span class="nv">elem</span>.<span class="nv">separator</span><span class="ss">)</span>,
          <span class="nv">i</span> <span class="o">=</span> <span class="mi">0</span>,
          <span class="nv">len</span> <span class="o">=</span> <span class="nv">values</span>.<span class="nv">length</span>,
          <span class="nv">value</span>
      <span class="nv">elem</span>.<span class="nv">editor</span>.<span class="nv">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">adjustEditorWidth</span><span class="ss">(</span><span class="nv">elem</span><span class="ss">)</span>
      <span class="k">for</span> <span class="ss">(</span><span class="c1">; i &lt; len; i++) {</span>
        <span class="nv">value</span> <span class="o">=</span> <span class="nv">values</span>[<span class="nv">i</span>]
        <span class="k">if</span> <span class="ss">(</span><span class="nv">value</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">containsTag</span><span class="ss">(</span><span class="nv">elem</span>, <span class="nv">value</span><span class="ss">))</span> {
          <span class="nv">elem</span>.<span class="nv">tags</span>.<span class="nv">push</span><span class="ss">(</span>{<span class="nv">name</span>: <span class="nv">value</span>}<span class="ss">)</span>
        }
      }
    }

    <span class="nv">function</span> <span class="nv">containsTag</span><span class="ss">(</span><span class="nv">elem</span>, <span class="nv">tag</span><span class="ss">)</span> {
      <span class="nv">var</span> <span class="nv">i</span> <span class="o">=</span> <span class="mi">0</span>, 
          <span class="nv">len</span> <span class="o">=</span> <span class="nv">elem</span>.<span class="nv">tags</span>.<span class="nv">length</span>
      <span class="k">for</span> <span class="ss">(</span><span class="c1">; i &lt; len; i++) {</span>
        <span class="k">if</span> <span class="ss">(</span><span class="nv">elem</span>.<span class="nv">tags</span>[<span class="nv">i</span>].<span class="nv">name</span> <span class="o">===</span> <span class="nv">tag</span><span class="ss">)</span> {
          <span class="k">return</span> <span class="nv">true</span>
        }
      }
      <span class="k">return</span> <span class="nv">false</span>
    }
  <span class="o">&lt;/</span><span class="nv">script</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="nv">tag</span><span class="o">-</span><span class="nv">editor</span><span class="o">&gt;</span>
</pre></div>


<p>HTMLのタグとJavaScriptのコードを一箇所にかけて、イベントもonclickとかで書くので、コンパクトで見やすいです。
onclickとかに指定した関数は <code>function</code> なしで書けるようになっていますが、そうでない関数には <code>function</code> を明記する必要がありました。</p>
<p>タグエディターを利用する側のHTMLのコードは以下の様な感じで、こちらもシンプルです。</p>
<p>https://github.com/hnakamur/riot-tag-editor-live-reload-example-with-goemon/blob/621d58d0d9774c710f61ad993da451cf948fce22/assets/index.html#L31-L41</p>
<div class="highlight"><pre><span></span>    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;tag-editor.tag&quot;</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;riot/tag&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;https://cdn.jsdelivr.net/g/riot@2.0(riot.min.js+compiler.min.js)&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="n">riot</span><span class="p">.</span><span class="n">mount</span><span class="p">(</span><span class="err">&#39;</span><span class="n">tag</span><span class="o">-</span><span class="n">editor</span><span class="err">&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nl">tags</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="nl">name</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">foo</span><span class="err">&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="nl">name</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">bar</span><span class="err">&#39;</span><span class="p">},</span>
      <span class="p">]</span>
    <span class="p">})</span>
    <span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>


<h2>プリコンパイル済みのソースの作成</h2>
<div class="highlight"><pre><span></span><span class="n">riot</span> <span class="n">assets</span><span class="o">/</span> <span class="n">demo</span><span class="o">/</span>
</pre></div>


<p>で <code>assets/tag-editor.tag</code> から <code>demo/tag-editor.js</code> が生成されます。</p>
<p>利用する側のHTMLは以下のようにします。 riot.jsの読み込み方法と、タグエディターのソースを読み込む順番が開発時とは違うので要注意です。</p>
<p>https://github.com/hnakamur/riot-tag-editor-live-reload-example-with-goemon/blob/621d58d0d9774c710f61ad993da451cf948fce22/demo/index.html#L30-L40</p>
<div class="highlight"><pre><span></span>    <span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">&quot;https://cdn.jsdelivr.net/riot/2.0/riot.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">&quot;tag-editor.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>

    <span class="nt">&lt;script&gt;</span>
    riot.mount(&#39;tag-editor&#39;, {
      tags: [
        {name: &#39;foo&#39;},
        {name: &#39;bar&#39;},
      ]
    })
    <span class="nt">&lt;/script&gt;</span>
</pre></div>


<h2>Riot.jsの魅力</h2>
<p><a href="https://muut.com/riotjs/compare.html">Riot vs React vs Polymer</a>を見ても、riot.min.jsは6.7KBとコンパクトなのが魅力です。それでいてカスタムタグもすっきりシンプルに書けますし。これは今後に期待ですね！</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>