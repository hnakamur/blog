<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.101.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>GeForce搭載の旧モデルMacBook ProでCaffeをビルドする手順メモ &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2022. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>GeForce搭載の旧モデルMacBook ProでCaffeをビルドする手順メモ</h1>
  <time datetime=2015-07-26T00:53:52&#43;0900 class="post-date">2015-07-26</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#caffeはpython3非対応">CaffeはPython3非対応</a></li>
    <li><a href="#依存ライブラリのインストール">依存ライブラリのインストール</a>
      <ul>
        <li><a href="#protobufのインストール">protobufのインストール</a></li>
        <li><a href="#boost-1570-boost-python-1570-のインストール">boost 1.57.0, boost-python 1.57.0 のインストール</a></li>
      </ul>
    </li>
    <li><a href="#python2でvirtualenvで作業用の環境を作成して依存ライブラリをインストール">Python2でvirtualenvで作業用の環境を作成して依存ライブラリをインストール</a></li>
    <li><a href="#caffeのソースを取得してビルド">Caffeのソースを取得してビルド</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="/blog/2015/07/25/setup_cuda_on_macbook_pro_with_geforce/">GeForce搭載の旧モデルMacBook ProでCUDAをセットアップする手順のメモ</a>でCUDA 7.0.29をインストールしたMacBook Proで<a href="http://caffe.berkeleyvision.org/">Caffe | Deep Learning Framework</a>をビルドしてみた手順メモです。</p>
<p><a href="https://pypi.python.org/pypi?%3Aaction=search&amp;term=caffe&amp;submit=search">PyPIでCaffeで検索</a>しても出てこないので、ソースからビルドするしかないようです。</p>
<p><a href="http://caffe.berkeleyvision.org/install_osx.html">OS X Installation</a>を参考にしつつ、一部手順を変更してインストールしました。</p>
<h2 id="caffeはpython3非対応">CaffeはPython3非対応</h2>
<p><a href="http://qiita.com/icoxfog417/items/65e800c3a2094457c3a0">Python - はじめるDeep learning - Qiita</a>で紹介されていた<a href="https://github.com/BVLC/caffe/issues/293">Python3 support · Issue #293 · BVLC/caffe</a>によると、オフィシャルでPython3対応の予定はないとのこと。Python3でも動かないこともないそうですが、初心者なのでまずはPython2で動かすことにします。</p>
<h2 id="依存ライブラリのインストール">依存ライブラリのインストール</h2>
<p>依存するライブラリを以下のコマンドでインストールしました。</p>
<pre tabindex="0"><code>brew install -vd snappy leveldb gflags glog szip lmdb
brew tap homebrew/science
brew install hdf5 opencv
</code></pre><h3 id="protobufのインストール">protobufのインストール</h3>
<p>以下のコマンドでprotobufをインストールします。</p>
<pre tabindex="0"><code>brew install protobuf
</code></pre><p><a href="http://caffe.berkeleyvision.org/install_osx.html">OS X Installation</a>の手順では <code>--with-python</code> オプションを指定していますが、 <code>brew info protobuf</code> で確認すると2.6.1用のformulaでは <code>--with-python</code> オプションは無くなって代わりに <code>--without-python</code> オプションが出来ていました。何も指定しなければpythonサポートが入るようです。</p>
<p>なお、インストール完了時に以下のメッセージが出ますが、後でvirtualenvで作った環境内で <code>pip install protobuf</code> すればいけるので、ここに書かれている対応は不要でした。</p>
<pre tabindex="0"><code>==&gt; Caveats
Editor support and examples have been installed to:
  /usr/local/Cellar/protobuf/2.6.1/share/doc/protobuf

Python modules have been installed and Homebrew&#39;s site-packages is not
in your Python sys.path, so you will not be able to import the modules
this formula installed. If you plan to develop with these modules,
please run:
  mkdir -p
  echo &#39;import site; site.addsitedir(&#34;/usr/local/lib/python2.7/site-packages&#34;)&#39; &gt;&gt; homebrew.pth
</code></pre><h3 id="boost-1570-boost-python-1570-のインストール">boost 1.57.0, boost-python 1.57.0 のインストール</h3>
<p><code>brew install boost boost-python</code> だと1.58.0が入ったのですが、Caffeのビルド時にコンパイルエラーが出ました。<a href="http://itinerantbioinformaticist.blogspot.jp/2015/05/caffe-incompatible-with-boost-1580.html">Itinerant Bioinformaticist: Caffe incompatible with Boost 1.58.0</a>と同じエラーですが、ここに回避方法も書かれていたので、これに従いました。</p>
<p>まず、boost 1.58.0, boost-python 1.58.0が入っている場合はアンインストールします。</p>
<pre tabindex="0"><code>brew uninstall boost boost-python
</code></pre><p>以下の手順で1.57.0をソースからインストールします。</p>
<pre tabindex="0"><code>cd `brew --prefix`/Library/Formula
curl -O https://raw.githubusercontent.com/Homebrew/homebrew/6fd6a9b6b2f56139a44dd689d30b7168ac13effb/Library/Formula/boost.rb
curl -O https://raw.githubusercontent.com/Homebrew/homebrew/3141234b3473717e87f3958d4916fe0ada0baba9/Library/Formula/boost-python.rb
brew install --build-from-source -vd boost boost-python
</code></pre><h2 id="python2でvirtualenvで作業用の環境を作成して依存ライブラリをインストール">Python2でvirtualenvで作業用の環境を作成して依存ライブラリをインストール</h2>
<p>個人的にはAnaconda Pythonのようなオールインワンのインストーラはあまり好きではないので、<a href="https://github.com/riywo/anyenv">riywo/anyenv</a>と<a href="https://github.com/yyuu/pyenv">yyuu/pyenv</a>で入れたPython 2.7.10を使いました。</p>
<p>作業用のディレクトリ <code>~/work/caffe</code> を作ってvirtualenvで環境を作りました。</p>
<pre tabindex="0"><code>mkdir -p ~/work/caffe
cd !$
pyenv local 2.7.10
virtualenv venv
source venv/bin/activate
</code></pre><p>HomebrewでインストールしたPython 2.7.10でも <code>pyenv local 2.7.10</code> の行を除けば同じ手順で行けました。</p>
<p>Caffeで必要なprotobufとnumpyを以下の手順でインストールします。</p>
<pre tabindex="0"><code>pip install protobuf
pip install numpy
</code></pre><h2 id="caffeのソースを取得してビルド">Caffeのソースを取得してビルド</h2>
<p>ソースを取得してディレクトリに入ります。</p>
<pre tabindex="0"><code>cd ~/work/caffe
git clone https://github.com/BVLC/caffe
cd caffe
</code></pre><p><a href="http://caffe.berkeleyvision.org/installation.html#compilation">Installation</a>を参考にビルドします。virtualenv環境のincludeとlibディレクトリを参照するように以下のように加工してMakefile.configを作成します。Caffeのソースを違うディレクトリに配置した場合は適宜変更してください。</p>
<pre tabindex="0"><code>sed &#39;
s|/usr/include/python2.7|$(HOME)/work/caffe/venv/include/python2.7|
s|/usr/lib/python2.7/dist-packages|$(HOME)/work/caffe/venv/lib/python2.7/site-packages|
&#39; Makefile.config.example &gt; Makefile.config
</code></pre><p>Caffeをビルドします。</p>
<pre tabindex="0"><code>make all
</code></pre><p>テストコードをビルドします。</p>
<pre tabindex="0"><code>make test
</code></pre><p>テストを実行します。</p>
<pre tabindex="0"><code>(venv)$ make runtest
...(略)...
[----------] Global test environment tear-down
[==========] 1356 tests from 214 test cases ran. (306870 ms total)
[  PASSED  ] 1356 tests.

  YOU HAVE 2 DISABLED TESTS
</code></pre><p>ということで、Caffeをビルドする手順でした。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
