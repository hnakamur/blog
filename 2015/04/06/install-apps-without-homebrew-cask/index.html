<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Homebrew Caskを使わずにdmgファイルのアプリをコマンドでインストールする</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2015/04/06/install-apps-without-homebrew-cask/" rel="bookmark"
           title="Permalink to Homebrew Caskを使わずにdmgファイルのアプリをコマンドでインストールする">Homebrew Caskを使わずにdmgファイルのアプリをコマンドでインストールする</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-04-06T00:45:00+09:00">
                Published: 2015-04-06
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>

</footer><!-- /.post-info -->      <h2>なぜHomebrew Caskをやめたか</h2>
<p><a href="http://t-wada.hatenablog.jp/entry/mac-provisioning-by-ansible">Mac の開発環境構築を自動化する (2015 年初旬編) - t-wadaのブログ</a>でもHomebrew Caskの不安な点について書かれていますが、私もHomebrew Caskは便利と思いつつも止めたいなと思っていました。</p>
<p>私が使うアプリに関してはほとんどがアプリ側で最新版のお知らせとバージョンアップの仕組みを持っています。あとHomebrew Caskは/opt/homebrew-cask/以下に実体を置いて~/Applications/や/Applications/にシンボリックリンクを貼るようになっています。</p>
<p>私はそこまで複雑な仕組みは要らないので、初期インストールがコマンドで半自動化できれば十分です。</p>
<h2>dmgファイルのアプリをコマンドラインからインストールする</h2>
<p><a href="http://stackoverflow.com/questions/22934083/install-dmg-package-on-mac-os-from-terminal/22940943#22940943">osx - Install dmg package on MAC OS from Terminal - Stack Overflow</a>や<a href="http://commandlinemac.blogspot.jp/2008/12/installing-dmg-application-from-command.html">Command Line Mac: Installing a .dmg application from the command line</a>を見て実際にやってみました。</p>
<p>ソースは<a href="https://github.com/hnakamur/my-macbook-initial-setup">hnakamur/my-macbook-initial-setup · GitHub</a>にあります。</p>
<p>以下のアプリをdmgファイルからインストールしています。</p>
<ul>
<li><a href="https://github.com/splhack/macvim-kaoriya">splhack/macvim-kaoriya · GitHub</a></li>
<li><a href="http://calibre-ebook.com/">calibre - E-book management</a></li>
<li><a href="https://www.google.co.jp/chrome/browser/desktop/index.html">Chrome</a></li>
<li><a href="https://www.mozilla.org/ja/firefox/new/">Firefox</a></li>
<li><a href="https://www.google.co.jp/ime/">Google 日本語入力</a></li>
<li><a href="http://iterm2.com/">iTerm2 - Mac OS Terminal Replacement</a></li>
<li><a href="https://java.com/ja/download/">Java (JRE)</a></li>
<li><a href="http://grandperspectiv.sourceforge.net/">GrandPerspective</a></li>
<li><a href="https://www-jp.mysql.com/products/workbench/">MySQL Workbench</a></li>
<li><a href="http://mstarke.github.io/MacPass/">MacPass</a></li>
<li><a href="http://www.shadowlab.org/Software/spark.php">Spark</a></li>
<li><a href="https://www.virtualbox.org/">Oracle VM VirtualBox</a></li>
<li><a href="https://www.vagrantup.com/">Vagrant</a></li>
<li><a href="http://xquartz.macosforge.org/landing/">XQuartz</a></li>
</ul>
<h2>dmgファイルのマウントとアンマウント</h2>
<p>共通の処理として、dmgファイルのマウントは <code>hdiutil attach</code> 、アンマウントは <code>hdiutil detach</code> コマンドで行います。</p>
<p>マウントした時の /Volumes/〜 のディレクトリ名は <code>hdiutil attach</code> の実行結果の最後の行から取得できます。</p>
<p>最初は</p>
<div class="highlight"><pre><span></span>  <span class="nv">mount_dir</span><span class="o">=</span>`<span class="nv">hdiutil</span> <span class="nv">attach</span> <span class="mh">$d</span><span class="nv">mg_file</span> <span class="o">|</span> <span class="nv">awk</span> <span class="s1">&#39;</span><span class="s">END{print $NF}</span><span class="s1">&#39;</span>`
</pre></div>


<p>のようにして最後の行の一番右のフィールドを取得していましたが、 <code>/Volumes/Google Chrome</code> のように空白を含む場合があることがわかりました。</p>
<p><a href="http://stackoverflow.com/questions/22934083/install-dmg-package-on-mac-os-from-terminal/22940943#22940943">osx - Install dmg package on MAC OS from Terminal - Stack Overflow</a>では第1フィールドと第2フィールドを消して第3フィールド以降にしていますが、試してみると余分な空白（実際はタブと判明）が付いてきました。</p>
<p><code>hdiutil attach</code> の結果をファイルに落として見てみたら、空白に加えてタブで区切られていてタブで区切るほうがシンプルなことがわかりました。</p>
<p>そこで、以下のようにして取得するようにしました。</p>
<div class="highlight"><pre><span></span>  <span class="nv">mount_dir</span><span class="o">=</span>`<span class="nv">hdiutil</span> <span class="nv">attach</span> <span class="mh">$d</span><span class="nv">mg_file</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">END{print $NF}</span><span class="s1">&#39;</span>`
</pre></div>


<h2>インストール方法のパターン</h2>
<p>上記のアプリの範囲では4パターンありました。</p>
<h3>dmgファイル内に〜.appフォルダがあるパターン</h3>
<p>Chromeなどがこのパターンです。<a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/ditto.1.html">ditto</a>コマンドで/Applications/〜.appにコピーするようにしました。</p>
<p>https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L731-L740</p>
<div class="highlight"><pre><span></span><span class="nv">install_google_chrome</span><span class="ss">()</span> {
  <span class="nv">download_url</span><span class="o">=</span><span class="nv">https</span>:<span class="o">//</span><span class="nv">dl</span>.<span class="nv">google</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">chrome</span><span class="o">/</span><span class="nv">mac</span><span class="o">/</span><span class="nv">stable</span><span class="o">/</span><span class="nv">GGRO</span><span class="o">/</span><span class="nv">googlechrome</span>.<span class="nv">dmg</span>
  <span class="nv">dmg_file</span><span class="o">=</span>${<span class="nv">download_url</span>##<span class="o">*/</span>}

  <span class="nv">curl</span> <span class="o">-</span><span class="nv">LO</span> <span class="mh">$d</span><span class="nv">ownload_url</span>
  <span class="nv">mount_dir</span><span class="o">=</span>`<span class="nv">hdiutil</span> <span class="nv">attach</span> <span class="mh">$d</span><span class="nv">mg_file</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">END{print $NF}</span><span class="s1">&#39;</span>`
  <span class="nv">sudo</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">ditto</span> <span class="s2">&quot;</span><span class="s">$mount_dir/Google Chrome.app</span><span class="s2">&quot;</span> <span class="s2">&quot;</span><span class="s">/Applications/Google Chrome.app</span><span class="s2">&quot;</span>
  <span class="nv">hdiutil</span> <span class="nv">detach</span> <span class="s2">&quot;</span><span class="s">$mount_dir</span><span class="s2">&quot;</span>
  <span class="nv">rm</span> <span class="mh">$d</span><span class="nv">mg_file</span>
}
</pre></div>


<h3>dmgファイル内に*.pkgのインストーラがあるパターン</h3>
<p>Google日本語入力などがこのパターンです。OSXの<a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man8/installer.8.html">installer</a>コマンドでインストールします。</p>
<p>https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L742-L751</p>
<div class="highlight"><pre><span></span><span class="nv">install_google_japanese_input</span><span class="ss">()</span> {
  <span class="nv">download_url</span><span class="o">=</span><span class="nv">https</span>:<span class="o">//</span><span class="nv">dl</span>.<span class="nv">google</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">japanese</span><span class="o">-</span><span class="nv">ime</span><span class="o">/</span><span class="nv">latest</span><span class="o">/</span><span class="nv">GoogleJapaneseInput</span>.<span class="nv">dmg</span>
  <span class="nv">dmg_file</span><span class="o">=</span>${<span class="nv">download_url</span>##<span class="o">*/</span>}

  <span class="nv">curl</span> <span class="o">-</span><span class="nv">LO</span> <span class="mh">$d</span><span class="nv">ownload_url</span>
  <span class="nv">mount_dir</span><span class="o">=</span>`<span class="nv">hdiutil</span> <span class="nv">attach</span> <span class="mh">$d</span><span class="nv">mg_file</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">END{print $NF}</span><span class="s1">&#39;</span>`
  <span class="nv">sudo</span> <span class="nv">installer</span> <span class="o">-</span><span class="nv">pkg</span> $<span class="nv">mount_dir</span><span class="o">/</span><span class="nv">GoogleJapaneseInput</span>.<span class="nv">pkg</span> <span class="o">-</span><span class="nv">target</span> <span class="o">/</span>
  <span class="nv">hdiutil</span> <span class="nv">detach</span> <span class="s2">&quot;</span><span class="s">$mount_dir</span><span class="s2">&quot;</span>
  <span class="nv">rm</span> <span class="mh">$d</span><span class="nv">mg_file</span>
}
</pre></div>


<h3>dmgファイル内に独自形式のインストーラがあるパターン</h3>
<p>Javaがこのパターンでした。インストーラを実行してインストールします。</p>
<p>https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L762-L772</p>
<div class="highlight"><pre><span></span><span class="nv">install_java</span><span class="ss">()</span> {
  <span class="nv">download_url</span><span class="o">=</span><span class="nv">http</span>:<span class="o">//</span><span class="nv">javadl</span>.<span class="nv">sun</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">webapps</span><span class="o">/</span><span class="nv">download</span><span class="o">/</span><span class="nv">AutoDL</span>?<span class="nv">BundleId</span><span class="o">=</span><span class="mi">105219</span>
  <span class="nv">dmg_file</span><span class="o">=</span><span class="nv">jre</span>.<span class="nv">dmg</span>

  <span class="nv">curl</span> <span class="o">-</span><span class="nv">L</span> <span class="o">-</span><span class="nv">o</span> <span class="mh">$d</span><span class="nv">mg_file</span> <span class="s2">&quot;</span><span class="s">$download_url</span><span class="s2">&quot;</span>
  <span class="nv">mount_dir</span><span class="o">=</span>`<span class="nv">hdiutil</span> <span class="nv">attach</span> <span class="mh">$d</span><span class="nv">mg_file</span> <span class="o">|</span> <span class="nv">awk</span> <span class="o">-</span><span class="nv">F</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="s1">&#39;</span><span class="s">END{print $NF}</span><span class="s1">&#39;</span>`
  <span class="nv">java_dir</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">${mount_dir##*/}</span><span class="s2">&quot;</span>
  <span class="nv">sudo</span> <span class="s2">&quot;</span><span class="s">$mount_dir/${java_dir}.app/Contents/MacOS/MacJREInstaller</span><span class="s2">&quot;</span>
  <span class="nv">hdiutil</span> <span class="nv">detach</span> <span class="s2">&quot;</span><span class="s">$mount_dir</span><span class="s2">&quot;</span>
  <span class="nv">rm</span> <span class="mh">$d</span><span class="nv">mg_file</span>
}
</pre></div>


<h3>zipファイル内に〜.appがあるパターン</h3>
<p>iTerm2などがこのパターンです。unzipコマンドの-dオプションで解凍先を/Applicationsにして解凍してインストールします。</p>
<p>https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L753-L760</p>
<div class="highlight"><pre><span></span>install_iterm2() {
  download_url=https://iterm2.com/downloads/stable/iTerm2_v2_0.zip
  zip_file=<span class="cp">${</span><span class="n">download_url</span><span class="c1">##*/</span><span class="cp">}</span>

  curl -LO <span class="nv">$download_url</span>
  sudo unzip <span class="nv">$zip_file</span> -d /Applications
  rm <span class="nv">$zip_file</span>
}
</pre></div>


<h2>まとめ</h2>
<p>Homebrew Caskを使わずにコマンドラインでOSXのアプリのインストールを半自動化しました。全自動ではなく半自動化といっているのは、アプリによってパスワード入力が必要だったり、ダイアログが表示されてボタンを押す必要があるからです。</p>
<p>アプリのバージョンが今後上がった時にダウンロードURLを再度調べる必要があるのが面倒ではありますが、OSXを一からセットアップするのはたまにしか行わないのでよしとします。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>