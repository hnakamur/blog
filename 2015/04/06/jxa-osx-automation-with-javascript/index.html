<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.88.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>JXA (JavaScript for Automation)を使ってOSXの初期設定を半自動化してみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>JXA (JavaScript for Automation)を使ってOSXの初期設定を半自動化してみた</h1>
  <time datetime=2015-04-06T04:40:43&#43;0900 class="post-date">2015-04-06</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#概要">概要</a></li>
    <li><a href="#きっかけはapplescriptのui-elementsの記事を読んだこと">きっかけはAppleScriptのUI elementsの記事を読んだこと</a></li>
    <li><a href="#自分用セットアップスクリプト">自分用セットアップスクリプト</a></li>
    <li><a href="#applescriptやjxaで設定している内容">AppleScriptやJXAで設定している内容</a></li>
    <li><a href="#applescriptに比べてjxaが嬉しいところ">AppleScriptに比べてJXAが嬉しいところ</a></li>
    <li><a href="#うまくいってないところ">うまくいってないところ</a>
      <ul>
        <li><a href="#sparkのショートカット追加がうまくいかないときがある">Sparkのショートカット追加がうまくいかないときがある</a></li>
      </ul>
    </li>
    <li><a href="#まとめ">まとめ</a></li>
  </ul>
</nav>
  <h2 id="概要">概要</h2>
<p>OSXを再インストールしたときなどキーボードやトラックパッドの設定を行いますが、
設定する項目が意外と多くて時間がかかります。</p>
<p>そこでJXA (JavaScript for Automation)で自動化してみました。
全自動ではなく半自動化と書いているのはパスワードの入力などは手動で行う必要があるからです。</p>
<h2 id="きっかけはapplescriptのui-elementsの記事を読んだこと">きっかけはAppleScriptのUI elementsの記事を読んだこと</h2>
<p>以前からAppleScriptでOSXの初期設定の自動化をやってみたかったのですが、
UI要素の調べ方がわからず諦めていました。</p>
<p>StackOverflowの<a href="http://apple.stackexchange.com/questions/40436/how-to-know-the-name-of-ui-elements-using-accessibility-inspector-or-any-other/87412#87412">applescript - How to know the name of UI elements using Accessibility inspector (or any other tool) - Ask Different</a>のコメントから
<a href="http://n8henrie.com/2013/03/a-strategy-for-ui-scripting-in-applescript/">n8henrie.com | A Strategy for UI Scripting in AppleScript</a>という記事を見つけて、これがブレイクスルーになりました。</p>
<p>で、いろいろ試していくうちにJavaScriptで書くほうがクロージャが使えて便利ということに気づいたのでJavaScriptに切り替えました。</p>
<p>以下の記事が参考になりました。ありがとうございます！</p>
<ul>
<li><a href="https://github.com/dtinth/JXA-Cookbook/wiki">Home · dtinth/JXA-Cookbook Wiki · GitHub</a></li>
<li><a href="http://qiita.com/zakuroishikuro/items/afab0e33ad2030ba2f92">Macのキーボード入力、マウスクリックをJavaScriptで (JXA) - Qiita</a></li>
</ul>
<h2 id="自分用セットアップスクリプト">自分用セットアップスクリプト</h2>
<p>私用のセットアップスクリプトを<a href="https://github.com/hnakamur/my-macbook-initial-setup">hnakamur/my-macbook-initial-setup · GitHub</a>に置きました。完全に自分仕様ですが、ライセンスはMITなので適宜変更してご利用ください。</p>
<h2 id="applescriptやjxaで設定している内容">AppleScriptやJXAで設定している内容</h2>
<p>最初はAppleScriptで書いていたので一部はそのままです。</p>
<ul>
<li>App Store経由でのXcodeのインストール</li>
<li>Xcodeコマンドラインツールのインストール</li>
<li>キーボードの設定
<ul>
<li>リピート率の設定</li>
<li>ControlとCapsの入れ替え</li>
</ul>
</li>
<li>トラックパッドの設定
<ul>
<li>使う機能と使わない機能の設定</li>
<li>ドラッグロック設定</li>
</ul>
</li>
<li>ショートカットキーの設定
<ul>
<li>次のウィンドウのショートカットキー変更</li>
</ul>
</li>
<li>スクリーンロックのタイミング調整</li>
<li>キーボードの入力ソースにGoogle日本語入力のひらがなを追加</li>
<li><a href="http://www.shadowlab.org/Software/spark.php">Spark</a>のショートカット追加</li>
<li><a href="http://mstarke.github.io/MacPass/">MacPass</a>のメニューショートカット設定</li>
</ul>
<h2 id="applescriptに比べてjxaが嬉しいところ">AppleScriptに比べてJXAが嬉しいところ</h2>
<p>上にも書きましたが、クロージャが使えるのが便利です。</p>
<p>例えば特定の要素が出現するまで待つために以下の様な関数を定義しました。
<a href="https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L9-L26">https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L9-L26</a></p>
<pre tabindex="0"><code>function isInvalidIndexError(e) {
  return e.toString() === 'Error: Invalid index.'
}
function waitUntilSuccess(f) {
  var ret
  do {
    delay(1)
    try {
      ret = f()
    } catch (e) {
      if (!isInvalidIndexError(e)) {
        throw e
      }
    }
  } while (!ret)
  return ret
}
</code></pre><p>こんな感じで使用します。</p>
<p><a href="https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L39-L47">https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L39-L47</a></p>
<pre tabindex="0"><code>  var storeProc = Application('System Events').processes.byName('App Store')
  storeProc.frontmost = true
  var win = storeProc.windows.byName('App Store')
  // Search for Xcode
  var textField = waitUntilSuccess(function() {
    return win.toolbars[0].groups[6].textFields[0]
  })
  textField.value = 'Xcode'
  textField.buttons[0].click()
</code></pre><p>try catchを使わずにUI要素の存在をチェックするのは、上のように深い要素だと
面倒なので、アクセスするコードを動かしてみて <code>Error: Invalid index.</code> の
エラーが出たら要素が存在しないと判断するようにしています。</p>
<h2 id="うまくいってないところ">うまくいってないところ</h2>
<h3 id="sparkのショートカット追加がうまくいかないときがある">Sparkのショートカット追加がうまくいかないときがある</h3>
<p><a href="http://www.shadowlab.org/Software/spark.php">Spark</a>というアプリを使って
ショートカットを登録しておくと、キーボードの1ストロークで登録したアプリの
起動や起動済みの場合は最前面に持ってこれるので愛用しています。</p>
<p>フリーですがソースは非公開で設定ファイル形式も不明なのでJXAで登録しています。</p>
<p>しかし、アプリケーションのパスを選ぶところが、うまくいくときと行かない時があります。ファイル選択画面でパスを/から入力すると選べるのでその方式で実装しているのですが、 例えばFinderのパスを <code>/System/Library/CoreServices/Finder.app</code> のように入力してreturnキーを押す操作をJXAで行うと、そのフォルダの中が開いた状態になってしまう時があります。</p>
<p>カラムビューにすると成功するようだったので⌘3を押して切り替えるようにしてみたのですが、2秒ディレイを入れても全体を通して実行していると途中から失敗することがあります。</p>
<p>その後run.shを書き換えてSparkのショートカット設定の部分だけ実行すると、うまくいきます。なぜ全体を通して実行した時は失敗するのかが謎です。</p>
<h2 id="まとめ">まとめ</h2>
<p>上記のように一部問題はありますが、大部分の操作は自動化できたので、全て手動で設定するのに比べるとずいぶん楽になりました。JXA (JavaScript for Automation)便利です。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
