<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>LXDコンテナで固定IPアドレスを使うための設定</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/05/07/how-to-use-fixed-ip-address-for-a-lxd-container/" rel="bookmark"
           title="Permalink to LXDコンテナで固定IPアドレスを使うための設定">LXDコンテナで固定IPアドレスを使うための設定</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-05-07T18:01:00+09:00">
                Published: 2016-05-07
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/lxd.html">lxd</a> </p>
</footer><!-- /.post-info -->      <h2>2016-08-12 追記</h2>
<p><code>lxd-bridge</code> サービスを再起動せずに固定IPアドレス設定を更新できるようにするための設定方法を <a href="/blog/2016/08/12/update-lxd-dnsmasq-dhcp-hosts-config-with-sighup/">LXDのdnsmasqの固定IP設定をSIGHUPで更新する · hnakamur's blog at github</a> に書きました。こちらのほうがお勧めです。</p>
<h2>設定まとめ</h2>
<p>自分が後から参照することを想定して先に設定方法をまとめます。</p>
<p>LXDコンテナで固定IPアドレスを使うためには以下の設定が必要です。なお、設定にはroot権限が必要です。</p>
<p>まず <code>/etc/dnsmasq.conf</code> に以下のようにコンテナ名に対するIPアドレスを指定します。</p>
<div class="highlight"><pre><span></span><span class="n">dhcp</span><span class="o">-</span><span class="k">host</span><span class="o">=</span><span class="n">cent01</span><span class="p">,</span><span class="mi">10</span><span class="p">.</span><span class="mi">64</span><span class="p">.</span><span class="mi">177</span><span class="p">.</span><span class="mi">101</span>
<span class="n">dhcp</span><span class="o">-</span><span class="k">host</span><span class="o">=</span><span class="n">cent02</span><span class="p">,</span><span class="mi">10</span><span class="p">.</span><span class="mi">64</span><span class="p">.</span><span class="mi">177</span><span class="p">.</span><span class="mi">102</span>
</pre></div>


<p><code>lxd-bridge</code> サービスを再起動します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="k">restart</span> <span class="n">lxd</span><span class="o">-</span><span class="n">bridge</span>
</pre></div>


<p>IPアドレスを変更したコンテナを再起動します。</p>
<div class="highlight"><pre><span></span><span class="n">lxc</span> <span class="k">restart</span> <span class="n">cent01</span>
<span class="n">lxc</span> <span class="k">restart</span> <span class="n">cent02</span>
</pre></div>


<h2>調査メモ</h2>
<p>以下は調査メモです。</p>
<p>まず <a href="https://github.com/lxc/lxd/issues/1168">Persistent IP for Containers · Issue #1168 · lxc/lxd</a> に固定IPアドレスを使うための情報がありました。LXDで特にサポートはないが、各コンテナでDHCPを使わずに静的IPアドレスを使用するか、あるいはホストのDHCPサーバ側で設定すれば実現できるとのことです。</p>
<p>各コンテナで静的IPアドレスを使う方法も試してみたのですが、ホストのコンテナ内から別のコンテナをコンテナ名で参照しようとすると変更前のIPアドレスで通信しようとしてしまいうまく行きませんでした。</p>
<p>これを実現するにはホストのDHCPサーバに各コンテナのIPアドレスを把握してもらう必要があるので、後者のDHCPサーバ側で設定するほうが良いです。</p>
<h3>LXDのブリッジインターフェースとdnsmasqの設定ファイル</h3>
<p><a href="https://insights.ubuntu.com/2016/04/07/lxd-networking-lxdbr0-explained/">LXD networking: lxdbr0 explained | Ubuntu Insights</a>と<a href="https://gist.github.com/cronnelly/98345100afe21840267270da3283b371">lxcbr0 is being replaced by lxdbr0</a>によると、 LXCでは <code>lxcbr0</code> というブリッジインターフェースを使っていましたが、LXDでは <code>lxdbr0</code> と別のインターフェースを使うように変更されたそうです。</p>
<p>これらの記事を見るとLXCの <code>lxcbr0</code> はインストール時に固定のアドレスネットワークが設定されて環境によっては既存のネットワークと衝突するという問題があったので、LXD の <code>lxdbr0</code> ではインストール時にはIPv4やIPv6のサブネットは設定せずに <code>sudo lxd init</code> を実行したときに設定するように変更されたということのようです。</p>
<p><code>sudo lxd init</code> で生成した <code>lxdbr0</code> 用の設定は <code>/etc/default/lxd-bridge</code> に保存されています。
ファイルの先頭に書かれていますが、変更したい場合は直接編集せずに <code>dpkg-reconfigure -p medium lxd</code> を実行するのが良いそうです。</p>
<div class="highlight"><pre><span></span>$ <span class="nv">cat</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">default</span><span class="o">/</span><span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span>
# <span class="nv">WARNING</span>: <span class="nv">This</span> <span class="nv">file</span> <span class="nv">is</span> <span class="nv">generated</span> <span class="nv">by</span> <span class="nv">a</span> <span class="nv">debconf</span> <span class="nv">template</span><span class="o">!</span>
# <span class="nv">It</span> <span class="nv">is</span> <span class="nv">recommended</span> <span class="nv">to</span> <span class="nv">update</span> <span class="nv">it</span> <span class="nv">by</span> <span class="nv">using</span> <span class="s2">&quot;</span><span class="s">dpkg-reconfigure -p medium lxd</span><span class="s2">&quot;</span>

# <span class="nv">Whether</span> <span class="nv">to</span> <span class="nv">setup</span> <span class="nv">a</span> <span class="nv">new</span> <span class="nv">bridge</span> <span class="nv">or</span> <span class="nv">use</span> <span class="nv">an</span> <span class="nv">existing</span> <span class="nv">one</span>
<span class="nv">USE_LXD_BRIDGE</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">true</span><span class="s2">&quot;</span>

# <span class="nv">Bridge</span> <span class="nv">name</span>
# <span class="nv">This</span> <span class="nv">is</span> <span class="nv">still</span> <span class="nv">used</span> <span class="nv">even</span> <span class="k">if</span> <span class="nv">USE_LXD_BRIDGE</span> <span class="nv">is</span> <span class="nv">set</span> <span class="nv">to</span> <span class="nv">false</span>
# <span class="nv">set</span> <span class="nv">to</span> <span class="nv">an</span> <span class="nv">empty</span> <span class="nv">value</span> <span class="nv">to</span> <span class="nv">fully</span> <span class="nv">disable</span>
<span class="nv">LXD_BRIDGE</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">lxdbr0</span><span class="s2">&quot;</span>

# <span class="nv">Update</span> <span class="nv">the</span> <span class="s2">&quot;</span><span class="s">default</span><span class="s2">&quot;</span> <span class="nv">LXD</span> <span class="nv">profile</span>
<span class="nv">UPDATE_PROFILE</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">true</span><span class="s2">&quot;</span>

# <span class="nv">Path</span> <span class="nv">to</span> <span class="nv">an</span> <span class="nv">extra</span> <span class="nv">dnsmasq</span> <span class="nv">configuration</span> <span class="nv">file</span>
<span class="nv">LXD_CONFILE</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

# <span class="nv">DNS</span> <span class="nv">domain</span> <span class="k">for</span> <span class="nv">the</span> <span class="nv">bridge</span>
<span class="nv">LXD_DOMAIN</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">lxd</span><span class="s2">&quot;</span>

# <span class="nv">IPv4</span>
## <span class="nv">IPv4</span> <span class="nv">address</span> <span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>. <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">8</span>.<span class="mi">1</span><span class="ss">)</span>
<span class="nv">LXD_IPV4_ADDR</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">10.16.29.1</span><span class="s2">&quot;</span>

## <span class="nv">IPv4</span> <span class="nv">netmask</span> <span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>. <span class="mi">255</span>.<span class="mi">255</span>.<span class="mi">255</span>.<span class="mi">0</span><span class="ss">)</span>
<span class="nv">LXD_IPV4_NETMASK</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">255.255.255.0</span><span class="s2">&quot;</span>

## <span class="nv">IPv4</span> <span class="nv">network</span> <span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>. <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">8</span>.<span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="ss">)</span>
<span class="nv">LXD_IPV4_NETWORK</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">10.16.29.1/24</span><span class="s2">&quot;</span>

## <span class="nv">IPv4</span> <span class="nv">DHCP</span> <span class="nv">range</span> <span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>. <span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">8</span>.<span class="mi">2</span>,<span class="mi">10</span>.<span class="mi">0</span>.<span class="mi">8</span>.<span class="mi">254</span><span class="ss">)</span>
<span class="nv">LXD_IPV4_DHCP_RANGE</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">10.16.29.2,10.16.29.254</span><span class="s2">&quot;</span>

## <span class="nv">IPv4</span> <span class="nv">DHCP</span> <span class="nv">number</span> <span class="nv">of</span> <span class="nv">hosts</span> <span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>. <span class="mi">250</span><span class="ss">)</span>
<span class="nv">LXD_IPV4_DHCP_MAX</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">252</span><span class="s2">&quot;</span>

## <span class="nv">NAT</span> <span class="nv">IPv4</span> <span class="nv">traffic</span>
<span class="nv">LXD_IPV4_NAT</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">true</span><span class="s2">&quot;</span>

# <span class="nv">IPv6</span>
## <span class="nv">IPv6</span> <span class="nv">address</span> <span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>. <span class="mi">2001</span>:<span class="mi">470</span>:<span class="nv">b368</span>:<span class="mi">4242</span>::<span class="mi">1</span><span class="ss">)</span>
<span class="nv">LXD_IPV6_ADDR</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">fd94:d372:e27f:2987::1</span><span class="s2">&quot;</span>

## <span class="nv">IPv6</span> <span class="nv">CIDR</span> <span class="nv">mask</span> <span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>. <span class="mi">64</span><span class="ss">)</span>
<span class="nv">LXD_IPV6_MASK</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">64</span><span class="s2">&quot;</span>

## <span class="nv">IPv6</span> <span class="nv">network</span> <span class="ss">(</span><span class="nv">e</span>.<span class="nv">g</span>. <span class="mi">2001</span>:<span class="mi">470</span>:<span class="nv">b368</span>:<span class="mi">4242</span>::<span class="o">/</span><span class="mi">64</span><span class="ss">)</span>
<span class="nv">LXD_IPV6_NETWORK</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">fd94:d372:e27f:2987::1/64</span><span class="s2">&quot;</span>

## <span class="nv">NAT</span> <span class="nv">IPv6</span> <span class="nv">traffic</span>
<span class="nv">LXD_IPV6_NAT</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">true</span><span class="s2">&quot;</span>

# <span class="nv">Run</span> <span class="nv">a</span> <span class="nv">minimal</span> <span class="nv">HTTP</span> <span class="nv">PROXY</span> <span class="nv">server</span>
<span class="nv">LXD_IPV6_PROXY</span><span class="o">=</span><span class="s2">&quot;</span><span class="s">false</span><span class="s2">&quot;</span>
</pre></div>


<p>このブリッジインタフェースを有効にするには <code>lxd-bridge.service</code> を開始します。サービスの定義ファイルは以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">lxd</span><span class="o">-</span><span class="n">bridge</span><span class="p">.</span><span class="n">service</span><span class="w"></span>
<span class="o">[</span><span class="n">Unit</span><span class="o">]</span><span class="w"></span>
<span class="n">Description</span><span class="o">=</span><span class="n">LXD</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="n">bridge</span><span class="w"></span>
<span class="n">Documentation</span><span class="o">=</span><span class="nl">man</span><span class="p">:</span><span class="n">lxd</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="k">Before</span><span class="o">=</span><span class="n">lxd</span><span class="p">.</span><span class="n">service</span><span class="w"></span>

<span class="o">[</span><span class="n">Service</span><span class="o">]</span><span class="w"></span>
<span class="n">Type</span><span class="o">=</span><span class="n">oneshot</span><span class="w"></span>
<span class="n">RemainAfterExit</span><span class="o">=</span><span class="n">yes</span><span class="w"></span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">lxd</span><span class="o">/</span><span class="n">lxd</span><span class="o">-</span><span class="n">bridge</span><span class="p">.</span><span class="k">start</span><span class="w"></span>
<span class="n">ExecStop</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">lxd</span><span class="o">/</span><span class="n">lxd</span><span class="o">-</span><span class="n">bridge</span><span class="w"> </span><span class="n">stop</span><span class="w"></span>
</pre></div>


<p><code>ExecStart</code> に指定しているスクリプトの中身は以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="s s-Atom">cat</span> <span class="o">/</span><span class="s s-Atom">usr</span><span class="o">/</span><span class="s s-Atom">lib</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span><span class="p">.</span><span class="s s-Atom">start</span>
<span class="s s-Atom">#</span><span class="p">!</span><span class="o">/</span><span class="s s-Atom">bin</span><span class="o">/</span><span class="s s-Atom">sh</span> <span class="o">-</span><span class="s s-Atom">e</span>

<span class="p">[</span> <span class="p">!</span> <span class="o">-</span><span class="s s-Atom">e</span> <span class="o">/</span><span class="s s-Atom">etc</span><span class="o">/</span><span class="s s-Atom">default</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span> <span class="p">]</span> <span class="s s-Atom">&amp;&amp;</span> <span class="s s-Atom">exit</span> <span class="mi">0</span>

<span class="p">.</span> <span class="o">/</span><span class="s s-Atom">etc</span><span class="o">/</span><span class="s s-Atom">default</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span>

<span class="s s-Atom">#</span> <span class="nv">Start</span> <span class="s s-Atom">by</span> <span class="s s-Atom">bringing</span> <span class="s s-Atom">up</span> <span class="s s-Atom">the</span> <span class="s s-Atom">bridge</span>
<span class="o">/</span><span class="s s-Atom">usr</span><span class="o">/</span><span class="s s-Atom">lib</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span> <span class="s s-Atom">start</span>

<span class="s s-Atom">#</span> <span class="nv">Switch</span> <span class="nv">LXD</span> <span class="s s-Atom">in</span> <span class="s s-Atom">setup</span> <span class="s s-Atom">mode</span> <span class="s s-Atom">if</span> <span class="s s-Atom">needed</span>
<span class="s s-Atom">if</span> <span class="p">[</span> <span class="s2">&quot;${UPDATE_PROFILE:-true}&quot;</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span> <span class="p">]</span> <span class="s s-Atom">&amp;&amp;</span> <span class="p">[</span> <span class="o">-</span><span class="s s-Atom">e</span> <span class="s2">&quot;/var/lib/lxd&quot;</span> <span class="p">]</span> <span class="s s-Atom">&amp;&amp;</span> <span class="s s-Atom">\</span>
    <span class="p">([</span> <span class="p">!</span> <span class="o">-</span><span class="s s-Atom">e</span> <span class="s2">&quot;/var/lib/lxd-bridge/timestamp&quot;</span> <span class="p">]</span> <span class="p">||</span> <span class="s s-Atom">\</span>
     <span class="p">[</span> <span class="s2">&quot;/etc/default/lxd-bridge&quot;</span> <span class="o">-</span><span class="s s-Atom">nt</span> <span class="s2">&quot;/var/lib/lxd-bridge/timestamp&quot;</span> <span class="p">]);</span> <span class="s s-Atom">then</span>

    <span class="s s-Atom">mkdir</span> <span class="o">-</span><span class="s s-Atom">p</span> <span class="o">/</span><span class="s s-Atom">var</span><span class="o">/</span><span class="s s-Atom">lib</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span>
    <span class="s s-Atom">touch</span> <span class="o">/</span><span class="s s-Atom">var</span><span class="o">/</span><span class="s s-Atom">lib</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span><span class="o">/</span><span class="s s-Atom">timestamp</span>

    <span class="s s-Atom">touch</span> <span class="o">/</span><span class="s s-Atom">var</span><span class="o">/</span><span class="s s-Atom">lib</span><span class="o">/</span><span class="s s-Atom">lxd/.setup_mode</span>
<span class="s s-Atom">fi</span>

<span class="s s-Atom">exit</span> <span class="mi">0</span>
</pre></div>


<p>ここから呼ばれる <code>/usr/lib/lxd/lxd-bridge</code> を見てみると、initスクリプトになっていて <code>iptables</code>, <code>ip6tables</code>, <code>dnsmasq</code> を実行するようになっていました。また <code>/usr/lib/lxd/lxd-bridge</code> は上記の <code>/etc/default/lxd-bridge</code> を読み込むようになっています。</p>
<p>起動された <code>dnsmasq</code> を <code>ps</code> で見ると以下のようなコマンドラインになっていました。</p>
<p>$ ps auxww | grep [d]nsmasq
  lxd       2134  0.0  0.0  49984   388 ?        S    09:48   0:00 dnsmasq -s lxd -S /lxd/ -u lxd --strict-order --bind-interfaces --pid-file=/run/lxd-bridge//dnsmasq.pid --dhcp-no-override --except-interface=lo --interface=lxdbr0 --dhcp-leasefile=/var/lib/lxd-bridge//dnsmasq.lxdbr0.leases --dhcp-authoritative --listen-address 10.16.29.1 --dhcp-range 10.16.29.2,10.16.29.254 --dhcp-lease-max=252 --dhcp-range=fd94:d372:e27f:2987::1,ra-only --listen-address fd94:d372:e27f:2987::1</p>
<p><code>/usr/lib/lxd/lxd-bridge</code> を見ると <code>/etc/default/lxd-bridge</code> の <code>LXD_CONFILE</code> にファイル名を指定しておけば <code>dnsmasq</code> の <code>--conf-file</code> オプションを使ってそのファイルを読み込むように書かれています。この方法を使おうかと思ったのですが、一方で <code>/etc/default/lxd-bridge</code> の設定にかかわらず <code>--dhcp-authoritative</code> オプションが常に指定されるように書かれています。</p>
<p><code>man dnsmasq</code> によると <code>--dhcp-authoritative</code> オプションはネットワーク内に他にDHCPサーバが無く唯一のDHCPになっているときに指定するオプションとのことです。ホストで稼働する <code>dnsmasq</code> が1つという前提であれば、デフォルトの設定ファイル <code>/etc/dnsmasq.conf</code> を作ってそこに設定を書くほうが手っ取り早いので、そうすることにしました。</p>
<h3>lxd-bridge.serviceの設定変更はreloadではなくrestartが必要</h3>
<p><code>sudo systemctl reload lxd-bridge</code> を実行してみると以下のようなエラーが出て失敗しました。</p>
<div class="highlight"><pre><span></span>$ <span class="nv">sudo</span> <span class="nv">systemctl</span> <span class="nv">reload</span> <span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span>
<span class="nv">Failed</span> <span class="nv">to</span> <span class="nv">reload</span> <span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span>.<span class="nv">service</span>: <span class="nv">Job</span> <span class="nv">type</span> <span class="nv">reload</span> <span class="nv">is</span> <span class="nv">not</span> <span class="nv">applicable</span> <span class="k">for</span> <span class="nv">unit</span> <span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span>.<span class="nv">service</span>.
<span class="nv">See</span> <span class="nv">system</span> <span class="nv">logs</span> <span class="nv">and</span> <span class="s1">&#39;</span><span class="s">systemctl status lxd-bridge.service</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="nv">details</span>.
$ <span class="nv">sudo</span> <span class="nv">systemctl</span> <span class="nv">status</span> <span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span>
● <span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span>.<span class="nv">service</span> <span class="o">-</span> <span class="nv">LXD</span> <span class="o">-</span> <span class="nv">network</span> <span class="nv">bridge</span>
   <span class="nv">Loaded</span>: <span class="nv">loaded</span> <span class="ss">(</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">systemd</span><span class="o">/</span><span class="nv">system</span><span class="o">/</span><span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span>.<span class="nv">service</span><span class="c1">; static; vendor preset: enabled)</span>
   <span class="nv">Active</span>: <span class="nv">active</span> <span class="ss">(</span><span class="nv">exited</span><span class="ss">)</span> <span class="nv">since</span> 土 <span class="mi">2016</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">07</span> <span class="mi">13</span>:<span class="mi">06</span>:<span class="mi">06</span> <span class="nv">JST</span><span class="c1">; 6h ago</span>
     <span class="nv">Docs</span>: <span class="nv">man</span>:<span class="nv">lxd</span><span class="ss">(</span><span class="mi">1</span><span class="ss">)</span>
  <span class="nv">Process</span>: <span class="mi">3704</span> <span class="nv">ExecStop</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">lxd</span><span class="o">/</span><span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span> <span class="nv">stop</span> <span class="ss">(</span><span class="nv">code</span><span class="o">=</span><span class="nv">exited</span>, <span class="nv">status</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="nv">SUCCESS</span><span class="ss">)</span>
  <span class="nv">Process</span>: <span class="mi">3723</span> <span class="nv">ExecStart</span><span class="o">=/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">lxd</span><span class="o">/</span><span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span>.<span class="nv">start</span> <span class="ss">(</span><span class="nv">code</span><span class="o">=</span><span class="nv">exited</span>, <span class="nv">status</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="nv">SUCCESS</span><span class="ss">)</span>
 <span class="nv">Main</span> <span class="nv">PID</span>: <span class="mi">3723</span> <span class="ss">(</span><span class="nv">code</span><span class="o">=</span><span class="nv">exited</span>, <span class="nv">status</span><span class="o">=</span><span class="mi">0</span><span class="o">/</span><span class="nv">SUCCESS</span><span class="ss">)</span>
    <span class="nv">Tasks</span>: <span class="mi">1</span> <span class="ss">(</span><span class="nv">limit</span>: <span class="mi">512</span><span class="ss">)</span>
   <span class="nv">Memory</span>: <span class="mi">412</span>.<span class="mi">0</span><span class="nv">K</span>
      <span class="nv">CPU</span>: <span class="mi">1</span>.<span class="mi">293</span><span class="nv">s</span>
   <span class="nv">CGroup</span>: <span class="o">/</span><span class="nv">system</span>.<span class="nv">slice</span><span class="o">/</span><span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span>.<span class="nv">service</span>
           └─<span class="mi">3755</span> <span class="nv">dnsmasq</span> <span class="o">-</span><span class="nv">s</span> <span class="nv">lxd</span> <span class="o">-</span><span class="nv">S</span> <span class="o">/</span><span class="nv">lxd</span><span class="o">/</span> <span class="o">-</span><span class="nv">u</span> <span class="nv">lxd</span> <span class="o">--</span><span class="nv">strict</span><span class="o">-</span><span class="nv">order</span> <span class="o">--</span><span class="nv">bind</span><span class="o">-</span><span class="nv">interfaces</span> <span class="o">--</span><span class="nv">pid</span><span class="o">-</span><span class="nv">file</span><span class="o">=/</span><span class="nv">run</span><span class="o">/</span><span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span><span class="o">//</span><span class="nv">dnsmasq</span>.<span class="nv">pid</span> <span class="o">--</span><span class="nv">dhcp</span><span class="o">-</span><span class="nv">no</span><span class="o">-</span><span class="nv">override</span> <span class="o">--</span><span class="nv">except</span><span class="o">-</span><span class="nv">interface</span><span class="o">=</span><span class="nv">lo</span> <span class="o">--</span><span class="nv">interface</span><span class="o">=</span><span class="nv">lxdbr0</span> <span class="o">--</span><span class="nv">dhcp</span><span class="o">-</span><span class="nv">leasefile</span><span class="o">=/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">lxd</span><span class="o">-</span><span class="nv">bridge</span><span class="o">//</span><span class="nv">dnsmasq</span>.<span class="nv">lxdbr0</span>.<span class="nv">leases</span> <span class="o">--</span><span class="nv">dhcp</span><span class="o">-</span><span class="nv">authoritative</span> <span class="o">--</span><span class="nv">lis</span>
 <span class="mi">5</span>月 <span class="mi">07</span> <span class="mi">18</span>:<span class="mi">56</span>:<span class="mi">28</span> <span class="nv">express</span> <span class="nv">dnsmasq</span><span class="o">-</span><span class="nv">dhcp</span>[<span class="mi">3755</span>]: <span class="nv">not</span> <span class="nv">giving</span> <span class="nv">name</span> <span class="nv">cent02</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">DHCP</span> <span class="nv">lease</span> <span class="nv">of</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="nv">because</span> <span class="nv">the</span> <span class="nv">name</span> <span class="nv">exists</span> <span class="nv">in</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">hosts</span> <span class="nv">with</span> <span class="nv">address</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">201</span>
 <span class="mi">5</span>月 <span class="mi">07</span> <span class="mi">19</span>:<span class="mi">06</span>:<span class="mi">21</span> <span class="nv">express</span> <span class="nv">dnsmasq</span><span class="o">-</span><span class="nv">dhcp</span>[<span class="mi">3755</span>]: <span class="nv">DHCPREQUEST</span><span class="ss">(</span><span class="nv">lxdbr0</span><span class="ss">)</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="mi">00</span>:<span class="mi">16</span>:<span class="mi">3</span><span class="nv">e</span>:<span class="mi">59</span>:<span class="mi">21</span>:<span class="nv">d7</span>
 <span class="mi">5</span>月 <span class="mi">07</span> <span class="mi">19</span>:<span class="mi">06</span>:<span class="mi">21</span> <span class="nv">express</span> <span class="nv">dnsmasq</span><span class="o">-</span><span class="nv">dhcp</span>[<span class="mi">3755</span>]: <span class="nv">DHCPACK</span><span class="ss">(</span><span class="nv">lxdbr0</span><span class="ss">)</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="mi">00</span>:<span class="mi">16</span>:<span class="mi">3</span><span class="nv">e</span>:<span class="mi">59</span>:<span class="mi">21</span>:<span class="nv">d7</span> <span class="nv">cent02</span>
 <span class="mi">5</span>月 <span class="mi">07</span> <span class="mi">19</span>:<span class="mi">06</span>:<span class="mi">21</span> <span class="nv">express</span> <span class="nv">dnsmasq</span><span class="o">-</span><span class="nv">dhcp</span>[<span class="mi">3755</span>]: <span class="nv">not</span> <span class="nv">giving</span> <span class="nv">name</span> <span class="nv">cent02</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">DHCP</span> <span class="nv">lease</span> <span class="nv">of</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="nv">because</span> <span class="nv">the</span> <span class="nv">name</span> <span class="nv">exists</span> <span class="nv">in</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">hosts</span> <span class="nv">with</span> <span class="nv">address</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">201</span>
 <span class="mi">5</span>月 <span class="mi">07</span> <span class="mi">19</span>:<span class="mi">23</span>:<span class="mi">24</span> <span class="nv">express</span> <span class="nv">dnsmasq</span><span class="o">-</span><span class="nv">dhcp</span>[<span class="mi">3755</span>]: <span class="nv">DHCPREQUEST</span><span class="ss">(</span><span class="nv">lxdbr0</span><span class="ss">)</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">101</span> <span class="mi">00</span>:<span class="mi">16</span>:<span class="mi">3</span><span class="nv">e</span>:<span class="mi">5</span><span class="nv">f</span>:<span class="mi">01</span>:<span class="mi">7</span><span class="nv">e</span>
 <span class="mi">5</span>月 <span class="mi">07</span> <span class="mi">19</span>:<span class="mi">23</span>:<span class="mi">24</span> <span class="nv">express</span> <span class="nv">dnsmasq</span><span class="o">-</span><span class="nv">dhcp</span>[<span class="mi">3755</span>]: <span class="nv">DHCPACK</span><span class="ss">(</span><span class="nv">lxdbr0</span><span class="ss">)</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">101</span> <span class="mi">00</span>:<span class="mi">16</span>:<span class="mi">3</span><span class="nv">e</span>:<span class="mi">5</span><span class="nv">f</span>:<span class="mi">01</span>:<span class="mi">7</span><span class="nv">e</span> <span class="nv">cent01</span>
 <span class="mi">5</span>月 <span class="mi">07</span> <span class="mi">19</span>:<span class="mi">23</span>:<span class="mi">24</span> <span class="nv">express</span> <span class="nv">dnsmasq</span><span class="o">-</span><span class="nv">dhcp</span>[<span class="mi">3755</span>]: <span class="nv">not</span> <span class="nv">giving</span> <span class="nv">name</span> <span class="nv">cent02</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">DHCP</span> <span class="nv">lease</span> <span class="nv">of</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="nv">because</span> <span class="nv">the</span> <span class="nv">name</span> <span class="nv">exists</span> <span class="nv">in</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">hosts</span> <span class="nv">with</span> <span class="nv">address</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">201</span>
 <span class="mi">5</span>月 <span class="mi">07</span> <span class="mi">19</span>:<span class="mi">33</span>:<span class="mi">08</span> <span class="nv">express</span> <span class="nv">dnsmasq</span><span class="o">-</span><span class="nv">dhcp</span>[<span class="mi">3755</span>]: <span class="nv">DHCPREQUEST</span><span class="ss">(</span><span class="nv">lxdbr0</span><span class="ss">)</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="mi">00</span>:<span class="mi">16</span>:<span class="mi">3</span><span class="nv">e</span>:<span class="mi">59</span>:<span class="mi">21</span>:<span class="nv">d7</span>
 <span class="mi">5</span>月 <span class="mi">07</span> <span class="mi">19</span>:<span class="mi">33</span>:<span class="mi">08</span> <span class="nv">express</span> <span class="nv">dnsmasq</span><span class="o">-</span><span class="nv">dhcp</span>[<span class="mi">3755</span>]: <span class="nv">DHCPACK</span><span class="ss">(</span><span class="nv">lxdbr0</span><span class="ss">)</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="mi">00</span>:<span class="mi">16</span>:<span class="mi">3</span><span class="nv">e</span>:<span class="mi">59</span>:<span class="mi">21</span>:<span class="nv">d7</span> <span class="nv">cent02</span>
 <span class="mi">5</span>月 <span class="mi">07</span> <span class="mi">19</span>:<span class="mi">33</span>:<span class="mi">08</span> <span class="nv">express</span> <span class="nv">dnsmasq</span><span class="o">-</span><span class="nv">dhcp</span>[<span class="mi">3755</span>]: <span class="nv">not</span> <span class="nv">giving</span> <span class="nv">name</span> <span class="nv">cent02</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">DHCP</span> <span class="nv">lease</span> <span class="nv">of</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="nv">because</span> <span class="nv">the</span> <span class="nv">name</span> <span class="nv">exists</span> <span class="nv">in</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">hosts</span> <span class="nv">with</span> <span class="nv">address</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">201</span>
</pre></div>


<p>ということで、設定ファイルを変更反映するにも <code>sudo systemctl restart lxd-bridge</code> のように再起動する必要があります。</p>
<h3>dnsmasqの再起動後、コンテナの再起動が必要</h3>
<p>dnsmasqを再起動しただけではコンテナのIPアドレスは変わらないのでネットワークを再起動する必要がありました。</p>
<div class="highlight"><pre><span></span><span class="nv">lxc</span> <span class="k">exec</span> <span class="nv">cent01</span> <span class="nv">systemctl</span> <span class="nv">restart</span> <span class="nv">network</span>
<span class="nv">lxc</span> <span class="k">exec</span> <span class="nv">cent02</span> <span class="nv">systemctl</span> <span class="nv">restart</span> <span class="nv">network</span>
</pre></div>


<p>コンテナごと再起動でも良いと思います。</p>
<div class="highlight"><pre><span></span><span class="n">lxc</span> <span class="k">restart</span> <span class="n">cent01</span>
<span class="n">lxc</span> <span class="k">restart</span> <span class="n">cent02</span>
</pre></div>


<p>何回か試してみたところ、作っただけで特に何もしてないコンテナだとネットワーク再起動よりコンテナ自体を再起動するほうが速かったです。</p>
<div class="highlight"><pre><span></span>$ <span class="nv">time</span> <span class="nv">lxc</span> <span class="k">exec</span> <span class="nv">cent02</span> <span class="nv">systemctl</span> <span class="nv">restart</span> <span class="nv">network</span>

<span class="nv">real</span>    <span class="mi">0</span><span class="nv">m2</span>.<span class="mi">878</span><span class="nv">s</span>
<span class="nv">user</span>    <span class="mi">0</span><span class="nv">m0</span>.<span class="mi">008</span><span class="nv">s</span>
<span class="nv">sys</span>     <span class="mi">0</span><span class="nv">m0</span>.<span class="mi">000</span><span class="nv">s</span>
$ <span class="nv">time</span> <span class="nv">lxc</span> <span class="nv">restart</span> <span class="nv">cent02</span>

<span class="nv">real</span>    <span class="mi">0</span><span class="nv">m1</span>.<span class="mi">236</span><span class="nv">s</span>
<span class="nv">user</span>    <span class="mi">0</span><span class="nv">m0</span>.<span class="mi">004</span><span class="nv">s</span>
<span class="nv">sys</span>     <span class="mi">0</span><span class="nv">m0</span>.<span class="mi">004</span><span class="nv">s</span>
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>