<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>LXDのREST APIをcurlで試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/05/07/tried-lxd-rest-api-with-curl/" rel="bookmark"
           title="Permalink to LXDのREST APIをcurlで試してみた">LXDのREST APIをcurlで試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-05-07T21:17:00+09:00">
                Published: 2016-05-07
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/lxd.html">lxd</a> <a href="../../../../tag/curl.html">curl</a> </p>
</footer><!-- /.post-info -->      <h2>LXDのREST API</h2>
<p><a href="https://linuxcontainers.org/ja/lxd/rest-api/">Linux Containers - LXD - REST API</a>と<a href="https://github.com/lxc/lxd/blob/master/doc/rest-api.md">lxd/rest-api.md at master · lxc/lxd</a>にLXDのREST APIについて説明があります。</p>
<p>また<a href="https://github.com/lxc/lxd#using-the-rest-api">Using the REST API</a>に <code>curl</code> コマンドでのAPI呼び出し例が書かれていました。</p>
<h2>curlでhttpsのエンドポイントにアクセスしてみたがエラー</h2>
<p>まずはhttpsのURLで <a href="https://github.com/lxc/lxd/blob/master/doc/rest-api.md#10">/1.0</a> エンドポイントを試してみたのですが、 <code>ALPN, server did not agree to a protocol</code> というエラーになってしまいました。</p>
<div class="highlight"><pre><span></span>$ curl -k -v --cert ~/.config/lxc/client.crt --key ~/.config/lxc/client.key https://127.0.0.1:8443/1.0
*   Trying <span class="m">127</span>.0.0.1...
* Connected to <span class="m">127</span>.0.0.1 <span class="o">(</span><span class="m">127</span>.0.0.1<span class="o">)</span> port <span class="m">8443</span> <span class="o">(</span><span class="c1">#0)</span>
* found <span class="m">173</span> certificates in /etc/ssl/certs/ca-certificates.crt
* found <span class="m">692</span> certificates in /etc/ssl/certs
* ALPN, offering http/1.1
* SSL connection using TLS1.2 / ECDHE_RSA_AES_128_GCM_SHA256
*        server certificate verification SKIPPED
*        server certificate status verification SKIPPED
*        common name: root@express <span class="o">(</span>does not match <span class="s1">&#39;127.0.0.1&#39;</span><span class="o">)</span>
*        server certificate expiration date OK
*        server certificate activation date OK
*        certificate public key: RSA
*        certificate version: <span class="c1">#3</span>
*        subject: <span class="nv">O</span><span class="o">=</span>linuxcontainers.org,CN<span class="o">=</span>root@express
*        start date: Tue, <span class="m">03</span> May <span class="m">2016</span> <span class="m">11</span>:26:51 GMT
*        expire date: Fri, <span class="m">01</span> May <span class="m">2026</span> <span class="m">11</span>:26:51 GMT
*        issuer: <span class="nv">O</span><span class="o">=</span>linuxcontainers.org,CN<span class="o">=</span>root@express
*        compression: NULL
* ALPN, server did not agree to a protocol
&gt; GET /1.0 HTTP/1.1
&gt; Host: <span class="m">127</span>.0.0.1:8443
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 <span class="m">200</span> OK
&lt; Content-Type: application/json
&lt; Date: Sat, <span class="m">07</span> May <span class="m">2016</span> <span class="m">12</span>:25:53 GMT
&lt; Content-Length: <span class="m">162</span>
&lt;
<span class="o">{</span><span class="s2">&quot;type&quot;</span>:<span class="s2">&quot;sync&quot;</span>,<span class="s2">&quot;status&quot;</span>:<span class="s2">&quot;Success&quot;</span>,<span class="s2">&quot;status_code&quot;</span>:200,<span class="s2">&quot;metadata&quot;</span>:<span class="o">{</span><span class="s2">&quot;api_extensions&quot;</span>:<span class="o">[]</span>,<span class="s2">&quot;api_status&quot;</span>:<span class="s2">&quot;stable&quot;</span>,<span class="s2">&quot;api_version&quot;</span>:<span class="s2">&quot;1.0&quot;</span>,<span class="s2">&quot;auth&quot;</span>:<span class="s2">&quot;untrusted&quot;</span>,<span class="s2">&quot;public&quot;</span>:false<span class="o">}}</span>
* Connection <span class="c1">#0 to host 127.0.0.1 left intact</span>
</pre></div>


<p>この件は<a href="https://lists.linuxcontainers.org/pipermail/lxc-users/2016-May/011603.html">[lxc-users] The error "ALPN, server did not agree to a protocol" from LXD Rest API</a>で質問してみました。</p>
<h2>curlでunix domain socket経由でアクセスしてみたら成功</h2>
<p><a href="http://qiita.com/toritori0318/items/193df8f749a9c4bda883">curlでunix domain socket経由アクセスする - Qiita</a>を参考に以下のようにアクセスしてみると成功しました。</p>
<div class="highlight"><pre><span></span>$ curl -s --unix-socket /var/lib/lxd/unix.socket https:/1.0 <span class="p">|</span> jq .
<span class="o">{</span>
  <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;sync&quot;</span>,
  <span class="s2">&quot;status&quot;</span>: <span class="s2">&quot;Success&quot;</span>,
  <span class="s2">&quot;status_code&quot;</span>: <span class="m">200</span>,
  <span class="s2">&quot;metadata&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;api_extensions&quot;</span>: <span class="o">[]</span>,
    <span class="s2">&quot;api_status&quot;</span>: <span class="s2">&quot;stable&quot;</span>,
    <span class="s2">&quot;api_version&quot;</span>: <span class="s2">&quot;1.0&quot;</span>,
    <span class="s2">&quot;auth&quot;</span>: <span class="s2">&quot;trusted&quot;</span>,
    <span class="s2">&quot;config&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;core.https_address&quot;</span>: <span class="s2">&quot;127.0.0.1:8443&quot;</span>,
      <span class="s2">&quot;core.trust_password&quot;</span>: <span class="nb">true</span>
    <span class="o">}</span>,
    <span class="s2">&quot;environment&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;addresses&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;127.0.0.1:8443&quot;</span>
      <span class="o">]</span>,
      <span class="s2">&quot;architectures&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;x86_64&quot;</span>,
        <span class="s2">&quot;i686&quot;</span>
      <span class="o">]</span>,
      <span class="s2">&quot;certificate&quot;</span>: <span class="s2">&quot;-----BEGIN CERTIFICATE-----\n …(略)… \n-----END CERTIFICATE-----\n&quot;</span>,
      <span class="s2">&quot;driver&quot;</span>: <span class="s2">&quot;lxc&quot;</span>,
      <span class="s2">&quot;driver_version&quot;</span>: <span class="s2">&quot;2.0.0&quot;</span>,
      <span class="s2">&quot;kernel&quot;</span>: <span class="s2">&quot;Linux&quot;</span>,
      <span class="s2">&quot;kernel_architecture&quot;</span>: <span class="s2">&quot;x86_64&quot;</span>,
      <span class="s2">&quot;kernel_version&quot;</span>: <span class="s2">&quot;4.4.0-21-generic&quot;</span>,
      <span class="s2">&quot;server&quot;</span>: <span class="s2">&quot;lxd&quot;</span>,
      <span class="s2">&quot;server_pid&quot;</span>: <span class="m">6446</span>,
      <span class="s2">&quot;server_version&quot;</span>: <span class="s2">&quot;2.0.0&quot;</span>,
      <span class="s2">&quot;storage&quot;</span>: <span class="s2">&quot;dir&quot;</span>,
      <span class="s2">&quot;storage_version&quot;</span>: <span class="s2">&quot;&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;public&quot;</span>: <span class="nb">false</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p><code>sudo lxd init</code> でLXDをネットワーク越しに使うかの問いにnoと答えた環境では以下のような出力になりました。</p>
<div class="highlight"><pre><span></span>$ curl -s --unix-socket /var/lib/lxd/unix.socket http:/1.0 <span class="p">|</span> jq .
<span class="o">{</span>
  <span class="s2">&quot;type&quot;</span>: <span class="s2">&quot;sync&quot;</span>,
  <span class="s2">&quot;status&quot;</span>: <span class="s2">&quot;Success&quot;</span>,
  <span class="s2">&quot;status_code&quot;</span>: <span class="m">200</span>,
  <span class="s2">&quot;metadata&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;api_extensions&quot;</span>: <span class="o">[]</span>,
    <span class="s2">&quot;api_status&quot;</span>: <span class="s2">&quot;stable&quot;</span>,
    <span class="s2">&quot;api_version&quot;</span>: <span class="s2">&quot;1.0&quot;</span>,
    <span class="s2">&quot;auth&quot;</span>: <span class="s2">&quot;trusted&quot;</span>,
    <span class="s2">&quot;config&quot;</span>: <span class="o">{}</span>,
    <span class="s2">&quot;environment&quot;</span>: <span class="o">{</span>
      <span class="s2">&quot;addresses&quot;</span>: <span class="o">[]</span>,
      <span class="s2">&quot;architectures&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;x86_64&quot;</span>,
        <span class="s2">&quot;i686&quot;</span>
      <span class="o">]</span>,
      <span class="s2">&quot;certificate&quot;</span>: <span class="s2">&quot;-----BEGIN CERTIFICATE-----\n …(略)… \n-----END CERTIFICATE-----\n&quot;</span>,
      <span class="s2">&quot;driver&quot;</span>: <span class="s2">&quot;lxc&quot;</span>,
      <span class="s2">&quot;driver_version&quot;</span>: <span class="s2">&quot;2.0.0&quot;</span>,
      <span class="s2">&quot;kernel&quot;</span>: <span class="s2">&quot;Linux&quot;</span>,
      <span class="s2">&quot;kernel_architecture&quot;</span>: <span class="s2">&quot;x86_64&quot;</span>,
      <span class="s2">&quot;kernel_version&quot;</span>: <span class="s2">&quot;4.4.0-21-generic&quot;</span>,
      <span class="s2">&quot;server&quot;</span>: <span class="s2">&quot;lxd&quot;</span>,
      <span class="s2">&quot;server_pid&quot;</span>: <span class="m">2150</span>,
      <span class="s2">&quot;server_version&quot;</span>: <span class="s2">&quot;2.0.0&quot;</span>,
      <span class="s2">&quot;storage&quot;</span>: <span class="s2">&quot;dir&quot;</span>,
      <span class="s2">&quot;storage_version&quot;</span>: <span class="s2">&quot;&quot;</span>
    <span class="o">}</span>,
    <span class="s2">&quot;public&quot;</span>: <span class="nb">false</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>