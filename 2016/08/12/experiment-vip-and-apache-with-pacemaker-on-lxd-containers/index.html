<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>LXDコンテナ上でPacemakerを使って仮想IPとApacheのアクティブ・パッシブ・クラスタを試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/08/12/experiment-vip-and-apache-with-pacemaker-on-lxd-containers/" rel="bookmark"
           title="Permalink to LXDコンテナ上でPacemakerを使って仮想IPとApacheのアクティブ・パッシブ・クラスタを試してみた">LXDコンテナ上でPacemakerを使って仮想IPとApacheのアクティブ・パッシブ・クラスタを試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-08-12T18:54:00+09:00">
                Published: 2016-08-12
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/pacemaker.html">pacemaker</a> <a href="../../../../tag/virtual-ip.html">virtual-ip</a> </p>
</footer><!-- /.post-info -->      <p><a href="http://clusterlabs.org/doc/">Cluster Labs - Pacemaker Documentation</a> の "Pacemaker 1.1 for Corosync 2.x and pcs" の "Clusters from Scratch (en-US)" を参考にしつつ、多少手順を変更して試してみました。</p>
<h2>実験用コンテナの環境構築</h2>
<h3>コンテナの作成</h3>
<p><a href="/blog/2016/08/12/update-lxd-dnsmasq-dhcp-hosts-config-with-sighup/">LXDのdnsmasqの固定IP設定をSIGHUPで更新する · hnakamur's blog at github</a> の手法を使って、2つのコンテナ用のIPアドレスを設定しておきます。</p>
<div class="highlight"><pre><span></span><span class="n">lxdhost</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">cat</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">lxd</span><span class="o">-</span><span class="n">bridge</span><span class="o">/</span><span class="n">dhcp</span><span class="o">-</span><span class="n">hosts</span> 
<span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">.</span><span class="mi">155</span><span class="p">.</span><span class="mi">92</span><span class="p">.</span><span class="mi">101</span>
<span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">.</span><span class="mi">155</span><span class="p">.</span><span class="mi">92</span><span class="p">.</span><span class="mi">102</span>
</pre></div>


<p>また、仮想IPとして <code>10.155.92.100</code> を使用しますので、 <code>/var/lib/lxd-bridge/dnsmasq.lxdbr0.leases</code> で使われていないことを確認しておきます。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">kill</span> <span class="o">-</span><span class="n">HUP</span> <span class="o">`</span><span class="n">cat</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">lxd</span><span class="o">-</span><span class="n">bridge</span><span class="o">/</span><span class="n">dnsmasq</span><span class="p">.</span><span class="n">pid</span><span class="o">`</span>
</pre></div>


<p>で設定を dnsmasq に反映します。</p>
<p>なお、  <a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html/Clusters_from_Scratch/ch02.html#_configure_network">2.1.3. Configure Network</a> の "Important" の囲み部分によるとDHCPはcorosyncと干渉するので、 <strong>クラスタのマシンはDHCPを決して使うべきではない</strong> そうです。この記事はあくまでPacemakerの使い方を把握するために試してみるだけなので気にしないことにしますが、実運用の際には DHCP を使わない構成にする必要があります。</p>
<p>以下のコマンドでコンテナ <code>pcmk-1</code> と <code>pcmk-2</code> を作成します。</p>
<div class="highlight"><pre><span></span><span class="n">lxdhost</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">lxc</span> <span class="n">launch</span> <span class="n">images</span><span class="p">:</span><span class="n">centos</span><span class="o">/</span><span class="mi">7</span><span class="o">/</span><span class="n">amd64</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
<span class="n">lxdhost</span><span class="p">:</span><span class="o">~</span><span class="err">$</span> <span class="n">lxc</span> <span class="n">launch</span> <span class="n">images</span><span class="p">:</span><span class="n">centos</span><span class="o">/</span><span class="mi">7</span><span class="o">/</span><span class="n">amd64</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>
</pre></div>


<h3>コンテナ内の /etc/hosts 設定</h3>
<p>端末を2つ開いて <code>lxc exec pcmk-1 bash</code> と <code>lxc exec pcmk-2 bash</code> を実行し、それぞれ環境構築していきます。</p>
<p>まず、コンテナ作成直後の <code>pcmk-1</code> の <code>/etc/hosts</code> を確認すると以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>   <span class="nv">localhost</span>
<span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">1</span>.<span class="mi">1</span>   <span class="nv">pcmk</span><span class="o">-</span><span class="mi">1</span>

# <span class="nv">The</span> <span class="nv">following</span> <span class="nv">lines</span> <span class="nv">are</span> <span class="nv">desirable</span> <span class="k">for</span> <span class="nv">IPv6</span> <span class="nv">capable</span> <span class="nv">hosts</span>
::<span class="mi">1</span>     <span class="nv">ip6</span><span class="o">-</span><span class="nv">localhost</span> <span class="nv">ip6</span><span class="o">-</span><span class="nv">loopback</span>
<span class="nv">fe00</span>::<span class="mi">0</span> <span class="nv">ip6</span><span class="o">-</span><span class="nv">localnet</span>
<span class="nv">ff00</span>::<span class="mi">0</span> <span class="nv">ip6</span><span class="o">-</span><span class="nv">mcastprefix</span>
<span class="nv">ff02</span>::<span class="mi">1</span> <span class="nv">ip6</span><span class="o">-</span><span class="nv">allnodes</span>
<span class="nv">ff02</span>::<span class="mi">2</span> <span class="nv">ip6</span><span class="o">-</span><span class="nv">allrouters</span>
</pre></div>


<p>当初 <code>pcmk-1</code> ではIPv4の部分を</p>
<div class="highlight"><pre><span></span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span>   <span class="n">localhost</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span>   <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
<span class="mi">10</span><span class="p">.</span><span class="mi">155</span><span class="p">.</span><span class="mi">92</span><span class="p">.</span><span class="mi">102</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>
</pre></div>


<p>と変更し、 <code>pcmk-2</code> では</p>
<div class="highlight"><pre><span></span><span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span>   <span class="n">localhost</span>
<span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">1</span>   <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>
<span class="mi">10</span><span class="p">.</span><span class="mi">155</span><span class="p">.</span><span class="mi">92</span><span class="p">.</span><span class="mi">101</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
</pre></div>


<p>と変更してみたのですが、Pacemakerがうまく動かなかったようです（要追試）。</p>
<p><code>pcmk-1</code> と <code>pcmk-2</code> で <code>/etc/hosts</code> の IPv4 部分を以下のコマンドで変更したら、うまくいったので、とりあえずこれで試しました。</p>
<div class="highlight"><pre><span></span># <span class="nv">cat</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">hosts</span> <span class="o">&lt;&lt;</span><span class="s1">&#39;</span><span class="s">EOF</span><span class="s1">&#39;</span>
<span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>   <span class="nv">localhost</span>

<span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">101</span>   <span class="nv">pcmk</span><span class="o">-</span><span class="mi">1</span>
<span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span>   <span class="nv">pcmk</span><span class="o">-</span><span class="mi">2</span>

# <span class="nv">The</span> <span class="nv">following</span> <span class="nv">lines</span> <span class="nv">are</span> <span class="nv">desirable</span> <span class="k">for</span> <span class="nv">IPv6</span> <span class="nv">capable</span> <span class="nv">hosts</span>
::<span class="mi">1</span>     <span class="nv">ip6</span><span class="o">-</span><span class="nv">localhost</span> <span class="nv">ip6</span><span class="o">-</span><span class="nv">loopback</span>
<span class="nv">fe00</span>::<span class="mi">0</span> <span class="nv">ip6</span><span class="o">-</span><span class="nv">localnet</span>
<span class="nv">ff00</span>::<span class="mi">0</span> <span class="nv">ip6</span><span class="o">-</span><span class="nv">mcastprefix</span>
<span class="nv">ff02</span>::<span class="mi">1</span> <span class="nv">ip6</span><span class="o">-</span><span class="nv">allnodes</span>
<span class="nv">ff02</span>::<span class="mi">2</span> <span class="nv">ip6</span><span class="o">-</span><span class="nv">allrouters</span>
<span class="nv">EOF</span>
</pre></div>


<h3>Pacemakerのインストール</h3>
<p><code>pcmk-1</code> と <code>pcmk-2</code> で以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="k">update</span>
<span class="o">#</span> <span class="n">yum</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">pacemaker</span> <span class="n">pcs</span> <span class="n">psmisc</span> <span class="n">policycoreutils</span><span class="o">-</span><span class="n">python</span> <span class="n">which</span>
</pre></div>


<p>whichは仮想IPを使うための ocf:heartbeat:IPaddr2 のリソース用の resource agent スクリプト <code>/usr/lib/ocf/resource.d/heartbeat/IPaddr2</code> で必要となります。</p>
<p><code>pcsd</code> サービスを起動し、OS起動時に自動起動するようにします。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">systemctl</span> <span class="k">start</span> <span class="n">pcsd</span>
<span class="o">#</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">pcsd</span>
</pre></div>


<h2>クラスタを作成して仮想IPの作成・移動実験</h2>
<h3>クラスタの作成と開始</h3>
<p><code>hacluster</code> のパスワードを設定します。ここでは <code>password</code> という値にしていますが適宜変更してください。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">echo</span> <span class="n">password</span> <span class="o">|</span> <span class="n">passwd</span> <span class="c1">--stdin hacluster</span>
</pre></div>


<p>ここから先は <code>pcmk-1</code> だけでコマンドを実行します。 <code>-p</code> の値は上で設定したパスワードに合わせてください。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="k">cluster</span> <span class="n">auth</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="o">-</span><span class="n">u</span> <span class="n">hacluster</span> <span class="o">-</span><span class="n">p</span> <span class="n">password</span>
<span class="o">#</span> <span class="n">pcs</span> <span class="k">cluster</span> <span class="n">setup</span> <span class="c1">--name mycluster pcmk-1 pcmk-2</span>
</pre></div>


<p>この時点で <code>/etc/corosync/corosync.conf</code> が作られます。</p>
<p>以下のコマンドでクラスタを開始します。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="k">cluster</span> <span class="k">start</span> <span class="c1">--all</span>
</pre></div>


<p>起動してすぐにステータスを確認すると Node の行が UNCLEAN (offline) になりました。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">status</span><span class="w"></span>
<span class="n">Cluster</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">mycluster</span><span class="w"></span>
<span class="nl">WARNING</span><span class="p">:</span><span class="w"> </span><span class="k">no</span><span class="w"> </span><span class="n">stonith</span><span class="w"> </span><span class="n">devices</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">stonith</span><span class="o">-</span><span class="n">enabled</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="k">false</span><span class="w"></span>
<span class="k">Last</span><span class="w"> </span><span class="nl">updated</span><span class="p">:</span><span class="w"> </span><span class="n">Thu</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="err">:</span><span class="mi">55</span><span class="err">:</span><span class="mi">17</span><span class="w"> </span><span class="mi">2016</span><span class="w">          </span><span class="k">Last</span><span class="w"> </span><span class="nl">change</span><span class="p">:</span><span class="w"> </span><span class="n">Thu</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">15</span><span class="err">:</span><span class="mi">55</span><span class="err">:</span><span class="mi">16</span><span class="w"> </span><span class="mi">2016</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">hacluster</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">crmd</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="nl">Stack</span><span class="p">:</span><span class="w"> </span><span class="k">unknown</span><span class="w"></span>
<span class="k">Current</span><span class="w"> </span><span class="nl">DC</span><span class="p">:</span><span class="w"> </span><span class="k">NONE</span><span class="w"></span>
<span class="mi">2</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">resources</span><span class="w"> </span><span class="n">configured</span><span class="w"></span>

<span class="n">Node</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">UNCLEAN</span><span class="w"> </span><span class="p">(</span><span class="n">offline</span><span class="p">)</span><span class="w"></span>
<span class="n">Node</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="n">UNCLEAN</span><span class="w"> </span><span class="p">(</span><span class="n">offline</span><span class="p">)</span><span class="w"></span>

<span class="k">Full</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nl">resources</span><span class="p">:</span><span class="w"></span>


<span class="n">PCSD</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">Online</span><span class="w"></span>
<span class="w">  </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="n">Online</span><span class="w"></span>

<span class="n">Daemon</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nl">corosync</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">disabled</span><span class="w"></span>
<span class="w">  </span><span class="nl">pacemaker</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">disabled</span><span class="w"></span>
<span class="w">  </span><span class="nl">pcsd</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">enabled</span><span class="w"></span>
</pre></div>


<p>しばらくしてから再度ステータスを確認すると pcmk-1 も pcmk-2 も Online になっていました。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="n">status</span>
<span class="k">Cluster</span> <span class="n">name</span><span class="p">:</span> <span class="n">mycluster</span>
<span class="n">WARNING</span><span class="p">:</span> <span class="k">no</span> <span class="n">stonith</span> <span class="n">devices</span> <span class="k">and</span> <span class="n">stonith</span><span class="o">-</span><span class="n">enabled</span> <span class="k">is</span> <span class="k">not</span> <span class="k">false</span>
<span class="k">Last</span> <span class="n">updated</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Aug</span> <span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">41</span> <span class="mi">2016</span>          <span class="k">Last</span> <span class="n">change</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Aug</span> <span class="mi">11</span> <span class="mi">15</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">37</span> <span class="mi">2016</span> <span class="k">by</span> <span class="n">hacluster</span> <span class="n">via</span> <span class="n">crmd</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>
<span class="n">Stack</span><span class="p">:</span> <span class="n">corosync</span>
<span class="k">Current</span> <span class="n">DC</span><span class="p">:</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">(</span><span class="k">version</span> <span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">10</span><span class="p">.</span><span class="n">el7_2</span><span class="p">.</span><span class="mi">4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span> <span class="o">-</span> <span class="n">partition</span> <span class="k">with</span> <span class="n">quorum</span>
<span class="mi">2</span> <span class="n">nodes</span> <span class="k">and</span> <span class="mi">0</span> <span class="n">resources</span> <span class="n">configured</span>

<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

<span class="k">Full</span> <span class="n">list</span> <span class="k">of</span> <span class="n">resources</span><span class="p">:</span>


<span class="n">PCSD</span> <span class="n">Status</span><span class="p">:</span>
  <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Online</span>
  <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Online</span>

<span class="n">Daemon</span> <span class="n">Status</span><span class="p">:</span>
  <span class="n">corosync</span><span class="p">:</span> <span class="n">active</span><span class="o">/</span><span class="n">disabled</span>
  <span class="n">pacemaker</span><span class="p">:</span> <span class="n">active</span><span class="o">/</span><span class="n">disabled</span>
  <span class="n">pcsd</span><span class="p">:</span> <span class="n">active</span><span class="o">/</span><span class="n">enabled</span>
</pre></div>


<h3>STONITHを無効化</h3>
<p><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html/Clusters_from_Scratch/ch05.html">Chapter 5. Create an Active/Passive Cluster</a>の手順でクラスタの設定エラーを確認します。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">crm_verify</span> <span class="o">-</span><span class="n">L</span> <span class="o">-</span><span class="n">V</span>
   <span class="n">error</span><span class="p">:</span> <span class="n">unpack_resources</span><span class="p">:</span>     <span class="n">Resource</span> <span class="k">start</span><span class="o">-</span><span class="n">up</span> <span class="n">disabled</span> <span class="n">since</span> <span class="k">no</span> <span class="n">STONITH</span> <span class="n">resources</span> <span class="n">have</span> <span class="n">been</span> <span class="k">defined</span>
   <span class="n">error</span><span class="p">:</span> <span class="n">unpack_resources</span><span class="p">:</span>     <span class="n">Either</span> <span class="n">configure</span> <span class="k">some</span> <span class="k">or</span> <span class="n">disable</span> <span class="n">STONITH</span> <span class="k">with</span> <span class="n">the</span> <span class="n">stonith</span><span class="o">-</span><span class="n">enabled</span> <span class="k">option</span>
   <span class="n">error</span><span class="p">:</span> <span class="n">unpack_resources</span><span class="p">:</span>     <span class="n">NOTE</span><span class="p">:</span> <span class="n">Clusters</span> <span class="k">with</span> <span class="n">shared</span> <span class="k">data</span> <span class="n">need</span> <span class="n">STONITH</span> <span class="k">to</span> <span class="n">ensure</span> <span class="k">data</span> <span class="n">integrity</span>
<span class="n">Errors</span> <span class="k">found</span> <span class="n">during</span> <span class="k">check</span><span class="p">:</span> <span class="n">config</span> <span class="k">not</span> <span class="k">valid</span>
</pre></div>


<p>ここでは簡単に Pacemaker を試すために STONITH を無効にします。無効にしたあと設定エラーを再度確認すると、今度はエラーが無くなりました。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="n">property</span> <span class="k">set</span> <span class="n">stonith</span><span class="o">-</span><span class="n">enabled</span><span class="o">=</span><span class="k">false</span>
<span class="o">#</span> <span class="n">crm_verify</span> <span class="o">-</span><span class="n">L</span> <span class="o">-</span><span class="n">V</span>
</pre></div>


<p>なお、 <a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html/Clusters_from_Scratch/ch05.html">Chapter 5. Create an Active/Passive Cluster</a> の最後の Warning にもある通り、 <strong>実運用では STONITH を無効にするのは全く不適切</strong> とのことなので、きちんと設定する必要があります。 STONITH についての説明は上記の Warning の囲み内からもリンクされている <a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html/Clusters_from_Scratch/ch08.html#_what_is_stonith">Chapter 8. Configure STONITH</a> を参照してください。</p>
<h3>仮想IPアドレス用のリソース作成</h3>
<p><code>pcmk-1</code> で以下のコマンドを実行して、仮想IPアドレス <code>10.155.92.100</code> 用のリソースを作成します。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="n">resource</span> <span class="k">create</span> <span class="n">ClusterIP</span> <span class="n">ocf</span><span class="p">:</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span> <span class="err">\</span>
    <span class="n">ip</span><span class="o">=</span><span class="mi">10</span><span class="p">.</span><span class="mi">155</span><span class="p">.</span><span class="mi">92</span><span class="p">.</span><span class="mi">100</span> <span class="n">cidr_netmask</span><span class="o">=</span><span class="mi">32</span> <span class="n">op</span> <span class="n">monitor</span> <span class="nb">interval</span><span class="o">=</span><span class="mi">30</span><span class="n">s</span>
</pre></div>


<p>数秒してから状態を確認してみます。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="n">status</span>
<span class="k">Cluster</span> <span class="n">name</span><span class="p">:</span> <span class="n">mycluster</span>
<span class="k">Last</span> <span class="n">updated</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Aug</span> <span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">50</span> <span class="mi">2016</span>          <span class="k">Last</span> <span class="n">change</span><span class="p">:</span> <span class="n">Thu</span> <span class="n">Aug</span> <span class="mi">11</span> <span class="mi">16</span><span class="p">:</span><span class="mi">04</span><span class="p">:</span><span class="mi">47</span> <span class="mi">2016</span> <span class="k">by</span> <span class="n">root</span> <span class="n">via</span> <span class="n">cibadmin</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
<span class="n">Stack</span><span class="p">:</span> <span class="n">corosync</span>
<span class="k">Current</span> <span class="n">DC</span><span class="p">:</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">(</span><span class="k">version</span> <span class="mi">1</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span><span class="mi">13</span><span class="o">-</span><span class="mi">10</span><span class="p">.</span><span class="n">el7_2</span><span class="p">.</span><span class="mi">4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span> <span class="o">-</span> <span class="n">partition</span> <span class="k">with</span> <span class="n">quorum</span>
<span class="mi">2</span> <span class="n">nodes</span> <span class="k">and</span> <span class="mi">1</span> <span class="n">resource</span> <span class="n">configured</span>

<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

<span class="k">Full</span> <span class="n">list</span> <span class="k">of</span> <span class="n">resources</span><span class="p">:</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>

<span class="n">PCSD</span> <span class="n">Status</span><span class="p">:</span>
  <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">Online</span>
  <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="n">Online</span>

<span class="n">Daemon</span> <span class="n">Status</span><span class="p">:</span>
  <span class="n">corosync</span><span class="p">:</span> <span class="n">active</span><span class="o">/</span><span class="n">disabled</span>
  <span class="n">pacemaker</span><span class="p">:</span> <span class="n">active</span><span class="o">/</span><span class="n">disabled</span>
  <span class="n">pcsd</span><span class="p">:</span> <span class="n">active</span><span class="o">/</span><span class="n">enabled</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="n">resource</span> <span class="c1">--full</span>
 <span class="n">Resource</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="p">(</span><span class="k">class</span><span class="o">=</span><span class="n">ocf</span> <span class="n">provider</span><span class="o">=</span><span class="n">heartbeat</span> <span class="k">type</span><span class="o">=</span><span class="n">IPaddr2</span><span class="p">)</span>
  <span class="n">Attributes</span><span class="p">:</span> <span class="n">ip</span><span class="o">=</span><span class="mi">10</span><span class="p">.</span><span class="mi">155</span><span class="p">.</span><span class="mi">92</span><span class="p">.</span><span class="mi">100</span> <span class="n">cidr_netmask</span><span class="o">=</span><span class="mi">32</span> 
  <span class="n">Operations</span><span class="p">:</span> <span class="k">start</span> <span class="nb">interval</span><span class="o">=</span><span class="mi">0</span><span class="n">s</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="n">s</span> <span class="p">(</span><span class="n">ClusterIP</span><span class="o">-</span><span class="k">start</span><span class="o">-</span><span class="nb">interval</span><span class="o">-</span><span class="mi">0</span><span class="n">s</span><span class="p">)</span>
              <span class="n">stop</span> <span class="nb">interval</span><span class="o">=</span><span class="mi">0</span><span class="n">s</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">20</span><span class="n">s</span> <span class="p">(</span><span class="n">ClusterIP</span><span class="o">-</span><span class="n">stop</span><span class="o">-</span><span class="nb">interval</span><span class="o">-</span><span class="mi">0</span><span class="n">s</span><span class="p">)</span>
              <span class="n">monitor</span> <span class="nb">interval</span><span class="o">=</span><span class="mi">30</span><span class="n">s</span> <span class="p">(</span><span class="n">ClusterIP</span><span class="o">-</span><span class="n">monitor</span><span class="o">-</span><span class="nb">interval</span><span class="o">-</span><span class="mi">30</span><span class="n">s</span><span class="p">)</span>
</pre></div>


<p><code>ip</code> コマンドを実行して、仮想IPアドレスが <code>pcmk-1</code> 側についており <code>pcmk-2</code> 側にはついていないことを確認します。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="mi">120</span><span class="err">:</span><span class="w"> </span><span class="n">eth0</span><span class="nv">@if121</span><span class="err">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mtu</span><span class="w"> </span><span class="mi">1500</span><span class="w"> </span><span class="n">qdisc</span><span class="w"> </span><span class="n">noqueue</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">UP</span><span class="w"> </span><span class="n">qlen</span><span class="w"> </span><span class="mi">1000</span><span class="w"></span>
<span class="w">    </span><span class="n">link</span><span class="o">/</span><span class="n">ether</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">16</span><span class="err">:</span><span class="mi">3</span><span class="nl">e</span><span class="p">:</span><span class="nl">e6</span><span class="p">:</span><span class="nl">fb</span><span class="p">:</span><span class="n">ab</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="n">ff</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">netnsid</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">inet</span><span class="w"> </span><span class="mf">10.155.92.101</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="mf">10.155.92.255</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">dynamic</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="mi">3203</span><span class="n">sec</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="mi">3203</span><span class="n">sec</span><span class="w"></span>
<span class="w">    </span><span class="n">inet</span><span class="w"> </span><span class="mf">10.155.92.100</span><span class="o">/</span><span class="mi">32</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="mf">10.155.92.255</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"></span>
<span class="w">    </span><span class="n">inet6</span><span class="w"> </span><span class="nl">fe80</span><span class="p">:</span><span class="err">:</span><span class="mi">216</span><span class="err">:</span><span class="mi">3</span><span class="nl">eff</span><span class="p">:</span><span class="nl">fee6</span><span class="p">:</span><span class="n">fbab</span><span class="o">/</span><span class="mi">64</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="n">link</span><span class="w"> </span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"></span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="mi">122</span><span class="err">:</span><span class="w"> </span><span class="n">eth0</span><span class="nv">@if123</span><span class="err">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mtu</span><span class="w"> </span><span class="mi">1500</span><span class="w"> </span><span class="n">qdisc</span><span class="w"> </span><span class="n">noqueue</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">UP</span><span class="w"> </span><span class="n">qlen</span><span class="w"> </span><span class="mi">1000</span><span class="w"></span>
<span class="w">    </span><span class="n">link</span><span class="o">/</span><span class="n">ether</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">16</span><span class="err">:</span><span class="mi">3</span><span class="nl">e</span><span class="p">:</span><span class="mi">4</span><span class="nl">b</span><span class="p">:</span><span class="mi">6</span><span class="nl">d</span><span class="p">:</span><span class="n">b1</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="n">ff</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">netnsid</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">inet</span><span class="w"> </span><span class="mf">10.155.92.102</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="mf">10.155.92.255</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">dynamic</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="mi">3560</span><span class="n">sec</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="mi">3560</span><span class="n">sec</span><span class="w"></span>
<span class="w">    </span><span class="n">inet6</span><span class="w"> </span><span class="nl">fe80</span><span class="p">:</span><span class="err">:</span><span class="mi">216</span><span class="err">:</span><span class="mi">3</span><span class="nl">eff</span><span class="p">:</span><span class="nl">fe4b</span><span class="p">:</span><span class="mi">6</span><span class="n">db1</span><span class="o">/</span><span class="mi">64</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="n">link</span><span class="w"> </span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"></span>
</pre></div>


<h3><code>pcmk-1</code> をクラスタから離脱させて仮想IPアドレスが <code>pcmk-2</code> に移動するか確認</h3>
<p>以下のコマンドで <code>pcmk-1</code> をクラスタから離脱させます。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">Stopping</span><span class="w"> </span><span class="n">Cluster</span><span class="w"> </span><span class="p">(</span><span class="n">pacemaker</span><span class="p">)...</span><span class="w"></span>
<span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">Stopping</span><span class="w"> </span><span class="n">Cluster</span><span class="w"> </span><span class="p">(</span><span class="n">corosync</span><span class="p">)...</span><span class="w"></span>
</pre></div>


<p><code>pcmk-1</code> で状態を確認すると以下のようになります。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">status</span><span class="w"></span>
<span class="nl">Error</span><span class="p">:</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">node</span><span class="w"></span>
</pre></div>


<p><code>pcmk-2</code> で状態を確認すると以下のようになります。 <code>pcmk-1</code> は <code>OFFLINE</code> となっていますが、 <code>pcsd</code> は動いているので <code>PCSD Status</code> のほうは <code>Online</code> のままです。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">status</span><span class="w"></span>
<span class="n">Cluster</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">mycluster</span><span class="w"></span>
<span class="k">Last</span><span class="w"> </span><span class="nl">updated</span><span class="p">:</span><span class="w"> </span><span class="n">Thu</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">10</span><span class="err">:</span><span class="mi">04</span><span class="w"> </span><span class="mi">2016</span><span class="w">          </span><span class="k">Last</span><span class="w"> </span><span class="nl">change</span><span class="p">:</span><span class="w"> </span><span class="n">Thu</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">04</span><span class="err">:</span><span class="mi">47</span><span class="w"> </span><span class="mi">2016</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">cibadmin</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="nl">Stack</span><span class="p">:</span><span class="w"> </span><span class="n">corosync</span><span class="w"></span>
<span class="k">Current</span><span class="w"> </span><span class="nl">DC</span><span class="p">:</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="mf">1.1.13</span><span class="o">-</span><span class="mf">10.</span><span class="n">el7_2</span><span class="mf">.4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">partition</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">quorum</span><span class="w"></span>
<span class="mi">2</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="n">configured</span><span class="w"></span>

<span class="nl">Online</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n"> pcmk-2 </span><span class="o">]</span><span class="w"></span>
<span class="nl">OFFLINE</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n"> pcmk-1 </span><span class="o">]</span><span class="w"></span>

<span class="k">Full</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nl">resources</span><span class="p">:</span><span class="w"></span>

<span class="w"> </span><span class="n">ClusterIP</span><span class="w">      </span><span class="p">(</span><span class="nl">ocf</span><span class="p">:</span><span class="err">:</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">)</span><span class="err">:</span><span class="w">       </span><span class="n">Started</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="w"></span>

<span class="n">PCSD</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">Online</span><span class="w"></span>
<span class="w">  </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="n">Online</span><span class="w"></span>

<span class="n">Daemon</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nl">corosync</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">disabled</span><span class="w"></span>
<span class="w">  </span><span class="nl">pacemaker</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">disabled</span><span class="w"></span>
<span class="w">  </span><span class="nl">pcsd</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">enabled</span><span class="w"></span>
</pre></div>


<p><code>ip</code> コマンドを実行して、仮想IPアドレスが <code>pcmk-2</code> 側についており <code>pcmk-1</code> 側にはついていないことを確認します。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="mi">120</span><span class="err">:</span><span class="w"> </span><span class="n">eth0</span><span class="nv">@if121</span><span class="err">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mtu</span><span class="w"> </span><span class="mi">1500</span><span class="w"> </span><span class="n">qdisc</span><span class="w"> </span><span class="n">noqueue</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">UP</span><span class="w"> </span><span class="n">qlen</span><span class="w"> </span><span class="mi">1000</span><span class="w"></span>
<span class="w">    </span><span class="n">link</span><span class="o">/</span><span class="n">ether</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">16</span><span class="err">:</span><span class="mi">3</span><span class="nl">e</span><span class="p">:</span><span class="nl">e6</span><span class="p">:</span><span class="nl">fb</span><span class="p">:</span><span class="n">ab</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="n">ff</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">netnsid</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">inet</span><span class="w"> </span><span class="mf">10.155.92.101</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="mf">10.155.92.255</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">dynamic</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="mi">3024</span><span class="n">sec</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="mi">3024</span><span class="n">sec</span><span class="w"></span>
<span class="w">    </span><span class="n">inet6</span><span class="w"> </span><span class="nl">fe80</span><span class="p">:</span><span class="err">:</span><span class="mi">216</span><span class="err">:</span><span class="mi">3</span><span class="nl">eff</span><span class="p">:</span><span class="nl">fee6</span><span class="p">:</span><span class="n">fbab</span><span class="o">/</span><span class="mi">64</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="n">link</span><span class="w"> </span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"></span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="mi">122</span><span class="err">:</span><span class="w"> </span><span class="n">eth0</span><span class="nv">@if123</span><span class="err">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mtu</span><span class="w"> </span><span class="mi">1500</span><span class="w"> </span><span class="n">qdisc</span><span class="w"> </span><span class="n">noqueue</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">UP</span><span class="w"> </span><span class="n">qlen</span><span class="w"> </span><span class="mi">1000</span><span class="w"></span>
<span class="w">    </span><span class="n">link</span><span class="o">/</span><span class="n">ether</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">16</span><span class="err">:</span><span class="mi">3</span><span class="nl">e</span><span class="p">:</span><span class="mi">4</span><span class="nl">b</span><span class="p">:</span><span class="mi">6</span><span class="nl">d</span><span class="p">:</span><span class="n">b1</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="n">ff</span><span class="w"> </span><span class="n">link</span><span class="o">-</span><span class="n">netnsid</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">    </span><span class="n">inet</span><span class="w"> </span><span class="mf">10.155.92.102</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="mf">10.155.92.255</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">dynamic</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="mi">3385</span><span class="n">sec</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="mi">3385</span><span class="n">sec</span><span class="w"></span>
<span class="w">    </span><span class="n">inet</span><span class="w"> </span><span class="mf">10.155.92.100</span><span class="o">/</span><span class="mi">32</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="mf">10.155.92.255</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"></span>
<span class="w">    </span><span class="n">inet6</span><span class="w"> </span><span class="nl">fe80</span><span class="p">:</span><span class="err">:</span><span class="mi">216</span><span class="err">:</span><span class="mi">3</span><span class="nl">eff</span><span class="p">:</span><span class="nl">fe4b</span><span class="p">:</span><span class="mi">6</span><span class="n">db1</span><span class="o">/</span><span class="mi">64</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="n">link</span><span class="w"> </span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"></span>
</pre></div>


<h3><code>pcmk-1</code> をクラスタに復帰させる</h3>
<p>以下のコマンドで <code>pcmk-1</code> をクラスタに復帰させます。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">Cluster</span><span class="p">...</span><span class="w"></span>
</pre></div>


<p>状態を確認してみると、仮想IP は <code>pcmk-2</code> のほうについたままです。
<a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html/Clusters_from_Scratch/_perform_a_failover.html">5.3. Perform a Failover</a> の最後の Note によると Pacemakerのより古いバージョンでは <code>pcmk-1</code> のほうに切り替わっていたそうですが、挙動が変更されたとのことです。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">status</span><span class="w"></span>
<span class="n">Cluster</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">mycluster</span><span class="w"></span>
<span class="k">Last</span><span class="w"> </span><span class="nl">updated</span><span class="p">:</span><span class="w"> </span><span class="n">Thu</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">12</span><span class="err">:</span><span class="mi">35</span><span class="w"> </span><span class="mi">2016</span><span class="w">          </span><span class="k">Last</span><span class="w"> </span><span class="nl">change</span><span class="p">:</span><span class="w"> </span><span class="n">Thu</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">16</span><span class="err">:</span><span class="mi">04</span><span class="err">:</span><span class="mi">47</span><span class="w"> </span><span class="mi">2016</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">cibadmin</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="nl">Stack</span><span class="p">:</span><span class="w"> </span><span class="n">corosync</span><span class="w"></span>
<span class="k">Current</span><span class="w"> </span><span class="nl">DC</span><span class="p">:</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="mf">1.1.13</span><span class="o">-</span><span class="mf">10.</span><span class="n">el7_2</span><span class="mf">.4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">partition</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">quorum</span><span class="w"></span>
<span class="mi">2</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="n">configured</span><span class="w"></span>

<span class="nl">Online</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n"> pcmk-1 pcmk-2 </span><span class="o">]</span><span class="w"></span>

<span class="k">Full</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nl">resources</span><span class="p">:</span><span class="w"></span>

<span class="w"> </span><span class="n">ClusterIP</span><span class="w">      </span><span class="p">(</span><span class="nl">ocf</span><span class="p">:</span><span class="err">:</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">)</span><span class="err">:</span><span class="w">       </span><span class="n">Started</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="w"></span>

<span class="n">PCSD</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">Online</span><span class="w"></span>
<span class="w">  </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="n">Online</span><span class="w"></span>

<span class="n">Daemon</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nl">corosync</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">disabled</span><span class="w"></span>
<span class="w">  </span><span class="nl">pacemaker</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">disabled</span><span class="w"></span>
<span class="w">  </span><span class="nl">pcsd</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">enabled</span><span class="w"></span>
</pre></div>


<p>以下のコマンドを実行して、仮想IPを <code>pcmk-1</code> のほうに移動します。</p>
<div class="highlight"><pre><span></span><span class="n">pcs</span> <span class="k">cluster</span> <span class="n">stop</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">pcs</span> <span class="k">cluster</span> <span class="k">start</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>
</pre></div>


<h2>ApacheのActive/Passiveクラスタを作って仮想IPと連動させる</h2>
<h3>リソースのスティッキネスのデフォルト値を設定</h3>
<p><a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html/Clusters_from_Scratch/_prevent_resources_from_moving_after_recovery.html">5.4. Prevent Resources from Moving after Recovery</a> を見て設定します。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="n">defaults</span><span class="w"> </span><span class="n">resource</span><span class="o">-</span><span class="n">stickiness</span><span class="o">=</span><span class="mi">100</span><span class="w"></span>
<span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="n">defaults</span><span class="w"> </span>
<span class="n">resource</span><span class="o">-</span><span class="nl">stickiness</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>
</pre></div>


<h3>Apache のインストールと設定</h3>
<p><code>pcmk-1</code> と <code>pcmk-2</code> で以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span># yum -y install httpd wget
# mkdir -p /var/www/html /var/log/httpd
# cat &gt; /var/www/html/index.html <span class="err">&lt;</span><span class="nt">&lt;EOF</span>
<span class="err">&lt;html</span><span class="nt">&gt;</span>
<span class="nt">&lt;body&gt;</span>My Test Site - $(hostname)<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
EOF
# cat &gt; /etc/httpd/conf.d/status.conf <span class="err">&lt;&lt;</span>&#39;EOF&#39;
<span class="nt">&lt;Location</span> <span class="err">/server-status</span><span class="nt">&gt;</span>
  SetHandler server-status
  Require ip 127.0.0.1
<span class="nt">&lt;/Location&gt;</span>
EOF
</pre></div>


<h3>Apache の Active/Passive クラスタ作成</h3>
<p><code>pcmk-1</code> か <code>pcmk-2</code> のどちらか一方で以下のコマンドを実行します。
公式のドキュメントでは、 <code>pcmk-2</code> で開始した後、制約を追加しただけでは <code>pcmk-1</code> に移動しないというデモをしていますが、ここでは <code>--disabled</code> つきでリソースを作成後、制約を追加してから有効化することで最初から <code>pcmk-1</code> で開始させています。</p>
<p>また、制約を追加するごとに <code>crm_simulate -sL</code> を実行してリソースをどのノードに割り当てるかのスコアを確認しています。</p>
<p>まず WebSite という名前のリソースを <code>disabled</code> 状態で作成します。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="n">resource</span> <span class="k">create</span> <span class="n">WebSite</span> <span class="n">ocf</span><span class="p">:</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span> <span class="err">\</span>
    <span class="n">configfile</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">httpd</span><span class="p">.</span><span class="n">conf</span> <span class="err">\</span>
    <span class="n">statusurl</span><span class="o">=</span><span class="ss">&quot;http://localhost/server-status&quot;</span> <span class="err">\</span>
    <span class="n">op</span> <span class="n">monitor</span> <span class="nb">interval</span><span class="o">=</span><span class="mi">3</span><span class="n">s</span> <span class="k">on</span><span class="o">-</span><span class="n">fail</span><span class="o">=</span><span class="k">restart</span> <span class="err">\</span>
    <span class="c1">--disabled</span>
</pre></div>


<p>WebSite リソースは ClusterIP リソースと同じノードで動かすという制約を追加します。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="k">constraint</span> <span class="n">colocation</span> <span class="k">add</span> <span class="n">WebSite</span> <span class="k">with</span> <span class="n">ClusterIP</span> <span class="n">INFINITY</span>
<span class="o">#</span> <span class="n">crm_simulate</span> <span class="o">-</span><span class="n">sL</span>

<span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="k">role</span><span class="p">:</span><span class="n">Stopped</span><span class="p">)</span> <span class="n">Stopped</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">100</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
</pre></div>


<p>リソースの開始順序を ClusterIP、 WebSite にする制約を追加します。</p>
<div class="highlight"><pre><span></span># <span class="nv">pcs</span> <span class="nv">constraint</span> <span class="nv">order</span> <span class="nv">ClusterIP</span> <span class="k">then</span> <span class="nv">WebSite</span>
</pre></div>


<p>WebSite のリソースをなるべく <code>pcmk-1</code> 側で動かすようにする制約を追加します。 <code>250</code> という値はこの後の操作を一度試行錯誤してみて適当に選びましたが、希望通りの動作が実現できさえすれば違う値でも構いません。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="k">constraint</span> <span class="k">location</span> <span class="n">WebSite</span> <span class="n">prefers</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="o">=</span><span class="mi">250</span>
<span class="o">#</span> <span class="n">crm_simulate</span> <span class="o">-</span><span class="n">sL</span>

<span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="k">role</span><span class="p">:</span><span class="n">Stopped</span><span class="p">)</span> <span class="n">Stopped</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">350</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
</pre></div>


<p>希望する制約を一通り追加したので、 WebSite リソースを稼働開始します。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">pcs</span> <span class="n">resource</span> <span class="n">enable</span> <span class="n">WebSite</span>
<span class="o">#</span> <span class="n">crm_simulate</span> <span class="o">-</span><span class="n">sL</span>

<span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">450</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">350</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
</pre></div>


<p><code>pcmk-1</code> と <code>pcmk-2</code> で <code>ps auxww | grep httpd</code> すると <code>pcmk-1</code> 側で Apache が稼働して <code>pcmk-2</code> 側では稼働していないことを確認できます。</p>
<h3>手動で制約を調整して仮想IPとApacheを <code>pcmk-2</code> に移動する</h3>
<p>以下のコマンドで制約を調整し、移動が完了するまでのスコアの変遷を確認します。 <code>500</code> という値は前項の最後の <code>pcmk-1</code> の ClusterIP のスコアを上回る値として選びました。</p>
<div class="highlight"><pre><span></span># <span class="nv">pcs</span> <span class="nv">constraint</span> <span class="nv">location</span> <span class="nv">WebSite</span> <span class="nv">prefers</span> <span class="nv">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="o">=</span><span class="mi">500</span> \
  <span class="o">&amp;&amp;</span> <span class="k">for</span> <span class="nv">i</span> <span class="nv">in</span> `<span class="nv">seq</span> <span class="mi">1</span> <span class="mi">20</span>`<span class="c1">; do crm_simulate -sL; sleep 0.1; done</span>
</pre></div>


<p>出力結果のうち変化があったものだけを抜粋します。
まず開始直後の状態。</p>
<div class="highlight"><pre><span></span><span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">450</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">500</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">500</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
 <span class="o">*</span> <span class="k">Move</span>    <span class="n">ClusterIP</span>    <span class="p">(</span><span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
 <span class="o">*</span> <span class="k">Move</span>    <span class="n">WebSite</span>      <span class="p">(</span><span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>


<p>WebSiteが停止した状態。</p>
<div class="highlight"><pre><span></span><span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="n">Stopped</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">350</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">500</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">500</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
 <span class="o">*</span> <span class="k">Move</span>    <span class="n">ClusterIP</span>    <span class="p">(</span><span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
 <span class="o">*</span> <span class="k">Start</span>   <span class="n">WebSite</span>      <span class="p">(</span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>


<p>ClusterIPがpcmk-2に移った状態。</p>
<div class="highlight"><pre><span></span><span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="n">Stopped</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">250</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">600</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">500</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
 <span class="o">*</span> <span class="k">Start</span>   <span class="n">WebSite</span>      <span class="p">(</span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
</pre></div>


<p>WebSiteが <code>pcmk-2</code> で稼働開始した状態。</p>
<div class="highlight"><pre><span></span><span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">250</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">700</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">600</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
</pre></div>


<h3>手動で制約を調整して仮想IPとApacheを <code>pcmk-1</code> に戻す</h3>
<p>次に <code>pcmk-2</code> から <code>pcmk-1</code> に戻してみます。
以下のコマンドで制約のIDを確認します。</p>
<div class="highlight"><pre><span></span>[<span class="nv">root</span>@<span class="nv">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="o">~</span>]# <span class="nv">pcs</span> <span class="nv">constraint</span> <span class="o">--</span><span class="nv">full</span>
<span class="nv">Location</span> <span class="nv">Constraints</span>:
  <span class="nv">Resource</span>: <span class="nv">WebSite</span>
    <span class="nv">Enabled</span> <span class="nv">on</span>: <span class="nv">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="ss">(</span><span class="nv">score</span>:<span class="mi">250</span><span class="ss">)</span> <span class="ss">(</span><span class="nv">id</span>:<span class="nv">location</span><span class="o">-</span><span class="nv">WebSite</span><span class="o">-</span><span class="nv">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="mi">250</span><span class="ss">)</span>
    <span class="nv">Enabled</span> <span class="nv">on</span>: <span class="nv">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="ss">(</span><span class="nv">score</span>:<span class="mi">500</span><span class="ss">)</span> <span class="ss">(</span><span class="nv">id</span>:<span class="nv">location</span><span class="o">-</span><span class="nv">WebSite</span><span class="o">-</span><span class="nv">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">500</span><span class="ss">)</span>
<span class="nv">Ordering</span> <span class="nv">Constraints</span>:
  <span class="nv">start</span> <span class="nv">ClusterIP</span> <span class="k">then</span> <span class="nv">start</span> <span class="nv">WebSite</span> <span class="ss">(</span><span class="nv">kind</span>:<span class="nv">Mandatory</span><span class="ss">)</span> <span class="ss">(</span><span class="nv">id</span>:<span class="nv">order</span><span class="o">-</span><span class="nv">ClusterIP</span><span class="o">-</span><span class="nv">WebSite</span><span class="o">-</span><span class="nv">mandatory</span><span class="ss">)</span>
<span class="nv">Colocation</span> <span class="nv">Constraints</span>:
  <span class="nv">WebSite</span> <span class="nv">with</span> <span class="nv">ClusterIP</span> <span class="ss">(</span><span class="nv">score</span>:<span class="nv">INFINITY</span><span class="ss">)</span> <span class="ss">(</span><span class="nv">id</span>:<span class="nv">colocation</span><span class="o">-</span><span class="nv">WebSite</span><span class="o">-</span><span class="nv">ClusterIP</span><span class="o">-</span><span class="nv">INFINITY</span><span class="ss">)</span>
</pre></div>


<p>以下のコマンドで <code>pcmk-2</code> 側の制約を削除し、 <code>pcmk-1</code> 側に戻るまでのスコアの動きを確認します。</p>
<div class="highlight"><pre><span></span># <span class="nv">pcs</span> <span class="nv">constraint</span> <span class="nv">remove</span> <span class="nv">location</span><span class="o">-</span><span class="nv">WebSite</span><span class="o">-</span><span class="nv">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="mi">500</span> \
  <span class="o">&amp;&amp;</span> <span class="k">for</span> <span class="nv">i</span> <span class="nv">in</span> `<span class="nv">seq</span> <span class="mi">1</span> <span class="mi">20</span>`<span class="c1">; do crm_simulate -sL; sleep 0.1; done</span>
</pre></div>


<p>開始直後の状態。</p>
<div class="highlight"><pre><span></span><span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">250</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">200</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">250</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
 <span class="o">*</span> <span class="k">Move</span>    <span class="n">ClusterIP</span>    <span class="p">(</span><span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="o">-&gt;</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
 <span class="o">*</span> <span class="k">Move</span>    <span class="n">WebSite</span>      <span class="p">(</span><span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="o">-&gt;</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>WebSiteが停止した状態。</p>
<div class="highlight"><pre><span></span><span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="n">Stopped</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">250</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">100</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">250</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
 <span class="o">*</span> <span class="k">Move</span>    <span class="n">ClusterIP</span>    <span class="p">(</span><span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="o">-&gt;</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
 <span class="o">*</span> <span class="k">Start</span>   <span class="n">WebSite</span>      <span class="p">(</span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>ClusterIPが <code>pcmk-1</code> に移動した状態。</p>
<div class="highlight"><pre><span></span><span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="n">Stopped</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">350</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">250</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
 <span class="o">*</span> <span class="k">Start</span>   <span class="n">WebSite</span>      <span class="p">(</span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>


<p>WebSiteが <code>pcmk-1</code> で稼働開始した状態。</p>
<div class="highlight"><pre><span></span><span class="k">Current</span> <span class="k">cluster</span> <span class="n">status</span><span class="p">:</span>
<span class="n">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span> <span class="p">]</span>

 <span class="n">ClusterIP</span>      <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">):</span>       <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>
 <span class="n">WebSite</span>        <span class="p">(</span><span class="n">ocf</span><span class="p">::</span><span class="n">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">):</span>        <span class="n">Started</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span>

<span class="n">Allocation</span> <span class="n">scores</span><span class="p">:</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">450</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">ClusterIP</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="mi">350</span>
<span class="n">native_color</span><span class="p">:</span> <span class="n">WebSite</span> <span class="n">allocation</span> <span class="n">score</span> <span class="k">on</span> <span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>

<span class="n">Transition</span> <span class="n">Summary</span><span class="p">:</span>
</pre></div>


<h2>Active側のコンテナに障害が発生してコンテナごと落ちるケースの模擬実験</h2>
<h3>Active側 <code>pcmk-1</code> のコンテナを停止させたときの挙動を確認</h3>
<p>LXDホストで以下のコマンドを実行して <code>pcmk-1</code> を停止させます。</p>
<div class="highlight"><pre><span></span>$ lxc stop -f pcmk-1
</pre></div>


<p><code>pcmk-2</code> で <code>pcs status</code> を実行すると <code>pcmk-1</code> が OFFLINE になったことがわかりますが、 <code>PCSD Status:</code> の後を表示するところでブロックしたので Ctrl-C で止めました。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">status</span><span class="w"></span>
<span class="n">Cluster</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">mycluster</span><span class="w"></span>
<span class="k">Last</span><span class="w"> </span><span class="nl">updated</span><span class="p">:</span><span class="w"> </span><span class="n">Fri</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">13</span><span class="err">:</span><span class="mi">37</span><span class="w"> </span><span class="mi">2016</span><span class="w">          </span><span class="k">Last</span><span class="w"> </span><span class="nl">change</span><span class="p">:</span><span class="w"> </span><span class="n">Fri</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">09</span><span class="err">:</span><span class="mi">34</span><span class="err">:</span><span class="mi">39</span><span class="w"> </span><span class="mi">2016</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">cibadmin</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="nl">Stack</span><span class="p">:</span><span class="w"> </span><span class="n">corosync</span><span class="w"></span>
<span class="k">Current</span><span class="w"> </span><span class="nl">DC</span><span class="p">:</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="mf">1.1.13</span><span class="o">-</span><span class="mf">10.</span><span class="n">el7_2</span><span class="mf">.4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">partition</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">quorum</span><span class="w"></span>
<span class="mi">2</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">resources</span><span class="w"> </span><span class="n">configured</span><span class="w"></span>

<span class="nl">Online</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n"> pcmk-2 </span><span class="o">]</span><span class="w"></span>
<span class="nl">OFFLINE</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n"> pcmk-1 </span><span class="o">]</span><span class="w"></span>

<span class="k">Full</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nl">resources</span><span class="p">:</span><span class="w"></span>

<span class="w"> </span><span class="n">ClusterIP</span><span class="w">      </span><span class="p">(</span><span class="nl">ocf</span><span class="p">:</span><span class="err">:</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">)</span><span class="err">:</span><span class="w">       </span><span class="n">Started</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="w"></span>
<span class="w"> </span><span class="n">WebSite</span><span class="w">        </span><span class="p">(</span><span class="nl">ocf</span><span class="p">:</span><span class="err">:</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">)</span><span class="err">:</span><span class="w">        </span><span class="n">Started</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="w"></span>

<span class="n">PCSD</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"></span>
<span class="o">^</span><span class="n">C</span><span class="w"></span>
</pre></div>


<p><code>ip a s eth0</code> と <code>ps auxww | grep httpd</code> で仮想IPとApacheが <code>pcmk-2</code> で動いていることが確認できました。</p>
<h3><code>pcmk-1</code> のコンテナを起動させた時の挙動を確認</h3>
<p>LXDホストで以下のコマンドを実行して <code>pcmk-1</code> を起動し、コンテナ内に入ります。</p>
<div class="highlight"><pre><span></span>$ <span class="nv">lxc</span> <span class="nv">satrt</span> <span class="nv">pcmk</span><span class="o">-</span><span class="mi">1</span>
$ <span class="nv">lxc</span> <span class="k">exec</span> <span class="nv">pcmk</span><span class="o">-</span><span class="mi">1</span> <span class="nv">bash</span>
</pre></div>


<p><code>pcmk-1</code> 側は <code>pcsd</code> は起動していますが、クラスタには所属していない状態です。</p>
<p>理由は <a href="http://clusterlabs.org/doc/en-US/Pacemaker/1.1-pcs/html/Clusters_from_Scratch/ch04.html#_start_the_cluster">Chapter 4. Start and Verify Cluster</a> に説明があります。 <code>pcsd</code> は <code>systemctl enable</code> でOS起動時の自動起動を有効にしていますが <code>corosync</code> と <code>pacemaker</code> はしていないからです。</p>
<p>実運用時に物理的な障害などで <code>pcmk-1</code> がクラスタから外れた場合、その後電源をいれて起動できたとしても、障害の原因を調査して、正常にサービスを稼働できるかを確認してからクラスタに復帰させたいので、この設定で良いと思います。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">status</span><span class="w"></span>
<span class="nl">Error</span><span class="p">:</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">currently</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">node</span><span class="w"></span>
</pre></div>


<p><code>pcmk-2</code> で <code>pcs status</code> は今度はブロックせずに完了します。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">status</span><span class="w"></span>
<span class="n">Cluster</span><span class="w"> </span><span class="nl">name</span><span class="p">:</span><span class="w"> </span><span class="n">mycluster</span><span class="w"></span>
<span class="k">Last</span><span class="w"> </span><span class="nl">updated</span><span class="p">:</span><span class="w"> </span><span class="n">Fri</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">13</span><span class="err">:</span><span class="mi">18</span><span class="err">:</span><span class="mi">22</span><span class="w"> </span><span class="mi">2016</span><span class="w">          </span><span class="k">Last</span><span class="w"> </span><span class="nl">change</span><span class="p">:</span><span class="w"> </span><span class="n">Fri</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">09</span><span class="err">:</span><span class="mi">34</span><span class="err">:</span><span class="mi">39</span><span class="w"> </span><span class="mi">2016</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">cibadmin</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="nl">Stack</span><span class="p">:</span><span class="w"> </span><span class="n">corosync</span><span class="w"></span>
<span class="k">Current</span><span class="w"> </span><span class="nl">DC</span><span class="p">:</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">version</span><span class="w"> </span><span class="mf">1.1.13</span><span class="o">-</span><span class="mf">10.</span><span class="n">el7_2</span><span class="mf">.4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">partition</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">quorum</span><span class="w"></span>
<span class="mi">2</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">resources</span><span class="w"> </span><span class="n">configured</span><span class="w"></span>

<span class="nl">Online</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n"> pcmk-2 </span><span class="o">]</span><span class="w"></span>
<span class="nl">OFFLINE</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="n"> pcmk-1 </span><span class="o">]</span><span class="w"></span>

<span class="k">Full</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nl">resources</span><span class="p">:</span><span class="w"></span>

<span class="w"> </span><span class="n">ClusterIP</span><span class="w">      </span><span class="p">(</span><span class="nl">ocf</span><span class="p">:</span><span class="err">:</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">)</span><span class="err">:</span><span class="w">       </span><span class="n">Started</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="w"></span>
<span class="w"> </span><span class="n">WebSite</span><span class="w">        </span><span class="p">(</span><span class="nl">ocf</span><span class="p">:</span><span class="err">:</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">apache</span><span class="p">)</span><span class="err">:</span><span class="w">        </span><span class="n">Started</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="w"></span>

<span class="n">PCSD</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">Online</span><span class="w"></span>
<span class="w">  </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">2</span><span class="err">:</span><span class="w"> </span><span class="n">Online</span><span class="w"></span>

<span class="n">Daemon</span><span class="w"> </span><span class="nl">Status</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nl">corosync</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">disabled</span><span class="w"></span>
<span class="w">  </span><span class="nl">pacemaker</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">disabled</span><span class="w"></span>
<span class="w">  </span><span class="nl">pcsd</span><span class="p">:</span><span class="w"> </span><span class="n">active</span><span class="o">/</span><span class="n">enabled</span><span class="w"></span>
</pre></div>


<p>以下のコマンドを実行して <code>pcmk-1</code> をクラスタに復帰させます。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pcmk-1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">pcs</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="w"></span>
<span class="n">pcmk</span><span class="o">-</span><span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="n">Starting</span><span class="w"> </span><span class="n">Cluster</span><span class="p">...</span><span class="w"></span>
</pre></div>


<p>しばらくして <code>pcs status</code> を確認すると <code>pcmk-1</code> がオンラインになり、 ClusterIP と WebSite リソースが <code>pcmk-1</code> に移動することが確認できました。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>