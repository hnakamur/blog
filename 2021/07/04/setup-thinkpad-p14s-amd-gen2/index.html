<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.122.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>ThinkPad P14s AMD Gen 2 のセットアップ &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2024. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>ThinkPad P14s AMD Gen 2 のセットアップ</h1>
  <time datetime=2021-07-04T13:30:00&#43;0900 class="post-date">2021-07-04</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#構成">構成</a>
      <ul>
        <li><a href="#ramとssdは別途ヨドバシドットコムで購入">RAMとSSDは別途ヨドバシ・ドット・コムで購入</a></li>
      </ul>
    </li>
    <li><a href="#注文と発送">注文と発送</a></li>
    <li><a href="#windows-10-のプロダクトキー確認">Windows 10 のプロダクトキー確認</a></li>
    <li><a href="#ハードウェアキーボードレイアウトを英語に変更">ハードウェアキーボードレイアウトを英語に変更</a></li>
    <li><a href="#windows-10-クリーンインストール">Windows 10 クリーン・インストール</a>
      <ul>
        <li><a href="#リカバリーメディアをダウンロードしてusbメモリに書き込み">リカバリーメディアをダウンロードしてUSBメモリに書き込み</a></li>
        <li><a href="#メモリ増設とssd換装">メモリ増設とSSD換装</a></li>
        <li><a href="#リカバリーの実行">リカバリーの実行</a></li>
      </ul>
    </li>
    <li><a href="#windows-の初期セットアップ">Windows の初期セットアップ</a></li>
    <li><a href="#windows-の各種設定">Windows の各種設定</a>
      <ul>
        <li><a href="#キーボードを英語配列に変更">キーボードを英語配列に変更</a></li>
        <li><a href="#ctrl--space-で-ime-オンオフ-の設定">Ctrl + Space で IME オン/オフ の設定</a></li>
        <li><a href="#タッチパッドの設定">タッチパッドの設定</a></li>
        <li><a href="#ディスプレイの設定">ディスプレイの設定</a></li>
        <li><a href="#電源とスリープ">電源とスリープ</a></li>
        <li><a href="#キーボードの-ctrl-と-capslock-入れ替え">キーボードの Ctrl と CapsLock 入れ替え</a></li>
        <li><a href="#マルチタスク設定">マルチタスク設定</a></li>
        <li><a href="#ホスト名設定">ホスト名設定</a></li>
        <li><a href="#エクスプローラの表示設定">エクスプローラの表示設定</a></li>
        <li><a href="#bluetooth-をオフ">Bluetooth をオフ</a></li>
      </ul>
    </li>
    <li><a href="#パスワードマネージャー-keepassxc-インストール">パスワードマネージャー KeePassXC インストール</a></li>
    <li><a href="#firefox-と-chrome-のセットアップ">Firefox と Chrome のセットアップ</a>
      <ul>
        <li><a href="#firefox">Firefox</a></li>
        <li><a href="#chrome">Chrome</a></li>
      </ul>
    </li>
    <li><a href="#wsl2-セットアップ">WSL2 セットアップ</a>
      <ul>
        <li><a href="#wsl2-の-linux-カーネルの更新を-windows-update-で受け取る設定-2021-07-23追記">WSL2 の Linux カーネルの更新を Windows Update で受け取る設定 (2021-07-23追記)</a></li>
      </ul>
    </li>
    <li><a href="#visual-studio-code-インストール">Visual Studio Code インストール</a></li>
    <li><a href="#cica-フォントインストール">Cica フォントインストール</a></li>
    <li><a href="#windows-terminal-インストールと設定">Windows Terminal インストールと設定</a></li>
    <li><a href="#windows-terminal-のインストール">Windows Terminal のインストール</a>
      <ul>
        <li><a href="#windows-terminal-の設定">Windows Terminal の設定</a></li>
      </ul>
    </li>
    <li><a href="#7-zip-をインストール">7-Zip をインストール</a></li>
    <li><a href="#wsl2-と-keepassxc-で-ssh-agent-を使う設定">WSL2 と KeePassXC で ssh-agent を使う設定</a>
      <ul>
        <li><a href="#ssh-agent-のサービス自動起動設定">ssh-agent のサービス自動起動設定</a></li>
        <li><a href="#wsl2-で-wsl-ssh-agent-のセットアップ">WSL2 で wsl-ssh-agent のセットアップ</a></li>
        <li><a href="#keepassxc-から-ssh-agent-への接続設定">KeePassXC から ssh-agent への接続設定</a></li>
      </ul>
    </li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p>購入した ThinkPad P14s AMD Gen 2 が届いたのでセットアップのメモです。</p>
<h2 id="構成">構成</h2>
<p><a href="https://www.lenovo.com/jp/ja/notebooks/thinkpad/p-series/P14s-AMD-G2/p/22WSP144SA2">ThinkPad P14s AMD Gen 2 | レノボジャパン</a></p>
<ul>
<li>構成内容: ThinkPad P14s Gen 2 AMD</li>
<li>製品番号: 21A0CTO1WWJAJP3</li>
<li>単価(税込): 134,618 円</li>
<li>Configuration Details
<ul>
<li>AMD Ryzen 7 PRO 5850U (1.90GHz, 12MB)</li>
<li>Windows 10 Pro 64bit - 日本語版</li>
<li>16GB DDR4 3200MHz (オンボード)</li>
<li>128GB ソリッドステートドライブ (M.2 2242, PCIe-NVMe)</li>
<li>14.0型FHD液晶(1920x1080) IPS、400nit、72%NTSC、マルチタッチ非対応</li>
<li>ブラック</li>
<li>なし</li>
<li>内蔵グラフィックス</li>
<li>IR &amp; 720p HDカメラ(マイクロホン付)</li>
<li>指紋センサーあり (ブラック)</li>
<li>英語キーボード</li>
<li>Wi-Fi 6対応 (IEEE802.11ax/ac/a/b/g/n準拠) (2x2) +Bluetooth</li>
<li>TPMあり(TCG V2.0準拠，ハードウェアチップ搭載)</li>
<li>BIOS Absolute有効</li>
<li>3セル リチウムイオンバッテリー (50Wh)</li>
<li>65W ACアダプター (2ピン)(USB Type-C)</li>
<li>14.0型FHD液晶(1920x1080)IPS、400nit、72%NTSC、マルチタッチ非対応、IR&amp;720p HDカメラ、マイク、WLAN、WWAN非対応、FreeSync</li>
<li>日本語</li>
<li>なし</li>
<li>1年間 引き取り修理</li>
</ul>
</li>
</ul>
<h3 id="ramとssdは別途ヨドバシドットコムで購入">RAMとSSDは別途ヨドバシ・ドット・コムで購入</h3>
<ul>
<li>RAM CT32G4SFD832A [32GB DDR4 3200 MT/s PC4-25600 CL22 DR x8 Unbuffered SODIMM 260pin]
<ul>
<li>単価(税込): 21,180 円</li>
</ul>
</li>
<li>SSD WDS100T2B0C [バルクSSD WD SN550シリーズ 1TB]
<ul>
<li>単価(税込): 14,920 円</li>
</ul>
</li>
</ul>
<h2 id="注文と発送">注文と発送</h2>
<ul>
<li>2021-06-19 注文</li>
<li>2021-06-28 発送</li>
<li>2021-07-03 到着</li>
</ul>
<h2 id="windows-10-のプロダクトキー確認">Windows 10 のプロダクトキー確認</h2>
<p><a href="https://www.quora.com/How-can-I-retrieve-my-Windows-10-product-key-from-my-Lenovos-and-HPs-laptop">(1) How can I retrieve my Windows 10 product key from my Lenovo&rsquo;s and HP&rsquo;s laptop? - Quora</a></p>
<p>管理者権限でコマンドプロンプトまたはパワーシェルを開いて以下のコマンドを実行。</p>
<pre tabindex="0"><code>wmic path SoftwareLicensingService get OA3xOriginalProductKey
</code></pre><p>表示されたプロダクトキーはいつも使っているパスワードマネージャ KeePassXC に登録して管理。</p>
<h2 id="ハードウェアキーボードレイアウトを英語に変更">ハードウェアキーボードレイアウトを英語に変更</h2>
<p>初期セットアップのときに設定を間違えたのか、キーボードレイアウトが「日本語キーボード(106/109キー)」になってしまっていました。</p>
<p><a href="https://hamachan.info/win10-win-ekeybord/">英語キーボードと日本語キーボードの切り替え | Windows 10 | 初心者のためのOffice講座</a> を参考に英語に切り替え。Windowsの再起動が必要です。</p>
<ol>
<li>Windows キー + i を押して設定画面を表示</li>
<li>「時刻と言語」を選択</li>
<li>左のメニューの「言語」を選択</li>
<li>「優先する言語」の一覧の「日本語」を選択し「オプション」ボタンを押す</li>
<li>ハーソウェアキーボードレイアウトの「レイアウトを変更する」ボタンを押す</li>
<li>「英語キーボード(101/102キー)」を選択して「今すぐ再起動する」ボタンを押す　</li>
</ol>
<h2 id="windows-10-クリーンインストール">Windows 10 クリーン・インストール</h2>
<p><a href="https://support.lenovo.com/jp/ja/solutions/ht103617-clean-install-of-windows-10-on-thinkpad-and-lenovo-lavie-computers">ThinkPad および Lenovo LaVie コンピューター上での Windows 10 のクリーン・インストール - Lenovo Support JP</a> に BIOS を最新にするよう書かれていました。</p>
<p><a href="http://www.lenovo.com/support">Lenovo サポート Web サイト</a> から該当の機種の最新の BIOS をダウンロードしてインストールすれば良いとのことです。</p>
<p>サポート Web サイトにアクセスして、「製品グループを選択する」のページの「PC」の「製品を検出する」を押してみると <a href="https://support.lenovo.com/ro/ja/solutions/ht104055">Lenovo Service Bridge: 自動的にシステムタイプとシリアル番号を検出 - Lenovo Support RO</a> のインストールのダイアログがブラウザ内に表示されました。</p>
<p>一方 Windows のスタートメニューを見てみると <a href="https://support.lenovo.com/jp/ja/solutions/hf003321-lenovo-vantage-for-enterprise">Commercial Vantage（企業向け） - Lenovo Support JP</a>  というアプリケーションがインストール済みになっていました。</p>
<p>そこで Lenovo Service Bridge は使わずに Commercial Vantage (以下 Vantage と略します)のほうを使うことにして、そちらでシステムの更新を行いました。</p>
<p>ちなみに Vantage では機種名は ThinkPad P14s Gen 2a という表示になっていました。</p>
<p>Vantage で表示される BIOS バージョンは R1MET35W 1.05 でした。</p>
<p><a href="http://www.lenovo.com/support">Lenovo サポート Web サイト</a> で「製品グループを選択する」のページの「PC」の「PC製品サポートへ」を押し、検索欄に「ThinkPad P14s」と入力し「ThinkPad P14s Gen 2 (マシンタイプ 21A0,21A1) ノートブック」を選択すると <a href="https://pcsupport.lenovo.com/jp/ja/products/laptops-and-netbooks/thinkpad-p-series-laptops/thinkpad-p14s-gen-2-type-21a0-21a1/?linkTrack=Homepage%3ABody_Search%20Products&amp;searchType=3&amp;keyWordSearch=ThinkPad%20P14s%20Gen%202%20%28%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%97%2021A0,%2021A1%29%20%E3%83%8E%E3%83%BC%E3%83%88%E3%83%96%E3%83%83%E3%82%AF">laptops and netbooks :: thinkpad p series laptops :: thinkpad p14s gen 2 type 21a0 21a1 - Lenovo Support JP</a> が表示されました。</p>
<p>左の「ドライバーとソフトウェア」を選んで右で「BIOS」を選んでバージョンを確認すると 1.05 だったので最新になっていることが確認できました。</p>
<h3 id="リカバリーメディアをダウンロードしてusbメモリに書き込み">リカバリーメディアをダウンロードしてUSBメモリに書き込み</h3>
<ol>
<li><a href="https://pcsupport.lenovo.com/jp/ja/products/laptops-and-netbooks/thinkpad-p-series-laptops/thinkpad-p14s-gen-2-type-21a0-21a1/?linkTrack=Homepage%3ABody_Search%20Products&amp;searchType=3&amp;keyWordSearch=ThinkPad%20P14s%20Gen%202%20%28%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%97%2021A0,%2021A1%29%20%E3%83%8E%E3%83%BC%E3%83%88%E3%83%96%E3%83%83%E3%82%AF">laptops and netbooks :: thinkpad p series laptops :: thinkpad p14s gen 2 type 21a0 21a1 - Lenovo Support JP</a> で 左の「ドライバーとソフトウェア」を選んで右で「リカバリーメディアを注文する」タブを選択し、「クリックして続ける」ボタンを押します。</li>
<li>「資格を確認する」のステップで「シリアル番号を入力」の下の入力欄に Vantage で表示されているシリアル番号を入力します。</li>
<li>「注文する」のステップで「マシンタイプ」が「21A0」、「オペレーティングシステム」が「Win10PROx64」と正しく表示されたことを確認した上で、「国/地域」は「日本」、「OSの言語を選ぶ」は「Japanese」を選択し、保証ポリシーの左の「同意します」チェックボックスをオンにして「次へ」ボタンを押します。</li>
<li>「顧客情報を入力」のステップでは、名、性、メールアドレスを入力して「送信」ボタンを押します。</li>
</ol>
<p><a href="https://support.lenovo.com/documents/ht103653">https://support.lenovo.com/documents/ht103653</a> を開いて<a href="https://s3-us-west-2.amazonaws.com/ddstools.gdi.lenovo/win8/USBRecoveryCreator.exe">Lenovo USB Recovery Creator tool for Windows® 8 または以降 (例： Windows® 10)</a> (USBRecoveryCreator.exe という Windows の実行ファイル)をダウンロード、実行します。</p>
<p>実行すると Lenovo ID とパスワードを聞かれるので入力し、先程の注文を選択して、リカバリーメディアをダウンロードします。</p>
<p>ダウンロードが終わった時点で一旦終了して、ダウンロードしたディレクトリを <a href="https://sevenzip.osdn.jp/">圧縮・解凍ソフト 7-Zip</a> で無圧縮の zip 形式で固めて USBRecoveryCreator.exe とともにバックアップしました。</p>
<p>その後 16GBのUSBメモリを刺して再度 USBRecoveryCreator.exe を実行し、ダウンロードディクトリ内の <code>*.REM</code> ファイルを選択してUSBメモリにリカバリーディスクの内容を書き込みます。書き込んだ後の検証が結構時間がかかりますが、書き込みエラーがあるとまずいので終わるまでおとなしく待ちます。</p>
<h4 id="参考-usb-メモリにパーティションがあった場合に消す手順">参考: USB メモリにパーティションがあった場合に消す手順</h4>
<p>USBRecoveryCreator.exe でUSBメモリに書き込む前の話ですが、私が使おうとしていたUSBメモリはパーティションが複数作られていたので <a href="https://qiita.com/ktyubeshi/items/e71dd89722db85081284">USBメモリに出来た複数のパーティーションをWindowsの標準機能だけで削除する - Qiita</a> を参考に消しました。</p>
<ol>
<li>Windows キー + R を押して diskpart と入力して起動。</li>
<li><code>list disk</code> でディスク一覧を表示し USB メモリのディスク番号を確認。　</li>
<li><code>select disk ディスク番号</code> で対象のUSBメモリに切り替え。</li>
<li><code>detail disk</code> で選択に間違いがないことを確認。</li>
<li><code>clean</code> でパーティションを全て削除。</li>
<li><code>create parition primary</code> でプライマリパーティションを作成。</li>
<li><code>exit</code> で diskpart を終了。</li>
</ol>
<p>Windows キーを押して <code>disk manager</code> と入力して絞り込み「ハードディスク パーティションの作成とフォーマット」を選択して「ディスクの管理」を起動します。</p>
<p>USBメモリのパーティションをFAT32でフォーマットします。</p>
<h3 id="メモリ増設とssd換装">メモリ増設とSSD換装</h3>
<p><a href="https://www.youtube.com/watch?v=swlpvRz5w3g">Lenovo Thinkpad P14s (and T14, T15, P15s) Overview and Upgrade options - YouTube</a> と <a href="https://27kamimen.com/bunkai/">ThinkPadの分解はコツがあった！コツを知れば自分でメモリは簡単に交換できる</a> を参考に背面カバーを外します。</p>
<p>メモリはオンボードで16GBで増設スロット1つに32GBを追加します。</p>
<p>SSD は128GB のを 1TB に換装します。
SSD を止めているネジと金具を外した後 128GB のSSDを外し、1TBのSSDをつけてネジ止めします。元のSSDと金具は保管しておきます。</p>
<h3 id="リカバリーの実行">リカバリーの実行</h3>
<p>リカバリー用のUSBメモリを刺して電源を入れ、指示に従ってリカバリーを実行します。
終わるとUSBメモリを抜いて再起動するように言われるのでそうします。</p>
<p>ここから結構時間かかりました。</p>
<p>再起動後コマンドプロンプトがポコポコ開いて自動でコマンドが実行されるので終わるまで待ちます。待っていると再起動して Lenovo のロゴが出ている画面でいろいろセットアップが進みまた再起動されます。</p>
<p>その後 Windows の画面で Administrator のユーザーが表示されたかと思ったら [Windows Setup] というダイアログが出てさらにセットアップが続きます。ダイアログには以下のようなメッセージが出ていました。</p>
<pre tabindex="0"><code>Windows is now setting up the following items:

AuditOne - DoWork
</code></pre><p>その後さらにセットアップと再起動が続いて、今度は Administrator で自動ログインしてセットアップが進み、さらに再起動がかかりました。</p>
<p>そしてまたコマンドプロンプトが開いてセットアップが続き、再起動がかかって続きが来ました (wpeinit の文字を見るのは2回めでループになってないかちょっと心配でしたが下記のダイアログで進んでいるとわかりました)。</p>
<p>今度は「Windows セットアップ」というダイアログで次のようなメッセージが出ました。</p>
<pre tabindex="0"><code>次の項目を設定します:

AuditTwo - DoWork
AuditTwo - Finish
</code></pre><p>最初は <code>AuditTwo - DoWork</code> が太字になっていました。セットアップと再起動が進むうちに <code>AuditTwo - DoWork</code> の左に緑のチェックマーク✅ (実際は前景色と背景色が逆)が付き <code>AuditTwo - Finish</code> のほうが太字になりました。</p>
<h2 id="windows-の初期セットアップ">Windows の初期セットアップ</h2>
<p>長いリカバリが終わってついに「お住いの地域はこちらでよろしいですか？」のダイアログが出ました。ここから初期セットアップです。</p>
<p>途中は省略して、「アカウントを追加しましょう」では左下の「オフラインアカウント」を選択し、その次は「制限付きエクスペリエンス」を選択しました。</p>
<p>「このPCを使うのはだれですか？」でローカルで作成するアカウント名を入力します。</p>
<p>3つのセキュリティの質問は省略不可なので、選んだ選択肢とパスワードマネージャで生成したランダムな文字列を入力し、パスワードマネージャーに登録しました。</p>
<p>Windows Helloでは「顔認識の使用」か「指紋認証の使用」が選べますが、初めて指紋センサーつきの ThinkPad を買ったので指紋認証を設定しました。</p>
<p>「PIN のセットアップ」では「英字と記号を含める」をチェックしてパスワードマネージャで生成したランダムな文字列を設定しました。</p>
<p>「デバイスのプライバシー設定の選択」は全て「いいえ」にしました。</p>
<p>デバイス登録でメールアドレスを入力する箇所ではやはり英語キーボードなのに日本語配列になっていました。アットマーク <code>@</code> は <code>P</code> の右の <code>[</code> で入力しました。</p>
<h2 id="windows-の各種設定">Windows の各種設定</h2>
<h3 id="キーボードを英語配列に変更">キーボードを英語配列に変更</h3>
<p>上記の手順で英語配列に変更しました。</p>
<h3 id="ctrl--space-で-ime-オンオフ-の設定">Ctrl + Space で IME オン/オフ の設定</h3>
<ol>
<li>Windows キー + i を押して設定画面を表示</li>
<li>「時刻と言語」を選択</li>
<li>左のメニューの「言語」を選択</li>
<li>「優先する言語」の一覧の「日本語」を選択し「オプション」ボタンを押す</li>
<li>「キーボード」の一覧の「Microsoft IME」を選んで「オプション」ボタンを押す</li>
<li>「キーとタッチのカスタマイズ」を押す</li>
<li>「各キーに好みの機能を割り当てる」のスイッチをオンにする。</li>
<li>「Ctrl + Space」を「IME-オン/オフ」に変更する。</li>
</ol>
<h3 id="タッチパッドの設定">タッチパッドの設定</h3>
<ol>
<li>Windows キー + i を押して設定画面を表示</li>
<li>「デバイス」を選択</li>
<li>左で「タッチパッド」を選択</li>
<li>「カーソルの速度を変更する」を適宜調整</li>
<li>「右クリックするにはタッチパッドの右下を押します」をオフにする</li>
<li>「3本指ジェスチャ」と「4本指ジェスチャ」は「何もしない」に変更</li>
</ol>
<h3 id="ディスプレイの設定">ディスプレイの設定</h3>
<ol>
<li>デスクトップでポップアップメニューの「ディスプレイ設定」を選択</li>
<li>「テキスト、アプリ、その他の項目のサイズを変更する」を「100%」に変更</li>
</ol>
<h3 id="電源とスリープ">電源とスリープ</h3>
<p>スリープはなしに変更</p>
<h3 id="キーボードの-ctrl-と-capslock-入れ替え">キーボードの Ctrl と CapsLock 入れ替え</h3>
<p>BIOS に Fn と Ctrl の入れ替えという設定はありましたが、Ctrl と CapsLock 入れ替えはなかったので、いつも使ってるレジストリ設定を投入します。</p>
<p><a href="https://ascii.jp/elem/000/000/927/927191/">ASCII.jp：CtrlとCapsを入れ替え！　Windowsのキー配列をカスタマイズ (1/2)</a></p>
<p><a href="/blog/windows10_keyboard_swap_ctrl_caps.reg">windows10_keyboard_swap_ctrl_caps.reg</a> を名前をつけて保存して、エクスプローラで選んでポップアップメニューの「結合」を選んでレジストリに登録します。その後 Windows を再起動して反映します。</p>
<h3 id="マルチタスク設定">マルチタスク設定</h3>
<ol>
<li>Windows キー + i を押して設定画面を表示</li>
<li>「システム」を選択</li>
<li>左で「マルチタスク」を選択</li>
<li>「ウィンドウのスナップ」と「タイムライン」をオフ</li>
<li>「AltキーとTabキーを押すと表示されます」を「ウィンドウのみを開く」に変更</li>
</ol>
<h3 id="ホスト名設定">ホスト名設定</h3>
<p>参考: <a href="http://alpha.shudo-u.ac.jp/~helpdesk/network/hostname-win10.html">ホスト名の設定（Windows 10）</a> と <a href="https://support.lenovo.com/rs/ja/solutions/ht105079">Windows 10でパソコンの名前（PC名）を確認/変更する方法 - Lenovo Support RS</a></p>
<ol>
<li>Windows キー + x を押して開いたメニューで「システム」をクリック</li>
<li>「このPCの名前を変更」ボタンを押す</li>
<li>「PC名を変更する」ダイアログで希望のPC名を入力後、再起動して反映</li>
</ol>
<h3 id="エクスプローラの表示設定">エクスプローラの表示設定</h3>
<ol>
<li>Windows キー + e を押してエクスプローラーを開く</li>
<li>[表示] / [詳細] メニューをクリック</li>
<li>[表示] / [オプション] メニューをクリック</li>
<li>「フォルダー オプション」ダイアログで「表示」タブに切り替え</li>
<li>詳細設定で以下のように変更して「適用」ボタンを押す
<ul>
<li>「隠しファイル、隠しフォルダー、および隠しドライブを表示する」をクリック</li>
<li>「登録されている拡張子は表示しない」をオフ</li>
<li>「保護されたオペレーティングシステムファイルを表示しない(推奨)」をオフ</li>
</ul>
</li>
<li>「フォルダーを表示」グループボックス内の「フォルダーに適用」ボタンを押す</li>
</ol>
<h3 id="bluetooth-をオフ">Bluetooth をオフ</h3>
<ol>
<li>Windows キー + i を押して設定画面を表示</li>
<li>「デバイス」をクリック</li>
<li>「Bluetoothとその他のデバイス」でBluetoothのスイッチをオフに変更</li>
</ol>
<h2 id="パスワードマネージャー-keepassxc-インストール">パスワードマネージャー KeePassXC インストール</h2>
<p><a href="https://keepassxc.org/">KeePassXC Password Manager</a> からインストーラーをダウンロードしてインストールします。</p>
<p>データファイルは既存のPCからUSB外付けハードディスクにコピーし、それを新しいPCに繋ぎ変えてコピーします。</p>
<h2 id="firefox-と-chrome-のセットアップ">Firefox と Chrome のセットアップ</h2>
<h3 id="firefox">Firefox</h3>
<p><a href="https://www.mozilla.org/ja/firefox/new/">Mozilla から高速、プライベート、無料の Firefox ブラウザー をダウンロード</a> からダウンロードしてインストールします。</p>
<p>私はFirefoxは敢えてログインしない使い方にしています。</p>
<p>ブックマークは他の PC の Firefox からエクスポートしたものをインポートします。</p>
<p>パスワードは保存しないように設定変更します。</p>
<p>拡張は Diigo と拙作の Format Link を入れます。</p>
<h4 id="google-の英語での検索設定">Google の英語での検索設定</h4>
<p>Firefox は設定の検索から「他の検索エンジンを追加」リンクをクリックすると <code>addons.mozilla.org</code> に登録された検索エンジンを追加できます。</p>
<p>しかしこれだと自分で好きな設定に出来ないので、ブックマークを使う方式にしています。</p>
<p>場所はどこでも良いので以下のようなブックマークを作ります。</p>
<ol>
<li>ハンバーガーメニューの「ブックマーク」の「ブックマークを管理」をクリック</li>
<li>左のツリーで「他のブックマーク」を選び(他でも可)、[管理]/[ブックマークを追加]メニューを選択</li>
<li>「新しいブックマークを追加」ダイアログで以下のように入力して「保存」ボタンを押す。
<ul>
<li>名前: Google en</li>
<li>URL: <code>https://www.google.com/search?q=%s&amp;hl=en</code></li>
<li>タグ: (空のまま)</li>
<li>キーワード: g</li>
</ul>
</li>
</ol>
<p>これでURL欄に g スペースと入れてその後に検索ワードを入れてEnterを押すと英語で検索されます。</p>
<h3 id="chrome">Chrome</h3>
<p><a href="https://www.google.com/intl/ja_jp/chrome/">Google Chrome - Google の高速で安全なブラウザをダウンロード</a> からダウンロードしてインストールします。</p>
<p>自分のアカウントでサインインすると設定(拡張のインストールとブックマーク)が同期されます。自分の写真がブラウザに常に表示されるのはうっとおしいのでアバターはChromeで用意されているアイコンに変更します。</p>
<h4 id="google-の英語での検索設定-1">Google の英語での検索設定</h4>
<p>設定で同期されるので変更は不要ですが、「検索エンジンの管理」では以下の設定を追加しています。</p>
<ul>
<li>検索エンジン: Google en</li>
<li>キーワード: g</li>
<li>URL (%s=検索語): <code>https://www.google.com/search?q=%s&amp;hl=en</code></li>
</ul>
<p>これでURL欄に g とスペースを押すと Google en と表示され、続いて検索ワードを入れて Enter を押すと英語で検索されます。</p>
<h2 id="wsl2-セットアップ">WSL2 セットアップ</h2>
<p>参考: <a href="/blog/2020/05/28/setup-wsl2-ubuntu-and-docker-desktop-for-windows/">WSL2のUbuntuとDocker Desktop for Windowsを試してみた · hnakamur&rsquo;s blog</a></p>
<p>今回も手順をミスって一旦 WSL1 で作った後 WSL2 に変換したので、下記の手順で一発で行けるかは不明です。</p>
<p>管理者権限の PowerShell を開いて以下のコマンドを実行し Microsoft-Windows-Subsystem-Linux の機能を有効にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">dism</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">online</span> <span class="p">/</span><span class="nb">enable-feature</span> <span class="p">/</span><span class="n">featurename</span><span class="err">:</span><span class="nb">Microsoft-Windows</span><span class="n">-Subsystem-Linux</span> <span class="p">/</span><span class="n">all</span> <span class="p">/</span><span class="n">norestart</span>
</span></span></code></pre></div><p>ここで一度Windowsを再起動します。</p>
<p>管理者権限の PowerShell を開いて以下のコマンドを実行し &ldquo;仮想マシン プラットフォーム&quot;のオプション コンポーネントを有効にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">dism</span><span class="p">.</span><span class="py">exe</span> <span class="p">/</span><span class="n">online</span> <span class="p">/</span><span class="nb">enable-feature</span> <span class="p">/</span><span class="n">featurename</span><span class="err">:</span><span class="n">VirtualMachinePlatform</span> <span class="p">/</span><span class="n">all</span> <span class="p">/</span><span class="n">norestart</span>
</span></span></code></pre></div><p><a href="https://docs.microsoft.com/ja-jp/windows/wsl/wsl2-kernel">WSL 2 Linux カーネルの更新 | Microsoft Docs</a> から Linux カーネル更新プログラム パッケージ（ファイル名： wsl_update_x64.msi ）をダウンロード、インストールします。</p>
<p>以下のコマンドを実行し、WSLのデフォルトバージョンを2にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">wsl</span> <span class="p">-</span><span class="n">-set-default-version</span> <span class="mf">2</span>
</span></span></code></pre></div><p>タスクバーの「Microsoft Store」を開き検索欄に「Ubuntu 20.04」と入力して「Ubuntu 20.04 LTS」を選択しインストールします。</p>
<h3 id="wsl2-の-linux-カーネルの更新を-windows-update-で受け取る設定-2021-07-23追記">WSL2 の Linux カーネルの更新を Windows Update で受け取る設定 (2021-07-23追記)</h3>
<p><a href="https://news.mynavi.jp/article/win10tips-592/">Windows 10ミニTips(592) 最新のLinuxカーネルがWindows Updateから降ってこない | マイナビニュース</a> を参考に設定します。保全のため以下にメモ。</p>
<ol>
<li>Windows キーを押し Update と入力して絞り込まれたメニューから「Windows Update の詳細オプション」を選択</li>
<li>「Windows の更新時に他の Microsoft 製品の更新プログラムを受け取る」スイッチをオンに切り替え</li>
</ol>
<h2 id="visual-studio-code-インストール">Visual Studio Code インストール</h2>
<p><a href="https://code.visualstudio.com/">Visual Studio Code - Code Editing. Redefined</a> からインストーラーをダウンロードしてインストールします。</p>
<h2 id="cica-フォントインストール">Cica フォントインストール</h2>
<p><a href="https://github.com/miiton/Cica">miiton/Cica: プログラミング用日本語等幅フォント Cica(シカ)</a> の <a href="https://github.com/miiton/Cica/releases">Releases · miiton/Cica</a> から最新リリースの絵文字ありの zip ファイルをダウンロードします。</p>
<p>エクスプローラで開いて <code>*.ttf</code> ファイルを zip の外にコピーして、選択してポップアップメニューの「インストール」でインストールします。</p>
<h2 id="windows-terminal-インストールと設定">Windows Terminal インストールと設定</h2>
<h2 id="windows-terminal-のインストール">Windows Terminal のインストール</h2>
<p>タスクバーの「Microsoft Store」を開き検索欄に「terminal」と入力して「Windows Terminal」を選択しインストールします。</p>
<h3 id="windows-terminal-の設定">Windows Terminal の設定</h3>
<p>参考: <a href="/blog/2020/05/16/my-settings-for-windows-terminal/">Windows Terminalの私の設定 · hnakamur&rsquo;s blog</a></p>
<p>ウィンドウの列数、行数と位置は以下のようにしました。</p>
<pre tabindex="0"><code>    &#34;initialCols&#34;: 200,
    &#34;initialRows&#34;: 54,
    &#34;initialPosition&#34;: &#34;0,0&#34;,
</code></pre><h2 id="7-zip-をインストール">7-Zip をインストール</h2>
<p><a href="https://sevenzip.osdn.jp/">圧縮・解凍ソフト 7-Zip</a> から 7-Zip をダウンロードしてインストールします。
(以前は次項の wsl-ssh-agent の配布物の解凍に必要だったのですが、最新版は通常のzip形式になっていたのでこの点だけなら不要です)</p>
<h2 id="wsl2-と-keepassxc-で-ssh-agent-を使う設定">WSL2 と KeePassXC で ssh-agent を使う設定</h2>
<h3 id="ssh-agent-のサービス自動起動設定">ssh-agent のサービス自動起動設定</h3>
<h4 id="openssh-クライアントはプリインストールされていました">OpenSSH クライアントはプリインストールされていました</h4>
<p>参考: <a href="https://docs.microsoft.com/ja-jp/windows-server/administration/openssh/openssh_install_firstuse">OpenSSH をインストールする | Microsoft Docs</a> と <a href="/blog/2020/02/22/install-openssh-client-to-windows10/">Windows 10 に OpenSSH クライアントをインストール · hnakamur&rsquo;s blog</a></p>
<p>管理権限の PowerShell を開いて以下のコマンドを実行して OpenSSH クライアントがインストール済みかを確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-WindowsCapability</span> <span class="n">-Online</span> <span class="p">|</span> <span class="p">?</span> <span class="n">Name</span> <span class="o">-like</span> <span class="s1">&#39;OpenSSH*&#39;</span>
</span></span></code></pre></div><p>私の環境では以下の出力となり OpenSSH クライアントはプリインストール済みでした。</p>
<pre tabindex="0"><code>Name  : OpenSSH.Client~~~~0.0.1.0
State : Installed

Name  : OpenSSH.Server~~~~0.0.1.0
State : NotPresent
</code></pre><h4 id="ssh-agent-サービスの自動起動設定">ssh-agent サービスの自動起動設定</h4>
<p>管理権限の PowerShell を開いて以下のコマンドを実行して ssh-agent サービスの状態を確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-Service</span> <span class="nb">ssh-agent</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Name</span><span class="p">,</span><span class="n">DisplayName</span><span class="p">,</span><span class="n">Status</span><span class="p">,</span><span class="n">StartType</span>
</span></span></code></pre></div><p>私の環境では Status が Stopped, StartType が Disabled になっていました。</p>
<p>StartType が Disabled のままだとサービスを起動できないので、以下のコマンドで自動起動にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Set-Service</span> <span class="nb">ssh-agent</span> <span class="n">-StartupType</span> <span class="n">Automatic</span>
</span></span></code></pre></div><p>その後以下のコマンドを実行して ssh-agent サービスを起動します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Start-Service</span> <span class="nb">ssh-agent</span>
</span></span></code></pre></div><p>再度</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="nb">Get-Service</span> <span class="nb">ssh-agent</span> <span class="p">|</span> <span class="nb">Select </span><span class="n">Name</span><span class="p">,</span><span class="n">DisplayName</span><span class="p">,</span><span class="n">Status</span><span class="p">,</span><span class="n">StartType</span>
</span></span></code></pre></div><p>を実行して Status が Running, StartType が Automatic になったことを確認します。</p>
<h3 id="wsl2-で-wsl-ssh-agent-のセットアップ">WSL2 で wsl-ssh-agent のセットアップ</h3>
<p>参考:</p>
<ul>
<li><a href="https://github.com/rupor-github/wsl-ssh-agent">rupor-github/wsl-ssh-agent: Helper to interface with Windows ssh-agent.exe service from Windows Subsystem for Linux (WSL)</a> の <a href="https://github.com/rupor-github/wsl-ssh-agent#wsl-2-compatibility">WSL 2 compatibility</a></li>
<li><a href="/blog/2020/05/29/run-ssh-agent-with-keepass-and-keeagent-for-wsl2/">KeePassとKeeAgentでWSL2用にssh-agentを動かす · hnakamur&rsquo;s blog</a></li>
</ul>
<p>手順:</p>
<ol>
<li><a href="https://github.com/rupor-github/wsl-ssh-agent/releases">Releases · rupor-github/wsl-ssh-agent</a> から最新版をダウンロードします。 2021-07-04 時点では v1.5.2 で <code>wsl-ssh-agent.zip</code> というファイル名でした。</li>
<li>エクスプローラーでダウンロードした zip ファイルを開き <code>npiperelay.exe</code> を zip の外にコピーします。私は <code>C:\wsl-ssh-agent</code> というフォルダーを作ってそこにコピーすることにしました。</li>
<li>WSL2 の Ubuntu-20.04 のシェルで以下のコマンドを実行し <code>socat</code> パッケージをインストールします。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo apt update <span class="o">&amp;&amp;</span> sudo apt install -y socat
</span></span></code></pre></div><ol start="4">
<li><a href="https://github.com/rupor-github/wsl-ssh-agent#wsl-2-compatibility">WSL 2 compatibility</a> に書かれている設定を <code>npiperelay.exe</code> のパスを自分の環境に応じて書き換えて <code>~/.bashrc</code> に追記します。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># Use ssh-agent through wwl-ssh-agent</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">SSH_AUTH_SOCK</span><span class="o">=</span><span class="nv">$HOME</span>/.ssh/agent.sock
</span></span><span class="line"><span class="cl">ss -a <span class="p">|</span> grep -q <span class="nv">$SSH_AUTH_SOCK</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    rm -f <span class="nv">$SSH_AUTH_SOCK</span>
</span></span><span class="line"><span class="cl">    <span class="o">(</span> setsid socat UNIX-LISTEN:<span class="nv">$SSH_AUTH_SOCK</span>,fork EXEC:<span class="s2">&#34;/mnt/c/wsl-ssh-agent/npiperelay.exe -ei -s //./pipe/openssh-ssh-agent&#34;</span>,nofork <span class="p">&amp;</span> <span class="o">)</span> &gt;/dev/null 2&gt;<span class="p">&amp;</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></div><ol start="5">
<li>WSL2 のターミナルを起動し直すか以下のコマンドを実行してログインシェルを再起動します。</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">exec</span> <span class="nv">$SHELL</span> -l
</span></span></code></pre></div><h3 id="keepassxc-から-ssh-agent-への接続設定">KeePassXC から ssh-agent への接続設定</h3>
<ol>
<li>KeePassXC の [ツール]/[設定] メニューをクリック</li>
<li>左の「SSHエージェント」をクリック</li>
<li>「SSHエージェント統合を有効にする」と「Pagentの代わりにOpenSSH for Windowsを使用する」にチェックして「OK」ボタンを押す</li>
<li>KeePassXC を一旦終了して再起動</li>
<li>[ツール]/[設定]メニューをクリックし左の「SSHエージェント」をクリックして「SSHエージェント接続が動作中です！」と表示されていればOKです。</li>
</ol>
<p>鍵の追加はエントリー一覧上でSSH秘密鍵を添付してあるエントリー(パスワード欄にパスフレーズを設定しています)を選択して[エントリー]/[SSHエージェントに鍵を追加]メニューで行います。</p>
<p>また <code>~/.ssh/config</code> のファイルを添付してあるエントリーからファイルを一旦Windowsのフォルダーに保存し、WSL2 のシェルを開いて WSL2 側に移動します。</p>
<p>例えば Documents フォルダーに保存したとして WSL2 のシェルでは以下のようにします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">mkdir -m <span class="m">700</span> ~/.ssh
</span></span><span class="line"><span class="cl">mv /mnt/c/Users/hnakamur/Documents/config ~/.ssh/config
</span></span><span class="line"><span class="cl">chmod <span class="m">600</span> ~/.ssh/config
</span></span></code></pre></div><p>これで KeePassXC がロック中の状態では <code>ssh-add -l</code> で確認すると <code>The agent has no identities.</code> となり、アンロック中は指定の鍵が登録された状態になります。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>
  </body>
</html>
