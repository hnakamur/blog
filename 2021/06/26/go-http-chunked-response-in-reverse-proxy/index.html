<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.111.2">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>GoのHTTPリバースプロキシーでのchunkedレスポンス &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>GoのHTTPリバースプロキシーでのchunkedレスポンス</h1>
  <time datetime=2021-06-26T16:55:00&#43;0900 class="post-date">2021-06-26</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#httpサーバーのリクエストハンドラー内からの-chunked-出力">HTTPサーバーのリクエストハンドラー内からの chunked 出力</a></li>
    <li><a href="#reverseproxy-を経由した-chunked-出力">ReverseProxy を経由した chunked 出力</a></li>
  </ul>
</nav>
  <h2 id="httpサーバーのリクエストハンドラー内からの-chunked-出力">HTTPサーバーのリクエストハンドラー内からの chunked 出力</h2>
<p>まずはリバースプロキシー無しでHTTPサーバー単体での chunked 出力について調べました。</p>
<p>そもそもどうやって Go の net/http パッケージで chunked なレスポンスを返すかですが、 <a href="https://stackoverflow.com/a/30603654/1391518">StackOverflow の回答</a> にコードと telnet で受信したレスポンスのサンプルが紹介されていました。</p>
<p><code>Content-Length</code> レスポンスヘッダーをつけないようにしつつ、リクエストハンドラーの <code>func ServeHTTP(w http.ResponseWriter, r *http.Request)</code> の <code>w</code> を <a href="https://golang.org/pkg/net/http/#Flusher">net/http.Flusher</a> インタフェースに type assertion して OK ならその Flush メソッドを呼ぶと chunked なレスポンスを返せます。</p>
<p>自分でも試してみました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;fmt&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;html&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;time&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">addr</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;:9090&#34;</span><span class="p">,</span> <span class="s">&#34;listen address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="nx">addr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">run</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">HandleFunc</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">Header</span><span class="p">().</span><span class="nf">Set</span><span class="p">(</span><span class="s">&#34;Content-Type&#34;</span><span class="p">,</span> <span class="s">&#34;text/plain&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Hello, %q\n&#34;</span><span class="p">,</span> <span class="nx">html</span><span class="p">.</span><span class="nf">EscapeString</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">flusher</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.(</span><span class="nx">http</span><span class="p">.</span><span class="nx">Flusher</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;w type=%T, is flusher=%v&#34;</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">ok</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;expected http.ResponseWriter to be an http.Flusher&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&#34;Chunk #%d\n&#34;</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">flusher</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span> <span class="c1">// Trigger &#34;chunked&#34; encoding and send a chunk...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">500</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>telnet での検証結果。Hostリクエストヘッダの後の空行を入れるとchunkedレスポンスが返ってきます。
最後は ^] (Ctrl-]) を押した後 ^D (Ctrl-D) を押してtelnetを抜けます。</p>
<pre tabindex="0"><code>$ telnet localhost 9090
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
GET / HTTP/1.1
Host: example.com

HTTP/1.1 200 OK
Content-Type: text/plain
Date: Sat, 26 Jun 2021 01:38:54 GMT
Transfer-Encoding: chunked

14
Hello, &#34;/&#34;
Chunk #1

9
Chunk #2

9
Chunk #3

0

^]
telnet&gt; Connection closed.
</code></pre><p>サーバー側の <code>log.Printf(&quot;w type=%T, is flusher=%v&quot;, w, ok)</code> の出力は <code>w type=*http.response, is flusher=true</code> となりました。</p>
<p>つまり、リクエストハンドラーの <code>func ServeHTTP(w http.ResponseWriter, r *http.Request)</code> の <code>w</code> は <code>*net/http.response</code> が渡されます。</p>
<p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/server.go#L417-L485">http.response 構造体の定義</a>。</p>
<p><a href="https://golang.org/pkg/net/http/httputil/#NewChunkedWriter">net/http/httputil/NewChunkedWriter</a> という公開APIはあるがそちらは使わず、非公開の chunkWriter 構造体を使っています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A response represents the server side of an HTTP response.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">response</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// …(略)…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">w</span>  <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Writer</span> <span class="c1">// buffers output in chunks to chunkWriter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">cw</span> <span class="nx">chunkWriter</span>
</span></span><span class="line"><span class="cl"><span class="c1">// …(略)…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><code>http.response</code> の w と cw は <a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/server.go#L956-L1058">conn の readRequest メソッド</a> 内で設定されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Read next request from connection.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">conn</span><span class="p">)</span> <span class="nf">readRequest</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">response</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// …(略)…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">w</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">response</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">conn</span><span class="p">:</span>          <span class="nx">c</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="c1">// …(略)…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// …(略)…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">w</span><span class="p">.</span><span class="nx">cw</span><span class="p">.</span><span class="nx">res</span> <span class="p">=</span> <span class="nx">w</span>
</span></span><span class="line"><span class="cl">	<span class="nx">w</span><span class="p">.</span><span class="nx">w</span> <span class="p">=</span> <span class="nf">newBufioWriterSize</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">w</span><span class="p">.</span><span class="nx">cw</span><span class="p">,</span> <span class="nx">bufferBeforeChunkingSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">w</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/server.go#L1677-L1683">http.response の Flush メソッド</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">w</span> <span class="o">*</span><span class="nx">response</span><span class="p">)</span> <span class="nf">Flush</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">w</span><span class="p">.</span><span class="nx">wroteHeader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">w</span><span class="p">.</span><span class="nf">WriteHeader</span><span class="p">(</span><span class="nx">StatusOK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">w</span><span class="p">.</span><span class="nx">w</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">w</span><span class="p">.</span><span class="nx">cw</span><span class="p">.</span><span class="nf">flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/server.go#L335-L361">chunkedWriter 構造体の定義</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// chunkWriter writes to a response&#39;s conn buffer, and is the writer
</span></span></span><span class="line"><span class="cl"><span class="c1">// wrapped by the response.bufw buffered writer.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// chunkWriter also is responsible for finalizing the Header, including
</span></span></span><span class="line"><span class="cl"><span class="c1">// conditionally setting the Content-Type and setting a Content-Length
</span></span></span><span class="line"><span class="cl"><span class="c1">// in cases where the handler&#39;s final output is smaller than the buffer
</span></span></span><span class="line"><span class="cl"><span class="c1">// size. It also conditionally adds chunk headers, when in chunking mode.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// See the comment above (*response).Write for the entire write flow.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">chunkWriter</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">res</span> <span class="o">*</span><span class="nx">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// header is either nil or a deep clone of res.handlerHeader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// at the time of res.writeHeader, if res.writeHeader is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// called and extra buffering is being done to calculate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Content-Type and/or Content-Length.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">header</span> <span class="nx">Header</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// wroteHeader tells whether the header&#39;s been written to &#34;the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// wire&#34; (or rather: w.conn.buf). this is unlike
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// (*response).wroteHeader, which tells only whether it was
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// logically written.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">wroteHeader</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// set by the writeHeader method:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">chunking</span> <span class="kt">bool</span> <span class="c1">// using chunked transfer encoding for reply body
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><code>chunking</code> は <a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/server.go#L1214-L1488">chunkWriter の writeHeader メソッド</a> 内の以下の条件を全て満たす場合に <code>true</code> に設定されます。</p>
<ul>
<li>メソッドが HEAD ではない</li>
<li>ボディが許されるステータスコードである</li>
<li>Content-Length がない</li>
<li>リクエストプロトコルが HTTP/1.1 以上である</li>
<li>Transfer-Encoding が存在しないか、存在するが値が identity ではない　</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// writeHeader finalizes the header sent to the client and writes it
</span></span></span><span class="line"><span class="cl"><span class="c1">// to cw.res.conn.bufw.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// p is not written by writeHeader, but is the first chunk of the body
</span></span></span><span class="line"><span class="cl"><span class="c1">// that will be written. It is sniffed for a Content-Type if none is
</span></span></span><span class="line"><span class="cl"><span class="c1">// set explicitly. It&#39;s also used to set the Content-Length, if the
</span></span></span><span class="line"><span class="cl"><span class="c1">// total body size was small and the handler has already finished
</span></span></span><span class="line"><span class="cl"><span class="c1">// running.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cw</span> <span class="o">*</span><span class="nx">chunkWriter</span><span class="p">)</span> <span class="nf">writeHeader</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// …(略)…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">te</span> <span class="o">:=</span> <span class="nx">header</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hasTE</span> <span class="o">:=</span> <span class="nx">te</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// …(略)…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">==</span> <span class="s">&#34;HEAD&#34;</span> <span class="o">||</span> <span class="p">!</span><span class="nf">bodyAllowedForStatus</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// do nothing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">code</span> <span class="o">==</span> <span class="nx">StatusNoContent</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">delHeader</span><span class="p">(</span><span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">hasCL</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">delHeader</span><span class="p">(</span><span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">w</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nf">ProtoAtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// HTTP/1.1 or greater: Transfer-Encoding has been set to identity, and no
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// content-length has been provided. The connection must be closed after the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// reply is written, and no chunking is to be done. This is the setup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// recommended in the Server-Sent Events candidate recommendation 11,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// section 8.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">hasTE</span> <span class="o">&amp;&amp;</span> <span class="nx">te</span> <span class="o">==</span> <span class="s">&#34;identity&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cw</span><span class="p">.</span><span class="nx">chunking</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">			<span class="nx">w</span><span class="p">.</span><span class="nx">closeAfterReply</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// HTTP/1.1 or greater: use chunked transfer encoding
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// to avoid closing the connection at EOF.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">cw</span><span class="p">.</span><span class="nx">chunking</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">			<span class="nx">setHeader</span><span class="p">.</span><span class="nx">transferEncoding</span> <span class="p">=</span> <span class="s">&#34;chunked&#34;</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">hasTE</span> <span class="o">&amp;&amp;</span> <span class="nx">te</span> <span class="o">==</span> <span class="s">&#34;chunked&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// We will send the chunked Transfer-Encoding header later.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nf">delHeader</span><span class="p">(</span><span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// HTTP version &lt; 1.1: cannot do chunked transfer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// encoding and we don&#39;t know the Content-Length so
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// signal EOF by closing connection.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">w</span><span class="p">.</span><span class="nx">closeAfterReply</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="nf">delHeader</span><span class="p">(</span><span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">)</span> <span class="c1">// in case already set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Cannot use Content-Length with non-identity Transfer-Encoding.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">cw</span><span class="p">.</span><span class="nx">chunking</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">delHeader</span><span class="p">(</span><span class="s">&#34;Content-Length&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// …(略)…
</span></span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/server.go#L368-L391">chunkWriter の Write メソッド</a>。</p>
<p>cw.chunking が true の場合は内容を書き出す前に長さと CR+LF を出力します。
さらに内容を書き出した際にエラーが起きていなければその後に CR+LF を出力します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cw</span> <span class="o">*</span><span class="nx">chunkWriter</span><span class="p">)</span> <span class="nf">Write</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">cw</span><span class="p">.</span><span class="nx">wroteHeader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cw</span><span class="p">.</span><span class="nf">writeHeader</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cw</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">==</span> <span class="s">&#34;HEAD&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Eat writes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cw</span><span class="p">.</span><span class="nx">chunking</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Fprintf</span><span class="p">(</span><span class="nx">cw</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nx">bufw</span><span class="p">,</span> <span class="s">&#34;%x\r\n&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cw</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nx">rwc</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cw</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nx">bufw</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cw</span><span class="p">.</span><span class="nx">chunking</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">cw</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nx">bufw</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">crlf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cw</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nx">rwc</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/server.go#L393-L398">chunkWriter の flush メソッド</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cw</span> <span class="o">*</span><span class="nx">chunkWriter</span><span class="p">)</span> <span class="nf">flush</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">cw</span><span class="p">.</span><span class="nx">wroteHeader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cw</span><span class="p">.</span><span class="nf">writeHeader</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cw</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nx">bufw</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/server.go#L400-L415">chunkWriter の close メソッド</a>。</p>
<p>chunked の終わりを示す 0+CR+LF を書いた後、あればトレーラーを書いて、最後に CR+LF を書いています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cw</span> <span class="o">*</span><span class="nx">chunkWriter</span><span class="p">)</span> <span class="nb">close</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">cw</span><span class="p">.</span><span class="nx">wroteHeader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cw</span><span class="p">.</span><span class="nf">writeHeader</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cw</span><span class="p">.</span><span class="nx">chunking</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">bw</span> <span class="o">:=</span> <span class="nx">cw</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nx">conn</span><span class="p">.</span><span class="nx">bufw</span> <span class="c1">// conn&#39;s bufio writer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// zero chunk to mark EOF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">bw</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;0\r\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">trailers</span> <span class="o">:=</span> <span class="nx">cw</span><span class="p">.</span><span class="nx">res</span><span class="p">.</span><span class="nf">finalTrailers</span><span class="p">();</span> <span class="nx">trailers</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">trailers</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">bw</span><span class="p">)</span> <span class="c1">// the writer handles noting errors
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// final blank line after the trailers (whether
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// present or not)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">bw</span><span class="p">.</span><span class="nf">WriteString</span><span class="p">(</span><span class="s">&#34;\r\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="reverseproxy-を経由した-chunked-出力">ReverseProxy を経由した chunked 出力</h2>
<p><a href="https://golang.org/pkg/net/http/httputil/#NewSingleHostReverseProxy">httputil.NewSingleHostReverseProxy</a> を使ったリバースプロキシーのサンプルです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;flag&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;log&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/http/httputil&#34;</span>
</span></span><span class="line"><span class="cl">	<span class="s">&#34;net/url&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">addr</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;addr&#34;</span><span class="p">,</span> <span class="s">&#34;:9900&#34;</span><span class="p">,</span> <span class="s">&#34;listen address&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">upstream</span> <span class="o">:=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;upstream&#34;</span><span class="p">,</span> <span class="s">&#34;http://localhost:9090&#34;</span><span class="p">,</span> <span class="s">&#34;upstream URL&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="nx">addr</span><span class="p">,</span> <span class="o">*</span><span class="nx">upstream</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Fatal</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">run</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">upstream</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">rpURL</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">url</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="nx">upstream</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nf">Handle</span><span class="p">(</span><span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="nx">httputil</span><span class="p">.</span><span class="nf">NewSingleHostReverseProxy</span><span class="p">(</span><span class="nx">rpURL</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nf">ListenAndServe</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>telnet での検証結果。</p>
<pre tabindex="0"><code>$ telnet localhost 9900
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
GET / HTTP/1.1
Host: example.com

HTTP/1.1 200 OK
Content-Type: text/plain
Date: Sat, 26 Jun 2021 01:45:36 GMT
Transfer-Encoding: chunked

14
Hello, &#34;/&#34;
Chunk #1

9
Chunk #2

9
Chunk #3

0

^]
telnet&gt; Connection closed.
</code></pre><p>オリジンサーバの <code>time.Sleep(500 * time.Millisecond)</code> をコメントアウトして再度試してみると Chunk #2 と Chunk #3 が1つにまとめて出力されました。</p>
<pre tabindex="0"><code>$ telnet localhost 9900
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
GET / HTTP/1.1
Host: example.com

HTTP/1.1 200 OK
Content-Type: text/plain
Date: Sat, 26 Jun 2021 01:48:37 GMT
Transfer-Encoding: chunked

14
Hello, &#34;/&#34;
Chunk #1

12
Chunk #2
Chunk #3

0

^]
telnet&gt; Connection closed.
</code></pre><p>オリジンに直接アクセスするとこちらはまとめられてはいません。</p>
<pre tabindex="0"><code>$ telnet localhost 9090
Trying 127.0.0.1...
Connected to localhost.
Escape character is &#39;^]&#39;.
GET / HTTP/1.1
Host: example.com

HTTP/1.1 200 OK
Content-Type: text/plain
Date: Sat, 26 Jun 2021 01:50:30 GMT
Transfer-Encoding: chunked

14
Hello, &#34;/&#34;
Chunk #1

9
Chunk #2

9
Chunk #3

0

^]
telnet&gt; Connection closed.
</code></pre><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/httputil/reverseproxy.go#L212-L358">ReverseProxy の ServeHTTP メソッド</a> 内の以下の行</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">	<span class="nx">err</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">copyResponse</span><span class="p">(</span><span class="nx">rw</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nf">flushInterval</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>
</span></span></code></pre></div><p>でオリジンのレスポンスボディをクライアントに返しているようです。</p>
<p>ここで Go の標準ライブラリーのソースにデバッグログ出力を埋め込んで調査しました。
これは <a href="https://kawaken.hateblo.jp/entry/2017/07/31/150015">umeda.go #2 で発表してきた - kawaken&rsquo;s blog</a> で教わったものです。公式ドキュメントに書かれているわけではないので、将来もできるかの保証はありませんが、ソースを書き換えて自分のアプリケーションをビルドするだけで良いので手軽で便利です。デバッグが終わったらソースを元に戻すのを忘れずに。私は以下のような感じで /usr/local/go 全体でインストールし直しています。</p>
<pre tabindex="0"><code>rm -rf /usr/local/go; tar xf ~/go1.16.5.linux-amd64.tar.gz -C /usr/local/
</code></pre><p>またGoの標準ライブラリーのソースを Visual Studio Code で開くときは [File] / [Add Folder to Workspace &hellip;] メニューで /usr/local/go ではなく /usr/local/go/src を開くと [Go to Definition] なども動いて便利です。</p>
<p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/httputil/reverseproxy.go#L413-L437">ReverseProxy の copyResponse メソッド</a> に以下のように 2 箇所ログ出力を入れてみました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ReverseProxy</span><span class="p">)</span> <span class="nf">copyResponse</span><span class="p">(</span><span class="nx">dst</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">src</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">flushInterval</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;ReverseProxy.copyResponse, dst type=%T, flushInterval=%s&#34;</span><span class="p">,</span> <span class="nx">dst</span><span class="p">,</span> <span class="nx">flushInterval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">flushInterval</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">wf</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">dst</span><span class="p">.(</span><span class="nx">writeFlusher</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;ReverseProxy.copyResponse, dst is writeFlusher&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">mlw</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">maxLatencyWriter</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">dst</span><span class="p">:</span>     <span class="nx">wf</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="nx">latency</span><span class="p">:</span> <span class="nx">flushInterval</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">defer</span> <span class="nx">mlw</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// set up initial timer so headers get flushed even if body writes are delayed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">mlw</span><span class="p">.</span><span class="nx">flushPending</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">			<span class="nx">mlw</span><span class="p">.</span><span class="nx">t</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">AfterFunc</span><span class="p">(</span><span class="nx">flushInterval</span><span class="p">,</span> <span class="nx">mlw</span><span class="p">.</span><span class="nx">delayedFlush</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="nx">dst</span> <span class="p">=</span> <span class="nx">mlw</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">BufferPool</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">buf</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">BufferPool</span><span class="p">.</span><span class="nf">Get</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">BufferPool</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">copyBuffer</span><span class="p">(</span><span class="nx">dst</span><span class="p">,</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>これで再度試すと以下のようなログが出ました。</p>
<pre tabindex="0"><code>2021/06/26 10:56:12 ReverseProxy.copyResponse, dst type=*http.response, flushInterval=-1ns
2021/06/26 10:56:12 ReverseProxy.copyResponse, dst is writeFlusher
</code></pre><p>ということで ReverseProxy の copyResponse の引数の dst は <code>*http.response</code> 型ですが、中で <code>maxLatencyWriter</code> 構造体のインスタンスを作って dst を差し替えていることがわかります。</p>
<p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/httputil/reverseproxy.go#L480-L483">writeFlusher</a> は以下のようなインターフェースです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">writeFlusher</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span>
</span></span><span class="line"><span class="cl">	<span class="nx">http</span><span class="p">.</span><span class="nx">Flusher</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/httputil/reverseproxy.go#L485-L492">maxLatencyWriter</a> 構造体の定義。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">maxLatencyWriter</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">dst</span>     <span class="nx">writeFlusher</span>
</span></span><span class="line"><span class="cl">	<span class="nx">latency</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span> <span class="c1">// non-zero; negative means to flush immediately
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">mu</span>           <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span> <span class="c1">// protects t, flushPending, and dst.Flush
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">t</span>            <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Timer</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flushPending</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>今回は上のログ出力でわかったように dst は <code>*http.response</code> 型の値で latency は -1 になっています。</p>
<p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/httputil/reverseproxy.go#L494-L512">maxLatencyWriter の Write メソッド</a> にもログを入れました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">maxLatencyWriter</span><span class="p">)</span> <span class="nf">Write</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">dst</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;httputil.maxLatencyWriter.Write, n=%d, err=%v, latency=%d, flushPending=%v, dst type=%T&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">latency</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">flushPending</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">dst</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">m</span><span class="p">.</span><span class="nx">latency</span> <span class="p">&lt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">m</span><span class="p">.</span><span class="nx">dst</span><span class="p">.</span><span class="nf">Flush</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// …(略)…
</span></span></span></code></pre></div><p>以下のように2回呼ばれていました。n=20は16進数だと14、n=18は16進数だと12なので、上でtelnetでChunk #2とChunk #3がまとめられたときのチャンクのサイズと一致しています。</p>
<pre tabindex="0"><code>2021/06/26 11:25:47 httputil.maxLatencyWriter.Write, n=20, err=&lt;nil&gt;, latency=-1, flushPending=true, dst type=*http.response
</code></pre><pre tabindex="0"><code>2021/06/26 11:25:47 httputil.maxLatencyWriter.Write, n=18, err=&lt;nil&gt;, latency=-1, flushPending=true, dst type=*http.response
</code></pre><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/httputil/reverseproxy.go#L439-L470">ReverseProxy の copyBuffer メソッド</a> にもログを入れました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// copyBuffer returns any write errors or non-EOF read errors, and the amount
</span></span></span><span class="line"><span class="cl"><span class="c1">// of bytes written.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">ReverseProxy</span><span class="p">)</span> <span class="nf">copyBuffer</span><span class="p">(</span><span class="nx">dst</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">src</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="kt">int64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">buf</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">32</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">written</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">nr</span><span class="p">,</span> <span class="nx">rerr</span> <span class="o">:=</span> <span class="nx">src</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;ReverseProxy.copyBuffer, dst type=%T, src type=%T, nr=%d, nerr=%v&#34;</span><span class="p">,</span> <span class="nx">dst</span><span class="p">,</span> <span class="nx">src</span><span class="p">,</span> <span class="nx">nr</span><span class="p">,</span> <span class="nx">rerr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">rerr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">rerr</span> <span class="o">!=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="o">&amp;&amp;</span> <span class="nx">rerr</span> <span class="o">!=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Canceled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">p</span><span class="p">.</span><span class="nf">logf</span><span class="p">(</span><span class="s">&#34;httputil: ReverseProxy read error during body copy: %v&#34;</span><span class="p">,</span> <span class="nx">rerr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">nr</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">nw</span><span class="p">,</span> <span class="nx">werr</span> <span class="o">:=</span> <span class="nx">dst</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:</span><span class="nx">nr</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">nw</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">written</span> <span class="o">+=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">nw</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">werr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">written</span><span class="p">,</span> <span class="nx">werr</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">nr</span> <span class="o">!=</span> <span class="nx">nw</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">written</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrShortWrite</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">rerr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">rerr</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">rerr</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="nx">written</span><span class="p">,</span> <span class="nx">rerr</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>出力はこうなりました。</p>
<pre tabindex="0"><code>2021/06/26 11:35:16 ReverseProxy.copyBuffer, dst type=*httputil.maxLatencyWriter, src type=*http.bodyEOFSignal, nr=20, nerr=&lt;nil&gt;
</code></pre><pre tabindex="0"><code>2021/06/26 11:35:16 ReverseProxy.copyBuffer, dst type=*httputil.maxLatencyWriter, src type=*http.bodyEOFSignal, nr=18, nerr=EOF
</code></pre><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/transport.go#L2731-L2749">bodyEOFSignal 構造体の定義</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// bodyEOFSignal is used by the HTTP/1 transport when reading response
</span></span></span><span class="line"><span class="cl"><span class="c1">// bodies to make sure we see the end of a response body before
</span></span></span><span class="line"><span class="cl"><span class="c1">// proceeding and reading on the connection again.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// It wraps a ReadCloser but runs fn (if non-nil) at most
</span></span></span><span class="line"><span class="cl"><span class="c1">// once, right before its final (error-producing) Read or Close call
</span></span></span><span class="line"><span class="cl"><span class="c1">// returns. fn should return the new error to return from Read or Close.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// If earlyCloseFn is non-nil and Close is called before io.EOF is
</span></span></span><span class="line"><span class="cl"><span class="c1">// seen, earlyCloseFn is called instead of fn, and its return value is
</span></span></span><span class="line"><span class="cl"><span class="c1">// the return value from Close.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">bodyEOFSignal</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">body</span>         <span class="nx">io</span><span class="p">.</span><span class="nx">ReadCloser</span>
</span></span><span class="line"><span class="cl">	<span class="nx">mu</span>           <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>        <span class="c1">// guards following 4 fields
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">closed</span>       <span class="kt">bool</span>              <span class="c1">// whether Close has been called
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">rerr</span>         <span class="kt">error</span>             <span class="c1">// sticky Read error
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fn</span>           <span class="kd">func</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// err will be nil on Read io.EOF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">earlyCloseFn</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span>      <span class="c1">// optional alt Close func used if io.EOF not seen
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>ところで何回も telnet で試していたらリクエストを手入力するのが大変です。標準入力に流し込めないのかなと検索すると <a href="https://unix.stackexchange.com/a/160597/135274">StackOverflowの回答</a> で telnet では無理なので nc を使えと言われていました。以下のようにすると出来ました。</p>
<pre tabindex="0"><code>$ (echo GET / HTTP/1.1; echo Host: example.com; echo Connection: close; echo) | nc localhost 9900
HTTP/1.1 200 OK
Content-Type: text/plain
Date: Sat, 26 Jun 2021 04:21:31 GMT
Connection: close
Transfer-Encoding: chunked

14
Hello, &#34;/&#34;
Chunk #1

12
Chunk #2
Chunk #3

0
</code></pre><p>話を元に戻して bodyEOFSignal ですが <a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/transport.go#L2048-L2226">persistConn の readLoop メソッド</a> 内で resp.Body に設定されていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">		<span class="nx">waitForBodyRead</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">body</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">bodyEOFSignal</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">body</span><span class="p">:</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="nx">earlyCloseFn</span><span class="p">:</span> <span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">waitForBodyRead</span> <span class="o">&lt;-</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">				<span class="o">&lt;-</span><span class="nx">eofc</span> <span class="c1">// will be closed by deferred call at the end of the function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="cl">			<span class="nx">fn</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">isEOF</span> <span class="o">:=</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
</span></span><span class="line"><span class="cl">				<span class="nx">waitForBodyRead</span> <span class="o">&lt;-</span> <span class="nx">isEOF</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nx">isEOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="o">&lt;-</span><span class="nx">eofc</span> <span class="c1">// see comment above eofc declaration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="k">if</span> <span class="nx">cerr</span> <span class="o">:=</span> <span class="nx">pc</span><span class="p">.</span><span class="nf">canceled</span><span class="p">();</span> <span class="nx">cerr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">						<span class="k">return</span> <span class="nx">cerr</span>
</span></span><span class="line"><span class="cl">					<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">			<span class="p">},</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">body</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/transport.go#L2753-L2774">bodyEOFSignal の Read メソッド</a> を見てもチャンクをまとめてはいなさそうなので、この中で呼び出している <code>es.body.Read</code> のほうを見ることにします。またログを追加して es.body の型を調べます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">es</span> <span class="o">*</span><span class="nx">bodyEOFSignal</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">es</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">closed</span><span class="p">,</span> <span class="nx">rerr</span> <span class="o">:=</span> <span class="nx">es</span><span class="p">.</span><span class="nx">closed</span><span class="p">,</span> <span class="nx">es</span><span class="p">.</span><span class="nx">rerr</span>
</span></span><span class="line"><span class="cl">	<span class="nx">es</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">closed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">errReadOnClosedResBody</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">rerr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">rerr</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;bodyEOFSignal.Read, es.body type=%T&#34;</span><span class="p">,</span> <span class="nx">es</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">es</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">es</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">defer</span> <span class="nx">es</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">es</span><span class="p">.</span><span class="nx">rerr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">es</span><span class="p">.</span><span class="nx">rerr</span> <span class="p">=</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">err</span> <span class="p">=</span> <span class="nx">es</span><span class="p">.</span><span class="nf">condfn</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><pre tabindex="0"><code>2021/06/26 13:38:31 bodyEOFSignal.Read, es.body type=*http.body
</code></pre><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/transfer.go#L805-L820">http.body 構造体の定義</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// body turns a Reader into a ReadCloser.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Close ensures that the body has been fully read
</span></span></span><span class="line"><span class="cl"><span class="c1">// and then reads the trailer if necessary.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">body</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">src</span>          <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span>
</span></span><span class="line"><span class="cl">	<span class="nx">hdr</span>          <span class="kd">interface</span><span class="p">{}</span>   <span class="c1">// non-nil (Response or Request) value means read trailer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">r</span>            <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span> <span class="c1">// underlying wire-format reader for the trailer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">closing</span>      <span class="kt">bool</span>          <span class="c1">// is the connection to be closed after reading body?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">doEarlyClose</span> <span class="kt">bool</span>          <span class="c1">// whether Close should stop early
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">mu</span>         <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span> <span class="c1">// guards following, and calls to Read and Close
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">sawEOF</span>     <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">closed</span>     <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">	<span class="nx">earlyClose</span> <span class="kt">bool</span>   <span class="c1">// Close called and we didn&#39;t read to the end of src
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">onHitEOF</span>   <span class="kd">func</span><span class="p">()</span> <span class="c1">// if non-nil, func to call when EOF is Read
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/transfer.go#L828-L835">http.body の Read メソッド</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">body</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">b</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">b</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">closed</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ErrBodyReadAfterClose</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nf">readLocked</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/transfer.go#L837-L884">http.body の readLocked メソッド</a>。またログを入れます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Must hold b.mu.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">body</span><span class="p">)</span> <span class="nf">readLocked</span><span class="p">(</span><span class="nx">p</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;http.body.readLocked, src type=%T, sawEOF=%v&#34;</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">src</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">sawEOF</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">sawEOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">b</span><span class="p">.</span><span class="nx">sawEOF</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Chunked case. Read the trailer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">hdr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">e</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">readTrailer</span><span class="p">();</span> <span class="nx">e</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Something went wrong in the trailer, we must not allow any
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// further reads of any kind to succeed from body, nor any
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// subsequent requests on the server connection. See
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// golang.org/issue/12027
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">b</span><span class="p">.</span><span class="nx">sawEOF</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">				<span class="nx">b</span><span class="p">.</span><span class="nx">closed</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">b</span><span class="p">.</span><span class="nx">hdr</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// If the server declared the Content-Length, our body is a LimitedReader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="c1">// and we need to check whether this EOF arrived early.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="nx">lr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">src</span><span class="p">.(</span><span class="o">*</span><span class="nx">io</span><span class="p">.</span><span class="nx">LimitedReader</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">lr</span><span class="p">.</span><span class="nx">N</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrUnexpectedEOF</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// If we can return an EOF here along with the read data, do
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// so. This is optional per the io.Reader contract, but doing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// so helps the HTTP transport code recycle its connection
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// earlier (since it will see this EOF itself), even if the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// client doesn&#39;t do future reads or Close.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">lr</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">src</span><span class="p">.(</span><span class="o">*</span><span class="nx">io</span><span class="p">.</span><span class="nx">LimitedReader</span><span class="p">);</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">lr</span><span class="p">.</span><span class="nx">N</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
</span></span><span class="line"><span class="cl">			<span class="nx">b</span><span class="p">.</span><span class="nx">sawEOF</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">b</span><span class="p">.</span><span class="nx">sawEOF</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">onHitEOF</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">b</span><span class="p">.</span><span class="nf">onHitEOF</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>ログ出力。</p>
<pre tabindex="0"><code>2021/06/26 13:45:38 http.body.readLocked, src type=*internal.chunkedReader, sawEOF=false
</code></pre><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/transfer.go#L481-L597">net/http パッケージの readTransfer 関数</a> 内で tranferReader のインスタンス t を作っていて <code>t.Chunked</code> が true でボディーありの場合に <code>internal.NewChunkedReader</code> 関数で生成されて http.body 型の src フィールドに設定されています。</p>
<p>関数の前のコメントに msg は <code>*Request</code> か <code>*Response</code> とあるようにこの関数はHTTPリクエストとレスポンスで共通となっています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// msg is *Request or *Response.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">readTransfer</span><span class="p">(</span><span class="nx">msg</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">t</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">transferReader</span><span class="p">{</span><span class="nx">RequestMethod</span><span class="p">:</span> <span class="s">&#34;GET&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Unify input
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">isResponse</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">rr</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">Response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">Header</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">Header</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">StatusCode</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">ProtoMajor</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">ProtoMajor</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">ProtoMinor</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">ProtoMinor</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">Close</span> <span class="p">=</span> <span class="nf">shouldClose</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">ProtoMajor</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">ProtoMinor</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">isResponse</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">Request</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">t</span><span class="p">.</span><span class="nx">RequestMethod</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">Request</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">Header</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">Header</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">RequestMethod</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">Method</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">ProtoMajor</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">ProtoMajor</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">ProtoMinor</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">ProtoMinor</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Transfer semantics for Requests are exactly like those for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// Responses with status code 200, responding to a GET method
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">t</span><span class="p">.</span><span class="nx">StatusCode</span> <span class="p">=</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">Close</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">Close</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;unexpected type&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Default to HTTP/1.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">ProtoMajor</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">t</span><span class="p">.</span><span class="nx">ProtoMinor</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">ProtoMajor</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">ProtoMinor</span> <span class="p">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Transfer-Encoding: chunked, and overriding Content-Length.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nf">parseTransferEncoding</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// …(略)…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Prepare body reader. ContentLength &lt; 0 means chunked encoding
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// or close connection when finished, since multipart is not supported yet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Chunked</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nf">noResponseBodyExpected</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">RequestMethod</span><span class="p">)</span> <span class="o">||</span> <span class="p">!</span><span class="nf">bodyAllowedForStatus</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">StatusCode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">t</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">NoBody</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">t</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">body</span><span class="p">{</span><span class="nx">src</span><span class="p">:</span> <span class="nx">internal</span><span class="p">.</span><span class="nf">NewChunkedReader</span><span class="p">(</span><span class="nx">r</span><span class="p">),</span> <span class="nx">hdr</span><span class="p">:</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">r</span><span class="p">:</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">closing</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Close</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">realLength</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">NoBody</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="nx">realLength</span> <span class="p">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">t</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">body</span><span class="p">{</span><span class="nx">src</span><span class="p">:</span> <span class="nx">io</span><span class="p">.</span><span class="nf">LimitReader</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">realLength</span><span class="p">),</span> <span class="nx">closing</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Close</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// realLength &lt; 0, i.e. &#34;Content-Length&#34; not mentioned in header
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Close</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Close semantics (i.e. HTTP/1.0)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">t</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">body</span><span class="p">{</span><span class="nx">src</span><span class="p">:</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">closing</span><span class="p">:</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Close</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Persistent connection (i.e. HTTP/1.1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">t</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">NoBody</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Unify output
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">switch</span> <span class="nx">rr</span> <span class="o">:=</span> <span class="nx">msg</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">Request</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rr</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Body</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rr</span><span class="p">.</span><span class="nx">ContentLength</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">ContentLength</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Chunked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rr</span><span class="p">.</span><span class="nx">TransferEncoding</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;chunked&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rr</span><span class="p">.</span><span class="nx">Close</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Close</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rr</span><span class="p">.</span><span class="nx">Trailer</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Trailer</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">Response</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rr</span><span class="p">.</span><span class="nx">Body</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Body</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rr</span><span class="p">.</span><span class="nx">ContentLength</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">ContentLength</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Chunked</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rr</span><span class="p">.</span><span class="nx">TransferEncoding</span> <span class="p">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;chunked&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rr</span><span class="p">.</span><span class="nx">Close</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Close</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rr</span><span class="p">.</span><span class="nx">Trailer</span> <span class="p">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Trailer</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>t.Chunked</code> は <a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/transfer.go#L621-L660">transferReader の parseTransferEncoding メソッド</a> 内でプロトコルが HTTP/1.1 以上かつ <code>Transfer-Encoding</code> ヘッダーが chunked のときに true に設定されています。またその際は <code>Content-Length</code> ヘッダーは消されています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// parseTransferEncoding sets t.Chunked based on the Transfer-Encoding header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">transferReader</span><span class="p">)</span> <span class="nf">parseTransferEncoding</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">raw</span><span class="p">,</span> <span class="nx">present</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">Header</span><span class="p">[</span><span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">present</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nb">delete</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span> <span class="s">&#34;Transfer-Encoding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Issue 12785; ignore Transfer-Encoding on HTTP/1.0 requests.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">t</span><span class="p">.</span><span class="nf">protoAtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Like nginx, we only support a single Transfer-Encoding header field, and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// only if set to &#34;chunked&#34;. This is one of the most security sensitive
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// surfaces in HTTP/1.1 due to the risk of request smuggling, so we keep it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// strict and simple.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">unsupportedTEError</span><span class="p">{</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;too many transfer encodings: %q&#34;</span><span class="p">,</span> <span class="nx">raw</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">ToLower</span><span class="p">(</span><span class="nx">textproto</span><span class="p">.</span><span class="nf">TrimString</span><span class="p">(</span><span class="nx">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">!=</span> <span class="s">&#34;chunked&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="o">&amp;</span><span class="nx">unsupportedTEError</span><span class="p">{</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;unsupported transfer encoding: %q&#34;</span><span class="p">,</span> <span class="nx">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">])}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// RFC 7230 3.3.2 says &#34;A sender MUST NOT send a Content-Length header field
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// in any message that contains a Transfer-Encoding header field.&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// but also: &#34;If a message is received with both a Transfer-Encoding and a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Content-Length header field, the Transfer-Encoding overrides the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Content-Length. Such a message might indicate an attempt to perform
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// request smuggling (Section 9.5) or response splitting (Section 9.4) and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ought to be handled as an error. A sender MUST remove the received
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Content-Length field prior to forwarding such a message downstream.&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// Reportedly, these appear in the wild.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nb">delete</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">Header</span><span class="p">,</span> <span class="s">&#34;Content-Length&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">t</span><span class="p">.</span><span class="nx">Chunked</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/internal/chunked.go#L37-L43">net/http/internal.chunkedReader 構造体の定義</a>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">chunkedReader</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span>        <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span>        <span class="kt">uint64</span> <span class="c1">// unread bytes in chunk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">err</span>      <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nx">buf</span>      <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="nx">checkEnd</span> <span class="kt">bool</span> <span class="c1">// whether need to check for \r\n chunk footer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/internal/chunked.go#L70-L115">net/http/internal.chunkedReader の Read メソッド</a> の最後に以下のようにログ出力を入れました。今回はスタックトレースも出してみました。今は呼び出し順を追って書いてるから不要ですが、気になる箇所がどこから呼ばれているかわかってない段階ではスタックトレースを出して調べるのは便利です（実は最初の方で気になるところにスタックトレース出力を入れてたのですが説明上は不要なので省略してました。使い方のメモということでここに入れておきます）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cr</span> <span class="o">*</span><span class="nx">chunkedReader</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">uint8</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">checkEnd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nf">Buffered</span><span class="p">()</span> <span class="p">&lt;</span> <span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// We have some data. Return early (per the io.Reader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// contract) instead of potentially blocking while
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// reading more.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadFull</span><span class="p">(</span><span class="nx">cr</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">buf</span><span class="p">[:</span><span class="mi">2</span><span class="p">]);</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nb">string</span><span class="p">(</span><span class="nx">cr</span><span class="p">.</span><span class="nx">buf</span><span class="p">[:])</span> <span class="o">!=</span> <span class="s">&#34;\r\n&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;malformed chunked encoding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">break</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cr</span><span class="p">.</span><span class="nx">checkEnd</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">cr</span><span class="p">.</span><span class="nf">chunkHeaderAvailable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// We&#39;ve read enough. Don&#39;t potentially block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// reading a new chunk header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cr</span><span class="p">.</span><span class="nf">beginChunk</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rbuf</span> <span class="o">:=</span> <span class="nx">b</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">rbuf</span><span class="p">))</span> <span class="p">&gt;</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rbuf</span> <span class="p">=</span> <span class="nx">rbuf</span><span class="p">[:</span><span class="nx">cr</span><span class="p">.</span><span class="nx">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">n0</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n0</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">rbuf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span> <span class="o">+=</span> <span class="nx">n0</span>
</span></span><span class="line"><span class="cl">		<span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">n0</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cr</span><span class="p">.</span><span class="nx">n</span> <span class="o">-=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">n0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If we&#39;re at the end of a chunk, read the next two
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// bytes to verify they are &#34;\r\n&#34;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cr</span><span class="p">.</span><span class="nx">checkEnd</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">buf</span> <span class="p">[</span><span class="mi">4096</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n2</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">Stack</span><span class="p">(</span><span class="nx">buf</span><span class="p">[:],</span> <span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read, n=%d, err=%v, stack=%s&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span><span class="p">,</span> <span class="nx">buf</span><span class="p">[:</span><span class="nx">n2</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><pre tabindex="0"><code>2021/06/26 16:05:31 chunkedReader.Read, n=20, err=&lt;nil&gt;, stack=goroutine 6 [running]:
net/http/internal.(*chunkedReader).Read(0xc000286060, 0xc0002a6014, 0x7fec, 0x7fec, 0x2, 0x6e2060, 0xc000298000)
        /usr/local/go/src/net/http/internal/chunked.go:118 +0x1b6
net/http.(*body).readLocked(0xc00028e000, 0xc0002a6000, 0x8000, 0x8000, 0xc00008c050, 0x2, 0xc00029a060)
        /usr/local/go/src/net/http/transfer.go:844 +0xf2
net/http.(*body).Read(0xc00028e000, 0xc0002a6000, 0x8000, 0x8000, 0x0, 0x0, 0x0)
        /usr/local/go/src/net/http/transfer.go:835 +0xf9
net/http.(*bodyEOFSignal).Read(0xc00028e040, 0xc0002a6000, 0x8000, 0x8000, 0x0, 0x0, 0x0)
        /usr/local/go/src/net/http/transport.go:2765 +0x13d
net/http/httputil.(*ReverseProxy).copyBuffer(0xc00008c140, 0x7491a0, 0xc0002860c0, 0x748f80, 0xc00028e040, 0xc0002a6000, 0x8000, 0x8000, 0x1, 0x0, ...)
        /usr/local/go/src/net/http/httputil/reverseproxy.go:450 +0xbe
net/http/httputil.(*ReverseProxy).copyResponse(0xc00008c140, 0x749140, 0xc0000e40e0, 0x748f80, 0xc00028e040, 0xffffffffffffffff, 0x0, 0x0)
        /usr/local/go/src/net/http/httputil/reverseproxy.go:438 +0x190
net/http/httputil.(*ReverseProxy).ServeHTTP(0xc00008c140, 0x74d280, 0xc0000e40e0, 0xc0000fe000)
        /usr/local/go/src/net/http/httputil/reverseproxy.go:325 +0x8a5
net/http.(*ServeMux).ServeHTTP(0x8c3660, 0x74d280, 0xc0000e40e0, 0xc0000fe000)
        /usr/local/go/src/net/http/server.go:2462 +0x1ad
net/http.serverHandler.ServeHTTP(0xc0000e4000, 0x74d280, 0xc0000e40e0, 0xc0000fe000)
        /usr/local/go/src/net/http/server.go:2901 +0xa3
net/http.(*conn).serve(0xc0000a8a00, 0x74d700, 0xc0000802c0)
        /usr/local/go/src/net/http/server.go:1966 +0x8cd
created by net/http.(*Server).Serve
        /usr/local/go/src/net/http/server.go:3027 +0x39b
</code></pre><pre tabindex="0"><code>2021/06/26 16:05:31 chunkedReader.Read, n=18, err=EOF, stack=goroutine 6 [running]:
net/http/internal.(*chunkedReader).Read(0xc000286060, 0xc0002a6012, 0x7fee, 0x7fee, 0x2, 0x6e2060, 0xc000122000)
        /usr/local/go/src/net/http/internal/chunked.go:118 +0x1b6
net/http.(*body).readLocked(0xc00028e000, 0xc0002a6000, 0x8000, 0x8000, 0xc00008c050, 0x2, 0xc000148000)
        /usr/local/go/src/net/http/transfer.go:844 +0xf2
net/http.(*body).Read(0xc00028e000, 0xc0002a6000, 0x8000, 0x8000, 0x0, 0x0, 0x0)
        /usr/local/go/src/net/http/transfer.go:835 +0xf9
net/http.(*bodyEOFSignal).Read(0xc00028e040, 0xc0002a6000, 0x8000, 0x8000, 0x0, 0x0, 0x0)
        /usr/local/go/src/net/http/transport.go:2765 +0x13d
net/http/httputil.(*ReverseProxy).copyBuffer(0xc00008c140, 0x7491a0, 0xc0002860c0, 0x748f80, 0xc00028e040, 0xc0002a6000, 0x8000, 0x8000, 0x1, 0x0, ...)
        /usr/local/go/src/net/http/httputil/reverseproxy.go:450 +0xbe
net/http/httputil.(*ReverseProxy).copyResponse(0xc00008c140, 0x749140, 0xc0000e40e0, 0x748f80, 0xc00028e040, 0xffffffffffffffff, 0x0, 0x0)
        /usr/local/go/src/net/http/httputil/reverseproxy.go:438 +0x190
net/http/httputil.(*ReverseProxy).ServeHTTP(0xc00008c140, 0x74d280, 0xc0000e40e0, 0xc0000fe000)
        /usr/local/go/src/net/http/httputil/reverseproxy.go:325 +0x8a5
net/http.(*ServeMux).ServeHTTP(0x8c3660, 0x74d280, 0xc0000e40e0, 0xc0000fe000)
        /usr/local/go/src/net/http/server.go:2462 +0x1ad
net/http.serverHandler.ServeHTTP(0xc0000e4000, 0x74d280, 0xc0000e40e0, 0xc0000fe000)
        /usr/local/go/src/net/http/server.go:2901 +0xa3
net/http.(*conn).serve(0xc0000a8a00, 0x74d700, 0xc0000802c0)
        /usr/local/go/src/net/http/server.go:1966 +0x8cd
created by net/http.(*Server).Serve
        /usr/local/go/src/net/http/server.go:3027 +0x39b
</code></pre><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/internal/chunked.go#L45-L59">net/http/internal.chunkedReader の beginChunk メソッド</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cr</span> <span class="o">*</span><span class="nx">chunkedReader</span><span class="p">)</span> <span class="nf">beginChunk</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// chunk-size CRLF
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">line</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="nx">line</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nf">readChunkLine</span><span class="p">(</span><span class="nx">cr</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">cr</span><span class="p">.</span><span class="nx">n</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nf">parseHexUint</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/internal/chunked.go#L117-L142">net/http/internal.chunkedReader の readChunkLine メソッド</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Read a line of bytes (up to \n) from b.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Give up if the line exceeds maxLineLength.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The returned bytes are owned by the bufio.Reader
</span></span></span><span class="line"><span class="cl"><span class="c1">// so they are only valid until the next bufio read.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">readChunkLine</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">ReadSlice</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// We always know when EOF is coming.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// If the caller asked for a line, there should be a line.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">ErrUnexpectedEOF</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">ErrBufferFull</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">err</span> <span class="p">=</span> <span class="nx">ErrLineTooLong</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nx">maxLineLength</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrLineTooLong</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span> <span class="p">=</span> <span class="nf">trimTrailingWhitespace</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">removeChunkExtension</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">p</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/internal/chunked.go#L61-L68">net/http/internal.chunkedReader の chunkHeaderAvailable メソッド</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cr</span> <span class="o">*</span><span class="nx">chunkedReader</span><span class="p">)</span> <span class="nf">chunkHeaderAvailable</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">n</span> <span class="o">:=</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nf">Buffered</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">peek</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nf">Peek</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">IndexByte</span><span class="p">(</span><span class="nx">peek</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="https://golang.org/pkg/bufio/#Reader">bufio.Reader 構造体</a> の <a href="https://golang.org/pkg/bufio/#Reader.Buffered">Buffered メソッド</a> でバッファ内の残りバイト数を調べて 0 より大きい場合は <a href="https://golang.org/pkg/bufio/#Reader.Peek">Peek メソッド</a> で <code>'\n'</code> が含まれるかを調べています。</p>
<p><a href="https://github.com/golang/go/blob/go1.16.5/src/net/http/internal/chunked.go#L70-L115">net/http/internal.chunkedReader の Read メソッド</a> にデバッグログ出力を大量に入れて再度試しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">cr</span> <span class="o">*</span><span class="nx">chunkedReader</span><span class="p">)</span> <span class="nf">Read</span><span class="p">(</span><span class="nx">b</span> <span class="p">[]</span><span class="kt">uint8</span><span class="p">)</span> <span class="p">(</span><span class="nx">n</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read start, len(b)=%d&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read, came into for loop, cr.checkEnd=%v&#34;</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">checkEnd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">checkEnd</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read checkEnd, n=%d, cr.r.Buffered()=%d&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nf">Buffered</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nf">Buffered</span><span class="p">()</span> <span class="p">&lt;</span> <span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// We have some data. Return early (per the io.Reader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// contract) instead of potentially blocking while
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// reading more.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read break since n &gt; 0 &amp;&amp; cr.r.Buffered() &lt; 2&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadFull</span><span class="p">(</span><span class="nx">cr</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">buf</span><span class="p">[:</span><span class="mi">2</span><span class="p">]);</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="nb">string</span><span class="p">(</span><span class="nx">cr</span><span class="p">.</span><span class="nx">buf</span><span class="p">[:])</span> <span class="o">!=</span> <span class="s">&#34;\r\n&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;malformed chunked encoding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="k">break</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cr</span><span class="p">.</span><span class="nx">checkEnd</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read, set cr.checkEnd to false&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read, before if cr.n == 0, cr.n=%d&#34;</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">cr</span><span class="p">.</span><span class="nf">chunkHeaderAvailable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// We&#39;ve read enough. Don&#39;t potentially block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">// reading a new chunk header.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read break n &gt; 0 &amp;&amp; !cr.chunkHeaderAvailable()&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cr</span><span class="p">.</span><span class="nf">beginChunk</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read, before if len(b) == 0, len(b)=%d&#34;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read break len(b) == 0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rbuf</span> <span class="o">:=</span> <span class="nx">b</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read, before if uint64(len(rbuf)) &gt; cr.n, uint64(len(rbuf))=%d, cr.n=%d&#34;</span><span class="p">,</span> <span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">rbuf</span><span class="p">)),</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">rbuf</span><span class="p">))</span> <span class="p">&gt;</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">n</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">rbuf</span> <span class="p">=</span> <span class="nx">rbuf</span><span class="p">[:</span><span class="nx">cr</span><span class="p">.</span><span class="nx">n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="kd">var</span> <span class="nx">n0</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n0</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="p">=</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="nx">rbuf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">n</span> <span class="o">+=</span> <span class="nx">n0</span>
</span></span><span class="line"><span class="cl">		<span class="nx">b</span> <span class="p">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">n0</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">		<span class="nx">cr</span><span class="p">.</span><span class="nx">n</span> <span class="o">-=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">n0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read, before if cr.n == 0 &amp;&amp; cr.err == nil, n0=%d, len(b)=%d, cr.n=%d, cr.err=%v&#34;</span><span class="p">,</span> <span class="nx">n0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">n</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If we&#39;re at the end of a chunk, read the next two
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// bytes to verify they are &#34;\r\n&#34;.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">cr</span><span class="p">.</span><span class="nx">checkEnd</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">			<span class="nx">log</span><span class="p">.</span><span class="nf">Print</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read, set cr.checkEnd to true&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;chunkedReader.Read exiting, n=%d, err=%v&#34;</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">cr</span><span class="p">.</span><span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><pre tabindex="0"><code>2021/06/26 16:38:37 chunkedReader.Read start, len(b)=32768
2021/06/26 16:38:37 chunkedReader.Read, came into for loop, cr.checkEnd=false
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0, cr.n=0
2021/06/26 16:38:37 chunkedReader.Read, came into for loop, cr.checkEnd=false
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0, cr.n=20
2021/06/26 16:38:37 chunkedReader.Read, before if len(b) == 0, len(b)=32768
2021/06/26 16:38:37 chunkedReader.Read, before if uint64(len(rbuf)) &gt; cr.n, uint64(len(rbuf))=32768, cr.n=20
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0 &amp;&amp; cr.err == nil, n0=20, len(b)=32748, cr.n=0, cr.err=&lt;nil&gt;
2021/06/26 16:38:37 chunkedReader.Read, set cr.checkEnd to true
2021/06/26 16:38:37 chunkedReader.Read, came into for loop, cr.checkEnd=true
2021/06/26 16:38:37 chunkedReader.Read checkEnd, n=20, cr.r.Buffered()=2
2021/06/26 16:38:37 chunkedReader.Read, set cr.checkEnd to false
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0, cr.n=0
2021/06/26 16:38:37 chunkedReader.Read break n &gt; 0 &amp;&amp; !cr.chunkHeaderAvailable()
2021/06/26 16:38:37 chunkedReader.Read exiting, n=20, err=&lt;nil&gt;
</code></pre><pre tabindex="0"><code>2021/06/26 16:38:37 chunkedReader.Read start, len(b)=32768
2021/06/26 16:38:37 chunkedReader.Read, came into for loop, cr.checkEnd=false
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0, cr.n=0
2021/06/26 16:38:37 chunkedReader.Read, came into for loop, cr.checkEnd=false
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0, cr.n=9
2021/06/26 16:38:37 chunkedReader.Read, before if len(b) == 0, len(b)=32768
2021/06/26 16:38:37 chunkedReader.Read, before if uint64(len(rbuf)) &gt; cr.n, uint64(len(rbuf))=32768, cr.n=9
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0 &amp;&amp; cr.err == nil, n0=9, len(b)=32759, cr.n=0, cr.err=&lt;nil&gt;
2021/06/26 16:38:37 chunkedReader.Read, set cr.checkEnd to true
2021/06/26 16:38:37 chunkedReader.Read, came into for loop, cr.checkEnd=true
2021/06/26 16:38:37 chunkedReader.Read checkEnd, n=9, cr.r.Buffered()=21
2021/06/26 16:38:37 chunkedReader.Read, set cr.checkEnd to false
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0, cr.n=0
2021/06/26 16:38:37 chunkedReader.Read, came into for loop, cr.checkEnd=false
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0, cr.n=9
2021/06/26 16:38:37 chunkedReader.Read, before if len(b) == 0, len(b)=32759
2021/06/26 16:38:37 chunkedReader.Read, before if uint64(len(rbuf)) &gt; cr.n, uint64(len(rbuf))=32759, cr.n=9
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0 &amp;&amp; cr.err == nil, n0=9, len(b)=32750, cr.n=0, cr.err=&lt;nil&gt;
2021/06/26 16:38:37 chunkedReader.Read, set cr.checkEnd to true
2021/06/26 16:38:37 chunkedReader.Read, came into for loop, cr.checkEnd=true
2021/06/26 16:38:37 chunkedReader.Read checkEnd, n=18, cr.r.Buffered()=7
2021/06/26 16:38:37 chunkedReader.Read, set cr.checkEnd to false
2021/06/26 16:38:37 chunkedReader.Read, before if cr.n == 0, cr.n=0
2021/06/26 16:38:37 chunkedReader.Read exiting, n=18, err=EOF
</code></pre><p>ということで</p>
<ul>
<li>1つもチャンクを読んでない場合はループしてチャンクが来るのを待つ。</li>
<li>1つチャンクを読んだ後は次のチャンクのヘッダがバッファ内にあれば読む。なければ抜ける。</li>
<li>バッファがフルになるか、チャンクを読んだ後次のチャンクのヘッダがバッファ内にないか、 EOF が来たら抜ける。</li>
</ul>
<p>という感じになっていることがわかりました。</p>
<p>まとめとしては Go の net/http では Request, Response ともボディが chunked な場合は内部で net/http/internal の chunkedReader が使われて Read すると chunked をデコードしたデータが返ってくるが、その際に受信していた複数のチャンクがまとめられるということです。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
