<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.140.1">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Ubuntuで長期サポートのLinuxカーネルを使用する &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2025. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Ubuntuで長期サポートのLinuxカーネルを使用する</h1>
  <time datetime=2021-06-28T05:12:14&#43;0900 class="post-date">2021-06-28</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#ubuntu-での長期サポート版-linux-カーネルパッケージ">Ubuntu での長期サポート版 Linux カーネルパッケージ</a></li>
    <li><a href="#カーネルのバージョンを下げてブートする場合の手順">カーネルのバージョンを下げてブートする場合の手順</a></li>
    <li><a href="#再起動後不要なカーネルパッケージを削除してgrubの設定を戻す">再起動後不要なカーネルパッケージを削除してGRUBの設定を戻す</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="https://www.kernel.org/category/releases.html">The Linux Kernel Archives - Releases</a> と <a href="https://en.wikipedia.org/wiki/Linux_kernel_version_history">Linux kernel version history - Wikipedia</a> を見て Linux カーネルは長期サポート版とそうでない版があることを知りました。なるべくなら長期サポート版を使うほうが安心だなと思ったので切り替えることにしました。その際のメモです。</p>
<p>ちなみに「長期サポート」は <a href="https://www.kernel.org/category/releases.html">The Linux Kernel Archives - Releases</a> では &ldquo;longterm maintenance&rdquo; kernel release とか longterm release kernel と書かれていました。
<a href="https://en.wikipedia.org/wiki/Linux_kernel_version_history">Linux kernel version history - Wikipedia</a> のほうでは Long-Term Support (LTS) と書かれていました。</p>
<h2 id="ubuntu-での長期サポート版-linux-カーネルパッケージ">Ubuntu での長期サポート版 Linux カーネルパッケージ</h2>
<ul>
<li>Ubuntu 18.04 LTS では linux-image-generic-hwe-18.04 が 5.4.x</li>
<li>Ubuntu 20.04 LTS では linux-image-oem-20.04b が 5.10.x</li>
</ul>
<p><code>sudo apt install linux-image-oem-20.04b</code> のようにインストールすればOKです。</p>
<h2 id="カーネルのバージョンを下げてブートする場合の手順">カーネルのバージョンを下げてブートする場合の手順</h2>
<p>長期サポートの Linux カーネルのことを知る前に Ubuntu 20.04 LTS で linux-image-generic-hwe-20.04-edge で 5.11.x をインストールしていたのですが、その後 linux-image-oem-20.04b で 5.10.x を入れました。</p>
<p>このようにバージョンを下げる場合は <a href="https://gihyo.jp/admin/serial/01/ubuntu-recipe/0639">第639回　Ubuntuに「トラブル時に」ログインするいろいろな方法：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社</a> の手順で起動時に GRUB メニューを表示して切り替えればよいのですが、わりと面倒なので
<a href="https://meetrix.io/blog/aws/changing-default-ubuntu-kernel.html">How to Change the Default Ubuntu Kernel - Meetrix.IO</a> の手順で一時的にデフォルトのカーネルを切り替えるようにしました。</p>
<p>この手順をメモしておきます。</p>
<p>GRUB のメニューに登録されているカーネル一覧を以下のコマンドで確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">grep -A100 submenu /boot/grub/grub.cfg <span class="p">|</span> grep menuentry
</span></span></code></pre></div><p>実行結果の例です。</p>
<pre tabindex="0"><code>$ grep -A100 submenu /boot/grub/grub.cfg | grep menuentry
submenu &#39;Advanced options for Ubuntu&#39; $menuentry_id_option &#39;gnulinux-advanced-0e6937b5-14c5-496d-ba95-42efe61cd35e&#39; {
        menuentry &#39;Ubuntu, with Linux 5.11.0-22-generic&#39; --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option &#39;gnulinux-5.11.0-22-generic-advanced-0e6937b5-14c5-496d-ba95-42efe61cd35e&#39; {
        menuentry &#39;Ubuntu, with Linux 5.11.0-22-generic (recovery mode)&#39; --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option &#39;gnulinux-5.11.0-22-generic-recovery-0e6937b5-14c5-496d-ba95-42efe61cd35e&#39; {
        menuentry &#39;Ubuntu, with Linux 5.10.0-1034-oem&#39; --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option &#39;gnulinux-5.10.0-1034-oem-advanced-0e6937b5-14c5-496d-ba95-42efe61cd35e&#39; {
        menuentry &#39;Ubuntu, with Linux 5.10.0-1034-oem (recovery mode)&#39; --class ubuntu --class gnu-linux --class gnu --class os $menuentry_id_option &#39;gnulinux-5.10.0-1034-oem-recovery-0e6937b5-14c5-496d-ba95-42efe61cd35e&#39; {
menuentry &#39;UEFI Firmware Settings&#39; $menuentry_id_option &#39;uefi-firmware&#39; {
</code></pre><p>ブートしたいカーネルの submenu と menuentry の ID をメモします。</p>
<p>上記の例だと <code>submenu 'Advanced options for Ubuntu'</code> の ID は gnulinux-advanced-0e6937b5-14c5-496d-ba95-42efe61cd35e です。
<code>menuentry 'Ubuntu, with Linux 5.10.0-1034-oem'</code> の ID は gnulinux-5.10.0-1034-oem-advanced-0e6937b5-14c5-496d-ba95-42efe61cd35e です。
これを <code>&gt;</code> で連結した文字列を <code>/etc/default/grub</code> の <code>GRUB_DEFAULT</code> に指定すればOKです。</p>
<p>GRUB 設定を編集します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo vim /etc/default/grub
</span></span></code></pre></div><p>編集前は以下のような内容になっていました。</p>
<pre tabindex="0"><code># If you change this file, run &#39;update-grub&#39; afterwards to update
# /boot/grub/grub.cfg.
# For full documentation of the options in this file, see:
#   info -f grub -n &#39;Simple configuration&#39;

GRUB_DEFAULT=0
GRUB_TIMEOUT_STYLE=hidden
GRUB_TIMEOUT=0
GRUB_DISTRIBUTOR=`lsb_release -i -s 2&gt; /dev/null || echo Debian`
GRUB_CMDLINE_LINUX_DEFAULT=&#34;quiet splash&#34;
GRUB_CMDLINE_LINUX=&#34;&#34;
…(略)…
</code></pre><p>上記の例の場合は <code>GRUB_DEFAULT</code> の設定を以下のように変更します。</p>
<pre tabindex="0"><code>GRUB_DEFAULT=&#34;gnulinux-advanced-0e6937b5-14c5-496d-ba95-42efe61cd35e&gt;gnulinux-5.10.0-1034-oem-advanced-0e6937b5-14c5-496d-ba95-42efe61cd35e&#34;
</code></pre><p>あとは <code>update-grub</code> で変更を反映して再起動します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo update-grub
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo reboot
</span></span></code></pre></div><h2 id="再起動後不要なカーネルパッケージを削除してgrubの設定を戻す">再起動後不要なカーネルパッケージを削除してGRUBの設定を戻す</h2>
<p>無事アップデートできたら不要なカーネルパッケージを削除します。</p>
<p>まず念のため今ブートしたカーネルのバージョンを確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">uname -r
</span></span></code></pre></div><p>実行例です。</p>
<pre tabindex="0"><code>$ uname -r
5.10.0-1034-oem
</code></pre><p>次に削除対象のパッケージ一覧を確認します。grepのパターンは適宜調整してください。</p>
<pre tabindex="0"><code>dpkg -l | grep linux.*5\.11
</code></pre><p>実行例です。</p>
<pre tabindex="0"><code>$ dpkg -l | grep linux.*5\.11
ii  linux-image-5.11.0-22-generic                 5.11.0-22.23~20.04.1                                             amd64        Signed kernel image generic
ii  linux-image-generic-hwe-20.04-edge            5.11.0.22.23~20.04.6                                             amd64        Generic Linux kernel image
ii  linux-modules-5.11.0-22-generic               5.11.0-22.23~20.04.1                                             amd64        Linux kernel extra modules for version 5.11.0 on 64 bit x86 SMP
ii  linux-modules-extra-5.11.0-22-generic         5.11.0-22.23~20.04.1                                             amd64        Linux kernel extra modules for version 5.11.0 on 64 bit x86 SMP
</code></pre><p>ちなみに <code>dpkg -l</code> の出力結果のヘッダー行は以下のようになっています。
行頭の ii は Desired が Install で Status が Inst になっていることを表しています。</p>
<pre tabindex="0"><code>$ dpkg -l | head -5
Desired=Unknown/Install/Remove/Purge/Hold
| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
||/ Name                                          Version                                                          Architecture Description
+++-=============================================-================================================================-============-===============================================================================
</code></pre><p>希望の一覧になっていることを確認したら以下のコマンドでパッケージを削除します。</p>
<pre tabindex="0"><code>dpkg -l | grep linux.*5\.11 | awk &#39;{print $2}&#39; | xargs sudo apt remove -y
</code></pre><p>削除後一部のパッケージが設定ファイルだけ残った状態になるので以下のコマンドで確認します。</p>
<pre tabindex="0"><code>dpkg -l | grep ^.c
</code></pre><p>実行例です。先頭の rc は Desired が Removed で Status が Conf-files を表しています。</p>
<pre tabindex="0"><code>$ dpkg -l | grep ^.c
rc  linux-image-5.11.0-22-generic                 5.11.0-22.23~20.04.1                                             amd64        Signed kernel image generic
rc  linux-modules-5.11.0-22-generic               5.11.0-22.23~20.04.1                                             amd64        Linux kernel extra modules for version 5.11.0 on 64 bit x86 SMP
rc  linux-modules-extra-5.11.0-22-generic         5.11.0-22.23~20.04.1                                             amd64        Linux kernel extra modules for version 5.11.0 on 64 bit x86 SMP
</code></pre><p>対象を確認したら以下のコマンドでパージします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">dpkg -l <span class="p">|</span> grep ^.c <span class="p">|</span> awk <span class="s1">&#39;{print $2}&#39;</span> <span class="p">|</span> xargs sudo apt purge -y
</span></span></code></pre></div><p>あとは GRUB の設定を元に戻します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo vim /etc/default/grub
</span></span></code></pre></div><p>で</p>
<pre tabindex="0"><code>GRUB_DEFAULT=0
</code></pre><p>に戻して</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo update-grub
</span></span></code></pre></div><p>を実行して反映します。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>
  </body>
</html>
