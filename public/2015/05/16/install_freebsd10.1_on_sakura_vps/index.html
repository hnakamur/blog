<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>さくらのVPSにFreeBSD 10.1をクリーンインストールした時のメモ</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2015/05/16/install_freebsd10.1_on_sakura_vps/" rel="bookmark"
           title="Permalink to さくらのVPSにFreeBSD 10.1をクリーンインストールした時のメモ">さくらのVPSにFreeBSD 10.1をクリーンインストールした時のメモ</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-05-16T11:39:00+09:00">
                Published: 2015-05-16
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/sakura-vps.html">sakura-vps</a> <a href="../../../../tag/freebsd.html">freebsd</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p>さくらのVPSにFreeBSD 10.1をクリーンインストールしてみましたので、手順をメモしておきます。作業した環境は MacBook Pro (USキーボード) です。
インストール後以下の設定を行います。</p>
<ul>
<li>ファイルシステムはZFSを選択</li>
<li>sshの鍵認証の設定</li>
<li>sudoのインストールと設定</li>
</ul>
<p>なお、インストールには下記のページを参考にしました。ありがとうございます！</p>
<ul>
<li><a href="http://blog.emaita.jp/2015/03/06/freebsd10_1.html">FreeBSD 10.1 導入 — emaita 備忘録</a></li>
<li><a href="http://blog.livedoor.jp/saba_nano/archives/28363307.html">[FreeBSD] さくらのVPSに FreeBSD 9.1 amd64 をインストールする方法 (1) : saba nano - へっぽこ管理者のサーバ管理日誌（LV.2）</a></li>
</ul>
<h2>インストール準備</h2>
<h3>ISOイメージをミラーから取得してVPSにsftpでアップロード</h3>
<p><a href="http://www.jp.freebsd.org/mirror.html">FreeBSD-related Sites in Japan</a>を見てftp3.jp.FreeBSD.org (ftp.sakura.ad.jp)からダウンロードすることにしました。</p>
<p>ブラウザで
ftp://ftp3.jp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.1/
を開き
ftp://ftp3.jp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.1/FreeBSD-10.1-RELEASE-amd64-bootonly.iso
をダウンロードします。</p>
<p>これを<a href="https://help.sakura.ad.jp/app/answers/detail/a_id/2405">ISOイメージインストール｜さくらインターネット公式サポートサイト</a>の手順を参考にアップロードします。</p>
<p>OS Xにはsftpコマンドが標準で入っているのでそれを使います。接続情報は、さくらのVPSのコントロールパネルで確認します。
ここでは、ユーザ名をvpsXXXXXXXXXXXX, ホスト名をvps-isoY.sakura.ad.jpとして説明します。</p>
<p>isoファイルのあるディレクトリでsftpを実行し、以下の手順で上記のisoファイルをアップロードします。</p>
<div class="highlight"><pre><span></span>$ sftp vpsXXXXXXXXXXXX@vps-isoY.sakura.ad.jp
vpsXXXXXXXXXXXX@vps-isoY.sakura.ad.jp<span class="err">&#39;</span>s password: <span class="o">(</span>パスワードを入力<span class="o">)</span>
sftp&gt; <span class="nb">cd</span> iso
sftp&gt; put FreeBSD-10.1-RELEASE-amd64-bootonly.iso
sftp&gt; quit
</pre></div>


<p>アップロードが完了したらsftpコマンドは終了します。さくらのVPSのコントロールパネルの「ISOイメージインストール」のポップアップの「ISOイメージ情報」に今アップロードしたisoファイルが表示されたことを確認し、「マウント設定」の「設定内容を確認する」ボタンを押し、「インストールを実行する」ボタンを押します。</p>
<h2>インストール</h2>
<p>「VNCコンソール(HTML5版)を起動」ボタンを押してコンソールで作業します。</p>
<h3>キーマップの確認</h3>
<p>HTML5版のVNCコンソールは、どうも日本語キーボードを想定しているようで、USキーボードだと以下のように一部の記号の配置が異なっています。
なお、キーマップはデフォルト(US配列)を選択しています。</p>
<p>押したキーを左、入力された文字を右に示します。</p>
<table border="1">
<tr><th style="padding:4px">押したキー</th><th style="padding:4px">入力された文字</th></tr>
<tr><td style="padding:4px">`</td><td style="padding:4px">[</td></tr>
<tr><td style="padding:4px">~ (Shift+`)</td><td style="padding:4px">+</td></tr>
<tr><td style="padding:4px">@ (Shift+2)</td><td style="padding:4px">{</td></tr>
<tr><td style="padding:4px">^ (Shift+6)</td><td style="padding:4px">+</td></tr>
<tr><td style="padding:4px">& (Shift+7)</td><td style="padding:4px">^</td></tr>
<tr><td style="padding:4px">* (Shift+8)</td><td style="padding:4px">"</td></tr>
<tr><td style="padding:4px">( (Shift+9)</td><td style="padding:4px">*</td></tr>
<tr><td style="padding:4px">) (Shift+0)</td><td style="padding:4px">(</td></tr>
<tr><td style="padding:4px">_ (Shift+-)</td><td style="padding:4px">何も入力されない</td></tr>
<tr><td style="padding:4px">=</td><td style="padding:4px">-</td></tr>
<tr><td style="padding:4px">+ (Shift+=)</td><td style="padding:4px">:</td></tr>
<tr><td style="padding:4px">[</td><td style="padding:4px">]</td></tr>
<tr><td style="padding:4px">{ (Shift+[)</td><td style="padding:4px">}</td></tr>
<tr><td style="padding:4px">]</td><td style="padding:4px">\</td></tr>
<tr><td style="padding:4px">} (Shift+})</td><td style="padding:4px">|</td></tr>
<tr><td style="padding:4px">\</td><td style="padding:4px">何も入力されない</td></tr>
<tr><td style="padding:4px">| (Shift+\)</td><td style="padding:4px">何も入力されない</td></tr>
<tr><td style="padding:4px">: (Shift+;)</td><td style="padding:4px">"</td></tr>
<tr><td style="padding:4px">'</td><td style="padding:4px">7</td></tr>
<tr><td style="padding:4px">" (Shift+')</td><td style="padding:4px">@</td></tr>
</table>

<h3>ホスト名設定</h3>
<p>"Please choose a hostname for this machine."の画面ではVPSのコンソールの標準ホスト名を入力します。</p>
<h3>インストールするコンポーネントの選択</h3>
<p>初期選択状態は以下のようになっていました。</p>
<ul>
<li>[ ] doc: Additional documentation</li>
<li>[*] games: Games (fortune, etc.)</li>
<li>[*] lib32: 32-bit compatiblity libraries</li>
<li>[*] ports: Ports tree</li>
<li>[ ] src: System source code</li>
</ul>
<p>gamesとlib32を外して、docとsrcを追加しました。</p>
<h3>ネットワーク設定</h3>
<ul>
<li>「Network Configuration」では「vtnet0」を選び「OK」を押します。</li>
<li>"Would you like to configure IPv4 for this interface" → [Yes]を押す</li>
<li>"Would you like to use DHCP to configure this interface?" → [No]を押す</li>
<li>「Static Netowrk Interface Configuration」の画面でIP Address, Subnet Mask, Default Routerを入力します。VPSのコントロールパネルのIPv4のアドレス、ネットマスク、ゲートウェイの値をそれぞれ入力します。</li>
<li>"Would you like to configure IPv6 for this interface?" → NoYes]を押す</li>
<li>「Resolver Configuration」の画面でSearch, IPv4 DNS #1, IPv4 DNS #2を入力します。順にVPSコントロールパネルの標準ホスト名のドメイン部分(私の場合はvs.sakura.ne.jp)、IPv4のプライマリDNS、セカンダリDNSを入力します。</li>
</ul>
<h4>(ボツ) IPv6を有効にすると失敗しました</h4>
<ul>
<li>"Would you like to configure IPv6 for this interface?" → [Yes]を押す</li>
<li>"Would you like to try stateless address autoconfiguration (SLAAC)?" → [No]を押す</li>
<li>「Static IPv6 Network Interface Configuration」の画面でIPv6 AddressとDefault RouterにVPSのコントロールパネルのIPv6のアドレスとゲートウェイを入力します。上記のキーマップの確認に書いたように:を入力するにはUSキーボードではShift+=を押してください。</li>
<li>「Resolver Configuration」の画面でSearch, IPv6 DNS #1, IPv6 DNS #2, IPv4 DNS #1, IPv4 DNS #2を入力します。順にVPSコントロールパネルの標準ホスト名のドメイン部分(私の場合はvs.sakura.ne.jp)、IPv6のDNS、空欄、IPv4のプライマリDNS、セカンダリDNSを入力します。</li>
</ul>
<p>ダウンロードは無事に進んだようなのですが、その後以下のエラーが出ました。</p>
<div class="highlight"><pre><span></span><span class="nv">Abort</span>
<span class="nv">Distribution</span> <span class="nv">extract</span> <span class="nv">failed</span>

<span class="nv">An</span> <span class="nv">installation</span> <span class="nv">step</span> <span class="nv">has</span> <span class="nv">been</span> <span class="nv">aborted</span>. <span class="nv">Would</span> <span class="nv">you</span>
<span class="nv">like</span> <span class="nv">to</span> <span class="nv">restart</span> <span class="nv">the</span> <span class="nv">installation</span> <span class="nv">or</span> <span class="k">exit</span>
<span class="nv">the</span> <span class="nv">installer</span>?
</pre></div>


<h3>ミラーサイト選択</h3>
<p>「Mirror Selection」の画面では「ftp://ftp3.jp.freebsd.org Japan #3」を選択します。</p>
<h3>パーティション作成</h3>
<ul>
<li>Auto (UFS): Guided Disk Setup</li>
<li>Manual: Manual Disk Setup (experts)</li>
<li>Shell: Open a shell and partition by hand</li>
<li>Auto (ZFS): Guided Root-on-ZFS</li>
</ul>
<p>今回は「Auto (ZFS)」にしました。
「ZFS Configuration」ではそのまま「&gt;&gt;&gt; Install     Proceed with Installation」を選びます。</p>
<h3>ZFSの仮想デバイスタイプ</h3>
<ul>
<li>stripe: Stripe - No Redundancy</li>
<li>mirror: Mirror - n-Way Mirroring</li>
<li>raidz1: RAID-Z1 - Single Redundant RAID</li>
<li>raidz2: RAID-Z2 - Single Redundant RAID</li>
<li>raidz3: RAID-Z3 - Single Redundant RAID</li>
</ul>
<p>「stripe」を選びました。</p>
<h3>ブロックデバイス選択</h3>
<p>「vtbd0 VirtIO Block Device」をスペースキーを押して選択します。</p>
<p>"Last Chance! Are you sure you want to destroy the current contents of the following disks: vtbd0" では[YES]を選びます。</p>
<h3>rootユーザのパスワード設定</h3>
<p>以下のようにrootユーザのパスワードを設定します。なぜかreturnキーが効かないようなのでCtrl-Jで代用しました。</p>
<div class="highlight"><pre><span></span><span class="nv">Please</span> <span class="nv">select</span> <span class="nv">a</span> <span class="nv">password</span> <span class="k">for</span> <span class="nv">the</span> <span class="nv">system</span> <span class="nv">management</span> <span class="nv">account</span> <span class="ss">(</span><span class="nv">root</span><span class="ss">)</span>:
<span class="nv">Changing</span> <span class="nv">local</span> <span class="nv">password</span> <span class="k">for</span> <span class="nv">root</span>
<span class="nv">New</span> <span class="nv">Password</span>: <span class="ss">(</span>パスワードを入力して<span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Retype</span> <span class="nv">New</span> <span class="nv">Password</span>: <span class="ss">(</span>パスワードを入力して<span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
</pre></div>


<p>表示も変で、Ctrl-Jを押した時に行が次の行に進みますが、行頭には戻らず続きのカラムから表示されていました。</p>
<h3>タイムゾーン設定</h3>
<p>"Is this machine's CMOS clock set to UTC?  If it is set to local time, or you don't know, please choose NO here!" ではハードウェアの設定はわからないので「No」を選びます。</p>
<p>「Select a region」では「5 Asia」を選び、「Select a country or region」では「18 Japan」を選びます。
"Does the abbreviation `JST' look reasonable?"に「Yes」を選びます。</p>
<h3>自動起動するサービス選択</h3>
<div class="highlight"><pre><span></span><span class="nv">Choose</span> <span class="nv">the</span> <span class="nv">services</span> <span class="nv">you</span> <span class="nv">would</span> <span class="nv">like</span> <span class="nv">to</span> <span class="nv">be</span> <span class="nv">started</span> <span class="nv">at</span> <span class="nv">boot</span>:
  [ ] <span class="nv">local_unbound</span>  <span class="nv">Local</span> <span class="nv">caching</span> <span class="nv">validating</span> <span class="nv">resolver</span>
  [<span class="o">*</span>] <span class="nv">sshd</span>           <span class="nv">Secure</span> <span class="nv">shell</span> <span class="nv">daemon</span>
  [ ] <span class="nv">moused</span>         <span class="nv">PS</span><span class="o">/</span><span class="mi">2</span> <span class="nv">mouse</span> <span class="nv">pointer</span> <span class="nv">on</span> <span class="nv">console</span>
  [ ] <span class="nv">ntpd</span>           <span class="nv">Synchronize</span> <span class="nv">system</span> <span class="nv">and</span> <span class="nv">network</span> <span class="nv">time</span>
  [ ] <span class="nv">powerd</span>         <span class="nv">Adjust</span> <span class="nv">CPU</span> <span class="nv">frequency</span> <span class="nv">dynamically</span> <span class="k">if</span> <span class="nv">supported</span>
  [<span class="o">*</span>] <span class="nv">dumpev</span>         <span class="nv">Enable</span> <span class="nv">kernel</span> <span class="nv">crash</span> <span class="nv">dumps</span> <span class="nv">to</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">crash</span>
</pre></div>


<p>ntpdを追加選択します。</p>
<h3>ユーザ追加</h3>
<p>sshでログインする管理用のユーザとして「admin」という名前のユーザを追加することにします。あとでsudoersに追加するのでadminユーザのセカンダリグループにwheelを追加します。</p>
<p>"Would you like to add users to the installed systems now?"に「Yes」を選びます。</p>
<div class="highlight"><pre><span></span><span class="nv">Add</span> <span class="nv">Users</span>
<span class="nv">Username</span>: <span class="nv">admin</span>
<span class="nv">Full</span> <span class="nv">name</span>: <span class="nv">admin</span>
<span class="nv">Uid</span> <span class="ss">(</span><span class="nv">Leave</span> <span class="nv">empty</span> <span class="k">for</span> <span class="nv">default</span><span class="ss">)</span>: <span class="ss">(</span><span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Login</span> <span class="nv">group</span> [<span class="nv">admin</span>]: <span class="ss">(</span><span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Login</span> <span class="nv">group</span> <span class="nv">is</span> <span class="nv">admin</span>. <span class="nv">Invite</span> <span class="nv">admin</span> <span class="nv">into</span> <span class="nv">other</span> <span class="nv">groups</span>? []: <span class="ss">(</span><span class="nv">wheel</span>と入力して<span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Login</span> <span class="nv">class</span> [<span class="nv">default</span>]: <span class="ss">(</span><span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Shell</span> <span class="ss">(</span><span class="nv">ch</span> <span class="nv">csh</span> <span class="nv">tcsh</span> <span class="nv">nologin</span><span class="ss">)</span> [<span class="nv">sh</span>]: <span class="ss">(</span><span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Home</span> <span class="nv">directory</span> [<span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">admin</span>]: <span class="ss">(</span><span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Home</span> <span class="nv">directory</span> <span class="nv">permissions</span> <span class="ss">(</span><span class="nv">Leave</span> <span class="nv">empty</span> <span class="k">for</span> <span class="nv">default</span><span class="ss">)</span>: <span class="ss">(</span><span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Use</span> <span class="nv">password</span><span class="o">-</span><span class="nv">based</span> <span class="nv">authentication</span>? [<span class="nv">yes</span>]: <span class="ss">(</span><span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Use</span> <span class="nv">an</span> <span class="nv">empty</span> <span class="nv">password</span>? <span class="ss">(</span><span class="nv">yes</span><span class="o">/</span><span class="nv">no</span><span class="ss">)</span> [<span class="nv">no</span>]: <span class="ss">(</span><span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Use</span> <span class="nv">a</span> <span class="k">random</span> <span class="nv">password</span>? <span class="ss">(</span><span class="nv">yes</span><span class="o">/</span><span class="nv">no</span><span class="ss">)</span> [<span class="nv">no</span>]: <span class="ss">(</span><span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Enter</span> <span class="nv">password</span>: <span class="ss">(</span>パスワードを入力して<span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Enter</span> <span class="nv">password</span> <span class="nv">again</span>: <span class="ss">(</span>パスワードを入力して<span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">Lock</span> <span class="nv">out</span> <span class="nv">the</span> <span class="nv">accout</span> <span class="nv">after</span> <span class="nv">creation</span>? [<span class="nv">no</span>]: <span class="ss">(</span><span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">OK</span>? <span class="ss">(</span><span class="nv">yes</span><span class="o">/</span><span class="nv">no</span><span class="ss">)</span>: <span class="ss">(</span><span class="nv">yes</span>と入力して<span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
<span class="nv">adduser</span>: <span class="nv">INFO</span> <span class="nv">Successfully</span> <span class="nv">added</span> <span class="ss">(</span><span class="nv">admin</span><span class="ss">)</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">user</span> <span class="nv">database</span>.
<span class="nv">Add</span> <span class="nv">another</span> <span class="nv">user</span>? <span class="ss">(</span><span class="nv">yes</span><span class="o">/</span><span class="nv">no</span><span class="ss">)</span>: <span class="ss">(</span><span class="nv">no</span>と入力して<span class="nv">Ctrl</span><span class="o">-</span><span class="nv">J</span>を押す<span class="ss">)</span>
</pre></div>


<h3>インストールの終了</h3>
<div class="highlight"><pre><span></span><span class="n">Setup</span> <span class="k">of</span> <span class="n">you</span> <span class="n">FreeBSD</span> <span class="k">system</span> <span class="k">is</span> <span class="n">nearly</span> <span class="n">complete</span><span class="p">.</span>  <span class="n">You</span> <span class="n">can</span> <span class="n">now</span>
<span class="k">modify</span> <span class="n">your</span> <span class="n">configuration</span> <span class="n">choices</span><span class="p">.</span> <span class="k">After</span> <span class="n">this</span> <span class="n">screen</span><span class="p">,</span> <span class="n">you</span> <span class="n">will</span>
<span class="n">have</span> <span class="n">an</span> <span class="n">opportunity</span> <span class="k">to</span> <span class="n">make</span> <span class="k">more</span> <span class="n">complex</span> <span class="n">changes</span> <span class="k">using</span> <span class="n">a</span> <span class="n">shell</span><span class="p">.</span>
</pre></div>


<p>上記の画面では「Exit」を選択して「OK」を押します。</p>
<div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">installation</span> <span class="k">is</span> <span class="n">now</span> <span class="n">finished</span><span class="p">.</span>
<span class="k">Before</span> <span class="n">exiting</span> <span class="n">the</span> <span class="n">installer</span><span class="p">,</span> <span class="n">yould</span>
<span class="n">you</span> <span class="k">like</span> <span class="k">to</span> <span class="k">open</span> <span class="n">a</span> <span class="n">shell</span> <span class="k">in</span> <span class="n">the</span> <span class="k">new</span>
<span class="k">system</span> <span class="k">to</span> <span class="n">make</span> <span class="k">any</span> <span class="k">final</span> <span class="n">manual</span>
<span class="n">modifications</span><span class="o">?</span>
</pre></div>


<p>上記の画面では「No」を選択します。</p>
<div class="highlight"><pre><span></span><span class="n">Installation</span> <span class="k">of</span> <span class="n">FreeBSD</span>
<span class="n">complete</span><span class="o">!</span> <span class="n">Would</span> <span class="n">you</span> <span class="k">like</span>
<span class="k">to</span> <span class="n">reboot</span> <span class="k">into</span> <span class="n">the</span>
<span class="n">installed</span> <span class="k">system</span> <span class="n">now</span><span class="o">?</span>
</pre></div>


<p>上記の画面では「Reboot」を押しても、またインストーラの画面が起動してしまいます。
そこで、さくらのVPSのコンソールで「OSインストール」→「ISOイメージインストール」を選び、「ISOイメージアップロード情報」の「アカウントの削除」ボタンを押します。
「アカウントを削除してよろしいですか？アップロードしたファイルも削除されます。」と表示されたら「削除する」ボタンを押します。</p>
<p>その後「ISOイメージインストール」のポップアップで「キャンセル」を押してVPSのコンソールに戻りツールバーの「強制停止」ボタンを押して停止した後「起動」ボタンを押して起動します。</p>
<h2>インストール後の設定</h2>
<h3>adminユーザの公開鍵の設置</h3>
<p>ここでは、OS X側で秘密鍵・公開鍵を作成済みとし、秘密鍵は ~/.ssh/id_rsa、公開鍵は ~/.ssh/id_rsa.pub とします。</p>
<p>OSX上で以下の操作を行い、公開鍵をサーバに転送します。</p>
<div class="highlight"><pre><span></span><span class="n">scp</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span> <span class="k">admin</span><span class="o">@</span><span class="err">サーバの</span><span class="n">IPアドレス</span><span class="p">:</span>
</pre></div>


<p>adminユーザのパスワードを聞かれるので入力します。</p>
<p>その後sshでサーバにログインします。</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="k">admin</span><span class="o">@</span><span class="err">サーバの</span><span class="n">IPアドレス</span>
</pre></div>


<p>パスワードを入力すると以下のようなメッセージが表示されます。アドレスのXXX.XXX.XXX.XXXとRSA鍵のフィンガープリントはここでは伏せていますが実際は異なる値になります。「yes」と入力してログインしてください。</p>
<div class="highlight"><pre><span></span><span class="nv">The</span> <span class="nv">authenticity</span> <span class="nv">of</span> <span class="nv">host</span> <span class="s1">&#39;</span><span class="s">XXX.XXX.XXX.XXX (XXX.XXX.XXX.XXX)</span><span class="s1">&#39;</span> <span class="nv">can</span><span class="s1">&#39;</span><span class="s">t be established.</span>
<span class="nv">RSA</span> <span class="nv">key</span> <span class="nv">fingerprint</span> <span class="nv">is</span> <span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>:<span class="nv">yy</span>.
<span class="nv">Are</span> <span class="nv">you</span> <span class="nv">sure</span> <span class="nv">you</span> <span class="nv">want</span> <span class="nv">to</span> <span class="k">continue</span> <span class="nv">connecting</span> <span class="ss">(</span><span class="nv">yes</span><span class="o">/</span><span class="nv">no</span><span class="ss">)</span>?
</pre></div>


<p>パスワードを入力してサーバにログインしたらサーバ上で以下のコマンドを実行し、カギ認証でログインできるようにします。</p>
<div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span>
<span class="n">chmod</span> <span class="mi">700</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span>
<span class="n">mv</span> <span class="n">id_rsa</span><span class="p">.</span><span class="n">pub</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span>
</pre></div>


<p>今度はOS X側で ~/.ssh/configというファイルが無い場合は新規作成した上で、以下の内容を追加します。</p>
<div class="highlight"><pre><span></span><span class="k">Host</span> <span class="err">接続に使用するお好みのホスト名エイリアス</span>
  <span class="n">Hostname</span> <span class="err">サーバの</span><span class="n">IPアドレス</span>
  <span class="k">User</span> <span class="k">admin</span>
  <span class="n">PasswordAuthentication</span> <span class="k">no</span>
  <span class="n">IdentityFile</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span>
</pre></div>


<p>IdentityFileの行は ~/.ssh/id_rsa はデフォルト値なので、この場合はこの行自体不要です。別のファイル名にしていた場合は設定が必要です。</p>
<p>この設定を加えた状態で、OS Xから以下のようにコマンドを実行しパスワードを聞かれずにログインできれば成功です。</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="err">ホスト名エイリアス</span>
</pre></div>


<h3>sshパスワード認証の無効化</h3>
<p>鍵認証でssh接続できるようになったら、悪意を持った第三者の攻撃でパスワードを当ててログインされてしまうのを防ぐため、パスワードでのログインを無効にします。</p>
<p>サーバ上で以下の手順を実行します。まず以下のコマンドを実行してrootユーザになります。</p>
<div class="highlight"><pre><span></span><span class="n">su</span> <span class="o">-</span>
</pre></div>


<p>rootユーザのパスワードを聞かれますので入力します(1行が長いのでブラウザでコピペする際は右の方までスクロールしてください)。</p>
<div class="highlight"><pre><span></span><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="p">.</span><span class="n">orig</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;s/^#\(PasswordAuthentication no\)/\1/;s/^#\(UsePAM\) yes/\1 no/;s/^#\(X11Forwarding\) yes/\1 no/&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">sshd_config</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">less</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">sshd_config</span>
</pre></div>


<p>で設定内容を確認します。</p>
<div class="highlight"><pre><span></span><span class="err">…</span><span class="p">(</span><span class="err">略</span><span class="p">)</span><span class="err">…</span>
<span class="n">PasswordAuthentication</span> <span class="k">no</span>
<span class="err">…</span><span class="p">(</span><span class="err">略</span><span class="p">)</span><span class="err">…</span>
<span class="n">UsePAM</span> <span class="k">no</span>
<span class="err">…</span><span class="p">(</span><span class="err">略</span><span class="p">)</span><span class="err">…</span>
<span class="n">X11Forwarding</span> <span class="k">no</span>
<span class="err">…</span><span class="p">(</span><span class="err">略</span><span class="p">)</span><span class="err">…</span>
</pre></div>


<p>となっていればOKですのでqを押してlessを終了します。</p>
<p>以下のコマンドを実行してsshdを再起動します。</p>
<div class="highlight"><pre><span></span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rc</span><span class="p">.</span><span class="n">d</span><span class="o">/</span><span class="n">sshd</span> <span class="k">restart</span>
</pre></div>


<p>次に実際にパスワード認証が無効化されたことを確認します。</p>
<p>一旦このrootユーザの接続は残しておいて、OS X上で別のターミナルを開き、~/.ssh/configを以下のように編集します。</p>
<div class="highlight"><pre><span></span><span class="k">Host</span> <span class="err">接続に使用するお好みのホスト名エイリアス</span>
  <span class="n">Hostname</span> <span class="err">サーバの</span><span class="n">IPアドレス</span>
  <span class="k">User</span> <span class="k">admin</span>
  <span class="n">PasswordAuthentication</span> <span class="n">yes</span>
  <span class="n">PubkeyAuthentication</span> <span class="k">no</span>
  <span class="o">#</span><span class="n">PasswordAuthentication</span> <span class="k">no</span>
  <span class="o">#</span><span class="n">IdentityFile</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span>
</pre></div>


<p>この状態で</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="err">ホスト名エイリアス</span>
</pre></div>


<p>のようにコマンドを実行した時にパスワードを聞かれることなく以下のように表示されれば、パスワード認証は正しく無効化できています。</p>
<div class="highlight"><pre><span></span><span class="n">Permission</span> <span class="n">denied</span> <span class="p">(</span><span class="n">publickey</span><span class="p">,</span><span class="n">keyboard</span><span class="o">-</span><span class="n">interactive</span><span class="p">).</span>
</pre></div>


<p>上記の確認ができたらOS Xの~/.ssh/configは元の内容に戻しておいてください。</p>
<h3>セキュリティパッチの適用</h3>
<p>先ほどのrootで接続していたターミナルに戻ってセキュリティパッチを適用します。</p>
<p><a href="https://www.freebsd.org/doc/ja_JP.eucJP/books/handbook/updating-upgrading-freebsdupdate.html">18.2. FreeBSD Update</a>の「セキュリティパッチの適用」の項を参考にします。</p>
<p><a href="https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=198030">Bug 198030 – /usr/src/crypto/openssl/util/mkbuildinf.pl: No such file or directory on freebsd-update install</a>のバグを回避するため
<a href="https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=198030#c7">Comment 7</a>の手順を実行してから、パッチを適用します。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="n">freebsd</span><span class="o">-</span><span class="k">update</span> <span class="k">fetch</span>
<span class="o">#</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">crypto</span><span class="o">/</span><span class="n">openssl</span><span class="o">/</span><span class="n">util</span>
<span class="o">#</span> <span class="n">freebsd</span><span class="o">-</span><span class="k">update</span> <span class="n">install</span>
</pre></div>


<p><code>freebsd-update patch</code> を実行すると、アップデートを取得後moreコマンドが起動して更新されたファイル一覧を確認できます。スペースキーを押してページを進め、確認したらqを押して終了します。</p>
<h3>sudoのインストールと設定</h3>
<p>rootユーザで以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="n">pkg</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">sudo</span>
</pre></div>


<p>すると以下のようにpkgコマンド自体をインストールするか聞かれますので、yと入力します。</p>
<div class="highlight"><pre><span></span><span class="nv">The</span> <span class="nv">package</span> <span class="nv">management</span> <span class="nv">tool</span> <span class="nv">is</span> <span class="nv">not</span> <span class="nv">yet</span> <span class="nv">installed</span> <span class="nv">on</span> <span class="nv">your</span> <span class="nv">system</span>.
<span class="k">Do</span> <span class="nv">you</span> <span class="nv">want</span> <span class="nv">to</span> <span class="nv">fetch</span> <span class="nv">and</span> <span class="nv">install</span> <span class="nv">it</span> <span class="nv">now</span>? [<span class="nv">y</span><span class="o">/</span><span class="nv">N</span>]:
</pre></div>


<p>pkgとsudoのインストールが終わったら、以下のコマンドを実行してsudoの設定を変更します。</p>
<div class="highlight"><pre><span></span><span class="n">visudo</span>
</pre></div>


<p>ここではwheelグループにsudoを許可します。</p>
<div class="highlight"><pre><span></span><span class="o">#</span> <span class="o">%</span><span class="n">wheel</span> <span class="k">ALL</span><span class="o">=</span><span class="p">(</span><span class="k">ALL</span><span class="p">)</span> <span class="k">ALL</span>
</pre></div>


<p>の行を</p>
<div class="highlight"><pre><span></span><span class="nf">%wheel</span> <span class="n">ALL</span><span class="o">=</span><span class="p">(</span><span class="n">ALL</span><span class="p">)</span> <span class="n">ALL</span>
</pre></div>


<p>のように変更して:wqで保存して終了します。</p>
<p>sudoの設定を確認するため、rootのターミナルは一旦置いておいて、OS Xからsshでadminユーザでログインし、以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">-</span><span class="n">i</span>
</pre></div>


<p>以下のようにメッセージが表示されますので、adminユーザのパスワードを入力します。
rootユーザのプロンプトが出れば成功です。</p>
<div class="highlight"><pre><span></span>$ sudo -i

We trust you have received the usual lecture from the <span class="nb">local</span> System
Administrator. It usually boils down to these three things:

    <span class="c1">#1) Respect the privacy of others.</span>
    <span class="c1">#2) Think before you type.</span>
    <span class="c1">#3) With great power comes great responsibility.</span>

Password:
root@ホスト名からドメインを除いたもの:~ <span class="c1">#</span>
</pre></div>


<p>確認できたら、このターミナルでCtrl-Dを押してadminユーザに戻り、さらにCtrl-Dを押してログアウトします。
先程残しておいたrootユーザのターミナルも同様にしてログアウトします。</p>
<h2>おわりに</h2>
<p>いくつかハマりどころがありましたが、さくらのVPSにFreeBSD 10.1をクリーンインストールできました。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>