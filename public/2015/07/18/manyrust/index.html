<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <title>manyrustという複数バージョンのrustインストールスクリプトを書いた &middot; hnakamur&#39;s blog at github</title>
        <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css'>
        <link rel="stylesheet" href="/blog//libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="/blog//css/liquorice.css" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="alternate" href="" type="application/rss+xml" title="hnakamur&#39;s blog at github" />
        
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', "UA-53263855-1", 'auto');
    ga('send', 'pageview');
</script>


    </head>
    <body class="li-body">

<header class="li-page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="/blog/">hnakamur&#39;s blog at github</a></div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                </ul>
            </div>
        </div>
    </div>
</header>


    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">manyrustという複数バージョンのrustインストールスクリプトを書いた</h1>
                        <time class="li-article-date">2015-07-18</time>
                    </header>
                    <section>
                        

<h2 id="multirustがあるのに-なぜ新たに書いたのか">multirustがあるのに、なぜ新たに書いたのか</h2>

<p>rustのインストールは<a href="http://www.rust-lang.org/install.html">Install · The Rust Programming Language</a>にあるように複数のチャネルから選んでインストールします。</p>

<ul>
<li>stable (安定版)チャネル</li>
<li>beta (ベータ版)チャネル</li>
<li>nightly (毎晩ビルドされる)チャネル</li>
</ul>

<p>rustでunstableなAPIを使うにはnightlyを使う必要があるので、たいていはstableとnightlyの両方をインストールして使い分けたくなるはずです。
その用途には定番のスクリプトとして<a href="https://github.com/brson/multirust">brson/multirust</a>があります。</p>

<p>私も使っていましたが、rustのソースコードの整形ツール<a href="https://github.com/nrc/rustfmt">nrc/rustfmt</a>をビルドして起動しようとするとエラーになってしまいました。</p>

<p>既に<a href="https://github.com/brson/multirust/issues/43">building cargo atop multirust fails, dyn link problems (Mac OS X) · Issue #43 · brson/multirust</a>にイシューが上がっていて、<a href="https://github.com/brson/multirust/issues/43#issuecomment-106758695">コメント106758695</a>にあるように環境変数 <code>DYLD_LIBRARY_PATH</code> を設定すれば問題は解消するとのことです。</p>

<p>ディレクトリによって環境変数を切り替えるのは<a href="https://github.com/direnv/direnv">direnv/direnv</a>が便利です。ただ、<code>direnv</code> を使うのであれば、そもそも <code>multirust</code> のように <code>rustc</code> などの実行ファイルをラップしたシェルスクリプトを作る必要は無いわけです。</p>

<p>rustの複数のバージョンを異なるディレクトリにインストールしておいて、利用するディレクトリごとに環境変数 <code>PATH</code> と <code>DYLD_LIBRARY_PATH</code> を切り替えればいいだけです。</p>

<p>であれば、 <code>multirust</code> 使わなくてももっとシンプルなスクリプトでいいよね、ということで書いたのが <code>manyrust</code> です。現状はOSXのみサポートしています。</p>

<h2 id="インストール手順">インストール手順</h2>

<p>以下のようにして <code>~/bin</code> に <code>manyrust</code> スクリプトを配置します。</p>

<pre><code>mkdir ~/bin
curl -s -o ~/bin/manyrust https://raw.githubusercontent.com/hnakamur/manyrust/master/manyrust
chmod +x ~/bin/manyrust
</code></pre>

<p>環境変数 <code>PATH</code> に <code>$HOME/bin</code> を追加して有効にします。
bashの場合はこんな感じです。</p>

<pre><code>echo 'export PATH=&quot;$HOME/bin:$PATH&quot;' &gt;&gt; ~/.bash_profilie
exec $SHELL -l
</code></pre>

<h2 id="rustのインストール">rustのインストール</h2>

<p>stableチャネルの最新版をインストール</p>

<pre><code>manyrust install
</code></pre>

<p>betaチャネルの最新版をインストール</p>

<pre><code>manyrust install beta
</code></pre>

<p>nightlyチャネルの最新版をインストール</p>

<pre><code>manyrust install nightly
</code></pre>

<h2 id="rustを利用する側の作業ディレクトリでの設定">rustを利用する側の作業ディレクトリでの設定</h2>

<p>stableチャネルの最新版を使うディレクトリでの設定</p>

<pre><code>manyrust showcfg &gt;&gt; .envrc
direnv allow .
</code></pre>

<p>nightlyチャネルの最新版を使うディレクトリでの設定</p>

<pre><code>manyrust showcfg nightly &gt;&gt; .envrc
direnv allow .
</code></pre>

<p>nightlyチャネルの特定のバージョン2015-07-14を使うディレクトリでの設定</p>

<pre><code>manyrust showcfg nightly 2015-07-14 &gt;&gt; .envrc
direnv allow .
</code></pre>

<h3 id="応用例">応用例</h3>

<p>基本的にはstableチャネルのrustを使いたいが、特定のディレクトリ下ではnightlyを使いたい場合は <code>$HOME/.envrc</code> にstableを使う設定を書いておいて、特定のディレクトリの <code>.envrc</code> ではnightlyを使う設定を書いておけばOKです。</p>

<pre><code>$ manyrust showcfg &gt;&gt; ~/.envrc
direnv: error .envrc is blocked. Run `direnv allow` to approve its content.
$ direnv allow ~
direnv: loading ../../../../.envrc
direnv: export +DYLD_LIBRARY_PATH ~PATH
$ mkdir ~/nightly_work
$ cd !$
cd ~/nightly_work
$ manyrust showcfg nightly &gt;&gt; .envrc
direnv: error .envrc is blocked. Run `direnv allow` to approve its content.
$ direnv allow .
direnv: loading .envrc
direnv: export +DYLD_LIBRARY_PATH ~PATH
$ rustc --version
rustc 1.3.0-nightly (e4e93196e 2015-07-14)
$ echo $DYLD_LIBRARY_PATH
/Users/hnakamur/rust/nightly/2015-07-14/rust/lib:
$ cd
direnv: loading .envrc
direnv: export +DYLD_LIBRARY_PATH ~PATH
$ rustc --version
rustc 1.1.0 (35ceea399 2015-06-19)
$ echo $DYLD_LIBRARY_PATH
/Users/hnakamur/rust/stable/1.1.0/rust/lib:
</code></pre>

<h3 id="direnvを使って設定を切り替えることの利点">direnvを使って設定を切り替えることの利点</h3>

<p>上の例で生成した設定ファイルは以下のようになっています。</p>

<pre><code>$ cat ~/.envrc
source &quot;${MANYRUST_ROOT:-$HOME/rust}/stable/current/etc/bashrc&quot;
$ cat ~/nightly_work/.envrc
source &quot;${MANYRUST_ROOT:-$HOME/rust}/nightly/current/etc/bashrc&quot;
</code></pre>

<p><code>souce</code> で読み込むファイルは <code>manyrust install</code> で以下のように生成されています。</p>

<pre><code>$ cat ~/rust/stable/current/etc/bashrc
rust_root=&quot;${RUSTS_HOME:-$HOME/rust}/stable/1.1.0/rust&quot;
export PATH=&quot;$rust_root/bin:$PATH&quot;
export DYLD_LIBRARY_PATH=&quot;$rust_root/lib:$DYLD_LIBRARY_PATH&quot;
$ cat ~/rust/nightly/current/etc/bashrc
rust_root=&quot;${RUSTS_HOME:-$HOME/rust}/nightly/2015-07-14/rust&quot;
export PATH=&quot;$rust_root/bin:$PATH&quot;
export DYLD_LIBRARY_PATH=&quot;$rust_root/lib:$DYLD_LIBRARY_PATH&quot;
</code></pre>

<p><code>direnv</code> を使わずに何回もこういうファイルを <code>source</code> すると、 <code>PATH</code> や <code>DYLD_LIBRARY_PATH</code> の中身がどんどん増えてしまいます。</p>

<pre><code>$ eval `manyrust showcfg beta`
$ echo $DYLD_LIBRARY_PATH
/Users/hnakamur/rust/beta/1.2.0-beta.2/rust/lib:
$ eval `manyrust showcfg stable`
$ echo $DYLD_LIBRARY_PATH
/Users/hnakamur/rust/stable/1.1.0/rust/lib:/Users/hnakamur/rust/beta/1.2.0-beta.2/rust/lib:
</code></pre>

<p>長いだけではなく、この例だとstableには無いがnightlyにあるライブラリが存在するとstableのライブラリを使いたいのにnightly側が使われてしまうという問題が起きてしまいます。</p>

<p><code>direnv</code> を使っていれば、上の応用例のように <code>DYLD_LIBRARY_PATH</code> の値が追加されるのではなく設定が切り替えられるので、この問題は起きません。</p>

<h2 id="rustfmtのビルドとインストール">rustfmtのビルドとインストール</h2>

<p>で、ここまで書いてから <code>rustfmt</code> をビルド、インストールしようとして問題に気付きました。 <code>rustfmt</code> は <code>~/rust/nightly/current/rust/bin/</code> に置いて上記のように <code>.envrc</code> で切り替えればいいかと思っていたのですが、そうすると <code>stable</code> を使うように <code>.envrc</code> を設定したディレクトリでは <code>rustfmt</code> が使えなくなってしまいます。</p>

<p>またnightlyのバージョンが上がると <code>rustfmt</code> をビルドし直す必要もあります。</p>

<p>これを回避するためにはビルドした <code>rustfmt</code> は <code>~/bin/rustfmt.bin</code> と名前を変えて <code>~/bin</code> に置いて、ラップしたスクリプトを <code>~/bin/rustfmt</code> という名前で作成します。</p>

<p>具体的な手順は以下の通りです。</p>

<pre><code>git clone https://github.com/nrc/rustfmt
cd rustfmt
manyrust showcfg nightly &gt;&gt; .envrc
direnv allow .
cargo build --release
cp target/release/rustfmt ~/bin/rustfmt.bin
cat &lt;&lt;'EOF' &gt; ~/bin/rustfmt
#!/bin/sh
DYLD_LIBRARY_PATH=&quot;${MANYRUST_ROOT:-$HOME/rust}/nightly/2015-07-14/rust/lib&quot; $HOME/bin/rustfmt.bin &quot;$@&quot;
EOF
</code></pre>

<p>今後nightlyを追加インストールした時に <code>rustfmt</code> が依存しているディレクトリが新しいバージョンの <code>lib</code> ディレクトリに存在しない場合に備えて、 <code>DYLD_LIBRARY_PATH</code> は <code>~/rust/nightly/current/rust/lib</code> ではなく特定のバージョンの <code>lib</code> ディレクトリを指定しています。</p>

<p>ということで、 <code>rustfmt</code> に関しては <code>multirust</code> でも <code>manyrust</code> でも同じことで、<code>DYLD_LIBRARY_PATH</code> を設定して実行するようなスクリプトを書いてラップする必要があるというオチでした。</p>

                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <a href="https://hnakamur.github.io"><strong>Hiroaki Nakamura</strong></a>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="/blog/2015/07/19/install_rustfmt/"> OSX上でmultirustを使ったrustfmtのインストール手順</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="/blog/2015/07/12/running_freebsd_on_xhyve/"> xhyveでFreeBSDを動かしてみた</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2012-2016. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="http://github.com/hnakamur/liquorice-hn/">liquorice-hn</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript">
    <!--
    function toggle(id) {
        var e = document.getElementById(id);
        e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
    }
    
    </script>
    </body>
</html>

