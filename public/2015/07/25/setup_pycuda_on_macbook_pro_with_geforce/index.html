<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>GeForce搭載の旧モデルMacBook ProでPyCUDAを試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2015/07/25/setup_pycuda_on_macbook_pro_with_geforce/" rel="bookmark"
           title="Permalink to GeForce搭載の旧モデルMacBook ProでPyCUDAを試してみた">GeForce搭載の旧モデルMacBook ProでPyCUDAを試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-07-25T18:31:00+09:00">
                Published: 2015-07-25
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/cuda.html">cuda</a> <a href="../../../../tag/python.html">python</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p><a href="../setup_cuda_on_macbook_pro_with_geforce/">GeForce搭載の旧モデルMacBook ProでCUDAをセットアップする手順のメモ</a>でCUDAをセットアップした後、<a href="http://mathema.tician.de/software/pycuda/">PyCUDA</a>も試してみたのでメモしておきます。</p>
<p><a href="http://mathema.tician.de/software/pycuda/">PyCUDA</a>のページの <code>Prerequisites</code> に <code>Boost</code>, <code>CUDA</code>, <code>Numpy</code> が書かれています。</p>
<p>CUDAは<a href="../setup_cuda_on_macbook_pro_with_geforce/">GeForce搭載の旧モデルMacBook ProでCUDAをセットアップする手順のメモ</a>でセットアップ済みです。</p>
<h2>Boostのインストール</h2>
<p>Boostは <a href="http://brew.sh/">Homebrew — The missing package manager for OS X</a> でインストールしました。</p>
<div class="highlight"><pre><span></span>brew update
brew install boost
</pre></div>


<p>インストールされたboostのバージョンは以下の通りです。</p>
<div class="highlight"><pre><span></span>$ brew info boost
boost: stable <span class="m">1</span>.58.0 <span class="o">(</span>bottled<span class="o">)</span>, HEAD
Collection of portable C++ <span class="nb">source</span> libraries
http://www.boost.org
/usr/local/Cellar/boost/1.58.0 <span class="o">(</span><span class="m">10718</span> files, 486M<span class="o">)</span> *
  Poured from bottle
From: https://github.com/Homebrew/homebrew/blob/master/Library/Formula/boost.rb
<span class="o">==</span>&gt; Dependencies
Optional: icu4c ✘
<span class="o">==</span>&gt; Options
--c++11
    Build using C++11 mode
--universal
    Build a universal binary
--with-icu4c
    Build regexp engine with icu support
--with-mpi
    Build with MPI support
--without-single
    Disable building single-threading variant
--without-static
    Disable building static library variant
--HEAD
    Install HEAD version
</pre></div>


<h2>NumpyとPyCUDAをインストールして試してみる</h2>
<p><a href="https://github.com/riywo/anyenv">riywo/anyenv</a>と<a href="https://github.com/yyuu/pyenv">yyuu/pyenv</a>で入れたPython 3.4.3を使い、 <code>~/sandbox/pycuda</code> という作業ディレクトリを作成してvenv環境を作って試しました。</p>
<p>以下の手順でvenv環境を作って有効にします。</p>
<div class="highlight"><pre><span></span>mkdir -p ~/sandbox/pycuda
cd !$
python -m venv venv
source venv/bin/activate
</pre></div>


<p><code>(venv) $</code> プロンプト内で以下のコマンドでNumPyとPyCUDAをインストールします。</p>
<div class="highlight"><pre><span></span>pip install numpy
pip install pycuda
</pre></div>


<p>PyCUDAのほうは以下のような警告が出ましたが、インストールは出来ました。</p>
<div class="highlight"><pre><span></span>    /Users/hnakamur/sandbox/pycuda/venv/lib/python3.4/site-packages/numpy/core/include/numpy/npy_1_7_deprecated_api.h:15:2: warning: &quot;Using deprecated NumPy API, disable it by &quot;          &quot;#defining NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION&quot; [-W#warnings]
    #warning &quot;Using deprecated NumPy API, disable it by &quot; \
     ^
    src/wrapper/_pvt_struct_v3.cpp:1047:30: warning: conversion from string literal to &#39;char *&#39; is deprecated [-Wc++11-compat-deprecated-writable-strings]
        static char *kwlist[] = {&quot;format&quot;, 0};
                                 ^
    src/wrapper/_pvt_struct_v3.cpp:1166:30: warning: conversion from string literal to &#39;char *&#39; is deprecated [-Wc++11-compat-deprecated-writable-strings]
        static char *kwlist[] = {&quot;buffer&quot;, &quot;offset&quot;, 0};
                                 ^
    src/wrapper/_pvt_struct_v3.cpp:1166:40: warning: conversion from string literal to &#39;char *&#39; is deprecated [-Wc++11-compat-deprecated-writable-strings]
        static char *kwlist[] = {&quot;buffer&quot;, &quot;offset&quot;, 0};
                                           ^
    src/wrapper/_pvt_struct_v3.cpp:1224:17: warning: unused variable &#39;isstring&#39; [-Wunused-variable]
                int isstring;
                    ^
    src/wrapper/_pvt_struct_v3.cpp:1430:6: warning: conversion from string literal to &#39;char *&#39; is deprecated [-Wc++11-compat-deprecated-writable-strings]
        {&quot;format&quot;, (getter)s_get_format, (setter)NULL, &quot;struct format string&quot;, NULL},
         ^
    src/wrapper/_pvt_struct_v3.cpp:1430:52: warning: conversion from string literal to &#39;char *&#39; is deprecated [-Wc++11-compat-deprecated-writable-strings]
        {&quot;format&quot;, (getter)s_get_format, (setter)NULL, &quot;struct format string&quot;, NULL},
                                                       ^
    src/wrapper/_pvt_struct_v3.cpp:1431:6: warning: conversion from string literal to &#39;char *&#39; is deprecated [-Wc++11-compat-deprecated-writable-strings]
        {&quot;size&quot;, (getter)s_get_size, (setter)NULL, &quot;struct size in bytes&quot;, NULL},
         ^
    src/wrapper/_pvt_struct_v3.cpp:1431:48: warning: conversion from string literal to &#39;char *&#39; is deprecated [-Wc++11-compat-deprecated-writable-strings]
        {&quot;size&quot;, (getter)s_get_size, (setter)NULL, &quot;struct size in bytes&quot;, NULL},
                                                   ^
    src/wrapper/_pvt_struct_v3.cpp:1720:1: warning: duplicate &#39;extern&#39; declaration specifier [-Wduplicate-decl-specifier]
    PyMODINIT_FUNC
    ^
    /Users/hnakamur/.anyenv/envs/pyenv/versions/3.4.3/include/python3.4m/pyport.h:778:39: note: expanded from macro &#39;PyMODINIT_FUNC&#39;
    #               define PyMODINIT_FUNC extern &quot;C&quot; PyObject*
                                          ^
    10 warnings generated.
</pre></div>


<h2>PyCUDAのサンプルを試す</h2>
<p><a href="http://documen.tician.de/pycuda/tutorial.html">Tutorial — PyCUDA 2015.1.2 documentation</a>と<a href="http://qiita.com/masato/items/713fa8876e50a65d575c">Windows7 64bitにPyCUDAとTheanoをインストールしてGPU計算する - Qiita</a>の<a href="http://qiita.com/masato/items/713fa8876e50a65d575c#%E3%83%86%E3%82%B9%E3%83%88">テスト</a>を参考にして、以下の内容で <code>pycuda-test.py</code> を作って実行してみました。</p>
<p>Python 3.xを使っているので <code>print</code> の引数は括弧で囲むように書き換えています。</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pycuda.gpuarray</span> <span class="kn">as</span> <span class="nn">gpuarray</span>
<span class="kn">import</span> <span class="nn">pycuda.driver</span> <span class="kn">as</span> <span class="nn">cuda</span>
<span class="kn">import</span> <span class="nn">pycuda.autoinit</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="n">a_gpu</span> <span class="o">=</span> <span class="n">gpuarray</span><span class="o">.</span><span class="n">to_gpu</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
<span class="n">a_doubled</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a_gpu</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">a_doubled</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">a_gpu</span><span class="p">)</span>
</pre></div>


<p>実行してみると、以下のように出力されPyCUDAが無事動きました！</p>
<div class="highlight"><pre><span></span>(venv) $ python pycuda-test.py
[[-0.72795004 -0.16994514  0.02276878 -1.07509565]
 [ 0.20851769  2.08421874 -0.51877511 -1.27585149]
 [ 0.29300559 -0.40393201  3.15332532 -1.90199065]
 [ 2.87024021  0.64773476  2.65404892 -2.97092891]]
[[-0.36397502 -0.08497257  0.01138439 -0.53754783]
 [ 0.10425884  1.04210937 -0.25938755 -0.63792574]
 [ 0.14650279 -0.201966    1.57666266 -0.95099533]
 [ 1.43512011  0.32386738  1.32702446 -1.48546445]]
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>