<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <title>Homebrew Caskを使わずにdmgファイルのアプリをコマンドでインストールする &middot; hnakamur&#39;s blog at github</title>
        <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css'>
        <link rel="stylesheet" href="https://hnakamur.github.io/blog//libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://hnakamur.github.io/blog//css/liquorice.css" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="alternate" href="" type="application/rss+xml" title="hnakamur&#39;s blog at github" />
        
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', "UA-53263855-1", 'auto');
    ga('send', 'pageview');
</script>


    </head>
    <body class="li-body">

<header class="li-page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://hnakamur.github.io/blog/">hnakamur&#39;s blog at github</a></div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                </ul>
            </div>
        </div>
    </div>
</header>


    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">Homebrew Caskを使わずにdmgファイルのアプリをコマンドでインストールする</h1>
                        <time class="li-article-date">2015-04-06</time>
                    </header>
                    <section>
                        

<h2 id="なぜhomebrew-caskをやめたか">なぜHomebrew Caskをやめたか</h2>

<p><a href="http://t-wada.hatenablog.jp/entry/mac-provisioning-by-ansible">Mac の開発環境構築を自動化する (2015 年初旬編) - t-wadaのブログ</a>でもHomebrew Caskの不安な点について書かれていますが、私もHomebrew Caskは便利と思いつつも止めたいなと思っていました。</p>

<p>私が使うアプリに関してはほとんどがアプリ側で最新版のお知らせとバージョンアップの仕組みを持っています。あとHomebrew Caskは/opt/homebrew-cask/以下に実体を置いて~/Applications/や/Applications/にシンボリックリンクを貼るようになっています。</p>

<p>私はそこまで複雑な仕組みは要らないので、初期インストールがコマンドで半自動化できれば十分です。</p>

<h2 id="dmgファイルのアプリをコマンドラインからインストールする">dmgファイルのアプリをコマンドラインからインストールする</h2>

<p><a href="http://stackoverflow.com/questions/22934083/install-dmg-package-on-mac-os-from-terminal/22940943#22940943">osx - Install dmg package on MAC OS from Terminal - Stack Overflow</a>や<a href="http://commandlinemac.blogspot.jp/2008/12/installing-dmg-application-from-command.html">Command Line Mac: Installing a .dmg application from the command line</a>を見て実際にやってみました。</p>

<p>ソースは<a href="https://github.com/hnakamur/my-macbook-initial-setup">hnakamur/my-macbook-initial-setup · GitHub</a>にあります。</p>

<p>以下のアプリをdmgファイルからインストールしています。</p>

<ul>
<li><a href="https://github.com/splhack/macvim-kaoriya">splhack/macvim-kaoriya · GitHub</a></li>
<li><a href="http://calibre-ebook.com/">calibre - E-book management</a></li>
<li><a href="https://www.google.co.jp/chrome/browser/desktop/index.html">Chrome</a></li>
<li><a href="https://www.mozilla.org/ja/firefox/new/">Firefox</a></li>
<li><a href="https://www.google.co.jp/ime/">Google 日本語入力</a></li>
<li><a href="http://iterm2.com/">iTerm2 - Mac OS Terminal Replacement</a></li>
<li><a href="https://java.com/ja/download/">Java (JRE)</a></li>
<li><a href="http://grandperspectiv.sourceforge.net/">GrandPerspective</a></li>
<li><a href="https://www-jp.mysql.com/products/workbench/">MySQL Workbench</a></li>
<li><a href="http://mstarke.github.io/MacPass/">MacPass</a></li>
<li><a href="http://www.shadowlab.org/Software/spark.php">Spark</a></li>
<li><a href="https://www.virtualbox.org/">Oracle VM VirtualBox</a></li>
<li><a href="https://www.vagrantup.com/">Vagrant</a></li>
<li><a href="http://xquartz.macosforge.org/landing/">XQuartz</a></li>
</ul>

<h2 id="dmgファイルのマウントとアンマウント">dmgファイルのマウントとアンマウント</h2>

<p>共通の処理として、dmgファイルのマウントは <code>hdiutil attach</code> 、アンマウントは <code>hdiutil detach</code> コマンドで行います。</p>

<p>マウントした時の /Volumes/〜 のディレクトリ名は <code>hdiutil attach</code> の実行結果の最後の行から取得できます。</p>

<p>最初は</p>

<pre><code>  mount_dir=`hdiutil attach $dmg_file | awk 'END{print $NF}'`
</code></pre>

<p>のようにして最後の行の一番右のフィールドを取得していましたが、 <code>/Volumes/Google Chrome</code> のように空白を含む場合があることがわかりました。</p>

<p><a href="http://stackoverflow.com/questions/22934083/install-dmg-package-on-mac-os-from-terminal/22940943#22940943">osx - Install dmg package on MAC OS from Terminal - Stack Overflow</a>では第1フィールドと第2フィールドを消して第3フィールド以降にしていますが、試してみると余分な空白（実際はタブと判明）が付いてきました。</p>

<p><code>hdiutil attach</code> の結果をファイルに落として見てみたら、空白に加えてタブで区切られていてタブで区切るほうがシンプルなことがわかりました。</p>

<p>そこで、以下のようにして取得するようにしました。</p>

<pre><code>  mount_dir=`hdiutil attach $dmg_file | awk -F '\t' 'END{print $NF}'`
</code></pre>

<h2 id="インストール方法のパターン">インストール方法のパターン</h2>

<p>上記のアプリの範囲では4パターンありました。</p>

<h3 id="dmgファイル内に-appフォルダがあるパターン">dmgファイル内に〜.appフォルダがあるパターン</h3>

<p>Chromeなどがこのパターンです。<a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man1/ditto.1.html">ditto</a>コマンドで/Applications/〜.appにコピーするようにしました。</p>

<p><a href="https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L731-L740">https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L731-L740</a></p>

<pre><code>install_google_chrome() {
  download_url=https://dl.google.com/chrome/mac/stable/GGRO/googlechrome.dmg
  dmg_file=${download_url##*/}

  curl -LO $download_url
  mount_dir=`hdiutil attach $dmg_file | awk -F '\t' 'END{print $NF}'`
  sudo /usr/bin/ditto &quot;$mount_dir/Google Chrome.app&quot; &quot;/Applications/Google Chrome.app&quot;
  hdiutil detach &quot;$mount_dir&quot;
  rm $dmg_file
}
</code></pre>

<h3 id="dmgファイル内に-pkgのインストーラがあるパターン">dmgファイル内に*.pkgのインストーラがあるパターン</h3>

<p>Google日本語入力などがこのパターンです。OSXの<a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man8/installer.8.html">installer</a>コマンドでインストールします。</p>

<p><a href="https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L742-L751">https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L742-L751</a></p>

<pre><code>install_google_japanese_input() {
  download_url=https://dl.google.com/japanese-ime/latest/GoogleJapaneseInput.dmg
  dmg_file=${download_url##*/}

  curl -LO $download_url
  mount_dir=`hdiutil attach $dmg_file | awk -F '\t' 'END{print $NF}'`
  sudo installer -pkg $mount_dir/GoogleJapaneseInput.pkg -target /
  hdiutil detach &quot;$mount_dir&quot;
  rm $dmg_file
}
</code></pre>

<h3 id="dmgファイル内に独自形式のインストーラがあるパターン">dmgファイル内に独自形式のインストーラがあるパターン</h3>

<p>Javaがこのパターンでした。インストーラを実行してインストールします。</p>

<p><a href="https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L762-L772">https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L762-L772</a></p>

<pre><code>install_java() {
  download_url=http://javadl.sun.com/webapps/download/AutoDL?BundleId=105219
  dmg_file=jre.dmg

  curl -L -o $dmg_file &quot;$download_url&quot;
  mount_dir=`hdiutil attach $dmg_file | awk -F '\t' 'END{print $NF}'`
  java_dir=&quot;${mount_dir##*/}&quot;
  sudo &quot;$mount_dir/${java_dir}.app/Contents/MacOS/MacJREInstaller&quot;
  hdiutil detach &quot;$mount_dir&quot;
  rm $dmg_file
}
</code></pre>

<h3 id="zipファイル内に-appがあるパターン">zipファイル内に〜.appがあるパターン</h3>

<p>iTerm2などがこのパターンです。unzipコマンドの-dオプションで解凍先を/Applicationsにして解凍してインストールします。</p>

<p><a href="https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L753-L760">https://github.com/hnakamur/my-macbook-initial-setup/blob/df0eb48db189d39de9103a53c06f85a5acfaf347/run.sh#L753-L760</a></p>

<pre><code>install_iterm2() {
  download_url=https://iterm2.com/downloads/stable/iTerm2_v2_0.zip
  zip_file=${download_url##*/}

  curl -LO $download_url
  sudo unzip $zip_file -d /Applications
  rm $zip_file
}
</code></pre>

<h2 id="まとめ">まとめ</h2>

<p>Homebrew Caskを使わずにコマンドラインでOSXのアプリのインストールを半自動化しました。全自動ではなく半自動化といっているのは、アプリによってパスワード入力が必要だったり、ダイアログが表示されてボタンを押す必要があるからです。</p>

<p>アプリのバージョンが今後上がった時にダウンロードURLを再度調べる必要があるのが面倒ではありますが、OSXを一からセットアップするのはたまにしか行わないのでよしとします。</p>

                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <a href="https://hnakamur.github.io"><strong>Hiroaki Nakamura</strong></a>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://hnakamur.github.io/blog/2015/04/06/jxa-osx-automation-with-javascript/"> JXA (JavaScript for Automation)を使ってOSXの初期設定を半自動化してみた</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://hnakamur.github.io/blog/2015/02/28/riot-tag-editor-example/"> Riot.jsでタグエディターのサンプルを作ってみた</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2012-2016. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="http://github.com/hnakamur/liquorice-hn/">liquorice-hn</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript">
    <!--
    function toggle(id) {
        var e = document.getElementById(id);
        e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
    }
    
    </script>
    </body>
</html>

