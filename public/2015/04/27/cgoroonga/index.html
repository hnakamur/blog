<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>データ登録用にgroongaのC APIのgoバインディングを書いてみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2015/04/27/cgoroonga/" rel="bookmark"
           title="Permalink to データ登録用にgroongaのC APIのgoバインディングを書いてみた">データ登録用にgroongaのC APIのgoバインディングを書いてみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-04-27T00:44:00+09:00">
                Published: 2015-04-27
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/groonga.html">groonga</a> </p>
</footer><!-- /.post-info -->      <h2>groongaで大量のデータを登録する方法を調べてみた</h2>
<h3>方法1: loadコマンドの文字列を組み立ててgroongaコマンドの標準入力に流し込む</h3>
<p>groongaのデータの登録はチュートリアルの<a href="http://groonga.org/ja/docs/tutorial/introduction.html#load-records">データのロード</a>にあるように<a href="http://groonga.org/ja/docs/reference/commands/load.html">loadコマンド</a>を使えば出来ます。</p>
<p>外部ファイルから大量のデータを登録するときはどうするのかなと思って調べてみると、 groongaのソースの examples/dictionary/eijiro/ の例では <code>load</code> コマンドの文字列を組み立てて <code>groonga</code> コマンドの標準入力に流し込んでいました。</p>
<p>https://github.com/groonga/groonga/blob/59ef5d1d26b4ba47d163019a21a20519d349489b/examples/dictionary/eijiro/eijiro-import.sh#L10-L12</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="nv">iconv</span> <span class="o">-</span><span class="nv">f</span> <span class="nv">UCS2</span> <span class="o">-</span><span class="nv">t</span> <span class="nv">UTF8</span> <span class="mh">$2</span> <span class="o">|</span> ${<span class="nv">base_dir</span>}<span class="o">/</span><span class="nv">eijiro2grn</span>.<span class="nv">rb</span> <span class="o">|</span> <span class="nv">groonga</span> <span class="mh">$1</span> <span class="o">&gt;</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">null</span><span class="c1">; then</span>
  <span class="nv">echo</span> <span class="s2">&quot;</span><span class="s">eijiro data loaded.</span><span class="s2">&quot;</span>
<span class="nv">fi</span>
</pre></div>


<h3>方法2: groongaのC APIを使う</h3>
<p>この方法はお手軽ですが、エラー処理が難しそうと重い、さらに調べてみると、groongaのC APIを使ってデータ登録する例を見つけました。</p>
<p><a href="http://createfield.com/C%E8%A8%80%E8%AA%9E%E3%81%A7Groonga%E3%81%AEAPI%E3%82%92%E4%BD%BF%E3%81%86%E6%96%B9%E6%B3%95">C言語でGroongaのAPIを使う方法 - CreateField</a></p>
<h2>go言語用のライブラリを作ってみました</h2>
<p>折角なのでCのライブラリのgo言語バインディングを作る練習を兼ねてgo言語用のライブラリを作ってみました。</p>
<p><a href="https://github.com/hnakamur/cgoroonga">hnakamur/cgoroonga</a></p>
<h3>テーブルとカラムを作ってレコードを1件登録するサンプルコード</h3>
<p>https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/add_record/main.go</p>
<p>OSX + homebrewという環境で試しました。</p>
<div class="highlight"><pre><span></span><span class="n">brew</span> <span class="n">install</span> <span class="n">groonga</span>
</pre></div>


<p>でgroongaをインストールして、以下の手順で実行します。</p>
<div class="highlight"><pre><span></span><span class="k">go</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="n">cgoroonga</span><span class="w"></span>
<span class="n">cd</span><span class="w"> </span><span class="err">$</span><span class="n">GOPATH</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="n">cgoroonga</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">add_record</span><span class="w"></span>
<span class="k">go</span><span class="w"> </span><span class="n">build</span><span class="w"></span>
<span class="p">.</span><span class="o">/</span><span class="n">add_record</span><span class="w"></span>
</pre></div>


<h3>Wikipedia日本語版の記事データを登録するサンプルコード</h3>
<p>https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/import_wikipedia/main.go</p>
<p>データファイルは
<a href="http://dumps.wikimedia.org/jawiki/20150422/">jawiki dump progress on 20150422</a>
から以下の4つのファイルをダウンロードしました。</p>
<ul>
<li>jawiki-20150422-pages-articles1.xml.bz2</li>
<li>jawiki-20150422-pages-articles2.xml.bz2</li>
<li>jawiki-20150422-pages-articles3.xml.bz2</li>
<li>jawiki-20150422-pages-articles4.xml.bz2</li>
</ul>
<p>Wikipediaのデータファイルはxmlをbzip2で圧縮した形式になっているので、Goの標準ライブラリの<a href="http://golang.org/pkg/compress/bzip2/">bzip2</a>と<a href="http://golang.org/pkg/encoding/xml/">xml</a>パッケージを使って読み込むようにしています。</p>
<p>サイズの大きいXMLファイルを読み込んで処理するときにおすすめの方法が
<a href="http://blog.davidsingleton.org/parsing-huge-xml-files-with-go/">Parsing huge XML files with Go - david singleton</a>で紹介されていたので、それを真似しました。ありがとうございます！</p>
<div class="highlight"><pre><span></span><span class="n">cd</span><span class="w"> </span><span class="err">$</span><span class="n">GOPATH</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="n">cgoroonga</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">import_wikipedia</span><span class="w"></span>
<span class="k">go</span><span class="w"> </span><span class="n">build</span><span class="w"></span>
<span class="p">.</span><span class="o">/</span><span class="n">import_wikipedia</span><span class="w"> </span><span class="n">jawiki</span><span class="o">-</span><span class="mi">20150422</span><span class="o">-</span><span class="n">pages</span><span class="o">-</span><span class="n">articles1</span><span class="p">.</span><span class="nc">xml</span><span class="p">.</span><span class="n">bz2</span><span class="w"></span>
</pre></div>


<p>のように実行します。</p>
<h2>Cライブラリのgoバインディングを書くときのtips</h2>
<p>基本的には</p>
<ul>
<li><a href="https://golang.org/cmd/cgo/">cgo - The Go Programming Language</a></li>
<li><a href="https://github.com/golang/go/wiki/cgo">cgo · golang/go Wiki</a></li>
</ul>
<p>を読めばOKなのですが、ハマった点をメモしておきます。</p>
<h3>import "C"の上に空行を入れないように注意</h3>
<p>たとえば
https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/column.go#L7
で <code>import "C"</code> の上に空行を入れて <code>go build</code> を実行すると以下の様なエラーになります。</p>
<div class="highlight"><pre><span></span>$ <span class="nv">go</span> <span class="nv">build</span>
# <span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">hnakamur</span><span class="o">/</span><span class="nv">cgoroonga</span>
<span class="nv">could</span> <span class="nv">not</span> <span class="nv">determine</span> <span class="nv">kind</span> <span class="nv">of</span> <span class="nv">name</span> <span class="k">for</span> <span class="nv">C</span>.<span class="nv">free</span>
<span class="nv">could</span> <span class="nv">not</span> <span class="nv">determine</span> <span class="nv">kind</span> <span class="nv">of</span> <span class="nv">name</span> <span class="k">for</span> <span class="nv">C</span>.<span class="nv">grn_column_create</span>
<span class="nv">could</span> <span class="nv">not</span> <span class="nv">determine</span> <span class="nv">kind</span> <span class="nv">of</span> <span class="nv">name</span> <span class="k">for</span> <span class="nv">C</span>.<span class="nv">grn_obj_column</span>
<span class="nv">could</span> <span class="nv">not</span> <span class="nv">determine</span> <span class="nv">kind</span> <span class="nv">of</span> <span class="nv">name</span> <span class="k">for</span> <span class="nv">C</span>.<span class="nv">grn_obj_flags</span>
<span class="nv">could</span> <span class="nv">not</span> <span class="nv">determine</span> <span class="nv">kind</span> <span class="nv">of</span> <span class="nv">name</span> <span class="k">for</span> <span class="nv">C</span>.<span class="k">strlen</span>
</pre></div>


<h3>Cのマクロはgoから呼べないのでCの関数でラップする</h3>
<p>https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/cgoroonga.c
のようにマクロをラップしたCの関数を書いて、それをgoから呼ぶようにします。</p>
<h3>エラーコードが有るエラーと無いエラーを統一的に扱うようにした</h3>
<p>groongaのC APIはほとんどが<a href="http://groonga.org/ja/docs/reference/api/grn_table.html">7.20.21. grn_table — Groonga v5.0.2ドキュメント</a>の <a href="http://groonga.org/ja/docs/reference/api/grn_table.html#c.grn_table_delete">grn_table_delete</a>  のように <a href="https://github.com/groonga/groonga/blob/v5.0.2/include/groonga/groonga.h#L44-L125">grn_rc</a> を返します。</p>
<p>が、 <a href="http://groonga.org/ja/docs/reference/api/grn_table.html#c.grn_table_create">grn_table_create</a></p>
<div class="highlight"><pre><span></span><span class="n">grn_obj</span> <span class="o">*</span><span class="n">grn_table_create</span><span class="p">(</span><span class="n">grn_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="n">const</span> <span class="nb">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">unsigned</span> <span class="nb">int</span> <span class="n">name_size</span><span class="p">,</span> <span class="n">const</span> <span class="nb">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="n">grn_obj_flags</span> <span class="n">flags</span><span class="p">,</span> <span class="n">grn_obj</span> <span class="o">*</span><span class="k">key_type</span><span class="p">,</span> <span class="n">grn_obj</span> <span class="o">*</span><span class="n">value_type</span><span class="p">)</span>
</pre></div>


<p>のように <code>grn_rc</code> を返さないAPIもあります。ドキュメントには明記されていませんが、Cの慣例としてエラーのときはおそらく戻り値が <code>NULL</code> になるのだと予想します。</p>
<p>https://github.com/groonga/groonga/blob/v5.0.2/lib/db.c#L744-L930 を見るとやはりNULLを返すケースが有りました。</p>
<p>そこで、
https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/error.go
のようにエラーコードが有るエラーと無いエラーを全てGoの変数として定義するようにしてみました。</p>
<p>これにより
https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/import_wikipedia/main.go#L59-L63</p>
<div class="highlight"><pre><span></span>    <span class="nv">table</span>, <span class="nv">err</span> :<span class="o">=</span> <span class="nv">ctx</span>.<span class="nv">TableOpenOrCreate</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">Articles</span><span class="s2">&quot;</span>, <span class="s2">&quot;&quot;</span>,
        <span class="nv">grn</span>.<span class="nv">OBJ_TABLE_HASH_KEY</span><span class="o">|</span><span class="nv">grn</span>.<span class="nv">OBJ_PERSISTENT</span>, <span class="nv">keyType</span>, <span class="nv">nil</span><span class="ss">)</span>
    <span class="k">if</span> <span class="nv">err</span> <span class="o">!=</span> <span class="nv">nil</span> {
        <span class="k">return</span>
    }
</pre></div>


<p>のようにエラーを常に戻り値で受け取るように統一することができ、見通しのよいコードが実現できました。</p>
<h2>まとめ</h2>
<p>データ登録用にgroongaのC APIのgoバインディングを書きました。
C APIがエラーコードを返さない場合でもGo側ではエラーを返し <code>if err != nil</code> というのようにエラーチェックの方式を統一することで、エラー処理の漏れに気づきやすくする事が出来ました。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>