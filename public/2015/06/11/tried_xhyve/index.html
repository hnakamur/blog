<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>xhyveを試してみました</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2015/06/11/tried_xhyve/" rel="bookmark"
           title="Permalink to xhyveを試してみました">xhyveを試してみました</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-06-11T00:45:00+09:00">
                Published: 2015-06-11
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/xhyve.html">xhyve</a> <a href="../../../../tag/virtualization.html">virtualization</a> </p>
</footer><!-- /.post-info -->      <p><a href="http://www.pagetable.com/?p=831">xhyve – Lightweight Virtualization on OS X Based on bhyve | pagetable.com</a>に沿って試してみました。</p>
<h2>確認した環境</h2>
<ul>
<li>MacBook Pro (Retina, Mid 2012)</li>
<li>OS X Yosemite 10.10.3</li>
</ul>
<h2>ソースからビルド</h2>
<div class="highlight"><pre><span></span>cd お好みの作業ディレクトリ
git clone https://github.com/mist64/xhyve
cd xhyve
make
</pre></div>


<h2>Tiny Core Linuxを起動</h2>
<div class="highlight"><pre><span></span>./xhyverun.sh
</pre></div>


<p>起動メッセージが流れた後、画面がクリアされて以下のように表示されたら起動完了です。ここまで3〜4秒です。速い！</p>
<div class="highlight"><pre><span></span>(�-
 //\   Core is distributed with ABSOLUTELY NO WARRANTY.
 v_/_           www.tinycorelinux.com

tc@box:~$ Switched to clocksource tsc
</pre></div>


<p>プロンプトにかぶってメッセージが出ていますが、enterを押せばプロンプトが出ます。</p>
<div class="highlight"><pre><span></span>tc@box:~$
</pre></div>


<p>シャットダウンするには以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span>sudo halt
</pre></div>


<h2>Ubuntu Server 14.04.2のディスクイメージ作成</h2>
<p>Ubuntu ServerのISOイメージをダウンロードして、ディスクイメージを作成するための準備を行います。元記事によると、OS Xがハイブリッドファイルシステムを認識しないので、Linux kernelとinitrdを取り出しているそうです。</p>
<div class="highlight"><pre><span></span>mkdir ubuntu
cd ubuntu
curl -O ftp://ftp.kddilabs.jp/Linux/packages/ubuntu/releases-cd/14.04.2/ubuntu-14.04.2-server-amd64.iso
dd if=/dev/zero bs=2k count=1 of=/tmp/tmp.iso
dd if=ubuntu-14.04.2-server-amd64.iso bs=2k skip=1 &gt;&gt; /tmp/tmp.iso
hdiutil attach /tmp/tmp.iso
cp /Volumes/Ubuntu-Server\ 14/install/vmlinuz .
cp /Volumes/Ubuntu-Server\ 14/install/initrd.gz .
</pre></div>


<p>以下のコマンドでディスクイメージを作成します。ここでは <code>bs=1g count=8</code> でディスクサイズを8GBとしていますが、お好みで調整してください。</p>
<div class="highlight"><pre><span></span>dd if=/dev/zero of=hdd.img bs=1g count=8
</pre></div>


<p>xhyve/ubuntuディレクトリではなくxhyveディレクトリにディスクイメージ作成用のスクリプトを作ります。</p>
<div class="highlight"><pre><span></span>cd ..
cat &lt;&lt;&#39;EOF&#39; &gt; xhyverun_ubuntu_install.sh
#!/bin/sh

KERNEL=&quot;ubuntu/vmlinuz&quot;
INITRD=&quot;ubuntu/initrd.gz&quot;
CMDLINE=&quot;earlyprintk=serial console=ttyS0 acpi=off&quot;

MEM=&quot;-m 1G&quot;
#SMP=&quot;-c 2&quot;
NET=&quot;-s 2:0,virtio-net&quot;
IMG_CD=&quot;-s 3,ahci-cd,ubuntu/ubuntu-14.04.2-server-amd64.iso&quot;
IMG_HDD=&quot;-s 4,virtio-blk,ubuntu/hdd.img&quot;
PCI_DEV=&quot;-s 0:0,hostbridge -s 31,lpc&quot;
LPC_DEV=&quot;-l com1,stdio&quot;

build/xhyve $MEM $SMP $PCI_DEV $LPC_DEV $NET $IMG_CD $IMG_HDD -f kexec,$KERNEL,$INITRD,&quot;$CMDLINE&quot;
EOF
</pre></div>


<p>スクリプトに実行パーミションをつけてsudo付きで実行します。</p>
<div class="highlight"><pre><span></span>chmod +x xhyverun_ubuntu_install.sh
sudo ./xhyverun_ubuntu_install.sh
</pre></div>


<p>テキストインストーラが起動しますので、以下のように選択してインストールしました。</p>
<ul>
<li>Select a language: English</li>
<li>Select your location: other -&gt; Asia -&gt; Japan</li>
<li>Configure locales: United Status - en_US.UTF-8</li>
<li>Hostname: お好みの名前</li>
<li>Set up users and passwords: お好みのIDとパスワードで作成</li>
<li>time zone: Asia/Tokyo</li>
<li>Partition disks: Guided - use entire disk</li>
<li>HTTP proxy: 無し</li>
<li>manage upgrades: No automatic updates</li>
<li>Software selection:<ul>
<li>Basic Ubuntu Server</li>
<li>OpenSSH server</li>
</ul>
</li>
<li>Install GRUB to the master boot record: Yes</li>
<li>Is the system clock set to UTC: No</li>
<li>Installation complete: Go Back -&gt; Execute a shell</li>
</ul>
<p>Installation completeのところでContinueではなくGo Backでメニューに戻りExecute a shellを選んで進み、シェルが起動したら以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span>cd /target
sbin/ifconfig
tar c boot | nc -l -p 1234
</pre></div>


<p>上記のコマンド実行のうちsbin/ifconfigで表示されたIPアドレスをメモしておきます。</p>
<div class="highlight"><pre><span></span>/target # sbin/ifconfig
eth0      Link encap:Ethernet  HWaddr e6:0d:f2:6b:cf:32
          inet addr:192.168.64.3  Bcast:192.168.64.255  Mask:255.255.255.0
          inet6 addr: fe80::e40d:f2ff:fe6b:cf32/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:25405 errors:0 dropped:0 overruns:0 frame:85
          TX packets:13601 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:38179647 (38.1 MB)  TX bytes:931189 (931.1 KB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
</pre></div>


<p>Mac側では以下のコマンドを実行します。IPアドレスはifconfigで表示されたものに置き換えて実行してください。</p>
<div class="highlight"><pre><span></span>cd ubuntu
nc 192.168.64.3 1234 | tar x
</pre></div>


<p>VMのシェルのプロンプトで以下のように入力してシェルを終了します。</p>
<div class="highlight"><pre><span></span>exit
</pre></div>


<p>メニューに戻ったら <code>Finish the installation</code> を選びます。</p>
<ul>
<li>Is the system clock set to UTC?: No</li>
<li>Installation complete: Continue</li>
</ul>
<h2>Ubuntu Server 14.04.2の起動</h2>
<p>Macでxhyve/ubuntuではなくxhyveのディレクトリで起動用のスクリプトを作成します。</p>
<div class="highlight"><pre><span></span>cat &lt;&lt;&#39;EOF&#39; &gt; ./xhyverun_ubuntu.sh
#!/bin/sh

KERNEL=&quot;ubuntu/boot/vmlinuz-3.16.0-30-generic&quot;
INITRD=&quot;ubuntu/boot/initrd.img-3.16.0-30-generic&quot;
CMDLINE=&quot;earlyprintk=serial console=ttyS0 acpi=off root=/dev/vda1 ro&quot;

MEM=&quot;-m 1G&quot;
#SMP=&quot;-c 2&quot;
NET=&quot;-s 2:0,virtio-net&quot;
IMG_HDD=&quot;-s 4,virtio-blk,ubuntu/hdd.img&quot;
PCI_DEV=&quot;-s 0:0,hostbridge -s 31,lpc&quot;
LPC_DEV=&quot;-l com1,stdio&quot;

build/xhyve $MEM $SMP $PCI_DEV $LPC_DEV $NET $IMG_CD $IMG_HDD -f kexec,$KERNEL,$INITRD,&quot;$CMDLINE&quot;
EOF
</pre></div>


<p>スクリプトに実行パーミションをつけてsudo付きで実行してUbuntuを起動します。</p>
<div class="highlight"><pre><span></span>chmod +x ./xhyverun_ubuntu.sh
sudo ./xhyverun_ubuntu.sh
</pre></div>


<p>起動してログインプロンプトが出たらインストール時に作成したユーザでログインします。IPアドレスはDHCPで取得する設定にしたのですが、確認してみると、ディスクイメージ作成時とは違う値になっていました。</p>
<div class="highlight"><pre><span></span>$ ip a s eth0
<span class="m">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc pfifo_fast state UP group default qlen <span class="m">1000</span>
    link/ether <span class="m">62</span>:ca:c1:25:cf:32 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">192</span>.168.64.4/24 brd <span class="m">192</span>.168.64.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::60ca:c1ff:fe25:cf32/64 scope link
       valid_lft forever preferred_lft forever
</pre></div>


<p>Macからsshでログインも出来ました。</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="n">ubuntu</span><span class="mf">@192.168.64.4</span>
</pre></div>


<p>sshでログインすると初回だけ表示が24行に限定され、リターンを押しても24行の範囲でスクロールされるようになってしまいました。Mac側ではiTermで65行にしていました。と、この説明を書くためにiTermのウィンドウで高さを変えて行数を変えて戻してとやっていたら、次のsshログインからはiTermの行数で表示されるようになりました。</p>
<p>Ubuntuを停止するにはVM内で以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span>sudo shutdown -h now
</pre></div>


<h2>Ubuntuの起動に必要なファイル</h2>
<p>ubuntuフォルダにはビルドに使用したファイルも含まれていますが、起動スクリプトで参照されているファイル以外のファイルを別ディレクトリに移動して起動してみたら起動出来ました。ということで、起動には以下の4つのファイルだけあればOKです。</p>
<div class="highlight"><pre><span></span>./xhyverun_ubuntu.sh
ubuntu/boot/initrd.img-3.16.0-30-generic
ubuntu/boot/vmlinuz-3.16.0-30-generic
ubuntu/hdd.img
</pre></div>


<h1>まとめ</h1>
<p>xhyveをソースからビルドして、Tiny Core LinuxとUbuntu Server 14.04.2を動かしてみました。<a href="https://github.com/mist64/xhyve#todo">TODO</a>によると、まだいろいろ対応予定の項目があるようです。今後が楽しみです！</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>