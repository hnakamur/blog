<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>LuaのGo実装GopherLuaを試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2015/06/03/tried_gopher_lua/" rel="bookmark"
           title="Permalink to LuaのGo実装GopherLuaを試してみた">LuaのGo実装GopherLuaを試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-06-03T05:29:00+09:00">
                Published: 2015-06-03
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/go.html">go</a> <a href="../../../../tag/lua.html">lua</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p><a href="http://inforno.net/articles/2015/02/15/gopher-lua-released">inforno :: LuaのGo言語実装を公開しました</a>を以前読んでましたが、試してなかったので試しました。</p>
<p><a href="http://www.lua.org/about.html">Lua: about</a>の"What is Lua?"に</p>
<blockquote>
<p>making it ideal for configuration, scripting, and rapid prototyping.</p>
</blockquote>
<p>とあるようにLuaは設定ファイルとして使うことも想定されています。</p>
<p>ということで試してみました。</p>
<h2>GopherLuaの利用例</h2>
<p>hello.lua</p>
<div class="highlight"><pre><span></span>print(&quot;hello&quot;)

a = 2
b = {
    c = 4,
    d = a + 3
}
</pre></div>


<p>main.go</p>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s2">&quot;fmt&quot;</span>

    <span class="s2">&quot;github.com/yuin/gopher-lua&quot;</span>
<span class="p">)</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">l</span> <span class="p">:</span><span class="o">=</span> <span class="n">lua</span><span class="o">.</span><span class="n">NewState</span><span class="p">()</span>
    <span class="n">defer</span> <span class="n">l</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">err</span> <span class="p">:</span><span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">DoFile</span><span class="p">(</span><span class="s2">&quot;hello.lua&quot;</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">a</span> <span class="p">:</span><span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">GetGlobal</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">&quot;a=%v</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

    <span class="n">b</span> <span class="p">:</span><span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">GetGlobal</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">lua</span><span class="o">.</span><span class="n">LTable</span><span class="p">)</span>
    <span class="n">b</span><span class="o">.</span><span class="n">ForEach</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="n">lua</span><span class="o">.</span><span class="n">LValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">&quot;b.%v=%v</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>


<p>実行結果</p>
<div class="highlight"><pre><span></span>$ go run main.go
hello
<span class="nv">a</span><span class="o">=</span><span class="m">2</span>
b.c<span class="o">=</span><span class="m">4</span>
b.d<span class="o">=</span><span class="m">5</span>
</pre></div>


<p>hello.luaに <code>print("hello")</code> を入れているのはLuaからの出力を試してみたかったからで、実際に設定ファイルとして使うときは変数設定だけの使い方になるでしょう。</p>
<p>上記では単に値を出力していますが、変数の値がプリミティブの場合は</p>
<ul>
<li><a href="http://godoc.org/github.com/yuin/gopher-lua#LVAsBool">LVAsBool</a></li>
<li><a href="http://godoc.org/github.com/yuin/gopher-lua#LVAsString">LVAsString</a></li>
<li><a href="http://godoc.org/github.com/yuin/gopher-lua#LVAsNumber">LVAsNumber</a></li>
</ul>
<p>を使えばbool, string, LNumberに変換できます。</p>
<p><a href="http://godoc.org/github.com/yuin/gopher-lua#LNumber">LNumberの定義</a> を見ると</p>
<div class="highlight"><pre><span></span>type LNumber float64
</pre></div>


<p>となっているので、Goでも数値として扱えます。</p>
<p>なお、<a href="http://www.lua.org/manual/5.3/manual.html#8.1">Luaは5.3で数値に整数型が追加されています</a>が、<a href="https://github.com/yuin/gopher-lua">gopher-lua</a>はLua 5.1相当なので数値型は64bit浮動小数点数のみです。</p>
<p>で、table (ハッシュテーブル) 型は <code>lua.LValue</code> から <code>.(*lua.Table)</code> でTableに変換できます。</p>
<p>ちなみに、<a href="http://www.lua.org/manual/5.1/manual.html#2.2">2.2 – Values and Type - sLua 5.1 Reference Manual</a>にあるようにLuaのtable型は連想配列と整数インデクスでの配列を兼用したデータ型となっています。</p>
<h2>まとめ</h2>
<p>設定ファイルをLuaで書くようにすると、上記の hello.lua で <code>b.d</code> を <code>a + 3</code> としているように変数や式が使えます。</p>
<p>table型があるのでネストしたデータ構造も表現できます。</p>
<p>ということで、Goのプログラムの設定ファイルをluaで書いて<a href="https://github.com/yuin/gopher-lua">gopher-lua</a>で解釈するというのは、かなり便利そうですね。今後活用していきたいです。yuinさん、便利なライブラリをありがとうございます！</p>
<h2>2015-06-03 21:35 頃追記</h2>
<p>作者の方からご指摘頂いたのですが、LValueからTableへの変換方法はREADMEの<a href="https://github.com/yuin/gopher-lua#data-model">Data model</a>に書いてありました。失礼いたしました。</p>
<p>またLuaを設定ファイルとして使う場合は、そのためのライブラリも書かれているので、そちらを使うほうがよいそうです。
<a href="http://inforno.net/articles/2015/03/23/gluamapper-released">inforno :: GopherLuaを設定ファイルで使うライブラリを書きました</a>をご参照ください。Goのstructの各フィールドの値をLuaのtableのデータに応じて設定してくれます。ますます便利ですね！</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>