<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Cybozu Garoon APIのファイル管理の部分だけのgoライブラリを書いた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2015/06/15/garoon_go_client/" rel="bookmark"
           title="Permalink to Cybozu Garoon APIのファイル管理の部分だけのgoライブラリを書いた">Cybozu Garoon APIのファイル管理の部分だけのgoライブラリを書いた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-06-15T20:24:00+09:00">
                Published: 2015-06-15
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/go.html">go</a> <a href="../../../../tag/xml.html">xml</a> </p>
</footer><!-- /.post-info -->      <h1>はじめに</h1>
<p>Cybozu <a href="https://cybozudev.zendesk.com/hc/ja/categories/200157760-Garoon-API">Garoon API</a>のファイル管理のうち、フォルダ一覧取得、フォルダ内のファイル一覧取得、ファイルダウンロードのAPIを呼び出すライブラリをGoで書いてみました。</p>
<p>ただし、汎用的なライブラリではなく、自分が必要な機能のみを実装しています。レスポンスの中の項目も自分が必要な部分だけ取り出して残りは破棄しています。
<a href="http://blog.sigbus.info/2015/01/p1.html">sigbus.info: コードを書くことは無限の可能性を捨てて一つのやり方を選ぶということ</a>を読んでから、汎用性をあまり気にせず自分の用途に合わせて書くようになって楽で良いです。</p>
<h1>実装方法についてのメモ</h1>
<p>まず、Garoon APIの手動での呼び出し方は<a href="http://qiita.com/yamasaki-masahide/items/fff1c84e65043ac4caf7">garoon - Cybozu ガルーン API を使ってみる - Qiita</a>を参考にして試してみました。</p>
<h2>リクエストのXML組み立て</h2>
<p>Garoon APIはSOAPなので、リクエストやレスポンスはXMLになります。</p>
<p>リクエストを送るところは<a href="http://qiita.com/yamasaki-masahide/items/03dfa6cd70ff20607b58">Cybozu ガルーン API を golang で叩いてみる - Qiita</a>を見たのですが、<a href="http://qiita.com/ono_matope/items/70080cc33b75152c5c2a">Goのencoding/xmlを使いこなす - Qiita</a>を参考にMarshalXMLを実装する方式にしてみました。</p>
<p><a href="http://golang.org/pkg/encoding/xml/#Marshaler">xml.Marshaler</a>の <code>MarshalXML(e *Encoder, start StartElement) error</code> は <code>start</code> をエンコードするのが本来の使い方だとは思うのですが、下記の例のように <code>CabinetGetFolderInfo</code> といったリクエスト本体を渡すと <code>soap:Envelope</code> でラップしてエンコードしてくれる方が使うときに楽なので、 <code>MarshalXML</code> 内でデータ構造を組み立ててエンコードするようにしてみました。</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;soap:Envelope</span> <span class="na">xmlns:soap=</span><span class="s">&quot;http://www.w3.org/2003/05/soap-envelope&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;soap:Header&gt;</span>
    <span class="nt">&lt;Action&gt;</span>CabinetGetFolderInfo<span class="nt">&lt;/Action&gt;</span>
    <span class="nt">&lt;Security&gt;</span>
      <span class="nt">&lt;UsernameToken&gt;</span>
        <span class="nt">&lt;Username&gt;</span>foo<span class="nt">&lt;/Username&gt;</span>
        <span class="nt">&lt;Password&gt;</span>password<span class="nt">&lt;/Password&gt;</span>
      <span class="nt">&lt;/UsernameToken&gt;</span>
    <span class="nt">&lt;/Security&gt;</span>
    <span class="nt">&lt;Timestamp&gt;</span>
      <span class="nt">&lt;Created&gt;</span>2010-08-12T14:45:00Z<span class="nt">&lt;/Created&gt;</span>
      <span class="nt">&lt;Expires&gt;</span>2037-08-12T14:45:00Z<span class="nt">&lt;/Expires&gt;</span>
    <span class="nt">&lt;/Timestamp&gt;</span>
    <span class="nt">&lt;Locale&gt;</span>jp<span class="nt">&lt;/Locale&gt;</span>
  <span class="nt">&lt;/soap:Header&gt;</span>
  <span class="nt">&lt;soap:Body&gt;</span>
    <span class="nt">&lt;CabinetGetFolderInfo&gt;</span>
      <span class="nt">&lt;parameters&gt;&lt;/parameters&gt;</span>
    <span class="nt">&lt;/CabinetGetFolderInfo&gt;</span>
  <span class="nt">&lt;/soap:Body&gt;</span>
<span class="nt">&lt;/soap:Envelope&gt;</span>
</pre></div>


<p><code>soap:Envelope</code> でラップした構造を作るところは、</p>
<p>https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/request.go#L44-L62</p>
<div class="highlight"><pre><span></span><span class="nv">func</span> <span class="nv">buildRequestStruct</span><span class="ss">(</span><span class="nv">h</span> <span class="nv">RequestHeader</span>, <span class="nv">apiName</span> <span class="nv">string</span>, <span class="nv">parameters</span> <span class="nv">interface</span>{}<span class="ss">)</span> <span class="nv">envelope</span> {
    <span class="k">return</span> <span class="nv">envelope</span>{
        <span class="nv">Xmlns</span>: <span class="s2">&quot;</span><span class="s">http://www.w3.org/2003/05/soap-envelope</span><span class="s2">&quot;</span>,
        <span class="nv">Header</span>: <span class="nv">header</span>{
            <span class="nv">Action</span>:   <span class="nv">apiName</span>,
            <span class="nv">Username</span>: <span class="nv">h</span>.<span class="nv">Username</span>,
            <span class="nv">Password</span>: <span class="nv">h</span>.<span class="nv">Password</span>,
            <span class="nv">Created</span>:  <span class="nv">h</span>.<span class="nv">Created</span>,
            <span class="nv">Expires</span>:  <span class="nv">h</span>.<span class="nv">Expires</span>,
            <span class="nv">Locale</span>:   <span class="nv">h</span>.<span class="nv">Locale</span>,
        },
        <span class="nv">Body</span>: <span class="nv">body</span>{
            <span class="nv">Content</span>: <span class="nv">bodyContent</span>{
                <span class="nv">XMLName</span>:    <span class="nv">xml</span>.<span class="nv">Name</span>{<span class="nv">Local</span>: <span class="nv">apiName</span>},
                <span class="nv">Parameters</span>: <span class="nv">parameters</span>,
            },
        },
    }
}
</pre></div>


<p>で共通処理として実装し、各API用のリクエストの構造体では</p>
<p>https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/cabinet.go#L16-L26</p>
<div class="highlight"><pre><span></span><span class="nv">type</span> <span class="nv">CabinetGetFolderInfoRequest</span> <span class="nv">struct</span> {
    <span class="nv">Header</span> <span class="nv">RequestHeader</span>
}

<span class="nv">func</span> <span class="ss">(</span><span class="nv">r</span> <span class="nv">CabinetGetFolderInfoRequest</span><span class="ss">)</span> <span class="nv">MarshalXML</span><span class="ss">(</span><span class="nv">e</span> <span class="o">*</span><span class="nv">xml</span>.<span class="nv">Encoder</span>, <span class="nv">start</span> <span class="nv">xml</span>.<span class="nv">StartElement</span><span class="ss">)</span> <span class="nv">error</span> {
    <span class="k">return</span> <span class="nv">e</span>.<span class="nv">Encode</span><span class="ss">(</span><span class="nv">buildRequestStruct</span><span class="ss">(</span>
        <span class="nv">r</span>.<span class="nv">Header</span>,
        <span class="s2">&quot;</span><span class="s">CabinetGetFolderInfo</span><span class="s2">&quot;</span>,
        <span class="nv">struct</span>{}{},
    <span class="ss">))</span>
}
</pre></div>


<p>のようにして呼び出しています。</p>
<p>また、日時の項目は構造体側では <code>time.Time</code> にしたいところですが、<a href="https://code.google.com/p/go/issues/detail?id=2771#c2">Issue 2771 - go - encoding/xml: MarshalXML interface is not good enough - The Go Programming Language - Google Project Hosting</a>の<a href="https://code.google.com/p/go/issues/detail?id=2771#c2">コメント#2</a>を読んで <code>string</code> にしました。</p>
<h2>レスポンスのパース処理</h2>
<p>レスポンスのパースは<a href="http://qiita.com/yamasaki-masahide/items/f20a2ca4700e00777303">Cybozu ガルーン API のレスポンスのXMLを golang でパースする - Qiita</a>を見たのですが、<a href="http://blog.davidsingleton.org/parsing-huge-xml-files-with-go/">Parsing huge XML files with Go - david singleton</a>の方法のほうが楽なのでこちらを参考にしました。</p>
<p>共通のユーテリティ関数としては
https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/response.go</p>
<div class="highlight"><pre><span></span><span class="nv">var</span> <span class="nv">ResponseTagNotFoundError</span> <span class="o">=</span> <span class="nv">errors</span>.<span class="nv">New</span><span class="ss">(</span><span class="s2">&quot;</span><span class="s">response tag not found</span><span class="s2">&quot;</span><span class="ss">)</span>

<span class="nv">func</span> <span class="nv">parseResponse</span><span class="ss">(</span><span class="nv">r</span> <span class="nv">io</span>.<span class="nv">Reader</span>, <span class="nv">localName</span> <span class="nv">string</span>, <span class="nv">v</span> <span class="nv">interface</span>{}<span class="ss">)</span> <span class="nv">error</span> {
    <span class="nv">decoder</span> :<span class="o">=</span> <span class="nv">xml</span>.<span class="nv">NewDecoder</span><span class="ss">(</span><span class="nv">r</span><span class="ss">)</span>
    <span class="k">for</span> {
        <span class="nv">t</span>, <span class="nv">_</span> :<span class="o">=</span> <span class="nv">decoder</span>.<span class="nv">Token</span><span class="ss">()</span>
        <span class="k">if</span> <span class="nv">t</span> <span class="o">==</span> <span class="nv">nil</span> {
            <span class="k">break</span>
        }
        <span class="nv">switch</span> <span class="nv">se</span> :<span class="o">=</span> <span class="nv">t</span>.<span class="ss">(</span><span class="nv">type</span><span class="ss">)</span> {
        <span class="nv">case</span> <span class="nv">xml</span>.<span class="nv">StartElement</span>:
            <span class="k">if</span> <span class="nv">se</span>.<span class="nv">Name</span>.<span class="nv">Local</span> <span class="o">==</span> <span class="nv">localName</span> {
                <span class="k">return</span> <span class="nv">decoder</span>.<span class="nv">DecodeElement</span><span class="ss">(</span><span class="nv">v</span>, <span class="o">&amp;</span><span class="nv">se</span><span class="ss">)</span>
            }
        }
    }
    <span class="k">return</span> <span class="nv">ResponseTagNotFoundError</span>
}
</pre></div>


<p>のように定義して、</p>
<p>https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/cabinet.go#L115-L127</p>
<div class="highlight"><pre><span></span><span class="nv">func</span> <span class="nv">parseCabinetGetFolderInfoResponse</span><span class="ss">(</span><span class="nv">r</span> <span class="nv">io</span>.<span class="nv">Reader</span><span class="ss">)</span> <span class="ss">(</span><span class="o">*</span><span class="nv">CabinetGetFolderInfoResponse</span>, <span class="nv">error</span><span class="ss">)</span> {
    <span class="nv">exclude</span> :<span class="o">=</span> <span class="nv">NewExclude</span><span class="ss">(</span><span class="nv">func</span><span class="ss">(</span><span class="nv">b</span> <span class="nv">byte</span><span class="ss">)</span> <span class="nv">bool</span> {
        <span class="k">return</span> <span class="nv">b</span> <span class="o">==</span> <span class="mi">0</span><span class="nv">x08</span> <span class="o">||</span> <span class="nv">b</span> <span class="o">==</span> <span class="mi">0</span><span class="nv">x0B</span>
    }<span class="ss">)</span>
    <span class="nv">r2</span> :<span class="o">=</span> <span class="nv">transform</span>.<span class="nv">NewReader</span><span class="ss">(</span><span class="nv">r</span>, <span class="nv">exclude</span><span class="ss">)</span>
    <span class="nv">var</span> <span class="nv">resp</span> <span class="nv">CabinetGetFolderInfoResponse</span>
    <span class="nv">err</span> :<span class="o">=</span> <span class="nv">parseResponse</span><span class="ss">(</span><span class="nv">r2</span>, <span class="s2">&quot;</span><span class="s">CabinetGetFolderInfoResponse</span><span class="s2">&quot;</span>, <span class="o">&amp;</span><span class="nv">resp</span><span class="ss">)</span>
    <span class="k">if</span> <span class="nv">err</span> <span class="o">!=</span> <span class="nv">nil</span> {
        <span class="k">return</span> <span class="nv">nil</span>, <span class="nv">err</span>
    }
    <span class="nv">resp</span>.<span class="nv">fillPath</span><span class="ss">()</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nv">resp</span>, <span class="nv">err</span>
}
</pre></div>


<p>という感じで呼び出しています。</p>
<h2>レスポンスからU+0008などの制御文字を除去</h2>
<p>あと、レスポンスのXMLをそのまま<a href="http://golang.org/pkg/encoding/xml/#Decoder">xml.Decoder</a>に渡すとUTF-8の不正なバイト列といったエラーが出ました。U+0008やU+000Bというデータが入っていたので、これを除去するようにしました。</p>
<p>日本語の文字コード変換用のライブラリ<a href="https://godoc.org/golang.org/x/text/encoding/japanese">golang.org/x/text/encoding/japanese</a>で使っているインターフェース<a href="https://godoc.org/golang.org/x/text/transform#Transformer">golang.org/x/text/transform/Transformer</a>に合わせて実装しました。</p>
<p>https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/cabinet.go#L28-L50</p>
<div class="highlight"><pre><span></span><span class="nv">type</span> <span class="nv">exclude</span> <span class="nv">struct</span> {
    <span class="nv">transform</span>.<span class="nv">NopResetter</span>
    <span class="nv">excluder</span> <span class="nv">func</span><span class="ss">(</span><span class="nv">byte</span><span class="ss">)</span> <span class="nv">bool</span>
}

<span class="nv">func</span> <span class="nv">NewExclude</span><span class="ss">(</span><span class="nv">excluder</span> <span class="nv">func</span><span class="ss">(</span><span class="nv">byte</span><span class="ss">)</span> <span class="nv">bool</span><span class="ss">)</span> <span class="nv">transform</span>.<span class="nv">Transformer</span> {
    <span class="k">return</span> <span class="nv">exclude</span>{<span class="nv">excluder</span>: <span class="nv">excluder</span>}
}

<span class="nv">func</span> <span class="ss">(</span><span class="nv">e</span> <span class="nv">exclude</span><span class="ss">)</span> <span class="nv">Transform</span><span class="ss">(</span><span class="nv">dst</span>, <span class="nv">src</span> []<span class="nv">byte</span>, <span class="nv">atEOF</span> <span class="nv">bool</span><span class="ss">)</span> <span class="ss">(</span><span class="nv">nDst</span>, <span class="nv">nSrc</span> <span class="nv">int</span>, <span class="nv">err</span> <span class="nv">error</span><span class="ss">)</span> {
    <span class="k">for</span> <span class="nv">nSrc</span> <span class="o">=</span> <span class="mi">0</span><span class="c1">; nSrc &lt; len(src); nSrc++ {</span>
        <span class="nv">b</span> :<span class="o">=</span> <span class="nv">src</span>[<span class="nv">nSrc</span>]
        <span class="k">if</span> <span class="o">!</span><span class="nv">e</span>.<span class="nv">excluder</span><span class="ss">(</span><span class="nv">b</span><span class="ss">)</span> {
            <span class="k">if</span> <span class="nv">nDst</span> <span class="o">&gt;=</span> <span class="nv">len</span><span class="ss">(</span><span class="nv">dst</span><span class="ss">)</span> {
                <span class="nv">err</span> <span class="o">=</span> <span class="nv">transform</span>.<span class="nv">ErrShortDst</span>
                <span class="k">return</span>
            }
            <span class="nv">dst</span>[<span class="nv">nDst</span>] <span class="o">=</span> <span class="nv">b</span>
            <span class="nv">nDst</span><span class="o">++</span>
        }
    }
    <span class="k">return</span>
}
</pre></div>


<p>利用するときは<a href="https://godoc.org/golang.org/x/text/transform#NewReader">golang.org/x/text/transform/NewReader</a>を使います。</p>
<h1>まとめ</h1>
<p>Cybozu Garoon APIの一部のクライアントライブラリをGoで実装しました。</p>
<ul>
<li>MarshalXMLを実装することで、構造体とXMLの構造がかなり違う場合でも、XMLに合わせて一々構造体を定義することなく楽に対応出来ました。</li>
<li><a href="http://golang.org/pkg/encoding/xml/#Decoder.Token">xml.DecoderのToken</a>を使うことでXMLの一部だけをパースしました。</li>
<li>制御文字除去の処理を<a href="https://godoc.org/golang.org/x/text/transform#Transformer">golang.org/x/text/transform/Transformer</a>インタフェースに合わせて実装しました。</li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>