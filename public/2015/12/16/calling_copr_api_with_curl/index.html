<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <title>coprのAPIをcurlで呼び出す &middot; hnakamur&#39;s blog at github</title>
        <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css'>
        <link rel="stylesheet" href="/blog//libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="/blog//css/liquorice.css" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="alternate" href="" type="application/rss+xml" title="hnakamur&#39;s blog at github" />
        
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', "UA-53263855-1", 'auto');
    ga('send', 'pageview');
</script>


    </head>
    <body class="li-body">

<header class="li-page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="/blog/">hnakamur&#39;s blog at github</a></div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                </ul>
            </div>
        </div>
    </div>
</header>


    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">coprのAPIをcurlで呼び出す</h1>
                        <time class="li-article-date">2015-12-16</time>
                    </header>
                    <section>
                        

<h2 id="はじめに:d97aa5d91864f67b35847063abc7f579">はじめに</h2>

<p><a href="https://fedorahosted.org/copr/">copr</a>を利用するには以下の3つの手段があります。</p>

<ul>
<li>ウェブ管理画面を使う

<ul>
<li><a href="https://fedorahosted.org/copr/wiki/ScreenshotsTutorial">スクリーンショットつきのチュートリアル</a></li>
</ul></li>
<li><a href="https://apps.fedoraproject.org/packages/copr-cli">copr-cli</a>というコマンドラインツールを使う

<ul>
<li>内部的に下記の<a href="https://copr.fedoraproject.org/api/">API for Copr</a>を呼び出しています</li>
</ul></li>
<li><a href="https://copr.fedoraproject.org/api/">API for Copr</a>を使う</li>
</ul>

<h2 id="copr-cliを使わずにcurlでapiを呼ぶ理由:d97aa5d91864f67b35847063abc7f579">copr-cliを使わずにcurlでAPIを呼ぶ理由</h2>

<p>折角copr-cliというコマンドラインツールが用意されているのでそれを活用すれば良いのですが、以下のような問題に遭遇したのでAPIをcurlで呼ぶようにしてみました。</p>

<ul>
<li>CentOS 7でyumでインストールできるcopr-cliはバージョンが古くてsrpmのアップロード機能が未サポート</li>
<li>CentOS 7のPythonが古いのでInsecurePlatformWarningが出てしまう</li>
</ul>

<h3 id="centos-7でyumでインストールできるcopr-cliはバージョンが古くてsrpmのアップロード機能が未サポート:d97aa5d91864f67b35847063abc7f579">CentOS 7でyumでインストールできるcopr-cliはバージョンが古くてsrpmのアップロード機能が未サポート</h3>

<p>正確にはcopr-cliが利用している<a href="https://apps.fedoraproject.org/packages/python-copr/">python-copr</a>のバージョンの問題です。
<a href="https://apps.fedoraproject.org/packages/python-copr/changelog">python-coprのChangelog</a>を見ると1.58-1でsrpmをアップロードする機能が追加されています。</p>

<p>一方、CentOS 7のepelにあるpython-coprは1.57-1です。srpmをアップロードする機能を使わないとなると、インターネット上にsrpmを置いてURLを指定する必要があり面倒です。</p>

<h3 id="centos-7のpythonが古いのでinsecureplatformwarningが出てしまう:d97aa5d91864f67b35847063abc7f579">CentOS 7のPythonが古いのでInsecurePlatformWarningが出てしまう</h3>

<p>copr-cliはpipからインストールすれば1.58-1が使えて解決と思ったのですが、今度はPythonのバージョンが古くてhttps通信時にInsecurePlatformWarningが出ました。</p>

<p><a href="https://urllib3.readthedocs.org/en/latest/security.html#insecureplatformwarning">Security: Verified HTTPS with SSL/TLS — urllib3 dev documentation</a>を見るとPythonを2.7.9以上にするのが一番理想なのですが、CentOS 7に入っているPythonは2.7.5です。
softwarecollection.orgの<a href="https://www.softwarecollections.org/repos/rhscl/python27/epel-7-x86_64/python27-python-2.7.8-3.el7/">python27-python</a>でも2.7.8です。</p>

<p><a href="https://urllib3.readthedocs.org/en/latest/security.html#without-modifying-code">Without modifying code</a>の手順で警告を無視するというあまり良くない方法も使ってみたのですが、手元のDocker環境ではよかったもののTravis CIだとエラーになってしまうという現象が起きました。</p>

<h2 id="copr-apiの認証方法:d97aa5d91864f67b35847063abc7f579">copr APIの認証方法</h2>

<p>というわけでcopr-cliを使わずにcurlでCoprのAPIを呼び出す方法を調べました。</p>

<p>まずは認証ですが、<a href="https://copr.fedoraproject.org/api/">API for Copr</a>の先頭にcopr-cli用の設定ファイル形式でAPIトークンの情報が表示されています。が、APIの認証方法は記載されていません。</p>

<p>しかたがないので、python-coprのソースを読んでみるとcopr/client/client.pyに以下のようなコードがありました。</p>

<pre><code>...(snip)...
    def _fetch(self, url, data=None, username=None, method=None,
               skip_auth=False, on_error_response=None, headers=None):
...(snip)...
        if not skip_auth:
            kwargs[&quot;auth&quot;] = (self.login, self.token)
...(snip)...
        try:
            response = requests.request(
                method=method.upper(),
                url=url,
                **kwargs
            )
...(snip)...
</code></pre>

<p><a href="http://docs.python-requests.org/en/latest/">PythonのRequestsライブラリ</a>の<a href="http://docs.python-requests.org/en/latest/user/authentication/#basic-authentication">Basic Authentication</a>のドキュメントを見ると、上記のコードは <code>self.login</code> の値をユーザ名、 <code>self.token</code> の値をパスワードとしてBASIC認証していることがわかりました。</p>

<h2 id="apiの呼び出し例:d97aa5d91864f67b35847063abc7f579">APIの呼び出し例</h2>

<p><a href="https://github.com/hnakamur/nginx-rpm/">hnakamur/nginx-rpm</a>の<a href="https://github.com/hnakamur/nginx-rpm/blob/358d646a22c9c516a9247595e296b256d61a86f6/scripts/build.sh#L72-L95">scripts/build.sh</a>のコードで説明します。</p>

<pre><code>build_rpm_on_copr() {
  build_srpm

  # Check the project is already created on copr.
  status=`curl -s -o /dev/null -w &quot;%{http_code}&quot; https://copr.fedoraproject.org/api/coprs/${COPR_USERNAME}/${copr_project_name}/detail/`
  if [ $status = &quot;404&quot; ]; then
    # Create the project on copr.
    # We call copr APIs with curl to work around the InsecurePlatformWarning problem
    # since system python in CentOS 7 is old.
    # I read the source code of https://pypi.python.org/pypi/copr/1.62.1
    # since the API document at https://copr.fedoraproject.org/api/ is old.
    curl -s -X POST -u &quot;${COPR_LOGIN}:${COPR_TOKEN}&quot; \
      --data-urlencode &quot;name=${copr_project_name}&quot; \
      --data-urlencode &quot;${mock_chroot}=y&quot; \
      --data-urlencode &quot;description=$copr_project_description&quot; \
      --data-urlencode &quot;instructions=$copr_project_instructions&quot; \
      https://copr.fedoraproject.org/api/coprs/${COPR_USERNAME}/new/
  fi
  # Add a new build on copr with uploading a srpm file.
  curl -s -X POST -u &quot;${COPR_LOGIN}:${COPR_TOKEN}&quot; \
    -F &quot;${mock_chroot}=y&quot; \
    -F &quot;pkgs=@${topdir}/SRPMS/${srpm_file};type=application/x-rpm&quot; \
    https://copr.fedoraproject.org/api/coprs/${COPR_USERNAME}/${copr_project_name}/new_build_upload/
}
</code></pre>

<p>最初の <code>https://copr.fedoraproject.org/api/coprs/${COPR_USERNAME}/${copr_project_name}/detail/</code> はプロジェクトの詳細情報取得です。これはログイン不要です。</p>

<p>次の <code>https://copr.fedoraproject.org/api/coprs/${COPR_USERNAME}/new/</code> にPOSTしているのがプロジェクト作成です。</p>

<p>最後の <code>https://copr.fedoraproject.org/api/coprs/${COPR_USERNAME}/${copr_project_name}/new_build_upload/</code> がsrpmをアップロードしてビルド開始のAPIです。<a href="https://copr.fedoraproject.org/api/">API for Copr</a>には <code>/new_build/</code> は記載がありますが、 <code>/new_build_upload/</code> は記載が無いです。python-coprのcopr/client/client.pyのソースで見つけました。</p>

<pre><code>...(snip)...
    def create_new_build(self, projectname, pkgs, username=None,
                         timeout=None, memory=None, chroots=None,
                         progress_callback=None):
...(snip)...
        if urlparse(pkgs[0]).scheme != &quot;&quot;:
            api_endpoint = &quot;new_build&quot;
            data[&quot;pkgs&quot;] = &quot; &quot;.join(pkgs)
        else:
            try:
                api_endpoint = &quot;new_build_upload&quot;
                f = open(pkgs[0], &quot;rb&quot;)
                data[&quot;pkgs&quot;] = (os.path.basename(f.name), f, &quot;application/x-rpm&quot;)
            except IOError as e:
                raise CoprRequestException(e)

        url = &quot;{0}/coprs/{1}/{2}/{3}/&quot;.format(
            self.api_url, username, projectname, api_endpoint
        )
...(snip)...
</code></pre>

<h2 id="まとめ:d97aa5d91864f67b35847063abc7f579">まとめ</h2>

<p><a href="https://copr.fedoraproject.org/api/">API for Copr</a>のAPIドキュメントが不完全ですが、python-coprのソースを参考にしてcurlでCopr APIを呼び出すことが出来ました。</p>

<p>これによりCentOS 7でcopr-cliやPythonのバージョンが古いことによる問題を回避できるので良かったです。curlでのcopr APIの呼び出しも上記のようにシンプルに書けるのでこれで十分だと思います。</p>

                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <a href="https://hnakamur.github.io"><strong>Hiroaki Nakamura</strong></a>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="/blog/2015/12/16/how_to_debug_errors_in_rpm_build_using_mock/"> mockを使ったrpmビルドが失敗した時の調査方法</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="/blog/2015/12/15/using_mock_and_copr_to_build_nginx_rpm_on_docker/"> nginxのカスタムrpmをmockでビルドできることを確認してからcoprでビルド・配布する環境を作りました</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2012-2015. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="http://github.com/hnakamur/liquorice-hn/">liquorice-hn</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript">
    <!--
    function toggle(id) {
        var e = document.getElementById(id);
        e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
    }
    
    </script>
    </body>
</html>

