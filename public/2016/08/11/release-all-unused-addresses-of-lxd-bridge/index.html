<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>LXDのDHCPで使っていないIPアドレスを一括で解放するスクリプトを書いた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/08/11/release-all-unused-addresses-of-lxd-bridge/" rel="bookmark"
           title="Permalink to LXDのDHCPで使っていないIPアドレスを一括で解放するスクリプトを書いた">LXDのDHCPで使っていないIPアドレスを一括で解放するスクリプトを書いた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-08-11T22:58:00+09:00">
                Published: 2016-08-11
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/lxd.html">lxd</a> <a href="../../../../tag/dnsmasq.html">dnsmasq</a> </p>
</footer><!-- /.post-info -->      <p><a href="/blog/2016/05/07/how-to-use-fixed-ip-address-for-a-lxd-container/">LXDコンテナで固定IPアドレスを使うための設定 · hnakamur's blog at github</a> の設定を行ってもIPアドレスが指定通りにならないことがありました。</p>
<p><code>journal -xe</code> で見てみると</p>
<div class="highlight"><pre><span></span>Aug 11 22:46:55 bai1b7faf04 dnsmasq-dhcp[11082]: not using configured address 10.155.92.102 because it is leased to 00:16:3e:1e:08:8a
</pre></div>


<p>というメッセージが出ていて、他のMACアドレスに貸出中になっています。</p>
<p>ググってみると <a href="http://www.linuxquestions.org/questions/linux-newbie-8/dnsmasq-force-release-renew-of-dhcp-clients-how-933535/">[SOLVED] dnsmasq force release/renew of dhcp clients, how?</a> に回答がありました。</p>
<h2>使っていないIPアドレスを手動で消す</h2>
<div class="highlight"><pre><span></span>sudo systemctl stop lxd-bridge
</pre></div>


<p>で止めて</p>
<div class="highlight"><pre><span></span>sudo vi /var/lib/lxd-bridge/dnsmasq.lxdbr0.leases
</pre></div>


<p>で使っていないIPアドレスの行を全て削除します。</p>
<p>その後</p>
<div class="highlight"><pre><span></span>sudo systemctl start lxd-bridge
</pre></div>


<p>で再起動します。</p>
<h2>自動で消すスクリプトも書きました</h2>
<p>これでよいかと思ったら、
http://lists.thekelleys.org.uk/pipermail/dnsmasq-discuss/2013q3/007356.html
を見て <code>dhcp_release</code> というコマンドを使えば <code>lxd-bridge</code> の再起動が不要なことを知りました。</p>
<p>ということでスクリプトを書いてみました。
https://gist.github.com/hnakamur/7ed3f7c6175817b633586a1b468bd5c1</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nb">set</span> -eu

<span class="c1"># Set value of LXD_BRIDGE</span>
. /etc/default/lxd-bridge

<span class="nv">addr_list_file</span><span class="o">=</span>/tmp/lxd-addr-list.<span class="sb">`</span>date +%Y-%m-%dT%H:%M:%S<span class="sb">`</span>
lxc list <span class="p">|</span> awk <span class="s1">&#39;$4==&quot;RUNNING&quot;{print $6}&#39;</span> &gt; <span class="nv">$addr_list_file</span>
cleanup<span class="o">()</span> <span class="o">{</span>
  rm <span class="nv">$addr_list_file</span>
<span class="o">}</span>
<span class="nb">trap</span> cleanup EXIT

awk -v <span class="nv">addr_list_file</span><span class="o">=</span><span class="nv">$addr_list_file</span> -v <span class="nv">interface</span><span class="o">=</span><span class="nv">$LXD_BRIDGE</span> <span class="s1">&#39;{</span>
<span class="s1">  mac_addr = $2</span>
<span class="s1">  addr = $3</span>
<span class="s1">  ret = system(sprintf(&quot;awk -v addr=%s &#39;</span><span class="se">\&#39;</span><span class="s1">&#39;BEGIN{rc=1} $1==addr{rc=0} END{exit rc}&#39;</span><span class="se">\&#39;</span><span class="s1">&#39; %s&quot;, addr,  addr_list_file))</span>
<span class="s1">  if (ret == 1) {</span>
<span class="s1">    system(sprintf(&quot;sudo dhcp_release %s %s %s&quot;, interface, addr, mac_addr))</span>
<span class="s1">  }</span>
<span class="s1">}&#39;</span> /var/lib/lxd-bridge/dnsmasq.<span class="nv">$LXD_BRIDGE</span>.leases
</pre></div>
</td></tr></table>

<p>Ubuntu 16.04 の場合 <code>dhcp_release</code> コマンドを使うには以下のように <code>dnsmasq-utils</code> パッケージをインストールする必要があります。</p>
<div class="highlight"><pre><span></span>sudo apt -y install dnsmasq-utils
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>