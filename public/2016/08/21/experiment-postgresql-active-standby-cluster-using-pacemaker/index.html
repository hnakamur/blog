<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Pacemakerを使ってPostgreSQLのアクティブ・スタンバイ(1+1構成)を試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/08/21/experiment-postgresql-active-standby-cluster-using-pacemaker/" rel="bookmark"
           title="Permalink to Pacemakerを使ってPostgreSQLのアクティブ・スタンバイ(1+1構成)を試してみた">Pacemakerを使ってPostgreSQLのアクティブ・スタンバイ(1+1構成)を試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-08-21T11:23:00+09:00">
                Published: 2016-08-21
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/postgresql.html">postgresql</a> <a href="../../../../tag/pacemaker.html">pacemaker</a> <a href="../../../../tag/lxd.html">lxd</a> <a href="../../../../tag/ansible.html">ansible</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p>STONITH無し、quorum無しのアクティブ・スタンバイ(1+1構成)がとりあえず動くところまでは来たので、一旦メモです。</p>
<h2>参考資料</h2>
<p>以下の資料と連載記事がわかりやすくて非常に参考になりました。ありがとうございます！</p>
<ul>
<li><a href="http://linux-ha.osdn.jp/wp/archives/3244">JPUG 第23回しくみ+アプリケーション勉強会 セミナー資料公開 « Linux-HA Japan</a><ul>
<li><a href="http://linux-ha.osdn.jp/wp/wp-content/uploads/pacemaker_20120526JPUG.pdf">HAクラスタでPostgreSQLを高可用化(前編) ～Pacemaker入門編～(PDF)</a></li>
<li><a href="http://linux-ha.osdn.jp/wp/wp-content/uploads/b754c737d835c2546415009387407b7b.pdf">PostgreSQLを高可用化(後編) 〜レプリケーション編〜(PDF)</a></li>
</ul>
</li>
<li><a href="http://linux-ha.osdn.jp/wp/archives/3589">OSC 2013 Tokyo/Spring 講演資料公開 « Linux-HA Japan</a><ul>
<li><a href="http://www.slideshare.net/takmatsuo/osc-tokyospring2013-16694861">Pacemaker+PostgreSQLレプリケーションで共有ディスクレス高信頼クラスタの構築＠OSC 2013 Tokyo/Spring</a></li>
</ul>
</li>
<li><a href="http://gihyo.jp/admin/serial/01/pacemaker">Pacemakerでかんたんクラスタリング体験してみよう！：連載｜gihyo.jp … 技術評論社</a></li>
</ul>
<p>さらに以下の記事と電子書籍も参考にしました。</p>
<ul>
<li><a href="http://clusterlabs.org/wiki/PgSQL_Replicated_Cluster">PgSQL Replicated Cluster - ClusterLabs</a></li>
<li><a href="http://shop.oreilly.com/product/9781783550609.do">PostgreSQL Replication, 2nd Edition - O'Reilly Media</a></li>
</ul>
<h2>テスト用のAnsible playbook</h2>
<p>https://github.com/hnakamur/postgresql-pacemaker-example-playbook
に置きました。</p>
<p>LXD をセットアップ済みの Ubuntu 16.04 上で試しました。</p>
<h2>セットアップの事前準備</h2>
<p>上記のplaybookを取得します。</p>
<div class="highlight"><pre><span></span>git clone https://github.com/hnakamur/postgresql-pacemaker-example-playbook
cd postgresql-pacemaker-example-playbook
</pre></div>


<p>Ansibleの <code>lxd_container</code> モジュールを使うので、virtualenvで仮想環境を作ってAnsibleのmaster版をインストールします。</p>
<div class="highlight"><pre><span></span>virtualenv venv
source venv/bin/activate
pip install git+https://github.com/ansible/ansible
</pre></div>


<p>今回はコンテナのIPアドレスをDHCPではなく静的アドレスを使うようにしてみました。</p>
<p><code>/etc/default/lxd-bridge</code> の <code>LXD_IPV4_DHCP_RANGE</code> に DHCP のアドレス範囲が設定されているので、ファイルを編集して範囲を狭めます。私の環境では以下のようにしました。</p>
<div class="highlight"><pre><span></span>## IPv4 network (e.g. 10.0.8.0/24)
LXD_IPV4_NETWORK=&quot;10.155.92.1/24&quot;

## IPv4 DHCP range (e.g. 10.0.8.2,10.0.8.254)
LXD_IPV4_DHCP_RANGE=&quot;10.155.92.200,10.155.92.254&quot;
</pre></div>


<p>LXDをインストールしたときに <code>LXD_IPV4_NETWORK</code> はランダムなアドレスになるかあるいは自分で指定しますので、それに応じた値に適宜変更してください。</p>
<p>変更したら <code>lxd-bridge</code> を再起動して変更を反映します。</p>
<div class="highlight"><pre><span></span>sudo systemctl restart lxd-bridge
</pre></div>


<p><code>group_vars/development/vars.yml</code> ファイル内のIPアドレスも適宜変更します。</p>
<p>また、 <code>group_vars/development/secrets.yml</code> 内にパスワードやsshの鍵ペアなどが含まれています。これを違う値に変更したい場合は以下のようにします。</p>
<p>まず、以下のコマンドを実行して一旦復号化します。</p>
<div class="highlight"><pre><span></span>ansible-vault decrypt group_vars/development/secrets.yml
</pre></div>


<p>vaultのパスワードを聞かれますので入力します。この例では <code>password</code> としています。これはあくまで例なのでこういう弱いパスワードにしていますが、実際の案件で使うときは、もっと強いパスワードを指定してください。</p>
<p><code>group_vars/development/secrets.yml</code> 内の変数を適宜変更したら、以下のコマンドを実行して暗号化します。</p>
<div class="highlight"><pre><span></span>ansible-vault encrypt group_vars/development/secrets.yml
</pre></div>


<p>vaultの新しいパスワードを聞かれますので入力してください。</p>
<h2>コンテナの作成</h2>
<p>以下のコマンドを実行して <code>node1</code> と <code>node2</code> という2つのコンテナを作成します。</p>
<div class="highlight"><pre><span></span>$ ansible-playbook launch_containers.yml -D -v
</pre></div>


<p>vaultのパスワードを聞かれますので入力してください。</p>
<h2>コンテナ内にPostgreSQLとPacemakerをセットアップ</h2>
<p>以下のコマンドを実行して、コンテナ内にPostgreSQLとPacemakerをセットアップします。</p>
<div class="highlight"><pre><span></span>$ ansible-playbook setup_containers.yml -D -v
</pre></div>


<p>ここでは、セットアップ完了後、アクティブスタンバイ構成が開始するまでの時間を図りたいので、以下のように <code>date -u</code> コマンドも実行するようにします。</p>
<div class="highlight"><pre><span></span>$ ansible-playbook setup_containers.yml -D -v<span class="p">;</span> date -u
…<span class="o">(</span>略<span class="o">)</span>…
Sun Aug <span class="m">21</span> <span class="m">13</span>:51:21 UTC <span class="m">2016</span>
</pre></div>


<p>以下のコマンドを実行して <code>node2</code> コンテナに入ります。</p>
<div class="highlight"><pre><span></span>$ lxc <span class="nb">exec</span> node2 bash
</pre></div>


<p>以下のコマンドを実行して、クラスタの状態をモニターします。
<code>node1</code>, <code>node2</code> が両方 Slaves の状態を経て、 <code>node1</code> が Master になり master-ip が <code>node1</code> につくまで待ちます。</p>
<div class="highlight"><pre><span></span><span class="n">Last</span> <span class="nl">updated</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mo">07</span> <span class="mi">2016</span>          <span class="n">Last</span> <span class="nl">change</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mo">03</span> <span class="mi">2016</span> <span class="n">by</span> <span class="n">root</span> <span class="n">via</span> <span class="n">crm_attribute</span> <span class="n">on</span> <span class="n">node1</span>
<span class="nl">Stack</span><span class="p">:</span> <span class="n">corosync</span>
<span class="n">Current</span> <span class="nl">DC</span><span class="p">:</span> <span class="n">node1</span> <span class="p">(</span><span class="n">version</span> <span class="mf">1.1.13</span><span class="o">-</span><span class="mf">10.</span><span class="n">el7_2</span><span class="mf">.4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span> <span class="o">-</span> <span class="n">partition</span> <span class="n">with</span> <span class="n">quorum</span>
<span class="mi">2</span> <span class="n">nodes</span> <span class="n">and</span> <span class="mi">3</span> <span class="n">resources</span> <span class="n">configured</span>

<span class="nl">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">node1</span> <span class="n">node2</span> <span class="p">]</span>

 <span class="n">Master</span><span class="o">/</span><span class="n">Slave</span> <span class="nl">Set</span><span class="p">:</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">master</span> <span class="p">[</span><span class="n">pgsql</span><span class="p">]</span>
     <span class="nl">Masters</span><span class="p">:</span> <span class="p">[</span> <span class="n">node1</span> <span class="p">]</span>
     <span class="nl">Slaves</span><span class="p">:</span> <span class="p">[</span> <span class="n">node2</span> <span class="p">]</span>
<span class="n">master</span><span class="o">-</span><span class="n">ip</span>       <span class="p">(</span><span class="n">ocf</span><span class="o">::</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">)</span><span class="o">:</span>       <span class="n">Started</span> <span class="n">node1</span>

<span class="n">Node</span> <span class="nl">Attributes</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node1</span><span class="p">:</span>
    <span class="o">+</span> <span class="n">master</span><span class="o">-</span><span class="nl">pgsql</span>                      <span class="p">:</span> <span class="mi">1000</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nl">status</span>                 <span class="p">:</span> <span class="n">LATEST</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="nl">baseline</span>             <span class="p">:</span> <span class="mo">00000000030000</span><span class="mi">98</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="nl">status</span>                      <span class="p">:</span> <span class="n">PRI</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">xlog</span><span class="o">-</span><span class="nl">loc</span>                    <span class="p">:</span> <span class="mo">00000000030000</span><span class="mi">98</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node2</span><span class="p">:</span>
    <span class="o">+</span> <span class="n">master</span><span class="o">-</span><span class="nl">pgsql</span>                      <span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nl">status</span>                 <span class="p">:</span> <span class="n">STREAMING</span><span class="o">|</span><span class="n">ASYNC</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="nl">status</span>                      <span class="p">:</span> <span class="nl">HS</span><span class="p">:</span><span class="n">async</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">xlog</span><span class="o">-</span><span class="nl">loc</span>                    <span class="p">:</span> <span class="mo">0000000003000000</span>

<span class="n">Migration</span> <span class="nl">Summary</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node2</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node1</span><span class="p">:</span>
</pre></div>


<p>この端末は開いたままにしておきます。</p>
<h2>node1 コンテナを強制停止してフェールオーバのテスト</h2>
<p>別の端末を開いて以下のコマンドを実行し、 <code>node1</code> コンテナを強制停止し時刻を記録します。</p>
<div class="highlight"><pre><span></span>$ lxc stop -f node1<span class="p">;</span> date -u
Sun Aug <span class="m">21</span> <span class="m">13</span>:52:57 UTC <span class="m">2016</span>
</pre></div>


<p>しばらくすると　<code>crm_mon -fA</code> の出力が以下のようになります。</p>
<div class="highlight"><pre><span></span>Last updated: Sun Aug 21 13:53:11 2016          Last change: Sun Aug 21 13:53:05 2016 by root via crm_attribute on node2
Stack: corosync
Current DC: node2 (version 1.1.13-10.el7_2.4-44eb2dd) - partition with quorum
2 nodes and 3 resources configured

Online: [ node2 ]
OFFLINE: [ node1 ]

 Master/Slave Set: pgsql-master [pgsql]
     Masters: [ node2 ]
master-ip       (ocf::heartbeat:IPaddr2):       Started node2

Node Attributes:
* Node node2:
    + master-pgsql                      : 1000
    + pgsql-data-status                 : LATEST
    + pgsql-master-baseline             : 00000000030001A8
    + pgsql-status                      : PRI
    + pgsql-xlog-loc                    : 0000000003000000

Migration Summary:
* Node node2:
</pre></div>


<p>LXDホストで以下のコマンドを実行して <code>node1</code> を起動します。</p>
<div class="highlight"><pre><span></span>$ lxc start node1<span class="p">;</span> date -u
Sun Aug <span class="m">21</span> <span class="m">13</span>:53:58 UTC <span class="m">2016</span>
</pre></div>


<p>起動後しばらくしても <code>node1</code> はオフラインのままですが、これは意図した挙動です。実際のケースではディスク障害などが起きているかもしれないので、マシンの状況を確認してから手動でクラスタに復帰させることになるためです。</p>
<p>以下のコマンドで <code>node1</code> コンテナに入ります。</p>
<div class="highlight"><pre><span></span>$ lxc <span class="nb">exec</span> node1 bash
</pre></div>


<p>PacemakerがPostgreSQLのロックファイルを作っているのでそれを削除します。</p>
<div class="highlight"><pre><span></span>[root@node1 ~]# ll /var/run/postgresql/
total 4
-rw-r----- 1 root     root      0 Aug 21 13:52 PGSQL.lock
-rw-r----- 1 postgres postgres 36 Aug 21 13:52 rep_mode.conf
[root@node1 ~]# rm /var/run/postgresql/PGSQL.lock
rm: remove regular empty file &#39;/var/run/postgresql/PGSQL.lock&#39;? y
</pre></div>


<p>以下のコマンドで <code>node1</code> をクラスタに復帰させ、時刻を記録します。</p>
<div class="highlight"><pre><span></span>[root@node1 ~]# pcs cluster start node1; date -u
node1: Starting Cluster...
Sun Aug 21 13:55:30 UTC 2016
</pre></div>


<p>15秒後、 <code>crm_mon -fA</code> の画面で <code>node1</code> の PostgreSQL が Slaves に追加されました。</p>
<div class="highlight"><pre><span></span><span class="n">Last</span> <span class="nl">updated</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mi">45</span> <span class="mi">2016</span>          <span class="n">Last</span> <span class="nl">change</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mi">42</span> <span class="mi">2016</span> <span class="n">by</span> <span class="n">root</span> <span class="n">via</span> <span class="n">crm_attribute</span> <span class="n">on</span> <span class="n">node2</span>
<span class="nl">Stack</span><span class="p">:</span> <span class="n">corosync</span>
<span class="n">Current</span> <span class="nl">DC</span><span class="p">:</span> <span class="n">node2</span> <span class="p">(</span><span class="n">version</span> <span class="mf">1.1.13</span><span class="o">-</span><span class="mf">10.</span><span class="n">el7_2</span><span class="mf">.4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span> <span class="o">-</span> <span class="n">partition</span> <span class="n">with</span> <span class="n">quorum</span>
<span class="mi">2</span> <span class="n">nodes</span> <span class="n">and</span> <span class="mi">3</span> <span class="n">resources</span> <span class="n">configured</span>

<span class="nl">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">node1</span> <span class="n">node2</span> <span class="p">]</span>

 <span class="n">Master</span><span class="o">/</span><span class="n">Slave</span> <span class="nl">Set</span><span class="p">:</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">master</span> <span class="p">[</span><span class="n">pgsql</span><span class="p">]</span>
     <span class="nl">Masters</span><span class="p">:</span> <span class="p">[</span> <span class="n">node2</span> <span class="p">]</span>
     <span class="nl">Slaves</span><span class="p">:</span> <span class="p">[</span> <span class="n">node1</span> <span class="p">]</span>
<span class="n">master</span><span class="o">-</span><span class="n">ip</span>       <span class="p">(</span><span class="n">ocf</span><span class="o">::</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">)</span><span class="o">:</span>       <span class="n">Started</span> <span class="n">node2</span>

<span class="n">Node</span> <span class="nl">Attributes</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node1</span><span class="p">:</span>
    <span class="o">+</span> <span class="n">master</span><span class="o">-</span><span class="nl">pgsql</span>                      <span class="p">:</span> <span class="mi">100</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nl">status</span>                 <span class="p">:</span> <span class="n">STREAMING</span><span class="o">|</span><span class="n">SYNC</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="nl">status</span>                      <span class="p">:</span> <span class="nl">HS</span><span class="p">:</span><span class="n">sync</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node2</span><span class="p">:</span>
    <span class="o">+</span> <span class="n">master</span><span class="o">-</span><span class="nl">pgsql</span>                      <span class="p">:</span> <span class="mi">1000</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nl">status</span>                 <span class="p">:</span> <span class="n">LATEST</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="nl">baseline</span>             <span class="p">:</span> <span class="mo">00000000030001</span><span class="n">A8</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="nl">status</span>                      <span class="p">:</span> <span class="n">PRI</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">xlog</span><span class="o">-</span><span class="nl">loc</span>                    <span class="p">:</span> <span class="mo">0000000003000000</span>

<span class="n">Migration</span> <span class="nl">Summary</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node2</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node1</span><span class="p">:</span>
</pre></div>


<p>ここで、 <code>node2</code> で <code>crm_mon -fA</code> を実行していた端末で Control-C を入力してモニターを終了します。</p>
<h2>PostgreSQLのプロセスを強制終了してフェールオーバのテスト</h2>
<p>今度は <code>node2</code> の PostgreSQL のプロセスを強制終了してフェールオーバしてみます。</p>
<p>経過を見るために <code>node1</code> で以下のコマンドを実行して、その端末を開いたままにしておきます。</p>
<div class="highlight"><pre><span></span>[root@node1 ~]# crm_mon -fA
</pre></div>


<p>開始時点では以下のような出力になっていました。</p>
<div class="highlight"><pre><span></span><span class="n">Last</span> <span class="nl">updated</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mi">17</span> <span class="mi">2016</span>          <span class="n">Last</span> <span class="nl">change</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">55</span><span class="o">:</span><span class="mi">42</span> <span class="mi">2016</span> <span class="n">by</span> <span class="n">root</span> <span class="n">via</span> <span class="n">crm_attribute</span> <span class="n">on</span> <span class="n">node2</span>
<span class="nl">Stack</span><span class="p">:</span> <span class="n">corosync</span>
<span class="n">Current</span> <span class="nl">DC</span><span class="p">:</span> <span class="n">node2</span> <span class="p">(</span><span class="n">version</span> <span class="mf">1.1.13</span><span class="o">-</span><span class="mf">10.</span><span class="n">el7_2</span><span class="mf">.4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span> <span class="o">-</span> <span class="n">partition</span> <span class="n">with</span> <span class="n">quorum</span>
<span class="mi">2</span> <span class="n">nodes</span> <span class="n">and</span> <span class="mi">3</span> <span class="n">resources</span> <span class="n">configured</span>

<span class="nl">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">node1</span> <span class="n">node2</span> <span class="p">]</span>

 <span class="n">Master</span><span class="o">/</span><span class="n">Slave</span> <span class="nl">Set</span><span class="p">:</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">master</span> <span class="p">[</span><span class="n">pgsql</span><span class="p">]</span>
     <span class="nl">Masters</span><span class="p">:</span> <span class="p">[</span> <span class="n">node2</span> <span class="p">]</span>
     <span class="nl">Slaves</span><span class="p">:</span> <span class="p">[</span> <span class="n">node1</span> <span class="p">]</span>
<span class="n">master</span><span class="o">-</span><span class="n">ip</span>       <span class="p">(</span><span class="n">ocf</span><span class="o">::</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">)</span><span class="o">:</span>       <span class="n">Started</span> <span class="n">node2</span>

<span class="n">Node</span> <span class="nl">Attributes</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node1</span><span class="p">:</span>
    <span class="o">+</span> <span class="n">master</span><span class="o">-</span><span class="nl">pgsql</span>                      <span class="p">:</span> <span class="mi">100</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nl">status</span>                 <span class="p">:</span> <span class="n">STREAMING</span><span class="o">|</span><span class="n">SYNC</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="nl">status</span>                      <span class="p">:</span> <span class="nl">HS</span><span class="p">:</span><span class="n">sync</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node2</span><span class="p">:</span>
    <span class="o">+</span> <span class="n">master</span><span class="o">-</span><span class="nl">pgsql</span>                      <span class="p">:</span> <span class="mi">1000</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nl">status</span>                 <span class="p">:</span> <span class="n">LATEST</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="nl">baseline</span>             <span class="p">:</span> <span class="mo">00000000030001</span><span class="n">A8</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="nl">status</span>                      <span class="p">:</span> <span class="n">PRI</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">xlog</span><span class="o">-</span><span class="nl">loc</span>                    <span class="p">:</span> <span class="mo">0000000003000000</span>

<span class="n">Migration</span> <span class="nl">Summary</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node2</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node1</span><span class="p">:</span>
</pre></div>


<p><code>node2</code> で以下のコマンドを実行して PostgreSQL のプロセスを強制終了し、時刻を記録します。</p>
<div class="highlight"><pre><span></span>[root@node2 ~]# kill -KILL `head -1 /var/lib/pgsql/9.5/data/postmaster.pid`; date -u
Sun Aug 21 13:58:20 UTC 2016
</pre></div>


<p>11秒後 <code>node1</code> の PostgreSQL が Masterに昇格されました。</p>
<div class="highlight"><pre><span></span><span class="n">Last</span> <span class="nl">updated</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mi">31</span> <span class="mi">2016</span>          <span class="n">Last</span> <span class="nl">change</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mi">27</span> <span class="mi">2016</span> <span class="n">by</span> <span class="n">root</span> <span class="n">via</span> <span class="n">crm_attribute</span> <span class="n">on</span> <span class="n">node1</span>
<span class="nl">Stack</span><span class="p">:</span> <span class="n">corosync</span>
<span class="n">Current</span> <span class="nl">DC</span><span class="p">:</span> <span class="n">node2</span> <span class="p">(</span><span class="n">version</span> <span class="mf">1.1.13</span><span class="o">-</span><span class="mf">10.</span><span class="n">el7_2</span><span class="mf">.4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span> <span class="o">-</span> <span class="n">partition</span> <span class="n">with</span> <span class="n">quorum</span>
<span class="mi">2</span> <span class="n">nodes</span> <span class="n">and</span> <span class="mi">3</span> <span class="n">resources</span> <span class="n">configured</span>

<span class="nl">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">node1</span> <span class="n">node2</span> <span class="p">]</span>

 <span class="n">Master</span><span class="o">/</span><span class="n">Slave</span> <span class="nl">Set</span><span class="p">:</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">master</span> <span class="p">[</span><span class="n">pgsql</span><span class="p">]</span>
     <span class="nl">Masters</span><span class="p">:</span> <span class="p">[</span> <span class="n">node1</span> <span class="p">]</span>
<span class="n">master</span><span class="o">-</span><span class="n">ip</span>       <span class="p">(</span><span class="n">ocf</span><span class="o">::</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">)</span><span class="o">:</span>       <span class="n">Started</span> <span class="n">node1</span>

<span class="n">Node</span> <span class="nl">Attributes</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node1</span><span class="p">:</span>
    <span class="o">+</span> <span class="n">master</span><span class="o">-</span><span class="nl">pgsql</span>                      <span class="p">:</span> <span class="mi">1000</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nl">status</span>                 <span class="p">:</span> <span class="n">LATEST</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="nl">baseline</span>             <span class="p">:</span> <span class="mo">00000000030003</span><span class="mi">98</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="nl">status</span>                      <span class="p">:</span> <span class="n">PRI</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node2</span><span class="p">:</span>
    <span class="o">+</span> <span class="n">master</span><span class="o">-</span><span class="nl">pgsql</span>                      <span class="p">:</span> <span class="o">-</span><span class="n">INFINITY</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nl">status</span>                 <span class="p">:</span> <span class="n">DISCONNECT</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="nl">status</span>                      <span class="p">:</span> <span class="n">STOP</span>

<span class="n">Migration</span> <span class="nl">Summary</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node2</span><span class="p">:</span>
   <span class="nl">pgsql</span><span class="p">:</span> <span class="n">migration</span><span class="o">-</span><span class="n">threshold</span><span class="o">=</span><span class="mi">2</span> <span class="n">fail</span><span class="o">-</span><span class="n">count</span><span class="o">=</span><span class="mi">1000000</span> <span class="n">last</span><span class="o">-</span><span class="n">failure</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mi">23</span> <span class="mi">2016</span><span class="err">&#39;</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node1</span><span class="p">:</span>

<span class="n">Failed</span> <span class="nl">Actions</span><span class="p">:</span>
<span class="o">*</span> <span class="n">pgsql_start_0</span> <span class="n">on</span> <span class="n">node2</span> <span class="err">&#39;</span><span class="n">unknown</span> <span class="n">error</span><span class="err">&#39;</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="n">call</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">complete</span><span class="p">,</span> <span class="n">exitreason</span><span class="o">=</span><span class="err">&#39;</span><span class="n">My</span> <span class="n">data</span> <span class="n">may</span> <span class="n">be</span> <span class="n">inconsistent</span><span class="p">.</span> <span class="n">You</span> <span class="n">have</span> <span class="n">to</span> <span class="n">remove</span> <span class="o">/</span><span class="n">va</span>
<span class="n">r</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="n">PGSQL</span><span class="p">.</span><span class="n">lock</span> <span class="n">file</span> <span class="n">to</span> <span class="n">force</span> <span class="n">start</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="n">last</span><span class="o">-</span><span class="n">rc</span><span class="o">-</span><span class="n">change</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mi">23</span> <span class="mi">2016</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">queued</span><span class="o">=</span><span class="mi">0</span><span class="n">ms</span><span class="p">,</span> <span class="n">exec</span><span class="o">=</span><span class="mi">383</span><span class="n">ms</span>
</pre></div>


<p>次に、 <code>node2</code> の PostgreSQL を再び稼働してスタンバイにさせてみます。</p>
<p>まず Pacemaker が作成した PostgreSQL のロックファイル <code>/var/run/postgresql/PGSQL.lock</code> を削除します。</p>
<div class="highlight"><pre><span></span>[root@node2 ~]# ll /var/run/postgresql/
total 4
-rw-r----- 1 root     root      0 Aug 21 13:53 PGSQL.lock
-rw-r----- 1 postgres postgres 31 Aug 21 13:58 rep_mode.conf
[root@node2 ~]# \rm /var/run/postgresql/PGSQL.lock
</pre></div>


<p>次に以下のコマンドを実行して <code>node2</code> のPostgreSQL の failcount をリセットし、時刻を記録します。</p>
<div class="highlight"><pre><span></span>[root@node2 ~]# pcs resource failcount reset pgsql node2; date -u
Sun Aug 21 14:00:04 UTC 2016
</pre></div>


<p>9秒後、 <code>node1</code> での <code>crm_mon -fA</code> の出力を見ると <code>node2</code> がスタンバイになりました。</p>
<div class="highlight"><pre><span></span><span class="n">Last</span> <span class="nl">updated</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">14</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">13</span> <span class="mi">2016</span>          <span class="n">Last</span> <span class="nl">change</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">14</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mi">10</span> <span class="mi">2016</span> <span class="n">by</span> <span class="n">root</span> <span class="n">via</span> <span class="n">crm_attribute</span> <span class="n">on</span> <span class="n">node1</span>
<span class="nl">Stack</span><span class="p">:</span> <span class="n">corosync</span>
<span class="n">Current</span> <span class="nl">DC</span><span class="p">:</span> <span class="n">node2</span> <span class="p">(</span><span class="n">version</span> <span class="mf">1.1.13</span><span class="o">-</span><span class="mf">10.</span><span class="n">el7_2</span><span class="mf">.4</span><span class="o">-</span><span class="mi">44</span><span class="n">eb2dd</span><span class="p">)</span> <span class="o">-</span> <span class="n">partition</span> <span class="n">with</span> <span class="n">quorum</span>
<span class="mi">2</span> <span class="n">nodes</span> <span class="n">and</span> <span class="mi">3</span> <span class="n">resources</span> <span class="n">configured</span>

<span class="nl">Online</span><span class="p">:</span> <span class="p">[</span> <span class="n">node1</span> <span class="n">node2</span> <span class="p">]</span>

 <span class="n">Master</span><span class="o">/</span><span class="n">Slave</span> <span class="nl">Set</span><span class="p">:</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">master</span> <span class="p">[</span><span class="n">pgsql</span><span class="p">]</span>
     <span class="nl">Masters</span><span class="p">:</span> <span class="p">[</span> <span class="n">node1</span> <span class="p">]</span>
     <span class="nl">Slaves</span><span class="p">:</span> <span class="p">[</span> <span class="n">node2</span> <span class="p">]</span>
<span class="n">master</span><span class="o">-</span><span class="n">ip</span>       <span class="p">(</span><span class="n">ocf</span><span class="o">::</span><span class="nl">heartbeat</span><span class="p">:</span><span class="n">IPaddr2</span><span class="p">)</span><span class="o">:</span>       <span class="n">Started</span> <span class="n">node1</span>

<span class="n">Node</span> <span class="nl">Attributes</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node1</span><span class="p">:</span>
    <span class="o">+</span> <span class="n">master</span><span class="o">-</span><span class="nl">pgsql</span>                      <span class="p">:</span> <span class="mi">1000</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nl">status</span>                 <span class="p">:</span> <span class="n">LATEST</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">master</span><span class="o">-</span><span class="nl">baseline</span>             <span class="p">:</span> <span class="mo">00000000030003</span><span class="mi">98</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="nl">status</span>                      <span class="p">:</span> <span class="n">PRI</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node2</span><span class="p">:</span>
    <span class="o">+</span> <span class="n">master</span><span class="o">-</span><span class="nl">pgsql</span>                      <span class="p">:</span> <span class="mi">100</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="n">data</span><span class="o">-</span><span class="nl">status</span>                 <span class="p">:</span> <span class="n">STREAMING</span><span class="o">|</span><span class="n">SYNC</span>
    <span class="o">+</span> <span class="n">pgsql</span><span class="o">-</span><span class="nl">status</span>                      <span class="p">:</span> <span class="nl">HS</span><span class="p">:</span><span class="n">sync</span>

<span class="n">Migration</span> <span class="nl">Summary</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node2</span><span class="p">:</span>
<span class="o">*</span> <span class="n">Node</span> <span class="nl">node1</span><span class="p">:</span>

<span class="n">Failed</span> <span class="nl">Actions</span><span class="p">:</span>
<span class="o">*</span> <span class="n">pgsql_start_0</span> <span class="n">on</span> <span class="n">node2</span> <span class="err">&#39;</span><span class="n">unknown</span> <span class="n">error</span><span class="err">&#39;</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">:</span> <span class="n">call</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">complete</span><span class="p">,</span> <span class="n">exitreason</span><span class="o">=</span><span class="err">&#39;</span><span class="n">My</span> <span class="n">data</span> <span class="n">may</span> <span class="n">be</span> <span class="n">inconsistent</span><span class="p">.</span> <span class="n">You</span> <span class="n">have</span> <span class="n">to</span> <span class="n">remove</span> <span class="o">/</span><span class="n">va</span>
<span class="n">r</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">postgresql</span><span class="o">/</span><span class="n">PGSQL</span><span class="p">.</span><span class="n">lock</span> <span class="n">file</span> <span class="n">to</span> <span class="n">force</span> <span class="n">start</span><span class="p">.</span><span class="err">&#39;</span><span class="p">,</span>
    <span class="n">last</span><span class="o">-</span><span class="n">rc</span><span class="o">-</span><span class="n">change</span><span class="o">=</span><span class="err">&#39;</span><span class="n">Sun</span> <span class="n">Aug</span> <span class="mi">21</span> <span class="mi">13</span><span class="o">:</span><span class="mi">58</span><span class="o">:</span><span class="mi">23</span> <span class="mi">2016</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">queued</span><span class="o">=</span><span class="mi">0</span><span class="n">ms</span><span class="p">,</span> <span class="n">exec</span><span class="o">=</span><span class="mi">383</span><span class="n">ms</span>
</pre></div>


<h2>おわりに</h2>
<p>STONITH無し、quorum無しという簡易構成ですが、アクティブ・スタンバイ(1+1構成)でフフェールオーバする検証ができました。本番運用するにはSTONITHやquorumも重要そうなので、そちらも調べて行きたいです。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>