<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>pgpool-IIを使ってPostgreSQLのアクティブ・スタンバイ(1+1構成)を試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/09/15/experiment-postgresql-active-standby-using-pgpool-ii/" rel="bookmark"
           title="Permalink to pgpool-IIを使ってPostgreSQLのアクティブ・スタンバイ(1+1構成)を試してみた">pgpool-IIを使ってPostgreSQLのアクティブ・スタンバイ(1+1構成)を試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-09-15T06:28:00+09:00">
                Published: 2016-09-15
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>

</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p>pgool-IIを使ってPostgreSQLのアクティブ・スタンバイ(1+1構成)を試したのでメモです。</p>
<p>以下のページを参考にしました。</p>
<ul>
<li><a href="http://www.pgpool.net/docs/latest/pgpool-ja.html">pgpool-II ユーザマニュアル</a></li>
<li><a href="http://www.pgpool.net/pgpool-web/contrib_docs/watchdog_master_slave_3.3/ja.html">pgpool-II watchdog チュートリアル（master-slave mode）</a></li>
<li><a href="http://lets.postgresql.jp/documents/technical/pgpool-II-3.3-watchdog/1">pgpool-II 3.3 の watchdog 機能 — Let's Postgres</a></li>
</ul>
<h2>テスト用のAnsible playbook</h2>
<p>https://github.com/hnakamur/postgresql-pgpool2-failover-example-playbook に置きました。</p>
<p>LXD をセットアップ済みの Ubuntu 16.04 上で試しました。</p>
<p>LXD で CentOS 7 のコンテナを2つ作って環境構築しています。
PostgreSQL と pgpool-II は <a href="http://yum.postgresql.org/repopackages.php">PostgreSQL RPM Repository (with Yum)</a> からインストールしました。
PostgreSQL のバージョンは 9.5.4、 pgpool-II のバージョンは 3.5.4 です。</p>
<h2>今回の構成</h2>
<p><a href="http://www.pgpool.net/pgpool-web/contrib_docs/watchdog_master_slave_3.3/ja.html">pgpool-II watchdog チュートリアル（master-slave mode）</a> の図と同様の構成となっています。</p>
<p>ただし、今回の構成では pgpool-II と PostgreSQL を別のコンテナにせず1つのコンテナに同居させていて、以下の2つのコンテナで構成しています。</p>
<ul>
<li>pgsql1 (IPアドレス <code>10.155.92.101</code>)</li>
<li>pgsql2 (IPアドレス <code>10.155.92.102</code>)</li>
</ul>
<p>pgpool-II は watchdog で相互監視するマスタ・スタンバイ構成 (
<a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#config">pgpool-II の設定</a> のマスタスレーブモード ) です。
pgpool-II のマスタが仮想 IP <code>10.155.92.100</code> を持ちます。</p>
<p>pgpool-II から PostgreSQL を監視するのは heartbeat という仕組みを今回は使っています。</p>
<p>レプリケーションは pgpool-II ではなく PostgreSQL の非同期ストリーミング・レプリケーションを使っています。</p>
<p>また、 pgpool-II の負荷分散 (ロードバランサ) 機能は今回は使っていません。</p>
<p>なお、仮想 IP はあくまで pgpool-II のマスタと連動するもので、 PostgreSQL のプライマリとは別のコンテナになることもあります。</p>
<p>pgpool-II のドキュメントやコマンドの出力を見ると、 pgpool-II のマスタはマスタ、 PostgreSQL のマスタはプライマリと用語を使い分けているようです。この記事もそれに従います。</p>
<p>pgpool-II と PostgreSQL のポートはそれぞれデフォルトの 9999 と 5432 としています。
pgpool-II は他に管理用のポートとして 9898、 watchdog 用のポートで 9000 を使います。</p>
<h2>セットアップの事前準備</h2>
<p><a href="/blog/2016/08/21/experiment-postgresql-active-standby-cluster-using-pacemaker/">Pacemakerを使ってPostgreSQLのアクティブ・スタンバイ(1+1構成)を試してみた · hnakamur's blog at github</a> と同様です。</p>
<h2>pgpool-II の管理者ユーザとパスワード</h2>
<p><a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#pcp_config">pcp.conf の設定</a> に従って pgpool-II の管理者のユーザ名と md5 暗号化したパスワードを <code>/etc/pgpool-II-95/pcp.conf</code> に設定しています。</p>
<p>管理者ユーザ名は <code>pgpool2</code> としました。</p>
<p>パスワードは以下のコマンドを実行して <code>group_vars/development/secrets.yml</code> を復号化し、 <code>development.secrets.pgpool2_admin_password</code> の値を参照してください。</p>
<div class="highlight"><pre><span></span>$ ansible-vault decrypt group_vars/development/secrets.yml 
Vault password: 
Decryption successful
</pre></div>


<h2>コンテナの作成</h2>
<p>以下のコマンドを実行して <code>pgsql1</code> と <code>pgsql2</code> という2つのコンテナを作成します。</p>
<div class="highlight"><pre><span></span>$ ansible-playbook launch_containers.yml -D -v
</pre></div>


<p>vaultのパスワードを聞かれますので入力してください。</p>
<h2>コンテナ内に PostgreSQL と pgpool-II をセットアップ</h2>
<p>以下のコマンドを実行して、コンテナ内に PostgreSQL と pgpool-II をセットアップします。</p>
<div class="highlight"><pre><span></span>$ ansible-playbook setup_containers.yml -D -v
</pre></div>


<p>セットアップが完了したときの初期状態では <code>pgsql1</code> の pgpool-II がマスタで仮想IPを持ち、 PostgreSQL も <code>pgsql1</code> がプライマリとなっています。</p>
<h2>状態確認のコマンド説明</h2>
<h3>PostgreSQL のプロセス確認</h3>
<p>起動してしばらく経ってから <code>pgsql1</code> コンテナの PostgreSQL プロセスを ps で見ると以下のようになります。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="n">axf</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">[</span><span class="n">p</span><span class="o">]</span><span class="n">ostgres</span><span class="w"></span>
<span class="w"> </span><span class="mi">1464</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">S</span><span class="w">      </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgsql</span><span class="o">-</span><span class="mf">9.5</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">postgres</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mf">9.5</span><span class="o">/</span><span class="k">data</span><span class="w"></span>
<span class="w"> </span><span class="mi">1465</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1467</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">checkpointer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1468</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1469</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">wal</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1470</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">autovacuum</span><span class="w"> </span><span class="n">launcher</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1471</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">archiver</span><span class="w"> </span><span class="n">process</span><span class="w">   </span><span class="k">last</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="mf">000000010000000000000002.00000028</span><span class="p">.</span><span class="k">backup</span><span class="w"></span>
<span class="w"> </span><span class="mi">1472</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="n">collector</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1720</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">wal</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">repl_user</span><span class="w"> </span><span class="mf">10.155.92.102</span><span class="p">(</span><span class="mi">43074</span><span class="p">)</span><span class="w"> </span><span class="n">streaming</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="mi">3000060</span><span class="w"></span>
</pre></div>


<p><code>pgsql2</code> ではこうなります。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="n">axf</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">[</span><span class="n">p</span><span class="o">]</span><span class="n">ostgres</span><span class="w"></span>
<span class="w"> </span><span class="mi">1386</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">S</span><span class="w">      </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgsql</span><span class="o">-</span><span class="mf">9.5</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">postgres</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mf">9.5</span><span class="o">/</span><span class="k">data</span><span class="w"></span>
<span class="w"> </span><span class="mi">1387</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1388</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">startup</span><span class="w"> </span><span class="n">process</span><span class="w">   </span><span class="n">recovering</span><span class="w"> </span><span class="mi">000000010000000000000003</span><span class="w"></span>
<span class="w"> </span><span class="mi">1394</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">checkpointer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1395</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1396</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="n">collector</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1399</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">wal</span><span class="w"> </span><span class="n">receiver</span><span class="w"> </span><span class="n">process</span><span class="w">   </span><span class="n">streaming</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="mi">3000060</span><span class="w"></span>
</pre></div>


<p><code>postgres: wal sender</code> のプロセスがあれば PostgreSQL のプライマリ、 <code>postgres: wal receiver</code> のプロセスがあれば PostgreSQL のスタンバイと判断することが出来ます。</p>
<p>ただし、PostgreSQL のプライマリが切り替わってしばらくの間はこのプロセスは存在しないので、 次項の方法を使います。</p>
<h3>pgpool-II から見た PostgreSQL ノードの状態確認</h3>
<p><a href="http://tyawan080.hatenablog.com/entry/2014/05/12/234226">PostgreSQLのマスタ判断 - Marlock Homes Diary</a> で知りました。</p>
<p><code>select pg_is_in_recovery()</code> を実行して <code>t</code> であればスタンバイ、 <code>f</code> であればプライマリかスタンドアロンです。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="ss">&quot;select pg_is_in_recovery()&quot;</span><span class="w"></span>
<span class="w"> </span><span class="n">pg_is_in_recovery</span><span class="w"> </span>
<span class="c1">-------------------</span>
<span class="w"> </span><span class="n">f</span><span class="w"></span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="ss">&quot;select pg_is_in_recovery()&quot;</span><span class="w"></span>
<span class="w"> </span><span class="n">pg_is_in_recovery</span><span class="w"> </span>
<span class="c1">-------------------</span>
<span class="w"> </span><span class="n">t</span><span class="w"></span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>


<h3>pgpool-II から見た PostgreSQL ノードの状態確認</h3>
<p><a href="http://www.pgpool.net/docs/latest/pgpool-ja.html">pgpool-II ユーザマニュアル</a> の <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#show-commands">SHOWコマンド</a> の <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#pool_nodes">pool_nodes</a> に対応します。</p>
<p>どちらかのコンテナで以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span>[<span class="nv">root</span>@<span class="nv">pgsql1</span> <span class="o">~</span>]# <span class="nv">sudo</span> <span class="o">-</span><span class="nv">i</span> <span class="o">-</span><span class="nv">u</span> <span class="nv">postgres</span> <span class="nv">psql</span> <span class="o">-</span><span class="nv">h</span> <span class="nv">localhost</span> <span class="o">-</span><span class="nv">p</span> <span class="mi">9999</span> <span class="o">-</span><span class="nv">c</span> <span class="s2">&quot;</span><span class="s">show pool_nodes</span><span class="s2">&quot;</span>
 <span class="nv">node_id</span> <span class="o">|</span>   <span class="nv">hostname</span>    <span class="o">|</span> <span class="nv">port</span> <span class="o">|</span> <span class="nv">status</span> <span class="o">|</span> <span class="nv">lb_weight</span> <span class="o">|</span>  <span class="nv">role</span>   <span class="o">|</span> <span class="nv">select_cnt</span> 
<span class="o">---------+---------------+------+--------+-----------+---------+------------</span>
 <span class="mi">0</span>       <span class="o">|</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">101</span> <span class="o">|</span> <span class="mi">5432</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">0</span>.<span class="mi">500000</span>  <span class="o">|</span> <span class="nv">primary</span> <span class="o">|</span> <span class="mi">0</span>
 <span class="mi">1</span>       <span class="o">|</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="o">|</span> <span class="mi">5432</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">0</span>.<span class="mi">500000</span>  <span class="o">|</span> <span class="nv">standby</span> <span class="o">|</span> <span class="mi">0</span>
<span class="ss">(</span><span class="mi">2</span> <span class="nv">rows</span><span class="ss">)</span>
</pre></div>


<p>なお、 今回の設定では <code>postgres</code> ユーザのパスワードを <code>/var/lib/pgsql/.pgpass</code> に書いているのでパスワード入力は不要です。実運用時は書かないほうが良いでしょう。</p>
<p><code>role</code> 列の primary か standby で PostgreSQL のプライマリかスタンバイもわかるようですが、切替時はすぐに更新されなかったことがあったような気がします。</p>
<p>切り替え直後は <code>select pg_is_in_recovery()</code> を実行する方式のほうが良さそうです。</p>
<p>status 列の値については <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html">pgpool-II ユーザマニュアル</a> の <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#pcp_node_info">pcp_node_info</a> に説明があります。</p>
<ul>
<li>0 - 初期化時のみに表われる。PCP コマンドで表示されることはない。</li>
<li>1 - ノード稼働中。接続無し</li>
<li>2 - ノード稼働中。接続有り</li>
<li>3 - ノードダウン</li>
</ul>
<h3>watchdog から見た pgpool-II の状態確認</h3>
<p><a href="http://www.pgpool.net/docs/latest/pgpool-ja.html">pgpool-II ユーザマニュアル</a> の <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#pcp_watchdog_info">pcp_watchdog_info</a> に対応します。</p>
<p>以下のコマンドを実行します。 pgpool-II の管理者 <code>pgpool2</code> のパスワードを聞かれますので入力してください。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgpool</span><span class="o">-</span><span class="mf">9.5</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">pcp_watchdog_info</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">pgpool2</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"></span>
<span class="nl">Password</span><span class="p">:</span><span class="w"> </span>
<span class="n">Watchdog</span><span class="w"> </span><span class="n">Cluster</span><span class="w"> </span><span class="n">Information</span><span class="w"> </span>
<span class="n">Total</span><span class="w"> </span><span class="n">Nodes</span><span class="w">          </span><span class="err">:</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="n">Remote</span><span class="w"> </span><span class="n">Nodes</span><span class="w">         </span><span class="err">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">Quorum</span><span class="w"> </span><span class="k">state</span><span class="w">         </span><span class="err">:</span><span class="w"> </span><span class="n">QUORUM</span><span class="w"> </span><span class="n">EXIST</span><span class="w"></span>
<span class="n">Alive</span><span class="w"> </span><span class="n">Remote</span><span class="w"> </span><span class="n">Nodes</span><span class="w">   </span><span class="err">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">VIP</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="k">local</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="err">:</span><span class="w"> </span><span class="n">YES</span><span class="w"></span>
<span class="n">Master</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">Name</span><span class="w">     </span><span class="err">:</span><span class="w"> </span><span class="n">Linux_pgsql1_9999</span><span class="w"></span>
<span class="n">Master</span><span class="w"> </span><span class="k">Host</span><span class="w"> </span><span class="n">Name</span><span class="w">     </span><span class="err">:</span><span class="w"> </span><span class="mf">10.155.92.101</span><span class="w"></span>

<span class="n">Watchdog</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">Information</span><span class="w"> </span>
<span class="n">Node</span><span class="w"> </span><span class="n">Name</span><span class="w">      </span><span class="err">:</span><span class="w"> </span><span class="n">Linux_pgsql1_9999</span><span class="w"></span>
<span class="k">Host</span><span class="w"> </span><span class="n">Name</span><span class="w">      </span><span class="err">:</span><span class="w"> </span><span class="mf">10.155.92.101</span><span class="w"></span>
<span class="n">Delegate</span><span class="w"> </span><span class="n">IP</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="mf">10.155.92.100</span><span class="w"></span>
<span class="n">Pgpool</span><span class="w"> </span><span class="n">port</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="mi">9999</span><span class="w"></span>
<span class="n">Watchdog</span><span class="w"> </span><span class="n">port</span><span class="w">  </span><span class="err">:</span><span class="w"> </span><span class="mi">9000</span><span class="w"></span>
<span class="n">Node</span><span class="w"> </span><span class="n">priority</span><span class="w">  </span><span class="err">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">Status</span><span class="w">         </span><span class="err">:</span><span class="w"> </span><span class="mi">4</span><span class="w"></span>
<span class="n">Status</span><span class="w"> </span><span class="n">Name</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="n">MASTER</span><span class="w"></span>

<span class="n">Node</span><span class="w"> </span><span class="n">Name</span><span class="w">      </span><span class="err">:</span><span class="w"> </span><span class="n">Linux_pgsql2_9999</span><span class="w"></span>
<span class="k">Host</span><span class="w"> </span><span class="n">Name</span><span class="w">      </span><span class="err">:</span><span class="w"> </span><span class="mf">10.155.92.102</span><span class="w"></span>
<span class="n">Delegate</span><span class="w"> </span><span class="n">IP</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="mf">10.155.92.100</span><span class="w"></span>
<span class="n">Pgpool</span><span class="w"> </span><span class="n">port</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="mi">9999</span><span class="w"></span>
<span class="n">Watchdog</span><span class="w"> </span><span class="n">port</span><span class="w">  </span><span class="err">:</span><span class="w"> </span><span class="mi">9000</span><span class="w"></span>
<span class="n">Node</span><span class="w"> </span><span class="n">priority</span><span class="w">  </span><span class="err">:</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="n">Status</span><span class="w">         </span><span class="err">:</span><span class="w"> </span><span class="mi">7</span><span class="w"></span>
<span class="n">Status</span><span class="w"> </span><span class="n">Name</span><span class="w">    </span><span class="err">:</span><span class="w"> </span><span class="n">STANDBY</span><span class="w"></span>
</pre></div>


<p><code>Status Name</code> の種類は src/watchdog/watchdog.c 内にで定義されていました。 <code>Status</code> はこの配列内のゼロオリジンのインデクスです。</p>
<div class="highlight"><pre><span></span><span class="nv">char</span> <span class="o">*</span><span class="nv">wd_state_names</span>[] <span class="o">=</span> {
        <span class="s2">&quot;</span><span class="s">DEAD</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">LOADING</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">JOINING</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">INITIALIZING</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">MASTER</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">PARTICIPATING IN ELECTION</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">STANDING FOR MASTER</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">STANDBY</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">LOST</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">IN NETWORK TROUBLE</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">SHUTDOWN</span><span class="s2">&quot;</span>,
        <span class="s2">&quot;</span><span class="s">ADD MESSAGE SENT</span><span class="s2">&quot;</span>}<span class="c1">;</span>
</pre></div>


<h2>pgsql1 (プライマリ)の PostgreSQL を強制停止してフェイルオーバーのテスト</h2>
<h3>フェイルオーバー時に呼び出されるスクリプト</h3>
<p><a href="http://www.pgpool.net/docs/latest/pgpool-ja.html">pgpool-II ユーザマニュアル</a> の <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#failover_in_stream_mode">Streaming Replicationでのフェイルオーバ</a> に対応します。</p>
<p>フェイルオーバー時には <code>/etc/pgpool-II-95/pgpool.conf</code> の <code>failover_command</code> に設定したスクリプトが実行されます。今回の構成では以下のような設定にしました。</p>
<div class="highlight"><pre><span></span><span class="n">failover_command</span> <span class="o">=</span> <span class="s1">&#39;/var/lib/pgsql/9.5/data/pgpool_failover %d %P %H %R&#39;</span>
                   <span class="o">#</span> <span class="n">NOTE</span><span class="p">:</span> <span class="o">%</span><span class="n">dなどの値は</span> <span class="n">src</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">pgpool_main</span><span class="p">.</span><span class="k">c</span> <span class="err">の</span> <span class="n">trigger_failover_command</span> <span class="err">で設定しています。</span>
                   <span class="o">#</span> <span class="n">Executes</span> <span class="n">this</span> <span class="n">command</span> <span class="k">at</span> <span class="n">failover</span>
                   <span class="o">#</span> <span class="n">Special</span> <span class="k">values</span><span class="p">:</span>
                   <span class="o">#</span>   <span class="o">%</span><span class="n">d</span> <span class="o">=</span> <span class="n">node</span> <span class="n">id</span>
                   <span class="o">#</span>   <span class="o">%</span><span class="n">h</span> <span class="o">=</span> <span class="k">host</span> <span class="n">name</span>
                   <span class="o">#</span>   <span class="o">%</span><span class="n">p</span> <span class="o">=</span> <span class="n">port</span> <span class="nb">number</span>
                   <span class="o">#</span>   <span class="o">%</span><span class="n">D</span> <span class="o">=</span> <span class="k">database</span> <span class="k">cluster</span> <span class="n">path</span>
                   <span class="o">#</span>   <span class="o">%</span><span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">master</span> <span class="n">node</span> <span class="n">id</span>
                   <span class="o">#</span>   <span class="o">%</span><span class="n">H</span> <span class="o">=</span> <span class="n">hostname</span> <span class="k">of</span> <span class="n">the</span> <span class="k">new</span> <span class="n">master</span> <span class="n">node</span>
                   <span class="o">#</span>   <span class="o">%</span><span class="n">M</span> <span class="o">=</span> <span class="k">old</span> <span class="n">master</span> <span class="n">node</span> <span class="n">id</span>
                   <span class="o">#</span>   <span class="o">%</span><span class="n">P</span> <span class="o">=</span> <span class="k">old</span> <span class="k">primary</span> <span class="n">node</span> <span class="n">id</span>
                   <span class="o">#</span>   <span class="o">%</span><span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">master</span> <span class="n">port</span> <span class="nb">number</span>
                   <span class="o">#</span>   <span class="o">%</span><span class="n">R</span> <span class="o">=</span> <span class="k">new</span> <span class="n">master</span> <span class="k">database</span> <span class="k">cluster</span> <span class="n">path</span>
                   <span class="o">#</span>   <span class="o">%%</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span> <span class="nb">character</span>
</pre></div>


<p><code>/var/lib/pgsql/9.5/data/pgpool_failover</code> は <a href="https://github.com/hnakamur/postgresql-pgpool2-failover-example-playbook/blob/7f3ef8af54a4f9ec948d65bfc47e33db4792737d/roles/postgresql_db/templates/pgpool_failover.j2">roles/postgresql_db/templates/pgpool_failover.j2</a> から Ansible の template モジュールで生成しています。</p>
<h3>フェイルオーバーの実行</h3>
<p>実行後にどう動いたか確認できるように <code>logger</code> コマンドでログを出力するようにしています。 <code>journalctl -f</code> でログを <code>tail -f</code> 的な感じで見られるので、これで見ながら実行します。</p>
<p>初期状態では pgsql1 が PostgreSQL のプライマリになっています。</p>
<p>pgsql2 で以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">journalctl</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">pgpool_failover</span><span class="w"></span>
</pre></div>


<p>pgsql1 で以下のコマンドを実行しバックグラウンド ( <code>&amp;</code> は 1つ) で PostgreSQL を強制停止しつつ、 journald のログを表示します。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgsql</span><span class="o">-</span><span class="mf">9.5</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">pg_ctl</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="k">immediate</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mf">9.5</span><span class="o">/</span><span class="k">data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">journalctl</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">pgpool_failover</span><span class="w"></span>
</pre></div>


<p>何回か試してみたのですが、 <code>/var/lib/pgsql/9.5/data/pgpool_failover</code> は pgsql1 で実行される場合と pgsql2 で実行される場合があり、どうやらランダムにどちらか一方で実行されるということのようです。また今回の構成では root ユーザで実行されました。</p>
<p>以下は pgsql1 での出力結果です。
Ctrl-C で <code>journalctl -f</code> を停止します。</p>
<div class="highlight"><pre><span></span>[<span class="mi">1</span>] <span class="mi">2319</span>
<span class="nv">waiting</span> <span class="k">for</span> <span class="nv">server</span> <span class="nv">to</span> <span class="nv">shut</span> <span class="nv">down</span>.... <span class="nv">done</span>
<span class="nv">server</span> <span class="nv">stopped</span>

<span class="o">^</span><span class="nv">C</span>
[<span class="mi">1</span>]<span class="o">+</span>  <span class="nv">Done</span>                  <span class="nv">sudo</span> <span class="o">-</span><span class="nv">i</span> <span class="o">-</span><span class="nv">u</span> <span class="nv">postgres</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">pgsql</span><span class="o">-</span><span class="mi">9</span>.<span class="mi">5</span><span class="o">/</span><span class="nv">bin</span><span class="o">/</span><span class="nv">pg_ctl</span> <span class="nv">stop</span> <span class="o">-</span><span class="nv">m</span> <span class="nv">immediate</span> <span class="o">-</span><span class="nv">D</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">pgsql</span><span class="o">/</span><span class="mi">9</span>.<span class="mi">5</span><span class="o">/</span><span class="nv">data</span>
</pre></div>


<p>以下は pgsql2 での出力結果です。
Ctrl-C で <code>journalctl -f</code> を停止します。</p>
<div class="highlight"><pre><span></span><span class="n">Sep</span> <span class="mi">15</span> <span class="mi">13</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">47</span> <span class="n">pgsql2</span> <span class="n">pgpool</span><span class="p">[</span><span class="mi">1432</span><span class="p">]:</span> <span class="mi">2016</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">15</span> <span class="mi">13</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span> <span class="n">pid</span> <span class="mi">1432</span><span class="p">:</span> <span class="n">LOG</span><span class="p">:</span>  <span class="k">execute</span> <span class="n">command</span><span class="p">:</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mi">9</span><span class="p">.</span><span class="mi">5</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">pgpool_failover</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">10</span><span class="p">.</span><span class="mi">155</span><span class="p">.</span><span class="mi">92</span><span class="p">.</span><span class="mi">102</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mi">9</span><span class="p">.</span><span class="mi">5</span><span class="o">/</span><span class="k">data</span>
<span class="n">Sep</span> <span class="mi">15</span> <span class="mi">13</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">47</span> <span class="n">pgsql2</span> <span class="n">pgpool_failover</span><span class="p">[</span><span class="mi">32612</span><span class="p">]:</span> <span class="k">start</span> <span class="n">args</span><span class="o">=</span><span class="mi">0</span> <span class="mi">0</span> <span class="mi">10</span><span class="p">.</span><span class="mi">155</span><span class="p">.</span><span class="mi">92</span><span class="p">.</span><span class="mi">102</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mi">9</span><span class="p">.</span><span class="mi">5</span><span class="o">/</span><span class="k">data</span> <span class="n">UID</span><span class="o">=</span><span class="mi">0</span>
<span class="n">Sep</span> <span class="mi">15</span> <span class="mi">13</span><span class="p">:</span><span class="mi">06</span><span class="p">:</span><span class="mi">47</span> <span class="n">pgsql2</span> <span class="n">pgpool_failover</span><span class="p">[</span><span class="mi">32620</span><span class="p">]:</span> <span class="n">created</span> <span class="n">promote_trigger</span> <span class="n">file</span>
<span class="o">^</span><span class="k">C</span>
</pre></div>


<p>少ししてから PostgreSQL のノードの状態を確認すると以下のようになりました。
pgsql2 (10.155.92.102) の role が primary になり、 pgsql1 (10.155.92.101) は
role が standby で status が <code>3</code> (ノードダウン) になっています。</p>
<div class="highlight"><pre><span></span>[<span class="nv">root</span>@<span class="nv">pgsql2</span> <span class="o">~</span>]# <span class="nv">sudo</span> <span class="o">-</span><span class="nv">i</span> <span class="o">-</span><span class="nv">u</span> <span class="nv">postgres</span> <span class="nv">psql</span> <span class="o">-</span><span class="nv">h</span> <span class="nv">localhost</span> <span class="o">-</span><span class="nv">p</span> <span class="mi">9999</span> <span class="o">-</span><span class="nv">c</span> <span class="s2">&quot;</span><span class="s">show pool_nodes</span><span class="s2">&quot;</span>
 <span class="nv">node_id</span> <span class="o">|</span>   <span class="nv">hostname</span>    <span class="o">|</span> <span class="nv">port</span> <span class="o">|</span> <span class="nv">status</span> <span class="o">|</span> <span class="nv">lb_weight</span> <span class="o">|</span>  <span class="nv">role</span>   <span class="o">|</span> <span class="nv">select_cnt</span> 
<span class="o">---------+---------------+------+--------+-----------+---------+------------</span>
 <span class="mi">0</span>       <span class="o">|</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">101</span> <span class="o">|</span> <span class="mi">5432</span> <span class="o">|</span> <span class="mi">3</span>      <span class="o">|</span> <span class="mi">0</span>.<span class="mi">500000</span>  <span class="o">|</span> <span class="nv">standby</span> <span class="o">|</span> <span class="mi">0</span>
 <span class="mi">1</span>       <span class="o">|</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="o">|</span> <span class="mi">5432</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">0</span>.<span class="mi">500000</span>  <span class="o">|</span> <span class="nv">primary</span> <span class="o">|</span> <span class="mi">0</span>
<span class="ss">(</span><span class="mi">2</span> <span class="nv">rows</span><span class="ss">)</span>
</pre></div>


<p>pgsql2 で <code>select pg_is_in_recovery()</code> を実行すると <code>f</code> になってプライマリになっていることがわかります。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="ss">&quot;select pg_is_in_recovery()&quot;</span><span class="w"></span>
<span class="w"> </span><span class="n">pg_is_in_recovery</span><span class="w"> </span>
<span class="c1">-------------------</span>
<span class="w"> </span><span class="n">f</span><span class="w"></span>
<span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">row</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p>pgsql2 側での変更実験としてデータベースを作成してみます。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="n">createdb</span><span class="w"> </span><span class="n">foo</span><span class="w"></span>
<span class="o">[</span><span class="n">root@pgsql2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"></span>
<span class="w">                             </span><span class="n">List</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">databases</span><span class="w"></span>
<span class="w">   </span><span class="n">Name</span><span class="w">    </span><span class="o">|</span><span class="w">  </span><span class="n">Owner</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Encoding</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Collate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Ctype</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="n">Access</span><span class="w"> </span><span class="k">privileges</span><span class="w">   </span>
<span class="c1">-----------+----------+----------+---------+-------+-----------------------</span>
<span class="w"> </span><span class="n">foo</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UTF8</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>
<span class="w"> </span><span class="n">postgres</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UTF8</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>
<span class="w"> </span><span class="n">template0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UTF8</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">=</span><span class="n">c</span><span class="o">/</span><span class="n">postgres</span><span class="w">          </span><span class="o">+</span><span class="w"></span>
<span class="w">           </span><span class="o">|</span><span class="w">          </span><span class="o">|</span><span class="w">          </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">postgres</span><span class="o">=</span><span class="n">CTc</span><span class="o">/</span><span class="n">postgres</span><span class="w"></span>
<span class="w"> </span><span class="n">template1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">UTF8</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">C</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">=</span><span class="n">c</span><span class="o">/</span><span class="n">postgres</span><span class="w">          </span><span class="o">+</span><span class="w"></span>
<span class="w">           </span><span class="o">|</span><span class="w">          </span><span class="o">|</span><span class="w">          </span><span class="o">|</span><span class="w">         </span><span class="o">|</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">postgres</span><span class="o">=</span><span class="n">CTc</span><span class="o">/</span><span class="n">postgres</span><span class="w"></span>
<span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w"></span>
</pre></div>


<p>なお、 pgpool-II 自体のマスタ・スタンバイの役割は変わらず同じで、 pgsql1 がマスタ、 pgsql2 がスタンバイで、 仮想IP は pgsql1 についた状態です。</p>
<h2>pgsql1 の PostgreSQL をオンラインリカバリしスタンバイとして復帰させる</h2>
<h3>オンラインリカバリで呼び出される2つのスクリプト</h3>
<p><a href="http://www.pgpool.net/docs/latest/pgpool-ja.html">pgpool-II ユーザマニュアル</a> の <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#online_recovery_in_stream_mode">Streaming Replicationでのオンラインリカバリ</a> に対応します。</p>
<p>オンラインリカバリで呼び出されるスクリプトは2つあります。この2つのスクリプトは <code>failover_command</code> とは違って、必ずプライマリ側で <code>postgres</code> ユーザで実行されます。</p>
<p>1つ目は <code>/etc/pgpool-II-95/pgpool.conf</code> の <code>recovery_1st_stage_command</code> に指定したスクリプトです。
ここではファイル名のみが指定可能で、ディレクトリは PostgreSQL のデータディレクトリ (今回の構成では /var/lib/pgsql/9.5/data ) と決められています。
<a href="http://www.pgpool.net/docs/latest/pgpool-ja.html">pgpool-II ユーザマニュアル</a> の <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#RECOVERY_1ST_STAGE_COMMAND">recovery_1st_stage_command</a> によるとセキュリティ上の観点からそうしているそうです。</p>
<div class="highlight"><pre><span></span><span class="n">recovery_1st_stage_command</span> <span class="o">=</span> <span class="s1">&#39;recovery_1st_stage&#39;</span>
</pre></div>


<p><code>/var/lib/pgsql/9.5/data/recovery_1st_stage</code> は <a href="https://github.com/hnakamur/postgresql-pgpool2-failover-example-playbook/blob/7f3ef8af54a4f9ec948d65bfc47e33db4792737d/roles/postgresql_db/templates/recovery_1st_stage.j2">roles/postgresql_db/templates/recovery_1st_stage.j2</a> から Ansible の template モジュールで生成しています。</p>
<p>今回の構成では古いデータディレクトリを <code>mv</code> コマンドでリネームして、 <code>pg_basebackup</code> コマンドでプライマリ・データベースの複製を作り、 <code>recovery.conf</code> を作ってスタンバイとして稼働させる準備をしています。</p>
<p>2つ目は PostgreSQL のデータディレクトリ下の <code>pgpool_remote_start</code> というファイル名のスクリプトです。</p>
<p><a href="http://www.pgpool.net/docs/latest/pgpool-ja.html">pgpool-II ユーザマニュアル</a> の <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#pool_remote_start">pgpool_remote_start</a> に説明があります。</p>
<p>こちらはファイル名が pgpool-II のソースコード <code>src/sql/pgpool-recovery/pgpool-recovery.c</code> 内に</p>
<div class="highlight"><pre><span></span><span class="o">#</span><span class="n">define</span> <span class="n">REMOTE_START_FILE</span> <span class="ss">&quot;pgpool_remote_start&quot;</span>
</pre></div>


<p>のように固定の定義になっています。</p>
<p><code>/var/lib/pgsql/9.5/data/pgpool_remote_start</code> は <a href="https://github.com/hnakamur/postgresql-pgpool2-failover-example-playbook/blob/7f3ef8af54a4f9ec948d65bfc47e33db4792737d/roles/postgresql_db/templates/pgpool_remote_start.j2">roles/postgresql_db/templates/pgpool_remote_start.j2</a> から Ansible の template モジュールで生成しています。</p>
<p>処理内容はリモートのノードの PostgreSQL を起動するというものになっています。
ファイル名は <code>pgpool_remote_start</code> なので最初見たときは <code>pgpool</code> を起動するのかと勘違いしましたが、 <code>pgpool_</code> は <code>pgpool</code> のファイルであることを示す接頭辞的な意味合いのようです。
<code>pgpool</code> を起動するなら <code>start_remote_pgoool</code> のほうがわかりやすいでしょうしね。</p>
<p>なお、 <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html">pgpool-II ユーザマニュアル</a> の <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#pool_remote_start">pgpool_remote_start</a> で書かれているサンプルスクリプトでは <code>pg_ctl</code> コマンドで PostgreSQL を起動していますが、 <code>systemctl status postgresql-9.5</code> でサービス状態が確認できなくなってしまうため、 <a href="https://github.com/hnakamur/postgresql-pgpool2-failover-example-playbook/blob/7f3ef8af54a4f9ec948d65bfc47e33db4792737d/roles/postgresql_db/templates/pgpool_remote_start.j2">roles/postgresql_db/templates/pgpool_remote_start.j2</a> では <code>sudo systemctl start postgresql-9.5</code> で起動しています。
またそのために postgres ユーザ用の sudoers 設定も <a href="https://github.com/hnakamur/postgresql-pgpool2-failover-example-playbook/blob/7f3ef8af54a4f9ec948d65bfc47e33db4792737d/roles/postgresql/templates/sudoers_postgres.j2">roles/postgresql/templates/sudoers_postgres.j2</a> を元に <code>/etc/sudoers.d/01_postgres</code> を生成し行っています。</p>
<h3>リカバリの実行</h3>
<p>今回は <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#perform_online_recovery">リカバリの実行</a> で説明されている <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#pcp_recovery_node">pcp_recovery_node</a> コマンドを使います。</p>
<p><code>pcp_recovery_node</code> コマンドは pgpool-II のユーザ <code>pgpool2</code> のパスワードを入力する必要があるためフォアグラウンドで実行し ( <code>&amp;</code> は <code>&amp;&amp;</code> と2つ)、ログを表示します。</p>
<p><code>pcp_recovery_node</code> コマンドは pgsql1 と pgsql2 のどちらで実行しても良いようです。ここでは対象のサーバが pgsql1 なので対応する <code>node_id</code> の <code>0</code> を引数の最後に指定しています。 <code>node_id</code> は上記の <code>show pool_nodes</code> の出力で確認できます。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgpool</span><span class="o">-</span><span class="mf">9.5</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">pcp_recovery_node</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">9898</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">pgpool2</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nl">Password</span><span class="p">:</span><span class="w"> </span>
<span class="n">pcp_recovery_node</span><span class="w"> </span><span class="c1">-- Command Successful</span>
</pre></div>


<p>ログを確認すると以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">journalctl</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="s1">&#39;(recovery_1st_stage|pgpool_remote_start)&#39;</span><span class="w"></span>
<span class="n">Sep</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">03</span><span class="err">:</span><span class="mi">38</span><span class="w"> </span><span class="n">pgsql2</span><span class="w"> </span><span class="n">pgpool</span><span class="o">[</span><span class="n">1416</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="mi">2016</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">15</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">03</span><span class="err">:</span><span class="mi">38</span><span class="err">:</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="mi">1700</span><span class="err">:</span><span class="w"> </span><span class="nl">DETAIL</span><span class="p">:</span><span class="w">  </span><span class="n">starting</span><span class="w"> </span><span class="n">recovery</span><span class="w"> </span><span class="nl">command</span><span class="p">:</span><span class="w"> </span><span class="ss">&quot;SELECT pgpool_recovery(&#39;recovery_1st_stage&#39;, &#39;10.155.92.101&#39;, &#39;/var/lib/pgsql/9.5/data&#39;, &#39;5432&#39;)&quot;</span><span class="w"></span>
<span class="n">Sep</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">03</span><span class="err">:</span><span class="mi">38</span><span class="w"> </span><span class="n">pgsql2</span><span class="w"> </span><span class="n">recovery_1st_stage</span><span class="o">[</span><span class="n">1704</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">args</span><span class="o">=/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mf">9.5</span><span class="o">/</span><span class="k">data</span><span class="w"> </span><span class="mf">10.155.92.101</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mf">9.5</span><span class="o">/</span><span class="k">data</span><span class="w"> </span><span class="mi">5432</span><span class="w"> </span><span class="n">UID</span><span class="o">=</span><span class="mi">26</span><span class="w"></span>
<span class="n">Sep</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">03</span><span class="err">:</span><span class="mi">39</span><span class="w"> </span><span class="n">pgsql2</span><span class="w"> </span><span class="n">recovery_1st_stage</span><span class="o">[</span><span class="n">1713</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">pg_basebackup</span><span class="w"> </span><span class="n">done</span><span class="p">.</span><span class="w"></span>
<span class="n">Sep</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">03</span><span class="err">:</span><span class="mi">39</span><span class="w"> </span><span class="n">pgsql2</span><span class="w"> </span><span class="n">recovery_1st_stage</span><span class="o">[</span><span class="n">1716</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">archive_status</span><span class="p">.</span><span class="w"></span>
<span class="n">Sep</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">03</span><span class="err">:</span><span class="mi">39</span><span class="w"> </span><span class="n">pgsql2</span><span class="w"> </span><span class="n">recovery_1st_stage</span><span class="o">[</span><span class="n">1719</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">created</span><span class="w"> </span><span class="n">recovery</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="w"></span>
<span class="n">Sep</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">03</span><span class="err">:</span><span class="mi">39</span><span class="w"> </span><span class="n">pgsql2</span><span class="w"> </span><span class="n">pgpool_remote_start</span><span class="o">[</span><span class="n">1722</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">args</span><span class="o">=</span><span class="mf">10.155.92.101</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mf">9.5</span><span class="o">/</span><span class="k">data</span><span class="w"> </span><span class="n">UID</span><span class="o">=</span><span class="mi">26</span><span class="w"></span>
<span class="n">Sep</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">03</span><span class="err">:</span><span class="mi">42</span><span class="w"> </span><span class="n">pgsql2</span><span class="w"> </span><span class="n">pgpool_remote_start</span><span class="o">[</span><span class="n">1738</span><span class="o">]</span><span class="err">:</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">postgresql</span><span class="w"> </span><span class="n">service</span><span class="w"></span>
</pre></div>


<p>しばらくして PostgreSQL の状態を確認すると以下のように pgsql1 の role が standby で status が 2 (ノード稼働中。接続有り) になりました。</p>
<div class="highlight"><pre><span></span>[<span class="nv">root</span>@<span class="nv">pgsql2</span> <span class="nv">pgsql</span>]# <span class="nv">sudo</span> <span class="o">-</span><span class="nv">i</span> <span class="o">-</span><span class="nv">u</span> <span class="nv">postgres</span> <span class="nv">psql</span> <span class="o">-</span><span class="nv">h</span> <span class="nv">localhost</span> <span class="o">-</span><span class="nv">p</span> <span class="mi">9999</span> <span class="o">-</span><span class="nv">c</span> <span class="s2">&quot;</span><span class="s">show pool_nodes</span><span class="s2">&quot;</span>
 <span class="nv">node_id</span> <span class="o">|</span>   <span class="nv">hostname</span>    <span class="o">|</span> <span class="nv">port</span> <span class="o">|</span> <span class="nv">status</span> <span class="o">|</span> <span class="nv">lb_weight</span> <span class="o">|</span>  <span class="nv">role</span>   <span class="o">|</span> <span class="nv">select_cnt</span> 
<span class="o">---------+---------------+------+--------+-----------+---------+------------</span>
 <span class="mi">0</span>       <span class="o">|</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">101</span> <span class="o">|</span> <span class="mi">5432</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">0</span>.<span class="mi">500000</span>  <span class="o">|</span> <span class="nv">standby</span> <span class="o">|</span> <span class="mi">0</span>
 <span class="mi">1</span>       <span class="o">|</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="o">|</span> <span class="mi">5432</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">0</span>.<span class="mi">500000</span>  <span class="o">|</span> <span class="nv">primary</span> <span class="o">|</span> <span class="mi">0</span>
<span class="ss">(</span><span class="mi">2</span> <span class="nv">rows</span><span class="ss">)</span>
</pre></div>


<p>ps を実行してみると pgsql2 で <code>postgres: wal sender process</code> が稼働しており、 pgsql1 で <code>postgres: wal receiver process</code> が稼働しており、ストリーミング・レプリケーションが動いていることが確認できました。</p>
<h2>pgsql1 (スタンバイ) の PostgreSQL を強制停止してみる</h2>
<h3>スタンバイの PostgreSQL を強制停止</h3>
<p>pgsql2 で以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">journalctl</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">pgpool_failover</span><span class="w"></span>
</pre></div>


<p>pgsql1 で以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql1 ~</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgsql</span><span class="o">-</span><span class="mf">9.5</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">pg_ctl</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="k">immediate</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mf">9.5</span><span class="o">/</span><span class="k">data</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">journalctl</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">pgpool_failover</span><span class="w"></span>
</pre></div>


<p>今回は pgsql2 に以下のログが出ました。</p>
<div class="highlight"><pre><span></span><span class="nv">Sep</span> <span class="mi">15</span> <span class="mi">14</span>:<span class="mi">21</span>:<span class="mi">05</span> <span class="nv">pgsql2</span> <span class="nv">pgpool</span>[<span class="mi">1416</span>]: <span class="mi">2016</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">15</span> <span class="mi">14</span>:<span class="mi">21</span>:<span class="mi">05</span>: <span class="nv">pid</span> <span class="mi">1416</span>: <span class="nv">LOG</span>:  <span class="nv">execute</span> <span class="nv">command</span>: <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">pgsql</span><span class="o">/</span><span class="mi">9</span>.<span class="mi">5</span><span class="o">/</span><span class="nv">data</span><span class="o">/</span><span class="nv">pgpool_failover</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">pgsql</span><span class="o">/</span><span class="mi">9</span>.<span class="mi">5</span><span class="o">/</span><span class="nv">data</span>
<span class="nv">Sep</span> <span class="mi">15</span> <span class="mi">14</span>:<span class="mi">21</span>:<span class="mi">05</span> <span class="nv">pgsql2</span> <span class="nv">pgpool_failover</span>[<span class="mi">2466</span>]: <span class="nv">start</span> <span class="nv">args</span><span class="o">=</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">lib</span><span class="o">/</span><span class="nv">pgsql</span><span class="o">/</span><span class="mi">9</span>.<span class="mi">5</span><span class="o">/</span><span class="nv">data</span> <span class="nv">UID</span><span class="o">=</span><span class="mi">0</span>
<span class="nv">Sep</span> <span class="mi">15</span> <span class="mi">14</span>:<span class="mi">21</span>:<span class="mi">05</span> <span class="nv">pgsql2</span> <span class="nv">pgpool_failover</span>[<span class="mi">2468</span>]: <span class="k">do</span> <span class="nv">nothing</span> <span class="nv">since</span> <span class="nv">failed</span> <span class="nv">node</span> <span class="nv">was</span> <span class="nv">not</span> <span class="nv">primary</span>
</pre></div>


<p>停止された PostgreSQL がプライマリではなかったのでフェイルオーバは行わず、プライマリ (pgsql2) をそのままスタンドアロンで稼働させています。</p>
<p><a href="http://www.pgpool.net/docs/latest/pgpool-ja.html">pgpool-II ユーザマニュアル</a> の <a href="http://www.pgpool.net/docs/latest/pgpool-ja.html#failover_in_stream_mode">Streaming Replicationでのフェイルオーバ</a> に上げられているフェイルオーバ用スクリプトではノード 0 がプライマリで 1 がスタンバイという想定で書かれているため、今回の状況ではうまく行きませんでした。
が、 <a href="https://github.com/hnakamur/postgresql-pgpool2-failover-example-playbook/blob/7f3ef8af54a4f9ec948d65bfc47e33db4792737d/roles/postgresql_db/templates/pgpool_failover.j2">roles/postgresql_db/templates/pgpool_failover.j2</a> では <code>pgpool.conf</code> の <code>failover_command</code> の4つの引数のうち、最初の2つに停止したノード <code>%d</code> と旧プライマリノード %P を渡していて、値が違う場合はスタンバイと判定していますので、一度フェイルオーバ→リカバリをした後でも大丈夫です。</p>
<p><code>show pool_nodes</code> の実行結果は以下の通りです。</p>
<div class="highlight"><pre><span></span>[<span class="nv">root</span>@<span class="nv">pgsql2</span> <span class="nv">pgsql</span>]# <span class="nv">sudo</span> <span class="o">-</span><span class="nv">u</span> <span class="nv">postgres</span> <span class="nv">psql</span> <span class="o">-</span><span class="nv">h</span> <span class="nv">localhost</span> <span class="o">-</span><span class="nv">p</span> <span class="mi">9999</span> <span class="o">-</span><span class="nv">c</span> <span class="s2">&quot;</span><span class="s">show pool_nodes</span><span class="s2">&quot;</span>
 <span class="nv">node_id</span> <span class="o">|</span>   <span class="nv">hostname</span>    <span class="o">|</span> <span class="nv">port</span> <span class="o">|</span> <span class="nv">status</span> <span class="o">|</span> <span class="nv">lb_weight</span> <span class="o">|</span>  <span class="nv">role</span>   <span class="o">|</span> <span class="nv">select_cnt</span> 
<span class="o">---------+---------------+------+--------+-----------+---------+------------</span>
 <span class="mi">0</span>       <span class="o">|</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">101</span> <span class="o">|</span> <span class="mi">5432</span> <span class="o">|</span> <span class="mi">3</span>      <span class="o">|</span> <span class="mi">0</span>.<span class="mi">500000</span>  <span class="o">|</span> <span class="nv">standby</span> <span class="o">|</span> <span class="mi">0</span>
 <span class="mi">1</span>       <span class="o">|</span> <span class="mi">10</span>.<span class="mi">155</span>.<span class="mi">92</span>.<span class="mi">102</span> <span class="o">|</span> <span class="mi">5432</span> <span class="o">|</span> <span class="mi">2</span>      <span class="o">|</span> <span class="mi">0</span>.<span class="mi">500000</span>  <span class="o">|</span> <span class="nv">primary</span> <span class="o">|</span> <span class="mi">0</span>
<span class="ss">(</span><span class="mi">2</span> <span class="nv">rows</span><span class="ss">)</span>
</pre></div>


<p>pgsql2 で postgres のプロセスを見ると <code>wal sender</code> がいないので、スタンドアロン状態であることがわかります。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="n">axf</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">[</span><span class="n">p</span><span class="o">]</span><span class="n">ostgres</span><span class="w"></span>
<span class="w"> </span><span class="mi">1370</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">S</span><span class="w">      </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgsql</span><span class="o">-</span><span class="mf">9.5</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">postgres</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mf">9.5</span><span class="o">/</span><span class="k">data</span><span class="w"></span>
<span class="w"> </span><span class="mi">1371</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1378</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">checkpointer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1379</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1381</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="n">collector</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1554</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">wal</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1555</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">autovacuum</span><span class="w"> </span><span class="n">launcher</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1556</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">archiver</span><span class="w"> </span><span class="n">process</span><span class="w">   </span><span class="k">last</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="mf">000000020000000000000004.00000060</span><span class="p">.</span><span class="k">backup</span><span class="w"></span>
</pre></div>


<p>スタンドアロン状態であることは <code>select * from pg_stat_replication</code> の結果が 0であることからもわかります。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="ss">&quot;select * from pg_stat_replication&quot;</span><span class="w"></span>
<span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="k">rows</span><span class="p">)</span><span class="w"></span>
</pre></div>


<h3>スタンバイの PostgreSQL を復活させる</h3>
<h4>単に PostgreSQL を起動すれば動く場合</h4>
<p>実運用の際はデータディレクトリの状況を調査したりするところですが、ここでは問題ないという前提で、 pgsql1 で PostgreSQL を起動して pgpool-II の管理下に追加します。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql1 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="k">start</span><span class="w"> </span><span class="n">postgresql</span><span class="o">-</span><span class="mf">9.5</span><span class="w"></span>
</pre></div>


<p>で起動し</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql1 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="n">postgresql</span><span class="o">-</span><span class="mf">9.5</span><span class="w"></span>
</pre></div>


<p>で状態を確認します。
Active の行が以下のように <code>active (running)</code> になっていれば OK です。</p>
<div class="highlight"><pre><span></span>   <span class="nt">Active</span><span class="o">:</span> <span class="nt">active</span> <span class="o">(</span><span class="nt">running</span><span class="o">)</span> <span class="nt">since</span> <span class="nt">Thu</span> <span class="nt">2016-09-15</span> <span class="nt">14</span><span class="p">:</span><span class="nd">36</span><span class="p">:</span><span class="nd">12</span> <span class="nt">UTC</span><span class="o">;</span> <span class="nt">3s</span> <span class="nt">ago</span>
</pre></div>


<p>しばらくすると pgpool-II の heartbeat で pgsql1 の PostgreSQL が稼働していることを検知し、 pgsql2 をプライマリとするリプリケーションが再開されます。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql1 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="n">axf</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">[</span><span class="n">p</span><span class="o">]</span><span class="n">ostgres</span><span class="w"></span>
<span class="w"> </span><span class="mi">2778</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">S</span><span class="w">      </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgsql</span><span class="o">-</span><span class="mf">9.5</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">postgres</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mf">9.5</span><span class="o">/</span><span class="k">data</span><span class="w"></span>
<span class="w"> </span><span class="mi">2779</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">2780</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">startup</span><span class="w"> </span><span class="n">process</span><span class="w">   </span><span class="n">recovering</span><span class="w"> </span><span class="mi">000000020000000000000005</span><span class="w"></span>
<span class="w"> </span><span class="mi">2785</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">checkpointer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">2786</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">2787</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="n">collector</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">2788</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">wal</span><span class="w"> </span><span class="n">receiver</span><span class="w"> </span><span class="n">process</span><span class="w">   </span><span class="n">streaming</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="mi">5000680</span><span class="w"></span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="n">axf</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="o">[</span><span class="n">p</span><span class="o">]</span><span class="n">ostgres</span><span class="w"></span>
<span class="w"> </span><span class="mi">1370</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">S</span><span class="w">      </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgsql</span><span class="o">-</span><span class="mf">9.5</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">postgres</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span><span class="mf">9.5</span><span class="o">/</span><span class="k">data</span><span class="w"></span>
<span class="w"> </span><span class="mi">1371</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">logger</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1378</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">checkpointer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1379</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1381</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">stats</span><span class="w"> </span><span class="n">collector</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1554</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">wal</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1555</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">autovacuum</span><span class="w"> </span><span class="n">launcher</span><span class="w"> </span><span class="n">process</span><span class="w">   </span>
<span class="w"> </span><span class="mi">1556</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">archiver</span><span class="w"> </span><span class="n">process</span><span class="w">   </span><span class="k">last</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="mf">000000020000000000000004.00000060</span><span class="p">.</span><span class="k">backup</span><span class="w"></span>
<span class="w"> </span><span class="mi">3111</span><span class="w"> </span><span class="vm">?</span><span class="w">        </span><span class="n">Ss</span><span class="w">     </span><span class="mi">0</span><span class="err">:</span><span class="mi">00</span><span class="w">  </span><span class="err">\</span><span class="n">_</span><span class="w"> </span><span class="nl">postgres</span><span class="p">:</span><span class="w"> </span><span class="n">wal</span><span class="w"> </span><span class="n">sender</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">repl_user</span><span class="w"> </span><span class="mf">10.155.92.101</span><span class="p">(</span><span class="mi">57142</span><span class="p">)</span><span class="w"> </span><span class="n">streaming</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="mi">5000680</span><span class="w"></span>
<span class="o">[</span><span class="n">root@pgsql2 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="n">psql</span><span class="w"> </span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="ss">&quot;select * from pg_stat_replication&quot;</span><span class="w"></span>
<span class="o">-[</span><span class="n"> RECORD 1 </span><span class="o">]</span><span class="c1">----+------------------------------</span>
<span class="n">pid</span><span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="mi">3111</span><span class="w"></span>
<span class="n">usesysid</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">16394</span><span class="w"></span>
<span class="n">usename</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">repl_user</span><span class="w"></span>
<span class="n">application_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">walreceiver</span><span class="w"></span>
<span class="n">client_addr</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">10.155.92.101</span><span class="w"></span>
<span class="n">client_hostname</span><span class="w">  </span><span class="o">|</span><span class="w"> </span>
<span class="n">client_port</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mi">57142</span><span class="w"></span>
<span class="n">backend_start</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">2016</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">15</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">36</span><span class="err">:</span><span class="mf">12.312321</span><span class="o">+</span><span class="mi">00</span><span class="w"></span>
<span class="n">backend_xmin</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">1842</span><span class="w"></span>
<span class="k">state</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="n">streaming</span><span class="w"></span>
<span class="n">sent_location</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="mi">5000680</span><span class="w"></span>
<span class="n">write_location</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="mi">5000680</span><span class="w"></span>
<span class="n">flush_location</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="mi">5000680</span><span class="w"></span>
<span class="n">replay_location</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="o">/</span><span class="mi">5000680</span><span class="w"></span>
<span class="n">sync_priority</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="n">sync_state</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">async</span><span class="w"></span>
</pre></div>


<h4>スタンバイデータベースを作り直す場合</h4>
<p>スタンバイデータベースの損傷がひどくて起動できない場合は、プライマリデータベースを <code>pg_basebackup</code> コマンドで複製して作り直し、スタンバイ用の設定を加えて起動することになります。</p>
<p>これは上記の「リカバリの実行」でやっていることと同じなので、今のプライマリである pgsql2 で以下のコマンドを実行すれば OK です。</p>
<div class="highlight"><pre><span></span><span class="o">[</span><span class="n">root@pgsql2 pgsql</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">postgres</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">pgpool</span><span class="o">-</span><span class="mf">9.5</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">pcp_recovery_node</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">9898</span><span class="w"> </span><span class="o">-</span><span class="n">U</span><span class="w"> </span><span class="n">pgpool2</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="nl">Password</span><span class="p">:</span><span class="w"> </span>
<span class="n">pcp_recovery_node</span><span class="w"> </span><span class="c1">-- Command Successful</span>
</pre></div>


<h2>おわりに</h2>
<p>さらに pgpool-II が落ちたときやサーバ全体が落ちたときなども検証が必要ですがこのブログ記事を書くのに、今日の早朝と今でなんだかんだで4時間ぐらいはかかっているので (環境構築と動作検証には3日かかってます)、一旦ここまでとします。</p>
<p>pgpool-II でのフェイルオーバ、リカバリは呼び出されるスクリプトをどうすれば良いのかが最初は全くわからなくて苦労しましたが、ドキュメントとソースを読んで理解できたので良かったです。</p>
<p>Pacemaker は高機能なんですが複雑すぎるように私には思えたので、 pgpool-II のほうが好感触です。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>