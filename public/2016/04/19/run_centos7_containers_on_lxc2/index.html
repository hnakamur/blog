<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>LXC 2.0でCentOS 7のコンテナを動かしてみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/04/19/run_centos7_containers_on_lxc2/" rel="bookmark"
           title="Permalink to LXC 2.0でCentOS 7のコンテナを動かしてみた">LXC 2.0でCentOS 7のコンテナを動かしてみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-04-19T06:37:00+09:00">
                Published: 2016-04-19
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/lxc.html">lxc</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<h3>なぜDockerではなくLXCを使うのか</h3>
<p>コンテナと言えばDockerが有名です。Docker 1.9からネットワーク機能が大幅に良くなっていて、Docker Composeでコンテナを作成するとコンテナ名で名前解決できるようになっています。</p>
<p>また公式のCentOS 7コンテナも良くなっていて、Dockerfileに <code>CMD ["/bin/init"]</code> と書いておけば普通に systemd が起動するようになっています。</p>
<p>そして <code>docker run</code> に <code>--privileged</code> オプションを付けて実行すれば実行時に <code>/etc/</code> などの下のファイルを書き換えることも出来ます。</p>
<p>しかしこのような使い方は<a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/">Best practices for writing Dockerfiles</a>と全く合いません。Dockerのベストプラクティスでは1コンテナ1プロセス、コンテナは最小限で使い捨て、ログやデータはコンテナ外部に保存するというスタンスなのです。</p>
<p>一方、本番環境でDockerを使わずAnsibleでプロビジョニングする前提であれば、開発環境もAnsibleでプロビジョニングしたいところです。サーバが1台ならVagrant + VirtualBoxで良いのですが、複数台となると仮想マシンではメモリがたくさん必要になりますのでコンテナを使いたいところです。LXCなら従来のLinuxサーバと同じ感覚で利用できます。</p>
<h3>2016-05-07 追記</h3>
<p><a href="http://hnakamur.github.io/blog/2016/05/07/tried-lxd-2.0-on-ubuntu-16.04/">Ubuntu 16.04 LTSでLXD 2.0を試してみた</a>を書きました。試してみて思ったのは、今から使うならLXC 2.0よりもLXD 2.0のほうが良いということです。この記事よりもこちらをお勧めします。</p>
<h3>Ubuntu 14.04/16.04でLXC 2.0を使う</h3>
<p>LXCもコンテナなのでLinuxカーネルはホストとコンテナで同じものが使われます。CentOS 7単独の環境に近づけるにはホストもCentOS 7にしたいところです。が、現時点ではCentOS 7ではLXCはepelにバージョン1.0.8があるだけです。</p>
<p>LXCはCanonical LtdがUbuntu上で開発しているので、Ubuntu上で使うほうがトラブルは少なくて済むと予想します。ということで、LinuxカーネルのバージョンがCentOS 7と違ってしまうというデメリットはあるのですが、ホストはUbuntuを使うことにします。</p>
<p>Ubuntu 14.04のカーネルのほうがCentOS 7のカーネルより新しいので、アプリケーション開発に使う分にはLinuxカーネルのバージョン違いで影響が出ることはほぼ無いと思います。</p>
<p>2016-04-06にLXC 2.0がリリースされました。<a href="https://linuxcontainers.org/ja/lxc/news/">Linux Containers - LXC - ニュース</a></p>
<p>これは長期サポート(Long-term support; LTS) リリースです。ということで、今から使うなら2.0が良いと思います。</p>
<h2>LXCのセットアップ</h2>
<p>セットアップ用のスクリプトとVagrantfileを書きました。
<a href="https://github.com/hnakamur/setup_lxc_on_vagrant">hnakamur/setup_lxc_on_vagrant: Vagrantfile to set up LXC 2.x on Ubuntu 14.04 or 16.04</a></p>
<p>これを使うと以下の手順でセットアップ出来ます。</p>
<div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">Vagrantfile</span><span class="p">.</span><span class="n">ubuntu1404</span> <span class="n">Vagrantfile</span>
<span class="n">vagrant</span> <span class="n">up</span> <span class="o">&amp;&amp;</span> <span class="n">vagrant</span> <span class="n">reload</span>
</pre></div>


<p>セットアップした後ネットワークの再起動が必要なので <code>vagrant up</code> に加えて <code>vagrant reload</code> を実行しています。</p>
<p>セットアップは<a href="https://github.com/hnakamur/setup_lxc_on_vagrant/blob/master/setup_lxc.sh">setup_lxc.sh</a>というシェルスクリプトになっているので設定内容が気になる方はこちらを参照してください。Vagrantを使わないUbuntu 14.04/16.04環境でもこのスクリプトを実行すればLXCをセットアップできます。</p>
<p>Vagrantの仮想マシンの再起動が終わったら</p>
<div class="highlight"><pre><span></span><span class="n">vagrant</span> <span class="n">ssh</span>
</pre></div>


<p>で仮想マシンに入ってLXCを使います。</p>
<h2>コンテナ作成</h2>
<p>例えばweb01という名前のCentOS 7コンテナを作成するには以下のようにします。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">lxc</span><span class="o">-</span><span class="k">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">web01</span> <span class="o">-</span><span class="n">t</span> <span class="n">download</span> <span class="c1">-- -d centos -r 7 -a amd64</span>
</pre></div>


<p><code>-t</code> はテンプレートを指定するオプションです。centosというテンプレートもあるのですが、それを使うとコンテナの挙動に問題があった (これについては今後別記事で書く予定です) ので、downloadテンプレートを使っています。</p>
<p>初回はコンテナのイメージファイルをダウンロードするので時間がかかります。イメージファイルのサイズは約60MBとそれほど大きくもないのですが、私の環境では20分程度かかる場合もありました。</p>
<h2>コンテナ起動</h2>
<p>web01というコンテナを起動するには以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">lxc</span><span class="o">-</span><span class="k">start</span> <span class="o">-</span><span class="n">n</span> <span class="n">web01</span>
</pre></div>


<h2>コンテナ一覧表示</h2>
<p>以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">lxc</span><span class="o">-</span><span class="n">ls</span> <span class="o">-</span><span class="n">f</span>
</pre></div>


<p>出力例はこんな感じになります。</p>
<div class="highlight"><pre><span></span><span class="n">vagrant</span><span class="nv">@vagrant</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">trusty</span><span class="o">-</span><span class="mi">64</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">lxc</span><span class="o">-</span><span class="n">ls</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"></span>
<span class="n">NAME</span><span class="w">    </span><span class="k">STATE</span><span class="w">   </span><span class="n">AUTOSTART</span><span class="w"> </span><span class="n">GROUPS</span><span class="w"> </span><span class="n">IPV4</span><span class="w">       </span><span class="n">IPV6</span><span class="w"></span>
<span class="n">web01</span><span class="w">   </span><span class="n">RUNNING</span><span class="w"> </span><span class="mi">0</span><span class="w">         </span><span class="o">-</span><span class="w">      </span><span class="mf">10.0.3.244</span><span class="w">  </span><span class="o">-</span><span class="w"></span>
</pre></div>


<p>起動直後に実行するとIPv4の列が-になっています。数秒立ってから再度実行するとIPアドレスがDHCPで設定されて表示されます。</p>
<h3>コンテナ名でDNSを引けるか確認</h3>
<div class="highlight"><pre><span></span><span class="n">vagrant</span><span class="nv">@vagrant</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">trusty</span><span class="o">-</span><span class="mi">64</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">dig</span><span class="w"> </span><span class="o">+</span><span class="n">short</span><span class="w"> </span><span class="n">web01</span><span class="w"></span>
<span class="mf">10.0.3.244</span><span class="w"></span>
</pre></div>


<p>なお、LXCのdnsmasqで引けるようにするために<a href="http://www.clear-code.com/blog/2014/7/30.html#.2Fetc.2Fresolve.conf.E3.81.ABnameserver.E3.82.92.E8.BF.BD.E5.8A.A0.E3.81.99.E3.82.8B">LXCコンテナに名前でアクセスする方法 - ククログ(2014-07-30)</a>を参考に https://github.com/hnakamur/setup_lxc_on_vagrant/blob/8dac97e2c0dafe3bad275f733a549f7b03477cb4/setup_lxc.sh#L40-L43 で設定しています。情報共有ありがとうございます！</p>
<h2>コンテナ内に入る</h2>
<p>web01というコンテナ内に入るには以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">lxc</span><span class="o">-</span><span class="n">attach</span> <span class="o">-</span><span class="n">n</span> <span class="n">web01</span>
</pre></div>


<p>コンテナ内でシェルのプロンプトが表示されますので、好きなコマンドを実行してください。 <code>exit</code> で抜けます。実行例を以下に示します。</p>
<div class="highlight"><pre><span></span><span class="n">vagrant</span><span class="nv">@vagrant</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">trusty</span><span class="o">-</span><span class="mi">64</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">lxc</span><span class="o">-</span><span class="n">attach</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">web01</span><span class="w"></span>
<span class="n">bash</span><span class="o">-</span><span class="mf">4.2</span><span class="err">#</span><span class="w"> </span><span class="n">ip</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
<span class="mi">1</span><span class="err">:</span><span class="w"> </span><span class="nl">lo</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">LOOPBACK</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mtu</span><span class="w"> </span><span class="mi">65536</span><span class="w"> </span><span class="n">qdisc</span><span class="w"> </span><span class="n">noqueue</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="k">UNKNOWN</span><span class="w"></span>
<span class="w">    </span><span class="n">link</span><span class="o">/</span><span class="n">loopback</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="err">:</span><span class="mi">00</span><span class="w"></span>
<span class="w">    </span><span class="n">inet</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">8</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="k">host</span><span class="w"> </span><span class="n">lo</span><span class="w"></span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"></span>
<span class="w">    </span><span class="n">inet6</span><span class="w"> </span><span class="o">::</span><span class="mi">1</span><span class="o">/</span><span class="mi">128</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="k">host</span><span class="w"></span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"></span>
<span class="mi">9</span><span class="err">:</span><span class="w"> </span><span class="nl">eth0</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mtu</span><span class="w"> </span><span class="mi">1500</span><span class="w"> </span><span class="n">qdisc</span><span class="w"> </span><span class="n">pfifo_fast</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="n">UP</span><span class="w"> </span><span class="n">qlen</span><span class="w"> </span><span class="mi">1000</span><span class="w"></span>
<span class="w">    </span><span class="n">link</span><span class="o">/</span><span class="n">ether</span><span class="w"> </span><span class="nl">fe</span><span class="p">:</span><span class="mi">74</span><span class="err">:</span><span class="mi">45</span><span class="err">:</span><span class="mi">50</span><span class="err">:</span><span class="mi">85</span><span class="err">:</span><span class="mi">27</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="n">ff</span><span class="w"></span>
<span class="w">    </span><span class="n">inet</span><span class="w"> </span><span class="mf">10.0.3.11</span><span class="o">/</span><span class="mi">24</span><span class="w"> </span><span class="n">brd</span><span class="w"> </span><span class="mf">10.0.3.255</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="k">dynamic</span><span class="w"> </span><span class="n">eth0</span><span class="w"></span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="mi">3219</span><span class="n">sec</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="mi">3219</span><span class="n">sec</span><span class="w"></span>
<span class="w">    </span><span class="n">inet6</span><span class="w"> </span><span class="nl">fe80</span><span class="p">:</span><span class="err">:</span><span class="nl">fc74</span><span class="p">:</span><span class="mi">45</span><span class="nl">ff</span><span class="p">:</span><span class="nl">fe50</span><span class="p">:</span><span class="mi">8527</span><span class="o">/</span><span class="mi">64</span><span class="w"> </span><span class="k">scope</span><span class="w"> </span><span class="n">link</span><span class="w"></span>
<span class="w">       </span><span class="n">valid_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"> </span><span class="n">preferred_lft</span><span class="w"> </span><span class="n">forever</span><span class="w"></span>
<span class="n">bash</span><span class="o">-</span><span class="mf">4.2</span><span class="err">#</span><span class="w"> </span><span class="n">exitvagrant</span><span class="nv">@vagrant</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">trusty</span><span class="o">-</span><span class="mi">64</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"></span>
</pre></div>


<p>↑exitの後returnキーを押しても改行されませんでした。</p>
<h2>コンテナを停止する</h2>
<p>以下のようにして停止します。</p>
<div class="highlight"><pre><span></span>$ sudo lxc-stop -n web01
vagrant@vagrant-ubuntu-trusty-64:~$ sudo lxc-ls -f
NAME    STATE   AUTOSTART GROUPS IPV4       IPV6
web01   STOPPED <span class="m">0</span>         -      -          -
</pre></div>


<h3>lxc-stopですぐに停止するには以下の設定が必要</h3>
<p>downloadテンプレートで作成したCentOS 7コンテナはそのままだと、lxc-stopで停止するのに1分間待たされます。</p>
<p><a href="https://lists.linuxcontainers.org/pipermail/lxc-users/2014-February/006304.html">[lxc-users] lxc-stop doesn't stop centos, waits for the timeout</a>を参考に、コンテナ内で</p>
<div class="highlight"><pre><span></span><span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">halt</span><span class="p">.</span><span class="n">target</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="k">system</span><span class="o">/</span><span class="n">sigpwr</span><span class="p">.</span><span class="n">target</span>
</pre></div>


<p>を実行すれば、lxc-stopですぐに停止できました。</p>
<h2>コンテナを削除する</h2>
<div class="highlight"><pre><span></span><span class="n">vagrant</span><span class="nv">@vagrant</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">trusty</span><span class="o">-</span><span class="mi">64</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">lxc</span><span class="o">-</span><span class="k">destroy</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">web01</span><span class="w"></span>
<span class="n">Destroyed</span><span class="w"> </span><span class="n">container</span><span class="w"> </span><span class="n">web01</span><span class="w"></span>
<span class="n">vagrant</span><span class="nv">@vagrant</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">trusty</span><span class="o">-</span><span class="mi">64</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">lxc</span><span class="o">-</span><span class="n">ls</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"></span>
<span class="n">vagrant</span><span class="nv">@vagrant</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">trusty</span><span class="o">-</span><span class="mi">64</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"></span>
</pre></div>


<h3>ホストでLXCサービス起動時にコンテナを自動起動する</h3>
<p><code>/var/lib/lxc/${コンテナ名}/config</code> ファイルに以下の行を追加します。</p>
<div class="highlight"><pre><span></span><span class="n">lxc</span><span class="p">.</span><span class="k">start</span><span class="p">.</span><span class="n">auto</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>


<p>複数コンテナ間の依存関係を指定して起動の順序を制御するなど高度な指定については加藤泰文さんの<a href="http://gihyo.jp/admin/serial/01/linux_containers/0025?page=1">第25回　LXCの構築・活用 [11] ─lxc-autostartコマンドによるコンテナの自動起動：LXCで学ぶコンテナ入門 －軽量仮想化環境を実現する技術｜gihyo.jp … 技術評論社</a>の記事をご参照ください。私は複雑な指定は試してないです。</p>
<h2>おわりに</h2>
<p>Ubuntu 14.04上でLXC 2.0をセットアップして使う手順についてまとめました。</p>
<p>コンテナの作成とプロビジョニングについてはAnsible playbookのサンプルも作ったので今後別記事で書く予定です。また、この記事では触れなかったハマりネタもいくつかあったのでそれも今度書こうと思います。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>