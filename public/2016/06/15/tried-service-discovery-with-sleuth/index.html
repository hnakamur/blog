<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>sleuthというGoのライブラリでサービスディスカバリを試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/06/15/tried-service-discovery-with-sleuth/" rel="bookmark"
           title="Permalink to sleuthというGoのライブラリでサービスディスカバリを試してみた">sleuthというGoのライブラリでサービスディスカバリを試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-06-15T06:56:00+09:00">
                Published: 2016-06-15
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/golang.html">golang</a> <a href="../../../../tag/service-discovery.html">service-discovery</a> <a href="../../../../tag/sleuth.html">sleuth</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p><a href="http://darian.af/post/master-less-peer-to-peer-micro-service-autodiscovery-in-golang-with-sleuth/">Service autodiscovery in Go with sleuth - darian.af</a>という記事を見かけて試してみたのでメモです。</p>
<h2>github.com/ursiform/sleuthのセットアップ</h2>
<p><a href="https://github.com/ursiform/sleuth#installation">Installation</a>を見ながらセットアップします。</p>
<p>いきなりgo getでインストールしてみるとZeroMQ version 4が必要というエラーメッセージが出ました。</p>
<div class="highlight"><pre><span></span>$ go get -u github.com/ursiform/sleuth
<span class="c1"># github.com/pebbe/zmq4</span>
In file included from ../../../pebbe/zmq4/ctxoptions_unix.go:7:0:
zmq4.h:2:2: error: <span class="c1">#error &quot;You need ZeroMQ version 4 to build this&quot;</span>
 <span class="c1">#error &quot;You need ZeroMQ version 4 to build this&quot;</span>
  ^
</pre></div>


<p>Ubuntu 16.04では</p>
<div class="highlight"><pre><span></span>sudo apt install -y libzmq3-dev
</pre></div>


<p>CentOS 7では</p>
<div class="highlight"><pre><span></span>sudo yum install -y zeromq-devel
</pre></div>


<p>でZeroMQ 4.xのライブラリとヘッダファイルがインストールできます。</p>
<p>このあとで go get でsleuthをインストールすると今度は大丈夫でした。</p>
<div class="highlight"><pre><span></span>$ go get -u github.com/ursiform/sleuth
</pre></div>


<h2>動作確認のためエコーバックのサービスの例を試す</h2>
<p><a href="https://github.com/ursiform/sleuth#examples">Examples</a>のExample (1)にエコーバックのサーバとクライアントがあるのでそれを試します。</p>
<p>コードをコピペするのが面倒な人は</p>
<div class="highlight"><pre><span></span>go get -d github.com/hnakamur/sleuth-echo-example
</pre></div>


<p>で取得できます。</p>
<p>以下のコマンドでプロジェクトのディレクトリに移動します。</p>
<div class="highlight"><pre><span></span>cd $GOPATH/src/github.com/hnakamur/sleuth-echo-example
</pre></div>


<p>以下のコマンドでエコーバックのサーバを起動します。</p>
<div class="highlight"><pre><span></span>(cd echo-server &amp;&amp; go run main.go &amp;)
</pre></div>


<p>起動すると以下のようなログが出力されます。</p>
<div class="highlight"><pre><span></span>2016/06/15 06:54:06 [**warning**] sleuth: config.Interface not defined [801]
2016/06/15 06:54:06 [ listening ] sleuth: [SLEUTH-v0:5670][echo-service E13055]
</pre></div>


<p>以下のコマンドでクライアントを実行し、"It works." と表示されれば成功です。</p>
<div class="highlight"><pre><span></span>$ <span class="o">(</span><span class="nb">cd</span> echo-client <span class="o">&amp;&amp;</span> go run main.go<span class="o">)</span>
It works.
</pre></div>


<p>curlでも試してみます。</p>
<div class="highlight"><pre><span></span>$ curl -s -d Hello <span class="m">127</span>.0.0.1:9873/echo-service/
Hello
</pre></div>


<h2>サービスディスカバリの例を試す</h2>
<div class="highlight"><pre><span></span>go get -u github.com/afshin/sleuth-example/...
</pre></div>


<p>でサンプルのコードと依存するライブラリを取得し</p>
<div class="highlight"><pre><span></span>cd $GOPATH/src/github.com/afshin/sleuth-example
</pre></div>


<p>でプロジェクトのディレクトリに移動します。</p>
<p>この例にはarticle-serviceとcomment-serviceという2つのサービスが含まれています。</p>
<p>まずは article-service を起動します。article-serviceはポート9872で起動されます。</p>
<div class="highlight"><pre><span></span>$ <span class="o">(</span><span class="nb">cd</span> article-service <span class="o">&amp;&amp;</span> go run main.go<span class="o">)</span>
<span class="m">2016</span>/06/14 <span class="m">22</span>:38:08 <span class="o">[</span>**warning**<span class="o">]</span> sleuth: config.Interface not defined <span class="o">[</span><span class="m">801</span><span class="o">]</span>
<span class="m">2016</span>/06/14 <span class="m">22</span>:38:08 <span class="o">[</span> listening <span class="o">]</span> sleuth: <span class="o">[</span>SLEUTH-v0:5670<span class="o">][</span>client-only EC740A<span class="o">]</span>
<span class="m">2016</span>/06/14 <span class="m">22</span>:38:08 <span class="o">[</span>**blocked**<span class="o">]</span> sleuth: waiting <span class="k">for</span> client to find <span class="o">[</span>comment-service<span class="o">]</span>
</pre></div>


<p>ログに書かれているようにcomment-serviceが見つからなくて待っている状態です。</p>
<p>別の端末を開いて以下のコマンドを実行してcomment-serviceを起動します。comment-serviceはポート9871で起動されます。</p>
<div class="highlight"><pre><span></span>$ <span class="o">(</span><span class="nb">cd</span> comment-service <span class="o">&amp;&amp;</span> go run main.go<span class="o">)</span>
<span class="m">2016</span>/06/15 <span class="m">07</span>:47:42 <span class="o">[</span>**warning**<span class="o">]</span> sleuth: config.Interface not defined <span class="o">[</span><span class="m">801</span><span class="o">]</span>
<span class="m">2016</span>/06/15 <span class="m">07</span>:47:42 <span class="o">[</span> listening <span class="o">]</span> sleuth: <span class="o">[</span>SLEUTH-v0:5670<span class="o">][</span>comment-service 0DBE04<span class="o">]</span>
ready...
</pre></div>


<p>comment-serviceを起動するとarticle-serviceの端末には以下のログが追加で出力されます。</p>
<div class="highlight"><pre><span></span>2016/06/15 07:47:43 [*unblocked*] sleuth: client found [comment-service]
ready...
</pre></div>


<p>つまりarticle-serviceがcomment-serviceを発見（サービスディカバリ）出来たということです。</p>
<p>別の端末を開いて以下のコマンドを実行してcurlでarticle-serviceから記事のデータを1件取得してみます。</p>
<div class="highlight"><pre><span></span>$ curl -s localhost:9872/articles/049cd8fc-a66b-4a3d-956b-7c2ab5fb9c5d <span class="p">|</span> jq .
<span class="o">{</span>
  <span class="s2">&quot;success&quot;</span>: true,
  <span class="s2">&quot;data&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;guid&quot;</span>: <span class="s2">&quot;049cd8fc-a66b-4a3d-956b-7c2ab5fb9c5d&quot;</span>,
    <span class="s2">&quot;byline&quot;</span>: <span class="s2">&quot;Kristen Rasmussen&quot;</span>,
    <span class="s2">&quot;headline&quot;</span>: <span class="s2">&quot;Wanting the Unwanted: Why Eat Weeds&quot;</span>,
    <span class="s2">&quot;url&quot;</span>: <span class="s2">&quot;http://www.rootedfood.com/musings/2015/4/1/a-foraged-affair&quot;</span>,
    <span class="s2">&quot;time&quot;</span>: <span class="m">1428168580</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>comment-serviceからコメントのデータを1件取得します。</p>
<div class="highlight"><pre><span></span>$ curl -s localhost:9871/comments/06500da3-f9b0-4731-b0fa-fbc6cbe8c155 <span class="p">|</span> jq .
<span class="o">{</span>
  <span class="s2">&quot;success&quot;</span>: true,
  <span class="s2">&quot;data&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;guid&quot;</span>: <span class="s2">&quot;d7041752-6854-4b2c-ad6d-1b48d898668d&quot;</span>,
      <span class="s2">&quot;article&quot;</span>: <span class="s2">&quot;06500da3-f9b0-4731-b0fa-fbc6cbe8c155&quot;</span>,
      <span class="s2">&quot;text&quot;</span>: <span class="s2">&quot;Star Trek, on the other hand, consistently presents an optimistic view of our capacity for civilization. I love science-fiction, even when it&amp;#x27;s dystopian. But why does so much of it have to be dystopian?&quot;</span>,
      <span class="s2">&quot;time&quot;</span>: <span class="m">1452738329</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</pre></div>


<p>次に2つのサービスを連携させた使い方として、以下のコマンドで1件の記事とそれに紐づくコメントを取得します。</p>
<div class="highlight"><pre><span></span>$ curl -s localhost:9872/articles/049cd8fc-a66b-4a3d-956b-7c2ab5fb9c5d?includecomments<span class="o">=</span><span class="nb">true</span> <span class="p">|</span> jq .
<span class="o">{</span>
  <span class="s2">&quot;success&quot;</span>: true,
  <span class="s2">&quot;data&quot;</span>: <span class="o">{</span>
    <span class="s2">&quot;guid&quot;</span>: <span class="s2">&quot;049cd8fc-a66b-4a3d-956b-7c2ab5fb9c5d&quot;</span>,
    <span class="s2">&quot;byline&quot;</span>: <span class="s2">&quot;Kristen Rasmussen&quot;</span>,
    <span class="s2">&quot;comments&quot;</span>: <span class="o">[</span>
      <span class="o">{</span>
        <span class="s2">&quot;guid&quot;</span>: <span class="s2">&quot;1b1e937b-8521-4c88-a13c-105d421ea030&quot;</span>,
        <span class="s2">&quot;article&quot;</span>: <span class="s2">&quot;049cd8fc-a66b-4a3d-956b-7c2ab5fb9c5d&quot;</span>,
        <span class="s2">&quot;text&quot;</span>: <span class="s2">&quot;I believe the premise to be false, while it is true that you can eat many different &amp;quot;weeds&amp;quot; I cannot find any methodology or theory where that doing so increases the efficiency of land use. There are some key things like nutrients in == nutrie</span>
<span class="s2">nts out and digestibility in humans which is not a given.&lt;p&gt;That said, there were some interesting recipes for what are nominally weeds in the Foxfire[1], and Euell Gibbons books[2] which were certainly edible although nothing I&amp;#x27;ve tried really struck me as excepti</span>
<span class="s2">onal. As Boy Scouts we got a merit badge for creating a meal out of locally harvested plants, that was fun.&lt;p&gt;[1] &lt;a href=\&quot;http:&amp;#x2F;&amp;#x2F;www.foxfire.org&amp;#x2F;thefoxfirebooks.aspx\&quot; rel=\&quot;nofollow\&quot;&gt;http:&amp;#x2F;&amp;#x2F;www.foxfire.org&amp;#x2F;thefoxfirebooks.aspx&lt;/a&gt;&lt;p&gt;[2]</span>
<span class="s2"> &lt;a href=\&quot;http:&amp;#x2F;&amp;#x2F;www.amazon.com&amp;#x2F;Euell-Gibbons-Handbook-Edible-Plants&amp;#x2F;dp&amp;#x2F;0915442787\&quot; rel=\&quot;nofollow\&quot;&gt;http:&amp;#x2F;&amp;#x2F;www.amazon.com&amp;#x2F;Euell-Gibbons-Handbook-Edible-Plants&amp;#x2F;d...&lt;/a&gt;&quot;</span>,
        <span class="s2">&quot;time&quot;</span>: <span class="m">1428172888</span>
      <span class="o">}</span>,
      <span class="o">{</span>
        <span class="s2">&quot;guid&quot;</span>: <span class="s2">&quot;1ffa59ea-1b62-41fe-87c3-98ec6901d768&quot;</span>,
        <span class="s2">&quot;article&quot;</span>: <span class="s2">&quot;049cd8fc-a66b-4a3d-956b-7c2ab5fb9c5d&quot;</span>,
        <span class="s2">&quot;text&quot;</span>: <span class="s2">&quot;Something to keep in mind here is that once a viable market is found then the product will be fully commercialised and mass-produced.  No longer will poor conditions be good enough when compared to the yield you get from ideal conditions.&lt;p&gt;Then we will</span>
<span class="s2"> start fertilising them, then tweaking the seeds etc etc etc. And before long it will be just like anything else grown on the land.&quot;</span>,
        <span class="s2">&quot;time&quot;</span>: <span class="m">1428188859</span>
      <span class="o">}</span>,
…<span class="o">(</span>略<span class="o">)</span>…
        <span class="s2">&quot;guid&quot;</span>: <span class="s2">&quot;587b528f-f4fe-4620-959e-f0d087c97348&quot;</span>,
        <span class="s2">&quot;article&quot;</span>: <span class="s2">&quot;049cd8fc-a66b-4a3d-956b-7c2ab5fb9c5d&quot;</span>,
        <span class="s2">&quot;text&quot;</span>: <span class="s2">&quot;The premise that weeds are a suitable food for humans is wrong. Most of these plants are loaded with toxins. You can&amp;#x27;t eat them in any quantity for calories without getting poisoned.&lt;p&gt;Cows and goats and sheep can eat these things, though, because </span>
<span class="s2">they have more advanced digestive systems. The udder provides an added toxin filtration system.&lt;p&gt;In theory you might be able to design an efficient system to detoxify wild plants such as grass and weeds directly into a high quality human food. At this moment cheese is </span>
<span class="s2">already an incredibly effective way to use wild forage to make human food.&quot;</span>,
        <span class="s2">&quot;time&quot;</span>: <span class="m">1428192718</span>
      <span class="o">}</span>
    <span class="o">]</span>,
    <span class="s2">&quot;headline&quot;</span>: <span class="s2">&quot;Wanting the Unwanted: Why Eat Weeds&quot;</span>,
    <span class="s2">&quot;url&quot;</span>: <span class="s2">&quot;http://www.rootedfood.com/musings/2015/4/1/a-foraged-affair&quot;</span>,
    <span class="s2">&quot;time&quot;</span>: <span class="m">1428168580</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2>sleuthのQ &amp; Aを見てみる</h2>
<p><a href="https://github.com/ursiform/sleuth#q--a">Q &amp; A</a>を見ると、sleuthのメッセージプロトコルはJSONをgzipしてHTTPで通信しているとのことです。Protocol Buffersなどの他のライブラリに依存するのを避けたいという意図で、マイクロサービスのAPIレスポンスのほとんどは小さいのでJSONをgzipする方式で十分だし、そのほうがGo以外の言語でも利用しやすいので良いだろうということです。</p>
<p>sleuthは熊のグループの集合名詞とのことです。</p>
<h2>おわりに</h2>
<p>sleuthはzeromqとGoさえあれば使えるということでセットアップが簡単です。</p>
<p>サービスの実装<a href="https://github.com/afshin/sleuth-example/blob/master/article-service/main.go">sleuth-example/main.go</a>と<a href="https://github.com/afshin/sleuth-example/blob/master/comment-service/main.go">sleuth-example/main.go</a>も、Goで普通にウェブサービスを実装したところに、sleuthを使うためのコードを少し足すだけでいいのでお手軽でいいですね。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>