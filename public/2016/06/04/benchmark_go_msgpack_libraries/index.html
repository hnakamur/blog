<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>GoのMessagePackのライブラリのベンチマークをしてみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/06/04/benchmark_go_msgpack_libraries/" rel="bookmark"
           title="Permalink to GoのMessagePackのライブラリのベンチマークをしてみた">GoのMessagePackのライブラリのベンチマークをしてみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-06-04T22:17:00+09:00">
                Published: 2016-06-04
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/golang.html">golang</a> <a href="../../../../tag/messagepack.html">messagepack</a> </p>
</footer><!-- /.post-info -->      <p><a href="http://qiita.com/yosisa/items/f21d3476bc8d368d7494">Go の msgpack ライブラリ比較 - Qiita</a>の記事が最終更新日から1年以上経過しているとのことなので、現在の最新のコミットで試してみました。</p>
<p><code>github.com/vmihailenco/msgpack</code> を <code>go get</code> すると</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">go</span> <span class="n">get</span> <span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">vmihailenco</span><span class="o">/</span><span class="n">msgpack</span>
<span class="n">package</span> <span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">vmihailenco</span><span class="o">/</span><span class="n">msgpack</span><span class="p">:</span> <span class="n">code</span> <span class="ow">in</span> <span class="n">directory</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="n">gocode</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">vmihailenco</span><span class="o">/</span><span class="n">msgpack</span> <span class="n">expects</span> <span class="kn">import</span> <span class="s2">&quot;gopkg.in/vmihailenco/msgpack.v2&quot;</span>
</pre></div>


<p>と言われたので <code>go get gopkg.in/vmihailenco/msgpack.v2</code> で取得し、この記事のコードの <code>"github.com/vmihailenco/msgpack"</code> を <code>"gopkg.in/vmihailenco/msgpack.v2"</code> に書き換え <code>msgpack_test.go</code> という名前で保存して試しました。</p>
<p>エンコードは <code>gopkg.in/vmihailenco/msgpack.v2</code> 、デコードは <code>github.com/ugorji/go/codec</code> が速いという結果になりましたが、総合的にはほぼ同等と言えると思います。</p>
<div class="highlight"><pre><span></span>$ go <span class="nb">test</span> -bench . -benchmem
testing: warning: no tests to run
PASS
BenchmarkCodecEncode-2            <span class="m">500000</span>              <span class="m">3236</span> ns/op              <span class="m">48</span> B/op          <span class="m">2</span> allocs/op
BenchmarkCodecDecode-2            <span class="m">200000</span>              <span class="m">8998</span> ns/op             <span class="m">264</span> B/op         <span class="m">25</span> allocs/op
BenchmarkMsgpackEncode-2          <span class="m">500000</span>              <span class="m">2624</span> ns/op              <span class="m">48</span> B/op          <span class="m">2</span> allocs/op
BenchmarkMsgpackDecode-2          <span class="m">200000</span>             <span class="m">10604</span> ns/op             <span class="m">448</span> B/op         <span class="m">35</span> allocs/op
ok      bitbucket.org/hnakamur/msgpack_experiment       <span class="m">7</span>.146s
</pre></div>


<p>ベンチマークに使用したライブラリとGoのバージョンは以下の通りです。</p>
<div class="highlight"><pre><span></span>$ git -C <span class="nv">$GOPATH</span>/src/github.com/ugorji/go rev-parse HEAD
a396ed22fc049df733440d90efe17475e3929ccb
$ git -C <span class="nv">$GOPATH</span>/src/gopkg.in/vmihailenco/msgpack.v2 rev-parse HEAD
851cd631b60599a692b136c60eb6eb2899b0e664
$ go version
go version go1.6.2 linux/amd64
</pre></div>


<p><a href="https://github.com/vmihailenco/msgpack">vmihailenco/msgpack: MessagePack encoding for Golang</a>のベンチマークもやってみました。</p>
<div class="highlight"><pre><span></span>$ go <span class="nb">test</span> -bench . -benchmem                                          
<span class="m">2016</span>/06/04 <span class="m">22</span>:12:13 
************************************************ 
package github.com/ugorji/go-msgpack has been deprecated <span class="o">(</span><span class="m">05</span>/29/2013<span class="o">)</span>. 
It will be retired anytime from July <span class="m">1</span>, <span class="m">2013</span>.
Please update to faster and much much better github.com/ugorji/go/codec.
See https://github.com/ugorji/go/tree/master/codec#readme <span class="k">for</span> more information.
************************************************ 
OK: <span class="m">27</span> passed, <span class="m">1</span> skipped
PASS
BenchmarkBool-2                         <span class="m">20000000</span>                <span class="m">90</span>.3 ns/op             <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
BenchmarkInt0-2                         <span class="m">20000000</span>                <span class="m">96</span>.1 ns/op             <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
BenchmarkInt1-2                         <span class="m">10000000</span>               <span class="m">123</span> ns/op               <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
BenchmarkInt2-2                         <span class="m">10000000</span>               <span class="m">123</span> ns/op               <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
BenchmarkInt4-2                         <span class="m">10000000</span>               <span class="m">179</span> ns/op               <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
BenchmarkInt8-2                         <span class="m">10000000</span>               <span class="m">176</span> ns/op               <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
BenchmarkInt0Binary-2                    <span class="m">5000000</span>               <span class="m">340</span> ns/op              <span class="m">24</span> B/op          <span class="m">3</span> allocs/op
BenchmarkInt0UgorjiGoMsgpack-2           <span class="m">3000000</span>               <span class="m">586</span> ns/op               <span class="m">8</span> B/op          <span class="m">1</span> allocs/op
BenchmarkInt0UgorjiGoCodec-2             <span class="m">5000000</span>               <span class="m">360</span> ns/op               <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
BenchmarkTime-2                          <span class="m">5000000</span>               <span class="m">353</span> ns/op               <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
BenchmarkDuration-2                     <span class="m">10000000</span>               <span class="m">180</span> ns/op               <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
BenchmarkByteSlice-2                     <span class="m">1000000</span>              <span class="m">1021</span> ns/op            <span class="m">1024</span> B/op          <span class="m">1</span> allocs/op
BenchmarkByteArray-2                      <span class="m">500000</span>              <span class="m">2741</span> ns/op            <span class="m">2112</span> B/op          <span class="m">4</span> allocs/op
BenchmarkByteSliceUgorjiGoCodec-2        <span class="m">2000000</span>               <span class="m">647</span> ns/op               <span class="m">0</span> B/op          <span class="m">0</span> allocs/op
BenchmarkByteArrayUgorjiGoCodec-2        <span class="m">1000000</span>              <span class="m">2632</span> ns/op            <span class="m">1088</span> B/op          <span class="m">3</span> allocs/op
BenchmarkMapStringString-2               <span class="m">1000000</span>              <span class="m">1898</span> ns/op              <span class="m">16</span> B/op          <span class="m">4</span> allocs/op
BenchmarkMapStringStringPtr-2             <span class="m">500000</span>              <span class="m">2461</span> ns/op              <span class="m">32</span> B/op          <span class="m">5</span> allocs/op
BenchmarkMapStringStringUgorjiGoCodec-2  <span class="m">1000000</span>              <span class="m">1737</span> ns/op              <span class="m">16</span> B/op          <span class="m">4</span> allocs/op
BenchmarkMapIntInt-2                      <span class="m">500000</span>              <span class="m">3424</span> ns/op             <span class="m">208</span> B/op         <span class="m">10</span> allocs/op
BenchmarkStringSlice-2                   <span class="m">3000000</span>               <span class="m">530</span> ns/op              <span class="m">10</span> B/op          <span class="m">2</span> allocs/op
BenchmarkStringSlicePtr-2                <span class="m">1000000</span>              <span class="m">1270</span> ns/op              <span class="m">26</span> B/op          <span class="m">3</span> allocs/op
BenchmarkStructVmihailencoMsgpack-2       <span class="m">100000</span>             <span class="m">12732</span> ns/op            <span class="m">3152</span> B/op         <span class="m">27</span> allocs/op
BenchmarkStructMarshal-2                  <span class="m">300000</span>              <span class="m">6003</span> ns/op            <span class="m">1808</span> B/op          <span class="m">8</span> allocs/op
BenchmarkStructUnmarshal-2                <span class="m">200000</span>              <span class="m">5788</span> ns/op            <span class="m">1344</span> B/op         <span class="m">19</span> allocs/op
BenchmarkStructManual-2                   <span class="m">200000</span>              <span class="m">6610</span> ns/op            <span class="m">2720</span> B/op         <span class="m">21</span> allocs/op
BenchmarkStructUgorjiGoMsgpack-2          <span class="m">100000</span>             <span class="m">17138</span> ns/op            <span class="m">3616</span> B/op         <span class="m">70</span> allocs/op
BenchmarkStructUgorjiGoCodec-2            <span class="m">100000</span>             <span class="m">21833</span> ns/op            <span class="m">7345</span> B/op         <span class="m">23</span> allocs/op
BenchmarkStructJSON-2                      <span class="m">20000</span>             <span class="m">63809</span> ns/op            <span class="m">7896</span> B/op         <span class="m">26</span> allocs/op
BenchmarkStructGOB-2                       <span class="m">20000</span>             <span class="m">96275</span> ns/op           <span class="m">14664</span> B/op        <span class="m">278</span> allocs/op
BenchmarkStructUnmarshalPartially-2       <span class="m">300000</span>              <span class="m">5791</span> ns/op            <span class="m">2272</span> B/op         <span class="m">12</span> allocs/op
BenchmarkCSV-2                            <span class="m">200000</span>              <span class="m">6971</span> ns/op            <span class="m">8748</span> B/op         <span class="m">12</span> allocs/op
BenchmarkCSVMsgpack-2                    <span class="m">1000000</span>              <span class="m">1541</span> ns/op             <span class="m">384</span> B/op         <span class="m">13</span> allocs/op
ok      gopkg.in/vmihailenco/msgpack.v2 <span class="m">58</span>.623s
</pre></div>


<h2>gopkg.in/vmihailenco/msgpack.v2 でGoのstructをエンコード・デコードするインターフェース</h2>
<p><a href="https://godoc.org/gopkg.in/vmihailenco/msgpack.v2#Marshaler">Marshaler</a> はdeprecatedで<a href="https://godoc.org/gopkg.in/vmihailenco/msgpack.v2#CustomEncoder">CustomEncoder</a>を使えとのことです。<a href="https://godoc.org/gopkg.in/vmihailenco/msgpack.v2#CustomEncoder">CustomEncoder</a> の Example を見ると使い方も簡単そうです。</p>
<h2>gopkg.in/vmihailenco/msgpack.v2 を使うことにします</h2>
<p><a href="https://github.com/vmihailenco/msgpack">github.com/vmihailenco/msgpack</a>も<a href="https://github.com/ugorji/go/tree/master/codec">go/codec at master · ugorji/go</a>も活発にメンテナンスされているようです。</p>
<p>APIドキュメント <a href="https://godoc.org/gopkg.in/vmihailenco/msgpack.v2">gopkg.in/vmihailenco/msgpack.v2</a>、<a href="https://godoc.org/github.com/ugorji/go/codec">github.com/ugorji/go/codec</a> を見ると私は前者のほうがしっくりきました。ということで gopkg.in/vmihailenco/msgpack.v2 を使うことにします。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>