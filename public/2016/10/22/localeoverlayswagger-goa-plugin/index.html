<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>

        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <title>LocaleOverlaySwaggerというgoaプラグインを書いた &middot; hnakamur&#39;s blog at github</title>
        <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css'>
        <link rel="stylesheet" href="https://hnakamur.github.io/blog//libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://hnakamur.github.io/blog//css/liquorice.css" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="alternate" href="" type="application/rss+xml" title="hnakamur&#39;s blog at github" />
        
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', "UA-53263855-1", 'auto');
    ga('send', 'pageview');
</script>




    </head>
    <body class="li-body">

<header class="li-page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://hnakamur.github.io/blog/">hnakamur&#39;s blog at github</a></div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                </ul>
            </div>
        </div>
    </div>
</header>


    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">LocaleOverlaySwaggerというgoaプラグインを書いた</h1>
                        <time class="li-article-date">2016-10-22</time>
                    </header>
                    <section>
                        

<h2 id="まず-swagger-仕様を複数ファイル出力する-goa-プラグイン-multiswagger-を試してみました">まず Swagger 仕様を複数ファイル出力する goa プラグイン Multiswagger を試してみました</h2>

<p>まずは <a href="http://tchssk.hatenablog.com/entry/2016/10/18/122215">Swagger 仕様を複数ファイル出力する goa プラグイン Multiswagger を作った - tchsskのブログ</a> を読んで試してみました。</p>

<p><a href="https://github.com/goadesign/goa/">goadesign/goa: Design-based APIs and microservices in Go</a> の README からリンクされているサンプル <a href="https://github.com/goadesign/goa-cellar">goadesign/goa-cellar: goa winecellar example service</a> の <code>design.go</code> の各種項目の <code>Title</code> や <code>Description</code> の値に JSON を書いて英語と日本語の説明を書いてみた例が <a href="https://github.com/hnakamur/goa-getting-started/blob/use_multiswagger/design/design.go">goa-getting-started/design.go</a> です。　</p>

<p>私が試したバージョンの <a href="https://github.com/tchssk/multiswagger/tree/7ad4f69b2209316035dd222819228f90327cd1f3">Multiswagger at 7ad4f69b2209316035dd222819228f90327cd1f3</a> では <a href="https://github.com/hnakamur/goa-getting-started/blob/4bef7925510700d8797831f3bb665eb87c8ca6b9/design/design.go#L8-L19">API定義</a> の <code>Title</code> や <code>Definition</code> は非対応だったので、 <a href="https://github.com/tchssk/multiswagger/compare/master...hnakamur:support_more_fields">Comparing tchssk:master&hellip;hnakamur:support_more_fields · tchssk/multiswagger</a> のように変更して試してみました。</p>

<p>変更に際して以下の点にハマりました。</p>

<p>ハマった点その1。 API定義は <a href="https://godoc.org/github.com/goadesign/goa/goagen/gen_swagger#Swagger">github.com/goadesign/goagen/genswagger/Swagger</a> の <code>Definitions</code> に保持されるのですが、値の型が <code>map[string]*genschema.JSONSchema</code> となっていて、 <code>JSONSchema</code> の値は <a href="https://github.com/goadesign/goa/blob/4d19425396efa86b61d97c3cda0b00ec21f103f7/goagen/gen_schema/json_schema.go#L100">goa/json_schema.go のグローバル変数 Definitions</a> に保持されています。</p>

<p>このため <a href="https://github.com/hnakamur/multiswagger/blob/ec57ee4e1b17d0b13091e0b3d17649796967ed64/generator.go#L142-L173">extract 関数</a> 内で JSON 文字列から最初のキーの値を取り出して書き変えた後、 <a href="https://github.com/hnakamur/multiswagger/blob/ec57ee4e1b17d0b13091e0b3d17649796967ed64/generator.go#L72">generator.go#L72</a> で次のキー用に <code>Swagger</code> の値を作り直しても JSONSchema は古い値が再利用されてしまいます。そこで <a href="https://github.com/hnakamur/multiswagger/blob/ec57ee4e1b17d0b13091e0b3d17649796967ed64/generator.go#L71">generator.go#L71</a> で <code>genschema.Definitions</code> を初期化することで対応できました。</p>

<p>ハマった点その2。生成された <a href="https://github.com/hnakamur/goa-getting-started/blob/4bef7925510700d8797831f3bb665eb87c8ca6b9/swagger/swagger.ja.yaml#L8">swagger.ja.yaml の 8 行目</a>  を見ると <code>definitions</code> の <code>description</code> に <code>(default view)</code> という値が自動的に追加されています。  <a href="https://github.com/hnakamur/goa-getting-started/blob/4bef7925510700d8797831f3bb665eb87c8ca6b9/design/design.go#L42-L45">design.go#L42-L45</a> に JSON を書いていても <code>(default view)</code> という値が追加されるので JSON としてパースしようとするとエラーになってしまいます。そこで、値が <code>(default view)</code> で終わっていたら、それを取り除いてから JSON としてパース可能か調べるようにしました。そしてパースできる場合はパースして特定のキーの値を取り出してから最後に <code>(default view)</code> とつけるようにしました。</p>

<p>やれやれこれで大丈夫かと思ったのですが、 <a href="https://github.com/hnakamur/goa-getting-started/blob/4bef7925510700d8797831f3bb665eb87c8ca6b9/swagger/swagger.ja.yaml#L33-L69">swagger.ja.yaml#L33-L69</a> の <code>error</code> の <code>description</code> は英語になっています。 <a href="https://github.com/hnakamur/goa-getting-started/blob/4bef7925510700d8797831f3bb665eb87c8ca6b9/design/design.go">design.go</a> に書いていないデフォルト値が出力されているようです。</p>

<p>また、 <a href="https://github.com/hnakamur/goa-getting-started/blob/4bef7925510700d8797831f3bb665eb87c8ca6b9/swagger/swagger.ja.yaml#L95">swagger.ja.yaml#L95</a> の <code>summary</code> も show bottle と英語になっています。これは今はコメントにしていますが <a href="https://github.com/hnakamur/goa-getting-started/blob/4bef7925510700d8797831f3bb665eb87c8ca6b9/design/design.go#L36">design.go#L36</a> のように <code>Metadata(&quot;swagger:summary&quot;, value)</code> で設定可能なことがわかりました。</p>

<p>しかしこの値を JSON で書くとなると <a href="https://github.com/hnakamur/multiswagger/blob/ec57ee4e1b17d0b13091e0b3d17649796967ed64/generator.go#L175-L253">walk 関数</a> で Metadata で <code>&quot;swagger:summary&quot;</code> 特定のキーの場合だけ処理するという改修が必要です。</p>

<p>このあたりで辛くなってきました。 <code>design.go</code> の DSL はそのままで値に JSON を書くという設計は <code>design.go</code> で各言語のメッセージが一覧できるという利点がある一方、 generator の実装が面倒だと思います。あと、言語が増えると <code>design.go</code> の API 定義に対するメッセージ文字列の行が増えて API 定義が見にくくなるという欠点もあると思いました。</p>

<h2 id="ということで-localeovrerlayswagger-という別の-swagger-仕様生成プラグインを作りました">ということで LocaleOvrerlaySwagger という別の Swagger 仕様生成プラグインを作りました</h2>

<p>ソースは <a href="https://github.com/hnakamur/localeoverlayswagger">hnakamur/localeoverlayswagger</a> で公開しています。</p>

<p>使い方は <a href="https://github.com/hnakamur/localeoverlayswagger#usage">README の Usage</a> をご参照ください。メッセージの書き方ですが、 <a href="https://github.com/hnakamur/goa-getting-started/blob/overlay_japanese_yaml/design/design.go">design.go</a> の各種 Description は標準通り英語で書きます。</p>

<p>英語の Swagger 仕様は標準と同じ内容で <a href="https://github.com/hnakamur/goa-getting-started/blob/overlay_japanese_yaml/swagger/swagger.yaml">swagger/swagger.yaml</a> のように生成されます。 この内置き換えた部分だけのキーを含む YAML ファイルを <a href="https://github.com/hnakamur/goa-getting-started/blob/overlay_japanese_yaml/locales/ja.yaml">overlay_japanese_yaml</a> のように書いておくと、 <a href="https://github.com/hnakamur/goa-getting-started/blob/overlay_japanese_yaml/swagger/swagger.ja.yaml">swagger/swagger.ja.yaml</a> のようにその部分だけ上書きされた YAML が生成されるという仕組みです。</p>

<p>英語のメッセージに対応する日本語のメッセージを離れたところに書く必要があるのでその点は不便なのですが、生成された英語の YAML を見ながら対応するキーに日本語メッセージを書くだけで良いので、トータルではこちらのほうが管理が楽だと個人的には思います。</p>

<p>ということで、良かったらご利用ください。</p>

                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <a href="https://hnakamur.github.io"><strong>Hiroaki Nakamura</strong></a>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://hnakamur.github.io/blog/2016/10/22/max-time-for-golang-os-chtimes/"> Go言語のos.Chtimesで設定可能な最大日時は 2262-04-11 23:47:16.854775807 &#43;0000 UTC</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://hnakamur.github.io/blog/2016/09/15/experiment-postgresql-active-standby-using-pgpool-ii/"> pgpool-IIを使ってPostgreSQLのアクティブ・スタンバイ(1&#43;1構成)を試してみた</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2012-2017. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="http://github.com/hnakamur/liquorice-hn/">liquorice-hn</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript">
    <!--
    function toggle(id) {
        var e = document.getElementById(id);
        e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
    }
    
    </script>

    </body>
</html>

