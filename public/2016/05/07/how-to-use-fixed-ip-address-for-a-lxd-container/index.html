<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>LXDコンテナで固定IPアドレスを使うための設定</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/05/07/how-to-use-fixed-ip-address-for-a-lxd-container/" rel="bookmark"
           title="Permalink to LXDコンテナで固定IPアドレスを使うための設定">LXDコンテナで固定IPアドレスを使うための設定</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-05-07T18:01:00+09:00">
                Published: 2016-05-07
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/lxd.html">lxd</a> </p>
</footer><!-- /.post-info -->      <h2>2016-08-12 追記</h2>
<p><code>lxd-bridge</code> サービスを再起動せずに固定IPアドレス設定を更新できるようにするための設定方法を <a href="/blog/2016/08/12/update-lxd-dnsmasq-dhcp-hosts-config-with-sighup/">LXDのdnsmasqの固定IP設定をSIGHUPで更新する · hnakamur's blog at github</a> に書きました。こちらのほうがお勧めです。</p>
<h2>設定まとめ</h2>
<p>自分が後から参照することを想定して先に設定方法をまとめます。</p>
<p>LXDコンテナで固定IPアドレスを使うためには以下の設定が必要です。なお、設定にはroot権限が必要です。</p>
<p>まず <code>/etc/dnsmasq.conf</code> に以下のようにコンテナ名に対するIPアドレスを指定します。</p>
<div class="highlight"><pre><span></span>dhcp-host=cent01,10.64.177.101
dhcp-host=cent02,10.64.177.102
</pre></div>


<p><code>lxd-bridge</code> サービスを再起動します。</p>
<div class="highlight"><pre><span></span>sudo systemctl restart lxd-bridge
</pre></div>


<p>IPアドレスを変更したコンテナを再起動します。</p>
<div class="highlight"><pre><span></span>lxc restart cent01
lxc restart cent02
</pre></div>


<h2>調査メモ</h2>
<p>以下は調査メモです。</p>
<p>まず <a href="https://github.com/lxc/lxd/issues/1168">Persistent IP for Containers · Issue #1168 · lxc/lxd</a> に固定IPアドレスを使うための情報がありました。LXDで特にサポートはないが、各コンテナでDHCPを使わずに静的IPアドレスを使用するか、あるいはホストのDHCPサーバ側で設定すれば実現できるとのことです。</p>
<p>各コンテナで静的IPアドレスを使う方法も試してみたのですが、ホストのコンテナ内から別のコンテナをコンテナ名で参照しようとすると変更前のIPアドレスで通信しようとしてしまいうまく行きませんでした。</p>
<p>これを実現するにはホストのDHCPサーバに各コンテナのIPアドレスを把握してもらう必要があるので、後者のDHCPサーバ側で設定するほうが良いです。</p>
<h3>LXDのブリッジインターフェースとdnsmasqの設定ファイル</h3>
<p><a href="https://insights.ubuntu.com/2016/04/07/lxd-networking-lxdbr0-explained/">LXD networking: lxdbr0 explained | Ubuntu Insights</a>と<a href="https://gist.github.com/cronnelly/98345100afe21840267270da3283b371">lxcbr0 is being replaced by lxdbr0</a>によると、 LXCでは <code>lxcbr0</code> というブリッジインターフェースを使っていましたが、LXDでは <code>lxdbr0</code> と別のインターフェースを使うように変更されたそうです。</p>
<p>これらの記事を見るとLXCの <code>lxcbr0</code> はインストール時に固定のアドレスネットワークが設定されて環境によっては既存のネットワークと衝突するという問題があったので、LXD の <code>lxdbr0</code> ではインストール時にはIPv4やIPv6のサブネットは設定せずに <code>sudo lxd init</code> を実行したときに設定するように変更されたということのようです。</p>
<p><code>sudo lxd init</code> で生成した <code>lxdbr0</code> 用の設定は <code>/etc/default/lxd-bridge</code> に保存されています。
ファイルの先頭に書かれていますが、変更したい場合は直接編集せずに <code>dpkg-reconfigure -p medium lxd</code> を実行するのが良いそうです。</p>
<div class="highlight"><pre><span></span>$ cat /etc/default/lxd-bridge
<span class="c1"># WARNING: This file is generated by a debconf template!</span>
<span class="c1"># It is recommended to update it by using &quot;dpkg-reconfigure -p medium lxd&quot;</span>

<span class="c1"># Whether to setup a new bridge or use an existing one</span>
<span class="nv">USE_LXD_BRIDGE</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>

<span class="c1"># Bridge name</span>
<span class="c1"># This is still used even if USE_LXD_BRIDGE is set to false</span>
<span class="c1"># set to an empty value to fully disable</span>
<span class="nv">LXD_BRIDGE</span><span class="o">=</span><span class="s2">&quot;lxdbr0&quot;</span>

<span class="c1"># Update the &quot;default&quot; LXD profile</span>
<span class="nv">UPDATE_PROFILE</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>

<span class="c1"># Path to an extra dnsmasq configuration file</span>
<span class="nv">LXD_CONFILE</span><span class="o">=</span><span class="s2">&quot;&quot;</span>

<span class="c1"># DNS domain for the bridge</span>
<span class="nv">LXD_DOMAIN</span><span class="o">=</span><span class="s2">&quot;lxd&quot;</span>

<span class="c1"># IPv4</span>
<span class="c1">## IPv4 address (e.g. 10.0.8.1)</span>
<span class="nv">LXD_IPV4_ADDR</span><span class="o">=</span><span class="s2">&quot;10.16.29.1&quot;</span>

<span class="c1">## IPv4 netmask (e.g. 255.255.255.0)</span>
<span class="nv">LXD_IPV4_NETMASK</span><span class="o">=</span><span class="s2">&quot;255.255.255.0&quot;</span>

<span class="c1">## IPv4 network (e.g. 10.0.8.0/24)</span>
<span class="nv">LXD_IPV4_NETWORK</span><span class="o">=</span><span class="s2">&quot;10.16.29.1/24&quot;</span>

<span class="c1">## IPv4 DHCP range (e.g. 10.0.8.2,10.0.8.254)</span>
<span class="nv">LXD_IPV4_DHCP_RANGE</span><span class="o">=</span><span class="s2">&quot;10.16.29.2,10.16.29.254&quot;</span>

<span class="c1">## IPv4 DHCP number of hosts (e.g. 250)</span>
<span class="nv">LXD_IPV4_DHCP_MAX</span><span class="o">=</span><span class="s2">&quot;252&quot;</span>

<span class="c1">## NAT IPv4 traffic</span>
<span class="nv">LXD_IPV4_NAT</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>

<span class="c1"># IPv6</span>
<span class="c1">## IPv6 address (e.g. 2001:470:b368:4242::1)</span>
<span class="nv">LXD_IPV6_ADDR</span><span class="o">=</span><span class="s2">&quot;fd94:d372:e27f:2987::1&quot;</span>

<span class="c1">## IPv6 CIDR mask (e.g. 64)</span>
<span class="nv">LXD_IPV6_MASK</span><span class="o">=</span><span class="s2">&quot;64&quot;</span>

<span class="c1">## IPv6 network (e.g. 2001:470:b368:4242::/64)</span>
<span class="nv">LXD_IPV6_NETWORK</span><span class="o">=</span><span class="s2">&quot;fd94:d372:e27f:2987::1/64&quot;</span>

<span class="c1">## NAT IPv6 traffic</span>
<span class="nv">LXD_IPV6_NAT</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>

<span class="c1"># Run a minimal HTTP PROXY server</span>
<span class="nv">LXD_IPV6_PROXY</span><span class="o">=</span><span class="s2">&quot;false&quot;</span>
</pre></div>


<p>このブリッジインタフェースを有効にするには <code>lxd-bridge.service</code> を開始します。サービスの定義ファイルは以下のようになっていました。</p>
<div class="highlight"><pre><span></span>$ cat /lib/systemd/system/lxd-bridge.service
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>LXD - network bridge
<span class="nv">Documentation</span><span class="o">=</span>man:lxd<span class="o">(</span><span class="m">1</span><span class="o">)</span>
<span class="nv">Before</span><span class="o">=</span>lxd.service

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Type</span><span class="o">=</span>oneshot
<span class="nv">RemainAfterExit</span><span class="o">=</span>yes
<span class="nv">ExecStart</span><span class="o">=</span>/usr/lib/lxd/lxd-bridge.start
<span class="nv">ExecStop</span><span class="o">=</span>/usr/lib/lxd/lxd-bridge stop
</pre></div>


<p><code>ExecStart</code> に指定しているスクリプトの中身は以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="s s-Atom">cat</span> <span class="o">/</span><span class="s s-Atom">usr</span><span class="o">/</span><span class="s s-Atom">lib</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span><span class="p">.</span><span class="s s-Atom">start</span>
<span class="c1">#!/bin/sh -e</span>

<span class="p">[</span> <span class="p">!</span> <span class="o">-</span><span class="s s-Atom">e</span> <span class="o">/</span><span class="s s-Atom">etc</span><span class="o">/</span><span class="s s-Atom">default</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span> <span class="p">]</span> <span class="s s-Atom">&amp;&amp;</span> <span class="s s-Atom">exit</span> <span class="mi">0</span>

<span class="p">.</span> <span class="o">/</span><span class="s s-Atom">etc</span><span class="o">/</span><span class="s s-Atom">default</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span>

<span class="c1"># Start by bringing up the bridge</span>
<span class="o">/</span><span class="s s-Atom">usr</span><span class="o">/</span><span class="s s-Atom">lib</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span> <span class="s s-Atom">start</span>

<span class="c1"># Switch LXD in setup mode if needed</span>
<span class="s s-Atom">if</span> <span class="p">[</span> <span class="s2">&quot;${UPDATE_PROFILE:-true}&quot;</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span> <span class="p">]</span> <span class="s s-Atom">&amp;&amp;</span> <span class="p">[</span> <span class="o">-</span><span class="s s-Atom">e</span> <span class="s2">&quot;/var/lib/lxd&quot;</span> <span class="p">]</span> <span class="s s-Atom">&amp;&amp;</span> <span class="s s-Atom">\</span>
    <span class="p">([</span> <span class="p">!</span> <span class="o">-</span><span class="s s-Atom">e</span> <span class="s2">&quot;/var/lib/lxd-bridge/timestamp&quot;</span> <span class="p">]</span> <span class="p">||</span> <span class="s s-Atom">\</span>
     <span class="p">[</span> <span class="s2">&quot;/etc/default/lxd-bridge&quot;</span> <span class="o">-</span><span class="s s-Atom">nt</span> <span class="s2">&quot;/var/lib/lxd-bridge/timestamp&quot;</span> <span class="p">]);</span> <span class="s s-Atom">then</span>

    <span class="s s-Atom">mkdir</span> <span class="o">-</span><span class="s s-Atom">p</span> <span class="o">/</span><span class="s s-Atom">var</span><span class="o">/</span><span class="s s-Atom">lib</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span>
    <span class="s s-Atom">touch</span> <span class="o">/</span><span class="s s-Atom">var</span><span class="o">/</span><span class="s s-Atom">lib</span><span class="o">/</span><span class="s s-Atom">lxd</span><span class="o">-</span><span class="s s-Atom">bridge</span><span class="o">/</span><span class="s s-Atom">timestamp</span>

    <span class="s s-Atom">touch</span> <span class="o">/</span><span class="s s-Atom">var</span><span class="o">/</span><span class="s s-Atom">lib</span><span class="o">/</span><span class="s s-Atom">lxd/.setup_mode</span>
<span class="s s-Atom">fi</span>

<span class="s s-Atom">exit</span> <span class="mi">0</span>
</pre></div>


<p>ここから呼ばれる <code>/usr/lib/lxd/lxd-bridge</code> を見てみると、initスクリプトになっていて <code>iptables</code>, <code>ip6tables</code>, <code>dnsmasq</code> を実行するようになっていました。また <code>/usr/lib/lxd/lxd-bridge</code> は上記の <code>/etc/default/lxd-bridge</code> を読み込むようになっています。</p>
<p>起動された <code>dnsmasq</code> を <code>ps</code> で見ると以下のようなコマンドラインになっていました。</p>
<p>$ ps auxww | grep [d]nsmasq
  lxd       2134  0.0  0.0  49984   388 ?        S    09:48   0:00 dnsmasq -s lxd -S /lxd/ -u lxd --strict-order --bind-interfaces --pid-file=/run/lxd-bridge//dnsmasq.pid --dhcp-no-override --except-interface=lo --interface=lxdbr0 --dhcp-leasefile=/var/lib/lxd-bridge//dnsmasq.lxdbr0.leases --dhcp-authoritative --listen-address 10.16.29.1 --dhcp-range 10.16.29.2,10.16.29.254 --dhcp-lease-max=252 --dhcp-range=fd94:d372:e27f:2987::1,ra-only --listen-address fd94:d372:e27f:2987::1</p>
<p><code>/usr/lib/lxd/lxd-bridge</code> を見ると <code>/etc/default/lxd-bridge</code> の <code>LXD_CONFILE</code> にファイル名を指定しておけば <code>dnsmasq</code> の <code>--conf-file</code> オプションを使ってそのファイルを読み込むように書かれています。この方法を使おうかと思ったのですが、一方で <code>/etc/default/lxd-bridge</code> の設定にかかわらず <code>--dhcp-authoritative</code> オプションが常に指定されるように書かれています。</p>
<p><code>man dnsmasq</code> によると <code>--dhcp-authoritative</code> オプションはネットワーク内に他にDHCPサーバが無く唯一のDHCPになっているときに指定するオプションとのことです。ホストで稼働する <code>dnsmasq</code> が1つという前提であれば、デフォルトの設定ファイル <code>/etc/dnsmasq.conf</code> を作ってそこに設定を書くほうが手っ取り早いので、そうすることにしました。</p>
<h3>lxd-bridge.serviceの設定変更はreloadではなくrestartが必要</h3>
<p><code>sudo systemctl reload lxd-bridge</code> を実行してみると以下のようなエラーが出て失敗しました。</p>
<div class="highlight"><pre><span></span>$ sudo systemctl reload lxd-bridge
Failed to reload lxd-bridge.service: Job <span class="nb">type</span> reload is not applicable <span class="k">for</span> unit lxd-bridge.service.
See system logs and <span class="s1">&#39;systemctl status lxd-bridge.service&#39;</span> <span class="k">for</span> details.
$ sudo systemctl status lxd-bridge
● lxd-bridge.service - LXD - network bridge
   Loaded: loaded <span class="o">(</span>/lib/systemd/system/lxd-bridge.service<span class="p">;</span> static<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
   Active: active <span class="o">(</span>exited<span class="o">)</span> since 土 <span class="m">2016</span>-05-07 <span class="m">13</span>:06:06 JST<span class="p">;</span> 6h ago
     Docs: man:lxd<span class="o">(</span><span class="m">1</span><span class="o">)</span>
  Process: <span class="m">3704</span> <span class="nv">ExecStop</span><span class="o">=</span>/usr/lib/lxd/lxd-bridge stop <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span><span class="m">0</span>/SUCCESS<span class="o">)</span>
  Process: <span class="m">3723</span> <span class="nv">ExecStart</span><span class="o">=</span>/usr/lib/lxd/lxd-bridge.start <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span><span class="m">0</span>/SUCCESS<span class="o">)</span>
 Main PID: <span class="m">3723</span> <span class="o">(</span><span class="nv">code</span><span class="o">=</span>exited, <span class="nv">status</span><span class="o">=</span><span class="m">0</span>/SUCCESS<span class="o">)</span>
    Tasks: <span class="m">1</span> <span class="o">(</span>limit: <span class="m">512</span><span class="o">)</span>
   Memory: <span class="m">412</span>.0K
      CPU: <span class="m">1</span>.293s
   CGroup: /system.slice/lxd-bridge.service
           └─3755 dnsmasq -s lxd -S /lxd/ -u lxd --strict-order --bind-interfaces --pid-file<span class="o">=</span>/run/lxd-bridge//dnsmasq.pid --dhcp-no-override --except-interface<span class="o">=</span>lo --interface<span class="o">=</span>lxdbr0 --dhcp-leasefile<span class="o">=</span>/var/lib/lxd-bridge//dnsmasq.lxdbr0.leases --dhcp-authoritative --lis
 5月 <span class="m">07</span> <span class="m">18</span>:56:28 express dnsmasq-dhcp<span class="o">[</span><span class="m">3755</span><span class="o">]</span>: not giving name cent02 to the DHCP lease of <span class="m">10</span>.155.92.102 because the name exists in /etc/hosts with address <span class="m">10</span>.155.92.201
 5月 <span class="m">07</span> <span class="m">19</span>:06:21 express dnsmasq-dhcp<span class="o">[</span><span class="m">3755</span><span class="o">]</span>: DHCPREQUEST<span class="o">(</span>lxdbr0<span class="o">)</span> <span class="m">10</span>.155.92.102 <span class="m">00</span>:16:3e:59:21:d7
 5月 <span class="m">07</span> <span class="m">19</span>:06:21 express dnsmasq-dhcp<span class="o">[</span><span class="m">3755</span><span class="o">]</span>: DHCPACK<span class="o">(</span>lxdbr0<span class="o">)</span> <span class="m">10</span>.155.92.102 <span class="m">00</span>:16:3e:59:21:d7 cent02
 5月 <span class="m">07</span> <span class="m">19</span>:06:21 express dnsmasq-dhcp<span class="o">[</span><span class="m">3755</span><span class="o">]</span>: not giving name cent02 to the DHCP lease of <span class="m">10</span>.155.92.102 because the name exists in /etc/hosts with address <span class="m">10</span>.155.92.201
 5月 <span class="m">07</span> <span class="m">19</span>:23:24 express dnsmasq-dhcp<span class="o">[</span><span class="m">3755</span><span class="o">]</span>: DHCPREQUEST<span class="o">(</span>lxdbr0<span class="o">)</span> <span class="m">10</span>.155.92.101 <span class="m">00</span>:16:3e:5f:01:7e
 5月 <span class="m">07</span> <span class="m">19</span>:23:24 express dnsmasq-dhcp<span class="o">[</span><span class="m">3755</span><span class="o">]</span>: DHCPACK<span class="o">(</span>lxdbr0<span class="o">)</span> <span class="m">10</span>.155.92.101 <span class="m">00</span>:16:3e:5f:01:7e cent01
 5月 <span class="m">07</span> <span class="m">19</span>:23:24 express dnsmasq-dhcp<span class="o">[</span><span class="m">3755</span><span class="o">]</span>: not giving name cent02 to the DHCP lease of <span class="m">10</span>.155.92.102 because the name exists in /etc/hosts with address <span class="m">10</span>.155.92.201
 5月 <span class="m">07</span> <span class="m">19</span>:33:08 express dnsmasq-dhcp<span class="o">[</span><span class="m">3755</span><span class="o">]</span>: DHCPREQUEST<span class="o">(</span>lxdbr0<span class="o">)</span> <span class="m">10</span>.155.92.102 <span class="m">00</span>:16:3e:59:21:d7
 5月 <span class="m">07</span> <span class="m">19</span>:33:08 express dnsmasq-dhcp<span class="o">[</span><span class="m">3755</span><span class="o">]</span>: DHCPACK<span class="o">(</span>lxdbr0<span class="o">)</span> <span class="m">10</span>.155.92.102 <span class="m">00</span>:16:3e:59:21:d7 cent02
 5月 <span class="m">07</span> <span class="m">19</span>:33:08 express dnsmasq-dhcp<span class="o">[</span><span class="m">3755</span><span class="o">]</span>: not giving name cent02 to the DHCP lease of <span class="m">10</span>.155.92.102 because the name exists in /etc/hosts with address <span class="m">10</span>.155.92.201
</pre></div>


<p>ということで、設定ファイルを変更反映するにも <code>sudo systemctl restart lxd-bridge</code> のように再起動する必要があります。</p>
<h3>dnsmasqの再起動後、コンテナの再起動が必要</h3>
<p>dnsmasqを再起動しただけではコンテナのIPアドレスは変わらないのでネットワークを再起動する必要がありました。</p>
<div class="highlight"><pre><span></span>lxc exec cent01 systemctl restart network
lxc exec cent02 systemctl restart network
</pre></div>


<p>コンテナごと再起動でも良いと思います。</p>
<div class="highlight"><pre><span></span>lxc restart cent01
lxc restart cent02
</pre></div>


<p>何回か試してみたところ、作っただけで特に何もしてないコンテナだとネットワーク再起動よりコンテナ自体を再起動するほうが速かったです。</p>
<div class="highlight"><pre><span></span>$ <span class="nb">time</span> lxc <span class="nb">exec</span> cent02 systemctl restart network

real    0m2.878s
user    0m0.008s
sys     0m0.000s
$ <span class="nb">time</span> lxc restart cent02

real    0m1.236s
user    0m0.004s
sys     0m0.004s
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>