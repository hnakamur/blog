<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Ubuntuでホームディレクトリを暗号化するのを止めた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2016/05/02/uninstall-encrypted-home-on-ubuntu/" rel="bookmark"
           title="Permalink to Ubuntuでホームディレクトリを暗号化するのを止めた">Ubuntuでホームディレクトリを暗号化するのを止めた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-05-02T12:28:00+09:00">
                Published: 2016-05-02
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/crypt.html">crypt</a> <a href="../../../../tag/ubuntu.html">ubuntu</a> </p>
</footer><!-- /.post-info -->      <h2>背景</h2>
<p><a href="/blog/2016/05/01/install_ubuntu_xenial_with_pxe_boot/">MacをPXEサーバにしてExpress5800/S70タイプRBにUbuntu16.04をインストールしてみた · hnakamur's blog at github</a>でホームディレクトリを暗号化してみたのですが、OS起動後に鍵認証でsshしようとすると鍵は正しく指定しているのに <code>Permission denied (publickey).</code> と拒否されてしまうケースがありました。コンソールで一度ログインするとsshでもログイン出来るようになります。</p>
<p>これはホームディレクトリを暗号化した影響で <code>~/.ssh/authorized_keys</code> が読めない状態になっているようです。</p>
<h2>authorized_keys をホームディレクトリの外に置く手もある</h2>
<p><a href="http://askubuntu.com/questions/254776/ubuntu-server-ssh-after-reboot-permission-denied-publickey/254787#254787">Ubuntu server ssh after reboot: Permission denied (publickey) - Ask Ubuntu</a>によると <code>/etc/ssh/sshd_config</code> で <code>AuthorizedKeysFile</code> の設定を変える手もあるようです。</p>
<p>変更前の状態は</p>
<div class="highlight"><pre><span></span><span class="o">#</span><span class="n">AuthorizedKeysFile</span>     <span class="o">%</span><span class="n">h</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span>
</pre></div>


<p>とデフォルト値がコメントアウトされて書かれていました。</p>
<p><a href="http://manpages.ubuntu.com/manpages/precise/en/man5/sshd_config.5.html">Ubuntu Manpage: sshd_config — OpenSSH SSH daemon configuration file</a>によると <code>%h</code> はホームディレクトリに展開されます。ユーザ名に展開される <code>%u</code> というのもあるそうです。</p>
<p>ここでは <code>/etc/%u/.ssh/authorized_keys</code> に変更するのを試してみました。
先に自分のユーザID <code>hnakamur</code> 用のディレクトリを作って所有者を変更します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="mi">700</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">hnakamur</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span>
</pre></div>


<p>その後 <code>sudo vi /etc/ssh/sshd_config</code> を実行し以下の行を追加します。</p>
<div class="highlight"><pre><span></span><span class="n">AuthorizedKeysFile</span> <span class="o">/</span><span class="n">etc</span><span class="o">/%</span><span class="n">u</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span>
</pre></div>


<p>これでOSを再起動後、コンソールでログインしない状態でもsshで鍵認証でログンできることを確認しました。</p>
<p>ただし、ログインは出来ましたが、暗号化の解除は手動で行う必要がありました。作ったはずの <code>~/.bash_profile</code> が無いので気付きました。ホームディレクトリの中身は以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="n">hnakamur</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">-</span><span class="n">la</span><span class="w"></span>
<span class="n">合計</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="n">dr</span><span class="o">-</span><span class="n">x</span><span class="c1">------ 2 hnakamur hnakamur 4096  5月  2 01:31 .</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">root</span><span class="w">     </span><span class="n">root</span><span class="w">     </span><span class="mi">4096</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">..</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">33</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">.</span><span class="n">Private</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">Private</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">34</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">.</span><span class="n">ecryptfs</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">56</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="n">Access</span><span class="o">-</span><span class="n">Your</span><span class="o">-</span><span class="n">Private</span><span class="o">-</span><span class="k">Data</span><span class="p">.</span><span class="n">desktop</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">utils</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">mount</span><span class="o">-</span><span class="n">private</span><span class="p">.</span><span class="n">desktop</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">52</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="n">README</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">utils</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">mount</span><span class="o">-</span><span class="n">private</span><span class="p">.</span><span class="n">txt</span><span class="w"></span>
</pre></div>


<p><code>README.txt</code> を見てみました。</p>
<div class="highlight"><pre><span></span><span class="n">hnakamur</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">README</span><span class="p">.</span><span class="n">txt</span><span class="w"></span>
<span class="n">THIS</span><span class="w"> </span><span class="n">DIRECTORY</span><span class="w"> </span><span class="n">HAS</span><span class="w"> </span><span class="n">BEEN</span><span class="w"> </span><span class="n">UNMOUNTED</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="n">PROTECT</span><span class="w"> </span><span class="n">YOUR</span><span class="w"> </span><span class="k">DATA</span><span class="p">.</span><span class="w"></span>

<span class="k">From</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">graphical</span><span class="w"> </span><span class="n">desktop</span><span class="p">,</span><span class="w"> </span><span class="n">click</span><span class="w"> </span><span class="k">on</span><span class="err">:</span><span class="w"></span>
<span class="w"> </span><span class="ss">&quot;Access Your Private Data&quot;</span><span class="w"></span>

<span class="ow">or</span><span class="w"></span>

<span class="k">From</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="nl">run</span><span class="p">:</span><span class="w"></span>
<span class="w"> </span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">mount</span><span class="o">-</span><span class="n">private</span><span class="w"></span>
</pre></div>


<p><code>ecryptfs-mount-private</code> を実行してログインパスワードを入力し <code>cd /home/hnakamur</code> でホームディレクトリに入り直すと、復号化された内容が見えるようになりました。</p>
<div class="highlight"><pre><span></span><span class="n">hnakamur</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">mount</span><span class="o">-</span><span class="n">private</span><span class="w"></span>
<span class="n">Enter</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="n">login</span><span class="w"> </span><span class="nl">passphrase</span><span class="p">:</span><span class="w"></span>
<span class="n">Inserted</span><span class="w"> </span><span class="n">auth</span><span class="w"> </span><span class="n">tok</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">sig</span><span class="w"> </span><span class="o">[</span><span class="n">d094f2376006dce9</span><span class="o">]</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">user</span><span class="w"> </span><span class="k">session</span><span class="w"> </span><span class="n">keyring</span><span class="w"></span>

<span class="nl">INFO</span><span class="p">:</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">private</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">mounted</span><span class="p">.</span><span class="w"></span>
<span class="nl">INFO</span><span class="p">:</span><span class="w"> </span><span class="k">To</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">change</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">your</span><span class="w"> </span><span class="k">current</span><span class="w"> </span><span class="nl">shell</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="w"></span>

<span class="n">hnakamur</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">-</span><span class="n">la</span><span class="w"></span>
<span class="n">合計</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="n">dr</span><span class="o">-</span><span class="n">x</span><span class="c1">------ 2 hnakamur hnakamur 4096  5月  2 01:31 .</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">root</span><span class="w">     </span><span class="n">root</span><span class="w">     </span><span class="mi">4096</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">..</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">33</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">.</span><span class="n">Private</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">Private</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">34</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">.</span><span class="n">ecryptfs</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">56</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="n">Access</span><span class="o">-</span><span class="n">Your</span><span class="o">-</span><span class="n">Private</span><span class="o">-</span><span class="k">Data</span><span class="p">.</span><span class="n">desktop</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">utils</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">mount</span><span class="o">-</span><span class="n">private</span><span class="p">.</span><span class="n">desktop</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">52</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="n">README</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">utils</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">mount</span><span class="o">-</span><span class="n">private</span><span class="p">.</span><span class="n">txt</span><span class="w"></span>
<span class="n">hnakamur</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">cd</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="w"></span>
<span class="n">hnakamur</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">$</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">-</span><span class="n">la</span><span class="w"></span>
<span class="n">合計</span><span class="w"> </span><span class="mi">128</span><span class="w"></span>
<span class="n">drwx</span><span class="c1">------ 6 hnakamur hnakamur 4096  5月  2 12:43 .</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">root</span><span class="w">     </span><span class="n">root</span><span class="w">     </span><span class="mi">4096</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">..</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">33</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">.</span><span class="n">Private</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">Private</span><span class="w"></span>
<span class="o">-</span><span class="n">rw</span><span class="c1">------- 1 hnakamur hnakamur 1908  5月  2 12:43 .bash_history</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="c1">--r-- 1 hnakamur hnakamur  220  5月  2 01:31 .bash_logout</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="c1">--r-- 1 hnakamur hnakamur  100  5月  2 08:50 .bash_profile</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="c1">--r-- 1 hnakamur hnakamur 3771  5月  2 01:31 .bashrc</span>
<span class="n">drwx</span><span class="c1">------ 2 hnakamur hnakamur 4096  5月  2 01:36 .cache</span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">34</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">.</span><span class="n">ecryptfs</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="w"></span>
<span class="o">-</span><span class="n">rw</span><span class="c1">------- 1 hnakamur hnakamur   41  5月  2 09:00 .lesshst</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="c1">--r-- 1 hnakamur hnakamur  675  5月  2 01:31 .profile</span>
<span class="n">drwx</span><span class="c1">------ 2 hnakamur hnakamur 4096  5月  2 01:38 .ssh</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="c1">--r-- 1 hnakamur hnakamur    0  5月  2 01:38 .sudo_as_admin_successful</span>
<span class="o">-</span><span class="n">rw</span><span class="c1">------- 1 hnakamur hnakamur 6841  5月  2 12:43 .viminfo</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="mi">4096</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">03</span><span class="err">:</span><span class="mi">13</span><span class="w"> </span><span class="n">docs</span><span class="w"></span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="mi">4096</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">08</span><span class="err">:</span><span class="mi">47</span><span class="w"> </span><span class="n">gocode</span><span class="w"></span>
</pre></div>


<h2>LVM暗号化を使っているのでホームディレクトリの暗号化は止めることにした</h2>
<p><a href="http://ubuntuforums.org/showthread.php?t=1335046">[all variants] Encrypted LVM vs Encrypted Home</a>を見ると、ホームディレクトリを暗号化してもスワップや <code>/tmp</code> などが暗号化されていないので情報漏えいのリスクがあるので、ホームディレクトリの暗号化よりもLVMの暗号化のほうが良いとのことです。</p>
<p>そもそも自宅サーバでユーザは私だけということもあり、ホームディレクトリの暗号化は止めることにしました。</p>
<p>以下のページを参考にしつつやってみました。</p>
<ul>
<li><a href="http://www.howtogeek.com/116179/how-to-disable-home-folder-encryption-after-installing-ubuntu/">How to Disable Home Folder Encryption After Installing Ubuntu</a></li>
<li><a href="https://help.ubuntu.com/community/EncryptedHome">EncryptedHome - Community Help Wiki</a></li>
</ul>
<p>バックアップ用のディレクトリを作って、所有者を変えます。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="p">.</span><span class="n">backup</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="n">hnakamur</span><span class="p">:</span><span class="n">hnakamur</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="p">.</span><span class="n">backup</span>
</pre></div>


<p><code>tar</code> でバックアップして <code>.encryptfs</code> ディレクトリは消します。シンボリックリンクもそのままコピーしたいので <code>tar</code> を使っています。</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="p">;</span> <span class="n">tar</span> <span class="n">cf</span> <span class="o">-</span> <span class="p">.)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="p">.</span><span class="n">backup</span><span class="p">;</span> <span class="n">tar</span> <span class="n">xf</span> <span class="o">-</span><span class="p">)</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="p">.</span><span class="n">backup</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span>
</pre></div>


<p>ホームディレクトリを暗号化するためのパッケージをアンインストールしました。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">remove</span> <span class="n">ecryptfs</span><span class="o">-</span><span class="n">utils</span> <span class="n">libecryptfs0</span>
</pre></div>


<p>上記は手順ミスです。先に別の管理者ユーザを作って元のユーザ <code>hnakamur</code> はログアウトし、別の管理ユーザで作業すべきでした。</p>
<p><code>df -h</code> で確認すると <code>hnakamur</code> ユーザのホームディレクトリがマウントされたままになっていました。</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">-</span><span class="n">h</span><span class="w"></span>
<span class="n">Filesystem</span><span class="w">                    </span><span class="k">Size</span><span class="w">  </span><span class="n">Used</span><span class="w"> </span><span class="n">Avail</span><span class="w"> </span><span class="k">Use</span><span class="o">%</span><span class="w"> </span><span class="n">Mounted</span><span class="w"> </span><span class="k">on</span><span class="w"></span>
<span class="n">udev</span><span class="w">                          </span><span class="mf">7.8</span><span class="n">G</span><span class="w">     </span><span class="mi">0</span><span class="w">  </span><span class="mf">7.8</span><span class="n">G</span><span class="w">   </span><span class="mi">0</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="w"></span>
<span class="n">tmpfs</span><span class="w">                         </span><span class="mf">1.6</span><span class="n">G</span><span class="w">  </span><span class="mf">8.8</span><span class="n">M</span><span class="w">  </span><span class="mf">1.6</span><span class="n">G</span><span class="w">   </span><span class="mi">1</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">run</span><span class="w"></span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">express</span><span class="c1">--vg-root  131G  2.1G  122G   2% /</span>
<span class="n">tmpfs</span><span class="w">                         </span><span class="mf">7.8</span><span class="n">G</span><span class="w">  </span><span class="mf">4.0</span><span class="n">K</span><span class="w">  </span><span class="mf">7.8</span><span class="n">G</span><span class="w">   </span><span class="mi">1</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">shm</span><span class="w"></span>
<span class="n">tmpfs</span><span class="w">                         </span><span class="mf">5.0</span><span class="n">M</span><span class="w">     </span><span class="mi">0</span><span class="w">  </span><span class="mf">5.0</span><span class="n">M</span><span class="w">   </span><span class="mi">0</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">lock</span><span class="w"></span>
<span class="n">tmpfs</span><span class="w">                         </span><span class="mf">7.8</span><span class="n">G</span><span class="w">     </span><span class="mi">0</span><span class="w">  </span><span class="mf">7.8</span><span class="n">G</span><span class="w">   </span><span class="mi">0</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">fs</span><span class="o">/</span><span class="n">cgroup</span><span class="w"></span>
<span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdc1</span><span class="w">                     </span><span class="mi">472</span><span class="n">M</span><span class="w">   </span><span class="mi">55</span><span class="n">M</span><span class="w">  </span><span class="mi">393</span><span class="n">M</span><span class="w">  </span><span class="mi">13</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">boot</span><span class="w"></span>
<span class="n">tmpfs</span><span class="w">                         </span><span class="mi">100</span><span class="n">K</span><span class="w">     </span><span class="mi">0</span><span class="w">  </span><span class="mi">100</span><span class="n">K</span><span class="w">   </span><span class="mi">0</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">lxcfs</span><span class="o">/</span><span class="n">controllers</span><span class="w"></span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">Private</span><span class="w">       </span><span class="mi">131</span><span class="n">G</span><span class="w">  </span><span class="mf">2.1</span><span class="n">G</span><span class="w">  </span><span class="mi">122</span><span class="n">G</span><span class="w">   </span><span class="mi">2</span><span class="o">%</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="w"></span>
</pre></div>


<p>この後、別のユーザを作りました。セカンダリグループに <code>sudo</code> を指定して <code>sudo</code> で <code>root</code> になれるようにします。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">useradd</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="k">G</span> <span class="n">sudo</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span> <span class="n">hnakamur2</span>
<span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur2</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="mi">700</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur2</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur2</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">hnakamur2</span><span class="p">:</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur2</span>
</pre></div>


<p>パスワードが空だとsshログイン出来ないので、パスワードを設定します。</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">passwd</span><span class="w"> </span><span class="n">hnakamur2</span><span class="w"></span>
<span class="n">新しい</span><span class="w"> </span><span class="n">UNIX</span><span class="w"> </span><span class="nl">パスワードを入力してください</span><span class="p">:</span><span class="w"></span>
<span class="n">新しい</span><span class="w"> </span><span class="n">UNIX</span><span class="w"> </span><span class="nl">パスワードを再入力してください</span><span class="p">:</span><span class="w"></span>
<span class="nl">passwd</span><span class="p">:</span><span class="w"> </span><span class="n">パスワードは正しく更新されました</span><span class="w"></span>
</pre></div>


<p>これで <code>hnakamur2</code> ユーザの作成が終わったので、Macからsshで hnakamur2 ユーザにログインします。</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span><span class="w"> </span><span class="n">hnakamur2</span><span class="nv">@express</span><span class="w"></span>
</pre></div>


<p><code>root</code> ユーザになって作業します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">-</span><span class="n">i</span>
<span class="n">umount</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span>
</pre></div>


<p><code>df -h</code> を実行してマウントが解除されたことを確認しました。
<code>/home/hnakamur</code> の中身を確認すると以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">ll</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="w"></span>
<span class="n">合計</span><span class="w"> </span><span class="mi">8</span><span class="w"></span>
<span class="n">dr</span><span class="o">-</span><span class="n">x</span><span class="c1">------ 2 hnakamur hnakamur 4096  5月  2 01:31 ./</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">root</span><span class="w">     </span><span class="n">root</span><span class="w">     </span><span class="mi">4096</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">42</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">33</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">.</span><span class="n">Private</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">Private</span><span class="o">/</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">34</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">.</span><span class="n">ecryptfs</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="o">/</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">56</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="n">Access</span><span class="o">-</span><span class="n">Your</span><span class="o">-</span><span class="n">Private</span><span class="o">-</span><span class="k">Data</span><span class="p">.</span><span class="n">desktop</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">utils</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">mount</span><span class="o">-</span><span class="n">private</span><span class="p">.</span><span class="n">desktop</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">52</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="n">README</span><span class="p">.</span><span class="n">txt</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">utils</span><span class="o">/</span><span class="n">ecryptfs</span><span class="o">-</span><span class="n">mount</span><span class="o">-</span><span class="n">private</span><span class="p">.</span><span class="n">txt</span><span class="w"></span>
</pre></div>


<p><code>hnakamur</code> のホームディレクトリを消して、バックアップした内容に戻します。</p>
<div class="highlight"><pre><span></span><span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span>
<span class="n">mv</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="p">.</span><span class="n">backup</span><span class="o">/</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span>
</pre></div>


<p>戻した中身を確認します。</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">ll</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="w"></span>
<span class="n">合計</span><span class="w"> </span><span class="mi">56</span><span class="w"></span>
<span class="n">drwx</span><span class="c1">------ 6 hnakamur hnakamur 4096  5月  2 13:04 ./</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">root</span><span class="w">     </span><span class="n">root</span><span class="w">     </span><span class="mi">4096</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">53</span><span class="w"> </span><span class="p">..</span><span class="o">/</span><span class="w"></span>
<span class="n">lrwxrwxrwx</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w">   </span><span class="mi">33</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">01</span><span class="err">:</span><span class="mi">31</span><span class="w"> </span><span class="p">.</span><span class="n">Private</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="p">.</span><span class="n">ecryptfs</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">Private</span><span class="o">/</span><span class="w"></span>
<span class="o">-</span><span class="n">rw</span><span class="c1">------- 1 hnakamur hnakamur 1908  5月  2 12:43 .bash_history</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="c1">--r-- 1 hnakamur hnakamur  220  5月  2 01:31 .bash_logout</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="c1">--r-- 1 hnakamur hnakamur  100  5月  2 08:50 .bash_profile</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="c1">--r-- 1 hnakamur hnakamur 3771  5月  2 01:31 .bashrc</span>
<span class="n">drwx</span><span class="c1">------ 2 hnakamur hnakamur 4096  5月  2 01:36 .cache/</span>
<span class="o">-</span><span class="n">rw</span><span class="c1">------- 1 hnakamur hnakamur   41  5月  2 09:00 .lesshst</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="c1">--r-- 1 hnakamur hnakamur  675  5月  2 01:31 .profile</span>
<span class="n">drwx</span><span class="c1">------ 2 hnakamur hnakamur 4096  5月  2 01:38 .ssh/</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-</span><span class="n">r</span><span class="c1">--r-- 1 hnakamur hnakamur    0  5月  2 01:38 .sudo_as_admin_successful</span>
<span class="o">-</span><span class="n">rw</span><span class="c1">------- 1 hnakamur hnakamur 6841  5月  2 12:43 .viminfo</span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="mi">4096</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">03</span><span class="err">:</span><span class="mi">13</span><span class="w"> </span><span class="n">docs</span><span class="o">/</span><span class="w"></span>
<span class="n">drwxr</span><span class="o">-</span><span class="n">xr</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="n">hnakamur</span><span class="w"> </span><span class="mi">4096</span><span class="w">  </span><span class="mi">5</span><span class="n">月</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="mi">08</span><span class="err">:</span><span class="mi">47</span><span class="w"> </span><span class="n">gocode</span><span class="o">/</span><span class="w"></span>
</pre></div>


<p><code>.Private</code> も不要なので消します。</p>
<div class="highlight"><pre><span></span><span class="n">rm</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">hnakamur</span><span class="o">/</span><span class="p">.</span><span class="n">Private</span>
</pre></div>


<p>これで Mac から元のユーザ <code>hnakamur</code> でsshログイン可能になります。
念のため <code>hnakamur2</code> はログインしたままにしておいて、ターミナルの別端末でログインしました。</p>
<div class="highlight"><pre><span></span><span class="n">ssh</span><span class="w"> </span><span class="n">hnakamur</span><span class="nv">@express</span><span class="w"></span>
</pre></div>


<p><code>/etc/ssh/sshd_config</code> の <code>AuthorizedKeysFile</code> の設定も元に戻すことにします。
<code>sudo vi /etc/ssh/sshd_config</code> を実行し以下の行を削除します。</p>
<div class="highlight"><pre><span></span><span class="n">AuthorizedKeysFile</span> <span class="o">/</span><span class="n">etc</span><span class="o">/%</span><span class="n">u</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span>
</pre></div>


<p>以下のコマンドで <code>sshd</code> を再起動します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="k">restart</span> <span class="n">sshd</span>
</pre></div>


<p><code>/etc/hnakamur</code> 以下に置いた <code>hnakamur</code> ユーザの鍵もディレクトリごと消します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rm</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur</span>
</pre></div>


<p>Mac のターミナルの別端末から <code>hnakamur</code> ユーザでsshログインできることと、sudoでrootになれることを確認しました。</p>
<p><code>hnakamur2</code> ユーザのほうはログアウトして、 <code>hnakamur</code> ユーザでログインした端末で <code>hnakamur2</code> ユーザを削除します。メールスプールのディレクトリが無いというメッセージが出ますが問題ありません。</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">sudo</span><span class="w"> </span><span class="n">userdel</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="n">hnakamur2</span><span class="w"></span>
<span class="nl">userdel</span><span class="p">:</span><span class="w"> </span><span class="n">hnakamur2</span><span class="w"> </span><span class="n">のメールスプール</span><span class="w"> </span><span class="p">(</span><span class="o">/</span><span class="nf">var</span><span class="o">/</span><span class="n">mail</span><span class="o">/</span><span class="n">hnakamur2</span><span class="p">)</span><span class="w"> </span><span class="n">がありません</span><span class="w"></span>
<span class="n">root</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="err">$</span><span class="vm">?</span><span class="w"></span>
<span class="mi">0</span><span class="w"></span>
</pre></div>


<p><code>/etc/hnakamur2</code> 以下に置いた <code>hnakamur2</code> ユーザの鍵もディレクトリごと消します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rm</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hnakamur2</span>
</pre></div>


<p>その後</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">shutdown</span> <span class="o">-</span><span class="n">r</span> <span class="n">now</span>
</pre></div>


<p>で再起動して、コンソールでLVM暗号化のパスフレーズを入力して起動し、コンソールでログインすることなしに、ssh鍵認証でログインできることを確認しました。</p>
<p>余談ですが、ちょっと不思議なのは、今まで構築したLinux環境ではsshで繋いで <code>sudo shutdown -h now</code> や <code>sudo shutdown -r now</code> を実行すると接続が切れていたのが、今回の環境ではプロンプトに戻らないまま残ってしまうということです。Ctrl-Cを入力すると <code>Host is down</code> と表示されていました。</p>
<div class="highlight"><pre><span></span><span class="n">root</span><span class="nv">@express</span><span class="err">:</span><span class="o">~</span><span class="err">#</span><span class="w"> </span><span class="k">shutdown</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="n">now</span><span class="w"></span>
<span class="nl">packet_write_poll</span><span class="p">:</span><span class="w"> </span><span class="k">Connection</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mf">192.168.0.201</span><span class="err">:</span><span class="w"> </span><span class="k">Host</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">down</span><span class="w"></span>
</pre></div>


<h2>まとめ</h2>
<p>今回のサーバのユーザは自分1人なのでホームディレクトリの暗号化は不要と判断し、解除しました。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>