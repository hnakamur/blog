<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>PPAでのビルドの予行演習にsbuildを使う</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/06/13/use-sbuild-for-ppa-build-rehearsal/" rel="bookmark"
           title="Permalink to PPAでのビルドの予行演習にsbuildを使う">PPAでのビルドの予行演習にsbuildを使う</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-06-13T18:00:00+09:00">
                Published: 2018-06-13
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/ubuntu.html">ubuntu</a> <a href="../../../../tag/deb.html">deb</a> <a href="../../../../tag/sbuild.html">sbuild</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>PPAでビルドする前に手元でビルドが通ることを確認したくてpbuilderを使っていましたが、pbuilderではビルドが通るのにPPAでは通らないケースが何度か起きたのでsbuildを使い始めました。使い方がある程度わかってきたのでメモです。</p>
<p>sbuildのセットアップ手順は
<a class="reference external" href="https://hnakamur.github.io/blog/2018/06/07/setup-sbuild-on-ubuntu-18.04-lts/">Ubuntu 18.04 LTSでsbuildをセットアップ</a>
に書きました。</p>
</div>
<div class="section" id="ppa">
<h2>PPAでビルド時に設定されている環境変数の例</h2>
<p>例えば以前 universal-ctags をPPAでビルドしたときの <a class="reference external" href="https://launchpadlibrarian.net/373686872/buildlog_ubuntu-bionic-amd64.universal-ctags_0+SNAPSHOT20180608-1ubuntu1ppa2~ubuntu18.04.1_BUILDING.txt.gz">ログ</a> を見ると以下のように環境変数が設定されていました。</p>
<div class="highlight"><pre><span></span>User Environment
----------------

APT_CONFIG=/var/lib/sbuild/apt.conf
DEB_BUILD_OPTIONS=parallel=4
HOME=/sbuild-nonexistent
LANG=C.UTF-8
LC_ALL=C.UTF-8
LOGNAME=buildd
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games
SCHROOT_ALIAS_NAME=build-PACKAGEBUILD-14993824
SCHROOT_CHROOT_NAME=build-PACKAGEBUILD-14993824
SCHROOT_COMMAND=env
SCHROOT_GID=2501
SCHROOT_GROUP=buildd
SCHROOT_SESSION_ID=build-PACKAGEBUILD-14993824
SCHROOT_UID=2001
SCHROOT_USER=buildd
SHELL=/bin/sh
TERM=unknown
USER=buildd
V=1
</pre></div>
<p>ちなみに、ビルドログへは以下の手順でたどり着きました。</p>
<ol class="arabic simple">
<li><a class="reference external" href="https://launchpad.net/~hnakamur/+archive/ubuntu/universal-ctags">universal-ctags : Hiroaki Nakamura</a> で &quot;View package details&quot; をクリック。</li>
<li>Packagesの表の &quot;universal-ctags - 0+SNAPSHOT20180608-1ubuntu1ppa2~ubuntu18.04.1&quot; をクリック。</li>
<li>展開された中の Builds の amd64 をクリック。</li>
<li>切り替わったページ内の Build Status の buildlog をクリック。</li>
</ol>
</div>
<div class="section" id="id3">
<h2>PPAでの環境変数に似せて手元のsbuildでビルドする手順</h2>
<p><code>TERM</code> や <code>V</code> などの環境変数を外から設定できるようにするため <code>~/.sbuildrc</code> に以下の設定を追加します。 <code>environment_filter</code> の説明とデフォルト値については
<a class="reference external" href="http://manpages.ubuntu.com/manpages/bionic/en/man5/sbuild.conf.5.html">man sbuild.conf</a>
を参照してください。</p>
<div class="highlight"><pre><span></span><span class="nv">$environment_filter</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s">&#39;^AR$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^ARFLAGS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^AS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^AWK$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^CC$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^CFLAGS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^CPP$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^CPPFLAGS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^CXX$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^CXXFLAGS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^DEB_BUILD_OPTIONS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^DEB_BUILD_PROFILES$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^DEB_VENDOR$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^DPKG_ADMINDIR$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^DPKG_DATADIR$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^DPKG_GENSYMBOLS_CHECK_LEVEL$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^DPKG_ORIGINS_DIR$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^DPKG_ROOT$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^FC$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^FFLAGS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^GCJFLAGS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LANG$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_ADDRESS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_ALL$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_COLLATE$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_CTYPE$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_IDENTIFICATION$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_MEASUREMENT$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_MESSAGES$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_MONETARY$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_NAME$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_NUMERIC$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_PAPER$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_TELEPHONE$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LC_TIME$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LD$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LDFLAGS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LD_LIBRARY_PATH$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^LEX$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^M2C$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^MAKE$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^MAKEFLAGS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^OBJC$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^OBJCFLAGS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^OBJCXX$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^OBJCXXFLAGS$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^PC$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^RANLIB$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^SOURCE_DATE_EPOCH$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^TERM$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^V$&#39;</span><span class="p">,</span>
                        <span class="s">&#39;^YACC$&#39;</span>
                      <span class="p">];</span>
</pre></div>
<p><code>~/.sbuildrc</code> はPerlのスクリプトになっていて、ファイル末尾に以下のような行があるので、それよりは上に上記の設定を書きます。</p>
<div class="highlight"><pre><span></span><span class="c1"># don&#39;t remove this, Perl needs it:</span>
<span class="mi">1</span><span class="p">;</span>
</pre></div>
<p>この設定を入れた上で、以下のコマンドでビルドするようにしました。</p>
<div class="highlight"><pre><span></span><span class="go">TERM=unknown DEB_BUILD_OPTIONS=parallel=2 V=1 sbuild --sbuild-mode=buildd</span>
</pre></div>
<p><code>DEB_BUILD_OPTIONS</code> の値は上記のPPAのログでは <code>parallel=4</code> でしたが、自宅サーバはコア数が2なので2にしています。</p>
<p><code>--sbuild-mode</code> オプションは
<a class="reference external" href="http://manpages.ubuntu.com/manpages/bionic/en/man1/sbuild.1.html">man sbuild</a> と
<a class="reference external" href="http://manpages.ubuntu.com/manpages/bionic/en/man5/sbuild.conf.5.html">man sbuild.conf</a>
を見ると <code>user</code> と <code>buildd</code> という選択肢があってデフォルトは <code>user</code> でした。</p>
<p>PPAのビルドログをみると launchpad-buildd というツールを使っているようなので <code>buildd</code> にしました。</p>
</div>
<div class="section" id="chroot">
<h2>ビルド失敗したchroot環境に入る</h2>
<p><a class="reference external" href="https://hnakamur.github.io/blog/2018/06/07/setup-sbuild-on-ubuntu-18.04-lts/">Ubuntu 18.04 LTSでsbuildをセットアップ</a>
で <code>~/.sbuildrc</code> に以下の設定を入れているので、ビルド失敗時にはchroot環境のセッションが削除されずに残ります。</p>
<div class="highlight"><pre><span></span><span class="nv">$purge_build_directory</span> <span class="o">=</span> <span class="s">&#39;successful&#39;</span><span class="p">;</span>
<span class="nv">$purge_session</span> <span class="o">=</span> <span class="s">&#39;successful&#39;</span><span class="p">;</span>
<span class="nv">$purge_build_deps</span> <span class="o">=</span> <span class="s">&#39;successful&#39;</span><span class="p">;</span>
</pre></div>
<p>ビルドログに以下のようにビルドセッションのIDが出力されます。</p>
<div class="highlight"><pre><span></span>+------------------------------------------------------------------------------+
| Cleanup                                                                      |
+------------------------------------------------------------------------------+

Not cleaning session: cloned chroot in use
Keeping session: bionic-amd64-sbuild-ec0f01f1-fc92-4ac0-940f-15acf7a9346c
E: Build failure (dpkg-buildpackage died)
</pre></div>
<p>ちなみにビルド成功時は以下のように出力されビルドセッションは削除されます。</p>
<div class="highlight"><pre><span></span>+------------------------------------------------------------------------------+
| Cleanup                                                                      |
+------------------------------------------------------------------------------+

Purging /&lt;&lt;BUILDDIR&gt;&gt;
Not cleaning session: cloned chroot in use
</pre></div>
<p><code>schroot -l --all-sessions</code> と実行するとセッションの一覧を確認できます。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> schroot -l --all-sessions
<span class="go">session:bionic-amd64-sbuild-06716ae7-5bfd-4845-80bc-fa6df4f9a2f9</span>
<span class="go">session:bionic-amd64-sbuild-119e026d-45df-45c6-b1a3-f2f750c0be86</span>
<span class="go">session:bionic-amd64-sbuild-1fa47574-b8e4-4bf3-b4b4-d2d247882bad</span>
<span class="go">session:bionic-amd64-sbuild-2298d959-a0c0-4b34-84b6-da0cf55b4e69</span>
<span class="go">session:bionic-amd64-sbuild-2d8e08f5-0f6d-4586-b73e-6fbe32d25a00</span>
<span class="go">session:bionic-amd64-sbuild-578bd0b0-e053-4ba1-80bd-eedc63b786f0</span>
<span class="go">session:bionic-amd64-sbuild-6778cf73-a495-4568-b75e-575955204012</span>
<span class="go">session:bionic-amd64-sbuild-903e3529-eb26-4d6c-a1de-b6271f899ee2</span>
<span class="go">session:bionic-amd64-sbuild-db7a2953-5321-420b-b14d-bda5c9c8845b</span>
<span class="go">session:bionic-amd64-sbuild-ec0f01f1-fc92-4ac0-940f-15acf7a9346c</span>
</pre></div>
<p>ちなみにchroot環境の一覧は <code>schroot -l</code> で確認できます。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> schroot -l
<span class="go">chroot:bionic-amd64</span>
<span class="go">chroot:bionic-amd64-sbuild</span>
<span class="go">source:bionic-amd64</span>
<span class="go">source:bionic-amd64-sbuild</span>
</pre></div>
<p>特定のセッションにユーザと実行ディレクトリを指定して入るのは以下のようにします（セッションIDとユーザIDとディレクトリは適宜変更してください）。</p>
<div class="highlight"><pre><span></span><span class="go">schroot -r -c bionic-amd64-sbuild-ec0f01f1-fc92-4ac0-940f-15acf7a9346c -u root -d /root</span>
</pre></div>
</div>
<div class="section" id="id4">
<h2>chrootのセッションを削除</h2>
<p>特定のセッションを終了して削除するには <code>schroot -e -c セッションID</code> と実行します。
その後 <code>schroot -l --all-sessions</code> 指定したセッションがなくなっていることを確認します。</p>
<p>全てのセッションを終了するには <code>schroot -e --all-sessions</code> とします。
<a class="reference external" href="https://wiki.ubuntu.com/SimpleSbuild">SimpleSbuild - Ubuntu Wiki</a> の Expiring active schroot sessions に書いていました。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>