<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>PXEブートでVyOSをインストール</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/10/08/install-vyos-with-pxe-boot/" rel="bookmark"
           title="Permalink to PXEブートでVyOSをインストール">PXEブートでVyOSをインストール</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-10-08T18:40:00+09:00">
                Published: 2018-10-08
        </abbr>
		<br />
        <abbr class="modified" title="2018-10-08T19:00:00+09:00">
                Updated: 2018-10-08
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/vyos.html">vyos</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>半年前くらいに <a class="reference external" href="https://twitter.com/yamamasa23">yamamasa23</a> さんの真似して中古で買った
<a class="reference external" href="https://store.atworks.co.jp/eol/eol2012/quad-beagle-zg/">Quad Beagle ZG</a>
に PXE ブートで <a class="reference external" href="https://vyos.io/">VyOS</a> をインストールしてみたメモです。</p>
<p>手順は <a class="reference external" href="https://wiki.vyos.net/wiki/PXE">PXE - VyOS Wiki</a> を参考にしました。</p>
<p>私は EdgeRouter-Lite で EdgeOS は利用していますが、 VyOS は今回が初めてです。</p>
<p>一通り設定してから、まとめてブログを書きたいのですが、分量が増えると書くのが
大変 (自分用のメモといっても、後から読んで理解できるように書こうとすると
なんだかんだで結構時間がかかってます) になるので、小分けにして書くことにします。</p>
</div>
<div class="section" id="debianpxe">
<h2>DebianのPXE ブート環境の整備</h2>
<p><a class="reference external" href="https://wiki.vyos.net/wiki/PXE">PXE - VyOS Wiki</a> に PXELINUX の設定が必要と
書かれているので、整備しました。</p>
<p><a class="reference external" href="/blog/2018/04/23/setup-router-on-ubuntu16.04/">Ubuntu 16.04をルーター化</a> と
<a class="reference external" href="/blog/2018/04/24/ubuntu18.04-pxe-boot-server-on-ubuntu16.04/">Ubuntu 16.04上にUbuntu 18.04のPXEブートサーバをセットアップ</a>
に書いた環境を今回は Ubuntu 18.04 上で構築しました。</p>
<p>一言で言うと <code>tftpd-hpa</code> と <code>isc-dhcp-server</code> の2つのパッケージを
インストールします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt install tftpd-hpa isc-dhcp-server</span>
</pre></div>
<p>なお私は以前使っていた <code>/var/lib/tftpboot</code> ディレクトリは <code>/var/lib/tftpboot.bak</code> に退避して、空のディレクトリを作りました。</p>
<p><a class="reference external" href="https://ja.wikipedia.org/wiki/VyOS">VyOS - Wikipedia</a> によると VyOS は
Debian 6.0 (Squeeze) をベースにしているとのことなので、
<a class="reference external" href="http://ftp.riken.jp/Linux/debian/debian/dists/">http://ftp.riken.jp/Linux/debian/debian/dists/</a> 以下から
<a class="reference external" href="http://ftp.riken.jp/Linux/debian/debian/dists/wheezy/main/installer-amd64/current/images/netboot/netboot.tar.gz">http://ftp.riken.jp/Linux/debian/debian/dists/wheezy/main/installer-amd64/current/images/netboot/netboot.tar.gz</a>
をダウンロードして <code>/var/lib/tftpboot</code> 以下に展開しました。</p>
<div class="highlight"><pre><span></span><span class="go">curl -L http://ftp.riken.jp/Linux/debian/debian/dists/wheezy/main/installer-amd64/current/images/netboot/netboot.tar.gz | sudo tar xf - -C /var/lib/tftpboot</span>
</pre></div>
<p><code>/etc/dhcp/dhcpd.conf</code> には以下の設定を追加しました。</p>
<div class="highlight"><pre><span></span>subnet 192.168.3.0 netmask 255.255.255.0 {
  option domain-name-servers 192.168.2.1;
  option routers 192.168.3.1;
  filename &quot;pxelinux.0&quot;;
}

host beagle {
  hardware ethernet XX:XX:XX:XX:XX:XX;
  fixed-address 192.168.3.2;
}
</pre></div>
</div>
<div class="section" id="vyospxe">
<h2>VyOSのPXE ブート環境の整備</h2>
<p><a class="reference external" href="https://wiki.vyos.net/wiki/PXE">PXE - VyOS Wiki</a> にはパッチを当てた initrd.img を使ったと書いていましたが、リンク切れになっていたのと <a class="reference external" href="https://github.com/vyos/live-initramfs/pull/1">Fix PXE booting helium · Pull Request #1 · vyos/live-initramfs</a> のコメントによると VyOS 1.1.8 には取り込まれたようだったので、 1.1.8 のをそのまま使いました。</p>
<p>作業用ディレクトリを作成して、VyOS のダウンロードページから ISO イメージをダウンロードし、マウント用ディレクトリ mnt を作ってそこにループバックマウントします。</p>
<div class="highlight"><pre><span></span><span class="go">mkdir ~/vyos</span>
<span class="go">cd !$</span>
<span class="go">curl -LO https://downloads.vyos.io/release/1.1.8/vyos-1.1.8-amd64.iso</span>
<span class="go">mkdir mnt</span>
<span class="go">sudo mount -o loop vyos-1.1.8-amd64.iso mnt</span>
</pre></div>
<p>mnt/live ディレクトリ内の vmlinuz と initrd.img を tftpd の公開領域に vyos というディレクトリを作ってコピーします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo mkdir /var/lib/tftpboot/vyos</span>
<span class="go">sudo cp -p mnt/live/{vmlinuz,initrd.img} !$</span>
</pre></div>
<p>HTTP サーバで配信するためのディレクトリを作り、 mnt/live ディレクトリ内の filesystem.squashfs をそこにコピーします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo mkdir -p /opt/kickstart/export/vyos</span>
<span class="go">sudo mnt/live/filesystem.squashfs !$</span>
</pre></div>
<p>nginx で以下の設定を <code>/etc/nginx/conf.d/vyos-pxe-boot.conf</code> として作成し(他の設定がある場合は適宜調整し) <code>systemctl reload nginx</code> で反映させます。</p>
<div class="highlight"><pre><span></span>server {
    listen 80;
    server_name localhost;

    location /vyos {
        root /opt/kickstart/export;
    }
}
</pre></div>
<p><code>/var/lib/tftpboot/pxelinux.cfg/default</code> に以下の内容を追加します。
<code>append</code> 行の最後の <code>verbose debug=vc</code> の部分はデバッグ用なので無くても良いですが、指定しておくとシェルスクリプトが <code>set -x</code> つきで実行されるので便利です。</p>
<div class="highlight"><pre><span></span>label vyos
   kernel /vyos/vmlinuz
   append initrd=/vyos/initrd.img console=ttyS0 console=tty0 boot=live nopersistent noautologin nonetworking nouser hostname=vyos fetch=http://192.168.3.1/vyos/filesystem.squashfs verbose debug=vc
   ipappend 2
</pre></div>
</div>
<div class="section" id="pxe">
<h2>PXEブートしてインストール</h2>
<p>PXEブートし、上記で追加した vyos メニューを選び、あとは
<a class="reference external" href="https://wiki.vyos.net/wiki/User_Guide#Installation">Installation - User Guide - VyOS Wiki</a>
(<a class="reference external" href="https://wiki.vyos-users.jp/index.php/%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%AC%E3%82%A4%E3%83%89#.E3.82.A4.E3.83.B3.E3.82.B9.E3.83.88.E3.83.BC.E3.83.AB">日本語訳</a>)
に従ってインストールすれば OK でした。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>