<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.133.1">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>go1.10rc1のdebパッケージを作ってみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2024. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>go1.10rc1のdebパッケージを作ってみた</h1>
  <time datetime=2018-01-28T21:30:00&#43;0900 class="post-date">2018-01-28</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#golang-110のパッケージ作成">golang-1.10のパッケージ作成</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#golang-defaultsのパッケージ作成">golang-defaultsのパッケージ作成</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#golang-110-race-detector-runtimeのパッケージ作成">golang-1.10-race-detector-runtimeのパッケージ作成</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#ppaでビルド">PPAでビルド</a></li>
    <li><a href="#ppaからのインストール方法">PPAからのインストール方法</a></li>
    <li><a href="#おわりに">おわりに</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="/blog/2017/08/05/built-golang-1.9rc1-deb-package/">golang 1.9rc1のUbuntu 16.04用debパッケージをビルドした</a> 以降go1.9.xのdebパッケージを <a href="https://honk.sigxcpu.org/piki/projects/git-buildpackage/">git-buildpackage</a> で作っていましたが、今回 go1.10rc1 のdebパッケージを作ってみたのでメモです。</p>
<p>上の記事ではよくわかっていなかったので手順に無駄がありましたが、今回は現状の私の理解での最適な手順を書きました。ビルドするところまでは。</p>
<p>ビルドが失敗して試行錯誤したので記録として残そうかと思ったのですが長くなったので最終的な手順だけメモしておきます。</p>
<h2 id="golang-110のパッケージ作成">golang-1.10のパッケージ作成</h2>
<p>パッケージのソースのレポジトリは
<a href="https://github.com/hnakamur/golang-deb">https://github.com/hnakamur/golang-deb</a>
です。</p>
<h4 id="110x用のブランチ作成">1.10.x用のブランチ作成</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">git branch ubuntu-1.10 ubuntu-1.9
</span></span></span><span class="line"><span class="cl"><span class="go">git branch upstream-1.10 upstream-1.9
</span></span></span></code></pre></div><h4 id="110rc1のtarballをダウンロード">1.10rc1のtarballをダウンロード</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mkdir -p ~/go-deb-work
</span></span></span><span class="line"><span class="cl"><span class="go">cd ~/go-deb-work
</span></span></span><span class="line"><span class="cl"><span class="go">curl -LO https://dl.google.com/go/go1.10rc1.src.tar.gz
</span></span></span></code></pre></div><h4 id="ビルド対象を110xに切り替え">ビルド対象を1.10.xに切り替え</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cd ~/.ghq/github.com/hnakamur/golang-deb
</span></span></span><span class="line"><span class="cl"><span class="go">git checkout ubuntu-1.10
</span></span></span><span class="line"><span class="cl"><span class="go">vi debian/changelog
</span></span></span></code></pre></div><p>先頭に以下の内容を追加。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">golang-1.10 (1.10~rc1-1ubuntu1~hnakamur1) xenial; urgency=medium
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  * Imported Upstream version 1.10rc1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Fri, 26 Jan 2018 22:53:00 +0900
</span></span></code></pre></div><p>.. code-block:: console</p>
<pre><code>git commit -m 'Release 1.10~rc1-1ubuntu1~hnakamur1' debian/changelog
</code></pre>
<p><code>debian/changelog</code> の先頭のエントリの <code>golang-1.10</code> の部分を元に
<code>debian/gbp.conf</code> などのファイルを上書き生成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">./debian/rules gencontrol
</span></span></span></code></pre></div><p>生成された debian/gbp.conf の内容を確認。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> cat debian/gbp.conf
</span></span><span class="line"><span class="cl"><span class="gp">#</span>
</span></span><span class="line"><span class="cl"><span class="c1"># WARNING: &#34;debian/gbp.conf&#34; is generated via &#34;debian/rules gencontrol&#34; (sourced from &#34;debian/gbp.conf.in&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="gp">#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>DEFAULT<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="go">debian-branch = ubuntu-1.10
</span></span></span><span class="line"><span class="cl"><span class="go">debian-tag = debian/%(version)s
</span></span></span><span class="line"><span class="cl"><span class="go">upstream-branch = upstream-1.10
</span></span></span><span class="line"><span class="cl"><span class="go">upstream-tag = upstream/%(version)s
</span></span></span><span class="line"><span class="cl"><span class="go">pristine-tar = True
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[dch]
</span></span></span><span class="line"><span class="cl"><span class="go">meta = 1
</span></span></span></code></pre></div><p>他に以下のファイルも生成されていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git status -s
</span></span><span class="line"><span class="cl"><span class="go"> M debian/control
</span></span></span><span class="line"><span class="cl"><span class="go"> M debian/gbp.conf
</span></span></span><span class="line"><span class="cl"><span class="go"> M debian/source/lintian-overrides
</span></span></span><span class="line"><span class="cl"><span class="go"> M debian/watch
</span></span></span></code></pre></div><p>変更されたファイルをコミットします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git commit -m <span class="s1">&#39;Switch to go1.10.x&#39;</span> debian/
</span></span></code></pre></div><h4 id="110rc1のtarballをインポート">1.10rc1のtarballをインポート</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp import-orig --no-interactive -u1.10~rc1 ~/go-deb-work/go1.10rc1.src.tar.gz
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Importing &#39;/home/hnakamur/go-deb-work/go1.10rc1.src.tar.gz&#39; to branch &#39;upstream-1.10&#39;...
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Source package is golang-1.10
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Upstream version is 1.10~rc1
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Merging to &#39;ubuntu-1.10&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Successfully imported version 1.10~rc1 of /home/hnakamur/go-deb-work/go1.10rc1.src.tar.gz
</span></span></span></code></pre></div><p>これで以下の4つが実行されていました。</p>
<ul>
<li><code>pristine-tar</code> ブランチに 1.10rc1 用のコミットが追加された。</li>
<li><code>upstream-1.10</code> ブランチに 1.10rc1 をインポートしたコミットが追加された。</li>
<li>上記のコミットに <code>upstream/1.10_rc1</code> というタグが打たれた。</li>
<li><code>ubuntu-1.10</code> ブランチに <code>upstream-1.10</code> ブランチの内容がマージされた。</li>
</ul>
<h4 id="110rc1のソースパッケージを作成">1.10rc1のソースパッケージを作成</h4>
<p>以下のコマンドでソースパッケージを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">gbp buildpackage --git-export-dir=../build-area -S -sa -p/home/hnakamur/bin/gpg-passphrase
</span></span></span></code></pre></div><p>最後の <code>-p</code> オプションは `git-buildpackageとfreightでパスフレーズをファイルから入力させる](/blog/2017/08/28/use-passphrase-file-in-git-buildpackage-and-freight/) にメモした通りパスフレーズを自動入力するためのものです。</p>
<h4 id="110rc1のdebパッケージをローカルでビルド">1.10rc1のdebパッケージをローカルでビルド</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo pbuilder build ../build-area/golang-1.10_1.10~rc1-1ubuntu1~hnakamur1.dsc
</span></span></span></code></pre></div><h4 id="ビルド失敗と回避策">ビルド失敗と回避策</h4>
<p>これで無事ビルドできるかと思いきや以下のようなエラーが出てビルド失敗しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Building packages and commands for linux/amd64.
</span></span><span class="line"><span class="cl">/build/golang-1.10-1.10~rc1/bin/go install -v -buildmode=shared \
</span></span><span class="line"><span class="cl">        -ldflags &#39;-extldflags &#34;-Wl,-soname=libgolang-1.10-std.so.1&#34;&#39; \
</span></span><span class="line"><span class="cl">        std
</span></span><span class="line"><span class="cl">initializing cache in $GOCACHE: mkdir /nonexistent: permission denied
</span></span><span class="line"><span class="cl">debian/rules:115: recipe for target &#39;override_dh_auto_build-arch&#39; failed
</span></span><span class="line"><span class="cl">make[1]: *** [override_dh_auto_build-arch] Error 1
</span></span><span class="line"><span class="cl">make[1]: Leaving directory &#39;/build/golang-1.10-1.10~rc1&#39;
</span></span><span class="line"><span class="cl">debian/rules:26: recipe for target &#39;build&#39; failed
</span></span><span class="line"><span class="cl">make: *** [build] Error 2
</span></span><span class="line"><span class="cl">dpkg-buildpackage: error: debian/rules build gave error exit status 2
</span></span><span class="line"><span class="cl">I: copying local configuration
</span></span><span class="line"><span class="cl">E: Failed autobuilding of package
</span></span><span class="line"><span class="cl">I: user script /var/cache/pbuilder/build/8740/tmp/hooks/C10shell starting
</span></span></code></pre></div><p>go1.10rc1のソースを見てみました。
上記の <code>initializing cache in $GOCACHE: mkdir /nonexistent: permission denied</code>
のエラーは以下の43行目で出ているようです。</p>
<p><a href="https://github.com/golang/go/blob/go1.10rc1/src/cmd/go/internal/cache/default.go#L35-L55">https://github.com/golang/go/blob/go1.10rc1/src/cmd/go/internal/cache/default.go#L35-L55</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// initDefaultCache does the work of finding the default cache
</span></span></span><span class="line"><span class="cl"><span class="c1">// the first time Default is called.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">initDefaultCache</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dir</span> <span class="o">:=</span> <span class="nf">DefaultDir</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">dir</span> <span class="o">==</span> <span class="s">&#34;off&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">base</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;initializing cache in $GOCACHE: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="s">&#34;README&#34;</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Best effort.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">ioutil</span><span class="p">.</span><span class="nf">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="s">&#34;README&#34;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">cacheREADME</span><span class="p">),</span> <span class="mo">0666</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Open</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">base</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;initializing cache in $GOCACHE: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">defaultCache</span> <span class="p">=</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>いろいろ調べたり試行錯誤した結果、pbuilderが <code>$HOME</code> の指すディレクトリを書き込み不可にする一方、goのビルドとテストでは <code>$HOME</code> 以下にディレクトリやファイルを作ろうとするのでエラーになることがわかりました。</p>
<p>そこで以下のように <code>debian/rules</code> を書き換えて回避しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">diff --git a/debian/rules b/debian/rules
</span></span><span class="line"><span class="cl">index b6d44ae..3bc70c9 100755
</span></span><span class="line"><span class="cl">--- a/debian/rules
</span></span><span class="line"><span class="cl">+++ b/debian/rules
</span></span><span class="line"><span class="cl">@@ -22,6 +22,14 @@ shlib_archs = $(shell GOVER=$(GOVER) perl debian/helpers/getshlibarches.pl)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> multiarch := $(shell dpkg-architecture -qDEB_HOST_MULTIARCH)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">+# NOTE: We need $HOME to be writable in order to run builds
</span></span><span class="line"><span class="cl">+# and tests successfully.
</span></span><span class="line"><span class="cl">+# pbuilder sets $HOME to /nonexistent and make it non-writable.
</span></span><span class="line"><span class="cl">+# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=441052
</span></span><span class="line"><span class="cl">+ifneq (0,$(shell test -w &#34;$(HOME)&#34;; echo $$?))
</span></span><span class="line"><span class="cl">+        export HOME := /tmp
</span></span><span class="line"><span class="cl">+endif
</span></span><span class="line"><span class="cl">+
</span></span><span class="line"><span class="cl"> %:
</span></span><span class="line"><span class="cl">        +dh --parallel $(opt_no_act) $@
</span></span></code></pre></div><p>これをコミットして再度ソースパッケージとdebパッケージをビルドすると今度は成功しました。</p>
<h4 id="gitタグ作成">gitタグ作成</h4>
<p>動作確認後以下のタグを打っておきました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">git tag debian/1.10_rc1-1ubuntu1_hnakamur1
</span></span></span></code></pre></div><h2 id="golang-defaultsのパッケージ作成">golang-defaultsのパッケージ作成</h2>
<p>パッケージのソースのレポジトリは
<a href="https://github.com/hnakamur/golang-defaults-deb">https://github.com/hnakamur/golang-defaults-deb</a>
です。</p>
<h4 id="changelogにエントリ追加">changelogにエントリ追加</h4>
<p><code>debian/changelog</code> の先頭に以下のエントリを追加します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">golang-defaults (2:1.10~1ubuntu1~hnakamur1) xenial; urgency=medium
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  * Use Golang 1.10.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Sun, 28 Jan 2018 16:52:00 +0900
</span></span></code></pre></div><p>上記の変更をコミットします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">git commit -m &#39;Release 2:1.10~1ubuntu1~hnakamur1&#39; debian/changelog
</span></span></span></code></pre></div><h4 id="ソースパッケージを作成">ソースパッケージを作成</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">gbp buildpackage --git-export-dir=../build-area -S -sa -p/home/hnakamur/bin/gpg-passphrase
</span></span></span></code></pre></div><h4 id="debパッケージをローカルでビルド">debパッケージをローカルでビルド</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo pbuilder build ../build-area/golang-defaults_1.10~1ubuntu1~hnakamur1.dsc
</span></span></span></code></pre></div><h4 id="gitタグ作成-1">gitタグ作成</h4>
<p>動作確認後以下のタグを打っておきました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">git tag debian/1.10_1ubuntu1_hnakamur1
</span></span></span></code></pre></div><h2 id="golang-110-race-detector-runtimeのパッケージ作成">golang-1.10-race-detector-runtimeのパッケージ作成</h2>
<p>パッケージのソースのレポジトリは
<a href="https://github.com/hnakamur/golang-1.10-race-detector-runtime-deb">https://github.com/hnakamur/golang-1.10-race-detector-runtime-deb</a>
です。</p>
<h4 id="ソースレポジトリを作成">ソースレポジトリを作成</h4>
<p>1.9のrace-detector-runtimeのレポジトリをコピーして作成しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cp -pr ~/.ghq/github.com/hnakamur/golang-1.{9,10}-race-detector-runtime-deb
</span></span></span></code></pre></div><p><code>debian/control</code> 内のパッケージ名を1.10用に書き換えます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sed -i &#39;s/golang-1\.9/golang-1.10/&#39; debian/control
</span></span></span></code></pre></div><p><code>debian/golang-1.8-race-detector-runtime.lintian-overrides</code> というファイルがあり、中身を見ると前回1.9用に作ったときに1.9用に書き換えてあったのですが、ファイル名は1.8のままになっていました。</p>
<p>ということでファイル名を1.10用に変えつつ中身も1.10用に変えます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">git mv debian/golang-1.{8,10}-race-detector-runtime.lintian-overrides
</span></span></span><span class="line"><span class="cl"><span class="go">sed -i &#39;s/golang-1\.9/golang-1.10/;s/go-1\.9/go-1.10/&#39; debian/golang-1.10-race-detector-runtime.lintian-overrides
</span></span></span></code></pre></div><p><a href="https://github.com/golang/go/blob/go1.10rc1/src/runtime/race/README">https://github.com/golang/go/blob/go1.10rc1/src/runtime/race/README</a>
を見ると、goのrace detectorのランタイムはLLVMプロジェクトの
ThreadSanitizer race detectorがベースになっていると書いてあります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">runtime/race package contains the data race detector runtime library.
</span></span><span class="line"><span class="cl">It is based on ThreadSanitizer race detector, that is currently a part of
</span></span><span class="line"><span class="cl">the LLVM project (http://llvm.org/git/compiler-rt.git).
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To update the .syso files use golang.org/x/build/cmd/racebuild.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Current runtime is built on rev 68e1532492f9b3fce0e9024f3c31411105965b11.
</span></span></code></pre></div><p><code>debian/changelog</code> の先頭に以下のエントリを追加します。
バージョン番号内の <code>+git</code> の後の文字列は上のREADMEの最終行に書いてあるgitのコミットハッシュの先頭6桁にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">golang-1.10-race-detector-runtime (0.0+git68e153~ubuntu16.04.1hnakamur1) xenial; urgency=medium
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  * Update package name for Go 1.10.
</span></span><span class="line"><span class="cl">  * Update to version used by Go 1.10.
</span></span><span class="line"><span class="cl">  * Get orig source from the LLVM compiler-rt git repository.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Sun, 28 Jan 2018 17:40:00 +0900
</span></span></code></pre></div><p>変更内容をコミットします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">git commit -m &#39;Update for go1.10&#39; debian/
</span></span></span></code></pre></div><h4 id="オリジンのソース取得">オリジンのソース取得</h4>
<p><code>debian/rules</code> の <code>get-orig-source</code> ターゲットはgo1.9のときはLLVMのsubversionレポジトリから取得するようになっていたのですが、今回はgitなので処理を書き換えました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">diff --git a/debian/rules b/debian/rules
</span></span><span class="line"><span class="cl">index b28630a..44e0ea6 100755
</span></span><span class="line"><span class="cl">--- a/debian/rules
</span></span><span class="line"><span class="cl">+++ b/debian/rules
</span></span><span class="line"><span class="cl">@@ -35,13 +35,15 @@ override_dh_auto_build:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> PKD  = $(abspath $(dir $(MAKEFILE_LIST)))
</span></span><span class="line"><span class="cl"> PKG  = $(shell dpkg-parsechangelog -l$(PKD)/changelog --show-field=Source)
</span></span><span class="line"><span class="cl">-REVNO = $(shell dpkg-parsechangelog  -SVersion | sed -e &#39;s/.*svn\([0-9]\+\)-.*/\1/&#39;)
</span></span><span class="line"><span class="cl">+COMMIT = $(shell dpkg-parsechangelog -SVersion | sed -rne &#39;s/[^+]*\+git([0-9a-f]+).*/\1/p&#39;)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> get-orig-source:
</span></span><span class="line"><span class="cl">-       svn co http://llvm.org/svn/llvm-project/compiler-rt/trunk compiler-rt
</span></span><span class="line"><span class="cl">-       cd compiler-rt &amp;&amp; svn export -r $(REVNO) . &#34;../$(PKG)_0.0+svn$(REVNO)&#34;
</span></span><span class="line"><span class="cl">-       tar czf $(PKG)_0.0+svn$(REVNO).orig.tar.gz $(PKG)_0.0+svn$(REVNO)
</span></span><span class="line"><span class="cl">-       rm -rf compiler-rt $(PKG)_0.0+svn$(REVNO)
</span></span><span class="line"><span class="cl">+       ls | grep -v &#39;^debian$$&#39; | xargs rm -rf
</span></span><span class="line"><span class="cl">+       git clone http://llvm.org/git/compiler-rt.git
</span></span><span class="line"><span class="cl">+       cd compiler-rt \
</span></span><span class="line"><span class="cl">+               &amp;&amp; echo .gitignore export-ignore &gt; .gitattributes \
</span></span><span class="line"><span class="cl">+               &amp;&amp; git archive --worktree-attributes $(COMMIT) | tar x -C ..
</span></span><span class="line"><span class="cl">+       rm -rf compiler-rt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> %:
</span></span><span class="line"><span class="cl">        dh $@
</span></span></code></pre></div><p>以下のコマンドを実行してオリジンのソースを取得します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">./debian/rules get-orig-source
</span></span></span></code></pre></div><p>ソースの差分は以下の一か所だけで実質は変わっていませんでした。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">diff --git a/lib/tsan/go/buildgo.sh b/lib/tsan/go/buildgo.sh
</span></span><span class="line"><span class="cl">index 812cb93..42d4790 100755
</span></span><span class="line"><span class="cl">--- a/lib/tsan/go/buildgo.sh
</span></span><span class="line"><span class="cl">+++ b/lib/tsan/go/buildgo.sh
</span></span><span class="line"><span class="cl">@@ -125,7 +125,7 @@ if [ &#34;$SILENT&#34; != &#34;1&#34; ]; then
</span></span><span class="line"><span class="cl"> fi
</span></span><span class="line"><span class="cl"> $CC $DIR/gotsan.cc -c -o $DIR/race_$SUFFIX.syso $FLAGS $CFLAGS
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-$CC $OSCFLAGS test.c $DIR/race_$SUFFIX.syso -m64 -g -o $DIR/test $OSLDFLAGS $LDFLAGS
</span></span><span class="line"><span class="cl">+$CC $OSCFLAGS test.c $DIR/race_$SUFFIX.syso -m64 -g -o $DIR/test $OSLDFLAGS
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> export GORACE=&#34;exitcode=0 atexit_sleep_ms=0&#34;
</span></span><span class="line"><span class="cl"> if [ &#34;$SILENT&#34; != &#34;1&#34; ]; then
</span></span></code></pre></div><p>取得したソースはコミットしておきます。</p>
<h4 id="ソースパッケージを作成-1">ソースパッケージを作成</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">gbp buildpackage --git-export-dir=../build-area -S -sa -p/home/hnakamur/bin/gpg-passphrase
</span></span></span></code></pre></div><h4 id="debパッケージをローカルでビルド-1">debパッケージをローカルでビルド</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo pbuilder build ../build-area/golang-1.10-race-detector-runtime_0.0+git68e153~ubuntu16.04.1hnakamur1.dsc
</span></span></span></code></pre></div><h4 id="gitタグ作成-2">gitタグ作成</h4>
<p>動作確認後以下のタグを打っておきました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">git tag debian/0.0+git68e153_ubuntu16.04.1hnakamur1
</span></span></span></code></pre></div><h2 id="ppaでビルド">PPAでビルド</h2>
<p><a href="/blog/2017/08/05/create-private-deb-repository-with-freight/">freightでプライベートdebレポジトリ作成</a> の手順でローカルのレポジトリに登録してLXDのUbuntu Xenialコンテナで動作確認して問題ないことを確認した後、PPAでビルドしました。</p>
<p>今回新たに
<a href="https://launchpad.net/~hnakamur/+archive/ubuntu/golang-1.10">https://launchpad.net/~hnakamur/+archive/ubuntu/golang-1.10</a>
というPPAを作成しました。</p>
<p>作成後、画面右の Change details リンクをクリックして以下のように変更しました。</p>
<ul>
<li>Build debug symbols にチェック</li>
<li>Publish debug symbols にチェック</li>
<li>Processors の Intel x86 (i386) のチェックを外す</li>
</ul>
<p>以下のコマンドを実行してPPAでビルドしました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">dput ppa:hnakamur/golang-1.10 ../build-area/golang-1.10_1.10~rc1-1ubuntu1~hnakamur1_source.changes
</span></span></span><span class="line"><span class="cl"><span class="go">dput ppa:hnakamur/golang-1.10 ../build-area/golang-defaults_1.10~1ubuntu1~hnakamur1_source.changes
</span></span></span><span class="line"><span class="cl"><span class="go">dput ppa:hnakamur/golang-1.10 ../build-area/golang-1.10-race-detector-runtime_0.0+git68e153~ubuntu16.04.1hnakamur1_source.changes
</span></span></span></code></pre></div><p>PPAでのビルド完了後、ローカルのレポジトリからインストールしたdebパッケージはアンインストールして、以下の手順でPPAからインストールして再度動作確認しました。</p>
<h2 id="ppaからのインストール方法">PPAからのインストール方法</h2>
<p><code>add-apt-repository</code> コマンドを使うために <code>software-properties-common</code> パッケージが必要です。インストールしていない場合は以下のコマンドでインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo apt update
</span></span></span><span class="line"><span class="cl"><span class="go">sudo apt install software-properties-common
</span></span></span></code></pre></div><p>以下のコマンドで必要なパッケージ一式がインストールできます。
<code>golang-1.10-doc</code> パッケージは <code>godoc</code> コマンドを使うために必要ですので入れておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo add-apt-repository ppa:hnakamur/golang-1.10
</span></span></span><span class="line"><span class="cl"><span class="go">sudo apt update
</span></span></span><span class="line"><span class="cl"><span class="go">sudo apt install golang-go golang-1.10-doc
</span></span></span></code></pre></div><p>インストールされたgoでバージョンや実行ファイルのパスを確認してみました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@xenial:~# go version
</span></span></span><span class="line"><span class="cl"><span class="go">go version go1.10rc1 linux/amd64
</span></span></span><span class="line"><span class="cl"><span class="go">root@xenial:~# which go
</span></span></span><span class="line"><span class="cl"><span class="go">/usr/bin/go
</span></span></span><span class="line"><span class="cl"><span class="go">root@xenial:~# ls -l /usr/bin/go
</span></span></span><span class="line"><span class="cl"><span class="go">lrwxrwxrwx 1 root root 21 Jan 28 12:01 /usr/bin/go -&gt; ../lib/go-1.10/bin/go
</span></span></span></code></pre></div><h2 id="おわりに">おわりに</h2>
<p>まだ作ったばかりで軽い動作確認しかしてませんが、今後使っていこうと思います。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>
  </body>
</html>
