<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Ubuntu16.04でrpmビルド用にmockとcopr-cliをセットアップ</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/04/21/setup-mock-and-copr-cli-for-building-rpm-on-ubuntu-16.04/" rel="bookmark"
           title="Permalink to Ubuntu16.04でrpmビルド用にmockとcopr-cliをセットアップ">Ubuntu16.04でrpmビルド用にmockとcopr-cliをセットアップ</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-04-21T21:00:00+09:00">
                Published: 2018-04-21
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/ubuntu.html">ubuntu</a> <a href="../../../../tag/rpm.html">rpm</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>Ubuntu 16.04で <a class="reference external" href="https://github.com/rpm-software-management/mock">mock</a> でローカルでrpmをビルドするための環境構築の手順メモです。</p>
<p><a class="reference external" href="https://developer.fedoraproject.org/deployment/copr/about.html">Copr Build Service</a> でrpmをビルドする際に、ビルドが通ることを事前に確認するために mock を使ってローカルでrpmをビルドするようにしています。</p>
<p>mockはchrootを使っているのですがLXDでcentos7コンテナを作ってそこでmockを実行するとエラーでうまく動かなかったので、以前はdockerでcentos7のコンテナを作ってそこでmockを実行していました。</p>
<p>その後、ubuntuにもmockコマンドのパッケージがあることを知り、そちらを使うようになりました。で、今回別のサーバで再度環境を構築する必要が出てきたので、この機会にメモしておきます。</p>
<p>また Copr Build Service で rpm をビルドするときに <a class="reference external" href="https://developer.fedoraproject.org/deployment/copr/copr-cli.html">copr-cli</a> を使っていたので、こちらのセットアップ手順も合わせて書いておきます。</p>
</div>
<div class="section" id="mock">
<h2>mockのセットアップ</h2>
<p>以下のコマンドで mock をインストールします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt install mock</span>
</pre></div>
<p><a class="reference external" href="https://github.com/hnakamur/my-mock-configs-for-building-rpm-on-ubuntu">hnakamur/my-mock-configs-for-building-rpm-on-ubuntu</a> にあるchroot環境の設定ファイルを <code>/etc/mock/</code> にコピーします。</p>
<div class="highlight"><pre><span></span><span class="go">git clone https://github.com/hnakamur/my-mock-configs-for-building-rpm-on-ubuntu</span>
<span class="go">sudo cp ./my-mock-configs-for-building-rpm-on-ubuntu/*.cfg /etc/mock/</span>
</pre></div>
<div class="section" id="mockchroot">
<h3>(参考) mockのchroot設定にレポジトリ追加</h3>
<p>脱線してmockのchroot設定にレポジトリ追加する方法を説明しておきます。
例えば <code>/etc/mock/epel-7-x86_64-with-luajit.cfg</code> は
<code>/etc/mock/epel-7-x86_64.cfg</code> をコピーして以下のようにレポジトリ設定を追加しています。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> diff -u /etc/mock/epel-7-x86_64<span class="o">{</span>,-with-luajit<span class="o">}</span>.cfg
<span class="go">--- /etc/mock/epel-7-x86_64.cfg 2018-04-20 21:05:09.303104170 +0900</span>
<span class="go">+++ /etc/mock/epel-7-x86_64-with-luajit.cfg     2018-04-20 20:50:33.082617365 +0900</span>
<span class="go">@@ -68,4 +68,11 @@</span>
<span class="go"> mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=epel-debug-7&amp;arch=x86_64</span>
<span class="go"> failovermethod=priority</span>
<span class="go"> enabled=0</span>
<span class="go">+</span>
<span class="go">+[hnakamur-luajit]</span>
<span class="go">+name=Copr repo for luajit owned by hnakamur</span>
<span class="go">+baseurl=https://copr-be.cloud.fedoraproject.org/results/hnakamur/luajit/epel-7-$basearch/</span>
<span class="go">+enabled=1</span>
<span class="go">+gpgcheck=0</span>
<span class="go">+</span>
<span class="go"> &quot;&quot;&quot;</span>
</pre></div>
</div>
<div class="section" id="centos-7epel-7gpg">
<h3>CentOS 7とEPEL 7のgpg鍵ファイルインストール</h3>
<p>ウェブから鍵を取得する場合は以下の場所を参照します。</p>
<ul>
<li><p class="first"><a class="reference external" href="https://www.centos.org/keys/">CentOS GPG Keys</a> のCentOS 7 Signing Key</p>
<blockquote>
<ul class="simple">
<li><code>/usr/share/distribution-gpg-keys/centos/RPM-GPG-KEY-CentOS-7</code> に設置。</li>
</ul>
</blockquote>
</li>
<li><p class="first"><a class="reference external" href="https://getfedora.org/en/keys/">Package Signing Keys</a> のEPEL 7</p>
<blockquote>
<ul class="simple">
<li><code>/usr/share/distribution-gpg-keys/epel/RPM-GPG-KEY-EPEL-7</code> に設置。</li>
</ul>
</blockquote>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="go">sudo mkdir -p /usr/share/distribution-gpg-keys/{centos,epel}</span>
<span class="go">sudo curl -L -o /usr/share/distribution-gpg-keys/centos/RPM-GPG-KEY-CentOS-7 \</span>
<span class="go">  https://www.centos.org/keys/RPM-GPG-KEY-CentOS-7</span>
<span class="go">sudo curl -L -o /usr/share/distribution-gpg-keys/epel/RPM-GPG-KEY-EPEL-7 \</span>
<span class="go">  https://getfedora.org/static/352C64E5.txt</span>
</pre></div>
<p>と書きましたが、実際はLXDのCentOS7コンテナからコピーしたファイルを設置しました。
<a class="reference external" href="https://linuxconfig.org/how-to-list-import-and-remove-archive-signing-keys-on-centos-7">How to list, import and remove archive signing keys on CentOS 7 - LinuxConfig.org</a> で説明されていますが
<code>/etc/pki/rpm-gpg/</code> に鍵ファイルがありました。</p>
<div class="highlight"><pre><span></span><span class="gp">#</span> ls /etc/pki/rpm-gpg/
<span class="go">RPM-GPG-KEY-CentOS-7  RPM-GPG-KEY-CentOS-Debug-7  RPM-GPG-KEY-CentOS-Testing-7</span>
</pre></div>
</div>
<div class="section" id="mockmock">
<h3>mockグループを作成し自ユーザをmockグループに追加</h3>
<p>ubuntuのmockパッケージをインストールしてもmockグループは作られないので手動で作る必要がありました。</p>
<div class="highlight"><pre><span></span><span class="go">sudo groupadd -r mock</span>
</pre></div>
<p>その後、自ユーザをmockグループに追加します。</p>
<div class="highlight"><pre><span></span><span class="go">sudo usermod -a -G mock $USER</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>copr-cliのセットアップ</h2>
<p>copr-cli は自作のパッケージをPPAに置いてあるので、そこからインストールします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo add-apt-repository ppa:hnakamur/copr-cli</span>
<span class="go">sudo apt update</span>
<span class="go">sudo apt install python3-copr-cli</span>
</pre></div>
<p>ブラウザで <a class="reference external" href="https://copr.fedorainfracloud.org/api/">API for Copr</a> を開き
fedora coprアカウントでログインするとAPIトークンのファイルの内容が表示されますので、
それを <code>~/.config/copr</code> というファイルに保存します。</p>
</div>
<div class="section" id="id3">
<h2>実際のビルドの例</h2>
<ul class="simple">
<li><a class="reference external" href="http://192.168.2.203:8000/2018/04/05/building-my-custom-nginx-rpm-and-deb/">私のnginxのカスタムrpmとdebをビルドする手順</a></li>
<li><a class="reference external" href="http://192.168.2.203:8000/2018/04/05/building-my-golang-rpm-and-deb/">私のgoのrpmとdebをビルドする手順</a></li>
</ul>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>