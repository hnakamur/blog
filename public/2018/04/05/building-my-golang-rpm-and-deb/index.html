<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>私のgoのrpmとdebをビルドする手順</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/04/05/building-my-golang-rpm-and-deb/" rel="bookmark"
           title="Permalink to 私のgoのrpmとdebをビルドする手順">私のgoのrpmとdebをビルドする手順</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-04-05T11:21:00+09:00">
                Published: 2018-04-05
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/go.html">go</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>golangの非公式rpmとdebをビルドし始めてから結構経っていますが、自分のブログ記事に散らばっている
手順をピックアップしながら毎度ビルドしているのは良くないので、自分用にまとめておきます。
なおこの手順は私の手元の環境と自作コマンドに依存しているので、他の環境でコピペしても動きません。</p>
<p>以下ではバージョン1.10.1の例をメモします。</p>
</div>
<div class="section" id="tarball">
<h2>tarballのダウンロード</h2>
<div class="highlight"><pre><span></span><span class="go">cd ~/golang-deb-work</span>
<span class="go">curl -LO https://dl.google.com/go/go1.10.1.src.tar.gz</span>
</pre></div>
</div>
<div class="section" id="golangrpm">
<h2>golangのrpmをビルド</h2>
<div class="section" id="srpm">
<h3>srpmを作成</h3>
<p>rpmビルドの作業用gitレポジトリで新しいバージョン用にトピックブランチ作成。</p>
<div class="highlight"><pre><span></span><span class="go">cd ~/.ghq/github.com/hnakamur/golang-1.10-rpm</span>
<span class="go">g co -b 1_10_1</span>
</pre></div>
<p>新しいtarballをSOURCESディレクトリに追加し、古いtarballはgitレポジトリから削除。</p>
<div class="highlight"><pre><span></span><span class="go">cp ~/go-deb-work/go1.10.1.src.tar.gz SOURCES/</span>
<span class="go">g rm SOURCES/go1.10.src.tar.gz</span>
</pre></div>
<p>rpmのスペックファイルを更新。</p>
<div class="highlight"><pre><span></span><span class="go">vi SPECS/golang.spec</span>
</pre></div>
<ul class="simple">
<li><code>%global go_version 1.10.1</code> の行を更新。</li>
<li>nginxのバージョンの行 <code>Version: 1.10.1</code> を更新。</li>
<li><code>%changelog</code> セクションの先頭にエントリ追加。</li>
</ul>
<div class="highlight"><pre><span></span>%changelog
* Thu Apr  5 2018 Hiroaki Nakamura &lt;hnakamur@gmail.com&gt; - 1.10.1-1
- bump to 1.10.1
</pre></div>
<p>rpmビルドの作業用gitレポジトリに変更内容をコミット。</p>
<div class="highlight"><pre><span></span><span class="go">g a .</span>
<span class="go">g ci -m &#39;Update to 1.10.1&#39;</span>
</pre></div>
<p>srpmを作成。</p>
<div class="highlight"><pre><span></span><span class="go">mkdir ~/rpmbuild/SOURCES/golang-1.10.1-1</span>
<span class="go">ln -s $PWD/SOURCES/* !$</span>
<span class="go">rpmbuild -bs SPECS/golang.spec</span>
</pre></div>
</div>
<div class="section" id="mock">
<h3>mockコマンドを使ってローカルでビルド</h3>
<p>mockコマンドを使ってローカルでビルド。</p>
<div class="highlight"><pre><span></span><span class="go">/usr/bin/mock -r epel-7-x86_64 --resultdir=~hnakamur/mockresult-golang-1.10.1-1 --rebuild ~/rpmbuild/SRPMS/golang-1.10.1-1.src.rpm</span>
</pre></div>
<p>うまくビルドできたときは <code>~/mockresult-golang-1.10.1-1/</code> 以下に生成された <code>*.rpm</code> をCentOS7の環境にコピーして <code>yum install -y golang*.x86_64.rpm</code> でインストールして動作確認します。
ビルド失敗した場合はこのディレクトリの <code>build.log</code> を見てエラーの内容を確認します。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/golang-1.10-rpm$</span> ls -lt ~/mockresult-golang-1.10.1-1
<span class="go">total 136048</span>
<span class="go">-rw-rw-r-- 1 hnakamur hnakamur    81122 Apr  5 11:48 root.log</span>
<span class="go">-rw-rw-r-- 1 hnakamur hnakamur     1586 Apr  5 11:48 state.log</span>
<span class="go">-rw-rw-r-- 1 hnakamur hnakamur  1768912 Apr  5 11:48 build.log</span>
<span class="go">-rw-rw-r-- 1 hnakamur mock      8735608 Apr  5 11:48 golang-race-1.10.1-1.el7.centos.x86_64.rpm</span>
<span class="go">-rw-rw-r-- 1 hnakamur mock     15588632 Apr  5 11:48 golang-shared-1.10.1-1.el7.centos.x86_64.rpm</span>
<span class="go">-rw-rw-r-- 1 hnakamur mock     75041160 Apr  5 11:48 golang-bin-1.10.1-1.el7.centos.x86_64.rpm</span>
<span class="go">-rw-rw-r-- 1 hnakamur mock      5686740 Apr  5 11:46 golang-src-1.10.1-1.el7.centos.noarch.rpm</span>
<span class="go">-rw-rw-r-- 1 hnakamur mock      6831176 Apr  5 11:46 golang-tests-1.10.1-1.el7.centos.noarch.rpm</span>
<span class="go">-rw-rw-r-- 1 hnakamur mock       716016 Apr  5 11:46 golang-misc-1.10.1-1.el7.centos.noarch.rpm</span>
<span class="go">-rw-rw-r-- 1 hnakamur mock      2494336 Apr  5 11:46 golang-docs-1.10.1-1.el7.centos.noarch.rpm</span>
<span class="go">-rw-rw-r-- 1 hnakamur mock      1315652 Apr  5 11:46 golang-1.10.1-1.el7.centos.x86_64.rpm</span>
<span class="go">-rw-rw-r-- 1 hnakamur mock         9707 Apr  5 11:33 installed_pkgs</span>
<span class="go">-rw-rw-r-- 1 hnakamur mock     18221830 Apr  5 11:32 golang-1.10.1-1.el7.centos.src.rpm</span>
<span class="go">-rw-rw-r-- 1 root     root      2793543 Apr  5 11:32 available_pkgs</span>
</pre></div>
<p>テスト環境でインストールしたgoのバージョン確認。</p>
<div class="highlight"><pre><span></span><span class="gp">[root@centos7 ~]#</span> go version
<span class="go">go version go1.10.1 linux/amd64</span>
</pre></div>
<p>dataraceチェッカー付きで実行可能なことを確認。</p>
<div class="highlight"><pre><span></span><span class="gp">[root@centos7 ~]#</span> mkdir -p ~/go/src/github.com/hnakamur/hello-go
<span class="gp">[root@centos7 ~]#</span> <span class="nb">cd</span> !$
<span class="gp">[root@centos7 ~]#</span> vi main.go
</pre></div>
<p>以下の内容で <code>main.go</code> を作成。</p>
<div class="highlight"><pre><span></span>package main

import (
        &quot;fmt&quot;
        &quot;runtime&quot;
)

func main() {
        fmt.Printf(&quot;Hello, %s!\n&quot;, runtime.Version())
}
</pre></div>
<p>以下のように動作確認。</p>
<div class="highlight"><pre><span></span>[root@centos7 hello-go]# go run -race main.go
Hello, go1.10.1!
</pre></div>
</div>
<div class="section" id="copr">
<h3>coprでビルド</h3>
<div class="highlight"><pre><span></span><span class="go">copr-cli build hnakamur/golang-1.10 ~/mockresult-golang-1.10.1-1/golang-1.10.1-1.el7.centos.src.rpm</span>
</pre></div>
<p>ビルドが完了したら
<a class="reference external" href="https://copr.fedorainfracloud.org/coprs/hnakamur/golang-1.10/">hnakamur/nginx Copr</a> のレポジトリを追加しているテスト環境にてgolangを更新して動作確認します。</p>
</div>
<div class="section" id="rpmgit">
<h3>rpmのgitレポジトリの更新とリリース作成</h3>
<p>今回のトピックブランチをgithubにプッシュ。</p>
<div class="highlight"><pre><span></span><span class="go">g push origin 1_10_1</span>
</pre></div>
<p><a class="reference external" href="https://github.com/hnakamur/nginx-rpm">hnakamur/nginx-rpm</a> でプルリクエストを作成してマージ。</p>
<p>ローカルのmasterブランチを更新してトピックブランチを削除。</p>
<div class="highlight"><pre><span></span><span class="go">g f</span>
<span class="go">g co master</span>
<span class="go">g me origin/master --ff</span>
<span class="go">g delete-merged-branches</span>
</pre></div>
<p>タグを作成してプッシュ。</p>
<div class="highlight"><pre><span></span><span class="go">g tag 1.10.1-1</span>
<span class="go">g push origin !$</span>
</pre></div>
<p>coprでビルドされたrpmをダウンロードし、githubレポジトリにリリースを作成してアップロード。</p>
<div class="highlight"><pre><span></span><span class="go">copr-files-downloader -user hnakamur -repo golang-1.10 -dest ./tmp</span>
<span class="go">cd ./tmp</span>
<span class="go">github-release release --user hnakamur --repo golang-1.10-rpm --tag 1.10.1-1</span>
<span class="go">for i in $(ls); do github-release upload --user hnakamur --repo golang-1.10-rpm --tag 1.10.1-1 --name $i --file $i; done</span>
<span class="go">cd ..</span>
<span class="go">rm -r ./tmp</span>
</pre></div>
</div>
</div>
<div class="section" id="nginxdeb">
<h2>nginxのdebをビルド</h2>
<div class="section" id="deb">
<h3>debのソースパッケージ作成</h3>
<p>debビルドの作業用gitレポジトリで新しいtarballを取り込む。 <code>gbp import-orig</code> の <code>--pristine-tar</code> オプションを忘れないこと。これを忘れると後でソースパッケージをビルドする時にoriginのtarballがgitレポジトリから再構築され、後ほどPPAでビルドする時になってoriginのtarballが既に他のレポジトリでアップロードされていると同じファイル名で中身が一致しなくてエラーになってしまう。</p>
<div class="highlight"><pre><span></span><span class="go">cd ~/.ghq/github.com/hnakamur/golang-deb</span>
<span class="go">gbp import-orig --pristine-tar -u 1.10.1 ~/go-deb-work/go1.10.1.src.tar.gz</span>
</pre></div>
<p>golang-debの場合は <code>upstream-1.10</code> ブランチにオリジンのtarballを取り込んだ後 <code>ubuntu-1.10</code> ブランチにマージするところまでやってくれます。</p>
<p><code>debian/changelog</code> の先頭にエントリを追加します。
以下のコマンドを実行すると前バージョンのタグ以降のコミットのコミットメッセージを並べて自動的にコミットメッセージを入力した状態で <code>debian/changelog</code> を開いてくれます。</p>
<div class="highlight"><pre><span></span><span class="go">gbp dch -R</span>
</pre></div>
<p>今回の例では <code>debian/changelog</code> の先頭に以下のようにエントリが追加された状態で vim で開かれました。</p>
<div class="highlight"><pre><span></span>golang-1.10 (1.10.1-1) xenial; urgency=medium

  * Imported Upstream version 1.10.1

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Thu, 05 Apr 2018 11:41:04 +0900
</pre></div>
<p>これを以下のように変更します。</p>
<div class="highlight"><pre><span></span>golang-1.10 (1.10.1-1ubuntu1ppa1~ubuntu16.04.1) xenial; urgency=medium

  * Imported Upstream version 1.10.1

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Thu, 05 Apr 2018 11:41:04 +0900
</pre></div>
<p><code>debian/changelog</code> の変更をコミットしてタグを打ちます。</p>
<div class="highlight"><pre><span></span><span class="go">g ci . -m &#39;Release 1.10.1-1ubuntu1ppa1~ubuntu16.04.1&#39;</span>
<span class="go">g tag debian/1.10.1-1ubuntu1ppa1-ubuntu16.04.1</span>
</pre></div>
</div>
<div class="section" id="pbuilderdeb">
<h3>pbuilderを使ってローカルでdebパッケージをビルド</h3>
<p>debのソースパッケージをビルドします。</p>
<div class="highlight"><pre><span></span><span class="go">gbp buildpackage --git-export-dir=../build-area -p/home/hnakamur/bin/gpg-passphrase -S -sa</span>
</pre></div>
<p><code>pbuilder</code> を使ってdebパッケージをビルドします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo pbuilder build ../build-area/golang-1.10_1.10.1-1ubuntu1ppa1~ubuntu16.04.1.dsc</span>
</pre></div>
<p>無事にビルドが終わったら <code>/var/cache/pbuilder/result/golang*1.10.1*</code> にdebパッケージが作られます。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/golang-deb$</span> ls -lt /var/cache/pbuilder/result/golang*1.10.1*
<span class="go">-rw-r--r-- 1 hnakamur hnakamur     4179 Apr  5 12:03 /var/cache/pbuilder/result/golang-1.10_1.10.1-1ubuntu1ppa1~ubuntu16.04.1_amd64.changes</span>
<span class="go">-rw-r--r-- 1 hnakamur hnakamur  6600814 Apr  5 12:03 /var/cache/pbuilder/result/golang-1.10-go-shared-dev_1.10.1-1ubuntu1ppa1~ubuntu16.04.1_amd64.deb</span>
<span class="go">-rw-r--r-- 1 hnakamur hnakamur    30042 Apr  5 12:03 /var/cache/pbuilder/result/golang-1.10_1.10.1-1ubuntu1ppa1~ubuntu16.04.1_all.deb</span>
<span class="go">-rw-r--r-- 1 hnakamur hnakamur  2436718 Apr  5 12:03 /var/cache/pbuilder/result/golang-1.10-doc_1.10.1-1ubuntu1ppa1~ubuntu16.04.1_all.deb</span>
<span class="go">-rw-r--r-- 1 hnakamur hnakamur 10182508 Apr  5 12:03 /var/cache/pbuilder/result/golang-1.10-src_1.10.1-1ubuntu1ppa1~ubuntu16.04.1_amd64.deb</span>
<span class="go">-rw-r--r-- 1 hnakamur hnakamur 99426882 Apr  5 12:02 /var/cache/pbuilder/result/golang-1.10-go_1.10.1-1ubuntu1ppa1~ubuntu16.04.1_amd64.deb</span>
<span class="go">-rw-r--r-- 1 hnakamur hnakamur     1996 Apr  5 11:46 /var/cache/pbuilder/result/golang-1.10_1.10.1-1ubuntu1ppa1~ubuntu16.04.1.dsc</span>
<span class="go">-rw-r--r-- 1 hnakamur hnakamur    32972 Apr  5 11:46 /var/cache/pbuilder/result/golang-1.10_1.10.1-1ubuntu1ppa1~ubuntu16.04.1.debian.tar.xz</span>
<span class="go">-rw-r--r-- 1 hnakamur hnakamur 18305765 Apr  5 11:43 /var/cache/pbuilder/result/golang-1.10_1.10.1.orig.tar.gz</span>
</pre></div>
<p>作られたdebパッケージをfreightのローカルdebレポジトリに追加します。</p>
<div class="highlight"><pre><span></span><span class="go">pushd /var/www/html/my-debs</span>
<span class="go">sudo freight add /var/cache/pbuilder/result/golang*1.10.1*.deb apt/xenial</span>
<span class="go">sudo freight cache -p /home/hnakamur/.gpg-passphrase apt/xenial</span>
<span class="go">popd</span>
</pre></div>
<p>テスト用のUbuntu環境にてfreightのdebレポジトリからgoのパッケージを更新します。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt update</span>
<span class="go">sudo apt upgrade -y golang-1.10-go golang-1.10-doc golang-1.10-src</span>
</pre></div>
<p>rpmの場合と同様に <code>go version</code> と <code>go run -race main.go</code> で動作確認。</p>
</div>
<div class="section" id="ppadeb">
<h3>PPAでdebパッケージをビルド</h3>
<p>動作確認して問題なければPPAでdebパッケージをビルドします。</p>
<div class="highlight"><pre><span></span><span class="go">dput ppa:hnakamur/golang-1.10 ../build-area/golang-1.10_1.10.1-1ubuntu1ppa1~ubuntu16.04.1_source.changes</span>
</pre></div>
<p><a class="reference external" href="https://launchpad.net/~hnakamur/+archive/ubuntu/golang-1.10/+packages">Packages in “golang 1.10” : golang 1.10 : Hiroaki Nakamura</a> でこのバージョンのBuild Statusの列が緑のチェックマークになるまで待ちます（時計や緑の歯車のときはまだです）。</p>
<p>なかなかビルドが始まらない場合は <a class="reference external" href="https://launchpad.net/builders">https://launchpad.net/builders</a> で状況を確認します。といっても結局待つしか無いです。</p>
<p>無事ビルドが完了したら <a class="reference external" href="https://launchpad.net/~hnakamur/+archive/ubuntu/golang-1.10">golang 1.10 : Hiroaki Nakamura</a> のレポジトリを追加してあるテスト環境にてgoのパッケージを更新して動作確認します。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt update</span>
<span class="go">sudo apt upgrade -y golang-1.10-go golang-1.10-doc golang-1.10-src</span>
</pre></div>
<p>動作確認はrpmの場合と同様に <code>go version</code> と <code>go run -race main.go</code> です。</p>
</div>
<div class="section" id="debgit">
<h3>debのgitレポジトリの更新とリリース作成</h3>
<p>ローカルのgitレポジトリでの変更をgithubに反映します。</p>
<p>一旦以下のコマンドでプッシュを試みます。</p>
<div class="highlight"><pre><span></span><span class="go">g push origin --all</span>
</pre></div>
<p><code>patch-queue</code> ブランチがconflictする場合は、乱暴ですが <code>-f</code> つきで再度プッシュします。まあ、 <code>patch-queue</code> は一時的な作業用ブランチなのとこのgitレポジトリはチームではなく一人作業用なのでよしということで。</p>
<div class="highlight"><pre><span></span><span class="go">g push origin --all -f</span>
</pre></div>
<p>タグもプッシュします。</p>
<div class="highlight"><pre><span></span><span class="go">g push origin --tags</span>
</pre></div>
<p>PPAでビルドされたrpmをダウンロードし、githubレポジトリにリリースを作成してアップロード。</p>
<div class="highlight"><pre><span></span><span class="go">ppa-files-downloader -user hnakamur -repo golang-1.10 -pkg golang-1.10 -dest ./tmp</span>
<span class="go">cd ./tmp</span>
<span class="go">github-release release --user hnakamur --repo golang-deb --tag debian/1.10.1-1ubuntu1ppa1-ubuntu16.04.1</span>
<span class="go">for i in $(ls); do github-release upload --user hnakamur --repo golang-deb --tag debian/1.10.1-1ubuntu1ppa1-ubuntu16.04.1 --name $i --file $i; done</span>
<span class="go">cd ..</span>
<span class="go">rm -r ./tmp</span>
</pre></div>
</div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>