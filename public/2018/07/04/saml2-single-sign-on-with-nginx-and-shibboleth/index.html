<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>nginxとshibbolethでSAML2のシングルサインオンを試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/07/04/saml2-single-sign-on-with-nginx-and-shibboleth/" rel="bookmark"
           title="Permalink to nginxとshibbolethでSAML2のシングルサインオンを試してみた">nginxとshibbolethでSAML2のシングルサインオンを試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-07-04T16:40:00+09:00">
                Published: 2018-07-04
        </abbr>
		<br />
        <abbr class="modified" title="2018-07-13T09:50:00+09:00">
                Updated: 2018-07-13
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/saml.html">saml</a> <a href="../../../../tag/nginx.html">nginx</a> <a href="../../../../tag/single-sign-on.html">single-sign-on</a> <a href="../../../../tag/shibboleth.html">shibboleth</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>勤務先でSAML2のシングルサインオンについて調査していたところ
<a class="reference external" href="https://github.com/nginx-shib/nginx-http-shibboleth/issues/16">Is this module compatible with SAML 2 in HTTP POST mode? · Issue #16 · nginx-shib/nginx-http-shibboleth</a>
というイシューを見つけました。
この nginx-http-shibboleth というモジュールを使えば実現できそうということで、
nginxとshibbolethでSAML2のシングルサインオンを試してみたメモです。</p>
<p>なお、とりあえず試してみただけで、セキュリティ上問題無い設定になっているかは未確認なのでご注意ください。</p>
<p>SAML認証についての概要は
<a class="reference external" href="https://qiita.com/khsk/items/10a136bded197272094a">SAML認証を勉強せずに理解したい私から勉強せずに理解したい私へ - Qiita</a>
で紹介されていた
<a class="reference external" href="http://blog.cybozu.io/entry/4224">SAML認証ができるまで - Cybozu Inside Out | サイボウズエンジニアのブログ</a>
がわかりやすかったです。</p>
<p>登場人物とサービスは以下の3つです。</p>
<ul class="simple">
<li>エンドユーザ</li>
<li>実際に認証を行う Identity Provider (IdP)</li>
<li>IdPを利用してサービスを提供する Service Provider (SP)</li>
</ul>
<p>今回はIdPは勤務先で用意されたテスト用のIdPを使いつつ、SPをnginxと <a class="reference external" href="https://www.internet2.edu/products-services/trust-identity/shibboleth/">Shibboleth</a> でCentOS7上で構築してみました。</p>
<p>ShibbolethについてはWikipediaの
<a class="reference external" href="https://ja.wikipedia.org/wiki/%E3%82%B7%E3%83%9C%E3%83%AC%E3%82%B9">シボレス - Wikipedia</a>
のページがわかりやすかったです。</p>
</div>
<div class="section" id="rpm">
<h2>自作rpmパッケージ作成</h2>
<p>nginx以外に以下のソフトウェアが必要になるので、自作rpmパッケージを作りました。</p>
<div class="section" id="nginx-http-shibboleth">
<h3>nginx-http-shibbolethモジュール</h3>
<p>nginxからShibbolethに連携して認証を行うために
<a class="reference external" href="https://github.com/nginx-shib/nginx-http-shibboleth">nginx-shib/nginx-http-shibboleth: Shibboleth auth request module for nginx</a>
というモジュールを使うので、いつも利用しているnginxの自作rpm
<a class="reference external" href="https://copr.fedorainfracloud.org/coprs/hnakamur/nginx/">hnakamur/nginx Copr</a>
にこのモジュールを追加してビルドしました。</p>
<p>なお
<a class="reference external" href="https://github.com/nginx-shib/nginx-http-shibboleth">nginx-shib/nginx-http-shibboleth</a> が依存している
<a class="reference external" href="https://github.com/openresty/headers-more-nginx-module">openresty/headers-more-nginx-module</a> も必要ですが、これは既に自作rpmに含めていました。</p>
</div>
<div class="section" id="fastcgishibboleth-sp">
<h3>FastCGIサポートを有効にしたShibboleth SP</h3>
<p><a class="reference external" href="https://github.com/nginx-shib/nginx-http-shibboleth/blob/master/CONFIG.rst#shibboleth-sp-with-fastcgi-support">Shibboleth SP with FastCGI Support</a> に説明があります。DebianとUbuntuでは shibboleth-sp-utils パッケージがFastCGIサポートを有効にしてビルドされていますが、CentOS 7で使うShibolleth公式レポジトリのrpmパッケージではFastCGIサポートが無効なので、有効にしたものを自分でビルドする必要があります。</p>
<p><a class="reference external" href="https://github.com/nginx-shib/shibboleth-fastcgi">nginx-shib/shibboleth-fastcgi</a> にFastCGIサポートを有効にしてrpmをビルドするための説明がありますので、これを参考にして自作rpmをビルドしました。</p>
<ul class="simple">
<li>FastCGIサポート有りのShibbolethの自作rpmのレポジトリ <a class="reference external" href="https://copr.fedorainfracloud.org/coprs/hnakamur/shibboleth/">hnakamur/shibboleth Copr</a></li>
<li>上記のrpmのソース <a class="reference external" href="https://github.com/hnakamur/shibboleth-fastcgi-rpm">hnakamur/shibboleth-fastcgi-rpm</a></li>
</ul>
<p>shibbolethのrpmをインストールすると <code>shibd</code> というサービスが追加されるのですが、FastCGIを有効にするとさらに <code>shibauthorizer</code> と <code>shibresponder</code> という2つのサービスが追加されます。</p>
<p>この2つを <a class="reference external" href="http://supervisord.org/">Supervisor (supervisord)</a> でFastCGIとして実行するための設定が
<a class="reference external" href="https://github.com/nginx-shib/nginx-http-shibboleth/blob/master/CONFIG.rst#running-the-fastcgi-authorizer-and-responder">Running the FastCGI authorizer and responder</a>
に書かれています。</p>
<p>今回はCentOS 7ということでsystemdを使ってFastCGIとして実行するようにしました。この方法は今回初めて知ったのでメモしておきます。</p>
<p><a class="reference external" href="https://redmine.lighttpd.net/projects/spawn-fcgi/wiki/Systemd">Systemd - spawn-fcgi - lighty labs</a>
と
<a class="reference external" href="https://gist.github.com/stbuehler/439a9849747279a1f0a9#gistcomment-1950602">systemd to FastCGI socket passing compatibility script</a>
を参考にして以下のようにsystemd用の <code>.socket</code> ファイルと <code>.service</code> を作りました。</p>
<p><code>/lib/systemd/system/shibauthorizer.socket</code></p>
<div class="highlight"><pre><span></span>[Unit]
Description=shibauthorizer socket

[Socket]
SocketUser=shibd
SocketGroup=shibd
SocketMode=0660
ListenStream=/run/shibboleth/shibauthorizer.sock
Accept=false

[Install]
WantedBy=sockets.target
</pre></div>
<p><code>/lib/systemd/system/shibauthorizer.service</code></p>
<div class="highlight"><pre><span></span>[Unit]
Description=shibauthorizer
After=network.target
Requires=shibauthorizer.socket

[Service]
Type=simple
ExecStart=/usr/lib64/shibboleth/shibauthorizer
User=shibd
Group=shibd
StandardInput=socket
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
</pre></div>
<p><code>.socket</code> ファイルの <code>ListenStream</code> でUnixドメインソケットを作成し、 <code>.service</code> ファイルで <code>StandardInput=socket</code> と指定することでそこから入力を読み取るというわけです。</p>
<p>上記の2つは <code>shibauthorizer</code> 用ですが、 <code>shibresponder</code> 用にも同様に2つ作りました。</p>
</div>
<div class="section" id="xml-security-c">
<h3>xml-security-c</h3>
<p>Shibbolethのrpmをビルドするための <code>shibboleth.spec</code> ファイルに</p>
<div class="highlight"><pre><span></span>BuildRequires:  libxml-security-c-devel &gt;= 1.7.3
</pre></div>
<p>という
<a class="reference external" href="https://github.com/hnakamur/shibboleth-fastcgi-rpm/blob/3952b09f2670f13ac343210eeb9580ce83d36e07/SPECS/shibboleth.spec#L31">行</a>
があり、 <code>libxml-security-c-devel</code> というパッケージに依存していることがわかりました。</p>
<p>yumでインストールしようとしたのですが、これはCentOS 7の標準レポジトリやepelにはありませんでした。
検索してみつけた
<a class="reference external" href="http://linuxsoft.cern.ch/cern/centos/7/cern/x86_64/repoview/libxml-security-c-devel.html">Linux &#64; CERN: /cern/centos/7/cern/x86_64/repoview/libxml-security-c-devel.html</a>
によると CentOS CERN 7 (CC7) という別のディストリビューションには入っているようです。</p>
<p><a class="reference external" href="http://linux.web.cern.ch/linux/centos7/">CC7: CERN CentOS 7</a> を見たところ、CentOS 7用の追加レポジトリというよりは、カスタム版の別ディストリビューションのようなので、これに依存するよりはrpmをリビルドして使うほうが良いと考えてCoprでビルドしました。</p>
<ul class="simple">
<li>xml-security-cの自作rpmのレポジトリ <a class="reference external" href="https://copr.fedorainfracloud.org/coprs/hnakamur/xml-security-c/">hnakamur/xml-security-c Copr</a></li>
<li>xml-security-cの自作rpmのソース <a class="reference external" href="https://github.com/hnakamur/xml-security-c-rpm">hnakamur/xml-security-c-rpm</a></li>
</ul>
</div>
</div>
<div class="section" id="id3">
<h2>インストール手順</h2>
<p>上記の自作rpmに加えて <code>xmltooling-schemas</code> と <code>opensaml-schemas</code> パッケージをインストールするためにShibbolethのレポジトリを追加する必要があります。</p>
<p><a class="reference external" href="https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPLinuxRPMInstall">NativeSPLinuxRPMInstall - Shibboleth 2 - Shibboleth Wiki</a> にrpmのインストール手順が書いてあるのですが、それとは別に
<a class="reference external" href="https://github.com/nginx-shib/shibboleth-fastcgi">nginx-shib/shibboleth-fastcgi</a> レポジトリに
以下のような <a class="reference external" href="https://github.com/nginx-shib/shibboleth-fastcgi/blob/master/configs/centos-7/shibboleth.repo">shibboleth.repo</a> ファイルがあったので、これを使わせてもらうことにしました。</p>
<div class="highlight"><pre><span></span>[shibboleth]
name=Shibboleth (CentOS_7)
# Please report any problems to https://issues.shibboleth.net
type=rpm-md
mirrorlist=https://shibboleth.net/cgi-bin/mirrorlist.cgi/CentOS_7
gpgcheck=1
gpgkey=https://downloadcontent.opensuse.org/repositories/security:/shibboleth/CentOS_7/repodata/repomd.xml.key
enabled=1
</pre></div>
<p>以下のコマンドを実行して必要なレポジトリを追加します。</p>
<div class="highlight"><pre><span></span><span class="go">sudo curl -sSL -o /etc/yum.repos.d/shibboleth.repo https://raw.githubusercontent.com/nginx-shib/shibboleth-fastcgi/master/configs/centos-7/shibboleth.repo</span>
<span class="go">sudo curl -sSL -o /etc/yum.repos.d/hnakamur-nginx-epel-7.repo https://copr.fedorainfracloud.org/coprs/hnakamur/nginx/repo/epel-7/hnakamur-nginx-epel-7.repo</span>
<span class="go">sudo curl -sSL -o /etc/yum.repos.d/hnakamur-xml-security-c-epel-7.repo https://copr.fedorainfracloud.org/coprs/hnakamur/xml-security-c/repo/epel-7/hnakamur-xml-security-c-epel-7.repo</span>
<span class="go">sudo curl -sSL -o /etc/yum.repos.d/hnakamur-shibboleth-epel-7.repo https://copr.fedorainfracloud.org/coprs/hnakamur/shibboleth/repo/epel-7/hnakamur-shibboleth-epel-7.repo</span>
</pre></div>
<p>以下のコマンドを実行して必要なrpmをインストールします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo yum install nginx shibboleth xmltooling-schemas opensaml-schemas</span>
</pre></div>
<p>2018-07-13 追記。
<code>nginx</code> ユーザが <code>/run/shibboleth/shibauthorizer.socket</code> と <code>/run/shibboleth/shibresponder.socket</code> に読み書きできるようにするため、 <code>shibd</code> グループに <code>nginx</code> ユーザを追加します。</p>
<div class="highlight"><pre><span></span><span class="go">sudo usermod -a -G shibd nginx</span>
</pre></div>
</div>
<div class="section" id="id4">
<h2>設定ファイルの編集</h2>
<div class="section" id="shibbolethsp">
<h3>ShibbolethのSP用設定</h3>
<p>ShibbolethのSP用の設定については
<a class="reference external" href="https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPConfiguration">NativeSPConfiguration - Shibboleth 2 - Shibboleth Wiki</a>
にドキュメントがあります。</p>
<p>量が多くて読むのが大変なので、私はまだ必要なところだけを拾い読みしただけの状態です。</p>
<div class="section" id="idpxml">
<h4>IdPのメタデータのXML</h4>
<p>SAMLのメタデータについては
<a class="reference external" href="https://docs.oasis-open.org/security/saml/v2.0/saml-metadata-2.0-os.pdf">Metadata for the OASIS Security Assertion Markup Language (SAML) V2.0</a>
が1次情報のドキュメントのようです（検索して見つけたのでリンク元は不明）。</p>
<p>今回は社内で教えてもらった
<a class="reference external" href="https://www.samltool.com/idp_metadata.php">SAML Identity Provider (IdP) XML Metadata Builder | SAMLTool.com</a>
というオンラインのツールを使いました。</p>
<p>この後は以下の構成例で説明します。</p>
<ul class="simple">
<li>IdPのエンティティID: <a class="reference external" href="https://idp.example.com/sso-test/idp">https://idp.example.com/sso-test/idp</a></li>
<li>HTTPリダイレクト先のシングルサインオンのエンドポイント: <a class="reference external" href="https://idp.example.com/sso-test/idp/sso_redirect">https://idp.example.com/sso-test/idp/sso_redirect</a></li>
<li>署名と暗号化に使う証明書:</li>
</ul>
<div class="highlight"><pre><span></span>-----BEGIN CERTIFICATE-----
MIIxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
…（略）…
xxxxxxxxxxxxxxxxxxxTow==
-----END CERTIFICATE-----
</pre></div>
<p>上記の項目を入力して &quot;BUILD IDP METADATA&quot; ボタンを押すとページの下の方に以下のようなXMLが出力されました。</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;md:EntityDescriptor</span> <span class="na">xmlns:md=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:metadata&quot;</span> <span class="na">validUntil=</span><span class="s">&quot;2018-06-30T08:00:05Z&quot;</span> <span class="na">cacheDuration=</span><span class="s">&quot;PT1530777605S&quot;</span> <span class="na">entityID=</span><span class="s">&quot;https://idp.example.com/sso-test/idp&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;md:IDPSSODescriptor</span> <span class="na">WantAuthnRequestsSigned=</span><span class="s">&quot;false&quot;</span> <span class="na">protocolSupportEnumeration=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;md:KeyDescriptor</span> <span class="na">use=</span><span class="s">&quot;signing&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;ds:KeyInfo</span> <span class="na">xmlns:ds=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ds:X509Data&gt;</span>
          <span class="nt">&lt;ds:X509Certificate&gt;</span>MIIxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx…（略）…xxxxxxxxxxxxxxxxxxxTow==<span class="nt">&lt;/ds:X509Certificate&gt;</span>
        <span class="nt">&lt;/ds:X509Data&gt;</span>
      <span class="nt">&lt;/ds:KeyInfo&gt;</span>
    <span class="nt">&lt;/md:KeyDescriptor&gt;</span>
    <span class="nt">&lt;md:KeyDescriptor</span> <span class="na">use=</span><span class="s">&quot;encryption&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;ds:KeyInfo</span> <span class="na">xmlns:ds=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ds:X509Data&gt;</span>
          <span class="nt">&lt;ds:X509Certificate&gt;</span>MIIxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx…（略）…xxxxxxxxxxxxxxxxxxxTow==<span class="nt">&lt;/ds:X509Certificate&gt;</span>
        <span class="nt">&lt;/ds:X509Data&gt;</span>
      <span class="nt">&lt;/ds:KeyInfo&gt;</span>
    <span class="nt">&lt;/md:KeyDescriptor&gt;</span>
    <span class="nt">&lt;md:NameIDFormat&gt;</span>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified<span class="nt">&lt;/md:NameIDFormat&gt;</span>
    <span class="nt">&lt;md:SingleSignOnService</span> <span class="na">Binding=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&quot;</span> <span class="na">Location=</span><span class="s">&quot;https://idp.example.com/sso-test/idp/sso_redirect&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/md:IDPSSODescriptor&gt;</span>
<span class="nt">&lt;/md:EntityDescriptor&gt;</span>
</pre></div>
<p><code>&lt;ds:X509Certificate&gt;</code> の値は証明書の
<code>-----BEGIN CERTIFICATE-----</code> と
<code>-----END CERTIFICATE-----</code> の間の行が連結されたものになっていました。</p>
<p>ちょっと脱線しますが、これで週末動作確認した後、週明けに再度確認したらエラーが起きるようになってしまいました。これは上記の <code>validUntil</code> の日付を過ぎていたのでこのメタデータが無効として扱われたからとわかりました。</p>
<p><a class="reference external" href="https://docs.oasis-open.org/security/saml/v2.0/saml-metadata-2.0-os.pdf">Metadata for the OASIS Security Assertion Markup Language (SAML) V2.0</a>
によると <code>validUntil</code> と <code>cacheDuration</code> はともに省略可能とのことなので、最終的には省略することにしました。</p>
<p>これを <code>/etc/shibboleth/idp-metadata.xml</code> というファイル名で保存しました。</p>
</div>
<div class="section" id="xml">
<h4>アトリビュートのマッピングのXML</h4>
<p>当初IdPで認証通った後にアトリビュートは何も返さない設定になっていたのですが、認証後のページに以下のようなエラーが表示されたので、 <code>mail</code> という名前でメールアドレスをアトリビュートとして返してもらうように設定してもらいました。</p>
<div class="highlight"><pre><span></span>xmltooling::ValidationException
The system encountered an error at Fri Jun 29 02:08:20 2018

To report this problem, please contact the site administrator at hnakamur@localhost.

Please include the following message in any email:

xmltooling::ValidationException at (http://localhost/Shibboleth.sso/SAML2/POST)

AttributeStatement must have at least one child element.
</pre></div>
<p>その後 <a class="reference external" href="https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPAddAttribute">NativeSPAddAttribute - Shibboleth 2 - Shibboleth Wiki</a> を読みつつ
<code>/etc/shibboleth/attribute-map.xml</code> というファイルを以下のように編集しました。</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;Attributes</span> <span class="na">xmlns=</span><span class="s">&quot;urn:mace:shibboleth:2.0:attribute-map&quot;</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;Attribute</span> <span class="na">name=</span><span class="s">&quot;mail&quot;</span> <span class="na">id=</span><span class="s">&quot;mail&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/Attributes&gt;</span>
</pre></div>
</div>
<div class="section" id="shibbolethxml">
<h4>Shibbolethのメイン設定のXML</h4>
<p>上記のIdPの設定項目の例に加えて、SPの設定項目として以下の例で説明します。</p>
<ul class="simple">
<li>SPの管理者のメールアドレス: <a class="reference external" href="mailto:admin&#64;sp.example.org">admin&#64;sp.example.org</a></li>
<li>SPのエンティティID: <a class="reference external" href="https://sp.example.org/sso">https://sp.example.org/sso</a></li>
</ul>
<p>なお、SPでは証明書を使わない構成とし、SPのエンティティIDをIdPの管理者にお願いして登録してもらいました。</p>
<p><code>/etc/shibboleth/shibboleth2.xml</code> を以下のように変更しました。</p>
<p>下記の変更内容は以下のコマンドで表示しました。</p>
<div class="highlight"><pre><span></span><span class="go">diff -u shibboleth-sp-2.6.1/configs/shibboleth2.xml shibboleth2.xml</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gd">--- shibboleth-sp-2.6.1/configs/shibboleth2.xml        2017-11-14 08:29:46.000000000 +0900</span>
<span class="gi">+++ shibboleth2.xml        2018-07-04 10:12:32.283184405 +0900</span>
<span class="gu">@@ -19,8 +19,19 @@</span>
     file, and the https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPRequestMapHowTo topic.
     --&gt;

<span class="gi">+    &lt;RequestMapper type=&quot;XML&quot;&gt;</span>
<span class="gi">+        &lt;RequestMap&gt;</span>
<span class="gi">+            &lt;Host name=&quot;localhost&quot;</span>
<span class="gi">+                  authType=&quot;shibboleth&quot;</span>
<span class="gi">+                  requireSession=&quot;true&quot;</span>
<span class="gi">+                  redirectToSSL=&quot;443&quot;&gt;</span>
<span class="gi">+                &lt;Path name=&quot;/secure&quot; /&gt;</span>
<span class="gi">+            &lt;/Host&gt;</span>
<span class="gi">+        &lt;/RequestMap&gt;</span>
<span class="gi">+    &lt;/RequestMapper&gt;</span>
<span class="gi">+</span>
     &lt;!-- The ApplicationDefaults element is where most of Shibboleth&#39;s SAML bits are defined. --&gt;
<span class="gd">-    &lt;ApplicationDefaults entityID=&quot;https://sp.example.org/shibboleth&quot;</span>
<span class="gi">+    &lt;ApplicationDefaults entityID=&quot;https://sp.example.org/sso&quot;</span>
                          REMOTE_USER=&quot;eppn persistent-id targeted-id&quot;&gt;

         &lt;!--
<span class="gu">@@ -35,14 +46,7 @@</span>
         &lt;Sessions lifetime=&quot;28800&quot; timeout=&quot;3600&quot; relayState=&quot;ss:mem&quot;
                   checkAddress=&quot;false&quot; handlerSSL=&quot;false&quot; cookieProps=&quot;http&quot;&gt;

<span class="gd">-            &lt;!--</span>
<span class="gd">-            Configures SSO for a default IdP. To allow for &gt;1 IdP, remove</span>
<span class="gd">-            entityID property and adjust discoveryURL to point to discovery service.</span>
<span class="gd">-            (Set discoveryProtocol to &quot;WAYF&quot; for legacy Shibboleth WAYF support.)</span>
<span class="gd">-            You can also override entityID on /Login query string, or in RequestMap/htaccess.</span>
<span class="gd">-            --&gt;</span>
<span class="gd">-            &lt;SSO entityID=&quot;https://idp.example.org/idp/shibboleth&quot;</span>
<span class="gd">-                 discoveryProtocol=&quot;SAMLDS&quot; discoveryURL=&quot;https://ds.example.org/DS/WAYF&quot;&gt;</span>
<span class="gi">+                  &lt;SSO entityID=&quot;https://idp.example.com/sso-test/idp&quot;&gt;</span>
               SAML2 SAML1
             &lt;/SSO&gt;

<span class="gu">@@ -66,53 +70,16 @@</span>
         Allows overriding of error template information/filenames. You can
         also add attributes with values that can be plugged into the templates.
         --&gt;
<span class="gd">-        &lt;Errors supportContact=&quot;root@localhost&quot;</span>
<span class="gi">+        &lt;Errors supportContact=&quot;admin@sp.example.org&quot;</span>
             helpLocation=&quot;/about.html&quot;
             styleSheet=&quot;/shibboleth-sp/main.css&quot;/&gt;
<span class="gd">-</span>
<span class="gd">-        &lt;!-- Example of remotely supplied batch of signed metadata. --&gt;</span>
<span class="gd">-        &lt;!--</span>
<span class="gd">-        &lt;MetadataProvider type=&quot;XML&quot; validate=&quot;true&quot;</span>
<span class="gd">-              uri=&quot;http://example.org/federation-metadata.xml&quot;</span>
<span class="gd">-              backingFilePath=&quot;federation-metadata.xml&quot; reloadInterval=&quot;7200&quot;&gt;</span>
<span class="gd">-            &lt;MetadataFilter type=&quot;RequireValidUntil&quot; maxValidityInterval=&quot;2419200&quot;/&gt;</span>
<span class="gd">-            &lt;MetadataFilter type=&quot;Signature&quot; certificate=&quot;fedsigner.pem&quot;/&gt;</span>
<span class="gd">-            &lt;DiscoveryFilter type=&quot;Blacklist&quot; matcher=&quot;EntityAttributes&quot; trimTags=&quot;true&quot;</span>
<span class="gd">-              attributeName=&quot;http://macedir.org/entity-category&quot;</span>
<span class="gd">-              attributeNameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:uri&quot;</span>
<span class="gd">-              attributeValue=&quot;http://refeds.org/category/hide-from-discovery&quot; /&gt;</span>
<span class="gd">-        &lt;/MetadataProvider&gt;</span>
<span class="gd">-        --&gt;</span>

         &lt;!-- Example of locally maintained metadata. --&gt;
<span class="gd">-        &lt;!--</span>
<span class="gd">-        &lt;MetadataProvider type=&quot;XML&quot; validate=&quot;true&quot; file=&quot;partner-metadata.xml&quot;/&gt;</span>
<span class="gd">-        --&gt;</span>
<span class="gi">+        &lt;MetadataProvider type=&quot;XML&quot; validate=&quot;true&quot; file=&quot;idp-metadata.xml&quot;/&gt;</span>

         &lt;!-- Map to extract attributes from SAML assertions. --&gt;
         &lt;AttributeExtractor type=&quot;XML&quot; validate=&quot;true&quot; reloadChanges=&quot;false&quot; path=&quot;attribute-map.xml&quot;/&gt;
<span class="gd">-</span>
<span class="gd">-        &lt;!-- Use a SAML query if no attributes are supplied during SSO. --&gt;</span>
<span class="gd">-        &lt;AttributeResolver type=&quot;Query&quot; subjectMatch=&quot;true&quot;/&gt;</span>
<span class="gd">-</span>
<span class="gd">-        &lt;!-- Default filtering policy for recognized attributes, lets other data pass. --&gt;</span>
<span class="gd">-        &lt;AttributeFilter type=&quot;XML&quot; validate=&quot;true&quot; path=&quot;attribute-policy.xml&quot;/&gt;</span>

<span class="gd">-        &lt;!-- Simple file-based resolver for using a single keypair. --&gt;</span>
<span class="gd">-        &lt;CredentialResolver type=&quot;File&quot; key=&quot;sp-key.pem&quot; certificate=&quot;sp-cert.pem&quot;/&gt;</span>
<span class="gd">-</span>
<span class="gd">-        &lt;!--</span>
<span class="gd">-        The default settings can be overridden by creating ApplicationOverride elements (see</span>
<span class="gd">-        the https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPApplicationOverride topic).</span>
<span class="gd">-        Resource requests are mapped by web server commands, or the RequestMapper, to an</span>
<span class="gd">-        applicationId setting.</span>
<span class="gd">-</span>
<span class="gd">-        Example of a second application (for a second vhost) that has a different entityID.</span>
<span class="gd">-        Resources on the vhost would map to an applicationId of &quot;admin&quot;:</span>
<span class="gd">-        --&gt;</span>
<span class="gd">-        &lt;!--</span>
<span class="gd">-        &lt;ApplicationOverride id=&quot;admin&quot; entityID=&quot;https://admin.example.org/shibboleth&quot;/&gt;</span>
<span class="gd">-        --&gt;</span>
     &lt;/ApplicationDefaults&gt;

     &lt;!-- Policies that determine how to process and authenticate runtime messages. --&gt;
</pre></div>
<p>変更後の <code>/etc/shibboleth/shibboleth2.xml</code> 全体は以下のとおりです。</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;SPConfig</span> <span class="na">xmlns=</span><span class="s">&quot;urn:mace:shibboleth:2.0:native:sp:config&quot;</span>
    <span class="na">xmlns:conf=</span><span class="s">&quot;urn:mace:shibboleth:2.0:native:sp:config&quot;</span>
    <span class="na">xmlns:saml=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;</span>
    <span class="na">xmlns:samlp=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</span>
    <span class="na">xmlns:md=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:metadata&quot;</span>
    <span class="na">clockSkew=</span><span class="s">&quot;180&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">    By default, in-memory StorageService, ReplayCache, ArtifactMap, and SessionCache</span>
<span class="c">    are used. See example-shibboleth2.xml for samples of explicitly configuring them.</span>
<span class="c">    --&gt;</span>

    <span class="c">&lt;!--</span>
<span class="c">    To customize behavior for specific resources on Apache, and to link vhosts or</span>
<span class="c">    resources to ApplicationOverride settings below, use web server options/commands.</span>
<span class="c">    See https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPConfigurationElements for help.</span>

<span class="c">    For examples with the RequestMap XML syntax instead, see the example-shibboleth2.xml</span>
<span class="c">    file, and the https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPRequestMapHowTo topic.</span>
<span class="c">    --&gt;</span>

    <span class="nt">&lt;RequestMapper</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;RequestMap&gt;</span>
            <span class="nt">&lt;Host</span> <span class="na">name=</span><span class="s">&quot;localhost&quot;</span>
                  <span class="na">authType=</span><span class="s">&quot;shibboleth&quot;</span>
                  <span class="na">requireSession=</span><span class="s">&quot;true&quot;</span>
                  <span class="na">redirectToSSL=</span><span class="s">&quot;443&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;Path</span> <span class="na">name=</span><span class="s">&quot;/secure&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/Host&gt;</span>
        <span class="nt">&lt;/RequestMap&gt;</span>
    <span class="nt">&lt;/RequestMapper&gt;</span>

    <span class="c">&lt;!-- The ApplicationDefaults element is where most of Shibboleth&#39;s SAML bits are defined. --&gt;</span>
    <span class="nt">&lt;ApplicationDefaults</span> <span class="na">entityID=</span><span class="s">&quot;https://sp.example.org/sso&quot;</span>
                         <span class="na">REMOTE_USER=</span><span class="s">&quot;eppn persistent-id targeted-id&quot;</span><span class="nt">&gt;</span>

        <span class="c">&lt;!--</span>
<span class="c">        Controls session lifetimes, address checks, cookie handling, and the protocol handlers.</span>
<span class="c">        You MUST supply an effectively unique handlerURL value for each of your applications.</span>
<span class="c">        The value defaults to /Shibboleth.sso, and should be a relative path, with the SP computing</span>
<span class="c">        a relative value based on the virtual host. Using handlerSSL=&quot;true&quot;, the default, will force</span>
<span class="c">        the protocol to be https. You should also set cookieProps to &quot;https&quot; for SSL-only sites.</span>
<span class="c">        Note that while we default checkAddress to &quot;false&quot;, this has a negative impact on the</span>
<span class="c">        security of your site. Stealing sessions via cookie theft is much easier with this disabled.</span>
<span class="c">        --&gt;</span>
        <span class="nt">&lt;Sessions</span> <span class="na">lifetime=</span><span class="s">&quot;28800&quot;</span> <span class="na">timeout=</span><span class="s">&quot;3600&quot;</span> <span class="na">relayState=</span><span class="s">&quot;ss:mem&quot;</span>
                  <span class="na">checkAddress=</span><span class="s">&quot;false&quot;</span> <span class="na">handlerSSL=</span><span class="s">&quot;false&quot;</span> <span class="na">cookieProps=</span><span class="s">&quot;http&quot;</span><span class="nt">&gt;</span>

                  <span class="nt">&lt;SSO</span> <span class="na">entityID=</span><span class="s">&quot;https://idp.example.com/sso-test/idp&quot;</span><span class="nt">&gt;</span>
              SAML2 SAML1
            <span class="nt">&lt;/SSO&gt;</span>

            <span class="c">&lt;!-- SAML and local-only logout. --&gt;</span>
            <span class="nt">&lt;Logout&gt;</span>SAML2 Local<span class="nt">&lt;/Logout&gt;</span>

            <span class="c">&lt;!-- Extension service that generates &quot;approximate&quot; metadata based on SP configuration. --&gt;</span>
            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&quot;MetadataGenerator&quot;</span> <span class="na">Location=</span><span class="s">&quot;/Metadata&quot;</span> <span class="na">signing=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- Status reporting service. --&gt;</span>
            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&quot;Status&quot;</span> <span class="na">Location=</span><span class="s">&quot;/Status&quot;</span> <span class="na">acl=</span><span class="s">&quot;127.0.0.1 ::1&quot;</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- Session diagnostic service. --&gt;</span>
            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&quot;Session&quot;</span> <span class="na">Location=</span><span class="s">&quot;/Session&quot;</span> <span class="na">showAttributeValues=</span><span class="s">&quot;false&quot;</span><span class="nt">/&gt;</span>

            <span class="c">&lt;!-- JSON feed of discovery information. --&gt;</span>
            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&quot;DiscoveryFeed&quot;</span> <span class="na">Location=</span><span class="s">&quot;/DiscoFeed&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/Sessions&gt;</span>

        <span class="c">&lt;!--</span>
<span class="c">        Allows overriding of error template information/filenames. You can</span>
<span class="c">        also add attributes with values that can be plugged into the templates.</span>
<span class="c">        --&gt;</span>
        <span class="nt">&lt;Errors</span> <span class="na">supportContact=</span><span class="s">&quot;admin@sp.example.org&quot;</span>
            <span class="na">helpLocation=</span><span class="s">&quot;/about.html&quot;</span>
            <span class="na">styleSheet=</span><span class="s">&quot;/shibboleth-sp/main.css&quot;</span><span class="nt">/&gt;</span>

        <span class="c">&lt;!-- Example of locally maintained metadata. --&gt;</span>
        <span class="nt">&lt;MetadataProvider</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">validate=</span><span class="s">&quot;true&quot;</span> <span class="na">file=</span><span class="s">&quot;idp-metadata.xml&quot;</span><span class="nt">/&gt;</span>

        <span class="c">&lt;!-- Map to extract attributes from SAML assertions. --&gt;</span>
        <span class="nt">&lt;AttributeExtractor</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">validate=</span><span class="s">&quot;true&quot;</span> <span class="na">reloadChanges=</span><span class="s">&quot;false&quot;</span> <span class="na">path=</span><span class="s">&quot;attribute-map.xml&quot;</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;/ApplicationDefaults&gt;</span>

    <span class="c">&lt;!-- Policies that determine how to process and authenticate runtime messages. --&gt;</span>
    <span class="nt">&lt;SecurityPolicyProvider</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">validate=</span><span class="s">&quot;true&quot;</span> <span class="na">path=</span><span class="s">&quot;security-policy.xml&quot;</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!-- Low-level configuration about protocols and bindings available for use. --&gt;</span>
    <span class="nt">&lt;ProtocolProvider</span> <span class="na">type=</span><span class="s">&quot;XML&quot;</span> <span class="na">validate=</span><span class="s">&quot;true&quot;</span> <span class="na">reloadChanges=</span><span class="s">&quot;false&quot;</span> <span class="na">path=</span><span class="s">&quot;protocols.xml&quot;</span><span class="nt">/&gt;</span>

<span class="nt">&lt;/SPConfig&gt;</span>
</pre></div>
<p><code>&lt;RequestMapper&gt;</code> の部分は
<a class="reference external" href="https://github.com/nginx-shib/nginx-http-shibboleth/blob/master/CONFIG.rst#configuring-shibboleths-shibboleth2xml-to-recognise-secured-paths">Configuring Shibboleth's shibboleth2.xml to recognise secured paths</a>
の例から <code>&lt;Path name=&quot;/secure2/shibboleth&quot; /&gt;</code> の行を消して、ホスト名を <code>localhost</code> に変更しました。</p>
<p>後述のnginxの設定例では <code>/secure</code> と <code>/secure2</code> という2つのロケーションが出てくるのですが、今回は前者しか使っていないので、後者の設定は消しました。</p>
<p><code>&lt;Host&gt;</code> タグの <code>name</code> 属性のホスト名を <code>localhost</code> にしているのは今回の検証では <code>localhost</code> で試したからで、実際の運用ではSPのホスト名（この記事の例では <code>sp.example.org</code> ）を設定してください。</p>
</div>
</div>
<div class="section" id="nginx">
<h3>nginxの設定</h3>
<p>nginxの自作rpmでは
<a class="reference external" href="https://github.com/nginx-shib/nginx-http-shibboleth">nginx-shib/nginx-http-shibboleth: Shibboleth auth request module for nginx</a>
を動的モジュールとしてビルドしたので、 <code>/etc/nginx/nginx.conf</code> の <code>events</code> の行の前に以下のようにモジュール読み込み設定が必要です。</p>
<div class="highlight"><pre><span></span>load_module modules/ngx_http_shibboleth_module.so;
</pre></div>
<p>nginxのserver設定は
<a class="reference external" href="https://github.com/nginx-shib/nginx-http-shibboleth/blob/master/CONFIG.rst#configure-nginx">Configure Nginx</a>
から <code>location /secure2</code> を除いて <code>server_name</code> を <code>localhost</code> にしたものを使いました。</p>
<p><code>/etc/nginx/conf.d/ssl.conf</code></p>
<div class="highlight"><pre><span></span>server {
    listen 443 ssl;
    server_name localhost;

    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 5m;
    ssl_ciphers AESGCM:HIGH:!EXP:!RC4:!LOW:!aNULL;
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1.2;

    ssl_certificate /etc/pki/tls/certs/localhost.crt;
    ssl_certificate_key /etc/pki/tls/private/localhost.key;

    #FastCGI authorizer for Auth Request module
    location = /shibauthorizer {
        internal;
        include fastcgi_params;
        fastcgi_pass unix:/opt/shibboleth/shibauthorizer.sock;
    }

    #FastCGI responder
    location /Shibboleth.sso {
        include fastcgi_params;
        fastcgi_pass unix:/opt/shibboleth/shibresponder.sock;
    }

    #Resources for the Shibboleth error pages. This can be customised.
    location /shibboleth-sp {
        alias /usr/share/shibboleth/;
    }

    #A secured location.  Here all incoming requests query the
    #FastCGI authorizer.  Watch out for performance issues and spoofing.
    location /secure {
        include shib_clear_headers;
        #Add your attributes here. They get introduced as headers
        #by the FastCGI authorizer so we must prevent spoofing.
        more_clear_input_headers &#39;displayName&#39; &#39;mail&#39; &#39;persistent-id&#39;;
        shib_request /shibauthorizer;
        shib_request_use_headers on;
        proxy_pass http://localhost:8080;
    }
}
</pre></div>
<div class="section" id="https">
<h4>httpsの自己証明書作成</h4>
<p>以下のようにhttpsの自己証明書を生成しました。</p>
<div class="highlight"><pre><span></span><span class="go">openssl req -new -newkey rsa:2048 -sha1 -x509 -nodes \</span>
<span class="go">    -set_serial 1 \</span>
<span class="go">    -days 365 \</span>
<span class="go">    -subj &quot;/C=JP/ST=Osaka/L=Osaka City/CN=localhost&quot; \</span>
<span class="go">    -out /etc/pki/tls/certs/localhost.crt \</span>
<span class="go">    -keyout /etc/pki/tls/private/localhost.key</span>
</pre></div>
</div>
<div class="section" id="upstream">
<h4>upstreamの設定</h4>
<p>上記で <code>proxy_pass</code> で指定している <a class="reference external" href="http://localhost:8080">http://localhost:8080</a> では実運用ではSAML認証した状態で使用するアプリケーションを動かすのですが、今回の検証は以下のような設定でnginxで静的なページを表示するだけにしました。</p>
<p><code>/etc/nginx/conf.d/upstream.conf</code></p>
<div class="highlight"><pre><span></span>server {
    listen       8080;
    server_name  localhost;

    access_log /var/log/nginx/upstream.access.log main;
    root /var/www/html-upstream;
}
</pre></div>
<p>以下のコマンドを実行して <code>/secure</code> のURLパスに対応するファイルを作成しておきます。</p>
<div class="highlight"><pre><span></span><span class="go">mkdir -p /var/www/html-upstream/secure</span>
<span class="go">echo &#39;secure index page&#39; | sudo tee /var/www/html-upstream/secure/index.html</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h2>サーバ再起動</h2>
<p>以上で設定ができたので、以下のコマンドで関連するサーバを再起動します。</p>
<div class="highlight"><pre><span></span><span class="go">systemctl restart shibd</span>
<span class="go">systemctl restart shibauthorizer</span>
<span class="go">systemctl restart shibrsponder</span>
<span class="go">systemctl restart nginx</span>
</pre></div>
</div>
<div class="section" id="id6">
<h2>動作確認</h2>
<p>これでブラウザで <code>https://localhost/secure</code> にアクセスします。
自己証明書なので警告が出ますが無視して進むと
<code>https://idp.example.com/sso-test/idp/sso_redirect?SAMLRequest=xxx…(略)…&amp;RelayState=…(略)…</code> といったURLにリダイレクトされます。</p>
<div class="section" id="samlrequest">
<h3>SAMLRequestの確認</h3>
<p>ChromeのURL欄からコピーしたSAMLRequestの値は以下のようにしてデコードできました。</p>
<div class="highlight"><pre><span></span><span class="go">python3 -c &#39;import sys, urllib.parse as ul, base64, zlib; print(zlib.decompress(base64.b64decode(ul.unquote_plus(sys.argv[1])), -15).decode(&quot;utf-8&quot;))&#39; &#39;ブラウザのURL欄からコピーしたSAMLRequestの値&#39;</span>
</pre></div>
<p>上記のコードはURLデコードを行ってから下記の <a class="reference external" href="https://github.com/onelogin/python-saml/blob/e2da620897fb78eb2095abe4f37bde87832c7d1d/src/onelogin/saml2/utils.py#L92-L113">python-saml/utils.py</a> の <code>decode_base64_and_inflate</code> の処理を行うようにしたものです。</p>
<div class="highlight"><pre><span></span><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">decode_base64_and_inflate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    base64 decodes and then inflates according to RFC1951</span>
<span class="sd">    :param value: a deflated and encoded string</span>
<span class="sd">    :type value: string</span>
<span class="sd">    :returns: the string after decoding and inflating</span>
<span class="sd">    :rtype: string</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">deflate_and_base64_encode</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deflates and then base64 encodes a string</span>
<span class="sd">    :param value: The string to deflate and encode</span>
<span class="sd">    :type value: string</span>
<span class="sd">    :returns: The deflated and encoded string</span>
<span class="sd">    :rtype: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
<p>デコードした結果の例を以下に示します（なお、実際はIdPとSPのエンティティIDとURLはこの記事と違う値で動作確認していて、以下に貼っているのはデコードした後それらの値を置換しています）。</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;samlp:AuthnRequest</span> <span class="na">xmlns:samlp=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</span> <span class="na">AssertionConsumerServiceURL=</span><span class="s">&quot;https://localhost/Shibboleth.sso/SAML2/POST&quot;</span> <span class="na">Destination=</span><span class="s">&quot;https://idp.example.com/sso-test/idp/sso_redirect&quot;</span> <span class="na">ID=</span><span class="s">&quot;_fbd5e55b3590bf5c947ce2dd3d9f0053&quot;</span> <span class="na">IssueInstant=</span><span class="s">&quot;2018-07-04T01:53:41Z&quot;</span> <span class="na">ProtocolBinding=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&quot;</span> <span class="na">Version=</span><span class="s">&quot;2.0&quot;</span><span class="nt">&gt;&lt;saml:Issuer</span> <span class="na">xmlns:saml=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;</span><span class="nt">&gt;</span>https://sp.example.org/sso<span class="nt">&lt;/saml:Issuer&gt;&lt;samlp:NameIDPolicy</span> <span class="na">AllowCreate=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;&lt;/samlp:AuthnRequest&gt;</span>
</pre></div>
</div>
<div class="section" id="samlresponse">
<h3>SAMLResponseの確認</h3>
<p>今回検証したIdPでは二段階認証を行うようになっています。Chromeの開発ツールを開いた状態で二段階目の入力を行うと <code>https://localhost/Shibboleth.sso/SAML2/POST</code> にPOSTでリクエストを送っていて FormData に <code>SAMLResponse</code> と <code>RelayState</code> という項目が含まれていました。</p>
<p>SAMLResponseは以下のようにしてBase64デコードすればXMLを確認できました。</p>
<div class="highlight"><pre><span></span><span class="go">echo &#39;ブラウザからコピーしたSAMLResponseの値&#39; | base64 --decode</span>
</pre></div>
<p>デコードしたXMLを機密情報を伏せた上で以下に示します。</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;samlp:Response</span> <span class="na">xmlns:samlp=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;</span> <span class="na">xmlns:saml=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;</span> <span class="na">ID=</span><span class="s">&quot;_EXAMPLE_SSO_f1756be7-771c-4330-9bd2-568501fdc194&quot;</span> <span class="na">Version=</span><span class="s">&quot;2.0&quot;</span> <span class="na">IssueInstant=</span><span class="s">&quot;2018-07-04T03:22:14Z&quot;</span> <span class="na">Destination=</span><span class="s">&quot;https://localhost/Shibboleth.sso/SAML2/POST&quot;</span> <span class="na">InResponseTo=</span><span class="s">&quot;_fbd5e55b3590bf5c947ce2dd3d9f0053&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;saml:Issuer&gt;</span>https://idp.example.com/sso-test/idp<span class="nt">&lt;/saml:Issuer&gt;</span>
  <span class="nt">&lt;ds:Signature</span> <span class="na">xmlns:ds=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ds:SignedInfo&gt;</span>
      <span class="nt">&lt;ds:CanonicalizationMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;ds:SignatureMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;ds:Reference</span> <span class="na">URI=</span><span class="s">&quot;#_EXAMPLE_SSO_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ds:Transforms&gt;</span>
          <span class="nt">&lt;ds:Transform</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;</span><span class="nt">/&gt;</span>
          <span class="nt">&lt;ds:Transform</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/ds:Transforms&gt;</span>
        <span class="nt">&lt;ds:DigestMethod</span> <span class="na">Algorithm=</span><span class="s">&quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;ds:DigestValue&gt;</span>xxxxxxxxxxxxxxxxxxxxxxxxxxx=<span class="nt">&lt;/ds:DigestValue&gt;</span>
      <span class="nt">&lt;/ds:Reference&gt;</span>
    <span class="nt">&lt;/ds:SignedInfo&gt;</span>
    <span class="nt">&lt;ds:SignatureValue&gt;</span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxx…(略)…xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxx==<span class="nt">&lt;/ds:SignatureValue&gt;</span>
    <span class="nt">&lt;ds:KeyInfo&gt;</span>
      <span class="nt">&lt;ds:X509Data&gt;</span>



      <span class="nt">&lt;ds:X509Certificate&gt;</span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxx…(略)…xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxx==<span class="nt">&lt;/ds:X509Certificate&gt;</span>
<span class="nt">&lt;ds:X509SubjectName&gt;</span>CN=localhost:5000,OU=sso-test,O=xxxxxxxxxxxxxxxxxxxx,L=Osaka,ST=Osaka,C=JP<span class="nt">&lt;/ds:X509SubjectName&gt;</span>
<span class="nt">&lt;ds:X509IssuerSerial&gt;</span>
<span class="nt">&lt;ds:X509IssuerName&gt;</span>CN=localhost:5000,OU=sso-test,O=xxxxxxxxxxxxxxxxxxxx,L=Osaka,ST=Osaka,C=JP<span class="nt">&lt;/ds:X509IssuerName&gt;</span>
<span class="nt">&lt;ds:X509SerialNumber&gt;</span>99999999999999999999<span class="nt">&lt;/ds:X509SerialNumber&gt;</span>
<span class="nt">&lt;/ds:X509IssuerSerial&gt;</span>
<span class="nt">&lt;/ds:X509Data&gt;</span>
    <span class="nt">&lt;/ds:KeyInfo&gt;</span>
  <span class="nt">&lt;/ds:Signature&gt;</span>
  <span class="nt">&lt;samlp:Status&gt;</span>
    <span class="nt">&lt;samlp:StatusCode</span> <span class="na">Value=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/samlp:Status&gt;</span>
  <span class="nt">&lt;saml:Assertion</span> <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="na">xmlns:xs=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> <span class="na">ID=</span><span class="s">&quot;_a_fbd5e55b3590bf5c947ce2dd3d9f0053&quot;</span> <span class="na">Version=</span><span class="s">&quot;2.0&quot;</span> <span class="na">IssueInstant=</span><span class="s">&quot;2018-07-04T03:22:14Z&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;saml:Issuer&gt;</span>https://idp.example.com/sso-test/idp<span class="nt">&lt;/saml:Issuer&gt;</span>
    <span class="nt">&lt;saml:Subject&gt;</span>
      <span class="nt">&lt;saml:NameID</span> <span class="na">Format=</span><span class="s">&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:persistent&quot;</span> <span class="na">NameQualifier=</span><span class="s">&quot;idp.example.com&quot;</span> <span class="na">SPNameQualifier=</span><span class="s">&quot;https://sp.example.org/sso&quot;</span><span class="nt">&gt;</span>user1<span class="nt">&lt;/saml:NameID&gt;</span>
      <span class="nt">&lt;saml:SubjectConfirmation</span> <span class="na">Method=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;saml:SubjectConfirmationData</span> <span class="na">InResponseTo=</span><span class="s">&quot;_fbd5e55b3590bf5c947ce2dd3d9f0053&quot;</span> <span class="na">NotOnOrAfter=</span><span class="s">&quot;2018-07-04T03:27:14Z&quot;</span> <span class="na">Recipient=</span><span class="s">&quot;https://localhost/Shibboleth.sso/SAML2/POST&quot;</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/saml:SubjectConfirmation&gt;</span>
    <span class="nt">&lt;/saml:Subject&gt;</span>
    <span class="nt">&lt;saml:Conditions</span> <span class="na">NotBefore=</span><span class="s">&quot;2018-07-04T03:17:14Z&quot;</span> <span class="na">NotOnOrAfter=</span><span class="s">&quot;2018-07-04T03:27:14Z&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;saml:AudienceRestriction&gt;</span>
        <span class="nt">&lt;saml:Audience&gt;</span>https://sp.example.org/sso<span class="nt">&lt;/saml:Audience&gt;</span>
      <span class="nt">&lt;/saml:AudienceRestriction&gt;</span>
    <span class="nt">&lt;/saml:Conditions&gt;</span>
    <span class="nt">&lt;saml:AuthnStatement</span> <span class="na">AuthnInstant=</span><span class="s">&quot;2018-07-04T03:22:14Z&quot;</span> <span class="na">SessionNotOnOrAfter=</span><span class="s">&quot;2018-07-04T04:22:14Z&quot;</span> <span class="na">SessionIndex=</span><span class="s">&quot;_s_fbd5e55b3590bf5c947ce2dd3d9f0053&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;saml:AuthnContext&gt;</span>
        <span class="nt">&lt;saml:AuthnContextClassRef&gt;</span>urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport<span class="nt">&lt;/saml:AuthnContextClassRef&gt;</span>
      <span class="nt">&lt;/saml:AuthnContext&gt;</span>
    <span class="nt">&lt;/saml:AuthnStatement&gt;</span>
    <span class="nt">&lt;saml:AttributeStatement&gt;</span>

      <span class="nt">&lt;saml:Attribute</span> <span class="na">Name=</span><span class="s">&quot;mail&quot;</span> <span class="na">NameFormat=</span><span class="s">&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;saml:AttributeValue</span> <span class="na">xsi:type=</span><span class="s">&quot;xs:anyType&quot;</span><span class="nt">&gt;</span>user1@example.net<span class="nt">&lt;/saml:AttributeValue&gt;</span>
      <span class="nt">&lt;/saml:Attribute&gt;</span>

    <span class="nt">&lt;/saml:AttributeStatement&gt;</span>
  <span class="nt">&lt;/saml:Assertion&gt;</span>
<span class="nt">&lt;/samlp:Response&gt;</span>
</pre></div>
<p><code>&lt;saml:Subject&gt;</code> の <code>&lt;saml:NameID&gt;</code> の値 <code>user1</code> がログインしたときのユーザIDです。
<code>AttributeStatement</code> の中に <code>&lt;saml:Attribute Name=&quot;mail&quot;&gt;</code> というタグがあり、その子供の <code>&lt;saml:AttributeValue&gt;</code> の値にログインユーザのメールアドレス <code>user1&#64;example.net</code> が入っています。</p>
<p>また <code>https://localhost/Shibboleth.sso/SAML2/POST</code> のレスポンスヘッダには以下のような <code>Set-Cookie</code> ヘッダが含まれていました。</p>
<div class="highlight"><pre><span></span>Set-Cookie: _shibsession_64656661756c7468747470733a2f2f61706930312e6465762e776562616363656c2e6a702f61646d696e2f73736f=_d43354cfc784c22b046e22bf1c1d176f; path=/; HttpOnly
</pre></div>
<p>この後 <code>https://localhost/secure</code> →  <code>https://localhost/secure/</code> とリダイレクトされて、上記で作成した /var/www/html-upstream/secure/index.html の内容である「secure index page」が無事表示されました。</p>
</div>
<div class="section" id="id7">
<h3>認証後にバックエンドに送られるリクエストヘッダ</h3>
<p>また、ポート8080で動かしているバックエンド（に見立てたnginx）へのリクエストヘッダに何が来るのかを確認するため、以下のコマンドを動かした状態で認証を実行しました（ヘッダ名がわかっていればnginxの設定を変えてログ出力すればよいのですが、どういうヘッダが来るかがわからないのでtcpdumpを使いました）。</p>
<div class="highlight"><pre><span></span><span class="go">tcpdump -X -i lo port 8080</span>
</pre></div>
<div class="highlight"><pre><span></span>…(略)…
06:41:20.135840 IP localhost.48704 &gt; localhost.webcache: Flags [P.], seq 1:1338, ack 1, win 342, options [nop,nop,TS val 763708778 ecr 763708778], length 1337: HTTP: GET /secure/ HTTP/1.0
        0x0000:  4500 056d 2757 4000 4006 1032 7f00 0001  E..m&#39;W@.@..2....
        0x0010:  7f00 0001 be40 1f90 71ea bb02 c998 0fbf  .....@..q.......
        0x0020:  8018 0156 0362 0000 0101 080a 2d85 456a  ...V.b......-.Ej
        0x0030:  2d85 456a 4745 5420 2f73 6563 7572 652f  -.EjGET./secure/
        0x0040:  2048 5454 502f 312e 300d 0a48 6f73 743a  .HTTP/1.0..Host:
        0x0050:  2031 3237 2e30 2e30 2e31 3a38 3038 300d  .127.0.0.1:8080.
        0x0060:  0a43 6f6e 6e65 6374 696f 6e3a 2063 6c6f  .Connection:.clo
…(略)…
</pre></div>
<p>Shibboleth関連のリクエストヘッダを抜き出して整形したものを以下に示します（日時が前後しているのは上で書いたのより前に動作確認したときのログをコピペしているためです）。</p>
<div class="highlight"><pre><span></span>Cookie: _shibsession_64656661756c7468747470733a2f2f61706930312e6465762e776562616363656c2e6a702f61646d696e2f73736f=_d43354cfc784c22b046e22bf1c1d176f
AUTH_TYPE: shibboleth
Shib-Application-ID: default
Shib-Authentication-Instant: 2018-06-29T06:41:19Z
Shib-Authentication-Method: urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
Shib-AuthnContext-Class: urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
Shib-Handler: http://localhost/Shibboleth.sso
Shib-Identity-Provider: https://idp.example.com/sso-test/idp
Shib-Session-ID: _d43354cfc784c22b046e22bf1c1d176f
Shib-Session-Index: _s_f5f10d110e4c22f0514443f82971c730
mail: user1@example.net
</pre></div>
<p>上記の <code>Set-Cookie</code> で設定されたクッキーのと同じ値が <code>Shib-Session-ID</code> というリクエストヘッダに付与されています。
また、 <code>mail</code> というリクエストヘッダにログインユーザのメールアドレスが設定されています。</p>
<p>上記のnginxの設定の <code>location /secure</code> で <code>include shib_clear_headers;</code> と指定して読み込んでいる <code>/etc/nginx/shib_clear_headers</code> を確認すると以下のようになっていました（コメントは省略）。</p>
<div class="highlight"><pre><span></span>more_clear_input_headers
    Auth-Type
    Shib-Application-Id
    Shib-Authentication-Instant
    Shib-Authentication-Method
    Shib-Authncontext-Class
    Shib-Identity-Provider
    Shib-Session-Id
    Shib-Session-Index
    Remote-User;
</pre></div>
<p>ということで攻撃の意図を持ってリクエスト時にこれらのリクエストヘッダを指定して上書きしようとしても、一旦クリアしてから Shibboleth が設定するので問題ないです。</p>
<p><code>mail</code> のリクエストヘッダについても以下の行で一旦クリアしているのでこちらも問題ないです。</p>
<div class="highlight"><pre><span></span>more_clear_input_headers &#39;displayName&#39; &#39;mail&#39; &#39;persistent-id&#39;;
</pre></div>
</div>
<div class="section" id="id8">
<h3>ログアウトの動作確認</h3>
<p>今回検証した構成ではIdPにログアウト用のエンドポイント(URL)は無いので、
_shibsession_xxxx
のクッキーを削除することでログアウトとするということにします。</p>
<p>もしこのクッキー名に紐付けてバックエンドのサーバサイドでセッションデータを保持する場合は、そちらの削除も行うようにします。</p>
<p>今回はChromeでクッキーの削除を行いました。</p>
<p>「設定」→「詳細設定」→「コンテンツの設定」→「Cookie」→「すべての Cookie とサイトデータを表示」と進み、「Cookieを検索」の入力欄に「localhost」と入力して絞り込んで、クッキーを削除します。</p>
<p>本来は _shibsession_xxxx のクッキーだけを削除したかったのですが、クッキーの名前が長すぎて削除の☓ボタンが枠内に表示されず押せないため、「localhost」のクッキー全てをまとめて消すことで回避しました。</p>
<p>何度も消す場合は「すべての Cookie とサイトデータ」のページを開いたままにしておいて、再度ログインした後に「すべての Cookie とサイトデータ」の左の「←」をクリックして「Cookie」のページに戻り、再度「すべての Cookie とサイトデータを表示」を押して「すべての Cookie とサイトデータ」に戻ると「localhost」でのフィルタリングが維持されているので、あとは消すだけでOKでした。</p>
<p>システム化する場合は例えば
<a class="reference external" href="https://github.com/openresty/lua-nginx-module">openresty/lua-nginx-module</a>
と
<a class="reference external" href="https://github.com/cloudflare/lua-resty-cookie">cloudflare/lua-resty-cookie</a>
を使って、以下のようなコードを書けば良いです。</p>
<div class="highlight"><pre><span></span>lua_package_path &quot;/usr/lib/nginx/lua/?.lua;;&quot;;

server {
    …(略)…

    location /signout {
        content_by_lua_block {
            ngx.header.content_type = &#39;text/plain&#39;;

            local ck = require &quot;resty.cookie&quot;
            local cookie, err = ck:new()
            if not cookie then
                ngx.log(ngx.ERR, err)
                return
            end
            local fields, err = cookie:get_all()
            if fields then
                local prefix = &quot;_shibsession_&quot;
                for k, v in pairs(fields) do
                    if string.sub(k, 1, #prefix) == prefix then
                        local ok, err = cookie:set({
                            key = k, value = &quot;&quot;, path = &quot;/&quot;, httponly = true,
                            expires = &quot;Thu Jan 01 1970 00:00:00 GMT&quot;
                        })
                        if not ok then
                            ngx.log(ngx.ERR, err)
                            return
                        end
                    end
                end
            else
                if err ~= &quot;no cookie found in the current request&quot; then
                    ngx.log(ngx.ERR, err)
                    return
                end
            end

            ngx.redirect(&#39;/&#39;)
        }
    }

    …(略)…
}
</pre></div>
<p>私のnginxのrpmでは <code>/usr/lib/nginx/lua/resty/cookie.lua</code> というパスに lua-resty-cookie のluaファイルを置いているので <code>lua_package_path &quot;/usr/lib/nginx/lua/?.lua;;&quot;;</code> と <code>require &quot;resty.cookie&quot;</code> でアクセスできます。</p>
<p>この例では名前が <code>_shibsession_</code> で始まるクッキーの有効期限を過去の日付にしてブラウザがクッキーを削除するようにしています。</p>
<p>既にサインアウト済みの場合とサインアウトした後に <code>/</code> にリダイレクトするようにしています。</p>
</div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>