<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Ubuntu 17.10でL2TPのVPN接続を試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/03/31/l2tp-vpn-on-ubuntu-17.10/" rel="bookmark"
           title="Permalink to Ubuntu 17.10でL2TPのVPN接続を試してみた">Ubuntu 17.10でL2TPのVPN接続を試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-03-31T08:40:00+09:00">
                Published: 2018-03-31
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/ubuntu.html">ubuntu</a> <a href="../../../../tag/l2tp.html">l2tp</a> <a href="../../../../tag/vpn.html">vpn</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>Ubuntu 17.10でL2TPのVPN接続を試してみたのでメモです。
以下の手順の一部は接続先の設定に依存して変動がありえます。</p>
</div>
<div class="section" id="id2">
<h2>セットアップ</h2>
<div class="section" id="id3">
<h3>必要なソフトウェアをインストール</h3>
<p>network-manager-l2tp-gnomeをインストール。依存関係でnetwork-manager-l2tpやxl2tpdも入ります。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt install -y network-manager-l2tp-gnome</span>
</pre></div>
<p>xl2tpdはVPN接続するときに起動されるのでOS起動時に起動しないようにしておきます。</p>
<div class="highlight"><pre><span></span><span class="go">sudo systemctl stop xl2tpd</span>
<span class="go">sudo systemctl disable xl2tpd</span>
</pre></div>
</div>
<div class="section" id="vpn">
<h3>VPN設定を追加</h3>
<ol class="arabic simple">
<li>「設定」→「ネットワーク」→「VPN」の右上の「＋」ボタンを押します。</li>
</ol>
<img alt="start adding vpn" src="../../../../2018/03/31/l2tp-vpn-on-ubuntu-17.10/start-adding-vpn.png" style="width: 490px; height: 355px;" />
<ol class="arabic simple" start="2">
<li>「VPNの追加」ダイアログで「Layer 2 Tunneling Protocol (L2TP)」を選択します。</li>
</ol>
<img alt="select l2tp" src="../../../../2018/03/31/l2tp-vpn-on-ubuntu-17.10/select-l2tp-protocol.png" style="width: 500px; height: 341px;" />
<ol class="arabic simple" start="3">
<li>「VPNの追加」ダイアログの「Identity」タブの項目設定<ul>
<li>名前: (任意)</li>
<li>ゲートウェイ: 接続先のホスト名</li>
<li>ユーザー名: 接続に必要なユーザ名</li>
<li>パスワード: 空のまま</li>
</ul>
</li>
</ol>
<img alt="vpn identity" src="../../../../2018/03/31/l2tp-vpn-on-ubuntu-17.10/vpn-identity.png" style="width: 556px; height: 409px;" />
<ol class="arabic simple" start="4">
<li>「VPNの追加」ダイアログの「IPSec Settings」ボタンを押して以下の項目を設定。<ul>
<li>「Enable IPsec tunnel to L2TP host」チェックボックスをオン。</li>
<li>Pre-shared keyに接続先で設定されている事前共有キーの値を設定。</li>
<li>「Advanced」を展開して「Phase1 Algorithms」に aes256-sha1-modp1536 と設定。アルゴリズムの設定値の調べ方については後述。</li>
</ul>
</li>
</ol>
<img alt="ipsec options" src="../../../../2018/03/31/l2tp-vpn-on-ubuntu-17.10/ipsec-options.png" style="width: 364px; height: 333px;" />
<ol class="arabic simple" start="5">
<li>「VPNの追加」ダイアログの「PPP Settings」ボタンを押して以下の項目を設定。<ol class="arabic">
<li>「MPPE暗号を使用する」チェックボックスをオン。</li>
<li>認証方式の「MSCHAP」と「MSCHAPｖ２」の2つのみがチェックされた状態になるので「MSCHAP」のチェックを外す。</li>
<li>「PPP Echoパケットを送信する」チェックボックスをオン（これは絶対に必要かは不明ですが試行錯誤した感じではオンにしたほうが良さそうな感じ）。</li>
</ol>
</li>
</ol>
<p>2018-05-06追記。その後他の環境やUbuntu 18.04でもVPN接続の設定を試した感じでは「PPP Echoパケットを送信する」は不要なようでした。</p>
<img alt="ppp options" src="../../../../2018/03/31/l2tp-vpn-on-ubuntu-17.10/ppp-options.png" style="width: 401px; height: 669px;" />
<ol class="arabic simple" start="6">
<li>Ubuntuを再起動。<ul>
<li>再起動は不要かもしれませんが、何回か試行錯誤したときの挙動にばらつきがあったので、確実にするために再起動しておきます。</li>
</ul>
</li>
</ol>
</div>
</div>
<div class="section" id="id4">
<h2>VPN接続の手順</h2>
<ol class="arabic simple">
<li>パスワードマネージャ KeePassX で接続先の自分のユーザー名に対応するパスワードをコピーします。</li>
<li>デスクトップ右上のWifiのアイコンをクリックし、「VPNオフ」メニューを展開して「接続」のメニューを選択。</li>
</ol>
<img alt="start connecting" src="../../../../2018/03/31/l2tp-vpn-on-ubuntu-17.10/start-connecting.png" style="width: 387px; height: 462px;" />
<ol class="arabic simple" start="3">
<li>パスワードダイアログがモーダルで表示されるのでコピーしておいたパスワードをペースト。</li>
</ol>
<p>接続中</p>
<img alt="connecting" src="../../../../2018/03/31/l2tp-vpn-on-ubuntu-17.10/connecting.png" style="width: 456px; height: 80px;" />
<p>接続完了</p>
<img alt="connected" src="../../../../2018/03/31/l2tp-vpn-on-ubuntu-17.10/connected.png" style="width: 405px; height: 84px;" />
</div>
<div class="section" id="id5">
<h2>VPN切断の手順</h2>
<ol class="arabic simple">
<li>デスクトップ右上のVPNのアイコンをクリックし、上記設定で追加したVPN名のメニューを展開して「オフにする」メニューを選択。</li>
</ol>
<img alt="start disconnecting" src="../../../../2018/03/31/l2tp-vpn-on-ubuntu-17.10/start-disconnecting.png" style="width: 366px; height: 469px;" />
<ol class="arabic simple" start="2">
<li>デスクトップ右上のVPN接続のアイコンが消えたら切断完了ですが、ウェブブラウザでインターネットのどこかのサイトを開いてアクセスできない場合Wifiを一旦オフにしてからオンにします。</li>
</ol>
<p>2018-05-06追記。Wifiを一旦オフにしてからオンにするよりはマシな回避策を見つけました。 <a class="reference external" href="/blog/2018/05/06/workaround-to-get-dns-working-after-vpn-disconnection-on-ubuntu-18.04/">Ubuntu 18.04でVPN切断後にホスト名解決が動くようにするための回避策</a></p>
</div>
<div class="section" id="id6">
<h2>デバッグ</h2>
<div class="section" id="id7">
<h3>接続のデバッグ</h3>
<p>接続がうまく行かないときは
<a class="reference external" href="https://github.com/nm-l2tp/network-manager-l2tp#debian-and-ubuntu">network-manager-l2tpのDebuggingのDebian and Ubuntuの手順</a>
でデバッグします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo killall -TERM nm-l2tp-service</span>
<span class="go">sudo /usr/lib/NetworkManager/nm-l2tp-service --debug</span>
</pre></div>
<p>例えば上記の「PPP Echoパケットを送信する」チェックボックスをオンにしていなかったときは以下のようなエラーが出ていました。</p>
<div class="highlight"><pre><span></span>xl2tpd[3698]: control_finish: sending ICRQ
xl2tpd[3698]: check_control: Received out of order control packet on tunnel 61298 (got 0, expected 1)
xl2tpd[3698]: handle_packet: bad control packet!
xl2tpd[3698]: network_thread: bad packet
</pre></div>
<p>2018-05-06追記。接続のデバッグは上記の手順以外に、以下のコマンドでjournaldのログを見るのでも十分でした。</p>
<div class="highlight"><pre><span></span><span class="go">journalctl -f</span>
</pre></div>
</div>
<div class="section" id="ipsec">
<h3>IPsecのアルゴリズムのスキャン</h3>
<p>IPsec Optionsダイアログに設定したAlgorithmは以下のようにして検出しました。</p>
<ol class="arabic simple">
<li>ike-scan パッケージをインストール</li>
</ol>
<div class="highlight"><pre><span></span><span class="go">sudo apt install -y ike-scan</span>
</pre></div>
<ol class="arabic" start="2">
<li><p class="first">検出用スクリプトを作成</p>
<p><a class="reference external" href="https://github.com/nm-l2tp/network-manager-l2tp/wiki/Known-Issues#querying-vpn-server-for-its-ikev1-algorithm-proposals">https://github.com/nm-l2tp/network-manager-l2tp/wiki/Known-Issues#querying-vpn-server-for-its-ikev1-algorithm-proposals</a></p>
<p>以下のスクリプトを ike-scan.sh という名前で保存。</p>
</li>
</ol>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="c1"># Encryption algorithms: 3des=5, aes128=7/128, aes192=7/192, aes256=7/256</span>
<span class="nv">ENCLIST</span><span class="o">=</span><span class="s2">&quot;5 7/128 7/192 7/256&quot;</span>
<span class="c1"># Hash algorithms: md5=1, sha1=2, sha256=5, sha384=6, sha512=7</span>
<span class="nv">HASHLIST</span><span class="o">=</span><span class="s2">&quot;1 2 5 6 7&quot;</span>
<span class="c1"># Diffie-Hellman groups: 1, 2, 5, 14, 15, 19, 20, 21</span>
<span class="nv">GROUPLIST</span><span class="o">=</span><span class="s2">&quot;1 2 5 14 15 19 20 21&quot;</span>
<span class="c1"># Authentication method: Preshared Key=1</span>
<span class="nv">AUTH</span><span class="o">=</span><span class="m">1</span>

<span class="k">for</span> ENC in <span class="nv">$ENCLIST</span><span class="p">;</span> <span class="k">do</span>
   <span class="k">for</span> HASH in <span class="nv">$HASHLIST</span><span class="p">;</span> <span class="k">do</span>
       <span class="k">for</span> GROUP in <span class="nv">$GROUPLIST</span><span class="p">;</span> <span class="k">do</span>
          <span class="nb">echo</span> ike-scan --trans<span class="o">=</span><span class="nv">$ENC</span>,<span class="nv">$HASH</span>,<span class="nv">$AUTH</span>,<span class="nv">$GROUP</span> -M <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
          ike-scan --trans<span class="o">=</span><span class="nv">$ENC</span>,<span class="nv">$HASH</span>,<span class="nv">$AUTH</span>,<span class="nv">$GROUP</span> -M <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
      <span class="k">done</span>
   <span class="k">done</span>
<span class="k">done</span>
</pre></div>
<ol class="arabic simple" start="3">
<li>実行パーミションを付与。</li>
</ol>
<div class="highlight"><pre><span></span><span class="go">chmod +x ike-scan.sh</span>
</pre></div>
<p>LT2Pの接続先を引数に指定して実行し、利用可能なアルゴリズム一覧を表示。下記の「接続先のホスト」は実際のホスト名に置き換えてください。</p>
<div class="highlight"><pre><span></span><span class="go">./ike-scan.sh 接続先のホスト | grep &#39;SA=&#39;</span>
</pre></div>
<p>実行例は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ./scan-vpn-algo 接続先のホスト <span class="p">|</span> grep <span class="s1">&#39;SA=&#39;</span>
<span class="go">        SA=(Enc=3DES Hash=SHA1 Auth=PSK Group=2:modp1024 LifeType=Seconds LifeDuration(4)=0x00007080)</span>
<span class="go">        SA=(Enc=3DES Hash=SHA1 Auth=PSK Group=5:modp1536 LifeType=Seconds LifeDuration(4)=0x00007080)</span>
<span class="go">        SA=(Enc=AES Hash=SHA1 Auth=PSK Group=2:modp1024 KeyLength=256 LifeType=Seconds LifeDuration(4)=0x00007080)</span>
<span class="go">        SA=(Enc=AES Hash=SHA1 Auth=PSK Group=5:modp1536 KeyLength=256 LifeType=Seconds LifeDuration(4)=0x00007080)</span>
</pre></div>
<p>上記の内容をIPsec Optionsにフルで指定する場合は以下のように書くことになります。</p>
<ul class="simple">
<li>Phase1 Algorithms: aes256-sha1-modp1536,aes256-sha1-modp1024</li>
<li>Phase2 Algorithms: 3des-sha1-modp1536,3des-sha1-modp1024</li>
</ul>
<p>ですが、わざわざ弱いアルゴリズムを指定する必要もないので、上記では一番強い aes256-sha1-modp1536 のみを指定する手順としました。</p>
</div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>