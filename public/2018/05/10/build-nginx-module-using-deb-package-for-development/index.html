<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>debパッケージを使って開発用にnginxモジュールをビルド・デバッグする</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/05/10/build-nginx-module-using-deb-package-for-development/" rel="bookmark"
           title="Permalink to debパッケージを使って開発用にnginxモジュールをビルド・デバッグする">debパッケージを使って開発用にnginxモジュールをビルド・デバッグする</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-05-10T09:25:00+09:00">
                Published: 2018-05-10
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/deb.html">deb</a> <a href="../../../../tag/nginx.html">nginx</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>私は <a class="reference external" href="https://hnakamur.github.io/blog/2018/04/05/building-my-custom-nginx-rpm-and-deb/">私のnginxのカスタムrpmとdebをビルドする手順</a> でサードパーティモジュールを含んだnginxのパッケージをビルドしています。</p>
<p>このパッケージに自作モジュールを追加して開発するためのビルド手順を考えてみたのでメモです。</p>
<p>普通にソースのtarballを展開してconfigure, make, make installでも良いのですが、本番運用時はdebパッケージを使うので同じ構成のほうが良いというのとnginx-dbgというデバッグシンボルパッケージも作ってくれるのでこれも活用したいということで、以下の手順にしてみました。</p>
<p>例として <a class="reference external" href="http://cubicdaiya.github.io/blog/ja/blog/2013/01/08/nginx1/">nginx moduleをつくろう その1〜Hello, World〜 - bokko bokkoにしてやんよ</a> の <a class="reference external" href="https://github.com/cubicdaiya/ngx_http_hello_world">cubicdaiya/ngx_http_hello_world: Hello, World with nginx</a> を使わせて頂きました。</p>
</div>
<div class="section" id="id2">
<h2>セットアップ手順</h2>
<div class="section" id="lxd">
<h3>LXDコンテナ作成</h3>
<p>ホストの環境を汚したくないので、開発用にLXDのコンテナを作ってそこで作業します。</p>
<div class="highlight"><pre><span></span><span class="go">lxc launch images:ubuntu/18.04 nginx-dev</span>
<span class="go">lxc exec nginx-dev bash</span>
</pre></div>
<p>ここ以降は全てコンテナ内で実行します。 <code>lxc exec</code> ではコンテナ内で root ユーザになっているので <code>sudo</code> は使いません。また、以下でコマンド実行例でプロンプトを示す場合はrootユーザということで <code>#</code> とします。</p>
</div>
<div class="section" id="id3">
<h3>ビルドに必要なパッケージをインストール</h3>
<p>debパッケージのビルドに必要なツールをインストールします。 <code>equivs</code> は後述の <code>mk-build-deps</code> コマンドで必要になります。</p>
<div class="highlight"><pre><span></span><span class="go">apt install build-essential devscripts equivs</span>
</pre></div>
</div>
<div class="section" id="deb">
<h3>自作debパッケージのソースを取得</h3>
<div class="highlight"><pre><span></span><span class="go">git clone https://github.com/hnakamur/nginx-deb</span>
<span class="go">cd nginx-deb</span>
</pre></div>
</div>
<div class="section" id="hello-world">
<h3>hello_worldモジュールのソースを取得</h3>
<p>gitサブモジュールとして追加します。</p>
<div class="highlight"><pre><span></span><span class="go">git submodule add https://github.com/cubicdaiya/ngx_http_hello_world</span>
</pre></div>
</div>
<div class="section" id="hello-worlddeb">
<h3>hello_worldモジュール開発用にdebパッケージのファイルを編集</h3>
<div class="section" id="debian-rules">
<h4>debian/rules</h4>
<p><code>debian/rules</code> は1行目に <code>#!/usr/bin/make -f</code> と書いてあるので Makefile の書式になっています。
通常の Makefile なら <code>make ターゲット</code> と実行するところを <code>./debian/rules ターゲット</code> で実行できます。</p>
<p>hello_worldモジュールをビルドするために以下の2つの変更を行います。</p>
<ul class="simple">
<li>リリースビルドとデバッグビルドのソースをビルド用のディレクトリにコピーするためのターゲット <code>config.env.%</code></li>
<li>リリースビルドとデバッグビルドのconfigureのオプションにhello_worldをダイナミックモジュールとしてビルドするためのオプションを追加。</li>
</ul>
<p>さらにhello_worldモジュールを変更・ビルド・動作確認のサイクルを効率化するために以下の2つの変更を行います。
ビルドディレクトリを残したままhello_worldモジュールのソースのみをビルドディレクトリに上書きコピーしてdebパッケージを作るための変更です。</p>
<ul class="simple">
<li>hello_worldモジュールのソースだけをビルドディレクトリにコピーするためのmakeターゲット <code>copy_hello_src</code> を追加し、 <code>.PHONY</code> に <code>copy_hello_src</code> を追加。</li>
<li>post-build と install ターゲットでシンボリックリンク作成する際に <code>-f</code> オプションを追加して、リンクが既にあってもエラーにならないようにする。</li>
</ul>
<div class="highlight"><pre><span></span><span class="gh">diff --git a/debian/rules b/debian/rules</span>
<span class="gh">index c97ab1a..3eef083 100755</span>
<span class="gd">--- a/debian/rules</span>
<span class="gi">+++ b/debian/rules</span>
<span class="gu">@@ -50,8 +50,14 @@ config.env.%:</span>
        cp -Pa $(CURDIR)/redis2-nginx-module $(BUILDDIR_$*)/
        cp -Pa $(CURDIR)/set-misc-nginx-module $(BUILDDIR_$*)/
        cp -Pa $(CURDIR)/srcache-nginx-module $(BUILDDIR_$*)/
<span class="gi">+       cp -Pa $(CURDIR)/ngx_http_hello_world $(BUILDDIR_$*)/</span>
        touch $@

<span class="gi">+copy_hello_src.%:</span>
<span class="gi">+       cp -Pa $(CURDIR)/ngx_http_hello_world $(BUILDDIR_$*)/</span>
<span class="gi">+</span>
<span class="gi">+copy_hello_src: copy_hello_src.nginx copy_hello_src.nginx_debug</span>
<span class="gi">+</span>
 config.status.nginx: config.env.nginx
        cd $(BUILDDIR_nginx) &amp;&amp; \
        CFLAGS=&quot;&quot; ./configure \
<span class="gu">@@ -114,6 +120,7 @@ config.status.nginx: config.env.nginx</span>
                --add-dynamic-module=./redis2-nginx-module \
                --add-dynamic-module=./set-misc-nginx-module \
                --add-dynamic-module=./srcache-nginx-module \
<span class="gi">+               --add-dynamic-module=./ngx_http_hello_world \</span>
                --with-cc-opt=&quot;$(CFLAGS)&quot; \
                --with-ld-opt=&quot;$(LDFLAGS)&quot;
        touch $@
<span class="gu">@@ -180,6 +187,7 @@ config.status.nginx_debug: config.env.nginx_debug</span>
                --add-dynamic-module=./redis2-nginx-module \
                --add-dynamic-module=./set-misc-nginx-module \
                --add-dynamic-module=./srcache-nginx-module \
<span class="gi">+               --add-dynamic-module=./ngx_http_hello_world \</span>
                --with-cc-opt=&quot;$(CFLAGS)&quot; \
                --with-ld-opt=&quot;$(LDFLAGS)&quot; \
                --with-debug
<span class="gu">@@ -221,7 +229,7 @@ clean:</span>

 post-build:
        mv $(BUILDDIR_nginx_debug)/objs/nginx $(BUILDDIR_nginx_debug)/objs/nginx-debug
<span class="gd">-       ln -s $(BUILDDIR_nginx)/objs $(CURDIR)/objs</span>
<span class="gi">+       ln -sf $(BUILDDIR_nginx)/objs $(CURDIR)/objs</span>
        cp $(BUILDDIR_nginx)/objs/nginx.8 $(BUILDDIR_nginx)/objs/nginx-debug.8

 install:
<span class="gu">@@ -235,7 +243,7 @@ install:</span>
        mkdir -p $(INSTALLDIR)/usr/share/doc/nginx
        install -m 644 debian/CHANGES $(INSTALLDIR)/usr/share/doc/nginx/changelog
        install -m 644 debian/nginx.vh.default.conf $(INSTALLDIR)/etc/nginx/conf.d/default.conf
<span class="gd">-       ln -s /usr/lib/nginx/modules $(INSTALLDIR)/etc/nginx/modules</span>
<span class="gi">+       ln -sf /usr/lib/nginx/modules $(INSTALLDIR)/etc/nginx/modules</span>

 binary-indep: build post-build install
        dh_testdir
<span class="gu">@@ -272,4 +280,4 @@ binary-arch: install build-dbg</span>

 binary: binary-indep binary-arch

<span class="gd">-.PHONY: build clean binary-indep binary-arch binary install</span>
<span class="gi">+.PHONY: build clean binary-indep binary-arch binary install copy_hello_src</span>
</pre></div>
</div>
<div class="section" id="debian-nginx-install">
<h4>debian/nginx.install</h4>
<p>ビルドしたhello_worldモジュールをdebパッケージに含めるために以下のように変更します。</p>
<div class="highlight"><pre><span></span><span class="gh">diff --git a/debian/nginx.install b/debian/nginx.install</span>
<span class="gh">index 7f2825a..f692042 100644</span>
<span class="gd">--- a/debian/nginx.install</span>
<span class="gi">+++ b/debian/nginx.install</span>
<span class="gu">@@ -16,6 +16,7 @@ objs/ngx_http_echo_module.so          usr/lib/nginx/modules</span>
 objs/ngx_http_enhanced_memcached_module.so     usr/lib/nginx/modules
 objs/ngx_http_geoip_module.so          usr/lib/nginx/modules
 objs/ngx_http_headers_more_filter_module.so    usr/lib/nginx/modules
<span class="gi">+objs/ngx_http_hello_world_module.so    usr/lib/nginx/modules</span>
 objs/ngx_http_image_filter_module.so   usr/lib/nginx/modules
 objs/ngx_http_lua_upstream_module.so   usr/lib/nginx/modules
 objs/ngx_http_memc_module.so           usr/lib/nginx/modules
</pre></div>
</div>
<div class="section" id="debian-nginx-conf">
<h4>debian/nginx.conf</h4>
<p><code>/etc/nginx/nginx.conf</code> で hello_world モジュールをロードするように以下のように変更します。
なお、後述のgdbでワーカープロセスのプロセスにアタッチしてデバッグする場合は、以下のように <code>worker_processes</code> は 1 にしておくのが楽です。</p>
<div class="highlight"><pre><span></span><span class="gh">diff --git a/debian/nginx.conf b/debian/nginx.conf</span>
<span class="gh">index e4bad8d..e89be3d 100644</span>
<span class="gd">--- a/debian/nginx.conf</span>
<span class="gi">+++ b/debian/nginx.conf</span>
<span class="gu">@@ -2,6 +2,8 @@</span>
 user  nginx;
 worker_processes  1;

<span class="gi">+load_module modules/ngx_http_hello_world_module.so;</span>
<span class="gi">+</span>
 error_log  /var/log/nginx/error.log warn;
 pid        /var/run/nginx.pid;
</pre></div>
</div>
<div class="section" id="debian-nginx-vh-default-conf">
<h4>debian/nginx.vh.default.conf</h4>
<p><code>/etc/nginx/conf.d/default.conf</code> に hello_world モジュールをテストするためのロケーションを追加するため以下のように変更します。</p>
<div class="highlight"><pre><span></span><span class="gh">diff --git a/debian/nginx.vh.default.conf b/debian/nginx.vh.default.conf</span>
<span class="gh">index 299c622..6f856d7 100644</span>
<span class="gd">--- a/debian/nginx.vh.default.conf</span>
<span class="gi">+++ b/debian/nginx.vh.default.conf</span>
<span class="gu">@@ -10,6 +10,10 @@ server {</span>
         index  index.html index.htm;
     }

<span class="gi">+    location ~ /hello_world$ {</span>
<span class="gi">+        hello_world;</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
     #error_page  404              /404.html;

     # redirect server error pages to the static page /50x.html
</pre></div>
</div>
<div class="section" id="debian-control">
<h4>debian/control</h4>
<p>今回は不要ですが、ビルド時の依存ライブラリが増える場合は <code>debian/control</code> の <code>Build-Depends</code> に追加します。</p>
</div>
</div>
<div class="section" id="id4">
<h3>依存ライブラリのインストール</h3>
<p><code>mk-build-deps</code> コマンドを使って依存ライブラリをインストールするためのdebパッケージを作成します。</p>
<div class="highlight"><pre><span></span><span class="gp">#</span> mk-build-deps debian/control
<span class="go">…(略)…</span>
<span class="go">dpkg-deb: building package &#39;nginx-build-deps&#39; in &#39;../nginx-build-deps_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_all.deb&#39;.</span>

<span class="go">The package has been created.</span>
<span class="go">Attention, the package has been created in the current directory,</span>
<span class="go">not in &quot;..&quot; as indicated by the message above!</span>
</pre></div>
<p>上記のように作成されたdebパッケージ名が表示されるので、それを指定してインストールします。
最後の3行で説明されているように親ディレクトリ <code>..</code> ではなくカレントディレクトリ <code>.</code> に作られているので以下のようにします。</p>
<div class="highlight"><pre><span></span><span class="go">dpkg -i ./nginx-build-deps_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_all.deb</span>
</pre></div>
<p>これでこのパッケージ自体はインストールされるのですが、依存ライブラリはまだインストールされていない状態です。</p>
<p><a class="reference external" href="https://askubuntu.com/questions/40011/how-to-let-dpkg-i-install-dependencies-for-me?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa">How to let `dpkg -i` install dependencies for me? - Ask Ubuntu</a> を参考に以下のようにしてインストールします。</p>
<div class="highlight"><pre><span></span><span class="go">apt install -f -y</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h2>初回のビルドと動作確認</h2>
<p>初回のビルドは通常通り行います。</p>
<div class="highlight"><pre><span></span><span class="gp">#</span> dpkg-buildpackage -b
<span class="go">…(略)…</span>
<span class="go">dpkg-deb: building package &#39;nginx&#39; in &#39;../nginx_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_amd64.deb&#39;.</span>
<span class="go">dpkg-deb: building package &#39;nginx-dbg&#39; in &#39;../nginx-dbg_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_amd64.deb&#39;.</span>
<span class="go">…(略)…</span>
</pre></div>
<p>作成されたdebパッケージのファイル名が表示されるので、これを指定してインストールします。
ここでは手抜きしてワイルドカードで指定します。この手順どおりでは無いはずですが、もし親ディレクトリにこれでマッチする他のファイルがある場合は上記の2つのファイルだけがマッチするように指定してください。</p>
<div class="highlight"><pre><span></span><span class="go">dpkg -i ../nginx*.deb</span>
</pre></div>
<p>nginxのサービスを起動します。</p>
<div class="highlight"><pre><span></span><span class="go">systemctl start nginx</span>
</pre></div>
<p><code>/hello_world</code> のロケーションにアクセスして動作確認します。</p>
<div class="highlight"><pre><span></span><span class="gp">#</span> curl localhost/hello_world
<span class="go">Hello, World!</span>
</pre></div>
</div>
<div class="section" id="id6">
<h2>2回め以降のビルドと動作確認</h2>
<p>初回のビルドが終わると <code>debian/build-nginx</code> にリリースビルド、 <code>debian/build-nginx-debug</code> にデバッグビルドのソースとビルド結果が残っています。</p>
<p>hello_world モジュールのソースを変更してビルド、インストール、動作確認をしてみます。</p>
<div class="section" id="id7">
<h3>hello_world モジュールのソース変更</h3>
<p><code>vim ngx_http_hello_world/ngx_http_hello_world_module.c</code> でソースを変更します。</p>
<p>なお <code>ngx_http_hello_world</code> はgitサブモジュールにした関係で、差分を表示するときは <code>git diff ngx_http_hello_world/ngx_http_hello_world_module.c</code> ではなく以下のようにする必要がありました（サブシェルで実行しているのはカレントディレクトリを移動したくないため）。</p>
<div class="highlight"><pre><span></span><span class="go">(cd ngx_http_hello_world/; git diff)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gh">diff --git a/ngx_http_hello_world_module.c b/ngx_http_hello_world_module.c</span>
<span class="gh">index 2760468..6a84d12 100644</span>
<span class="gd">--- a/ngx_http_hello_world_module.c</span>
<span class="gi">+++ b/ngx_http_hello_world_module.c</span>
<span class="gu">@@ -6,7 +6,7 @@</span>
 #include &lt;ngx_core.h&gt;
 #include &lt;ngx_http.h&gt;

<span class="gd">-#define NGX_HTTP_HELLO_WORLD &quot;Hello, World!\n&quot;</span>
<span class="gi">+#define NGX_HTTP_HELLO_WORLD &quot;Hello, World!!\n&quot;</span>

 static char *ngx_http_hello_world(ngx_conf_t *cf, ngx_command_t *cmd, void *conf);
 static ngx_int_t ngx_http_hello_world_handler(ngx_http_request_t *r);
</pre></div>
</div>
<div class="section" id="id8">
<h3>ビルド、インストール、動作確認</h3>
<p>ソース変更とビルド、インストール、動作確認は繰り返し行うので以下のように <code>&amp;&amp;</code> で繋いで一連で実行するようにします。あるいはシェルスクリプトファイルを作って実行しても良いでしょう。</p>
<div class="highlight"><pre><span></span><span class="go">./debian/rules copy_hello_src &amp;&amp; \</span>
<span class="go">  dpkg-buildpackage -nc &amp;&amp; \</span>
<span class="go">  dpkg -i --force-overwrite ../nginx_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_amd64.deb ../nginx-dbg_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_amd64.deb &amp;&amp; \</span>
<span class="go">  systemctl restart nginx &amp;&amp; \</span>
<span class="go">  curl -v localhost/hello_world</span>
</pre></div>
<p><code>curl</code> の実行結果は以下のようになり、上記の変更がただしく反映されたことを確認できました。</p>
<div class="highlight"><pre><span></span>*   Trying ::1...
* TCP_NODELAY set
* connect to ::1 port 80 failed: Connection refused
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 80 (#0)
&gt; GET /hello_world HTTP/1.1
&gt; Host: localhost
&gt; User-Agent: curl/7.58.0
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 200 OK
&lt; Server: nginx/1.13.11
&lt; Date: Thu, 10 May 2018 01:59:43 GMT
&lt; Content-Type: text/plain
&lt; Content-Length: 15
&lt; Connection: keep-alive
&lt;
Hello, World!!
</pre></div>
</div>
</div>
<div class="section" id="id9">
<h2>デバッガの実行</h2>
<p>ついでにデバッガで実行する手順もメモしておきます。</p>
<p>gdbの操作方法は公式ドキュメントのページ  <a class="reference external" href="http://www.gnu.org/software/gdb/documentation/">GDB Documentation</a> にあるGDB User Manualを参照してください。</p>
<p>まずgdbをインストールします。</p>
<div class="highlight"><pre><span></span><span class="go">apt install gdb</span>
</pre></div>
<p>リリースビルドのnginxのサービスを停止し、デバッグビルドのnginxのサービスを起動します。</p>
<div class="highlight"><pre><span></span><span class="go">systemctl stop nginx &amp;&amp; systemctl start nginx-debug</span>
</pre></div>
<p>nginxのワーカープロセスのPIDを確認します。</p>
<div class="highlight"><pre><span></span><span class="gp">#</span> ps auxwwf <span class="p">|</span> grep <span class="o">[</span>n<span class="o">]</span>ginx
<span class="go">root     11380  0.0  0.0  43844   988 ?        Ss   02:21   0:00 nginx: master process /usr/sbin/nginx-debug -c /etc/nginx/nginx.conf</span>
<span class="go">nginx    11381  0.0  0.0  48664  4744 ?        S    02:21   0:00  \_ nginx: worker process</span>
</pre></div>
<p>デバッグビルドのnginxのソースディレクトリとnginxワーカープロセスのPIDを指定してgdbを起動してワーカープロセスにアタッチします。 <a class="reference external" href="http://www.geekpage.jp/blog/?id=2007/1/17">既に起動しているプロセスをgdbで制御する:Geekなぺーじ</a> にわかりやすい解説がありました。</p>
<div class="highlight"><pre><span></span><span class="go">gdb --directory debian/build-nginx-debug -p 11381</span>
</pre></div>
<p>あるいはデバッグビルドのソースディレクトリに移動して実行しても良いです。</p>
<div class="highlight"><pre><span></span><span class="go">cd debian/build-nginx-debug; gdb -p 11381</span>
</pre></div>
<p>起動すると以下のようなメッセージが出力された後、gdbのプロンプトが出力されます。</p>
<p>PID 11381のプロセスにアタッチし、nginx-debugのシンボルが読み込めたことがわかります。
一方 <code>epoll_wait.c</code> が無いので <code>epoll_wait</code> のシンボル情報は読み込めていませんが、ここをデバッガで追わない場合は無視して構いません。デバッガで負いたい場合は対応するデバッグパッケージをインストールすれば良いはずです。</p>
<p>nginx-debugのシンボルは</p>
<div class="highlight"><pre><span></span>…(略)…
Attaching to process 11381
Reading symbols from /usr/sbin/nginx-debug...Reading symbols from /usr/lib/debug/.build-id/92/48720f057ba2391859b2bade2edabb6f050487.debug...done.
done.
…(略)…
0x00007fecd781fb77 in epoll_wait (epfd=8, events=0x55ca9383b300, maxevents=512, timeout=timeout@entry=-1)
    at ../sysdeps/unix/sysv/linux/epoll_wait.c:30
30      ../sysdeps/unix/sysv/linux/epoll_wait.c: No such file or directory.
(gdb)
</pre></div>
<p><a class="reference external" href="https://ccrma.stanford.edu/~jos/stkintro/Useful_commands_gdb.html">Useful commands in gdb</a> にgdbのよく使うコマンド一覧がありました。</p>
<p>gdbのプロンプトに <code>b ngx_http_hello_world/ngx_http_hello_world_module.c:ngx_http_hello_world_handler</code> と入力し、hello_worldモジュールの <code>ngx_http_hello_world_handler</code> 関数にブレークポイントを設定してみます。
以下のように、このあと共有ライブラリがロードされたらブレークポイントを設定するか聞かれるので <code>y</code> と入力します。</p>
<div class="highlight"><pre><span></span>(gdb) b ngx_http_hello_world/ngx_http_hello_world_module.c:ngx_http_hello_world_handler
No source file named ngx_http_hello_world/ngx_http_hello_world_module.c.
Make breakpoint pending on future shared library load? (y or [n]) y
Breakpoint 1 (ngx_http_hello_world/ngx_http_hello_world_module.c:ngx_http_hello_world_handler) pending.
</pre></div>
<p>念のためgdbのプロンプトに <code>i b</code> と入力してブレークポイントが設定されたことを確認します。</p>
<div class="highlight"><pre><span></span>(gdb) i b
Num     Type           Disp Enb Address            What
1       breakpoint     keep y   0x00007fecd67048f0 in ngx_http_hello_world_handler
                                                   at ./ngx_http_hello_world/ngx_http_hello_world_module.c:57
</pre></div>
<p>gdbのプロンプトに <code>c</code> を入力して処理を続行 (continue) します。</p>
<div class="highlight"><pre><span></span>(gdb) c
Continuing.
</pre></div>
<p>別の端末で <code>curl localhost/hello_world</code> と実行すると、gdbがブレークポイントで止まって以下のようにプロンプトが表示されます。</p>
<div class="highlight"><pre><span></span>Breakpoint 1, ngx_http_hello_world_handler (r=0x55ca9385efd0)
    at ./ngx_http_hello_world/ngx_http_hello_world_module.c:57
warning: Source file is more recent than executable.
57      {
(gdb)
</pre></div>
<p>ここで <code>C-x C-a</code> と入力すると画面が上下に分割され、上にソースコード、下にgdbのプロンプトが表示されます。
これはTUIモードと呼ばれるもので <a class="reference external" href="https://sourceware.org/gdb/current/onlinedocs/gdb/TUI.html#TUI">Debugging with GDB: TUI</a> に説明があります。</p>
<div class="highlight"><pre><span></span>   ┌──./ngx_http_hello_world/ngx_http_hello_world_module.c────────────────────────────────────────────────────────────┐
   │46          NULL,                             /* init master */                                                   │
   │47          NULL,                             /* init module */                                                   │
   │48          NULL,                             /* init process */                                                  │
   │49          NULL,                             /* init thread */                                                   │
   │50          NULL,                             /* exit thread */                                                   │
   │51          NULL,                             /* exit process */                                                  │
   │52          NULL,                             /* exit master */                                                   │
   │53          NGX_MODULE_V1_PADDING                                                                                 │
   │54      };                                                                                                        │
   │55                                                                                                                │
   │56      static ngx_int_t ngx_http_hello_world_handler(ngx_http_request_t *r)                                      │
B+&gt;│57      {                                                                                                         │
   │58          ngx_int_t                    rc;                                                                      │
   │59          ngx_chain_t                  out;                                                                     │
   │60          ngx_buf_t                   *b;                                                                       │
   │61          ngx_str_t                    body = ngx_string(NGX_HTTP_HELLO_WORLD);                                 │
   │62                                                                                                                │
   │63          if (r-&gt;method != NGX_HTTP_GET &amp;&amp; r-&gt;method != NGX_HTTP_HEAD) {                                        │
   │64              return NGX_HTTP_NOT_ALLOWED;                                                                      │
   │65          }                                                                                                     │
   │66                                                                                                                │
   │67          if (r-&gt;headers_in.if_modified_since) {                                                                │
   │68              return NGX_HTTP_NOT_MODIFIED;                                                                     │
   │69          }                                                                                                     │
   │70                                                                                                                │
   └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
multi-thre Thread 0x7fecd914b7 In: ngx_http_hello_world_handler                               L57   PC: 0x7fecd67048f0
(gdb)
</pre></div>
<p>TUIモードのキー操作については <a class="reference external" href="https://sourceware.org/gdb/current/onlinedocs/gdb/TUI-Keys.html#TUI-Keys">Debugging with GDB: TUI Keys</a> を参照してください。</p>
<p>gdbプロンプトで <cite>C-x 2</cite> と入力するとCとアセンブラのウィンドウが表示されます。</p>
<div class="highlight"><pre><span></span>   ┌──./ngx_http_hello_world/ngx_http_hello_world_module.c────────────────────────────────────────────────────────────┐
B+&gt;│57      {                                                                                                         │
   │58          ngx_int_t                    rc;                                                                      │
   │59          ngx_chain_t                  out;                                                                     │
   │60          ngx_buf_t                   *b;                                                                       │
   │61          ngx_str_t                    body = ngx_string(NGX_HTTP_HELLO_WORLD);                                 │
   │62                                                                                                                │
   │63          if (r-&gt;method != NGX_HTTP_GET &amp;&amp; r-&gt;method != NGX_HTTP_HEAD) {                                        │
   │64              return NGX_HTTP_NOT_ALLOWED;                                                                      │
   │65          }                                                                                                     │
   │66                                                                                                                │
   │67          if (r-&gt;headers_in.if_modified_since) {                                                                │
   │68              return NGX_HTTP_NOT_MODIFIED;                                                                     │
   │69          }                                                                                                     │
   └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
B+&gt;│0x7fecd67048f0 &lt;ngx_http_hello_world_handler&gt;           push   %rbx                                               │
   │0x7fecd67048f1 &lt;ngx_http_hello_world_handler+1&gt;         sub    $0x20,%rsp                                         │
   │0x7fecd67048f5 &lt;ngx_http_hello_world_handler+5&gt;         mov    %fs:0x28,%rax                                      │
   │0x7fecd67048fe &lt;ngx_http_hello_world_handler+14&gt;        mov    %rax,0x18(%rsp)                                    │
   │0x7fecd6704903 &lt;ngx_http_hello_world_handler+19&gt;        xor    %eax,%eax                                          │
   │0x7fecd6704905 &lt;ngx_http_hello_world_handler+21&gt;        mov    0x3d0(%rdi),%rax                                   │
   │0x7fecd670490c &lt;ngx_http_hello_world_handler+28&gt;        lea    -0x2(%rax),%rdx                                    │
   │0x7fecd6704910 &lt;ngx_http_hello_world_handler+32&gt;        mov    $0x195,%eax                                        │
   │0x7fecd6704915 &lt;ngx_http_hello_world_handler+37&gt;        test   $0xfffffffffffffffd,%rdx                           │
   │0x7fecd670491c &lt;ngx_http_hello_world_handler+44&gt;        jne    0x7fecd6704930 &lt;ngx_http_hello_world_handler+64&gt;   │
   │0x7fecd670491e &lt;ngx_http_hello_world_handler+46&gt;        cmpq   $0x0,0xb0(%rdi)                                    │
   │0x7fecd6704926 &lt;ngx_http_hello_world_handler+54&gt;        mov    %rdi,%rbx                                          │
   │0x7fecd6704929 &lt;ngx_http_hello_world_handler+57&gt;        mov    $0x130,%eax                                        │
   │0x7fecd670492e &lt;ngx_http_hello_world_handler+62&gt;        je     0x7fecd6704950 &lt;ngx_http_hello_world_handler+96&gt;   │
   └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
multi-thre Thread 0x7fecd914b7 In: ngx_http_hello_world_handler                               L57   PC: 0x7fecd67048f0
…(略)…
(gdb)
</pre></div>
<p><code>C-x o</code> でアクティブウィンドウを切り替えられます。押す度に、ソース、アセンブラ、コマンドと切り替わっていきます。あるいは <a class="reference external" href="https://sourceware.org/gdb/current/onlinedocs/gdb/TUI-Commands.html#TUI-Commands">TUI-specific Commands</a> の <code>focus</code> コマンドを使って切り替えることもできます。ソースかアセンブラがアクティブな場合はウィンドウ枠が反転表示になります。</p>
<p>ソースかアセンブラのウィンドウがアクティブな時に、カーソルキーの上下か PgUp, PgDown キーを押すと前後のソースまたはアセンブリコードが見られます。</p>
<p><code>wh</code> (winheight)` コマンドでウィンドウの高さを調節できます。引数なしで実行すると使い方が表示されます。</p>
<div class="highlight"><pre><span></span>(gdb) wh
Usage: winheight &lt;win_name&gt; [+ | -] &lt;#lines&gt;
</pre></div>
<p>ウィンドウの名前と現在の高さを見るには <code>i win</code> (info winの省略形) を実行します。</p>
<div class="highlight"><pre><span></span>(gdb) i win
        src     (15 lines)
        asm     (16 lines)
        cmd     (11 lines)  &lt;has focus&gt;
</pre></div>
<p>例えば <code>src</code> ウィンドウの高さを30行にするなら <code>winheight src 30</code> 、現在の行数より5行広げるなら <code>winheight src +5</code> のようにします。</p>
<p>ソースだけの表示に戻すには <code>C-x 1</code> 、TUIモードを抜けるには <code>C-x a</code> を押します。</p>
<p><a class="reference external" href="https://sourceware.org/gdb/current/onlinedocs/gdb/TUI-Single-Key-Mode.html#TUI-Single-Key-Mode">Single Key Mode</a> というのも便利でした。
これを知るまでは <a class="reference external" href="https://sourceware.org/gdb/current/onlinedocs/gdb/Continuing-and-Stepping.html#Continuing-and-Stepping">Continuing and Stepping</a> の <code>next</code> コマンドの省略形の <code>n</code> を使って <code>n</code> リターンを繰り返してステップ実行していました。
<code>C-x s</code> でシングルキーモードに入れば <code>n</code> だけでステップ実行できるので楽です。 <code>q</code> でシングルキーモードから抜けてgdbのプロンプトに戻ります。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>