<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Ubuntu 18.04でgit-buildpackageとfreightを使うときのメモ</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/05/01/ubuntu-18.04-git-buildpackage-freight/" rel="bookmark"
           title="Permalink to Ubuntu 18.04でgit-buildpackageとfreightを使うときのメモ">Ubuntu 18.04でgit-buildpackageとfreightを使うときのメモ</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-05-01T12:35:00+09:00">
                Published: 2018-05-01
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/ubuntu.html">ubuntu</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<ul class="simple">
<li><a class="reference external" href="/blog/2017/07/05/how-to-build-deb-with-git-buildpackage/">git-buildpackageでdebパッケージをビルドしてPPAにアップロードする手順</a></li>
<li><a class="reference external" href="/blog/2017/08/05/create-private-deb-repository-with-freight/">freightでプライベートdebレポジトリ作成</a></li>
<li><a class="reference external" href="/blog/2017/08/28/use-passphrase-file-in-git-buildpackage-and-freight/">git-buildpacakgeとfreightでパスフレーズをファイルから入力させる</a></li>
</ul>
<p>に書いた git-buildpackage と freight の環境を Ubuntu 18.04 でも作ったのですが、少し変更が必要だったのでメモです。</p>
</div>
<div class="section" id="gbp-buildpacakge-d">
<h2>gbp buildpacakgeには-dオプションを指定</h2>
<p>Ubuntu 16.04 のときには以下のコマンドでソースパッケージをビルドしていました。</p>
<div class="highlight"><pre><span></span><span class="go">gbp buildpackage --git-export-dir=../build-area -p/home/hnakamur/bin/gpg-passphrase -S -sa</span>
</pre></div>
<p>が、Ubuntu 18.04ではgit-buildpackageのバージョンが変わった影響で <code>gbp buildpackage</code> でのソースパッケージの作成時にdebパッケージの依存関係のエラーが出るようになりました。</p>
<p>調べてみたところ <code>gbp</code> が呼び出している <code>dpkg-buildpackage</code> に依存関係をチェックする <code>-D</code> オプションとチェックしない <code>-d</code> オプションがあることがわかりました。</p>
<p><a class="reference external" href="http://manpages.ubuntu.com/manpages/bionic/en/man1/dpkg-buildpackage.1.html">Ubuntu Manpage: dpkg-buildpackage - build binary or source packages from sources</a></p>
<div class="highlight"><pre><span></span>-D, --check-builddeps
       Check build dependencies and conflicts; abort if unsatisfied (long option since dpkg 1.18.8).  This is the default behavior.

-d, --no-check-builddeps
       Do not check build dependencies and conflicts (long option since dpkg 1.18.8).
</pre></div>
<p>Ubuntu 16.04 で gbp buildpackage を実行していたときは dpkg-buildpackage を呼ぶ時に -d が指定されていましたが、Ubuntu 18.04 では指定されなくなっていました。 gbp buildpackage のソースを見るとオプションを指定するとそのまま dpkg-buildpackage に渡すようになっていました。</p>
<p>ということで以下のように -d を指定することで解決しました。</p>
<div class="highlight"><pre><span></span><span class="go">gbp buildpackage --git-export-dir=../build-area -p/home/hnakamur/bin/gpg-passphrase -S -sa -d</span>
</pre></div>
</div>
<div class="section" id="gnupg-2-x">
<h2>GnuPG 2.xでパスフレーズをファイルから読み込ませるための対応</h2>
<p>Ubuntu 16.04では /usr/bin/gpg は gnupg という GnuPG 1.x のパッケージに含まれる実行ファイルでした。
で gnupg2 という GnuPG 2.x のパッケージの実行ファイルは /usr/bin/gpg2 という名前でした。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ls -l /usr/bin/gpg<span class="o">{</span>,2<span class="o">}</span>
<span class="go">-rwxr-xr-x 1 root root 1008632 Aug 18  2016 /usr/bin/gpg</span>
<span class="go">-rwxr-xr-x 1 root root  917032 Apr  8  2016 /usr/bin/gpg2</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> dpkg -l gnupg gnupg2 gnupg-agent
<span class="go">Desired=Unknown/Install/Remove/Purge/Hold</span>
<span class="go">| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend</span>
<span class="go">|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)</span>
<span class="go">||/ Name                    Version          Architecture     Description</span>
<span class="go">+++-=======================-================-================-====================================================</span>
<span class="go">ii  gnupg                   1.4.20-1ubuntu3. amd64            GNU privacy guard - a free PGP replacement</span>
<span class="go">ii  gnupg-agent             2.1.11-6ubuntu2  amd64            GNU privacy guard - cryptographic agent</span>
<span class="go">ii  gnupg2                  2.1.11-6ubuntu2  amd64            GNU privacy guard - a free PGP replacement (new v2.x</span>
</pre></div>
<p>Ubuntu 18.04では /usr/bin/gpg は gnupg2 パッケージのファイルになり、gnupg1 パッケージの実行ファイルは /usr/bin/gpg1 という名前に変えられています。また、 /usr/bin/gpg2 は /usr/bin/gpg へのシンボリックリンクになりました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ls -l /usr/bin/gpg<span class="o">{</span>,1,2<span class="o">}</span>
<span class="go">-rwxr-xr-x 1 root root 1021480 Jan 11 22:33 /usr/bin/gpg</span>
<span class="go">-rwxr-xr-x 1 root root  889720 Nov 11 23:41 /usr/bin/gpg1</span>
<span class="go">lrwxrwxrwx 1 root root       3 Jan 11 22:33 /usr/bin/gpg2 -&gt; gpg</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> dpkg -l gnupg gnupg2 gnupg1
<span class="go">Desired=Unknown/Install/Remove/Purge/Hold</span>
<span class="go">| Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend</span>
<span class="go">|/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)</span>
<span class="go">||/ Name                    Version          Architecture     Description</span>
<span class="go">+++-=======================-================-================-====================================================</span>
<span class="go">ii  gnupg                   2.2.4-1ubuntu1   amd64            GNU privacy guard - a free PGP replacement</span>
<span class="go">ii  gnupg1                  1.4.22-3ubuntu2  amd64            GNU privacy guard - a PGP implementation (deprecated</span>
<span class="go">ii  gnupg2                  2.2.4-1ubuntu1   all              GNU privacy guard - a free PGP replacement (dummy tr</span>
</pre></div>
<p>GnuPG 2.xでは
<a class="reference external" href="/blog/2017/08/28/use-passphrase-file-in-git-buildpackage-and-freight/">git-buildpacakgeとfreightでパスフレーズをファイルから入力させる</a>
に書いた <cite>--passphrase-fd</cite> を使った手法はそのままでは使えませんでした。</p>
<p>ArchWikiのGnuPGのページの <a class="reference external" href="https://wiki.archlinux.org/index.php/GnuPG#Unattended_passphrase">Unattended passphrase</a>  に回避策が書かれていました。元のオプションに <code>--pinentry-mode loopback</code> を追加すれば良いとのことです。</p>
<div class="section" id="gbp-buildpackage-p">
<h3>gbp buildpackageの-pオプションに指定するファイルの修正</h3>
<div class="highlight"><pre><span></span><span class="go">gbp buildpackage --git-export-dir=../build-area -p/home/hnakamur/bin/gpg-passphrase -S -sa -d</span>
</pre></div>
<p>の -p オプションで指定している /home/hnakamur/bin/gpg-passphrase の中身は以下のように書き換えました。</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nb">exec</span> &lt;/home/hnakamur/.gpg-passphrase /usr/bin/gpg --batch --pinentry-mode loopback --passphrase-fd <span class="m">0</span> <span class="s2">&quot;</span><span class="nv">$@</span><span class="s2">&quot;</span>
</pre></div>
</div>
<div class="section" id="fright-p">
<h3>frightの-pオプションを使うには修正が必要</h3>
<p>freightのほうはfreightのソースを変更する必要があったので、変更してプルリクエストを送りました。
<a class="reference external" href="https://github.com/freight-team/freight/pull/84">Support gpg2 in freight cache passphrase file option by hnakamur · Pull Request #84 · freight-team/freight</a></p>
<p>この変更を加えた状態ですと、以前と同じ以下のコマンドでOKです。</p>
<div class="highlight"><pre><span></span><span class="go">sudo freight cache -p /home/hnakamur/.gpg-passphrase</span>
</pre></div>
</div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>