<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>nginxのコードリーディングにrtagsを使う</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/05/23/use-rtags-for-nginx-code-reading/" rel="bookmark"
           title="Permalink to nginxのコードリーディングにrtagsを使う">nginxのコードリーディングにrtagsを使う</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-05-23T22:25:00+09:00">
                Published: 2018-05-23
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/ubuntu.html">ubuntu</a> <a href="../../../../tag/rtags.html">rtags</a> <a href="../../../../tag/nginx.html">nginx</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="/blog/2018/05/23/build-rtags-deb-for-ubuntu-18.04-lts/">Ubuntu 18.04 LTS用にrtagsのdebパッケージを作成した</a> で作成したrtagsを使ってnginxのコードリーディングをするための手順メモです。</p>
<p>configure で生成される <code>ngx_auto_config.h</code> と <code>ngx_auto_headers.h</code> も含めて読みたいというのと、rtagsのREADMEの <a class="reference external" href="https://github.com/Andersbakken/rtags#setup">Setup</a> のうちnginxでは <a class="reference external" href="https://github.com/rizsotto/Bear">Bear</a> を使って <code>compile_commands.json</code> を生成するという関係もあり、 <a class="reference external" href="https://hnakamur.github.io/blog/2018/05/10/build-and-debug-nginx-module-using-deb-package/">debパッケージを使ってnginxモジュールをビルド・デバッグする</a> と似た感じでビルドしていくことになります。</p>
<p>例によってこの記事に書いているのは試行錯誤してとりあえず動いたという手順なので、もっと良い手順があるかもしれません。</p>
</div>
<div class="section" id="rtagsvim-rtags">
<h2>rtagsとvim-rtagsのインストール</h2>
<p><a class="reference external" href="/blog/2018/05/23/build-rtags-deb-for-ubuntu-18.04-lts/">Ubuntu 18.04 LTS用にrtagsのdebパッケージを作成した</a> の手順で rtags をインストールして rdm を実行しておきます。またvim-rtagsもインストールしておきます。</p>
</div>
<div class="section" id="id2">
<h2>必要なソフトのインストール</h2>
<p>debパッケージのビルドに必要なツールをインストールします。 equivs は後述の mk-build-deps コマンドで必要になります。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt install build-essential devscripts equivs bear</span>
</pre></div>
</div>
<div class="section" id="nginxdeb">
<h2>nginxのdebパッケージのソースの取得</h2>
<p>普段使っているモジュール込みでコードリーディングしたいので自作debパッケージのソースを使います。
適当な作業ディレクトリで以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="go">git clone https://github.com/hnakamur/nginx-deb</span>
<span class="go">cd nginx-deb</span>
</pre></div>
</div>
<div class="section" id="id3">
<h2>依存ライブラリのインストール</h2>
<div class="highlight"><pre><span></span><span class="go">mk-build-deps debian/control</span>
<span class="go">sudo dpkg -i ./nginx-build-deps*.deb</span>
<span class="go">sudo apt install -f</span>
</pre></div>
</div>
<div class="section" id="id4">
<h2>パッチ適用</h2>
<p>debパッケージに含まれるパッチを適用します。この記事を書いている2018-05-23時点ではパッチを当てないとlua-nginx-moduleがUbuntu 18.04のlibluajit-5.1-devパッケージのファイルを見つけられないので当てる必要があります。</p>
<p>以下のコマンドでパッチを当てます。ちなみにこの手順はバイナリパッケージをビルドするコマンド <code>dpkg-buildpackage -b</code> を実行したときに出力されていて知りました。</p>
<div class="highlight"><pre><span></span><span class="go">dpkg-source --before-build .</span>
</pre></div>
<p>この時点で <code>git status</code> を実行するとカレントディクレクトリ配下のソースが変更されていました。後ほど <code>git checkout .</code> で元に戻しておきます。</p>
</div>
<div class="section" id="configure">
<h2>ソースのコピーとconfigure実行</h2>
<div class="highlight"><pre><span></span><span class="go">./debian/rules config.status.nginx</span>
</pre></div>
<p>これで <code>debian/build-nginx</code> ディレクトリが作成されてnginxとモジュールのソースがコピーされconfigureが実行されます。この結果として <code>debian/build-nginx</code> 以下に <code>Makefile</code>, <code>objs/ngx_auto_config.h</code>, <code>objs/ngx_auto_headers.h</code> やその他のファイルが作られます。</p>
<p>また、カレントディレクトリには <code>config.env.nginx</code> と <code>config.status.nginx</code> というファイルが生成されます。 <code>debian/rules</code> の中を見るとMakefileになっているのですが、これらはmakeのターゲットになっています。</p>
<p>もしcleanしてやり直したい場合は <code>fakeroot ./debian/rules clean</code> でcleanできますが、 <code>debian/build-nginx</code> 以下の <code>Makefile</code> も消えてしまうので、再度 <code>./debian/rules config.status.nginx</code> を実行する必要があります。その際は <code>config.env.nginx</code> と <code>config.status.nginx</code> を消しておく必要があります。</p>
</div>
<div class="section" id="bearcompile-commands-json">
<h2>bearを使ってcompile_commands.json作成</h2>
<p>rtagsのインデクスを作るための元ネタになる <code>compile_commands.json</code> をbearを使って作ります。
<code>compile_commands.json</code> にはソースコードのフルパスが含まれるので、コードを読むのを別のディレクトリで行いたい場合は、このタイミングで移動すると良いです。</p>
<p>ここでは <code>~/nginx-code-reading</code> に移動してみました。</p>
<div class="highlight"><pre><span></span><span class="go">mv debian/build-nginx ~/nginx-code-reading</span>
<span class="go">cd !$</span>
<span class="go">bear make</span>
</pre></div>
<p>これで <code>compile_commands.json</code> が作られますので、あとは以下を実行してインデクスを作成します。</p>
<div class="highlight"><pre><span></span><span class="go">rc -J</span>
</pre></div>
<p>すると <code>~/.cache/rtags</code> ディレクトリの下に <code>_home_hnakamur_nginx-code-reading_</code> というディレイクトリが作られていました。これは <code>/home/hnakamur/nginx-code-reading</code> というディレクトリに対応したものです（ <code>/</code> を <code>_</code> に置換して最後に <code>_</code> を追加している）。</p>
</div>
<div class="section" id="rtags">
<h2>rtagsを使ってコードを読む</h2>
<p>lyuts/vim-rtags の <a class="reference external" href="https://github.com/lyuts/vim-rtags#mappings">Mappings</a> のキー操作により定義にジャンプしたり関数などの参照箇所を表示します。</p>
<p><code>&lt;Leader&gt;rj</code> での定義へのジャンプは関数で使えるのはもちろんですが、構造体のフィールドを参照している箇所にカーソルをおいて <code>&lt;Leader&gt;rj</code> を押すと構造体の定義のフィールドの行に飛べるのが便利でした。</p>
<p>ジャンプから戻るのは <code>Ctrl-O</code> でできました。</p>
</div>
<div class="section" id="id5">
<h2>おわりに</h2>
<p>まだ使い始めたばかりなのでよくわかっていませんが、かなり便利そうなので使いこなしていきたいです。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>