<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>golang 1.9rc1のUbuntu 16.04用debパッケージをビルドした</title>
        <link rel="stylesheet" href="../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../08/05/built-golang-1.9rc1-deb-package/" rel="bookmark"
           title="Permalink to golang 1.9rc1のUbuntu 16.04用debパッケージをビルドした">golang 1.9rc1のUbuntu 16.04用debパッケージをビルドした</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-08-05T10:15:00+09:00">
                Published: 2017-08-05
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../tag/go.html">go</a> <a href="../../../tag/deb.html">deb</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="https://github.com/golang/go/wiki/Ubuntu">Ubuntu · golang/go Wiki</a> で紹介されている
<a class="reference external" href="https://launchpad.net/~longsleep/+archive/ubuntu/golang-backports">Golang Backports : Simon Eisenmann</a> を改変してgo 1.9rc1のUbuntu 16.04用debパッケージをビルドしたのでメモです。</p>
<p><a class="reference external" href="https://launchpad.net/~hnakamur/+archive/ubuntu/golang-1.9">golang 1.9 : Hiroaki Nakamura</a> というPPAで配布しています。</p>
<p>この記事の手順は <a class="reference external" href="https://hnakamur.github.io/blog/2017/07/05/how-to-build-deb-with-git-buildpackage/">git-buildpackageでdebパッケージをビルドしてPPAにアップロードする手順</a> で書いたセットアップが済んでいることが前提です。</p>
</div>
<div class="section" id="deb">
<h2>今回ビルドしたdebのインストール手順</h2>
<p>今回ビルドしたdebパッケージのインストール手順は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt update</span>
<span class="go">sudo apt install software-properties-common</span>
<span class="go">sudo add-apt-repository ppa:hnakamur/golang-1.9</span>
<span class="go">sudo apt update</span>
<span class="go">sudo apt install golang-go</span>
</pre></div>
<p>LXDのコンテナを新規に作って試す場合の手順も書いておきます。以下ではコンテナ名を <code>go19</code> としていますが適宜変更してください。</p>
<div class="highlight"><pre><span></span><span class="go">lxc launch images:ubuntu/xenial go19</span>
<span class="go">lxc exec go19 bash</span>
<span class="go">apt update</span>
<span class="go">apt install software-properties-common</span>
<span class="go">add-apt-repository ppa:hnakamur/golang-1.9</span>
<span class="go">apt update</span>
<span class="go">apt install golang-go</span>
</pre></div>
</div>
<div class="section" id="godeb">
<h2>goのdebパッケージの作成手順メモ</h2>
<p>作成と言っても一からではなくて、 Simon Eisenmann (LaunchPadのアカウントID: longsleep) さんのdebパッケージのソースを取って来て、オリジンのソースを入れ替えて適宜書き換えるだけです。</p>
<div class="section" id="simon-deb">
<h3>Simon さんのdebパッケージのソースをダウンロード</h3>
<p><a class="reference external" href="https://launchpad.net/~longsleep/+archive/ubuntu/golang-backports/+packages">Packages in “Golang Backports” : Golang Backports : Simon Eisenmann</a> でパッケージ名のリストを確認すると、以下の3つのパッケージがあります。</p>
<ul class="simple">
<li>golang-1.8</li>
<li>golang-1.8-race-detector-runtime</li>
<li>golang-defaults</li>
</ul>
<p>golang-1.8 のリンクをクリックして展開すると複数のパッケージファイルが並んでいますが、そのうち
golang-1.8-go というパッケージファイルをインストールすると /usr/lib/go-1.8/ 以下に /usr/lib/go-1.8/bin/go のように配置されるようになっています。</p>
<p>同様に golang-defaults のリンクをクリックして展開すると、 golang-go というパッケージファイルがあり、これをインストールすると <code>/usr/bin/go -&gt; ../lib/go-1.8/bin/go</code> というシンボリックリンクなどが作られるようになっています。</p>
<p>golang-1.8-race-detector-runtime はよくわかってないので今回はスキップします。</p>
<p>以下のコマンドを実行して golang-1.8 と golang-defaults のソースパッケージをダウンロードします。
ここでは <code>~/longsleep-go-deb</code> という作業ディレクトリを作成していますが、適宜変更してください。</p>
<div class="highlight"><pre><span></span><span class="go">sudo add-apt-repository ppa:longsleep/golang-backports</span>
<span class="go">sudo apt-get update</span>
<span class="go">mkdir ~/longsleep-go-deb</span>
<span class="go">cd !$</span>
<span class="go">apt source golang-1.8-go golang-defaults</span>
</pre></div>
</div>
<div class="section" id="golang-1-8golang-1-9">
<h3>golang-1.8のパッケージを改変してgolang-1.9のパッケージを作成</h3>
<p>最終結果は <a class="reference external" href="https://github.com/hnakamur/golang-deb">https://github.com/hnakamur/golang-deb</a> で公開しています。
以下の手順は何回か試行錯誤した結果なのですが、上記のレポジトリと多少ずれているかもしれません。もう一度一からやり直して確認するの面倒なので、そのまま書いてしまいます。</p>
<p>以下ではレポジトリの作業ディレクトリを <code>~/.ghq/github.com/hnakamur/golang-deb</code> として説明します。適宜変更してください。</p>
<p>まず、 <code>.dsc</code> ファイルをインポートして、レポジトリを新規作成します。
ディレクトリ名を <code>golang</code> から <code>golang-deb</code> に変更して、そこに移動します。</p>
<div class="highlight"><pre><span></span><span class="go">cd ~/.ghq/github.com/hnakamur</span>
<span class="go">gbp import-dsc --pristine-tar \</span>
<span class="go">        --debian-branch=ubuntu-1.8 --upstream-branch=upstream-1.8 \</span>
<span class="go">        ~/longsleep-go-deb/golang-1.8/golang-1.8_1.8.3-2ubuntu1~longsleep1-xenial.dsc</span>
<span class="go">mv golang golang-deb</span>
<span class="go">cd !$</span>
</pre></div>
<p>ブランチを確認します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git branch
<span class="go">* master</span>
<span class="go">  pristine-tar</span>
<span class="go">  ubuntu-1.8</span>
<span class="go">  upstream-1.8</span>
</pre></div>
<p>タグを確認します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git tag
<span class="go">debian/1.8.3-2ubuntu1_longsleep1-xenial</span>
<span class="go">upstream/1.8.3-2ubuntu1_longsleep1</span>
</pre></div>
<p>このレポジトリには <code>debian/gbp.conf.in</code> というファイルがあって、gbp (git-buildpackage) 用のブランチやタグの形式が記載されています。</p>
<p>アップストリームのブランチは <code>upstream-X.Y</code> で、debパッケージのブランチは <code>ubuntu-X.Y</code> だということがわかります。 <code>X.Y</code> の部分は <code>debian/changelog</code> ファイルからバージョンを読み取って展開されるようになっています。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> cat debian/gbp.conf.in
<span class="go">[DEFAULT]</span>
<span class="go">debian-branch = ubuntu-X.Y</span>
<span class="go">debian-tag = debian/%(version)s</span>
<span class="go">upstream-branch = upstream-X.Y</span>
<span class="go">upstream-tag = upstream/%(version)s</span>
<span class="go">pristine-tar = True</span>

<span class="go">[git-dch]</span>
<span class="go">meta = 1</span>
</pre></div>
<p>試行錯誤していた時に、 <code>[git-dch]</code> というセクション名は古いので <code>[dch]</code> にせよという主旨の警告が出ました。そこで以下のコマンドを実行して変更しました。</p>
<div class="highlight"><pre><span></span><span class="go">sed -i -e &#39;s/^\[git-dch\]/[dch]/&#39; debian/gbp.conf.in</span>
</pre></div>
<p>さらに以下のコマンドを実行して <code>debian/gbp.conf.in</code> から <code>debian/gbp.conf</code> を生成して上書きします。</p>
<div class="highlight"><pre><span></span><span class="go">debian/rules gencontrol</span>
</pre></div>
<p>変更した <code>debian/gbp.conf.in</code> と <code>debian/gbp.conf</code> をコミットします。</p>
<div class="highlight"><pre><span></span><span class="go">git commit -m &#39;Rename git-dch to dch in debian.gbp.conf.in&#39; debian/gbp.conf.in debian/gbp.conf</span>
</pre></div>
<p><code>ubuntu-1.8</code> ブランチにも上記の変更をマージします。</p>
<div class="highlight"><pre><span></span><span class="go">git checkout ubuntu-1.8</span>
<span class="go">git merge --ff master</span>
</pre></div>
<p><code>upstream-1.8</code> ブランチから <code>upstream-1.9</code> ブランチを、
<code>ubuntu-1.8</code> ブランチから <code>ubuntu-1.9</code> ブランチを作成し、
<code>ubuntu-1.9</code> ブランチに切り替えます。</p>
<div class="highlight"><pre><span></span><span class="go">git branch upstream-1.9 upstream-1.8</span>
<span class="go">git checkout -b ubuntu-1.9 ubuntu-1.8</span>
</pre></div>
<p>以下のコマンドを実行して <code>debian/changelog</code> にエントリを追加します。</p>
<div class="highlight"><pre><span></span><span class="go">gbp dch -R --debian-branch ubuntu-1.9</span>
</pre></div>
<p>エディタ (私の場合は vim) が起動しますので、先頭に追加されたエントリを以下のように編集します。</p>
<div class="highlight"><pre><span></span>golang-1.9 (1.9~rc1-1ubuntu1~hnakamur1-xenial) xenial; urgency=medium

  * New upstream release.

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Sat, 29 Jul 2017 00:38:32 +0900
</pre></div>
<p>以下のコマンドを実行して、ソースパッケージ内のgoのバージョンに依存したファイルを再生成します。</p>
<div class="highlight"><pre><span></span><span class="go">debian/rules gencontrol</span>
</pre></div>
<p>更新したファイルをコミットします。</p>
<div class="highlight"><pre><span></span><span class="go">git add .</span>
<span class="go">git commit -m &#39;Change control file to golang-1.9&#39;</span>
</pre></div>
<p>次に go 1.9rc1 のアップストリームのソースをインポートします。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp import-orig --no-merge --no-interactive <span class="se">\</span>
   --debian-branch<span class="o">=</span>ubuntu-1.9 --upstream-branch<span class="o">=</span>upstream-1.9 <span class="se">\</span>
   --upstream-version<span class="o">=</span><span class="m">1</span>.9~rc1 ~/go1.9rc1.src.tar.gz
<span class="go">gbp:info: Importing &#39;/home/hnakamur/go1.9rc1.src.tar.gz&#39; to branch &#39;upstream-1.9&#39;...</span>
<span class="go">gbp:info: Source package is golang-1.9</span>
<span class="go">gbp:info: Upstream version is 1.9~rc1</span>
<span class="go">gbp:info: Successfully imported version 1.9~rc1 of /home/hnakamur/go1.9rc1.src.tar.gz</span>
</pre></div>
<p><code>ubuntu-1.9</code> ブランチに切り替えて <code>upstream-1.9</code> ブランチの変更をマージします。</p>
<div class="highlight"><pre><span></span><span class="go">git checkout ubuntu-1.9</span>
<span class="go">git merge --no-ff upstream-1.9</span>
</pre></div>
<p>今回作成するdebパッケージのバージョン <code>1.9~rc1-1ubuntu1~hnakamur1-xenial</code> の <code>~</code> を <code>_</code> に置き換えたタグを打っておきます。</p>
<div class="highlight"><pre><span></span><span class="go">git tag upstream/1.9_rc1-1ubuntu1_hnakamur1 upstream-1.9</span>
</pre></div>
<p>さらに <code>master</code> ブランチに <code>upstream-1.9</code> ブランチの内容をマージしておきました。</p>
<div class="highlight"><pre><span></span><span class="go">git checkout master</span>
<span class="go">git merge ubuntu-1.9</span>
</pre></div>
<p>以下のコマンドでソースパッケージをビルドします。</p>
<div class="highlight"><pre><span></span><span class="go">gbp buildpackage --git-pristine-tar-commit --git-export-dir=../build-area --git-debian-branch=ubuntu-1.9 -S -sa</span>
</pre></div>
<p>以下のコマンドでバイナリパッケージをビルドします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo pbuilder build ../build-area/golang-1.9_1.9~rc1-1ubuntu1~hnakamur1-xenial.dsc</span>
</pre></div>
<p><code>/var/cache/pbuilder/result/</code> に生成されたdebファイルを、LXDの新規コンテナにコピー、インストールし、動作確認しました。動作確認と言っても <code>/usr/lib/go-1.9/bin/go version</code> を実行して出力を確認しただけです。</p>
</div>
<div class="section" id="golang-1-9ppa">
<h3>golang-1.9のPPAを作成してソースパッケージをアップロード</h3>
<p><a class="reference external" href="https://launchpad.net/">Launchpad</a> にログインして自分のページに移動して <code>golang-1.9</code> というPPAを作成しました。</p>
<p>すると Uploading packages to this PPA というところに
<code>dput ppa:hnakamur/golang-1.9 &lt;source.changes&gt;</code>
と書かれていますので、以下のコマンドを実行してソースパッケージをアップロードしました。</p>
<div class="highlight"><pre><span></span><span class="go">dput ppa:hnakamur/golang-1.9 ../build-area/golang-1.9_1.9~rc1-1ubuntu1~hnakamur1-xenial_source.changes</span>
</pre></div>
<p>しばらく待ってビルド結果を見ると amd64 は通ったのですが i386 はビルドエラーになっていました。
自分で使うのは amd64 だけなので
<a class="reference external" href="https://hnakamur.github.io/blog/2017/07/18/created-nginx-custom-deb-package/">nginx+luaのカスタムdebパッケージを作ってみた</a>
の「PPAでビルドするアーキテクチャの変更」の手順で i386 は以降のビルド対象から外しました。</p>
</div>
<div class="section" id="go-1-8golang-defaultsgo-1-9">
<h3>go 1.8用のgolang-defaultsパッケージgo 1.9用に改変</h3>
<p>まず、 <code>.dsc</code> ファイルをインポートして自分のレポジトリを作ります。</p>
<div class="highlight"><pre><span></span><span class="go">cd ~/.ghq/github.com/hnakamur</span>
<span class="go">gbp import-dsc --pristine-tar ~/longsleep-go-deb/golang-defaults_1.8~1ubuntu2~xenial.dsc</span>
<span class="go">mv golang-defaults golang-defaults-deb</span>
<span class="go">cd !$</span>
</pre></div>
<p>新しいリリースを <code>gbp dch -R</code> で作ろうとしたらタグが無くてエラーになったので、直接 <code>dch</code> を使うようにしました。</p>
<div class="highlight"><pre><span></span><span class="go">dch -R</span>
</pre></div>
<p>前のエントリ</p>
<div class="highlight"><pre><span></span>golang-defaults (2:1.8~1ubuntu2~xenial) xenial; urgency=medium

  * Backport to 16.04.
  * Use Golang 1.8.

 -- Simon Eisenmann &lt;simon@longsleep.org&gt;  Tue, 03 Jan 2017 16:49:41 +0100
</pre></div>
<p>を参考にして、先頭に追加されたエントリを以下のように編集しました。</p>
<div class="highlight"><pre><span></span>golang-defaults (2:1.9~1ubuntu1~hnakamur1) xenial; urgency=medium

  * Use Golang 1.9.

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Sat, 05 Aug 2017 09:38:34 +0900
</pre></div>
<p>バージョンに対応したタグを打ちます。</p>
<div class="highlight"><pre><span></span><span class="go">git tag debian/1.9_1ubuntu1_hnakamur1</span>
</pre></div>
<p>ソースパッケージをビルドします。</p>
<div class="highlight"><pre><span></span><span class="go">gbp buildpackage --git-export-dir=../build-area -S -sa</span>
</pre></div>
<p>バイナリパッケージをビルドします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo pbuilder build ../build-area/golang-defaults_1.9~1ubuntu1~hnakamur1.dsc</span>
</pre></div>
<p>生成されたバイナリパッケージの中身を確認します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> dpkg -c /var/cache/pbuilder/result/golang-go_1.9~1ubuntu1~hnakamur1_amd64.deb
<span class="go">drwxr-xr-x root/root         0 2017-08-05 09:43 ./</span>
<span class="go">drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/</span>
<span class="go">drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/lib/</span>
<span class="go">drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/share/</span>
<span class="go">drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/share/doc/</span>
<span class="go">drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/share/doc/golang-go/</span>
<span class="go">-rw-r--r-- root/root       870 2017-08-05 09:39 ./usr/share/doc/golang-go/changelog.gz</span>
<span class="go">-rw-r--r-- root/root      2890 2017-08-05 09:39 ./usr/share/doc/golang-go/copyright</span>
<span class="go">drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/bin/</span>
<span class="go">lrwxrwxrwx root/root         0 2017-08-05 09:43 ./usr/lib/go -&gt; go-1.9</span>
<span class="go">lrwxrwxrwx root/root         0 2017-08-05 09:43 ./usr/bin/gofmt -&gt; ../lib/go-1.9/bin/gofmt</span>
<span class="go">lrwxrwxrwx root/root         0 2017-08-05 09:43 ./usr/bin/go -&gt; ../lib/go-1.9/bin/go</span>
</pre></div>
<p>LXDコンテナにパッケージをコピーして動作確認した後、
PPAにソースパッケージをアップロードしてビルドしました。</p>
<div class="highlight"><pre><span></span><span class="go">dput ppa:hnakamur/golang-1.9 ../build-area/golang-defaults_1.9~1ubuntu1~hnakamur1_source.changes</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>おわりに</h2>
<p>使い方は先頭の「今回ビルドしたdebのインストール手順」の項に書いた通りです。
今後、go 1.9.xの新しいリリース候補や正式版が出たら、debパッケージもすぐ更新するつもりです。</p>
<p>一方で dh-make-golang パッケージなどは Simon さんのパッケージに依存していますので、
正式版が出たら Simon さんにも更新をお願いしようと思います。
以前 1.8.3 を Simon さんにメールでお願いしたら数日で作ってくれました。</p>
<p>さらに、goで書かれたコマンドやサーバのうち自分で使うものはdebパッケージを作っていきたいと
考えています。というより、それがしたいからgoのパッケージを作ったわけなので。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>