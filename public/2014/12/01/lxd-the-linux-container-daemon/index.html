<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>LXDを試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2014/12/01/lxd-the-linux-container-daemon/" rel="bookmark"
           title="Permalink to LXDを試してみた">LXDを試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-12-01T00:00:00+09:00">
                Published: 2014-12-01
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/lxc.html">lxc</a> <a href="../../../../tag/lxd.html">lxd</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p>LXDに関するページをいくつか紹介します。</p>
<ul>
<li><a href="https://lists.linuxcontainers.org/pipermail/lxc-users/2014-November/007978.html">[lxc-users] LXD an "hypervisor" for containers (based on liblxc)</a><ul>
<li>LXCメーリングリストに投稿されたLXDのアナウンスメール</li>
</ul>
</li>
<li><a href="http://www.ubuntu.com/cloud/tools/lxd">LXDのホームページ</a></li>
<li><a href="https://github.com/lxc/lxd">lxc/lxd githubレポジトリ</a></li>
<li><a href="https://insights.ubuntu.com/2014/11/04/lxd-the-linux-container-daemon/">Dustin KirklandさんによるLXDの紹介 (2分7秒)</a><ul>
<li>LXDの発音は<a href="https://www.youtube.com/watch?v=U-lXf85Mhno&amp;t=1m18s">1分18秒あたり</a></li>
</ul>
</li>
<li><a href="http://www.zdnet.com/ubuntu-lxd-not-a-docker-replacement-a-docker-enhancement-7000035463/">Ubuntu LXD: Not a Docker replacement, a Docker enhancement | ZDNet</a><ul>
<li>「LXDはdockerを置き換えるものではなく強化するもの」というタイトルの解説記事</li>
</ul>
</li>
</ul>
<p>目指しているのは以下の様なものらしいです。</p>
<ul>
<li>デフォルトでセキュア<ul>
<li>コンテナを非rootユーザで稼働できる</li>
<li>コンテナを隔離して安全に動かせる</li>
</ul>
</li>
<li>コンテナでは単一プロセスを動かすだけではなく完全なOS環境を動かす</li>
<li>リモートのイメージ管理サービスと連携してライブマイグレーションを可能にする</li>
<li>OpenStackとも連携</li>
</ul>
<h2>セットアップ</h2>
<p>Ubuntu 14.04で試しました。
バイナリパッケージをインストールする手順とソースからビルドする手順を書いておきますが、実際に試したのは後者です。正確には最初前者を試したのですが、その後何してよいかドキュメントが見当たらないので後者を試した感じです。</p>
<h3>バイナリパッケージをインストールする手順</h3>
<p><a href="http://www.ubuntu.com/cloud/tools/lxd">The next hypervisor: LXD is fast, secure container management for Linux | Cloud | Ubuntu</a>の"Getting started with LXD"に書いてあります。</p>
<p>add-apt-repositoryを使うため事前にsoftware-properties-commonパッケージをインストールしておく必要があります。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">aptitude</span> <span class="n">install</span> <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span>
</pre></div>


<p>その後以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="k">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">cloud</span><span class="o">-</span><span class="n">archive</span><span class="p">:</span><span class="n">juno</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="k">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="n">nova</span><span class="o">-</span><span class="n">compute</span><span class="o">-</span><span class="n">flex</span>
</pre></div>


<h3>ソースからビルドする手順</h3>
<p><a href="https://github.com/lxc/lxd#installing-the-dependencies">lxc/lxd</a>の手順に従います。</p>
<p>以下のコマンドで依存ライブラリをインストールします。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="n">lxc</span> <span class="n">lxc</span><span class="o">-</span><span class="n">dev</span> <span class="n">mercurial</span> <span class="n">git</span> <span class="n">pkg</span><span class="o">-</span><span class="n">config</span>
</pre></div>


<p>Goをインストールします。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span>
<span class="n">sudo</span> <span class="k">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="n">ppa</span><span class="p">:</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">lxc</span><span class="o">/</span><span class="n">lxd</span><span class="o">-</span><span class="n">daily</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="k">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="k">get</span> <span class="n">install</span> <span class="n">golang</span>
</pre></div>


<p>GOPATHのディレクトリを作成して、GOPATH環境変数を設定します。
以下はbashを使っている想定で ~/.bashrc に追加してシェルを再起動する例です。</p>
<div class="highlight"><pre><span></span><span class="nv">mkdir</span> <span class="o">-</span><span class="nv">p</span> <span class="o">~/</span><span class="nv">go</span>
<span class="nv">echo</span> <span class="s1">&#39;</span><span class="s">export GOPATH=$HOME/go</span><span class="s1">&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">~/</span>.<span class="nv">bashrc</span>
<span class="k">exec</span> $<span class="nv">SHELL</span> <span class="o">-</span><span class="nv">l</span>
</pre></div>


<p>go getしてソースディレクトリに移動してビルドします。</p>
<div class="highlight"><pre><span></span><span class="k">go</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">lxd</span><span class="w"></span>
<span class="n">cd</span><span class="w"> </span><span class="err">$</span><span class="n">GOPATH</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">lxd</span><span class="w"></span>
<span class="k">go</span><span class="w"> </span><span class="k">get</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="p">...</span><span class="w"></span>
<span class="n">make</span><span class="w"></span>
</pre></div>


<p>./lxc/lxcと./lxd/lxdという2つの実行ファイルが作られます。</p>
<div class="highlight"><pre><span></span><span class="n">vagrant</span><span class="nv">@ubuntu</span><span class="o">-</span><span class="mi">1404</span><span class="err">:</span><span class="o">~/</span><span class="k">go</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">lxd</span><span class="err">$</span><span class="w"> </span><span class="k">file</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">lxc</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">lxd</span><span class="o">/</span><span class="n">lxd</span><span class="w"></span>
<span class="p">.</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="nl">lxc</span><span class="p">:</span><span class="w"> </span><span class="n">ELF</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="nc">bit</span><span class="w"> </span><span class="n">LSB</span><span class="w">  </span><span class="n">executable</span><span class="p">,</span><span class="w"> </span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">SYSV</span><span class="p">),</span><span class="w"> </span><span class="n">dynamically</span><span class="w"> </span><span class="n">linked</span><span class="w"> </span><span class="p">(</span><span class="n">uses</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="n">libs</span><span class="p">),</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="mf">2.6.24</span><span class="p">,</span><span class="w"> </span><span class="n">BuildID</span><span class="o">[</span><span class="n">sha1</span><span class="o">]=</span><span class="n">a317752267685a543f724c02c2fb827e03564236</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">stripped</span><span class="w"></span>
<span class="p">.</span><span class="o">/</span><span class="n">lxd</span><span class="o">/</span><span class="nl">lxd</span><span class="p">:</span><span class="w"> </span><span class="n">ELF</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="nc">bit</span><span class="w"> </span><span class="n">LSB</span><span class="w">  </span><span class="n">executable</span><span class="p">,</span><span class="w"> </span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">SYSV</span><span class="p">),</span><span class="w"> </span><span class="n">dynamically</span><span class="w"> </span><span class="n">linked</span><span class="w"> </span><span class="p">(</span><span class="n">uses</span><span class="w"> </span><span class="n">shared</span><span class="w"> </span><span class="n">libs</span><span class="p">),</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="mf">2.6.24</span><span class="p">,</span><span class="w"> </span><span class="n">BuildID</span><span class="o">[</span><span class="n">sha1</span><span class="o">]=</span><span class="mi">8</span><span class="n">f4ff9b64ecda66a2269c18fd5c440620d548da3</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">stripped</span><span class="w"></span>
</pre></div>


<p>lxdはlxdのデーモンです。lxcはlxdに通信するクライアントプログラムです。<a href="http://gopkg.in/lxc/go-lxc.v2">go-lxc.v2 - gopkg.in/lxc/go-lxc.v2</a>というLXCのGoバインディングライブラリを使用しています。</p>
<h2>セットアップ</h2>
<p>ビルド後以下の環境整備が必要です。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">lxd</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="err">$</span><span class="k">USER</span><span class="p">:</span><span class="err">$</span><span class="k">USER</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">lxd</span>
<span class="n">echo</span> <span class="ss">&quot;$USER:1000000:65536&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">subuid</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">subgid</span>
</pre></div>


<h2>使い方</h2>
<h3>lxdの起動</h3>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">lxd</span><span class="o">/</span><span class="n">lxd</span> <span class="o">&amp;</span>
</pre></div>


<h3>lxcのコンテナ作成</h3>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">lxc</span> <span class="k">create</span> <span class="n">iamge</span><span class="p">:</span><span class="n">ubuntu</span> <span class="n">foo</span>
</pre></div>


<p>READMEでは <code>image:ubuntu</code> をつけていませんが、これだと以下の様なエラーになりました。</p>
<div class="highlight"><pre><span></span>$ ./lxc/lxc create baz
error: Only the default ubuntu image is supported. Try <span class="sb">`</span>lxc create images:ubuntu foo<span class="sb">`</span>.
</pre></div>


<h3>lxcのコンテナ起動</h3>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">lxc</span> <span class="k">start</span> <span class="n">foo</span>
</pre></div>


<h3>lxcのコンテナ一覧表示</h3>
<div class="highlight"><pre><span></span>$ ./lxc/lxc
foo
</pre></div>


<p>なお、通常のlxcとはコンテナの管理が別になっているのか(要確認)、 <code>lxc-ls</code> しても fooは表示されませんでした。</p>
<h3>lxcのコンテナ停止</h3>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">lxc</span> <span class="n">stop</span> <span class="n">foo</span>
</pre></div>


<h3>lxcのコンテナ停止</h3>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">lxc</span><span class="o">/</span><span class="n">lxc</span> <span class="k">delete</span> <span class="n">foo</span>
</pre></div>


<h3>lxc shellが未実装！</h3>
<p>コンテナでコマンドを実行してみたいところなのですが、 <code>lxc shell</code> というサブコマンドは未実装だそうです。</p>
<div class="highlight"><pre><span></span>$ .<span class="o">/</span><span class="nv">lxc</span><span class="o">/</span><span class="nv">lxc</span> <span class="nv">help</span>
<span class="nv">Usage</span>: <span class="nv">lxc</span> [<span class="nv">subcommand</span>] [<span class="nv">options</span>]
<span class="nv">Available</span> <span class="nv">commands</span>:
  <span class="nv">config</span>     <span class="o">-</span> <span class="nv">Manage</span> <span class="nv">configuration</span>.
  <span class="nv">create</span>     <span class="o">-</span> <span class="nv">lxc</span> <span class="nv">create</span> <span class="nv">images</span>:<span class="nv">ubuntu</span> <span class="o">&lt;</span><span class="nv">name</span><span class="o">&gt;</span>
  <span class="nv">delete</span>     <span class="o">-</span> <span class="nv">lxc</span> <span class="nv">delete</span> <span class="o">&lt;</span><span class="nv">resource</span><span class="o">&gt;</span>
  <span class="nv">finger</span>     <span class="o">-</span> <span class="nv">Fingers</span> <span class="nv">the</span> <span class="nv">lxd</span> <span class="nv">instance</span> <span class="nv">to</span> <span class="nv">check</span> <span class="k">if</span> <span class="nv">it</span> <span class="nv">is</span> <span class="nv">up</span> <span class="nv">and</span> <span class="nv">working</span>.
  <span class="nv">freeze</span>     <span class="o">-</span> <span class="nv">Changes</span> <span class="nv">a</span> <span class="nv">containers</span> <span class="nv">state</span> <span class="nv">to</span> <span class="nv">freeze</span>.
  <span class="nv">help</span>       <span class="o">-</span> <span class="nv">Presents</span> <span class="nv">details</span> <span class="nv">on</span> <span class="nv">how</span> <span class="nv">to</span> <span class="nv">use</span> <span class="nv">lxd</span>.
  <span class="nv">list</span>       <span class="o">-</span> <span class="nv">Lists</span> <span class="nv">the</span> <span class="nv">available</span> <span class="nv">resources</span>.
  <span class="nv">remote</span>     <span class="o">-</span> <span class="nv">Manage</span> <span class="nv">remote</span> <span class="nv">lxc</span> <span class="nv">servers</span>.
  <span class="nv">restart</span>    <span class="o">-</span> <span class="nv">Changes</span> <span class="nv">a</span> <span class="nv">containers</span> <span class="nv">state</span> <span class="nv">to</span> <span class="nv">restart</span>.
  <span class="nv">shell</span>      <span class="o">-</span> <span class="nv">Start</span> <span class="nv">a</span> <span class="nv">shell</span> <span class="nv">or</span> <span class="nv">specified</span> <span class="nv">command</span> <span class="ss">(</span><span class="nv">NOT</span> <span class="nv">IMPLEMENTED</span><span class="ss">)</span> <span class="nv">in</span> <span class="nv">a</span> <span class="nv">container</span>.
  <span class="nv">start</span>      <span class="o">-</span> <span class="nv">Changes</span> <span class="nv">a</span> <span class="nv">containers</span> <span class="nv">state</span> <span class="nv">to</span> <span class="nv">start</span>.
  <span class="nv">stop</span>       <span class="o">-</span> <span class="nv">Changes</span> <span class="nv">a</span> <span class="nv">containers</span> <span class="nv">state</span> <span class="nv">to</span> <span class="nv">stop</span>.
  <span class="nv">unfreeze</span>   <span class="o">-</span> <span class="nv">Changes</span> <span class="nv">a</span> <span class="nv">containers</span> <span class="nv">state</span> <span class="nv">to</span> <span class="nv">unfreeze</span>.
  <span class="nv">version</span>    <span class="o">-</span> <span class="nv">Prints</span> <span class="nv">the</span> <span class="nv">version</span> <span class="nv">number</span> <span class="nv">of</span> <span class="nv">lxd</span>.
</pre></div>


<p>ソースを見ても <a href="https://github.com/lxc/lxd/blob/a315c07c632188f7d37fa8dbbe3f1b7d87ab34de/lxc/shell.go#L38-L42">lxd/shell.go at a315c07c632188f7d37fa8dbbe3f1b7d87ab34de · lxc/lxd</a> のあたりにTODOと書かれています。</p>
<p>ただ、<a href="https://github.com/lxc/go-lxc">lxc/go-lxc</a>のソースを見ると、コンテナ内でコマンドを実行するための関数はあるのですが、</p>
<p>https://github.com/lxc/go-lxc/blob/bc0a9447e0be56f8e35d0affe83a92e638308e2f/container.go#L422-L423</p>
<div class="highlight"><pre><span></span><span class="o">//</span> <span class="k">Execute</span> <span class="n">executes</span> <span class="n">the</span> <span class="n">given</span> <span class="n">command</span> <span class="k">in</span> <span class="n">a</span> <span class="k">temporary</span> <span class="n">container</span><span class="p">.</span>
<span class="n">func</span> <span class="p">(</span><span class="k">c</span> <span class="o">*</span><span class="n">Container</span><span class="p">)</span> <span class="k">Execute</span><span class="p">(</span><span class="n">args</span> <span class="p">...</span><span class="n">string</span><span class="p">)</span> <span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="err">{</span>
</pre></div>


<p>コマンド実行後に標準出力の結果を戻り値で受け取るようになっています。</p>
<p>シェルを起動してインタラクティブに入出力するには、標準入力、標準出力、標準エラー出力をストリームのようにリアルタイムにやりとりするような関数が必要だと思います。</p>
<h2>おわりに</h2>
<p>早く <code>lxc shell</code> が実装されて欲しいですね！</p>
<p>2015-04-23 追記</p>
<p><a href="/blog/2015/04/23/try-lxd-0.7-with-vagrant/">LXD 0.7ではlxc execでシェルの対話操作もできるようになっていました</a>に書きましたが、 <code>lxc exec コンテナ名 /bin/bash</code> でシェルの対話操作もできるようになっていました。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>