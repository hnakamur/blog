<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>EdgeRouter Lite (ERLite-3)のファームウェアアップデート</title>
        <link rel="stylesheet" href="../../../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../../../content/post/2017/05/03/update-edgerouter-lite-firmware/" rel="bookmark"
           title="Permalink to EdgeRouter Lite (ERLite-3)のファームウェアアップデート">EdgeRouter Lite (ERLite-3)のファームウェアアップデート</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-05-03T07:30:00+09:00">
                Published: 2017-05-03
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../../../tag/edgerouter.html">edgerouter</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="https://misc.mat2uken.net/blog/2015/11/09/edgerouter_lite3.html">17,000円で買えるVyOSっぽいOSが動くルーター EdgeRouter Lite(ERLite-3)を使ってみる — どこか遠くでのんびり怠惰に暮らしたい</a>
を読んで EdgeRouter Lite (ERLite-3)を買いました。</p>
<p>ということで初期設定内容をメモしておきます。今回はファームウェアのアップデートです。</p>
<p>ありがたいことに
<a class="reference external" href="http://edge-os.net/wiki/view/%E6%8E%A5%E7%B6%9A">接続 - EdgeOS 日本語Wiki [非公式]</a>
に非常によくまとまっていました。</p>
</div>
<div class="section" id="id2">
<h2>工場出荷状態の設定</h2>
<ul class="simple">
<li>EdgeRouterのIPアドレスは <code>192.168.1.1</code></li>
<li>DHCPサーバはオフ</li>
<li>SSHサーバはオン</li>
<li>管理者ユーザのIDとパスワードはともに <code>ubnt</code></li>
</ul>
</div>
<div class="section" id="lan">
<h2>LANケーブルで接続</h2>
<p>Windows10が動いているThinkPadにLANケーブルを接続してEdgeRouterのeth0につないで設定しました。
別途WiFiで無線LANにもつないでいます。</p>
<ul class="simple">
<li>コントロールパネル &gt; ネットワークとインターネット &gt; ネットワークで「イーサネット」を選択してポップアップメニューの「プロパティ」を選択します。</li>
<li>「イーサネットのプロパティ」ダイアログが開いたら「ネットワーク」タブの「この接続は次の項目を使用します」のリストで「インターネットプロトコルバージョン 4 (TCP/IPv4)」を選んで「プロパティ」ボタンを押します。</li>
<li><dl class="first docutils">
<dt>「インターネットプロトコルバージョン 4 (TCP/IPv4)のプロパティ」ダイアログで以下のように設定します。</dt>
<dd><ul class="first last">
<li>「次のIPアドレスを使う」ラジオボタンを選択。</li>
<li>「IPアドレス」に <code>192.168.1.2</code> と入力。</li>
<li>「サブネットマスク」に <code>255.255.255.0</code> と入力。</li>
<li>「デフォルトゲートウェイ」に <code>192.168.1.1</code> と入力。</li>
<li>「次のDNSサーバのアドレスを使う」ラジオボタンを選択。</li>
<li>「優先DNSサーバ」と「代替DNSサーバ」のアドレスは空のままにする。</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="web-uisshcli">
<h2>Web UIもしくはsshでCLIに接続</h2>
<p>Web UIの場合はブラウザで <code>https://192.168.1.1</code> を開き、証明書のエラーを無視して進みます。
ブラウザウィンドウ内にログインダイアログが出たら、上記の管理者IDとパスワードを入力します。</p>
<p>右上の「CLI」ボタンを押すと、ブラウザウィンドウ内にCLIのウィンドウが開き、ログインプロンプトが表示されるので、再度上記の管理者IDとパスワードを入力します。</p>
<p>sshでCLIに接続するときは普通にsshコマンドでつなげばOKです。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ssh ubnt@192.168.1.1
<span class="go">Welcome to EdgeOS</span>

<span class="go">By logging in, accessing, or using the Ubiquiti product, you</span>
<span class="go">acknowledge that you have read and understood the Ubiquiti</span>
<span class="go">License Agreement (available in the Web UI at, by default,</span>
<span class="go">http://192.168.1.1) and agree to be bound by its terms.</span>

<span class="go">ubnt@192.168.1.1&#39;s password:</span>
<span class="go">Linux ubnt 2.6.32.13-UBNT #1 SMP Tue Jun 4 14:54:28 PDT 2013 mips64</span>
<span class="go">Welcome to EdgeOS</span>
<span class="gp">ubnt@ubnt:~$</span> ls
<span class="gp">ubnt@ubnt:~$</span> <span class="nb">pwd</span>
<span class="go">/home/ubnt</span>
<span class="gp">ubnt@ubnt:~$</span> <span class="nb">logout</span>
<span class="go">Connection to 192.168.1.1 closed.</span>
</pre></div>
</div>
<div class="section" id="web-ui">
<h2>Web UIからのファームウェアのアップデートは失敗</h2>
<p><a class="reference external" href="https://help.ubnt.com/hc/en-us/articles/205146110-EdgeRouter-Upgrading-EdgeOS-firmware">EdgeRouter - Upgrading EdgeOS firmware – Ubiquiti Networks Support and Help Center</a>
にファームウェアのアップデート手順が書いてあります。
最初はVideo Tutorial (Web GUI)の動画の手順に従ってアップデートしようとしましたが、うまくいきませんでした。試した手順を記録しておきます。</p>
<p>まず、現在のバージョンを確認しておきます。Web GUIの表示は Edge Router Lite v1.2.0 でした。</p>
<p>CLIでも <code>show version</code> コマンドを実行し確認しておきました。</p>
<div class="highlight"><pre><span></span><span class="gp">ubnt@ubnt:~$</span> show version
<span class="go">Version:      v1.2.0</span>
<span class="go">Build ID:     4574253</span>
<span class="go">Build on:     06/26/13 12:48</span>
<span class="go">Copyright:    2012-2013 Ubiquiti Networks, Inc.</span>
<span class="go">HW model:     EdgeRouter Lite 3-Port</span>
<span class="go">HW S/N:       F09FC2104B28</span>
<span class="go">Uptime:       10:34:58 up 35 min,  2 users,  load average: 0.00, 0.00, 0.00</span>
</pre></div>
<p>Web UIの左下のSystemボタンを押すと、設定画面のポップアップが開きます。
&quot;Upgrade System Image&quot; のグループボックス内の &quot;To check for updates go to:&quot; の後のリンクをクリックすると別タブでファームウェアやマニュアルをダウンロードできるページが開きます。
この後は上記の動画とはUIが変わっていました。
左のツリーで EdgeMax &gt; EdgeRouter Lite &gt; ERLite-3 を選んで、右のリストでFIRMWAREの一覧に表示されているファームウェアの行をクリックしてファームウェアをダウンロードします。</p>
<p>2017/04/28に登録された <code>ER-e100.v1.9.1.1.4977347.tar</code> をダウンロードしました。</p>
<p>あとはWeb UIのSystemのポップアップ内の &quot;Upgrade System Image&quot; のグループボックス内の&quot;Upload a file&quot; ボタンを押して、先ほどダウンロードしたファイルを選択してアップロードします。</p>
<p>が、やってみると Upload failed と表示されて失敗してしまいました。</p>
<p>バージョンが飛びすぎなのかと思い、 &quot;SEE PAST FIRMWARE&quot; ボタンを押して過去のファームウェアを表示し、適当に間をとって v1.7.0 をダウンロードして再度試してみました。
しかしやはり失敗でした。</p>
<p>これは1つずつ順番に上げる必要があるのかと思い、v1.2.0の次のv1.3.0でも試してみましたがやはりエラーでした。</p>
</div>
<div class="section" id="cli">
<h2>CLIからのファームウェアのアップデートは成功</h2>
<p>しかたがないのでCLIからアップデートすることにしました。</p>
<p>上記のページの Instructions for Upgrading Via CLI の項ではファームウェアのURLを指定していますが、私はまだルータからインターネットにアクセスできるようにしていないので、上でダウンロードしたファイルを scp でコピーし、CLIからファイル名を指定してアップデートしました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> scp ER-e100.v1.9.1.1.4977347.tar ubnt@192.168.1.1:
<span class="go">...</span>
<span class="gp">$</span> ssh ubnt@192.168.1.1
<span class="go">...</span>
<span class="gp">ubnt@ubnt:~$</span> add system image ER-e100.v1.9.1.1.4977347.tar
<span class="go">Checking upgrade image... Done</span>
<span class="go">Preparing to upgrade... Done</span>
<span class="go">Copying upgrade image... Done</span>
<span class="go">Removing old image... Done</span>
<span class="go">Checking upgrade image... Done</span>
<span class="go">Finishing upgrade... Done</span>
<span class="go">Upgrade completed</span>
</pre></div>
<p>scpでコピーしたファイルはもう不要なので消しておきます。</p>
<div class="highlight"><pre><span></span><span class="gp">ubnt@ubnt:~$</span> rm ER-e100.v1.9.1.1.4977347.tar
</pre></div>
<p>今度は成功しました。現在の状態を確認します。</p>
<div class="highlight"><pre><span></span><span class="gp">ubnt@ubnt:~$</span> show system image
<span class="go">The system currently has the following image(s) installed:</span>

<span class="go">v1.9.1.1.4977347.170426.0359   (default boot)</span>
<span class="go">v1.2.0.4574253.130626.1248     (running image)</span>

<span class="go">A reboot is needed to boot default image</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">ubnt@ubnt:~$</span> show system image storage
<span class="go">Image name                        Read-Only   Read-Write        Total</span>
<span class="go">------------------------------ ------------ ------------ ------------</span>
<span class="go">v1.9.1.1.4977347.170426.0359          78292           56        78348</span>
<span class="go">v1.2.0.4574253.130626.1248            62200        85232       147432</span>
</pre></div>
<p>以下のコマンドで使用するシステムイメージを切り替えます。</p>
<div class="highlight"><pre><span></span><span class="gp">ubnt@ubnt:~$</span> <span class="nb">set</span> system image default-boot
<span class="go">The system currently has the following image(s) installed:</span>

<span class="go">v1.9.1.1.4977347.170426.0359   (default boot)</span>
<span class="go">v1.2.0.4574253.130626.1248     (running image)</span>

<span class="go">A reboot is needed to boot default image</span>
<span class="go">Are you sure you want to switch images? (Yes/No) [Yes]: Yes</span>
<span class="go">Moving images...</span>
<span class="go">Done</span>
<span class="go">Switched from</span>
<span class="go">  Version:      v1.9.1.1.4977347.170426.0359</span>
<span class="go">to</span>
<span class="go">  Version:      v1.2.0.4574253.130626.1248</span>
</pre></div>
<p>と思ったら、既に切り替わっていたのを戻してしまいました。再度実行して新しいバージョンに切り替えました。</p>
<div class="highlight"><pre><span></span><span class="gp">ubnt@ubnt:~$</span> <span class="nb">set</span> system image default-boot
<span class="go">The system currently has the following image(s) installed:</span>

<span class="go">v1.2.0.4574253.130626.1248     (running image) (default boot)</span>
<span class="go">v1.9.1.1.4977347.170426.0359</span>

<span class="go">Are you sure you want to switch images? (Yes/No) [Yes]: Yes</span>
<span class="go">Moving images...</span>
<span class="go">Done</span>
<span class="go">Switched from</span>
<span class="go">  Version:      v1.2.0.4574253.130626.1248</span>
<span class="go">to</span>
<span class="go">  Version:      v1.9.1.1.4977347.170426.0359</span>
</pre></div>
<p><code>reboot</code> コマンドを実行して再起動します。<code>Proceed with reboot? [confirm]</code> と表示されたら <code>y</code> を押します。Enterは不要です。</p>
<div class="highlight"><pre><span></span><span class="gp">ubnt@ubnt:~$</span> reboot
<span class="go">Proceed with reboot? [confirm]y</span>

<span class="go">Broadcast message from root@ubnt (pts/0) (Wed Jun  1 11:26:15 2011):</span>

<span class="go">The system is going down for reboot NOW!</span>

<span class="go">Broadcast message from root@ubnt (pts/0) (Wed Jun  1 11:26:15 2011):</span>

<span class="go">The system is going down for reboot NOW!</span>
<span class="gp">ubnt@ubnt:~$</span> Connection to <span class="m">192</span>.168.1.1 closed by remote host.
<span class="go">Connection to 192.168.1.1 closed.</span>
</pre></div>
<p>再起動が終わったら Web UI を再度開き、画面左上でバージョンを確認すると無事に EdgeRouter Lite v1.9.1.1 となっていました。</p>
</div>
<div class="section" id="id3">
<h2>ファームウェアのアップデート情報</h2>
<p>ファームウェアのアップデート情報は <a class="reference external" href="https://community.ubnt.com/t5/EdgeMAX-Updates-Blog/bg-p/Blog_EdgeMAX">EdgeMAX Updates Blog - Ubiquiti Networks Community</a> を見れば良いそうです。</p>
<p>ページのソースを見ると <a class="reference external" href="https://community.ubnt.com/ubnt/rss/board?board.id=Blog_EdgeMAX">https://community.ubnt.com/ubnt/rss/board?board.id=Blog_EdgeMAX</a> にRSSフィードがありました。
ということでIFTTTでこのRSSフィードが来たらGmailで知らせるように設定してみました。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>