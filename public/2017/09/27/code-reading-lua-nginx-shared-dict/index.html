<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>lua-nginx-moduleのshared dictのコードリーディング</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/09/27/code-reading-lua-nginx-shared-dict/" rel="bookmark"
           title="Permalink to lua-nginx-moduleのshared dictのコードリーディング">lua-nginx-moduleのshared dictのコードリーディング</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-09-27T08:57:00+09:00">
                Published: 2017-09-27
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/nginx.html">nginx</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="https://github.com/openresty/lua-nginx-module">openresty/lua-nginx-module: Embed the Power of Lua into NGINX HTTP servers</a>
の
<a class="reference external" href="https://github.com/openresty/lua-nginx-module#ngxshareddict">ngx.shared.DICT</a>
を使う際
<a class="reference external" href="https://github.com/openresty/lua-nginx-module#lua_shared_dict">lua_shared_dict</a>
ディレクティブで</p>
<div class="highlight"><pre><span></span>http {
    lua_shared_dict dogs 10m;
    ...
}
</pre></div>
<p>のように dict のサイズを指定しますが、容量が足りているかを確認するため実際の使用量をモニタリングしたいと思いました。</p>
<p>systemtap を使った方法
<a class="reference external" href="https://github.com/openresty/openresty-systemtap-toolkit/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/ngx-shm">openresty-systemtap-toolkit/ngx-shm at 97fbeb0bef1aa85e758210d58063376de8eaed31 · openresty/openresty-systemtap-toolkit</a>
が提供されているのは気付いたのですが、FreeBSDなどLinux以外では使えません。</p>
<p>ngx.shared.DICT のソースを見ると nginx の slab allocator を使ってメモリ割り当てを行っていました。
そこで slab allocator の統計情報から使用量を計算するメソッドを ngx.shared.DICT に追加するプルリクエスト
<a class="reference external" href="https://github.com/openresty/lua-nginx-module/pull/1149">Add FFI methods for taking stats to ngx.shared.DICT by hnakamur · Pull Request #1149 · openresty/lua-nginx-module</a>
を書いてみました。これはまだマージされていません。</p>
<p>テストケースを用意して実際に試してみながら、lua-nginx-moduleのshared dict関連とnginxのslab allocatorのコードを読んでみたのでメモです。</p>
<p>対象バージョンは lua-nginx-module は現時点での最新コミット、nginx は 1.13.5 にしました。</p>
<p>(注) この記事は書きかけです。長くなって疲れてきたので途中ですが一旦上げます。</p>
</div>
<div class="section" id="id2">
<h2>lua_shared_dict ディレクティブ関連のコード</h2>
<p><code>lua_shared_dict</code> ディレクティブを処理する関数は <code>ngx_http_lua_shared_dict</code> です。</p>
<p><a class="reference external" href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_module.c#L74-L95">lua-nginx-module/src/ngx_http_lua_module.c#L74-L95</a></p>
<div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">ngx_command_t</span> <span class="n">ngx_http_lua_cmds</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>

    <span class="p">{</span> <span class="n">ngx_string</span><span class="p">(</span><span class="s">&quot;lua_max_running_timers&quot;</span><span class="p">),</span>
      <span class="n">NGX_HTTP_MAIN_CONF</span><span class="o">|</span><span class="n">NGX_CONF_TAKE1</span><span class="p">,</span>
      <span class="n">ngx_conf_set_num_slot</span><span class="p">,</span>
      <span class="n">NGX_HTTP_MAIN_CONF_OFFSET</span><span class="p">,</span>
      <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_http_lua_main_conf_t</span><span class="p">,</span> <span class="n">max_running_timers</span><span class="p">),</span>
      <span class="nb">NULL</span> <span class="p">},</span>

    <span class="p">{</span> <span class="n">ngx_string</span><span class="p">(</span><span class="s">&quot;lua_max_pending_timers&quot;</span><span class="p">),</span>
      <span class="n">NGX_HTTP_MAIN_CONF</span><span class="o">|</span><span class="n">NGX_CONF_TAKE1</span><span class="p">,</span>
      <span class="n">ngx_conf_set_num_slot</span><span class="p">,</span>
      <span class="n">NGX_HTTP_MAIN_CONF_OFFSET</span><span class="p">,</span>
      <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_http_lua_main_conf_t</span><span class="p">,</span> <span class="n">max_pending_timers</span><span class="p">),</span>
      <span class="nb">NULL</span> <span class="p">},</span>

    <span class="p">{</span> <span class="n">ngx_string</span><span class="p">(</span><span class="s">&quot;lua_shared_dict&quot;</span><span class="p">),</span>
      <span class="n">NGX_HTTP_MAIN_CONF</span><span class="o">|</span><span class="n">NGX_CONF_TAKE2</span><span class="p">,</span>
      <span class="n">ngx_http_lua_shared_dict</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span>
      <span class="nb">NULL</span> <span class="p">},</span>
</pre></div>
<p><a class="reference external" href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_directive.c#L73-L155">lua-nginx-module/src/ngx_http_lua_directive.c#L73-L155</a></p>
<p>下記の <code>ngx_http_lua_shared_dict</code> 関数の110行目で <code>ngx_parse_size</code> 関数でshared dictのサイズをパーズして 127行目で <code>ngx_http_lua_shared_memory_add</code> 関数で <code>zone</code> の情報を作成しています。</p>
<p>145～150行目で <code>zone</code> の情報をlua-nginx-moduleの shared dict管理情報の配列 <code>lmcf-&gt;shdict_zones</code> に追加しています。</p>
<p>また142行目で <code>zone-&gt;init</code> に <code>ngx_http_lua_shdict_init_zone</code> 関数を設定しています。</p>
<p><code>zone</code> に対応する共有メモリは後続の nginx の初期化処理で確保します。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="o">*</span>
<span class="nf">ngx_http_lua_shared_dict</span><span class="p">(</span><span class="n">ngx_conf_t</span> <span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="n">ngx_command_t</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_http_lua_main_conf_t</span>   <span class="o">*</span><span class="n">lmcf</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>

    <span class="n">ngx_str_t</span>                  <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>             <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>            <span class="o">**</span><span class="n">zp</span><span class="p">;</span>
    <span class="n">ngx_http_lua_shdict_ctx_t</span>  <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
    <span class="kt">ssize_t</span>                     <span class="n">size</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shdict_zones</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shdict_zones</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_array_t</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shdict_zones</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_array_init</span><span class="p">(</span><span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shdict_zones</span><span class="p">,</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                           <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_shm_zone_t</span> <span class="o">*</span><span class="p">))</span>
            <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">elts</span><span class="p">;</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_conf_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="s">&quot;invalid lua shared dict name </span><span class="se">\&quot;</span><span class="s">%V</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">ngx_parse_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">8191</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_conf_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="s">&quot;invalid lua shared dict size </span><span class="se">\&quot;</span><span class="s">%V</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ngx_pcalloc</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_http_lua_shdict_ctx_t</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">=</span> <span class="n">lmcf</span><span class="p">;</span>
    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="o">-&gt;</span><span class="n">new_log</span><span class="p">;</span>

    <span class="n">zone</span> <span class="o">=</span> <span class="n">ngx_http_lua_shared_memory_add</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">size</span><span class="p">,</span>
                                          <span class="o">&amp;</span><span class="n">ngx_http_lua_module</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

        <span class="n">ngx_conf_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="s">&quot;lua_shared_dict </span><span class="se">\&quot;</span><span class="s">%V</span><span class="se">\&quot;</span><span class="s"> is already defined as &quot;</span>
                           <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%V</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">zone</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="n">ngx_http_lua_shdict_init_zone</span><span class="p">;</span>
    <span class="n">zone</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

    <span class="n">zp</span> <span class="o">=</span> <span class="n">ngx_array_push</span><span class="p">(</span><span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shdict_zones</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zone</span><span class="p">;</span>

    <span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">requires_shm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">NGX_CONF_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>上記の145行目の <code>lmcf</code> に対応する <code>ngx_http_lua_main_conf_s</code> 構造体の定義は以下のようになっています。</p>
<p><a class="reference external" href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_common.h#L163-L234">lua-nginx-module/src/ngx_http_lua_common.h#L163-L234</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">ngx_http_lua_main_conf_s</span> <span class="p">{</span>
    <span class="n">lua_State</span>           <span class="o">*</span><span class="n">lua</span><span class="p">;</span>

    <span class="n">ngx_str_t</span>            <span class="n">lua_path</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>            <span class="n">lua_cpath</span><span class="p">;</span>

    <span class="n">ngx_cycle_t</span>         <span class="o">*</span><span class="n">cycle</span><span class="p">;</span>
    <span class="n">ngx_pool_t</span>          <span class="o">*</span><span class="n">pool</span><span class="p">;</span>

    <span class="n">ngx_int_t</span>            <span class="n">max_pending_timers</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>            <span class="n">pending_timers</span><span class="p">;</span>

    <span class="n">ngx_int_t</span>            <span class="n">max_running_timers</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>            <span class="n">running_timers</span><span class="p">;</span>

    <span class="n">ngx_connection_t</span>    <span class="o">*</span><span class="n">watcher</span><span class="p">;</span>  <span class="cm">/* for watching the process exit event */</span>

<span class="cp">#if (NGX_PCRE)</span>
    <span class="n">ngx_int_t</span>            <span class="n">regex_cache_entries</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>            <span class="n">regex_cache_max_entries</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>            <span class="n">regex_match_limit</span><span class="p">;</span>

<span class="cp">#if (LUA_HAVE_PCRE_JIT)</span>
    <span class="n">pcre_jit_stack</span>      <span class="o">*</span><span class="n">jit_stack</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#endif</span>

    <span class="n">ngx_array_t</span>         <span class="o">*</span><span class="n">shm_zones</span><span class="p">;</span>  <span class="cm">/* of ngx_shm_zone_t* */</span>

    <span class="n">ngx_array_t</span>         <span class="o">*</span><span class="n">shdict_zones</span><span class="p">;</span> <span class="cm">/* shm zones of &quot;shdict&quot; */</span>

    <span class="n">ngx_array_t</span>         <span class="o">*</span><span class="n">preload_hooks</span><span class="p">;</span> <span class="cm">/* of ngx_http_lua_preload_hook_t */</span>

    <span class="n">ngx_flag_t</span>           <span class="n">postponed_to_rewrite_phase_end</span><span class="p">;</span>
    <span class="n">ngx_flag_t</span>           <span class="n">postponed_to_access_phase_end</span><span class="p">;</span>

    <span class="n">ngx_http_lua_main_conf_handler_pt</span>    <span class="n">init_handler</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>                            <span class="n">init_src</span><span class="p">;</span>

    <span class="n">ngx_http_lua_main_conf_handler_pt</span>    <span class="n">init_worker_handler</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>                            <span class="n">init_worker_src</span><span class="p">;</span>

    <span class="n">ngx_http_lua_balancer_peer_data_t</span>      <span class="o">*</span><span class="n">balancer_peer_data</span><span class="p">;</span>
                    <span class="cm">/* balancer_by_lua does not support yielding and</span>
<span class="cm">                     * there cannot be any conflicts among concurrent requests,</span>
<span class="cm">                     * thus it is safe to store the peer data in the main conf.</span>
<span class="cm">                     */</span>

    <span class="n">ngx_uint_t</span>                      <span class="n">shm_zones_inited</span><span class="p">;</span>

    <span class="n">ngx_http_lua_sema_mm_t</span>         <span class="o">*</span><span class="n">sema_mm</span><span class="p">;</span>

    <span class="n">ngx_uint_t</span>           <span class="n">malloc_trim_cycle</span><span class="p">;</span>  <span class="cm">/* a cycle is defined as the number</span>
<span class="cm">                                                of reqeusts */</span>
    <span class="n">ngx_uint_t</span>           <span class="n">malloc_trim_req_count</span><span class="p">;</span>

<span class="cp">#if nginx_version &gt;= 1011011</span>
    <span class="cm">/* the following 2 fields are only used by ngx.req.raw_headers() for now */</span>
    <span class="n">ngx_buf_t</span>          <span class="o">**</span><span class="n">busy_buf_ptrs</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>            <span class="n">busy_buf_ptr_count</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="kt">unsigned</span>             <span class="nl">requires_header_filter</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_body_filter</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_capture_filter</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_rewrite</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_access</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_log</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_shm</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_capture_log</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p>次に <code>ngx_http_lua_shared_memory_add</code> 関数の実装を見ていきます。</p>
<p><a class="reference external" href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_api.c#L86-L152">lua-nginx-module/src/ngx_http_lua_api.c#L86-L152</a></p>
<p>115行目の <code>ngx_shared_memory_add</code> 関数で <code>zone</code> を作り、127行目で <code>ctx</code> 用のメモリを割りあてて 136行目で <code>ctx-&gt;zone</code> に <code>zone</code> の内容をコピーして 151行目で関数の戻り値として返しています。</p>
<p>138～143行目で lua-nginx-module で共有メモリのゾーンを管理する配列 <code>lmcf-&gt;shm_zones</code> に要素を追加しています。</p>
<p>また、146行目で <code>zone-&gt;init</code> に <code>ngx_http_lua_shared_memory_init</code> 関数を設定しています。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">ngx_shm_zone_t</span> <span class="o">*</span>
<span class="nf">ngx_http_lua_shared_memory_add</span><span class="p">(</span><span class="n">ngx_conf_t</span> <span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="n">ngx_str_t</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_http_lua_main_conf_t</span>     <span class="o">*</span><span class="n">lmcf</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>              <span class="o">**</span><span class="n">zp</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>               <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
    <span class="n">ngx_http_lua_shm_zone_ctx_t</span>  <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>                     <span class="n">n</span><span class="p">;</span>

    <span class="n">lmcf</span> <span class="o">=</span> <span class="n">ngx_http_conf_get_module_main_conf</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">ngx_http_lua_module</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shm_zones</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shm_zones</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_array_t</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shm_zones</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_array_init</span><span class="p">(</span><span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shm_zones</span><span class="p">,</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                           <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_shm_zone_t</span> <span class="o">*</span><span class="p">))</span>
            <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">zone</span> <span class="o">=</span> <span class="n">ngx_shared_memory_add</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">size</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_http_lua_shm_zone_ctx_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_http_lua_shm_zone_ctx_t</span><span class="p">);</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ngx_pcalloc</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">lmcf</span> <span class="o">=</span> <span class="n">lmcf</span><span class="p">;</span>
    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="o">-&gt;</span><span class="n">new_log</span><span class="p">;</span>
    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cycle</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">;</span>

    <span class="n">ngx_memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_shm_zone_t</span><span class="p">));</span>

    <span class="n">zp</span> <span class="o">=</span> <span class="n">ngx_array_push</span><span class="p">(</span><span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shm_zones</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zone</span><span class="p">;</span>

    <span class="cm">/* set zone init */</span>
    <span class="n">zone</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="n">ngx_http_lua_shared_memory_init</span><span class="p">;</span>
    <span class="n">zone</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

    <span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">requires_shm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_cycle.c#L1204-L1274">nginx/src/core/ngx_cycle.c#L1204-L1274</a></p>
<p>下記の <code>ngx_shared_memory_add</code> 関数の1264行目で <code>zone-&gt;data</code> に <code>NULL</code> を設定していますので、上記の関数 <code>ngx_http_lua_shared_memory_add</code> では 120行目の <code>if</code> の条件は <code>false</code> になり、125行目以降が実行されることになります。</p>
<p><code>ngx_shared_memory_add</code> の1258～1271でnginxで共有メモリを管理しているリスト <code>cf-&gt;cycle-&gt;shared_memory</code> に共有メモリの管理情報を追加しています。</p>
<p>実際に共有メモリを割り当てるのは後述の <code>ngx_shm_alloc</code> 関数です。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214
1215
1216
1217
1218
1219
1220
1221
1222
1223
1224
1225
1226
1227
1228
1229
1230
1231
1232
1233
1234
1235
1236
1237
1238
1239
1240
1241
1242
1243
1244
1245
1246
1247
1248
1249
1250
1251
1252
1253
1254
1255
1256
1257
1258
1259
1260
1261
1262
1263
1264
1265
1266
1267
1268
1269
1270
1271
1272
1273
1274</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">ngx_shm_zone_t</span> <span class="o">*</span>
<span class="nf">ngx_shared_memory_add</span><span class="p">(</span><span class="n">ngx_conf_t</span> <span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="n">ngx_str_t</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_uint_t</span>        <span class="n">i</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>   <span class="o">*</span><span class="n">shm_zone</span><span class="p">;</span>
    <span class="n">ngx_list_part_t</span>  <span class="o">*</span><span class="n">part</span><span class="p">;</span>

    <span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="o">-&gt;</span><span class="n">shared_memory</span><span class="p">.</span><span class="n">part</span><span class="p">;</span>
    <span class="n">shm_zone</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">elts</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* void */</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nelts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">shm_zone</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">elts</span><span class="p">;</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_strncmp</span><span class="p">(</span><span class="n">name</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
            <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_conf_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s">&quot;the shared memory zone </span><span class="se">\&quot;</span><span class="s">%V</span><span class="se">\&quot;</span><span class="s"> is &quot;</span>
                            <span class="s">&quot;already declared for a different use&quot;</span><span class="p">,</span>
                            <span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_conf_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s">&quot;the size %uz of shared memory zone </span><span class="se">\&quot;</span><span class="s">%V</span><span class="se">\&quot;</span><span class="s"> &quot;</span>
                            <span class="s">&quot;conflicts with already declared size %uz&quot;</span><span class="p">,</span>
                            <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="n">shm_zone</span> <span class="o">=</span> <span class="n">ngx_list_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="o">-&gt;</span><span class="n">shared_memory</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">exists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">noreuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">shm_zone</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>ngx_http_lua_shared_memory_init</code> 関数の実装です。</p>
<p><a class="reference external" href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_api.c#L155-L214">lua-nginx-module/src/ngx_http_lua_api.c#L155-L214</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">ngx_int_t</span>
<span class="nf">ngx_http_lua_shared_memory_init</span><span class="p">(</span><span class="n">ngx_shm_zone_t</span> <span class="o">*</span><span class="n">shm_zone</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_http_lua_shm_zone_ctx_t</span> <span class="o">*</span><span class="n">octx</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>              <span class="o">*</span><span class="n">ozone</span><span class="p">;</span>
    <span class="kt">void</span>                        <span class="o">*</span><span class="n">odata</span><span class="p">;</span>

    <span class="n">ngx_int_t</span>                    <span class="n">rc</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="n">ngx_cycle_t</span>        <span class="o">*</span><span class="n">saved_cycle</span><span class="p">;</span>
    <span class="n">ngx_http_lua_main_conf_t</span>    <span class="o">*</span><span class="n">lmcf</span><span class="p">;</span>
    <span class="n">ngx_http_lua_shm_zone_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>              <span class="o">*</span><span class="n">zone</span><span class="p">;</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_http_lua_shm_zone_ctx_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="n">zone</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">;</span>

    <span class="n">odata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">octx</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ozone</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">octx</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">;</span>
        <span class="n">odata</span> <span class="o">=</span> <span class="n">ozone</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">zone</span><span class="o">-&gt;</span><span class="n">shm</span> <span class="o">=</span> <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">;</span>
<span class="cp">#if defined(nginx_version) &amp;&amp; nginx_version &gt;= 1009000</span>
    <span class="n">zone</span><span class="o">-&gt;</span><span class="n">noreuse</span> <span class="o">=</span> <span class="n">shm_zone</span><span class="o">-&gt;</span><span class="n">noreuse</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">odata</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">dd</span><span class="p">(</span><span class="s">&quot;get lmcf&quot;</span><span class="p">);</span>

    <span class="n">lmcf</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">lmcf</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">dd</span><span class="p">(</span><span class="s">&quot;lmcf-&gt;lua: %p&quot;</span><span class="p">,</span> <span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">lua</span><span class="p">);</span>

    <span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shm_zones_inited</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shm_zones_inited</span> <span class="o">==</span> <span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">shm_zones</span><span class="o">-&gt;</span><span class="n">nelts</span>
        <span class="o">&amp;&amp;</span> <span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">init_handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">saved_cycle</span> <span class="o">=</span> <span class="n">ngx_cycle</span><span class="p">;</span>
        <span class="n">ngx_cycle</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">;</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">init_handler</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="n">lmcf</span><span class="p">,</span> <span class="n">lmcf</span><span class="o">-&gt;</span><span class="n">lua</span><span class="p">);</span>

        <span class="n">ngx_cycle</span> <span class="o">=</span> <span class="n">saved_cycle</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* an error happened */</span>
            <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>ngx_shm_zone_t</code> 構造体の定義です。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_cycle.h#L25-L35">nginx/src/core/ngx_cycle.h#L25-L35</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ngx_shm_zone_s</span>  <span class="n">ngx_shm_zone_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">ngx_int_t</span> <span class="p">(</span><span class="o">*</span><span class="n">ngx_shm_zone_init_pt</span><span class="p">)</span> <span class="p">(</span><span class="n">ngx_shm_zone_t</span> <span class="o">*</span><span class="n">zone</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ngx_shm_zone_s</span> <span class="p">{</span>
    <span class="kt">void</span>                     <span class="o">*</span><span class="n">data</span><span class="p">;</span>
    <span class="n">ngx_shm_t</span>                 <span class="n">shm</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_init_pt</span>      <span class="n">init</span><span class="p">;</span>
    <span class="kt">void</span>                     <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>                <span class="n">noreuse</span><span class="p">;</span>  <span class="cm">/* unsigned  noreuse:1; */</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><code>ngx_shm_t</code> 構造体の定義です。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/os/unix/ngx_shmem.h#L16-L26">nginx/os/unix/ngx_shmem.h#L16-L26</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>16
17
18
19
20
21
22
23
24
25
26</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">u_char</span>      <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
    <span class="kt">size_t</span>       <span class="n">size</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>    <span class="n">name</span><span class="p">;</span>
    <span class="n">ngx_log_t</span>   <span class="o">*</span><span class="n">log</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>   <span class="n">exists</span><span class="p">;</span>   <span class="cm">/* unsigned  exists:1;  */</span>
<span class="p">}</span> <span class="n">ngx_shm_t</span><span class="p">;</span>


<span class="n">ngx_int_t</span> <span class="nf">ngx_shm_alloc</span><span class="p">(</span><span class="n">ngx_shm_t</span> <span class="o">*</span><span class="n">shm</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">ngx_shm_free</span><span class="p">(</span><span class="n">ngx_shm_t</span> <span class="o">*</span><span class="n">shm</span><span class="p">);</span>
</pre></div>
</td></tr></table><p><code>ngx_http_lua_shm_zone_ctx_t</code> 構造体などの定義です。</p>
<p><a class="reference external" href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_shdict.h#L14-L55">lua-nginx-module/src/ngx_http_lua_shdict.h#L14-L55</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">u_char</span>                       <span class="n">color</span><span class="p">;</span>
    <span class="kt">uint8_t</span>                      <span class="n">value_type</span><span class="p">;</span>
    <span class="n">u_short</span>                      <span class="n">key_len</span><span class="p">;</span>
    <span class="kt">uint32_t</span>                     <span class="n">value_len</span><span class="p">;</span>
    <span class="kt">uint64_t</span>                     <span class="n">expires</span><span class="p">;</span>
    <span class="n">ngx_queue_t</span>                  <span class="n">queue</span><span class="p">;</span>
    <span class="kt">uint32_t</span>                     <span class="n">user_flags</span><span class="p">;</span>
    <span class="n">u_char</span>                       <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">ngx_http_lua_shdict_node_t</span><span class="p">;</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_queue_t</span>                  <span class="n">queue</span><span class="p">;</span>
    <span class="kt">uint32_t</span>                     <span class="n">value_len</span><span class="p">;</span>
    <span class="kt">uint8_t</span>                      <span class="n">value_type</span><span class="p">;</span>
    <span class="n">u_char</span>                       <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span> <span class="n">ngx_http_lua_shdict_list_node_t</span><span class="p">;</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_rbtree_t</span>                  <span class="n">rbtree</span><span class="p">;</span>
    <span class="n">ngx_rbtree_node_t</span>             <span class="n">sentinel</span><span class="p">;</span>
    <span class="n">ngx_queue_t</span>                   <span class="n">lru_queue</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_http_lua_shdict_shctx_t</span><span class="p">;</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_http_lua_shdict_shctx_t</span>  <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
    <span class="n">ngx_slab_pool_t</span>              <span class="o">*</span><span class="n">shpool</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>                     <span class="n">name</span><span class="p">;</span>
    <span class="n">ngx_http_lua_main_conf_t</span>     <span class="o">*</span><span class="n">main_conf</span><span class="p">;</span>
    <span class="n">ngx_log_t</span>                    <span class="o">*</span><span class="n">log</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_http_lua_shdict_ctx_t</span><span class="p">;</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_log_t</span>                   <span class="o">*</span><span class="n">log</span><span class="p">;</span>
    <span class="n">ngx_http_lua_main_conf_t</span>    <span class="o">*</span><span class="n">lmcf</span><span class="p">;</span>
    <span class="n">ngx_cycle_t</span>                 <span class="o">*</span><span class="n">cycle</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>               <span class="n">zone</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_http_lua_shm_zone_ctx_t</span><span class="p">;</span>
</pre></div>
</td></tr></table><p>今回注目するのは <code>ngx_http_lua_shdict_ctx_t</code> 構造体の <code>shpool</code> の <code>ngx_slab_pool_t</code> 構造体です。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.h#L16-L69">nginx/src/core/ngx_slab.h#L16-L69</a></p>
<p><code>ngx_slab_pool_t</code> 構造体の <code>stats</code> フィールド <code>ngx_slab_stat_t</code> 構造体にメモリ割り当ての回数 <code>used</code> とメモリ割り当て合計バイト数 <code>total</code> があり、 <code>total</code> からメモリ使用量を計算できます。 詳細は後ほど見ていきます。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ngx_slab_page_s</span>  <span class="n">ngx_slab_page_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ngx_slab_page_s</span> <span class="p">{</span>
    <span class="kt">uintptr_t</span>         <span class="n">slab</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="kt">uintptr_t</span>         <span class="n">prev</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_uint_t</span>        <span class="n">total</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">used</span><span class="p">;</span>

    <span class="n">ngx_uint_t</span>        <span class="n">reqs</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">fails</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_slab_stat_t</span><span class="p">;</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_shmtx_sh_t</span>    <span class="n">lock</span><span class="p">;</span>

    <span class="kt">size_t</span>            <span class="n">min_size</span><span class="p">;</span>
    <span class="kt">size_t</span>            <span class="n">min_shift</span><span class="p">;</span>

    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">pages</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">last</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>   <span class="n">free</span><span class="p">;</span>

    <span class="n">ngx_slab_stat_t</span>  <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">pfree</span><span class="p">;</span>

    <span class="n">u_char</span>           <span class="o">*</span><span class="n">start</span><span class="p">;</span>
    <span class="n">u_char</span>           <span class="o">*</span><span class="n">end</span><span class="p">;</span>

    <span class="n">ngx_shmtx_t</span>       <span class="n">mutex</span><span class="p">;</span>

    <span class="n">u_char</span>           <span class="o">*</span><span class="n">log_ctx</span><span class="p">;</span>
    <span class="n">u_char</span>            <span class="n">zero</span><span class="p">;</span>

    <span class="kt">unsigned</span>          <span class="nl">log_nomem</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>

    <span class="kt">void</span>             <span class="o">*</span><span class="n">data</span><span class="p">;</span>
    <span class="kt">void</span>             <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_slab_pool_t</span><span class="p">;</span>


<span class="kt">void</span> <span class="nf">ngx_slab_sizes_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">ngx_slab_init</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">ngx_slab_alloc</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">ngx_slab_alloc_locked</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">ngx_slab_calloc</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">ngx_slab_calloc_locked</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">ngx_slab_free</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">ngx_slab_free_locked</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="ngx-slab-sizes-init">
<h2>ngx_slab_sizes_init 関数のコード</h2>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L80-L95">nginx/src/core/ngx_slab.c#L80-L95</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">ngx_uint_t</span>  <span class="n">ngx_slab_max_size</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ngx_uint_t</span>  <span class="n">ngx_slab_exact_size</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ngx_uint_t</span>  <span class="n">ngx_slab_exact_shift</span><span class="p">;</span>


<span class="kt">void</span>
<span class="nf">ngx_slab_sizes_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_uint_t</span>  <span class="n">n</span><span class="p">;</span>

    <span class="n">ngx_slab_max_size</span> <span class="o">=</span> <span class="n">ngx_pagesize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">ngx_slab_exact_size</span> <span class="o">=</span> <span class="n">ngx_pagesize</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ngx_slab_exact_size</span><span class="p">;</span> <span class="n">n</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ngx_slab_exact_shift</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* void */</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>ngx_slab_sizes_init</code> は <code>main</code> 関数の280行目から呼ばれています。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/nginx.c#L264-L298">nginx/nginx.c at release-1.13.5 · nginx/nginx</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ngx_os_init</span><span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * ngx_crc32_table_init() requires ngx_cacheline_size set in ngx_os_init()</span>
<span class="cm">     */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ngx_crc32_table_init</span><span class="p">()</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/*</span>
<span class="cm">     * ngx_slab_sizes_init() requires ngx_pagesize set in ngx_os_init()</span>
<span class="cm">     */</span>

    <span class="n">ngx_slab_sizes_init</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ngx_add_inherited_sockets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_cycle</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ngx_preinit_modules</span><span class="p">()</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">cycle</span> <span class="o">=</span> <span class="n">ngx_init_cycle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_cycle</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_test_config</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_log_stderr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;configuration file %s test failed&quot;</span><span class="p">,</span>
                           <span class="n">init_cycle</span><span class="p">.</span><span class="n">conf_file</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table><p><code>ngx_slab_sizes_init: 内で参照している :code:`ngx_pagesize</code> は以下の場所で定義されています。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/os/unix/ngx_alloc.c#L12-L14">nginx/ngx_alloc.c at release-1.13.5 · nginx/nginx</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">ngx_uint_t</span>  <span class="n">ngx_pagesize</span><span class="p">;</span>
<span class="n">ngx_uint_t</span>  <span class="n">ngx_pagesize_shift</span><span class="p">;</span>
<span class="n">ngx_uint_t</span>  <span class="n">ngx_cacheline_size</span><span class="p">;</span>
</pre></div>
</td></tr></table><p><code>ngx_pagesize</code> は下記の <code>ngx_os_init</code> 関数内の
50行目で
<a class="reference external" href="http://man7.org/linux/man-pages/man2/getpagesize.2.html">getpagesize(2) - Linux manual page</a>
の値で初期化されています。
また <code>ngx_pagesize_shift</code> は53行目で 12 になります。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/os/unix/ngx_posix_init.c#L50-L53">nginx/src/os/unix/ngx_posix_init.c#L50-L53</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="n">ngx_pagesize</span> <span class="o">=</span> <span class="n">getpagesize</span><span class="p">();</span>
    <span class="n">ngx_cacheline_size</span> <span class="o">=</span> <span class="n">NGX_CPU_CACHE_LINE</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ngx_pagesize</span><span class="p">;</span> <span class="n">n</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ngx_pagesize_shift</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* void */</span> <span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="http://man7.org/linux/man-pages/man1/getconf.1p.html">getconf.1p - Linux manual page</a>
と
<a class="reference external" href="http://man7.org/linux/man-pages/man3/sysconf.3.html">sysconf(3) - Linux manual page</a>
を見て Ubuntu 16.04 環境で試したところ <code>getconf PAGESIZE</code> または <code>getconf PAGE_SIZE</code> で取得できました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> getconf PAGESIZE
<span class="go">4096</span>
<span class="gp">$</span> getconf PAGE_SIZE
<span class="go">4096</span>
</pre></div>
<p>詳細は省略しますがデバッグ版のnginxをgdbで動かして
<code>ngx_slab_max_size</code>, <code>ngx_slab_exact_size</code>, <code>ngx_slab_exact_shift</code> の値を確認すると以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="go">(gdb) break ngx_slab_sizes_init</span>
<span class="go">Breakpoint 1 at 0x426fdc: file src/core/ngx_slab.c, line 90.</span>
<span class="go">(gdb) run</span>
<span class="go">...</span>
<span class="go">Breakpoint 1, ngx_slab_sizes_init () at src/core/ngx_slab.c:90</span>
<span class="go">90          ngx_slab_max_size = ngx_pagesize / 2;</span>
<span class="go">(gdb) n</span>
<span class="go">91          ngx_slab_exact_size = ngx_pagesize / (8 * sizeof(uintptr_t));</span>
<span class="go">(gdb) n</span>
<span class="go">92          for (n = ngx_slab_exact_size; n &gt;&gt;= 1; ngx_slab_exact_shift++) {</span>
<span class="go">(gdb) n</span>
<span class="go">main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at src/core/nginx.c:282</span>
<span class="go">282         if (ngx_add_inherited_sockets(&amp;init_cycle) != NGX_OK) {</span>
<span class="go">(gdb) print ngx_slab_max_size</span>
<span class="gp">$</span><span class="nv">1</span> <span class="o">=</span> <span class="m">2048</span>
<span class="go">(gdb) print ngx_slab_exact_size</span>
<span class="gp">$</span><span class="nv">2</span> <span class="o">=</span> <span class="m">64</span>
<span class="go">(gdb) print ngx_slab_exact_shift</span>
<span class="gp">$</span><span class="nv">3</span> <span class="o">=</span> <span class="m">6</span>
</pre></div>
</div>
<div class="section" id="ngx-slab-init">
<h2>ngx_slab_init 関数のコード</h2>
<p><code>ngx_slab_init</code> 関数は上記に引用した <code>main</code> 関数の290行目から呼ばれる
<code>ngx_init_cycle</code> 関数の482行目を経由して <code>ngx_init_zone_pool</code> 関数から呼ばれます。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_cycle.c#L404-L493">nginx/src/core/ngx_cycle.c#L404-L493</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="cm">/* create shared memory */</span>

    <span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cycle</span><span class="o">-&gt;</span><span class="n">shared_memory</span><span class="p">.</span><span class="n">part</span><span class="p">;</span>
    <span class="n">shm_zone</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">elts</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* void */</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nelts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">shm_zone</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">elts</span><span class="p">;</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                          <span class="s">&quot;zero size shared memory zone </span><span class="se">\&quot;</span><span class="s">%V</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
                          <span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">cycle</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">;</span>

        <span class="n">opart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">old_cycle</span><span class="o">-&gt;</span><span class="n">shared_memory</span><span class="p">.</span><span class="n">part</span><span class="p">;</span>
        <span class="n">oshm_zone</span> <span class="o">=</span> <span class="n">opart</span><span class="o">-&gt;</span><span class="n">elts</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* void */</span> <span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">opart</span><span class="o">-&gt;</span><span class="n">nelts</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">opart</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">opart</span> <span class="o">=</span> <span class="n">opart</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">oshm_zone</span> <span class="o">=</span> <span class="n">opart</span><span class="o">-&gt;</span><span class="n">elts</span><span class="p">;</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">len</span> <span class="o">!=</span> <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ngx_strncmp</span><span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
                            <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
                            <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
                <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tag</span> <span class="o">==</span> <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">tag</span>
                <span class="o">&amp;&amp;</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span>
                <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">noreuse</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
<span class="cp">#if (NGX_WIN32)</span>
                <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">shm</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
<span class="cp">#endif</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">data</span><span class="p">)</span>
                    <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">goto</span> <span class="n">shm_zone_found</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">ngx_shm_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">shm</span><span class="p">);</span>

            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_shm_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">shm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_init_zone_pool</span><span class="p">(</span><span class="n">cycle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="nl">shm_zone_found</span><span class="p">:</span>

        <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_cycle.c#L868-L930">nginx/src/core/ngx_cycle.c#L868-L930</a></p>
<p>下記の <code>ngx_init_zone_pool</code> 関数の905行目で <code>ngx_slab_pool_t</code> の <code>min_shift</code> が <code>3</code> に初期化されています。</p>
<p>927行目で <code>ngx_slab_init</code> 関数を呼び出しています。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>868
869
870
871
872
873
874
875
876
877
878
879
880
881
882
883
884
885
886
887
888
889
890
891
892
893
894
895
896
897
898
899
900
901
902
903
904
905
906
907
908
909
910
911
912
913
914
915
916
917
918
919
920
921
922
923
924
925
926
927
928
929
930</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">ngx_int_t</span>
<span class="nf">ngx_init_zone_pool</span><span class="p">(</span><span class="n">ngx_cycle_t</span> <span class="o">*</span><span class="n">cycle</span><span class="p">,</span> <span class="n">ngx_shm_zone_t</span> <span class="o">*</span><span class="n">zn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span>           <span class="o">*</span><span class="n">file</span><span class="p">;</span>
    <span class="n">ngx_slab_pool_t</span>  <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

    <span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zn</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">zn</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">exists</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">==</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
        <span class="p">}</span>

<span class="cp">#if (NGX_WIN32)</span>

        <span class="cm">/* remap at the required address */</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_shm_remap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zn</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zn</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">==</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
        <span class="p">}</span>

<span class="cp">#endif</span>

        <span class="n">ngx_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cycle</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="s">&quot;shared zone </span><span class="se">\&quot;</span><span class="s">%V</span><span class="se">\&quot;</span><span class="s"> has no equal addresses: %p vs %p&quot;</span><span class="p">,</span>
                      <span class="o">&amp;</span><span class="n">zn</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sp</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">zn</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="n">zn</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">min_shift</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">zn</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

<span class="cp">#if (NGX_HAVE_ATOMIC_OPS)</span>

    <span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#else</span>

    <span class="n">file</span> <span class="o">=</span> <span class="n">ngx_pnalloc</span><span class="p">(</span><span class="n">cycle</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">cycle</span><span class="o">-&gt;</span><span class="n">lock_file</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="n">zn</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ngx_sprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s">&quot;%V%V%Z&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cycle</span><span class="o">-&gt;</span><span class="n">lock_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zn</span><span class="o">-&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ngx_shmtx_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">!=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ngx_slab_init</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L98-L165">nginx/src/core/ngx_slab.c#L98-L165</a></p>
<p>上記で <code>pool-&gt;min_shift</code> は <code>3</code> に設定されていますので、
107行目で <code>pool-&gt;min_size</code> は <code>8</code> になります。</p>
<p>116行目の <code>n</code> は <code>12 - 3</code> で <code>9</code> になります。</p>
<p>118行目以降はまた後で読むので、ここでは一旦スキップします。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">ngx_slab_init</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span>           <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">size_t</span>            <span class="n">size</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>         <span class="n">m</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">slots</span><span class="p">,</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">min_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">min_shift</span><span class="p">;</span>

    <span class="n">slots</span> <span class="o">=</span> <span class="n">ngx_slab_slots</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>

    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">slots</span><span class="p">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>

    <span class="n">ngx_slab_junk</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">ngx_pagesize_shift</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">min_shift</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* only &quot;next&quot; is used in list head */</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">p</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">);</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_stat_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_memzero</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">));</span>

    <span class="n">p</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">);</span>

    <span class="n">size</span> <span class="o">-=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">));</span>

    <span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_uint_t</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)));</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_page_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_memzero</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">));</span>

    <span class="n">page</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span>

    <span class="cm">/* only &quot;next&quot; is used in list head */</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">;</span>
    <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">),</span>
                                <span class="n">ngx_pagesize</span><span class="p">);</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">pages</span> <span class="o">-</span> <span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">ngx_pagesize</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pages</span> <span class="o">-=</span> <span class="n">m</span><span class="p">;</span>
        <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">+</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pfree</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">log_nomem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">log_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>上記の 109 行目で呼ばれている <code>ngx_slab_slots</code> は以下で定義されたマクロでした。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L44-L45">nginx/src/core/ngx_slab.c#L44-L45</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>44
45</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define ngx_slab_slots(pool)                                                  \</span>
<span class="cp">    (ngx_slab_page_t *) ((u_char *) (pool) + sizeof(ngx_slab_pool_t))</span>
</pre></div>
</td></tr></table><p><code>ngx_slab_pool_t</code> 構造体のメモリを割り当てる際に、連続して <code>ngx_slab_page_t</code> 構造体のメモリも割り当ててそこを参照するということですね。</p>
</div>
<div class="section" id="id3">
<h2>ngx.shared.DICTのメソッドのコード</h2>
<p>代表として
<a class="reference external" href="https://github.com/openresty/lua-nginx-module#ngxshareddictadd">ngx.shared.DICT.add</a>
のコードを見ます。</p>
<p><code>add</code> メソッドは <code>ngx_http_lua_shdict_add</code> 関数で実装されています。</p>
<p><a class="reference external" href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_shdict.c#L347-L348">lua-nginx-module/src/ngx_http_lua_shdict.c#L347-L348</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>347
348</pre></div></td><td class="code"><div class="highlight"><pre><span></span>        <span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ngx_http_lua_shdict_add</span><span class="p">);</span>
        <span class="n">lua_setfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;add&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_shdict.c#L869-L873">lua-nginx-module/src/ngx_http_lua_shdict.c#L869-L873</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>869
870
871
872
873</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span>
<span class="nf">ngx_http_lua_shdict_add</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">ngx_http_lua_shdict_set_helper</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">NGX_HTTP_LUA_SHDICT_ADD</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_shdict.c#L905-L1246">lua-nginx-module/src/ngx_http_lua_shdict.c#L905-L1246</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 905
 906
 907
 908
 909
 910
 911
 912
 913
 914
 915
 916
 917
 918
 919
 920
 921
 922
 923
 924
 925
 926
 927
 928
 929
 930
 931
 932
 933
 934
 935
 936
 937
 938
 939
 940
 941
 942
 943
 944
 945
 946
 947
 948
 949
 950
 951
 952
 953
 954
 955
 956
 957
 958
 959
 960
 961
 962
 963
 964
 965
 966
 967
 968
 969
 970
 971
 972
 973
 974
 975
 976
 977
 978
 979
 980
 981
 982
 983
 984
 985
 986
 987
 988
 989
 990
 991
 992
 993
 994
 995
 996
 997
 998
 999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036
1037
1038
1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049
1050
1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104
1105
1106
1107
1108
1109
1110
1111
1112
1113
1114
1115
1116
1117
1118
1119
1120
1121
1122
1123
1124
1125
1126
1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143
1144
1145
1146
1147
1148
1149
1150
1151
1152
1153
1154
1155
1156
1157
1158
1159
1160
1161
1162
1163
1164
1165
1166
1167
1168
1169
1170
1171
1172
1173
1174
1175
1176
1177
1178
1179
1180
1181
1182
1183
1184
1185
1186
1187
1188
1189
1190
1191
1192
1193
1194
1195
1196
1197
1198
1199
1200
1201
1202
1203
1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214
1215
1216
1217
1218
1219
1220
1221
1222
1223
1224
1225
1226
1227
1228
1229
1230
1231
1232
1233
1234
1235
1236
1237
1238
1239
1240
1241
1242
1243
1244
1245
1246</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span>
<span class="nf">ngx_http_lua_shdict_set_helper</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span>                          <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>                    <span class="n">key</span><span class="p">;</span>
    <span class="kt">uint32_t</span>                     <span class="n">hash</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>                    <span class="n">rc</span><span class="p">;</span>
    <span class="n">ngx_http_lua_shdict_ctx_t</span>   <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
    <span class="n">ngx_http_lua_shdict_node_t</span>  <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>                    <span class="n">value</span><span class="p">;</span>
    <span class="kt">int</span>                          <span class="n">value_type</span><span class="p">;</span>
    <span class="kt">double</span>                       <span class="n">num</span><span class="p">;</span>
    <span class="n">u_char</span>                       <span class="n">c</span><span class="p">;</span>
    <span class="n">lua_Number</span>                   <span class="n">exptime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">u_char</span>                      <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_rbtree_node_t</span>           <span class="o">*</span><span class="n">node</span><span class="p">;</span>
    <span class="n">ngx_time_t</span>                  <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>              <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
    <span class="kt">int</span>                          <span class="n">forcible</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                         <span class="cm">/* indicates whether to foricibly override other</span>
<span class="cm">                          * valid entries */</span>
    <span class="kt">int32_t</span>                      <span class="n">user_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ngx_queue_t</span>                 <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;expecting 3, 4 or 5 arguments, &quot;</span>
                          <span class="s">&quot;but only seen %d&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lua_type</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">LUA_TTABLE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;bad </span><span class="se">\&quot;</span><span class="s">zone</span><span class="se">\&quot;</span><span class="s"> argument&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">zone</span> <span class="o">=</span> <span class="n">ngx_http_lua_shdict_get_zone</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;bad </span><span class="se">\&quot;</span><span class="s">zone</span><span class="se">\&quot;</span><span class="s"> argument&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">zone</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lua_isnil</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
        <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;nil key&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">key</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">luaL_checklstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
        <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;empty key&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
        <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;key too long&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">hash</span> <span class="o">=</span> <span class="n">ngx_crc32_short</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

    <span class="n">value_type</span> <span class="o">=</span> <span class="n">lua_type</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">value_type</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">case</span> <span class="nl">SHDICT_TSTRING</span><span class="p">:</span>
        <span class="n">value</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lua_tolstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">SHDICT_TNUMBER</span><span class="p">:</span>
        <span class="n">value</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">);</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">lua_tonumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
        <span class="n">value</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">SHDICT_TBOOLEAN</span><span class="p">:</span>
        <span class="n">value</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u_char</span><span class="p">);</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">lua_toboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">value</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">LUA_TNIL</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NGX_HTTP_LUA_SHDICT_ADD</span><span class="o">|</span><span class="n">NGX_HTTP_LUA_SHDICT_REPLACE</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
            <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;attempt to add or replace nil values&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ngx_str_null</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">default</span><span class="o">:</span>
        <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
        <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;bad value type&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">exptime</span> <span class="o">=</span> <span class="n">luaL_checknumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;bad </span><span class="se">\&quot;</span><span class="s">exptime</span><span class="se">\&quot;</span><span class="s"> argument&quot;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">user_flags</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">luaL_checkinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">ngx_shmtx_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="cp">#if 1</span>
    <span class="n">ngx_http_lua_shdict_expire</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="n">rc</span> <span class="o">=</span> <span class="n">ngx_http_lua_shdict_lookup</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">hash</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="p">);</span>

    <span class="n">dd</span><span class="p">(</span><span class="s">&quot;shdict lookup returned %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rc</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NGX_HTTP_LUA_SHDICT_REPLACE</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">NGX_DECLINED</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">NGX_DONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;not found&quot;</span><span class="p">);</span>
            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">forcible</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* rc == NGX_OK */</span>

        <span class="k">goto</span> <span class="n">replace</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NGX_HTTP_LUA_SHDICT_ADD</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;exists&quot;</span><span class="p">);</span>
            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">forcible</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">NGX_DONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* exists but expired */</span>

            <span class="n">dd</span><span class="p">(</span><span class="s">&quot;go to replace&quot;</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">replace</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* rc == NGX_DECLINED */</span>

        <span class="n">dd</span><span class="p">(</span><span class="s">&quot;go to insert&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">insert</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">NGX_OK</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="n">NGX_DONE</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">value_type</span> <span class="o">==</span> <span class="n">LUA_TNIL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>
        <span class="p">}</span>

<span class="nl">replace</span><span class="p">:</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">data</span>
            <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">value_len</span>
            <span class="o">&amp;&amp;</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">value_type</span> <span class="o">!=</span> <span class="n">SHDICT_TLIST</span><span class="p">)</span>
        <span class="p">{</span>

            <span class="n">ngx_log_debug0</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_HTTP</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="s">&quot;lua shared dict set: found old entry and value &quot;</span>
                           <span class="s">&quot;size matched, reusing it&quot;</span><span class="p">);</span>

            <span class="n">ngx_queue_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
            <span class="n">ngx_queue_insert_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

            <span class="n">sd</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="n">ngx_timeofday</span><span class="p">();</span>
                <span class="n">sd</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">sec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">msec</span>
                              <span class="o">+</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">sd</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">sd</span><span class="o">-&gt;</span><span class="n">user_flags</span> <span class="o">=</span> <span class="n">user_flags</span><span class="p">;</span>

            <span class="n">sd</span><span class="o">-&gt;</span><span class="n">value_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

            <span class="n">dd</span><span class="p">(</span><span class="s">&quot;setting value type to %d&quot;</span><span class="p">,</span> <span class="n">value_type</span><span class="p">);</span>

            <span class="n">sd</span><span class="o">-&gt;</span><span class="n">value_type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">value_type</span><span class="p">;</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_copy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
            <span class="n">ngx_memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

            <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">forcible</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ngx_log_debug0</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_HTTP</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                       <span class="s">&quot;lua shared dict set: found old entry but value size &quot;</span>
                       <span class="s">&quot;NOT matched, removing it first&quot;</span><span class="p">);</span>

<span class="nl">remove</span><span class="p">:</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">value_type</span> <span class="o">==</span> <span class="n">SHDICT_TLIST</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="n">ngx_http_lua_shdict_get_list_head</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">ngx_queue_head</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
                 <span class="n">q</span> <span class="o">!=</span> <span class="n">ngx_queue_sentinel</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
                 <span class="n">q</span> <span class="o">=</span> <span class="n">ngx_queue_next</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ngx_queue_data</span><span class="p">(</span><span class="n">q</span><span class="p">,</span>
                                              <span class="n">ngx_http_lua_shdict_list_node_t</span><span class="p">,</span>
                                              <span class="n">queue</span><span class="p">);</span>

                <span class="n">ngx_slab_free_locked</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">ngx_queue_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

        <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_rbtree_node_t</span> <span class="o">*</span><span class="p">)</span>
                   <span class="p">((</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sd</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_rbtree_node_t</span><span class="p">,</span> <span class="n">color</span><span class="p">));</span>

        <span class="n">ngx_rbtree_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">rbtree</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

        <span class="n">ngx_slab_free_locked</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

    <span class="p">}</span>

<span class="nl">insert</span><span class="p">:</span>

    <span class="cm">/* rc == NGX_DECLINED or value size unmatch */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

        <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
        <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ngx_log_debug0</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_HTTP</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                   <span class="s">&quot;lua shared dict set: creating a new entry&quot;</span><span class="p">);</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_rbtree_node_t</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_http_lua_shdict_node_t</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span>
        <span class="o">+</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

    <span class="n">dd</span><span class="p">(</span><span class="s">&quot;overhead = %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_rbtree_node_t</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_http_lua_shdict_node_t</span><span class="p">,</span> <span class="n">data</span><span class="p">)));</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">ngx_slab_alloc_locked</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NGX_HTTP_LUA_SHDICT_SAFE_STORE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;no memory&quot;</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_HTTP</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                       <span class="s">&quot;lua shared dict set: overriding non-expired items &quot;</span>
                       <span class="s">&quot;due to memory shortage for entry </span><span class="se">\&quot;</span><span class="s">%V</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ngx_http_lua_shdict_expire</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">forcible</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="n">node</span> <span class="o">=</span> <span class="n">ngx_slab_alloc_locked</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">goto</span> <span class="n">allocated</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

        <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="s">&quot;no memory&quot;</span><span class="p">);</span>
        <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">forcible</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nl">allocated</span><span class="p">:</span>

    <span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_http_lua_shdict_node_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>

    <span class="n">node</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">hash</span><span class="p">;</span>
    <span class="n">sd</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">ngx_timeofday</span><span class="p">();</span>
        <span class="n">sd</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">sec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">msec</span>
                      <span class="o">+</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">sd</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sd</span><span class="o">-&gt;</span><span class="n">user_flags</span> <span class="o">=</span> <span class="n">user_flags</span><span class="p">;</span>

    <span class="n">sd</span><span class="o">-&gt;</span><span class="n">value_len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

    <span class="n">dd</span><span class="p">(</span><span class="s">&quot;setting value type to %d&quot;</span><span class="p">,</span> <span class="n">value_type</span><span class="p">);</span>

    <span class="n">sd</span><span class="o">-&gt;</span><span class="n">value_type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span> <span class="n">value_type</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_copy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
    <span class="n">ngx_memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

    <span class="n">ngx_rbtree_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">rbtree</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>

    <span class="n">ngx_queue_insert_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">sh</span><span class="o">-&gt;</span><span class="n">lru_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

    <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">shpool</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

    <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">);</span>
    <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">forcible</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>上記の1148行目の <code>insert:</code> ラベルの後の1172行目で <code>ngx_slab_alloc_locked</code> 関数を呼び出しています。</p>
<p>1164行目でメモリ割り当てするバイト数を計算しています。ログ出力を追加して動作確認したところ
<code>offsetof(ngx_rbtree_node_t, color)</code> は32、
<code>offsetof(ngx_http_lua_shdict_node_t, data)</code> は36 でした。</p>
<p><code>ngx_slab_alloc_locked</code> 関数の実装は以下の通りです。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L183-L417">nginx/src/core/ngx_slab.c#L183-L417</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="o">*</span>
<span class="nf">ngx_slab_alloc_locked</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">size_t</span>            <span class="n">s</span><span class="p">;</span>
    <span class="kt">uintptr_t</span>         <span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">map</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">slots</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">ngx_slab_max_size</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span> <span class="n">ngx_cycle</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                       <span class="s">&quot;slab alloc: %uz&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

        <span class="n">page</span> <span class="o">=</span> <span class="n">ngx_slab_alloc_pages</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">ngx_pagesize_shift</span><span class="p">)</span>
                                          <span class="o">+</span> <span class="p">((</span><span class="n">size</span> <span class="o">%</span> <span class="n">ngx_pagesize</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">min_size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">s</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">shift</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* void */</span> <span class="p">}</span>
        <span class="n">slot</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">min_shift</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">min_shift</span><span class="p">;</span>
        <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">reqs</span><span class="o">++</span><span class="p">;</span>

    <span class="n">ngx_log_debug2</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span> <span class="n">ngx_cycle</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                   <span class="s">&quot;slab alloc: %uz slot: %ui&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

    <span class="n">slots</span> <span class="o">=</span> <span class="n">ngx_slab_slots</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">page</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="n">ngx_slab_exact_shift</span><span class="p">)</span> <span class="p">{</span>

            <span class="n">bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

            <span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">));</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">map</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NGX_SLAB_BUSY</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">continue</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="n">bitmap</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">|=</span> <span class="n">m</span><span class="p">;</span>

                        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">;</span>

                        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="n">bitmap</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

                        <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">used</span><span class="o">++</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="n">NGX_SLAB_BUSY</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">map</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NGX_SLAB_BUSY</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>

                            <span class="n">prev</span> <span class="o">=</span> <span class="n">ngx_slab_page_prev</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
                            <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                            <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>

                            <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                            <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">NGX_SLAB_SMALL</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">==</span> <span class="n">ngx_slab_exact_shift</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">|=</span> <span class="n">m</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">==</span> <span class="n">NGX_SLAB_BUSY</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">prev</span> <span class="o">=</span> <span class="n">ngx_slab_page_prev</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
                    <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                    <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>

                    <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">NGX_SLAB_EXACT</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>

                <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">used</span><span class="o">++</span><span class="p">;</span>

                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* shift &gt; ngx_slab_exact_shift */</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="n">NGX_SLAB_MAP_SHIFT</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NGX_SLAB_MAP_SHIFT</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">m</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
                 <span class="n">m</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">|=</span> <span class="n">m</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">((</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">&amp;</span> <span class="n">NGX_SLAB_MAP_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">prev</span> <span class="o">=</span> <span class="n">ngx_slab_page_prev</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
                    <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                    <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>

                    <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">NGX_SLAB_BIG</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>

                <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">used</span><span class="o">++</span><span class="p">;</span>

                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">ngx_slab_error</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">NGX_LOG_ALERT</span><span class="p">,</span> <span class="s">&quot;ngx_slab_alloc(): page is busy&quot;</span><span class="p">);</span>
        <span class="n">ngx_debug_point</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">page</span> <span class="o">=</span> <span class="n">ngx_slab_alloc_pages</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="n">ngx_slab_exact_shift</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

            <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cm">/* &quot;n&quot; elements for bitmap, plus one requested */</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">));</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bitmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NGX_SLAB_BUSY</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">m</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">))))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">bitmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

            <span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">));</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bitmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">shift</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
            <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">|</span> <span class="n">NGX_SLAB_SMALL</span><span class="p">;</span>

            <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">total</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span><span class="p">;</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>

            <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">used</span><span class="o">++</span><span class="p">;</span>

            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">==</span> <span class="n">ngx_slab_exact_shift</span><span class="p">)</span> <span class="p">{</span>

            <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
            <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">|</span> <span class="n">NGX_SLAB_EXACT</span><span class="p">;</span>

            <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">total</span> <span class="o">+=</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uintptr_t</span><span class="p">);</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

            <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">used</span><span class="o">++</span><span class="p">;</span>

            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* shift &gt; ngx_slab_exact_shift */</span>

            <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="p">((</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">NGX_SLAB_MAP_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">shift</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">];</span>
            <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">|</span> <span class="n">NGX_SLAB_BIG</span><span class="p">;</span>

            <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">total</span> <span class="o">+=</span> <span class="n">ngx_pagesize</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>

            <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">used</span><span class="o">++</span><span class="p">;</span>

            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">fails</span><span class="o">++</span><span class="p">;</span>

<span class="nl">done</span><span class="p">:</span>

    <span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span> <span class="n">ngx_cycle</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                   <span class="s">&quot;slab alloc: %p&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>ngx_slab_max_size</code> は上記のように 2048 なのでそれより大きいサイズを割り当てる場合は
191行目の if の条件が true になり、193～205行目で処理されることになります。</p>
<p>2048バイト以下のサイズの場合は 208行目以降で処理されます。
<code>pool-&gt;min_size</code> は8なので、8バイトより大きい場合は209～211行目、8バイト以下なら214～215行目の分岐になります。</p>
<p><code>size</code> が8以下なら <code>slot</code> は 0, <code>shift</code> は3になります。
<code>size</code> が9～16なら <code>slot</code> は 1, <code>shift</code> は4になります。
<code>size</code> が17～32なら <code>slot</code> は 2, <code>shift</code> は5になります。
以下同様に2倍になるごとに <code>slot</code> と <code>shift</code> が増えていき、
最後は <code>size</code> が1025～2048 で <code>slot</code> が 8, <code>shift</code> が11になります。</p>
<p>218行目でスロット毎のメモリ割り当て依頼回数をインクリメントしています。</p>
<p>226～330行目では既存のページを再利用しているようです。249、291、322行目でスロット毎の使用中カウンタ <code>pool-&gt;stats[slot].used</code> をインクリメントしています。</p>
<p>332行目では <code>ngx_slab_alloc_pages</code> 関数を呼んで新たにページを割り当てています。</p>
<p>334～405行目では <code>pool-&gt;stats[slot].used</code> をインクリメントしつつ、スロット毎の使用バイト数 <code>pool-&gt;stats[slot].total</code> も増やしています。</p>
<p>405行目までの処理で正常に割り当てできた場合は 411行目の <code>done</code> ラベルに飛びます。
失敗した場合は409行目でスロット毎の失敗回数 <code>pool-&gt;stats[slot].fails</code> をインクリメントしています。</p>
<p><code>ngx_slab_alloc_pages</code> 関数の実装は以下の通りです。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L678-L731">nginx/src/core/ngx_slab.c#L678-L731</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">ngx_slab_page_t</span> <span class="o">*</span>
<span class="nf">ngx_slab_alloc_pages</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="n">ngx_uint_t</span> <span class="n">pages</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">next</span><span class="p">;</span> <span class="n">page</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">&gt;=</span> <span class="n">pages</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">&gt;</span> <span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">page</span><span class="p">[</span><span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">];</span>

                <span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">].</span><span class="n">slab</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">-</span> <span class="n">pages</span><span class="p">;</span>
                <span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">].</span><span class="n">prev</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>

                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_page_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">];</span>
                <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">];</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_page_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">pages</span> <span class="o">|</span> <span class="n">NGX_SLAB_PAGE_START</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">NGX_SLAB_PAGE</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pfree</span> <span class="o">-=</span> <span class="n">pages</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">pages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">page</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pages</span><span class="p">;</span> <span class="n">pages</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">NGX_SLAB_PAGE_BUSY</span><span class="p">;</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">NGX_SLAB_PAGE</span><span class="p">;</span>
                <span class="n">p</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">page</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">log_nomem</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_slab_error</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">NGX_LOG_CRIT</span><span class="p">,</span>
                       <span class="s">&quot;ngx_slab_alloc() failed: no memory&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>ngx_slab_pool_t *</code> 型の <code>pool</code> の <code>pool-&gt;free</code> は <code>ngx_slab_page_t</code> 型になっています。上に書いていますが再度引用します。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.h#L16-L22">nginx/src/core/ngx_slab.h#L16-L22</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ngx_slab_page_s</span>  <span class="n">ngx_slab_page_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ngx_slab_page_s</span> <span class="p">{</span>
    <span class="kt">uintptr_t</span>         <span class="n">slab</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="kt">uintptr_t</span>         <span class="n">prev</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><code>next</code> と <code>prev</code> フィールドで双方向リンクトリストになっています。
683行目の <code>for</code> 文を見るとリストの最後の要素では <code>next</code> を自分自身に指すようになっているようです。</p>
<p><code>slab</code> フィールドは <code>uintptr_t</code> 型で685行目ではページ数と比較しています。</p>
<p>704～719行目を見ると複数のページがメモリ上に連続して存在して、ページ割り付けの際に複数ページを使用する場合は、最初のページの <code>slab</code> フィールドにはページ数に <code>NGX_SLAB_PAGE_START</code> のフラグを追加し、継続するページの <code>slab</code> フィールドには <code>NGX_SLAB_PAGE_BUSY</code> を設定しています。</p>
<p><code>NGX_SLAB_PAGE_START</code> や <code>NGX_SLAB_PAGE_BUSY</code> の定数は以下のように定義されています。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L17-L41">nginx/src/core/ngx_slab.c#L17-L41</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#if (NGX_PTR_SIZE == 4)</span>

<span class="cp">#define NGX_SLAB_PAGE_FREE   0</span>
<span class="cp">#define NGX_SLAB_PAGE_BUSY   0xffffffff</span>
<span class="cp">#define NGX_SLAB_PAGE_START  0x80000000</span>

<span class="cp">#define NGX_SLAB_SHIFT_MASK  0x0000000f</span>
<span class="cp">#define NGX_SLAB_MAP_MASK    0xffff0000</span>
<span class="cp">#define NGX_SLAB_MAP_SHIFT   16</span>

<span class="cp">#define NGX_SLAB_BUSY        0xffffffff</span>

<span class="cp">#else </span><span class="cm">/* (NGX_PTR_SIZE == 8) */</span><span class="cp"></span>

<span class="cp">#define NGX_SLAB_PAGE_FREE   0</span>
<span class="cp">#define NGX_SLAB_PAGE_BUSY   0xffffffffffffffff</span>
<span class="cp">#define NGX_SLAB_PAGE_START  0x8000000000000000</span>

<span class="cp">#define NGX_SLAB_SHIFT_MASK  0x000000000000000f</span>
<span class="cp">#define NGX_SLAB_MAP_MASK    0xffffffff00000000</span>
<span class="cp">#define NGX_SLAB_MAP_SHIFT   32</span>

<span class="cp">#define NGX_SLAB_BUSY        0xffffffffffffffff</span>

<span class="cp">#endif</span>
</pre></div>
</td></tr></table><p><code>ngx_slab_alloc_pages</code> 関数のコードを改めて眺めてみると、この関数内では新たなメモリ割り当ては行っていないことに気づきます。
ということは <code>pool</code> の作成時に <code>pool-&gt;free</code> に割り当てられたメモリを使いまわしているだけということです。</p>
<p>遡って見てみると ngx_cycle.c の478行目で呼び出している <code>ngx_shm_alloc</code> 関数が
<a class="reference external" href="http://man7.org/linux/man-pages/man2/mmap.2.html">mmap(2)</a> システムコールを使ってメモリを割り当てていました。</p>
<p>OSによっては <code>ngx_shmem.c</code> の <code>#if</code> の違う分岐になりますが、Linuxでは上記の <code>mmap(2)</code> のマニュアルに <code>MAP_ANON</code> が deprecated ですが存在したので、Linuxでは下記の実装が使われていると思います。</p>
<p><a class="reference external" href="https://github.com/nginx/nginx/blob/release-1.13.5/src/os/unix/ngx_shmem.c#L12-L28">nginx/src/os/unix/ngx_shmem.c#L12-L28</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#if (NGX_HAVE_MAP_ANON)</span>

<span class="n">ngx_int_t</span>
<span class="nf">ngx_shm_alloc</span><span class="p">(</span><span class="n">ngx_shm_t</span> <span class="o">*</span><span class="n">shm</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">shm</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">shm</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
                                <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span>
                                <span class="n">MAP_ANON</span><span class="o">|</span><span class="n">MAP_SHARED</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">shm</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_log_error</span><span class="p">(</span><span class="n">NGX_LOG_ALERT</span><span class="p">,</span> <span class="n">shm</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="n">ngx_errno</span><span class="p">,</span>
                      <span class="s">&quot;mmap(MAP_ANON|MAP_SHARED, %uz) failed&quot;</span><span class="p">,</span> <span class="n">shm</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>ここで上で読み飛ばした <code>ngx_slab_init</code> 関数の続きを見ます。</p>
<p>109～111行目で <code>slots</code> と <code>p</code> は <code>*pool</code> の <code>ngx_slab_pool_t</code> 構造体の直後のアドレスに設定されます。</p>
<p>上記の通り <code>n</code> は 9 なので118～123行目で 0～8の9個のスロットを作成しています。</p>
<p>125行目で <code>p</code> は9個のスロットの直後のアドレスを指します。</p>
<p>そこから9個の <code>ngx_slab_stat_t</code> 構造体の領域が確保され、スロット毎の統計情報が保持されます。</p>
<p>130行目で <code>p</code> は統計情報の直後のアドレスを指します。</p>
<p>132行目で <code>size</code> は <code>ngx_slab_pool_t</code> 構造体と <code>ngx_slab_stat_t</code> 構造体の9組分のサイズを差し引かれます。</p>
<p>134行目で <code>pages</code> にページ数の計算結果を設定しています。上記の <code>size</code> を <code>(ngx_pagesize + sizeof(ngx_slab_page_t))</code> で割っていますので、各ページに対して 4096バイトのデータ領域と <code>ngx_slab_page_t</code> 構造体による管理情報が存在することがわかります。</p>
<p>136行目で <code>pool-&gt;pages</code> にページの先頭のアドレスをセットしています。</p>
<p>137行目で <code>pool-&gt;pages</code> から先頭 <code>pages * sizeof(ngx_slab_page_t)</code> バイトをゼロクリアしています。このことから上記の各ページに対応する 4096バイトのデータ領域と <code>ngx_slab_page_t</code> 構造体のうち <code>ngx_slab_page_t</code> 構造体が <code>pool-&gt;pages</code> の先頭にページ数分連続して存在し、その後に 4096 バイトのページがページ数分続くことがわかります。</p>
<p>139行目以降はリンクトリストの要素を設定しています。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">ngx_slab_init</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span>           <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">size_t</span>            <span class="n">size</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>         <span class="n">m</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">slots</span><span class="p">,</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">min_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">min_shift</span><span class="p">;</span>

    <span class="n">slots</span> <span class="o">=</span> <span class="n">ngx_slab_slots</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>

    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">slots</span><span class="p">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>

    <span class="n">ngx_slab_junk</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">ngx_pagesize_shift</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">min_shift</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* only &quot;next&quot; is used in list head */</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">p</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">);</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_stat_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_memzero</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">));</span>

    <span class="n">p</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">);</span>

    <span class="n">size</span> <span class="o">-=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">));</span>

    <span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_uint_t</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)));</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_page_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_memzero</span><span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">));</span>

    <span class="n">page</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">;</span>

    <span class="cm">/* only &quot;next&quot; is used in list head */</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">page</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">;</span>
    <span class="n">page</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">),</span>
                                <span class="n">ngx_pagesize</span><span class="p">);</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">pages</span> <span class="o">-</span> <span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">ngx_pagesize</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pages</span> <span class="o">-=</span> <span class="n">m</span><span class="p">;</span>
        <span class="n">page</span><span class="o">-&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pages</span> <span class="o">+</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">pfree</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">log_nomem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">log_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>