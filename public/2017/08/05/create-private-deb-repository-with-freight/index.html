<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>freightでプライベートdebレポジトリ作成</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/08/05/create-private-deb-repository-with-freight/" rel="bookmark"
           title="Permalink to freightでプライベートdebレポジトリ作成">freightでプライベートdebレポジトリ作成</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-08-05T17:40:00+09:00">
                Published: 2017-08-05
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/deb.html">deb</a> <a href="../../../../tag/freight.html">freight</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>CentOS だとカスタムrpmを作って <code>yum install rpmファイル名</code> で依存パッケージとともにインストールできますが、Ubuntuだと <code>dpkg -i debファイル名</code> でインストールは出来ますが依存パッケージは入りません。</p>
<p><a class="reference external" href="https://askubuntu.com/questions/40011/how-to-let-dpkg-i-install-dependencies-for-me">How to let `dpkg -i` install dependencies for me? - Ask Ubuntu</a> によると <code>dpkg -i</code> の後に <code>apt -f install</code> するか、 <code>gdebi-core</code> パッケージを入れておいて <code>sudo gdebi debファイル名</code> という手はあるようです。</p>
<p>とはいえ、PPAにアップロードする前に <code>apt install</code> で動作確認したいとか、PPAで公開しないdebパッケージを <code>apt</code> コマンドでインストールしたいというケースはあるので、プライベートdebレポジトリを作りたいところです。</p>
<p><a class="reference external" href="https://wiki.debian.org/DebianRepository/Setup">DebianRepository/Setup - Debian Wiki</a> に多くのツールが紹介されていますが、
<a class="reference external" href="https://askubuntu.com/questions/84788/create-deb-repository-with-several-versions-of-the-same-package#comment1444951_668791">Create deb repository with several versions of the same package - Ask Ubuntu</a> で紹介されていた <a class="reference external" href="https://github.com/freight-team/freight">https://github.com/freight-team/freight</a> を使ってみたところ、私のニーズに丁度良い感じでした。ということでメモです。</p>
<p>手順の作成で試行錯誤したのですが
<a class="reference external" href="http://blog.valouille.fr/2014/03/creer-un-depot-debian-signe-avec-freight/">Créer un repository Debian signé avec Freight | VaLouille</a>
をGoogle翻訳で英訳して読んで動かせるようになりました。先人の記事に感謝です。</p>
</div>
<div class="section" id="freight">
<h2>freightのインストール手順</h2>
<p><a class="reference external" href="https://github.com/freight-team/freight#from-a-debian-archive">From a Debian archive</a>
の手順を少し変えて以下のようにインストールしました。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt update</span>
<span class="go">sudo apt -y install curl</span>
<span class="go">curl -k https://swupdate.openvpn.net/repos/repo-public.gpg | sudo apt-key add -</span>
<span class="go">echo &quot;deb http://build.openvpn.net/debian/freight_team $(lsb_release -sc) main&quot; | sudo tee /etc/apt/sources.list.d/freight.list</span>
<span class="go">sudo apt update</span>
<span class="go">sudo apt -y install freight</span>
</pre></div>
<p>私はdebをビルドしたサーバとは別にLXDのコンテナを作ってその中で root ユーザで実行していたので <code>sudo</code> は不要なのですが、そうでない環境でセットアップすることも想定して <code>sudo</code> は付けておきます。</p>
<p><code>curl</code> に <code>-k</code> オプションを指定しないと以下のエラーが出たので、上の手順では <code>-k</code> を指定しています。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> curl https://swupdate.openvpn.net/repos/repo-public.gpg
<span class="go">curl: (77) Problem with the SSL CA cert (path? access rights?)</span>
</pre></div>
</div>
<div class="section" id="gpg">
<h2>gpgの秘密鍵のインポート</h2>
<p>debをビルドしたサーバで
<a class="reference external" href="https://hnakamur.github.io/blog/2017/07/01/generate-secret-key-with-gpg/">gpgで秘密鍵を作成する</a> の「秘密鍵をエクスポートする」の手順を実行して <code>lxc file push</code> コマンドを使ってLXDコンテナに秘密鍵を転送し、以下のコマンドでインポートしました。</p>
<div class="highlight"><pre><span></span><span class="go">gpg --import gpg-hnakamur-secret.key.pem</span>
</pre></div>
</div>
<div class="section" id="id3">
<h2>レポジトリの初期化</h2>
<p>以下の手順でレポジトリのディレクトリを作成して初期化します。ディレクトリや各引数は適宜調整してください。今回は xenial 上で golang-1.9 用のレポジトリを作るので <code>--suite</code> は <code>xenial-golang-1.9</code> としましたが、特にレポジトリを分ける必要がなければ <code>xenial</code> だけで良いです。</p>
<div class="highlight"><pre><span></span><span class="go">mkdir -p /var/www/freight</span>
<span class="go">cd /var/www/freight</span>
<span class="go">freight-init --gpg=hnakamur@gmail.com --libdir=/var/www/freight/lib \</span>
<span class="go">    --cachedir=/var/www/freight/cache --archs=&quot;amd64 all&quot; \</span>
<span class="go">    --origin=&quot;My Internal Repository&quot; --label=&quot;My Internal Reposiroty&quot; \</span>
<span class="go">    --suite=&quot;xenial-golang-1.9&quot;</span>
</pre></div>
</div>
<div class="section" id="deb">
<h2>レポジトリにdebパッケージを追加</h2>
<p>debをビルドしたサーバで <code>lxc file push</code> コマンドを使って作成した deb パッケージをLXDコンテナの <code>/root/</code> ディレクトリに転送しておいて、LXDコンテナで以下のコマンドを実行しdebファイルをレポジトリに追加します。</p>
<div class="highlight"><pre><span></span><span class="go">freight add /root/*.deb apt/xenial-golang-1.9</span>
<span class="go">freight cache apt/xenial-golang-1.9</span>
</pre></div>
<p>gpgのパスフレーズを求めるプロンプトが表示されますので、パスフレーズを入力してください。</p>
</div>
<div class="section" id="id4">
<h2>ローカルレポジトリを使うための設定</h2>
<p>ローカルレポジトリを使うには以下のように <code>.list</code> ファイルを作ればOKです。
<code>xenial-golang-1.9</code> の部分は <code>fright-init</code> の <code>--suite</code> の引数に指定した値に合わせます。ディレクトリや <code>.list</code> のファイル名も適宜調整してください。</p>
<div class="highlight"><pre><span></span><span class="go">echo &quot;deb file:/var/www/freight/cache xenial-golang-1.9 main&quot; | sudo tee /etc/apt/sources.list.d/local-golang-1.9.list</span>
</pre></div>
</div>
<div class="section" id="apt-key">
<h2>ローカルレポジトリの公開鍵をapt-keyに追加</h2>
<p>以下のコマンドでローカルレポジトリの公開鍵を追加します。</p>
<div class="highlight"><pre><span></span><span class="go">apt-key add /var/www/freight/cache/pubkey.gpg</span>
</pre></div>
</div>
<div class="section" id="id5">
<h2>パッケージのインストール</h2>
<p>これでローカルパッケージが使えるようになりました。あとは <code>apt update</code> して <code>apt install</code> するだけです。今回は golang-go パッケージを作ったので以下のようになります。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt update</span>
<span class="go">sudo apt -y install golang-go</span>
</pre></div>
<p>これで依存するパッケージとともにインストールされました。素晴らしい！</p>
</div>
<div class="section" id="id6">
<h2>おわりに</h2>
<p>今回は試していませんが、 <code>/var/www/freight/cache</code> を nginx などのウェブサーバで公開して、 <code>.list</code> ファイルの <code>deb</code> の後の <code>file:/var/www/freight/cache</code> の部分を公開したURLに変えればリモートのマシンでインストールも出来ると思います。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>