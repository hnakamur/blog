<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>iptablesのコードリーディング</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/02/26/iptables-code-reading/" rel="bookmark"
           title="Permalink to iptablesのコードリーディング">iptablesのコードリーディング</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-02-26T11:40:00+09:00">
                Published: 2017-02-26
        </abbr>
		<br />
        <abbr class="modified" title="2017-02-26T09:05:00+09:00">
                Updated: 2017-02-26
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/iptables.html">iptables</a> <a href="../../../../tag/code-reading.html">code-reading</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="/blog/2017/02/24/iptables-restore-code-reading/">iptables-restoreのコードリーディング</a> の続きです。</p>
<p>サーバ上の <tt class="docutils literal">iptables</tt> の現状の設定が、自分が意図した設定と一致しているか確認したいというニーズがあります。
シェルスクリプトで <tt class="docutils literal">iptables</tt> コマンドを順次実行する方式は大変すぎるので、 <tt class="docutils literal"><span class="pre">iptables-restore</span></tt> に自分の設定ファイルを渡して設定を反映させ、現在の状態は <tt class="docutils literal"><span class="pre">iptables-save</span></tt> で出力して、設定ファイルとこの出力を比較したらどうかと考えました。</p>
<p>しかし、この方式でもいくつか気をつける必要があります (これで全部ではないかもしれません)。</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">iptables-restore</span></tt> への入力ファイルに書いていないテーブル (<tt class="docutils literal">*</tt> テーブル名 の行から <tt class="docutils literal">COMMIT</tt> の行まで)も <tt class="docutils literal"><span class="pre">iptables-save</span></tt> では出力される。</li>
<li><tt class="docutils literal"><span class="pre">iptables-restore</span></tt> への入力ファイルで複数のテーブルを指定した場合、 <tt class="docutils literal"><span class="pre">iptables-save</span></tt> では特定の順序で出力される。</li>
<li><tt class="docutils literal"><span class="pre">iptables-restore</span></tt> への入力ファイルにコメント行(<tt class="docutils literal">#</tt> で始まる行)を含めていても、 <tt class="docutils literal"><span class="pre">iptables-save</span></tt> では出力されない。</li>
<li><tt class="docutils literal"><span class="pre">iptables-save</span></tt> ではテーブルの前後に <tt class="docutils literal"># Generated by <span class="pre">iptables-save</span> v1.4.21 on Sun Feb 26 03:40:03 2017</tt> と <tt class="docutils literal"># Completed on Sun Feb 26 03:40:03 2017</tt> のようなコメント行が出力される。</li>
<li>チェーン (<tt class="docutils literal">:</tt> で始まる行) のカウンタ (<tt class="docutils literal">[整数:整数]</tt>) の値は <tt class="docutils literal"><span class="pre">iptables-restore</span></tt> への入力ファイルと <tt class="docutils literal"><span class="pre">iptables-save</span></tt> の出力ではほとんどのケースは一致しない。 <tt class="docutils literal"><span class="pre">iptables-restore</span></tt> 実行時から <tt class="docutils literal"><span class="pre">iptables-save</span></tt> 実行時までにそのチェーンでパケットを処理していなければ一致するが、設定直後に確認するケースを除いてたいていは一致しないことになる。</li>
<li>既に追加したルールセットの途中に <tt class="docutils literal"><span class="pre">-I</span></tt> でルールを追加すると、 <tt class="docutils literal"><span class="pre">iptables-save</span></tt> ではソートされた <tt class="docutils literal"><span class="pre">-A</span></tt> のリストとして出力される。</li>
<li>1つのコマンド内で複数の引数の順序は任意に指定可能だが、 <tt class="docutils literal"><span class="pre">iptables-save</span></tt> では特定の順番で出力される。</li>
<li><tt class="docutils literal"><span class="pre">--destination-port</span></tt> と <tt class="docutils literal"><span class="pre">-dport</span></tt> のように同一のオプションに2通りの書き方（シノニム）が用意されているものがある。</li>
<li><tt class="docutils literal"><span class="pre">--tcp-flags</span></tt> の値に <tt class="docutils literal">ALL</tt> を指定すると、 <tt class="docutils literal"><span class="pre">iptables-save</span></tt> では <tt class="docutils literal">FIN,SYN,RST,PSH,ACK,URG</tt> に展開される。</li>
<li><tt class="docutils literal"><span class="pre">--tcp-flags</span></tt> の値に複数の値を指定した場合、 <tt class="docutils literal"><span class="pre">iptables-save</span></tt> では特定の順番で出力される。</li>
<li><tt class="docutils literal"><span class="pre">--syn</span></tt> を指定すると、 <tt class="docutils literal"><span class="pre">iptables-save</span></tt> では <tt class="docutils literal"><span class="pre">--tcp-flags</span> FIN,SYN,RST,ACK SYN</tt> に展開される。</li>
<li><tt class="docutils literal"><span class="pre">--src</span></tt> や <tt class="docutils literal"><span class="pre">--destination</span></tt> に <tt class="docutils literal">0.0.0.0/0</tt> を指定した場合、 <tt class="docutils literal"><span class="pre">iptables-save</span></tt> では出力が省略される。</li>
</ul>
<p>以下に例を示します。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">[root@centos7 iptables-experiment]#</span> cat iptables.conf
<span class="go">*filter</span>
<span class="go">:INPUT DROP [0:0]</span>
<span class="go">:FORWARD ACCEPT [0:0]</span>
<span class="go">:OUTPUT ACCEPT [0:0]</span>
<span class="go">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span>
<span class="gp">#</span> this comment will not be printed with iptables-save
<span class="go">-A INPUT -p tcp -m tcp --tcp-flags ALL NONE -j DROP</span>
<span class="go">-A INPUT -p tcp -m tcp ! --syn -m state --state NEW -j DROP</span>
<span class="go">-A INPUT -p tcp -m tcp --tcp-flags ALL ALL -j DROP</span>
<span class="go">-A INPUT -i lo -j ACCEPT</span>
<span class="go">-A INPUT -p icmp -j ACCEPT</span>
<span class="go">-A INPUT -p tcp -m tcp --destination 0.0.0.0/0 --dport 443 -j ACCEPT</span>
<span class="go">-I INPUT 7 -p tcp -m tcp --src 0.0.0.0/0 --destination-port 80 -j ACCEPT</span>
<span class="go">-I INPUT 7 -p tcp -m tcp --src 192.168.0.0/24 --destination-port 22 -j ACCEPT</span>
<span class="go">COMMIT</span>
<span class="go">*nat</span>
<span class="go">:PREROUTING ACCEPT [0:0]</span>
<span class="go">:INPUT ACCEPT [0:0]</span>
<span class="go">:OUTPUT ACCEPT [0:0]</span>
<span class="go">:POSTROUTING ACCEPT [0:0]</span>
<span class="go">COMMIT</span>
<span class="gp">[root@centos7 iptables-experiment]#</span> iptables-restore &lt; iptables.conf
</pre></div>
</td></tr></table><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">[root@centos7 iptables-experiment]#</span> iptables-save
<span class="gp">#</span> Generated by iptables-save v1.4.21 on Sun Feb <span class="m">26</span> <span class="m">03</span>:40:03 <span class="m">2017</span>
<span class="go">*mangle</span>
<span class="go">:PREROUTING ACCEPT [2:668]</span>
<span class="go">:INPUT ACCEPT [2:668]</span>
<span class="go">:FORWARD ACCEPT [0:0]</span>
<span class="go">:OUTPUT ACCEPT [2:656]</span>
<span class="go">:POSTROUTING ACCEPT [2:656]</span>
<span class="go">COMMIT</span>
<span class="gp">#</span> Completed on Sun Feb <span class="m">26</span> <span class="m">03</span>:40:03 <span class="m">2017</span>
<span class="gp">#</span> Generated by iptables-save v1.4.21 on Sun Feb <span class="m">26</span> <span class="m">03</span>:40:03 <span class="m">2017</span>
<span class="go">*nat</span>
<span class="go">:PREROUTING ACCEPT [0:0]</span>
<span class="go">:INPUT ACCEPT [0:0]</span>
<span class="go">:OUTPUT ACCEPT [0:0]</span>
<span class="go">:POSTROUTING ACCEPT [0:0]</span>
<span class="go">COMMIT</span>
<span class="gp">#</span> Completed on Sun Feb <span class="m">26</span> <span class="m">03</span>:40:03 <span class="m">2017</span>
<span class="gp">#</span> Generated by iptables-save v1.4.21 on Sun Feb <span class="m">26</span> <span class="m">03</span>:40:03 <span class="m">2017</span>
<span class="go">*filter</span>
<span class="go">:INPUT DROP [0:0]</span>
<span class="go">:FORWARD ACCEPT [0:0]</span>
<span class="go">:OUTPUT ACCEPT [0:0]</span>
<span class="go">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</span>
<span class="go">-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP</span>
<span class="go">-A INPUT -p tcp -m tcp ! --tcp-flags FIN,SYN,RST,ACK SYN -m state --state NEW -j DROP</span>
<span class="go">-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,PSH,ACK,URG -j DROP</span>
<span class="go">-A INPUT -i lo -j ACCEPT</span>
<span class="go">-A INPUT -p icmp -j ACCEPT</span>
<span class="go">-A INPUT -s 192.168.0.0/24 -p tcp -m tcp --dport 22 -j ACCEPT</span>
<span class="go">-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT</span>
<span class="go">-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT</span>
<span class="go">COMMIT</span>
<span class="gp">#</span> Completed on Sun Feb <span class="m">26</span> <span class="m">03</span>:40:03 <span class="m">2017</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="synonym">
<h2>synonymで検索した結果</h2>
<p>なお、 IPv6 関連は省略しています。</p>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n29">extensions/libxt_tcp.c#L29-#L38</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">tcp_opts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;source-port&quot;</span><span class="p">,</span>      <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;1&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sport&quot;</span><span class="p">,</span>            <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;1&#39;</span><span class="p">},</span> <span class="cm">/* synonym */</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;destination-port&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;2&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dport&quot;</span><span class="p">,</span>            <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;2&#39;</span><span class="p">},</span> <span class="cm">/* synonym */</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;syn&quot;</span><span class="p">,</span>              <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;3&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tcp-flags&quot;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;4&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;tcp-option&quot;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;5&#39;</span><span class="p">},</span>
    <span class="n">XT_GETOPT_TABLEEND</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n76">iptables/iptables.c#L76-#L114</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">original_opts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;append&quot;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;delete&quot;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;D&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;check&quot;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;C&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;insert&quot;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;I&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;replace&quot;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;list&quot;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;L&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;list-rules&quot;</span><span class="p">,</span>    <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;S&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;flush&quot;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;zero&quot;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;Z&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;new-chain&quot;</span><span class="p">,</span>     <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;N&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;delete-chain&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;X&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rename-chain&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;E&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;policy&quot;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;P&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;source&quot;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;s&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;destination&quot;</span><span class="p">,</span>   <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;src&quot;</span><span class="p">,</span>           <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;s&#39;</span><span class="p">},</span> <span class="cm">/* synonym */</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;dst&quot;</span><span class="p">,</span>           <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">},</span> <span class="cm">/* synonym */</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;protocol&quot;</span><span class="p">,</span>      <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;p&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;in-interface&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;i&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;jump&quot;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;j&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;table&quot;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;t&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;match&quot;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;m&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;numeric&quot;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;out-interface&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;o&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;verbose&quot;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;v&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wait&quot;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;w&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;exact&quot;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;x&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fragments&quot;</span><span class="p">,</span>     <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;version&quot;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;V&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;help&quot;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;h&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;line-numbers&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;modprobe&quot;</span><span class="p">,</span>      <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;M&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;set-counters&quot;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;c&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;goto&quot;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;g&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ipv4&quot;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;4&#39;</span><span class="p">},</span>
    <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ipv6&quot;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;6&#39;</span><span class="p">},</span>
    <span class="p">{</span><span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><div class="section" id="tcp-opts">
<h3><tt class="docutils literal">tcp_opts</tt> の参照箇所</h3>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n365">extensions/libxt_tcp.c#L365-#L383</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="n">xtables_match</span> <span class="n">tcp_match</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">family</span>         <span class="o">=</span> <span class="n">NFPROTO_UNSPEC</span><span class="p">,</span>
    <span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;tcp&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">version</span>        <span class="o">=</span> <span class="n">XTABLES_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">size</span>           <span class="o">=</span> <span class="n">XT_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_tcp</span><span class="p">)),</span>
    <span class="p">.</span><span class="n">userspacesize</span>  <span class="o">=</span> <span class="n">XT_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_tcp</span><span class="p">)),</span>
    <span class="p">.</span><span class="n">help</span>           <span class="o">=</span> <span class="n">tcp_help</span><span class="p">,</span>
    <span class="p">.</span><span class="n">init</span>           <span class="o">=</span> <span class="n">tcp_init</span><span class="p">,</span>
    <span class="p">.</span><span class="n">parse</span>          <span class="o">=</span> <span class="n">tcp_parse</span><span class="p">,</span>
    <span class="p">.</span><span class="n">print</span>          <span class="o">=</span> <span class="n">tcp_print</span><span class="p">,</span>
    <span class="p">.</span><span class="n">save</span>           <span class="o">=</span> <span class="n">tcp_save</span><span class="p">,</span>
    <span class="p">.</span><span class="n">extra_opts</span>     <span class="o">=</span> <span class="n">tcp_opts</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">xtables_register_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_match</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/libxtables/xtables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n821">libxtables/xtables.c#L821-#L861</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>821
822
823
824
825
826
827
828
829
830
831
832
833
834
835
836
837
838
839
840
841
842
843
844
845
846
847
848
849
850
851
852
853
854
855
856
857
858
859
860
861</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">xtables_register_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">xtables_match</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: match %s&lt;%u&gt; is missing a version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">XTABLES_VERSION</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: match </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> has version </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, &quot;</span>
                    <span class="s">&quot;but </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> is required.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">me</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">XTABLES_VERSION</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">XT_EXTENSION_MAXNAMELEN</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: match `%s&#39; has invalid name</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">NPROTO</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
                    <span class="s">&quot;%s: BUG: match %s has invalid protocol family</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">x6_options</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">xtables_option_metavalidate</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">x6_options</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">extra_opts</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">xtables_check_options</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">extra_opts</span><span class="p">);</span>

    <span class="cm">/* ignore not interested match */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&amp;&amp;</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">AF_UNSPEC</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

    <span class="cm">/* place on linked list of matches pending full registration */</span>
    <span class="n">me</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">xtables_pending_matches</span><span class="p">;</span>
    <span class="n">xtables_pending_matches</span> <span class="o">=</span> <span class="n">me</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/libxtables/xtables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n810">libxtables/xtables.c#L810-#L819</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>810
811
812
813
814
815
816
817
818
819</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">xtables_check_options</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="o">++</span><span class="n">opt</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">XT_OPTION_OFFSET_SCALE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: Extension %s uses invalid &quot;</span>
                            <span class="s">&quot;option value %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span>
                            <span class="n">name</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="original-opts">
<h3><tt class="docutils literal">original_opts</tt> の参照箇所</h3>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n118">iptables/iptables.c#L118-#L123</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>118
119
120
121
122
123</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">xtables_globals</span> <span class="n">iptables_globals</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">option_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">program_version</span> <span class="o">=</span> <span class="n">IPTABLES_VERSION</span><span class="p">,</span>
    <span class="p">.</span><span class="n">orig_opts</span> <span class="o">=</span> <span class="n">original_opts</span><span class="p">,</span>
    <span class="p">.</span><span class="n">exit_err</span> <span class="o">=</span> <span class="n">iptables_exit_error</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">iptables_globals.orig_opts</tt> の参照箇所のうちの1つ。</p>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n1300">iptables/iptables.c#L1300-#L1306</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1300
1301
1302
1303
1304
1305
1306</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="cm">/* Merge options for non-cloned matches */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">x6_options</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="n">xtables_options_xfrm</span><span class="p">(</span><span class="n">iptables_globals</span><span class="p">.</span><span class="n">orig_opts</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span>
                                        <span class="n">m</span><span class="o">-&gt;</span><span class="n">x6_options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">option_offset</span><span class="p">);</span>
    <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">extra_opts</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="n">xtables_merge_options</span><span class="p">(</span><span class="n">iptables_globals</span><span class="p">.</span><span class="n">orig_opts</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span>
                                         <span class="n">m</span><span class="o">-&gt;</span><span class="n">extra_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">option_offset</span><span class="p">);</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n171">iptables/iptables.c#L171</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>171</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define opts iptables_globals.opts</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="equivalent">
<h2>equivalentで検索した結果</h2>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n12">extensions/libxt_tcp.c#L12-#L27</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_help</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span>
<span class="s">&quot;tcp match options:</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;[!] --tcp-flags mask comp  match when TCP flags &amp; mask == comp</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;                           (Flags: SYN ACK FIN RST URG PSH ALL NONE)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;[!] --syn                  match when only SYN flag set</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;                           (equivalent to --tcp-flags SYN,RST,ACK,FIN SYN)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;[!] --source-port port[:port]</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; --sport ...</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;                           match source port(s)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;[!] --destination-port port[:port]</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot; --dport ...</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;                           match destination port(s)</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;[!] --tcp-option number        match if TCP option set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="id2">
<h2>コマンドとオプションの有効な組み合わせ</h2>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n125">iptables/iptables.c#L125-#L169</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Table of legal combinations of commands and options.  If any of the</span>
<span class="cm"> * given commands make an option legal, that option is legal (applies to</span>
<span class="cm"> * CMD_LIST and CMD_ZERO only).</span>
<span class="cm"> * Key:</span>
<span class="cm"> *  +  compulsory</span>
<span class="cm"> *  x  illegal</span>
<span class="cm"> *     optional</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">commands_v_options</span><span class="p">[</span><span class="n">NUMBER_OF_CMD</span><span class="p">][</span><span class="n">NUMBER_OF_OPT</span><span class="p">]</span> <span class="o">=</span>
<span class="cm">/* Well, it&#39;s better than &quot;Re: Linux vs FreeBSD&quot; */</span>
<span class="p">{</span>
    <span class="cm">/*     -n  -s  -d  -p  -j  -v  -x  -i  -o --line -c -f */</span>
<span class="cm">/*INSERT*/</span>    <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">},</span>
<span class="cm">/*DELETE*/</span>    <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">},</span>
<span class="cm">/*DELETE_NUM*/</span><span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*REPLACE*/</span>   <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">},</span>
<span class="cm">/*APPEND*/</span>    <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">},</span>
<span class="cm">/*LIST*/</span>      <span class="p">{</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*FLUSH*/</span>     <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*ZERO*/</span>      <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*NEW_CHAIN*/</span> <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*DEL_CHAIN*/</span> <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*SET_POLICY*/</span><span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*RENAME*/</span>    <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*LIST_RULES*/</span><span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*ZERO_NUM*/</span>  <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*CHECK*/</span>     <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">inverse_for_options</span><span class="p">[</span><span class="n">NUMBER_OF_OPT</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
<span class="cm">/* -n */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -s */</span> <span class="n">IPT_INV_SRCIP</span><span class="p">,</span>
<span class="cm">/* -d */</span> <span class="n">IPT_INV_DSTIP</span><span class="p">,</span>
<span class="cm">/* -p */</span> <span class="n">XT_INV_PROTO</span><span class="p">,</span>
<span class="cm">/* -j */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -v */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -x */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -i */</span> <span class="n">IPT_INV_VIA_IN</span><span class="p">,</span>
<span class="cm">/* -o */</span> <span class="n">IPT_INV_VIA_OUT</span><span class="p">,</span>
<span class="cm">/*--line*/</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -c */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -f */</span> <span class="n">IPT_INV_FRAG</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="tcp-flags">
<h2><tt class="docutils literal"><span class="pre">tcp-flags</span></tt> の値定義</h2>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n63">extensions/libxt_tcp.c#L63-#L77</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">tcp_flag_names</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_flag_names</span> <span class="n">tcp_flag_names</span><span class="p">[]</span>
<span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&quot;FIN&quot;</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;SYN&quot;</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;RST&quot;</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;PSH&quot;</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;ACK&quot;</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;URG&quot;</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;ALL&quot;</span><span class="p">,</span> <span class="mh">0x3F</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;NONE&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">strcasecmp</tt> で大文字小文字無視で比較していました。
<a class="reference external" href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n79">extensions/libxt_tcp.c#L79-#L102</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">parse_tcp_flag</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

    <span class="n">buffer</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tcp_flag_names</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">tcp_flag_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">ret</span> <span class="o">|=</span> <span class="n">tcp_flag_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">;</span>
                            <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tcp_flag_names</span><span class="p">))</span>
                    <span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
                               <span class="s">&quot;Unknown TCP flag `%s&#39;&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="dports">
<h2><tt class="docutils literal"><span class="pre">--dports</span></tt> などの値定義</h2>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n135">extensions/libxt_tcp.c#L135-#L138</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>135
136
137
138</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define TCP_SRC_PORTS 0x01</span>
<span class="cp">#define TCP_DST_PORTS 0x02</span>
<span class="cp">#define TCP_FLAGS 0x04</span>
<span class="cp">#define TCP_OPTION  0x08</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n140">extensions/libxt_tcp.c#L140-#L204</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span>
<span class="nf">tcp_parse</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">invert</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
          <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xt_entry_match</span> <span class="o">**</span><span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">xt_tcp</span> <span class="o">*</span><span class="n">tcpinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xt_tcp</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">match</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">&#39;1&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_SRC_PORTS</span><span class="p">)</span>
                    <span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
                               <span class="s">&quot;Only one `--source-port&#39; allowed&quot;</span><span class="p">);</span>
            <span class="n">parse_tcp_ports</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">spts</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
                    <span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">invflags</span> <span class="o">|=</span> <span class="n">XT_TCP_INV_SRCPT</span><span class="p">;</span>
            <span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCP_SRC_PORTS</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="sc">&#39;2&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_DST_PORTS</span><span class="p">)</span>
                    <span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
                               <span class="s">&quot;Only one `--destination-port&#39; allowed&quot;</span><span class="p">);</span>
            <span class="n">parse_tcp_ports</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">dpts</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
                    <span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">invflags</span> <span class="o">|=</span> <span class="n">XT_TCP_INV_DSTPT</span><span class="p">;</span>
            <span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCP_DST_PORTS</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="sc">&#39;3&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_FLAGS</span><span class="p">)</span>
                    <span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
                               <span class="s">&quot;Only one of `--syn&#39; or `--tcp-flags&#39; &quot;</span>
                               <span class="s">&quot; allowed&quot;</span><span class="p">);</span>
            <span class="n">parse_tcp_flags</span><span class="p">(</span><span class="n">tcpinfo</span><span class="p">,</span> <span class="s">&quot;SYN,RST,ACK,FIN&quot;</span><span class="p">,</span> <span class="s">&quot;SYN&quot;</span><span class="p">,</span> <span class="n">invert</span><span class="p">);</span>
            <span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCP_FLAGS</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="sc">&#39;4&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_FLAGS</span><span class="p">)</span>
                    <span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
                               <span class="s">&quot;Only one of `--syn&#39; or `--tcp-flags&#39; &quot;</span>
                               <span class="s">&quot; allowed&quot;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">]</span>
                <span class="o">||</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span> <span class="o">||</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
                    <span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
                               <span class="s">&quot;--tcp-flags requires two args.&quot;</span><span class="p">);</span>

            <span class="n">parse_tcp_flags</span><span class="p">(</span><span class="n">tcpinfo</span><span class="p">,</span> <span class="n">optarg</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">],</span>
                            <span class="n">invert</span><span class="p">);</span>
            <span class="n">optind</span><span class="o">++</span><span class="p">;</span>
            <span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCP_FLAGS</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="sc">&#39;5&#39;</span><span class="o">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_OPTION</span><span class="p">)</span>
                    <span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
                               <span class="s">&quot;Only one `--tcp-option&#39; allowed&quot;</span><span class="p">);</span>
            <span class="n">parse_tcp_option</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">option</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
                    <span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">invflags</span> <span class="o">|=</span> <span class="n">XT_TCP_INV_OPTION</span><span class="p">;</span>
            <span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCP_OPTION</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>