<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>ブログのソフトウェアをHugoからPelicanに切り替えた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/02/19/switch-from-hugo-to-pelican-for-blog-software/" rel="bookmark"
           title="Permalink to ブログのソフトウェアをHugoからPelicanに切り替えた">ブログのソフトウェアをHugoからPelicanに切り替えた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-02-19T23:20:00+09:00">
                Published: 2017-02-19
        </abbr>
		<br />
        <abbr class="modified" title="2017-02-20T16:34:00+09:00">
                Updated: 2017-02-20
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/pelican.html">pelican</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="https://gohugo.io/">Hugo</a> はビルドも速くて快適に使わせてもらっていました。ただ、コードブロックのシンタクスハイライトを使いたいと思って <a class="reference external" href="https://gohugo.io/extras/highlighting/">Syntax Highlighting</a> を読んだときにHugo独自の記法に依存するのが好ましくないなと思いました。Markdownには拡張の仕組みがないので仕方ないのですが。以前から <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> を使うようにしたいと思いつつ使えてなかったので、この機会に reStructuredText を使ってブログを書くようにしたいと思いました。</p>
<p>Hugoにも <a class="reference external" href="https://github.com/spf13/hugo/issues/1436">Add support for native Go implementation of reStructuredText (reST) · Issue #1436 · spf13/hugo</a> というイシューがあったのですが、まだ先は長そうな感じです。 また <a class="reference external" href="https://gohugo.io/extras/highlighting/">Syntax Highlighting</a> を見るとシンタクスハイライトで行番号を付けたい場合は <a class="reference external" href="http://pygments.org/">Pygments</a> というPythonで書かれたパッケージを使うということがわかりました。 それと reStructuredText 関連もGoよりPythonのほうが充実しています。</p>
<p>ということで、 Python で reStructuredText を扱えるブログパッケージを探してみると <a class="reference external" href="https://blog.getpelican.com/">Pelican Static Site Generator, Powered by Python</a> というのが見つかったので、これに乗り換えました。</p>
<p>この記事は乗り換えた時の作業メモと今後の記事を書く時の私用の手順メモです。</p>
</div>
<div class="section" id="pelican">
<h2>Pelicanのインストール</h2>
<p>CentOS 7環境を作りました。 <a class="reference external" href="https://ius.io/">IUS</a> のレポジトリから python36u パッケージをインストールした状態で以下のコマンドでインストールしました。</p>
<div class="highlight"><pre><span></span><span class="go">python3.6 -m venv venv</span>
<span class="go">source venv/bin/activate</span>
<span class="go">pip install pelican pygments ghp-import</span>
</pre></div>
<p>その後 <tt class="docutils literal">pip freeze &gt; pip_requirements.txt</tt> してあるので、後から <a class="reference external" href="https://github.com/hnakamur/blog/">hnakamur/blog: hnakamur's blog at github</a> を <tt class="docutils literal">git clone</tt> したときは以下の手順で構築できます。</p>
<div class="highlight"><pre><span></span><span class="go">python3.6 -m venv venv</span>
<span class="go">source venv/bin/activate</span>
<span class="go">pip install -r pip_requirements.txt</span>
</pre></div>
</div>
<div class="section" id="id3">
<h2>設定</h2>
<p>私は Octporess → Hugo → Pelican と移行しているので記事のURLがそのままになるように設定を調整しました。</p>
<p><a class="reference external" href="https://github.com/hnakamur/blog/blob/47217f6dc80d6148f9c9265014dee85e0b0f8408/pelicanconf.py#L43-L47">pelicanconf.py#L43-L47</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">RELATIVE_URLS</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">ARTICLE_URL</span> <span class="o">=</span> <span class="s1">&#39;{slug}/&#39;</span>
<span class="n">ARTICLE_SAVE_AS</span> <span class="o">=</span> <span class="s1">&#39;{slug}/index.html&#39;</span>
<span class="n">PAGE_URL</span> <span class="o">=</span> <span class="s1">&#39;pages/{slug}/&#39;</span>
<span class="n">PAGE_SAVE_AS</span> <span class="o">=</span> <span class="s1">&#39;pages/{slug}/index.html&#39;</span>
</pre></div>
</td></tr></table><p>他にも、日付のフォーマット、出力先ディレクトリ名、Google Analyticsの設定などを行っています。</p>
</div>
<div class="section" id="id4">
<h2>記事のメタ情報書き変え</h2>
<p>Pelican は Markdown と reStructuredText の両方が扱えるので、既存のMarkdownの記事は流用することにしました。
ただし作成日などのメタ情報は <a class="reference external" href="http://docs.getpelican.com/en/stable/content.html#file-metadata">File metadata</a> の形式に合わせる必要があります。
そこでPythonでその場限りのスクリプト <a class="reference external" href="https://github.com/hnakamur/blog/blob/47217f6dc80d6148f9c9265014dee85e0b0f8408/hugo2pelican.py">hugo2pelican.py</a> を書いて変換しました。</p>
<p>その後 slug の値に <tt class="docutils literal">blog/</tt> が入っていたのを削るため <a class="reference external" href="https://github.com/hnakamur/blog/blob/47217f6dc80d6148f9c9265014dee85e0b0f8408/hugo2pelican2.py">hugo2pelican2.py</a> で更に変換しました。
本来はデータを戻してスクリプトを書き変えて再実行するのが良いのですが、変換後にコミットしたりタグを手動修正したりしていたので、追加で変換しました。</p>
</div>
<div class="section" id="id5">
<h2>テーマのカスタマイズ</h2>
<p>デフォルトのテーマ <tt class="docutils literal">notmyidea</tt> のディレクトリ <tt class="docutils literal"><span class="pre">venv/lib/python3.6/site-packages/pelican/themes/notmyidea</span></tt> を <tt class="docutils literal">themes</tt> ディレクトリ以下に <tt class="docutils literal"><span class="pre">notmyidea-custom</span></tt>  という名前に変えてコピーしカスタマイズしました。</p>
<div class="section" id="css">
<h3>シンタクスハイライト用のCSS追加</h3>
<p><a class="reference external" href="https://github.com/hnakamur/blog/blob/47217f6dc80d6148f9c9265014dee85e0b0f8408/themes/notmyidea-custom/static/css/pygment.css#L1-L12">themes/notmyidea-custom/static/css/pygment.css#L1-L12</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">highlighttable</span> <span class="n">td</span> <span class="p">{</span>
<span class="n">padding</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">.</span><span class="n">highlighttable</span> <span class="n">td</span><span class="o">.</span><span class="n">linenos</span> <span class="p">{</span>
<span class="n">width</span><span class="p">:</span> <span class="mi">4</span><span class="n">rem</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">.</span><span class="n">highlighttable</span> <span class="n">td</span><span class="o">.</span><span class="n">linenos</span> <span class="n">pre</span> <span class="p">{</span>
<span class="n">text</span><span class="o">-</span><span class="n">align</span><span class="p">:</span> <span class="n">right</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">.</span><span class="n">highlighttable</span> <span class="n">pre</span> <span class="p">{</span>
<span class="n">margin</span><span class="p">:</span> <span class="mi">4</span><span class="n">px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="id6">
<h3>トップページの内容を記事一覧に変更</h3>
<p>Hugoを使っていた時はトップページは記事一覧にしていたので、テンプレートを大幅に書き変えて同じような内容にしました。
<a class="reference external" href="https://github.com/hnakamur/blog/commit/b59771b74408a71fae78a7a0d32fcd5348c6867e#diff-a88c508419b8e3db74c1a64be7f9d96f">Adjust theme for article list · hnakamur/blog&#64;b59771b</a></p>
<p>Pelicanは テンプレートエンジンとして <a class="reference external" href="http://jinja.pocoo.org/docs/2.9/">Jinja2</a> を使っています。
Ansibleでも使っていて私は慣れているのでさくっと変更できました。</p>
</div>
<div class="section" id="id7">
<h3>幅を広げる</h3>
<p>文章メインのブログでは元のテーマのほうが読みやすいと思いますが、コードブロックはなるべく幅を広くしておきたいので調整しました。
<a class="reference external" href="https://github.com/hnakamur/blog/commit/b6fba1ec659b53d38254d843e46ee396b64a7499#diff-a88c508419b8e3db74c1a64be7f9d96f">Modify theme to widen nav to 940px and content to 900px · hnakamur/blog&#64;b6fba1e</a></p>
</div>
</div>
<div class="section" id="id8">
<h2>記事を書く手順</h2>
<p>以下のコマンドを実行して、 <tt class="docutils literal">content</tt> ディレクトリ以下のファイルに変更を検知したらサイトのHTMLを自動生成するようにします。</p>
<div class="highlight"><pre><span></span><span class="go">source venv/bin/activate</span>
<span class="go">pelican -r content</span>
</pre></div>
<p>別の端末で以下のコマンドを実行して開発サーバを起動してプレビューできるようにしておきます。</p>
<div class="highlight"><pre><span></span><span class="go">source venv/bin/activate</span>
<span class="go">(cd public &amp;&amp; python -m pelican.server)</span>
</pre></div>
<p>この状態で <tt class="docutils literal"><span class="pre">contents/YYYY/MM/DD/my-super-title.rst</span></tt> という形式でファイルを作って編集します。
件名とメタ情報を <a class="reference external" href="http://docs.getpelican.com/en/stable/content.html#file-metadata">File metadata</a> の reStructuredText の形式で書きます。</p>
<div class="highlight"><pre><span></span><span class="gh">My super title</span>
<span class="gh">##############</span>

<span class="nc">:date:</span> <span class="nf">2017-02-19 23:20</span>
<span class="nc">:modified:</span> <span class="nf">2017-02-20 16:34</span>
<span class="nc">:tags:</span> <span class="nf">thats, awesome</span>
<span class="nc">:category:</span> <span class="nf">blog</span>
<span class="nc">:slug:</span> <span class="nf">YYYY/MM/DD/my-super-title</span>
</pre></div>
<p>保存する度に自動生成が動きます。
<a class="reference external" href="http://vps.sakura.ad.jp/">さくらのVPS</a> の1Gプランの環境で記事数119で12秒前後かかります。
Hugoのときに比べると長いですが、許容範囲です。</p>
<p><tt class="docutils literal"><span class="pre">code-block</span></tt> によるとシンタクスハイライトで使える言語一覧は <a class="reference external" href="http://pygments.org/docs/lexers/">Available lexers — Pygments</a> にあります。</p>
<p>記事を書き終わったら、以下のコマンドを実行して変更をコミットします。</p>
<div class="highlight"><pre><span></span><span class="go">git add .</span>
<span class="go">git commit -v</span>
</pre></div>
<p>実際はbashのエイリアスと <tt class="docutils literal"><span class="pre">~/.gitconfig</span></tt> でサブコマンドもエイリアスを付けているので以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="go">g a .</span>
<span class="go">g ci</span>
</pre></div>
</div>
<div class="section" id="github-pages">
<h2>記事をGitHub Pagesに公開</h2>
<p><a class="reference external" href="http://docs.getpelican.com/en/stable/tips.html?highlight=github%20pages#publishing-to-github">Publishing to GitHub</a> に説明があります。
私は Hugo のときに使っていた <tt class="docutils literal">deploy.sh</tt> を以下のように書き変えました。</p>
<p><a class="reference external" href="https://github.com/hnakamur/blog/blob/47217f6dc80d6148f9c9265014dee85e0b0f8408/deploy.sh">deploy.sh</a></p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">echo</span> -e <span class="s2">&quot;\033[0;32mDeploying updates to GitHub...\033[0m&quot;</span>

pelican content
ghp-import public
git push origin master gh-pages
</pre></div>
<p>今まで通り以下のコマンドで公開できます。</p>
<div class="highlight"><pre><span></span><span class="go">./deploy.sh</span>
</pre></div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>