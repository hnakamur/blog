<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
    <head>
        
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />

        <title>Kuberntesでデータ領域をNFSマウントしてMySQLを動かしてみた &middot; hnakamur&#39;s blog at github</title>
        <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600' type='text/css'>
        <link rel="stylesheet" href="https://hnakamur.github.io/blog//libraries/normalize.3.0.1.css" />
        <link rel="stylesheet" href="https://hnakamur.github.io/blog//css/liquorice.css" />
        <link rel="shortcut icon" href="/favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="/apple-touch-icon-144-precomposed.png" sizes="144x144" />
        <link rel="alternate" href="" type="application/rss+xml" title="hnakamur&#39;s blog at github" />
        
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', "UA-53263855-1", 'auto');
    ga('send', 'pageview');
</script>




    </head>
    <body class="li-body">

<header class="li-page-header">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-brand li-left">
                <a href="https://hnakamur.github.io/blog/">hnakamur&#39;s blog at github</a></div>
                <div class="li-menu li-right">
                    <span class="li-menu-icon" onclick="javascript:toggle('menu');">&#9776;</span>
                    <ul id="menu2" class="li-menu-items">
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="sixteen columns">
                <ul id="menu" class="li-menu-items li-menu-mobile">
                    
                </ul>
            </div>
        </div>
    </div>
</header>


    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <article class="li-article">
                    <header class="li-article-header">
                        <h1 class="li-article-title">Kuberntesでデータ領域をNFSマウントしてMySQLを動かしてみた</h1>
                        <time class="li-article-date">2017-01-01</time>
                    </header>
                    <section>
                        

<h2 id="はじめに">はじめに</h2>

<p><a href="/blog/2017/01/01/use-nfs-persistent-volume-on-minikube-virtualbox/">minikubeとVirtualBoxでNFSのpersistent volumeを試してみた · hnakamur&rsquo;s blog at github</a>の結果を踏まえて、 <a href="http://kubernetes.io/docs/tutorials/stateful-application/run-stateful-application/">Running a Single-Instance Stateful Application - Kubernetes</a> のチュートリアルを試してみたのでメモです。</p>

<h2 id="設定ファイル">設定ファイル</h2>

<pre><code>$ cat persistent-volume-nfs.yml
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-nfs
  labels:
    type: nfs
spec:
  capacity:
    storage: 30Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  nfs:
    # TODO: modify path and server appropriately
    path: /Users/hnakamur/kube-data/mysql
    server: 192.168.99.1
</code></pre>

<pre><code>$ cat mysql-pvc.yml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: mysql-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 15Gi
</code></pre>

<pre><code>$ cat mysql-deploy.yml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: mysql
spec:
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        env:
          # Use secret in real usage
        - name: MYSQL_ROOT_PASSWORD
          value: password
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
</code></pre>

<pre><code>$ cat mysql-svc.yml
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  ports:
    - port: 3306
  selector:
    app: mysql
  clusterIP: None
</code></pre>

<p>ハマった点としては、persistent volumeとpersistent volume claimのaccessModesは合わせないとうまく行きませんでした。具体的には <code>kubectl describe pvc mysql-pvc</code> で確認したときにStatusがPendingになっていました。</p>

<p><a href="http://kubernetes.io/docs/user-guide/persistent-volumes/#access-modes">Access Modes</a>にアクセスモードについての説明があります。</p>

<h2 id="サービスの作成と公開">サービスの作成と公開</h2>

<pre><code>kubectl create -f persistent-volume-nfs.yml
kubectl create -f mysql-pvc.yml
kubectl create -f mysql-deploy.yml
kubectl create -f mysql-svc.yml
</code></pre>

<h2 id="mysqlに接続してみる">MySQLに接続してみる</h2>

<p>まずMySQLコンテナのIPアドレスを調べます。</p>

<pre><code>$ kubectl get pods -o wide -l app=mysql
NAME                     READY     STATUS    RESTARTS   AGE       IP           NODE
mysql-4160924354-c5x2l   1/1       Running   0          3m        172.17.0.5   minikube
</code></pre>

<p>mysqlクライアントのイメージを使ってmysqlに接続します。
<code>If you don't see a command prompt, try pressing enter.</code> とある通り、そのままではプロンプトが表示されなかったのでエンターキーを押すと表示されました。</p>

<p>試しにデータベースをテーブルを作成してみます。その後 Control-D を押してmysqlクライアントを抜けます。</p>

<pre><code>$ kubectl run -it --rm --image=mysql:5.6 mysql-client -- mysql -h 172.17.0.5 -ppassword
Waiting for pod default/mysql-client-1703061864-g1p4s to be running, status is Pending, pod ready: false
If you don't see a command prompt, try pressing enter.

mysql&gt; create database test1;
Query OK, 1 row affected (0.00 sec)

mysql&gt; use test1;
Database changed
mysql&gt; create table table1 (id integer);
Query OK, 0 rows affected (0.02 sec)

mysql&gt; ^DBye
Session ended, resume using 'kubectl attach mysql-client-1703061864-g1p4s -c mysql-client -i -t' command when the pod is running
deployment &quot;mysql-client&quot; deleted
</code></pre>

<h2 id="mysqlサーバのpodを更新してみる">MySQLサーバのPodを更新してみる</h2>

<p>mysql-deploy.yml を書き変えて <code>kubectl apply</code> で更新してみます。</p>

<p>最初MYSQL_ROOT_PASSWORDの値を変えてみようかと思って試したのですが、よく考えるとこれはデータベース作成時に設定されてNFSでマウントしたデータ領域はそのまま残るので、この値を変えても更新できませんでした。</p>

<p>そこで、ラベルに <code>ver=5.6</code> というのを追加してみました。
最初5.6はダブルクォートで囲まずにyamlファイルに書いてみたのですが、エラーになったのでダブルクォートで囲んでいます。</p>

<pre><code>$ cat mysql-deploy.yml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: mysql
spec:
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
        ver: &quot;5.6&quot;
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        env:
          # Use secret in real usage
        - name: MYSQL_ROOT_PASSWORD
          value: password
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
</code></pre>

<p>以下のコマンドで反映しました。</p>

<pre><code>kubectl apply -f mysql-deploy.yml
</code></pre>

<p>再度mysqlに接続して、先ほど作成したデータベースとテーブルがあるかを確認します。</p>

<p>まずMySQLコンテナのIPアドレスを調べます。
spec.strategyがRecreateなので、コンテナが作り直されてIPアドレスも先程とは変わっています。</p>

<pre><code>$ kubectl get pods -o wide -l app=mysql
NAME                     READY     STATUS    RESTARTS   AGE       IP           NODE
mysql-1726459224-c5gps   1/1       Running   0          10s       172.17.0.6   minikube
</code></pre>

<p><code>kubectl describe po -l app=mysql</code> を実行してStateのStartedやEventsの時刻を見るとコンテナが作り直されたことがわかります。</p>

<p>mysqlに接続して、データベースとテーブルを確認します。</p>

<pre><code>$ kubectl run -it --rm --image=mysql:5.6 mysql-client -- mysql -h 172.17.0.6 -pmypassword
Waiting for pod default/mysql-client-1775806825-vxjgf to be running, status is Pending, pod ready: false
If you don't see a command prompt, try pressing enter.

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| test1              |
+--------------------+
4 rows in set (0.01 sec)

mysql&gt; use test1;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql&gt; show tables;
+-----------------+
| Tables_in_test1 |
+-----------------+
| table1          |
+-----------------+
1 row in set (0.00 sec)

mysql&gt; exit
Bye
Session ended, resume using 'kubectl attach mysql-client-1775806825-vxjgf -c mysql-client -i -t' command when the pod is running
deployment &quot;mysql-client&quot; deleted
</code></pre>

                    </section>
                </article>
            </div>
        </div>

        <div class="row li-author">
    <div class="sixteen columns">
        Written by <a href="https://hnakamur.github.io"><strong>Hiroaki Nakamura</strong></a>
    </div>
</div>


        <div class="row li-pagination">
            <div class="eight columns">
                <div class="li-pagination-previous">
                    
                        Later article<br />
                        <a href="https://hnakamur.github.io/blog/2017/01/01/tried-kubernetes-secrets/"> KubernetesのSecrets機能を試してみた</a>
                    
                </div>
            </div>
            <div class="eight columns">
                <div class="li-pagination-next">
                    
                        Older article<br />
                        <a href="https://hnakamur.github.io/blog/2017/01/01/use-nfs-persistent-volume-on-minikube-virtualbox/"> minikubeとVirtualBoxでNFSのpersistent volumeを試してみた</a>
                    
                </div>
            </div>
        </div>
    </div>

<footer class="li-page-footer">
    <div class="container">
        <div class="row">
            <div class="sixteen columns">
                <div class="li-page-footer-legal">
                    &copy; 2012-2017. All rights reserved. 
                </div>
                <div class="li-page-footer-theme">
                    <span class=""><a href="http://github.com/hnakamur/liquorice-hn/">liquorice-hn</a> is a theme for <a href="http://hugo.spf13.com">hugo</a></span>
                </div>
            </div>
        </div>
    </div>
</footer>

    <script type="text/javascript">
    <!--
    function toggle(id) {
        var e = document.getElementById(id);
        e.style.display == 'block' ? e.style.display = 'none' : e.style.display = 'block';
    }
    
    </script>

    </body>
</html>

