<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Kuberntesでデータ領域をNFSマウントしてMySQLを動かしてみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/01/01/tried-mysql-and-nfs-on-kubernetes/" rel="bookmark"
           title="Permalink to Kuberntesでデータ領域をNFSマウントしてMySQLを動かしてみた">Kuberntesでデータ領域をNFSマウントしてMySQLを動かしてみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-01-01T12:38:00+09:00">
                Published: 2017-01-01
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/kubernetes.html">kubernetes</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p><a href="/blog/2017/01/01/use-nfs-persistent-volume-on-minikube-virtualbox/">minikubeとVirtualBoxでNFSのpersistent volumeを試してみた · hnakamur's blog at github</a>の結果を踏まえて、 <a href="http://kubernetes.io/docs/tutorials/stateful-application/run-stateful-application/">Running a Single-Instance Stateful Application - Kubernetes</a> のチュートリアルを試してみたのでメモです。</p>
<h2>設定ファイル</h2>
<div class="highlight"><pre><span></span>$ cat persistent-volume-nfs.yml
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-nfs
  labels:
    type: nfs
spec:
  capacity:
    storage: 30Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  nfs:
    <span class="c1"># TODO: modify path and server appropriately</span>
    path: /Users/hnakamur/kube-data/mysql
    server: <span class="m">192</span>.168.99.1
</pre></div>


<div class="highlight"><pre><span></span>$ cat mysql-pvc.yml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: mysql-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 15Gi
</pre></div>


<div class="highlight"><pre><span></span>$ cat mysql-deploy.yml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: mysql
spec:
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        env:
          <span class="c1"># Use secret in real usage</span>
        - name: MYSQL_ROOT_PASSWORD
          value: password
        ports:
        - containerPort: <span class="m">3306</span>
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
</pre></div>


<div class="highlight"><pre><span></span>$ cat mysql-svc.yml
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  ports:
    - port: <span class="m">3306</span>
  selector:
    app: mysql
  clusterIP: None
</pre></div>


<p>ハマった点としては、persistent volumeとpersistent volume claimのaccessModesは合わせないとうまく行きませんでした。具体的には <code>kubectl describe pvc mysql-pvc</code> で確認したときにStatusがPendingになっていました。</p>
<p><a href="http://kubernetes.io/docs/user-guide/persistent-volumes/#access-modes">Access Modes</a>にアクセスモードについての説明があります。</p>
<h2>サービスの作成と公開</h2>
<div class="highlight"><pre><span></span>kubectl create -f persistent-volume-nfs.yml
kubectl create -f mysql-pvc.yml
kubectl create -f mysql-deploy.yml
kubectl create -f mysql-svc.yml
</pre></div>


<h2>MySQLに接続してみる</h2>
<p>まずMySQLコンテナのIPアドレスを調べます。</p>
<div class="highlight"><pre><span></span>$ kubectl get pods -o wide -l <span class="nv">app</span><span class="o">=</span>mysql
NAME                     READY     STATUS    RESTARTS   AGE       IP           NODE
mysql-4160924354-c5x2l   <span class="m">1</span>/1       Running   <span class="m">0</span>          3m        <span class="m">172</span>.17.0.5   minikube
</pre></div>


<p>mysqlクライアントのイメージを使ってmysqlに接続します。
<code>If you don't see a command prompt, try pressing enter.</code> とある通り、そのままではプロンプトが表示されなかったのでエンターキーを押すと表示されました。</p>
<p>試しにデータベースをテーブルを作成してみます。その後 Control-D を押してmysqlクライアントを抜けます。</p>
<div class="highlight"><pre><span></span>$ kubectl run -it --rm --image<span class="o">=</span>mysql:5.6 mysql-client -- mysql -h <span class="m">172</span>.17.0.5 -ppassword
Waiting <span class="k">for</span> pod default/mysql-client-1703061864-g1p4s to be running, status is Pending, pod ready: <span class="nb">false</span>
If you don<span class="s1">&#39;t see a command prompt, try pressing enter.</span>

<span class="s1">mysql&gt; create database test1;</span>
<span class="s1">Query OK, 1 row affected (0.00 sec)</span>

<span class="s1">mysql&gt; use test1;</span>
<span class="s1">Database changed</span>
<span class="s1">mysql&gt; create table table1 (id integer);</span>
<span class="s1">Query OK, 0 rows affected (0.02 sec)</span>

<span class="s1">mysql&gt; ^DBye</span>
<span class="s1">Session ended, resume using &#39;</span>kubectl attach mysql-client-1703061864-g1p4s -c mysql-client -i -t<span class="err">&#39;</span> <span class="nb">command</span> when the pod is running
deployment <span class="s2">&quot;mysql-client&quot;</span> deleted
</pre></div>


<h2>MySQLサーバのPodを更新してみる</h2>
<p>mysql-deploy.yml を書き変えて <code>kubectl apply</code> で更新してみます。</p>
<p>最初MYSQL_ROOT_PASSWORDの値を変えてみようかと思って試したのですが、よく考えるとこれはデータベース作成時に設定されてNFSでマウントしたデータ領域はそのまま残るので、この値を変えても更新できませんでした。</p>
<p>そこで、ラベルに <code>ver=5.6</code> というのを追加してみました。
最初5.6はダブルクォートで囲まずにyamlファイルに書いてみたのですが、エラーになったのでダブルクォートで囲んでいます。</p>
<div class="highlight"><pre><span></span>$ cat mysql-deploy.yml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: mysql
spec:
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
        ver: <span class="s2">&quot;5.6&quot;</span>
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        env:
          <span class="c1"># Use secret in real usage</span>
        - name: MYSQL_ROOT_PASSWORD
          value: password
        ports:
        - containerPort: <span class="m">3306</span>
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
</pre></div>


<p>以下のコマンドで反映しました。</p>
<div class="highlight"><pre><span></span>kubectl apply -f mysql-deploy.yml
</pre></div>


<p>再度mysqlに接続して、先ほど作成したデータベースとテーブルがあるかを確認します。</p>
<p>まずMySQLコンテナのIPアドレスを調べます。
spec.strategyがRecreateなので、コンテナが作り直されてIPアドレスも先程とは変わっています。</p>
<div class="highlight"><pre><span></span>$ kubectl get pods -o wide -l <span class="nv">app</span><span class="o">=</span>mysql
NAME                     READY     STATUS    RESTARTS   AGE       IP           NODE
mysql-1726459224-c5gps   <span class="m">1</span>/1       Running   <span class="m">0</span>          10s       <span class="m">172</span>.17.0.6   minikube
</pre></div>


<p><code>kubectl describe po -l app=mysql</code> を実行してStateのStartedやEventsの時刻を見るとコンテナが作り直されたことがわかります。</p>
<p>mysqlに接続して、データベースとテーブルを確認します。</p>
<div class="highlight"><pre><span></span>$ kubectl run -it --rm --image<span class="o">=</span>mysql:5.6 mysql-client -- mysql -h <span class="m">172</span>.17.0.6 -pmypassword
Waiting <span class="k">for</span> pod default/mysql-client-1775806825-vxjgf to be running, status is Pending, pod ready: <span class="nb">false</span>
If you don<span class="s1">&#39;t see a command prompt, try pressing enter.</span>

<span class="s1">mysql&gt; show databases;</span>
<span class="s1">+--------------------+</span>
<span class="s1">| Database           |</span>
<span class="s1">+--------------------+</span>
<span class="s1">| information_schema |</span>
<span class="s1">| mysql              |</span>
<span class="s1">| performance_schema |</span>
<span class="s1">| test1              |</span>
<span class="s1">+--------------------+</span>
<span class="s1">4 rows in set (0.01 sec)</span>

<span class="s1">mysql&gt; use test1;</span>
<span class="s1">Reading table information for completion of table and column names</span>
<span class="s1">You can turn off this feature to get a quicker startup with -A</span>

<span class="s1">Database changed</span>
<span class="s1">mysql&gt; show tables;</span>
<span class="s1">+-----------------+</span>
<span class="s1">| Tables_in_test1 |</span>
<span class="s1">+-----------------+</span>
<span class="s1">| table1          |</span>
<span class="s1">+-----------------+</span>
<span class="s1">1 row in set (0.00 sec)</span>

<span class="s1">mysql&gt; exit</span>
<span class="s1">Bye</span>
<span class="s1">Session ended, resume using &#39;</span>kubectl attach mysql-client-1775806825-vxjgf -c mysql-client -i -t<span class="err">&#39;</span> <span class="nb">command</span> when the pod is running
deployment <span class="s2">&quot;mysql-client&quot;</span> deleted
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>