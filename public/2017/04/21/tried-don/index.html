<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>github.com/deoxxa/donを試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/04/21/tried-don/" rel="bookmark"
           title="Permalink to github.com/deoxxa/donを試してみた">github.com/deoxxa/donを試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-04-21T02:00:00+09:00">
                Published: 2017-04-21
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/go.html">go</a> <a href="../../../../tag/mastodon.html">mastodon</a> <a href="../../../../tag/don.html">don</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="https://github.com/deoxxa/don">deoxxa/don: Less than half of mastodon.</a> はGoによる
<a class="reference external" href="https://github.com/tootsuite/mastodon/">tootsuite/mastodon</a> の実装です。
まだ開発中で、タイトルによるとmastodonの機能の半分以下らしいです。</p>
<p>この記事はdonをとりあえず動かしてみたメモです。</p>
</div>
<div class="section" id="nginxssl">
<h2>nginxとSSL証明書の設定</h2>
<p><a class="reference external" href="https://github.com/tootsuite/documentation/blob/master/Running-Mastodon/Production-guide.md#nginx">Production-guide.md のnginx</a> にそって設定し、SSL証明書も設定します。</p>
<p>私は <a class="reference external" href="https://github.com/hnakamur/mastadon-ansible-playbook">hnakamur/mastadon-ansible-playbook: さくらのVPSでmastodonをセットアップするAnsibleプレイブック</a> で構築した環境で <code>systemctl stop mastodon-web</code> でmastodonのサービスを止めた状態で試しました。</p>
</div>
<div class="section" id="don">
<h2>donのバイナリを取得</h2>
<p><a class="reference external" href="https://github.com/deoxxa/don">deoxxa/don: Less than half of mastodon.</a> の
<a class="reference external" href="https://github.com/deoxxa/don#prebuilt-binaries">Prebuilt Binaries</a> でlinux/amd64のバイナリをダウンロードしました。</p>
<div class="highlight"><pre><span></span><span class="go">curl --create-dirs -Lo ~/bin/don_dev &#39;https://bintray.com/deoxxa/don/download_file?file_path=don_dev_linux-amd64&#39;</span>
<span class="go">chmod +x ~/bin/don_dev</span>
</pre></div>
</div>
<div class="section" id="cookie-signing-key">
<h2>cookie_signing_keyオプションが必須</h2>
<p>READMEを読んで最初 <code>--public_url</code> オプションのみ指定したのですが、 <code>--cookie_signing_key</code> オプションも必須だというエラーになりました。</p>
<div class="highlight"><pre><span></span><span class="gp">ubuntu@naruh:~$</span> ~/bin/don_dev --public_url https://mstdn.naruh.com
<span class="go">don_dev: error: required flag --cookie_signing_key not provided, try --help</span>
</pre></div>
<p>コードを見ると <code>--cookie_signing_key</code> オプションと
<code>--cookie_encryption_key</code> オプションは16進数文字列で指定するようです。
<code>--cookie_encryption_key</code> オプションにも <code>Required()</code> がついているのでこれも必須です。</p>
<p><a class="reference external" href="https://github.com/deoxxa/don/blob/98d261c5dcf352131fe31fcfd464f8a876e1b845/main.go#L48-L49">don/main.go#L48-L49</a></p>
<div class="highlight"><pre><span></span><span class="nx">cookieSigningKey</span>      <span class="p">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Flag</span><span class="p">(</span><span class="s">&quot;cookie_signing_key&quot;</span><span class="p">,</span> <span class="s">&quot;Key for signing cookies.&quot;</span><span class="p">).</span><span class="nx">Envar</span><span class="p">(</span><span class="s">&quot;COOKIE_SIGNING_KEY&quot;</span><span class="p">).</span><span class="nx">Required</span><span class="p">().</span><span class="nx">HexBytes</span><span class="p">()</span>
<span class="nx">cookieEncryptionKey</span>   <span class="p">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Flag</span><span class="p">(</span><span class="s">&quot;cookie_encryption_key&quot;</span><span class="p">,</span> <span class="s">&quot;Key for encrypting cookies.&quot;</span><span class="p">).</span><span class="nx">Envar</span><span class="p">(</span><span class="s">&quot;COOKIE_ENCRYPTION_KEY&quot;</span><span class="p">).</span><span class="nx">Required</span><span class="p">().</span><span class="nx">HexBytes</span><span class="p">()</span>
</pre></div>
<p>使っている個所は
<a class="reference external" href="https://github.com/deoxxa/don/blob/98d261c5dcf352131fe31fcfd464f8a876e1b845/main.go#L126">don/main.go#L126</a></p>
<div class="highlight"><pre><span></span><span class="nx">ss</span> <span class="o">:=</span> <span class="nx">sessions</span><span class="p">.</span><span class="nx">NewCookieStore</span><span class="p">(</span><span class="o">*</span><span class="nx">cookieSigningKey</span><span class="p">,</span> <span class="o">*</span><span class="nx">cookieEncryptionKey</span><span class="p">)</span>
</pre></div>
<p>で、 <a class="reference external" href="https://github.com/deoxxa/don/blob/98d261c5dcf352131fe31fcfd464f8a876e1b845/main.go#L19">don/main.go#L19</a> を見ると <a class="reference external" href="https://github.com/gorilla/sessions">gorilla/sessions</a> を使っていました。</p>
<p><a class="reference external" href="https://godoc.org/github.com/gorilla/sessions#NewCookieStore">sessions.NewCookieStore のドキュメント</a> を見ると、キーペアの最初のキーが認証用で2つ目のキーが暗号化用とのことです。</p>
<p>認証用キーは32バイトか64バイトで、暗号化キーは16, 24, 32バイトのどれかが推奨となっていて、キーは <a class="reference external" href="https://godoc.org/github.com/gorilla/securecookie#GenerateRandomKey">securecookie.GenerateRandomKey</a> で生成すれば良いそうです。</p>
<p>ということで以下のコードを書いてキーを生成しました。</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&quot;encoding/hex&quot;</span>
    <span class="s">&quot;fmt&quot;</span>

    <span class="s">&quot;github.com/gorilla/securecookie&quot;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nx">generateRandomKey</span><span class="p">(</span><span class="nx">length</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">hex</span><span class="p">.</span><span class="nx">EncodeToString</span><span class="p">(</span><span class="nx">securecookie</span><span class="p">.</span><span class="nx">GenerateRandomKey</span><span class="p">(</span><span class="nx">length</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">signingKey</span> <span class="o">:=</span> <span class="nx">generateRandomKey</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
    <span class="nx">encryptingKey</span> <span class="o">:=</span> <span class="nx">generateRandomKey</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;--cookie_signing_key=%s --cookie_encryption_key=%s\n&quot;</span><span class="p">,</span> <span class="nx">signingKey</span><span class="p">,</span> <span class="nx">encryptingKey</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> go run main.go
<span class="go">--cookie_signing_key=5072237fbdb086f2541cac0fb007e97f9e6ab90b28e9045e3a754ce329591fc5158f9e46843baf975a6a7caa7bce04f835a9f2ce7113682a26d29e7d76eb5081 --cookie_encryption_key=580bab08ccbc59c98ad43dd2d13d199c79a0033d54e284f8198383c1d8fac196</span>
</pre></div>
</div>
<div class="section" id="id3">
<h2>実行</h2>
<p>以下のように実行すると、今度は起動しました (実際に実行するときはドメインは適宜調整してください)。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ~/bin/don_dev <span class="se">\</span>
  --cookie_signing_key<span class="o">=</span>5072237fbdb086f2541cac0fb007e97f9e6ab90b28e9045e3a754ce329591fc5158f9e46843baf975a6a7caa7bce04f835a9f2ce7113682a26d29e7d76eb5081 <span class="se">\</span>
  --cookie_encryption_key<span class="o">=</span>580bab08ccbc59c98ad43dd2d13d199c79a0033d54e284f8198383c1d8fac196 <span class="se">\</span>
  --addr <span class="s2">&quot;:3000&quot;</span> --public_url https://mstdn.example.com
</pre></div>
<p>サインアップフォームからアカウント名、メールアドレス、パスワードを入力すると、メールが送られることなくそのままサインアップ完了となりました。</p>
<p>サインアップしてみると以下のような画面になりました。</p>
<img alt="don top page" src="../../../../2017/04/21/tried-don/don.png" style="width: 544px; height: 110px;" />
<p>This is a ridiculously simple, read-only StatusNet node. Mostly an experiment. Source code is available.
と書かれていて、今はリードオンリーなStatusNetのノードとして動いている状態らしいです。</p>
<p>なるほど、読みと書きのうち読みだけなので、Less than half of mastodon というわけなんですね。
以上、とりあえず試してみました！</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>