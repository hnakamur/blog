<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>仮想マシンマネージャmultipassをWindowsとmacOSで試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2019/10/17/multipass-on-windows-and-macos/" rel="bookmark"
           title="Permalink to 仮想マシンマネージャmultipassをWindowsとmacOSで試してみた">仮想マシンマネージャmultipassをWindowsとmacOSで試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-10-17T06:00:00+09:00">
                Published: 2019-10-17
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/multipass.html">multipass</a> <a href="../../../../tag/virtualization.html">virtualization</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>multipass は私は Linux で <a class="reference external" href="https://snapcraft.io/first-snap#">Snapcraft - Snaps are universal Linux packages</a> のチュートリアルで snap パッケージを作ってみた時にインストールされたのが初めての出会いでしたが、その時はなんかまた新しい仮想マシンのツールが増えたのかぐらいに思っていました。</p>
<p>そこに <a class="reference external" href="https://gihyo.jp/admin/serial/01/ubuntu-recipe/0590">第590回　Windows/macOS/Linuxで使える仮想マシン管理ツール『multipass』：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社</a> の記事を見かけて、Linux以外に Windows と macOS でも使えることを知りました。</p>
<p>私は仕事で Linux のサーバサイドの開発環境を Windows と macOS 上に構築するのに <a class="reference external" href="https://www.virtualbox.org/">VirtualBox</a> と <a class="reference external" href="https://www.vagrantup.com/">Vagrant</a> で Ubuntu 仮想マシンを作ってそこで <a class="reference external" href="https://linuxcontainers.org/ja/lxd/introduction/">Linux Containers - LXD</a> を使って複数のコンテナを作るようにしています。</p>
<p>しかし <a class="reference external" href="https://news.mynavi.jp/article/20190515-823235/">Windows 10 WSL 2の詳細が明らかに、VMware/VirtualBoxとの併用不可 | マイナビニュース</a> にあるように、 WSL2 が Hyper-V のサブセットを使っていて VirtualBox と共存できないという問題があるので、どうしようか悩んでいました。私は Windows Insiders は使って無いので通常版の Windows で WSL2 がリリースされるのを待っている段階ですがリリースされたらぜひ使いたいのですが、一方で Windows と macOS で構築手順が分かれると構築用のスクリプトのメンテナンスが面倒なので出来れば統一しておきたいという思いもあるからです。</p>
<p><a class="reference external" href="https://github.com/microsoft/WSL/issues/4174">Is it Possible to Run WSL2 and Oracle VirtualBox? · Issue #4174 · microsoft/WSL</a> のコメントからリンクされている <a class="reference external" href="https://forums.virtualbox.org/viewtopic.php?f=6&amp;t=90853&amp;start=60#p445491">virtualbox.org • View topic - VirtualBox 6.0 and Hyper-V</a> によると VirtualBox 6.0 から Hyper-V 環境でも動かすためのサポートが入ったのですが highly pre-alpha という状態で、私も ThinkPad X260 の Windows 10 Pro で試してみたのですがうまく動きませんでした（詳細は失念）。</p>
<p><a class="reference external" href="https://github.com/CanonicalLtd/multipass">CanonicalLtd/multipass: Multipass orchestrates virtual Ubuntu instances</a> を見るとLinuxではKVM、WindowsではHyper-V、macOSではHyperKitを使い、WindowsとmacOSではVirtualBoxも使えるとあり、これで上記の問題が解決できるのでは、ということで喜んで試してみました。</p>
<p>macOS 用には <a class="reference external" href="https://qiita.com/satokaz/items/ab974af5632d1389add2">macOS で multipass やってみようぜ - Qiita</a> という良いまとめ記事があったのでこちらを参考にしつつ試して調べた内容をメモしておきます。</p>
</div>
<div class="section" id="windowsmacos">
<h2>Windows版とmacOS版のインストール</h2>
<p><a class="reference external" href="https://github.com/CanonicalLtd/multipass/releases">Releases · CanonicalLtd/multipass</a> にWindows版とmacOS版のインストーラがあるのでダウンロードしてインストールします。今回試したのはバージョン0.8.0です。</p>
</div>
<div class="section" id="windowsvirtualbox">
<h2>まずWindowsでVirtualBoxのドライバで試す</h2>
<p>職場のThinkPadではVirtualBoxを利用中ですぐにHyper-Vを有効には出来ない状態なので、まずはVirtualBoxドライバで試してみました。</p>
<p>現在選択されているドライバは管理者コマンドプロンプトで以下のコマンドで確認できます（一般ユーザのコマンドプロンプトでは権限不足でした）。</p>
<div class="highlight"><pre><span></span><span class="go">C:\&gt;multipass get local.driver</span>
<span class="go">hyperv</span>
</pre></div>
<p>上記のようにHyper-V無効の環境でも初期状態ではhypervになっています。そこで以下のコマンドを実行しvirtualboxドライバを使うように切り替えます。</p>
<div class="highlight"><pre><span></span><span class="go">multipass set local.driver virtualbox</span>
</pre></div>
<p><a class="reference external" href="https://gihyo.jp/admin/serial/01/ubuntu-recipe/0590">第590回　Windows/macOS/Linuxで使える仮想マシン管理ツール『multipass』：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社</a> の記事にも書かれていますがドライバの切り替えは気軽に行えるものではなく、インストール直後に設定してそれでずっと使うという感じのようです。</p>
<p>ここからは一般ユーザのコマンドプロンプトで実行可能でした（ただし管理者権限はついたユーザで試していて、管理者権限なしのユーザでも可能かは不明です）。</p>
<p>あと、別の環境で Hyper-V を有効にした Windows 10 Pro と macOS Mojave でも試しました。</p>
</div>
<div class="section" id="id2">
<h2>仮想マシンの基本操作</h2>
<p>以下の操作は <code>multipass</code> を <code>multipass.exe</code> とすれば <a class="reference external" href="https://github.com/mintty/wsltty">wsltty</a> でも可能でした（ただし後述のようにホストのディレクトリのマウントの初回実行はコマンドプロンプトで行う必要があるようでした）。</p>
<div class="section" id="id3">
<h3>仮想マシンの作成・起動</h3>
<p>以下のようにして仮想マシンを作成・起動します（オプションの説明は <code>multipass launch -h</code> を参照してください）。</p>
<div class="highlight"><pre><span></span><span class="go">multipass launch -n primary -c 2 -m 4G -d 100G</span>
</pre></div>
<p><code>-n</code> オプションを省略すると <code>petit-shrew</code> のようなランダムな名前が自動で設定されました。仮想マシンのシェルを実行する <code>multipass shell</code> コマンドなどがデフォルトでは <code>primary</code> という仮想マシンを対象とするので、仮想マシンを1つだけ作るのであれば上記のように <code>primary</code> という名前で作成するのが良いです。</p>
</div>
<div class="section" id="id4">
<h3>仮想マシンのシェル実行</h3>
<p><code>primary</code> の仮想マシンの場合は以下のように実行すると、インタラクティブなシェルが起動します。</p>
<div class="highlight"><pre><span></span><span class="go">multipass shell</span>
</pre></div>
<p>それ以外の場合は <code>multipass shell petit-shrew</code> のように仮想マシン名を引数に指定して起動します（<code>-n</code> オプションではないので注意。詳細は <code>multipass shell -h</code> を参照してください）。</p>
<p>上記のコマンドを実行すると <code>multipass</code> ユーザでログインした状態になります。シェルを終了するのは <code>exit</code> コマンドを実行するか Ctrl-D を押します。</p>
</div>
<div class="section" id="id5">
<h3>ホストのディレクトリのマウント</h3>
<p>仮想マシンのホストであるWindowsのディレクトリを仮想マシンにマウントするのは以下のようにします。ディレクトリ名は適宜変更してください。マウント先のディレクトリは自動的に作成されました。</p>
<div class="highlight"><pre><span></span><span class="go">multipass mount C:/Users/hnakamur/foo primary:foo</span>
</pre></div>
<p>マウント先は <code>primary</code> のようにマウント先ディレクトリ名を省略して仮想マシン名だけでも可能です。が、 <code>/home/multipass/C:/Users/hnakamur/foo</code> のようなディレクトリにマウントされ、しかも <code>/home/multipass/C:</code> ディレクトリの所有者が <code>root</code> になってしまいました。</p>
<p>上記のようにマウント先を <code>primary:foo</code> のように仮想マシン名とディレクトリの指定にすると <code>/home/multipass/foo</code> にマウントされ、所有者も <code>multipass</code> ユーザになります。こちらのほうがお勧めです。</p>
<p>マウントの初回実行時は <code>Enabling support for mounting</code> というメッセージと <code>\|/-</code> の文字がくるくる回るインジケータがしばらく表示されました。初回実行を wsltty から行ったときはこれがいつまでも続いたので待ちきれず端末のウィンドウを閉じました。初回だけコマンドプロンプトから実行しておけば、あとはwslttyからでも問題ないようです。</p>
</div>
<div class="section" id="id6">
<h3>仮想マシンの一覧表示</h3>
<p>実行例を以下に示します。</p>
<div class="highlight"><pre><span></span><span class="go">C:\&gt;multipass list</span>
<span class="go">Name                    State             IPv4             Image</span>
<span class="go">primary                 Running           192.168.133.102  Ubuntu 18.04 LTS</span>
</pre></div>
</div>
<div class="section" id="id7">
<h3>仮想マシンの情報表示</h3>
<p>実行例を以下に示します。マウント状態も確認できます。</p>
<div class="highlight"><pre><span></span><span class="go">C:\&gt;multipass info --all</span>
<span class="go">Name:           primary</span>
<span class="go">State:          Running</span>
<span class="go">IPv4:           192.168.133.102</span>
<span class="go">Release:        Ubuntu 18.04.3 LTS</span>
<span class="go">Image hash:     6204b6bff4ce (Ubuntu 18.04 LTS)</span>
<span class="go">Load:           0.22 0.08 0.02</span>
<span class="go">Disk usage:     1.7G out of 96.7G</span>
<span class="go">Memory usage:   3.0G out of 3.9G</span>
<span class="go">Mounts:         C:/Users/hnakamur/foo =&gt; foo</span>
<span class="go">                    UID map: -2:default</span>
<span class="go">                    GID map: -2:default</span>
</pre></div>
</div>
<div class="section" id="id8">
<h3>アンマウント</h3>
<p>以下のようにマウント先の仮想マシンとディレクトリを指定してアンマウントします。</p>
<div class="highlight"><pre><span></span><span class="go">multipass umount primary:foo</span>
</pre></div>
</div>
<div class="section" id="id9">
<h3>仮想マシン停止</h3>
<div class="highlight"><pre><span></span><span class="go">multipass stop VM名</span>
</pre></div>
</div>
<div class="section" id="id10">
<h3>仮想マシン起動</h3>
<div class="highlight"><pre><span></span><span class="go">multipass start VM名</span>
</pre></div>
</div>
<div class="section" id="id11">
<h3>仮想マシン削除</h3>
<p><code>-p</code> のpurgeオプションを付けて削除します。 <code>-p</code> なしだとファイルが残ったままになるらしいです。</p>
<div class="highlight"><pre><span></span><span class="go">multipass delete -p VM名</span>
</pre></div>
</div>
<div class="section" id="id12">
<h3>ヘルプ表示</h3>
<p>他にもサブコマンドがあります。 <code>-h</code> オプションでヘルプを見るのが手っ取り早いです。</p>
<div class="highlight"><pre><span></span><span class="go">C:\&gt;multipass -h</span>
<span class="go">Usage: multipass [options] &lt;command&gt;</span>
<span class="go">Create, control and connect to Ubuntu instances.</span>

<span class="go">This is a command line utility for multipass, a</span>
<span class="go">service that manages Ubuntu instances.</span>

<span class="go">Options:</span>
<span class="go">  -?, -h, --help  Display this help</span>
<span class="go">  -v, --verbose   Increase logging verbosity, repeat up to three times for more</span>
<span class="go">                  detail</span>

<span class="go">Available commands:</span>
<span class="go">  delete    Delete instances</span>
<span class="go">  exec      Run a command on an instance</span>
<span class="go">  find      Display available images to create instances from</span>
<span class="go">  get       Get a configuration option</span>
<span class="go">  help      Display help about a command</span>
<span class="go">  info      Display information about instances</span>
<span class="go">  launch    Create and start an Ubuntu instance</span>
<span class="go">  list      List all available instances</span>
<span class="go">  mount     Mount a local directory in the instance</span>
<span class="go">  purge     Purge all deleted instances permanently</span>
<span class="go">  recover   Recover deleted instances</span>
<span class="go">  restart   Restart instances</span>
<span class="go">  set       Set a configuration option</span>
<span class="go">  shell     Open a shell on a running instance</span>
<span class="go">  start     Start instances</span>
<span class="go">  stop      Stop running instances</span>
<span class="go">  suspend   Suspend running instances</span>
<span class="go">  transfer  Transfer files between the host and instances</span>
<span class="go">  umount    Unmount a directory from an instance</span>
<span class="go">  version   Show version details</span>
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h2>調査メモ</h2>
<p>以下こまごまとしたメモ。</p>
<div class="section" id="c-qt5">
<h3>C++とQt5で書かれている</h3>
<p><a class="reference external" href="https://github.com/CanonicalLtd/multipass">CanonicalLtd/multipass: Multipass orchestrates virtual Ubuntu instances</a> を見るとソースはC++とQt5で書かれています。 <a class="reference external" href="https://github.com/CanonicalLtd/multipass/blob/v0.8.0/COPYING.GPL.txt">COPYING.GPL.txt</a> を見るとライセンスは GPLv3 です。</p>
</div>
<div class="section" id="id14">
<h3>WindowsでVirtualBoxドライバで試したときのメモ</h3>
<ul class="simple">
<li>ネットワークインタフェース名は <code>enp0s3</code> になった。</li>
<li>IPアドレスは 10.0.2.15/24。なのでVirtualBoxのNATのネットワークアダプタが使われている模様。</li>
<li><code>multipass info --all</code> の出力で IPv4 のアドレスは N/A と表示。</li>
<li>VirtualBoxマネージャにはVMは表示されない。</li>
<li>仮想マシンのイメージファイルは <code>C:\Windows\System32\config\systemprofile\VirtualBox VMs\Multipass</code> 以下に仮想マシン名のディレクトリが作られてそこに置かれている。ファイル名は仮想マシン名 + .vbox。</li>
<li><code>%USERPROFILE%\AppData\Roaming\multipass\client-certificate</code> というディレクトリに <code>multipass_cert.pem</code> と <code>multipass_cert_key.pem</code> という鍵と証明書がある。</li>
</ul>
</div>
<div class="section" id="windowshyper-v">
<h3>WindowsでHyper-Vドライバで試したときのメモ</h3>
<ul class="simple">
<li>ネットワークインタフェース名は <code>eth0</code> になった。</li>
<li>IPアドレスはランダムに割り当てられる（例： 192.168.133.102）。 <code>multipass info</code> コマンドのIPv4の欄でも確認可能。</li>
<li>仮想マシンのイメージファイルは <code>C:\Windows\System32\config\systemprofile\AppData\Roaming\multipassd\vault\instances</code> 以下に仮想マシン名のディレクトリが作られてそこに置かれている。拡張子は <code>.vhdx</code> と <code>.avhdx</code> 。 また <code>cloud-init-config.iso</code> というファイルもあった。</li>
<li><code>%USERPROFILE%\AppData\Roaming\multipass\client-certificate</code> というディレクトリに <code>multipass_cert.pem</code> と <code>multipass_cert_key.pem</code> という鍵と証明書がある（これはVirtualBoxドライバの場合と同じ）。</li>
</ul>
</div>
<div class="section" id="macos-mojave">
<h3>macOS Mojaveで試したときのメモ</h3>
<ul class="simple">
<li>ネットワークインタフェース名は <code>enp0s2</code> になった。</li>
<li>IPアドレスはランダムに割り当てられる（例： 192.168.64.2）。 <code>multipass info</code> コマンドのIPv4の欄でも確認可能。</li>
<li>仮想マシンのイメージファイルは <code>/var/root/Library/Application Support/multipassd/vault/instances/</code> 以下に仮想マシン名のディレクトリが作られてそこに置かれている。また <code>cloud-init-config.iso</code> というファイルもあった。</li>
<li><code>~/Library/Application Support/multipass/client-certificates</code> ディレクトリに <code>multipass_cert.pem</code> と <code>multipass_cert_key.pem</code> という鍵と証明書がある。</li>
</ul>
</div>
<div class="section" id="root-ssh-authorized-keys">
<h3>仮想マシン内の/root/.ssh/authorized_keys</h3>
<p>私は面倒くさがりなのでホストからrootユーザでsshできるように <code>~multipass/.ssh/authorized_keys</code> を <code>/root/.ssh</code> にコピーしようとしたら既にファイルがあることに気づきました。内容を確認すると以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="gp">multipass@primary:~$</span> sudo cat /root/.ssh/authorized_keys
<span class="go">no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command=&quot;echo &#39;Please login as the user \&quot;multipass\&quot; rather than the user \&quot;root\&quot;.&#39;;echo;sleep 10&quot; ssh-rsa AAAAB...(snip)...Ybx multipass@localhost</span>
</pre></div>
<p><code>root</code> ユーザでログインせずに <code>multipass</code> ユーザでログインせよとのことです。ここまでして啓蒙してくれているのでおとなしく従おうかなという気になりました。</p>
</div>
</div>
<div class="section" id="id15">
<h2>おわりに</h2>
<p>とりあえず試してみた感じでは良さそうです。VM起動時に <code>--clout-init</code> オプションで <a class="reference external" href="https://github.com/cloud-init/cloud-init/">cloud-init</a> を使った初期設定も行えるのでこちらも試していきたいところです。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>