<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.133.1">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>VictoriMetrics/fastcacheによるGoのGC負荷の回避方法 &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2024. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>VictoriMetrics/fastcacheによるGoのGC負荷の回避方法</h1>
  <time datetime=2019-12-29T16:00:00&#43;0900 class="post-date">2019-12-29</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#ベンチマーク">ベンチマーク</a></li>
    <li><a href="#fastcache-のアーキテクチャ">fastcache のアーキテクチャ</a></li>
    <li><a href="#まとめ">まとめ</a></li>
  </ul>
</nav>
  <h2 id="背景">背景</h2>
<p><a href="https://github.com/VictoriaMetrics/VictoriaMetrics">VictoriaMetrics</a> で <code>foo.bar.baz</code> といったメトリクス名からIDへのマッピングは
<a href="https://github.com/VictoriaMetrics/fastcache">VictoriaMetrics/fastcache</a> というキーバリューストアで保管されています。ということで調査したメモ。</p>
<h2 id="ベンチマーク">ベンチマーク</h2>
<p>ベンチマークがついているので自分のサーバでも試してみました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> <span class="nv">GOMAXPROCS</span><span class="o">=</span><span class="m">4</span> go <span class="nb">test</span> github.com/VictoriaMetrics/fastcache -bench<span class="o">=</span><span class="s1">&#39;Set|Get&#39;</span> -benchtime<span class="o">=</span>10s
</span></span><span class="line"><span class="cl"><span class="go">go: downloading github.com/allegro/bigcache v1.2.1-0.20190218064605-e24eb225f156
</span></span></span><span class="line"><span class="cl"><span class="go">go: extracting github.com/allegro/bigcache v1.2.1-0.20190218064605-e24eb225f156
</span></span></span><span class="line"><span class="cl"><span class="go">goos: linux
</span></span></span><span class="line"><span class="cl"><span class="go">goarch: amd64
</span></span></span><span class="line"><span class="cl"><span class="go">pkg: github.com/VictoriaMetrics/fastcache
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkSetBig-4                 445272             26828 ns/op        9771.25 MB/s           3 B/op          0 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkGetBig-4                 520488             22983 ns/op        11806.75 MB/s          5 B/op          0 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkBigCacheSet-4              1003          12917688 ns/op           5.07 MB/s     4508913 B/op         10 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkBigCacheGet-4              1406           7261204 ns/op           9.03 MB/s      751703 B/op     131077 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkBigCacheSetGet-4            601          20793950 ns/op           6.30 MB/s     5055210 B/op     131087 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkCacheSet-4                 2865           3851611 ns/op          17.02 MB/s        1994 B/op          4 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkCacheGet-4                 2983           3733081 ns/op          17.56 MB/s        1916 B/op          3 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkCacheSetGet-4              1483           7788285 ns/op          16.83 MB/s        3851 B/op          7 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkStdMapSet-4                 756          15678413 ns/op           4.18 MB/s      278780 B/op      65539 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkStdMapGet-4                3852           2794116 ns/op          23.46 MB/s        3328 B/op         17 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkStdMapSetGet-4              127          96927749 ns/op           1.35 MB/s      361095 B/op      65554 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkSyncMapSet-4                271          43889357 ns/op           1.49 MB/s     3442234 B/op     262636 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkSyncMapGet-4               2641           3788181 ns/op          17.30 MB/s        4816 B/op        149 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">BenchmarkSyncMapSetGet-4             596          18809556 ns/op           6.97 MB/s     3423522 B/op     262367 allocs/op
</span></span></span><span class="line"><span class="cl"><span class="go">PASS
</span></span></span><span class="line"><span class="cl"><span class="go">ok      github.com/VictoriaMetrics/fastcache    193.857s
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> go version
</span></span><span class="line"><span class="cl"><span class="go">go version go1.13.5 linux/amd64
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">hnakamur@express:~/ghq/github.com/VictoriaMetrics/fastcache$ git rev-parse HEAD
</span></span></span><span class="line"><span class="cl"><span class="go">c9a5939fd508ba790b708b23929feea13623d735
</span></span></span></code></pre></div><p>CPU は <a href="https://ark.intel.com/content/www/jp/ja/ark/products/43546/intel-core-i5-650-processor-4m-cache-3-20-ghz.html">インテル® Core™ i5-650 プロセッサー (4M キャッシュ、3.20 GHz) 製品仕様</a> で2コア4スレッドです。</p>
<p>API <a href="https://pkg.go.dev/github.com/VictoriaMetrics/fastcache?tab=doc">fastcache package · go.dev</a> は README にある通りシンプルです。ちょっと変わっているのは <code>Get</code>, <code>Set</code> の他に 64KB 以上の値用に <code>GetBig</code>, <code>SetBig</code> という別の API が用意されている点です。</p>
<p>上記のベンチマークのうち SetBig, GetBig, CacheSet, CacheGet, CacheSetGet が fastcache の API です。どれも1操作当たりのメモリ割り当て回数 (allocs/op) が非常に少なく高速であることがわかります。メモリ割り当て回数が少ないのは <a href="https://golang.org/pkg/sync/#Pool">sync.Pool</a> を活用しているからです。 VictoriaMetrics の開発者は <a href="https://github.com/valyala/fasthttp">valyala/fasthttp</a> と同じ方でそちらでも <a href="https://golang.org/pkg/sync/#Pool">sync.Pool</a> を活用することで高速化を実現されています。</p>
<h2 id="fastcache-のアーキテクチャ">fastcache のアーキテクチャ</h2>
<p>READMEの <a href="https://github.com/VictoriaMetrics/fastcache#architecture-details">Architecture details</a> に説明があります。</p>
<p>そこからリンクされている <a href="https://syslog.ravelin.com/further-dangers-of-large-heaps-in-go-7a267b57d487">Further Dangers of Large Heaps in Go - Ravelin Tech Blog</a> が GC のオーバーヘッドについての素晴らしい記事でした。一言で言うとポインタが増えすぎると GC がそれらをスキャンして回るのが追い付かなくなるということです。 GC も銀の弾丸ではなく限界があるというわけです。冷静に考えれば当然のことで、アプリケーションの処理を進めるために GC に使う時間を限定すると、その時間の中で出来ることには限界があるわけです。</p>
<p>（実は私も過去に似た体験をしてました。 <a href="https://github.com/lomik/go-carbon">lomik/go-carbon</a> の負荷テストの CLI を Go で書いて1週間流しっぱなしにしたときに ps でみると使用メモリがじわじわ増えていくという現象が起きました）</p>
<p>回避策として mmap でメモリ割り当てして GC の対象外 (off-heap) なところでデータを扱うという方法があります。ただしその中に Go のオブジェクトは置けないので、バイト列として <a href="https://golang.org/pkg/unsafe/">unsafe</a> でアクセスするか、そこから読み取った値を元に Go のオブジェクトを別途作成する必要があります。でも後者だと二重管理になってメモリも二重に必要になるので、極力前者の方式をとるべきです。すると mmap で割り当てたメモリ領域の中で整数や浮動小数点やバイト列を置くのは良いとして、ポインタに関してはポインタを使わずなんらかのインデクスやオフセットでデータ構造を実現することになります。もしくはポインタの先を Go でメモリ割り当てしたデータ構造ではなく別の mmap 呼び出しで割り当てたメモリ領域内のアドレスにする手もありますね。</p>
<p><a href="https://github.com/VictoriaMetrics/fastcache#architecture-details">Architecture details</a> に戻ると mmap で一度に割り当てるメモリのチャンクサイズが大きいと GC の負荷が大きくなるので fastcache では 64KiB にしているそうです。これによりメモリのフラグメンテーションとトータルのメモリ使用量が抑えられるとのことです。</p>
<p>（<a href="/blog/2019/12/29/cgo-and-unsafe/">cgoとunsafeについてのメモ · hnakamur&rsquo;s blog</a> を書いたときは mmap の代わりに <code>C.malloc</code> でも良いかもと思ったのですが <a href="https://stackoverflow.com/questions/52417318/why-does-the-free-function-not-return-memory-to-the-operating-system/52417370">c++ - Why does the free() function not return memory to the operating system? - Stack Overflow</a> や <a href="https://www.linuxquestions.org/questions/linux-newbie-8/freed-memory-does-not-return-to-system-is-it-able-to-used-by-running-application-4175521572/">freed memory does not return to system , is it able to used by running application</a> を見ると <code>free</code> を読んでも OS にメモリが返却されないので mmap を使うほうが良さそうです。）</p>
<p>上で書いた 64KB 以上の値用に <code>GetBig</code>, <code>SetBig</code> という別の API が用意されているのはこれが理由だったんですね。</p>
<h2 id="まとめ">まとめ</h2>
<p>まとめると VictoriMetrics/fastcache によるGoのGC負荷の回避方法は以下の2点です。</p>
<ul>
<li>Goのオブジェクトは極力 <a href="https://golang.org/pkg/sync/#Pool">sync.Pool</a> を使って再利用することでメモリ割り当て回数を減らす。</li>
<li>Goのポインタを使わずに表せるデータ構造は mmap で割り当てて GC の対象外とし GC の負担を減らす。</li>
</ul>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>
  </body>
</html>
