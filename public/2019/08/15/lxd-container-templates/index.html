<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>LXDでコンテナの初期化に使われるテンプレート</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2019/08/15/lxd-container-templates/" rel="bookmark"
           title="Permalink to LXDでコンテナの初期化に使われるテンプレート">LXDでコンテナの初期化に使われるテンプレート</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-08-15T11:00:00+09:00">
                Published: 2019-08-15
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/lxd.html">lxd</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="https://cloudinit.readthedocs.io/en/latest/topics/dir_layout.html">Custom network configuration with cloud-init - LXD - system container manager</a> に説明がありますが、LXDのコンテナイメージにはいくつかのテンプレートファイルがメタデータとして含まれていて、コンテナの初期化の際に使用されます。</p>
<p>CentOS 7 のコンテナは cloud-init 非対応ですが、 Ubuntu のほうは cloud-init に対応していますので、 cloud-init を利用して初期化時に様々な設定が可能です。</p>
<p>今後の参照用にテンプレートの内容を以下にメモしておきます。</p>
</div>
<div class="section" id="id2">
<h2>ローカルにダウンロードされたイメージ</h2>
<p><code>lxc launch ubuntu:18.04 コンテナ名</code> で Ubuntu 18.04 LTS のコンテナを作成し、
<code>lxc launch images:centos/7 コンテナ名</code> で CentOS 7 のコンテナを作成した後、
ローカルにダウンロードされたイメージを確認すると以下のようになっていました
（イメージの fingerprint はイメージのバージョンによって異なります）。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> lxc image list
<span class="go">+-------+--------------+--------+-----------------------------------------------+--------+----------+-------------------------------+</span>
<span class="go">| ALIAS | FINGERPRINT  | PUBLIC |                  DESCRIPTION                  |  ARCH  |   SIZE   |          UPLOAD DATE          |</span>
<span class="go">+-------+--------------+--------+-----------------------------------------------+--------+----------+-------------------------------+</span>
<span class="go">|       | 2dd611e2689a | no     | ubuntu 18.04 LTS amd64 (release) (20190813.1) | x86_64 | 177.60MB | Aug 14, 2019 at 11:07pm (UTC) |</span>
<span class="go">+-------+--------------+--------+-----------------------------------------------+--------+----------+-------------------------------+</span>
<span class="go">|       | a0f13708a581 | no     | Centos 7 amd64 (20190814_07:08)               | x86_64 | 84.07MB  | Aug 15, 2019 at 1:29am (UTC)  |</span>
<span class="go">+-------+--------------+--------+-----------------------------------------------+--------+----------+-------------------------------+</span>
</pre></div>
<p>私は LXD を snap でインストールしているのでローカルにダウンロードされたイメージは <code>/var/snap/lxd/common/lxd/images/</code> にあります。</p>
<p>file コマンドで確認すると fingerprint と同じ名前のファイルと <code>.rootfs</code> の拡張子がついたファイルがあり、前者は xz で圧縮されたデータ、後者は squashfs のファイルシステム形式であることがわかります。前者は実際は .tar.xz 形式になっています。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> sudo sh -c <span class="s1">&#39;file /var/snap/lxd/common/lxd/images/*&#39;</span>
<span class="go">/var/snap/lxd/common/lxd/images/2dd611e2689a8efc45807bd2a86933cf2da0ffc768f57814724a73b5db499eac:        XZ compressed data</span>
<span class="go">/var/snap/lxd/common/lxd/images/2dd611e2689a8efc45807bd2a86933cf2da0ffc768f57814724a73b5db499eac.rootfs: Squashfs filesystem, little endian, version 4.0, 186228545 bytes, 35653 inodes, blocksize: 131072 bytes, created: Tue Aug 13 16:35:42 2019</span>
<span class="go">/var/snap/lxd/common/lxd/images/a0f13708a581b3d73de64a785559ae1c5ce773e4b7eb009eedb032563c851994:        XZ compressed data</span>
<span class="go">/var/snap/lxd/common/lxd/images/a0f13708a581b3d73de64a785559ae1c5ce773e4b7eb009eedb032563c851994.rootfs: Squashfs filesystem, little endian, version 4.0, 88156577 bytes, 14110 inodes, blocksize: 1048576 bytes, created: Wed Aug 14 07:22:52 2019</span>
</pre></div>
</div>
<div class="section" id="ubuntu-18-04-lts">
<h2>Ubuntu 18.04 LTS イメージのテンプレート</h2>
<p>以下のコマンドでテンプレートを展開します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> mkdir /tmp/ubuntu-templates
<span class="gp">$</span> sudo tar xf /var/snap/lxd/common/lxd/images/2dd611e2689a8efc45807bd2a86933cf2da0ffc768f57814724a73b5db499eac -C /tmp/ubuntu-templates/
</pre></div>
<p>ファイル一覧は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="o">(</span><span class="nb">cd</span> /tmp/ubuntu-templates/<span class="p">;</span> find . -type f <span class="p">|</span> sort<span class="o">)</span>
<span class="go">./metadata.yaml</span>
<span class="go">./templates/cloud-init-meta.tpl</span>
<span class="go">./templates/cloud-init-network.tpl</span>
<span class="go">./templates/cloud-init-user.tpl</span>
<span class="go">./templates/cloud-init-vendor.tpl</span>
<span class="go">./templates/hostname.tpl</span>
</pre></div>
<p>metadata.yaml の内容は以下の通りです。上記の <code>*.tpl</code> のテンプレートファイルがどのパスに展開されるかの対応が分かります。</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">architecture</span><span class="p p-Indicator">:</span> <span class="s">&quot;x86_64&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">creation_date</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1565716206</span>
<span class="l l-Scalar l-Scalar-Plain">properties</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">architecture</span><span class="p p-Indicator">:</span> <span class="s">&quot;x86_64&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">description</span><span class="p p-Indicator">:</span> <span class="s">&quot;Ubuntu</span><span class="nv"> </span><span class="s">18.04</span><span class="nv"> </span><span class="s">LTS</span><span class="nv"> </span><span class="s">server</span><span class="nv"> </span><span class="s">(20190813.1)&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">os</span><span class="p p-Indicator">:</span> <span class="s">&quot;ubuntu&quot;</span>
    <span class="l l-Scalar l-Scalar-Plain">release</span><span class="p p-Indicator">:</span> <span class="s">&quot;bionic&quot;</span>
<span class="l l-Scalar l-Scalar-Plain">templates</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">/etc/hostname</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">create</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">copy</span>
        <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">hostname.tpl</span>
    <span class="l l-Scalar l-Scalar-Plain">/var/lib/cloud/seed/nocloud-net/meta-data</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">create</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">copy</span>
        <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloud-init-meta.tpl</span>
    <span class="l l-Scalar l-Scalar-Plain">/var/lib/cloud/seed/nocloud-net/network-config</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">create</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">copy</span>
        <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloud-init-network.tpl</span>
    <span class="l l-Scalar l-Scalar-Plain">/var/lib/cloud/seed/nocloud-net/user-data</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">create</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">copy</span>
        <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloud-init-user.tpl</span>
        <span class="l l-Scalar l-Scalar-Plain">properties</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
                <span class="no">#cloud-config</span>
                <span class="no">{}</span>
    <span class="l l-Scalar l-Scalar-Plain">/var/lib/cloud/seed/nocloud-net/vendor-data</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">when</span><span class="p p-Indicator">:</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">create</span>
            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">copy</span>
        <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">cloud-init-vendor.tpl</span>
        <span class="l l-Scalar l-Scalar-Plain">properties</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">default</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|</span>
                <span class="no">#cloud-config</span>
                <span class="no">{}</span>
</pre></div>
<p>templates/cloud-init-meta.tpl の内容は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">instance-id</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{{</span> <span class="nv">container.name</span> <span class="p p-Indicator">}}</span>
<span class="l l-Scalar l-Scalar-Plain">local-hostname</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{{</span> <span class="nv">container.name</span> <span class="p p-Indicator">}}</span>
<span class="p p-Indicator">{{</span> <span class="nv">config_get(&quot;user.meta-data&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;&quot;</span><span class="nv">)</span> <span class="p p-Indicator">}}</span>
</pre></div>
<p>templates/cloud-init-network.tpl の内容は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">{</span><span class="err">%</span> <span class="nv">if config_get(&quot;user.network-config&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;&quot;</span><span class="nv">) == &quot;&quot; %</span><span class="p p-Indicator">}</span><span class="l l-Scalar l-Scalar-Plain">version</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="l l-Scalar l-Scalar-Plain">config</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">physical</span>
      <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">eth0</span>
      <span class="l l-Scalar l-Scalar-Plain">subnets</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">{</span><span class="err">%</span> <span class="nv">if config_get(&quot;user.network_mode&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;&quot;</span><span class="nv">) == &quot;link-local&quot; %</span><span class="p p-Indicator">}</span><span class="l l-Scalar l-Scalar-Plain">manual{% else %}dhcp{% endif %}</span>
            <span class="l l-Scalar l-Scalar-Plain">control</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">auto{% else %}{{ config_get(&quot;user.network-config&quot;, &quot;&quot;) }}{% endif %}</span>
</pre></div>
<p>templates/cloud-init-user.tpl の内容は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">{{</span> <span class="nv">config_get(&quot;user.user-data&quot;</span><span class="p p-Indicator">,</span> <span class="nv">properties.default)</span> <span class="p p-Indicator">}}</span>
</pre></div>
<p>templates/cloud-init-vendor.tpl の内容は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">{{</span> <span class="nv">config_get(&quot;user.vendor-data&quot;</span><span class="p p-Indicator">,</span> <span class="nv">properties.default)</span> <span class="p p-Indicator">}}</span>
</pre></div>
<p>templates/hostname.tpl の内容は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">{{</span> <span class="nv">container.name</span> <span class="p p-Indicator">}}</span>
</pre></div>
</div>
<div class="section" id="centos-7">
<h2>CentOS 7 イメージのテンプレート</h2>
<p>以下のコマンドでテンプレートを展開します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> mkdir /tmp/centos7-templates
<span class="gp">$</span> sudo tar xf /var/snap/lxd/common/lxd/images/a0f13708a581b3d73de64a785559ae1c5ce773e4b7eb009eedb032563c851994 -C /tmp/centos7-templates
</pre></div>
<p>ファイル一覧は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="o">(</span><span class="nb">cd</span> /tmp/centos7-templates/<span class="p">;</span> find . -type f <span class="p">|</span> sort<span class="o">)</span>
<span class="go">./metadata.yaml</span>
<span class="go">./templates/hosts.tpl</span>
<span class="go">./templates/ifcfg-eth0.lxd.tpl</span>
<span class="go">./templates/network.lxd.tpl</span>
</pre></div>
<p>metadata.yaml の内容は以下の通りです。上記の <code>*.tpl</code> のテンプレートファイルがどのパスに展開されるかの対応が分かります。</p>
<div class="highlight"><pre><span></span><span class="go">architecture: x86_64</span>
<span class="go">creation_date: 1565767338</span>
<span class="go">expiry_date: 1568359338</span>
<span class="go">properties:</span>
<span class="go">  architecture: x86_64</span>
<span class="go">  description: Centos 7 x86_64 (20190814_07:08)</span>
<span class="go">  name: centos-7-x86_64-default-20190814_07:08</span>
<span class="go">  os: centos</span>
<span class="go">  release: &quot;7&quot;</span>
<span class="go">  serial: &quot;20190814_07:08&quot;</span>
<span class="go">  variant: default</span>
<span class="go">templates:</span>
<span class="go">  /etc/hosts:</span>
<span class="go">    when:</span>
<span class="go">    - create</span>
<span class="go">    - copy</span>
<span class="go">    create_only: false</span>
<span class="go">    template: hosts.tpl</span>
<span class="go">    properties: {}</span>
<span class="go">  /etc/sysconfig/network:</span>
<span class="go">    when:</span>
<span class="go">    - create</span>
<span class="go">    - copy</span>
<span class="go">    create_only: false</span>
<span class="go">    template: network.lxd.tpl</span>
<span class="go">    properties: {}</span>
<span class="go">  /etc/sysconfig/network-scripts/ifcfg-eth0:</span>
<span class="go">    when:</span>
<span class="go">    - create</span>
<span class="go">    - copy</span>
<span class="go">    create_only: false</span>
<span class="go">    template: ifcfg-eth0.lxd.tpl</span>
<span class="go">    properties: {}</span>
</pre></div>
<p>templates/hosts.tpl の内容は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="go">127.0.1.1    {{ container.name }}</span>
<span class="go">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span>
<span class="go">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span>
</pre></div>
<p>templates/ifcfg-eth0.lxd.tpl の内容は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="go">DEVICE=eth0</span>
<span class="go">BOOTPROTO=dhcp</span>
<span class="go">ONBOOT=yes</span>
<span class="go">HOSTNAME={{ container.name }}</span>
<span class="go">NM_CONTROLLED=no</span>
<span class="go">TYPE=Ethernet</span>
<span class="go">MTU=</span>
<span class="go">DHCP_HOSTNAME=`hostname`</span>
</pre></div>
<p>templates/network.lxd.tpl の内容は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="go">NETWORKING=yes</span>
<span class="go">HOSTNAME={{ container.name }}</span>
</pre></div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>