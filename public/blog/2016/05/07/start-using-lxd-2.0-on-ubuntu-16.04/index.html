<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Ubuntu 16.04 LTSでLXD 2.0をセットアップして使ってみる</title>
        <link rel="stylesheet" href="../../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../../blog/2016/05/07/start-using-lxd-2.0-on-ubuntu-16.04/" rel="bookmark"
           title="Permalink to Ubuntu 16.04 LTSでLXD 2.0をセットアップして使ってみる">Ubuntu 16.04 LTSでLXD 2.0をセットアップして使ってみる</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-05-07T14:12:00+09:00">
                Published: 2016-05-07
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../../tag/ubuntu.html">ubuntu</a> <a href="../../../../../tag/lxd.html">lxd</a> </p>
</footer><!-- /.post-info -->      <h2>参考記事</h2>
<p>公式ドキュメントの<a href="https://linuxcontainers.org/ja/lxd/getting-started-cli/">Linux Containers - LXD - はじめに - コマンドライン</a>によくまとまっているのですが、より詳細には <a href="http://insights.ubuntu.com/2016/03/14/the-lxd-2-0-story-prologue/">The LXD 2.0 Story (Prologue) | Ubuntu Insights</a> にリストアップされている記事がわかりやすかったです。</p>
<h3>Ubuntu 16.04 serverでのLXDの初期セットアップ</h3>
<p>Ubuntu 16.04 serverならLXDはインストール済みなので、 <code>apt-get install lxd</code> と <code>newgrp lxd</code> は不要でした。</p>
<p>LXCではコンテナ一覧表示は <code>lxc-ls</code>、コンテナ作成は <code>lxc-create</code> のように別々のコマンドになっていましたが、 LXDではそれぞれ <code>lxc list</code>, <code>lxc launch</code> と <code>lxc</code> コマンドのサブコマンドになっています。</p>
<p>また <code>lxd</code> というプログラムもあります。 <code>man lxd</code> と <code>man lxc</code> してみると <code>lxd</code> はコンテナのハイパーバイザのデーモンで、 <code>lxc</code> はコンテナのハイパーバイザのクライアントです。</p>
<p>まずバージョンを確認してみます。</p>
<div class="highlight"><pre><span></span>$ lxd --version
<span class="m">2</span>.0.0
$ lxc --version
<span class="m">2</span>.0.0
</pre></div>


<p>ちなみに、 <code>lxc</code> のほうは <code>lxc version</code> と <code>version</code> サブコマンドも用意されていますが、 <code>lxd version</code> は <code>error: Unknown arguments</code> とエラーになりました。</p>
<p>コンテナ一覧を表示してみます。まだ1つもコンテナを作っていないので一覧は空です。</p>
<div class="highlight"><pre><span></span>$ lxc list
Generating a client certificate. This may take a minute...
If this is your first <span class="nb">time</span> using LXD, you should also run: sudo lxd init

+------+-------+------+------+------+-----------+
<span class="p">|</span> NAME <span class="p">|</span> STATE <span class="p">|</span> IPV4 <span class="p">|</span> IPV6 <span class="p">|</span> TYPE <span class="p">|</span> SNAPSHOTS <span class="p">|</span>
+------+-------+------+------+------+-----------+
</pre></div>


<p><code>lxc list</code> の出力の1行目にある通り、初回実行時にはクライアント証明書が生成されます。 <code>~/.config/lxc/client.key</code> に秘密鍵、 <code>~/.config/lxc/client.crt</code> に証明書が作られました。</p>
<p>また、 <code>lxc list</code> の出力の2行目に LXDを初めて使うときは <code>sudo lxd init</code> を実行するようにも書かれていますので、実行します。</p>
<p>すると、いくつか質問されるので入力していきます。</p>
<div class="highlight"><pre><span></span>$ sudo lxd init
sudo: unable to resolve host ubuntu-xenial
Name of the storage backend to use <span class="o">(</span>dir or zfs<span class="o">)</span>: dir
Would you like LXD to be available over the network <span class="o">(</span>yes/no<span class="o">)</span>? no
Do you want to configure the LXD bridge <span class="o">(</span>yes/no<span class="o">)</span>? yes
Warning: Stopping lxd.service, but it can still be activated by:
  lxd.socket
LXD has been successfully configured.
</pre></div>


<p>1つ目はストレージバックアップの選択です。選択肢は <code>dir</code> か <code>zfs</code> ですが、上記では <code>dir</code> にしました。</p>
<p>2つ目はLXDをネットワーク越しで利用するかどうかです。上記では <code>no</code> にしました。
すると上記の警告にあるとおり <code>lxd.service</code> が停止されました。 <code>sudo systemctl status lxd</code> で確認すると <code>Active:</code> の右が <code>inactive (dead)</code> になっていました。</p>
<p>一方で、 <code>lxd.socket</code> は稼働しています。 <code>sudo systemctl status lxd.socket</code> で確認すると <code>Active:</code> の右が <code>active (running)</code> になっていました。</p>
<p><code>/lib/systemd/system/lxd.socket</code> を見ると <code>/var/lib/lxd/unix.socket</code> というファイル名でUnixドメインソケットが作られていることがわかりました。</p>
<p>3つ目はLXDのブリッジを設定するかどうかです。上記は <code>yes</code> にしました。すると CUI でダイアログが次々開いて DHCPで発行するIPv4やIPv6のアドレスの範囲などを聞かれるので、順次入力していきます。ランダムなアドレスの範囲が事前入力されているので、特に変更不要な場合はenterキーを連打していけばOKでした。</p>
<p>再度 <code>lxc list</code> を実行してみると、今度はクライアント証明書を生成したとか、 <code>sudo lxc init</code> を実行せよとかの文言は表示されなくなりました。</p>
<div class="highlight"><pre><span></span>$ lxc list
+------+-------+------+------+------+-----------+
<span class="p">|</span> NAME <span class="p">|</span> STATE <span class="p">|</span> IPV4 <span class="p">|</span> IPV6 <span class="p">|</span> TYPE <span class="p">|</span> SNAPSHOTS <span class="p">|</span>
+------+-------+------+------+------+-----------+
</pre></div>


<h4>別パターンの初期化の検証</h4>
<p>このパターンではLXDをネットワーク越しに使うかの質問に <code>yes</code> と答えました。すると、バインドするアドレスとポートを聞かれます。ポートは <code>8443</code> がお勧めと書かれていますが、enterキー空打ちではだめで、ちゃんと値を入力する必要がありました。</p>
<div class="highlight"><pre><span></span>$ sudo lxd init
sudo: unable to resolve host ubuntu-xenial
Name of the storage backend to use <span class="o">(</span>dir or zfs<span class="o">)</span>: dir
Would you like LXD to be available over the network <span class="o">(</span>yes/no<span class="o">)</span>? yes
Address to <span class="nb">bind</span> LXD to <span class="o">(</span>not including port<span class="o">)</span>: <span class="m">0</span>.0.0.0
Port to <span class="nb">bind</span> LXD to <span class="o">(</span><span class="m">8443</span> recommended<span class="o">)</span>:
Invalid input, try again.

Port to <span class="nb">bind</span> LXD to <span class="o">(</span><span class="m">8443</span> recommended<span class="o">)</span>: <span class="m">8443</span>
Trust password <span class="k">for</span> new clients:
Again:
Do you want to configure the LXD bridge <span class="o">(</span>yes/no<span class="o">)</span>? no
LXD has been successfully configured.
</pre></div>


<p>この設定の後に <code>sudo systemctl status lxd</code> を実行すると <code>Active:</code> の右は <code>active (running)</code> になっていました。</p>
<p>また、上記ではLXDブリッジを設定するかの質問に <code>no</code> と答えてみました。この場合は CUIのダイアログは開かれず、すぐに <code>LXD has been successfully configured.</code> が表示されて完了しました。</p>
<p><code>ip a</code> で確認すると、この場合も <code>lxdbr0</code> というネットワークインターフェース自体は作成されていました。ただし、IPアドレスは設定されていない状態です。</p>
<div class="highlight"><pre><span></span>$ ip a
...<span class="o">(</span>略<span class="o">)</span>...
<span class="m">4</span>: lxdbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
    link/ether 0a:b4:d4:fa:b3:71 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::8b4:d4ff:fefa:b371/64 scope link
       valid_lft forever preferred_lft forever
    inet6 fe80::1/64 scope link
       valid_lft forever preferred_lft forever
</pre></div>


<p>ただ、その後 <code>lxc launch</code> でコンテナを起動した後再度確認すると <code>lxdbr0</code> の左の番号が <code>4:</code> から <code>5:</code> に変わっていて、IPv4アドレスも設定されていました。また <code>lxc.service</code> も起動していました。</p>
<p><code>sudo ss -antp</code> で確認したところ、LXDをネットワーク越しに使う設定を <code>yes</code> にしたときは <code>lxd</code> のプロセスが指定したポート（上記の例では8443番ポート）をLISTENしていますが、 <code>no</code> にしたときはLISTENしていませんでした。</p>
<h3>リモートとローカルのイメージ一覧表示</h3>
<p><code>lxc image</code> サブコマンドでイメージを取り扱います。 <code>lxc image -h</code> と入力すると使用方法が表示されます。</p>
<p><code>lxc image list</code> の説明の部分を以下に引用します。 <code>LANG</code> 環境変数が <code>ja_JP.UTF8</code> ならヘルプメッセージは日本語で表示されます。</p>
<div class="highlight"><pre><span></span>lxc image list [remote:] [filter]
    LXD のイメージストア内のイメージを一覧表示します。プロパティでフィルタ
    を行う場合は、フィルタは &lt;key&gt;=&lt;value&gt; の形になります。フィルタはイメー
    ジハッシュの一部やイメージエイリアス名の一部も指定できます。
</pre></div>


<p>英語のヘルプメッセージを見たい場合は <code>LANG=C</code> をつけて <code>LANG=C lxc image</code> のように実行すればOKです。 <code>lxc image list</code> の英語ヘルプメッセージを以下に引用します。</p>
<div class="highlight"><pre><span></span>lxc image list [remote:] [filter]
    List images in the LXD image store. Filters may be of the
    &lt;key&gt;=&lt;value&gt; form for property based filtering, or part of the image
    hash or part of the image alias name.
</pre></div>


<p>リモートのイメージ一覧は <code>lxc image list images:</code> で表示できます。最後の <code>:</code> はリモートの指定か区別するために必要です。</p>
<p>ローカルのイメージ一覧は <code>lxc image list</code> で表示できます。1つもコンテナを作っていない時は空になります。</p>
<p><code>[remote:]</code> の部分に指定可能なリモートの一覧は <code>lxc remote list</code> で確認できます。</p>
<div class="highlight"><pre><span></span>$ lxc remote list
+-----------------+------------------------------------------+---------------+--------+--------+
<span class="p">|</span>      NAME       <span class="p">|</span>                   URL                    <span class="p">|</span>   PROTOCOL    <span class="p">|</span> PUBLIC <span class="p">|</span> STATIC <span class="p">|</span>
+-----------------+------------------------------------------+---------------+--------+--------+
<span class="p">|</span> images          <span class="p">|</span> https://images.linuxcontainers.org       <span class="p">|</span> lxd           <span class="p">|</span> YES    <span class="p">|</span> NO     <span class="p">|</span>
+-----------------+------------------------------------------+---------------+--------+--------+
<span class="p">|</span> <span class="nb">local</span> <span class="o">(</span>default<span class="o">)</span> <span class="p">|</span> unix://                                  <span class="p">|</span> lxd           <span class="p">|</span> NO     <span class="p">|</span> YES    <span class="p">|</span>
+-----------------+------------------------------------------+---------------+--------+--------+
<span class="p">|</span> ubuntu          <span class="p">|</span> https://cloud-images.ubuntu.com/releases <span class="p">|</span> simplestreams <span class="p">|</span> YES    <span class="p">|</span> YES    <span class="p">|</span>
+-----------------+------------------------------------------+---------------+--------+--------+
<span class="p">|</span> ubuntu-daily    <span class="p">|</span> https://cloud-images.ubuntu.com/daily    <span class="p">|</span> simplestreams <span class="p">|</span> YES    <span class="p">|</span> YES    <span class="p">|</span>
+-----------------+------------------------------------------+---------------+--------+--------+
</pre></div>


<p>フィルタを指定してリモートのcentosのイメージ一覧を表示すると以下の3つがヒットしました。</p>
<div class="highlight"><pre><span></span>$ lxc image list images: centos
+-------------------------+--------------+--------+-----------------------------------+--------+---------+-----------------------------+
<span class="p">|</span>          ALIAS          <span class="p">|</span> FINGERPRINT  <span class="p">|</span> PUBLIC <span class="p">|</span>            DESCRIPTION            <span class="p">|</span>  ARCH  <span class="p">|</span>  SIZE   <span class="p">|</span>         UPLOAD DATE         <span class="p">|</span>
+-------------------------+--------------+--------+-----------------------------------+--------+---------+-----------------------------+
<span class="p">|</span> centos/6/amd64 <span class="o">(</span><span class="m">1</span> more<span class="o">)</span> <span class="p">|</span> 81c42e7d8c4e <span class="p">|</span> yes    <span class="p">|</span> Centos <span class="m">6</span> <span class="o">(</span>amd64<span class="o">)</span> <span class="o">(</span>20160507_02:16<span class="o">)</span> <span class="p">|</span> x86_64 <span class="p">|</span> <span class="m">52</span>.23MB <span class="p">|</span> May <span class="m">7</span>, <span class="m">2016</span> at <span class="m">3</span>:15am <span class="o">(</span>UTC<span class="o">)</span> <span class="p">|</span>
+-------------------------+--------------+--------+-----------------------------------+--------+---------+-----------------------------+
<span class="p">|</span> centos/6/i386 <span class="o">(</span><span class="m">1</span> more<span class="o">)</span>  <span class="p">|</span> 74c61c775024 <span class="p">|</span> yes    <span class="p">|</span> Centos <span class="m">6</span> <span class="o">(</span>i386<span class="o">)</span> <span class="o">(</span>20160507_02:16<span class="o">)</span>  <span class="p">|</span> i686   <span class="p">|</span> <span class="m">52</span>.16MB <span class="p">|</span> May <span class="m">7</span>, <span class="m">2016</span> at <span class="m">3</span>:16am <span class="o">(</span>UTC<span class="o">)</span> <span class="p">|</span>
+-------------------------+--------------+--------+-----------------------------------+--------+---------+-----------------------------+
<span class="p">|</span> centos/7/amd64 <span class="o">(</span><span class="m">1</span> more<span class="o">)</span> <span class="p">|</span> 9c8a52ca68e4 <span class="p">|</span> yes    <span class="p">|</span> Centos <span class="m">7</span> <span class="o">(</span>amd64<span class="o">)</span> <span class="o">(</span>20160507_02:16<span class="o">)</span> <span class="p">|</span> x86_64 <span class="p">|</span> <span class="m">62</span>.93MB <span class="p">|</span> May <span class="m">7</span>, <span class="m">2016</span> at <span class="m">3</span>:16am <span class="o">(</span>UTC<span class="o">)</span> <span class="p">|</span>
+-------------------------+--------------+--------+-----------------------------------+--------+---------+-----------------------------+
</pre></div>


<h3>CentOS 7のコンテナを起動してみる</h3>
<p>起動に使用するのは <code>lxc launch</code> サブコマンドです。 <code>lxc launch -h</code> でヘルプが見られます。</p>
<p>ここでは <code>images</code> のリモートの <code>centos/7/amd64</code> のエイリアスのイメージを起動して <code>cent01</code> というコンテナ名を付けてみます。どれぐらい時間がかかるか計測するため <code>time</code> コマンドを付けて実行してみました。</p>
<div class="highlight"><pre><span></span>$ <span class="nb">time</span> lxc launch images:centos/7/amd64 cent01
Creating cent01
Retrieving image: <span class="m">100</span>%
Starting cent01

real    0m58.036s
user    0m0.056s
sys     0m0.036s
</pre></div>


<p><code>Retrieving image: 100%</code> と表示されているように初回はイメージのダウンロードを行うので少し時間がかかります。私の環境では1分弱でした。</p>
<p>起動直後に <code>lxc list</code> を実行すると、 IPv6アドレスは付与されていますが、 IPv4アドレスはまだ空です。</p>
<div class="highlight"><pre><span></span>$ lxc list
+--------+---------+------+-----------------------------------------------+------------+-----------+
<span class="p">|</span>  NAME  <span class="p">|</span>  STATE  <span class="p">|</span> IPV4 <span class="p">|</span>                     IPV6                      <span class="p">|</span>    TYPE    <span class="p">|</span> SNAPSHOTS <span class="p">|</span>
+--------+---------+------+-----------------------------------------------+------------+-----------+
<span class="p">|</span> cent01 <span class="p">|</span> RUNNING <span class="p">|</span>      <span class="p">|</span> fd36:b946:6537:931e:216:3eff:fec9:2e18 <span class="o">(</span>eth0<span class="o">)</span> <span class="p">|</span> PERSISTENT <span class="p">|</span> <span class="m">0</span>         <span class="p">|</span>
+--------+---------+------+-----------------------------------------------+------------+-----------+
</pre></div>


<p>数秒立ってから再度実行するとIPv4アドレスが付与されていました。</p>
<div class="highlight"><pre><span></span>$ lxc list
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
<span class="p">|</span>  NAME  <span class="p">|</span>  STATE  <span class="p">|</span>         IPV4         <span class="p">|</span>                     IPV6                      <span class="p">|</span>    TYPE    <span class="p">|</span> SNAPSHOTS <span class="p">|</span>
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
<span class="p">|</span> cent01 <span class="p">|</span> RUNNING <span class="p">|</span> <span class="m">10</span>.64.177.167 <span class="o">(</span>eth0<span class="o">)</span> <span class="p">|</span> fd36:b946:6537:931e:216:3eff:fec9:2e18 <span class="o">(</span>eth0<span class="o">)</span> <span class="p">|</span> PERSISTENT <span class="p">|</span> <span class="m">0</span>         <span class="p">|</span>
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
</pre></div>


<p>この時点でローカルのイメージ一覧を表示してみると、CentOS 7のイメージが追加されていました。</p>
<div class="highlight"><pre><span></span>$ lxc image list
+-------+--------------+--------+-----------------------------------+--------+---------+-----------------------------+
<span class="p">|</span> ALIAS <span class="p">|</span> FINGERPRINT  <span class="p">|</span> PUBLIC <span class="p">|</span>            DESCRIPTION            <span class="p">|</span>  ARCH  <span class="p">|</span>  SIZE   <span class="p">|</span>         UPLOAD DATE         <span class="p">|</span>
+-------+--------------+--------+-----------------------------------+--------+---------+-----------------------------+
<span class="p">|</span>       <span class="p">|</span> 9c8a52ca68e4 <span class="p">|</span> no     <span class="p">|</span> Centos <span class="m">7</span> <span class="o">(</span>amd64<span class="o">)</span> <span class="o">(</span>20160507_02:16<span class="o">)</span> <span class="p">|</span> x86_64 <span class="p">|</span> <span class="m">62</span>.93MB <span class="p">|</span> May <span class="m">7</span>, <span class="m">2016</span> at <span class="m">7</span>:13am <span class="o">(</span>UTC<span class="o">)</span> <span class="p">|</span>
+-------+--------------+--------+-----------------------------------+--------+---------+-----------------------------+
</pre></div>


<p>同じイメージで2つめのコンテナを起動してみると今度はローカルのイメージを使うので起動時間は短くてすみました。私の環境では約10秒でした。</p>
<div class="highlight"><pre><span></span>$ <span class="nb">time</span> lxc launch images:centos/7/amd64 cent02
Creating cent02
Starting cent02

real    0m10.189s
user    0m0.044s
sys     0m0.008s
</pre></div>


<p>起動直後にコンテナ一覧を確認すると、今起動した <code>cent02</code> コンテナのIPv4アドレスはやはり空です。</p>
<div class="highlight"><pre><span></span>$ lxc list
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
<span class="p">|</span>  NAME  <span class="p">|</span>  STATE  <span class="p">|</span>         IPV4         <span class="p">|</span>                     IPV6                      <span class="p">|</span>    TYPE    <span class="p">|</span> SNAPSHOTS <span class="p">|</span>
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
<span class="p">|</span> cent01 <span class="p">|</span> RUNNING <span class="p">|</span> <span class="m">10</span>.64.177.167 <span class="o">(</span>eth0<span class="o">)</span> <span class="p">|</span> fd36:b946:6537:931e:216:3eff:fec9:2e18 <span class="o">(</span>eth0<span class="o">)</span> <span class="p">|</span> PERSISTENT <span class="p">|</span> <span class="m">0</span>         <span class="p">|</span>
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
<span class="p">|</span> cent02 <span class="p">|</span> RUNNING <span class="p">|</span>                      <span class="p">|</span> fd36:b946:6537:931e:216:3eff:fe18:680a <span class="o">(</span>eth0<span class="o">)</span> <span class="p">|</span> PERSISTENT <span class="p">|</span> <span class="m">0</span>         <span class="p">|</span>
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
</pre></div>


<p>数秒立ってから再度確認すると <code>centos02</code> コンテナにもIPv4アドレスが付与されていました。</p>
<div class="highlight"><pre><span></span>$ lxc list
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
<span class="p">|</span>  NAME  <span class="p">|</span>  STATE  <span class="p">|</span>         IPV4         <span class="p">|</span>                     IPV6                      <span class="p">|</span>    TYPE    <span class="p">|</span> SNAPSHOTS <span class="p">|</span>
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
<span class="p">|</span> cent01 <span class="p">|</span> RUNNING <span class="p">|</span> <span class="m">10</span>.64.177.167 <span class="o">(</span>eth0<span class="o">)</span> <span class="p">|</span> fd36:b946:6537:931e:216:3eff:fec9:2e18 <span class="o">(</span>eth0<span class="o">)</span> <span class="p">|</span> PERSISTENT <span class="p">|</span> <span class="m">0</span>         <span class="p">|</span>
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
<span class="p">|</span> cent02 <span class="p">|</span> RUNNING <span class="p">|</span> <span class="m">10</span>.64.177.34 <span class="o">(</span>eth0<span class="o">)</span>  <span class="p">|</span> fd36:b946:6537:931e:216:3eff:fe18:680a <span class="o">(</span>eth0<span class="o">)</span> <span class="p">|</span> PERSISTENT <span class="p">|</span> <span class="m">0</span>         <span class="p">|</span>
+--------+---------+----------------------+-----------------------------------------------+------------+-----------+
</pre></div>


<h3>コンテナ内でコマンドを実行する</h3>
<p>例えば <code>cent01</code> コンテナで <code>bash</code> を起動するには <code>lxc exec cent01 bash</code> と実行します。するとコンテナ内で root ユーザになってプロンプトが表示されるので、好きなコマンドを入力して実行します。</p>
<div class="highlight"><pre><span></span>$ lxc <span class="nb">exec</span> cent01 bash
<span class="o">[</span>root@cent01 ~<span class="o">]</span><span class="c1"># ip a</span>
<span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN qlen <span class="m">1</span>
    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
    inet <span class="m">127</span>.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
<span class="m">37</span>: eth0@if38: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc noqueue state UP qlen <span class="m">1000</span>
    link/ether <span class="m">00</span>:16:3e:5f:01:7e brd ff:ff:ff:ff:ff:ff link-netnsid <span class="m">0</span>
    inet <span class="m">10</span>.155.92.101/24 brd <span class="m">10</span>.155.92.255 scope global dynamic eth0
       valid_lft 2508sec preferred_lft 2508sec
    inet6 fe80::216:3eff:fe5f:17e/64 scope link
       valid_lft forever preferred_lft forever
<span class="o">[</span>root@cent01 ~<span class="o">]</span><span class="c1"># ping -c 3 cent02</span>
PING cent02.lxd <span class="o">(</span><span class="m">10</span>.64.177.34<span class="o">)</span> <span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from cent02.lxd <span class="o">(</span><span class="m">10</span>.64.177.34<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">0</span>.034 ms
<span class="m">64</span> bytes from cent02.lxd <span class="o">(</span><span class="m">10</span>.64.177.34<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">0</span>.068 ms
<span class="m">64</span> bytes from cent02.lxd <span class="o">(</span><span class="m">10</span>.64.177.34<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">64</span> <span class="nv">time</span><span class="o">=</span><span class="m">0</span>.081 ms

--- cent02.lxd ping statistics ---
<span class="m">3</span> packets transmitted, <span class="m">3</span> received, <span class="m">0</span>% packet loss, <span class="nb">time</span> 1998ms
rtt min/avg/max/mdev <span class="o">=</span> <span class="m">0</span>.034/0.061/0.081/0.019 ms
<span class="o">[</span>root@cent01 ~<span class="o">]</span><span class="c1"># exit</span>
<span class="nb">exit</span>
</pre></div>


<p>上記の <code>ping</code> の例でも分かる通り、コンテナ内から別のコンテナの名前を指定して通信可能です。 <code>ping</code> の出力を見ると <code>.lxd</code> というトップレベルドメインがつけられていて、 <code>ping -c 3 cent02.lxd</code> でも大丈夫でした。この <code>.lxd</code> という値は <code>/etc/default/lxd-bridge</code> の <code>LXD_DOMAIN="lxd"</code> という設定で指定されています。</p>
<p>Control-Dを押すか、<code>exit</code> に続いてenterキーで <code>bash</code> から抜けます。</p>
<p>単一のコマンドを実行したい場合は <code>bash</code> の代わりにコマンドを書きます。</p>
<div class="highlight"><pre><span></span>$ lxc <span class="nb">exec</span> cent01 ls /
bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  selinux  srv  sys  tmp  usr  var
</pre></div>


<p>コマンドにオプションを指定するとエラーになりますが、コマンドの前に <code>--</code> を入れれば大丈夫です。</p>
<div class="highlight"><pre><span></span>$ lxc <span class="nb">exec</span> cent01 ls -a /
error: flag provided but not defined: -a
$ lxc <span class="nb">exec</span> cent01 -- ls -a /
.  ..  .autorelabel  bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  selinux  srv  sys  tmp  usr  var
</pre></div>


<h2>ホストOSを再起動するとコンテナは自動起動されます</h2>
<p>LXCではホストOS起動時にコンテナを自動起動するには設定ファイルの編集が必要でしたが、LXDは特に設定は不要でした。　
ホストOSを再起動して <code>lxc list</code> を実行してみると上記で作成した2つのコンテナのSTATEがRUNNINGになっていました。</p>
<h2>コンテナの停止と削除</h2>
<p>停止は <code>lxc stop コンテナ名</code> 、削除は <code>lxc delete コンテナ名</code> で出来ます。が、 CentOS 7 のコンテナを停止するには以下の事前準備が必要でした。</p>
<h3>CentOS 7 のコンテナを停止可能にするための設定</h3>
<p><code>cent01</code> のところは実際のコンテナ名に置き換えて、各コンテナで実行が必要です。</p>
<div class="highlight"><pre><span></span>lxc exec cent01 -- sh -c &#39;ln -s /usr/lib/systemd/system/halt.target /etc/systemd/system/sigpwr.target &amp;&amp; systemctl daemon-reload&#39;
</pre></div>


<p>この回避方法は <a href="https://lists.linuxcontainers.org/pipermail/lxc-users/2014-February/006304.html">[lxc-users] lxc-stop doesn't stop centos, waits for the timeout</a> で紹介されていました。</p>
<p><a href="https://lists.linuxcontainers.org/pipermail/lxc-users/2016-May/011602.html">[lxc-users] lxc stop does not stop a CentOS 7 container</a> で <code>images:</code> で公開しているイメージにこの修正を取り込めないか問い合わせ中です。</p>
<h2>コンテナやイメージのファイルの在り処</h2>
<p>コンテナのファイルは <code>/var/lib/lxd/containers/</code> にありました。操作しているユーザのuidとgidは1000なのですが、コンテナのディレクトリは100000と異なっていました。どこかでマッピングを持っているのだと思いますが、未調査です。</p>
<div class="highlight"><pre><span></span>$ sudo ls -l /var/lib/lxd/containers/
合計 <span class="m">24</span>
drwxr-xr-x+ <span class="m">4</span> <span class="m">100000</span> <span class="m">100000</span>  <span class="m">4096</span>  5月  <span class="m">6</span> <span class="m">18</span>:56 cent01
drwxr-xr-x+ <span class="m">4</span> <span class="m">100000</span> <span class="m">100000</span>  <span class="m">4096</span>  5月  <span class="m">7</span> <span class="m">03</span>:18 cent02
-rw-r--r--  <span class="m">1</span> root   root   <span class="m">10756</span>  5月  <span class="m">7</span> <span class="m">19</span>:47 lxc-monitord.log
drwxr-xr-x+ <span class="m">4</span> <span class="m">100000</span> <span class="m">100000</span>  <span class="m">4096</span>  5月  <span class="m">3</span> <span class="m">20</span>:46 my-ubuntu
$ sudo ls -l /var/lib/lxd/containers/cent01
合計 <span class="m">12</span>
-rw-r--r--  <span class="m">1</span> root   root    <span class="m">628</span>  1月  <span class="m">1</span>  <span class="m">1970</span> metadata.yaml
dr-xr-xr-x <span class="m">18</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  5月  <span class="m">6</span> <span class="m">18</span>:56 rootfs
drwxr-xr-x  <span class="m">2</span> root   root   <span class="m">4096</span>  5月  <span class="m">6</span> <span class="m">18</span>:56 templates
<span class="m">1</span>$ sudo ls -l /var/lib/lxd/containers/cent01/rootfs/
合計 <span class="m">64</span>
lrwxrwxrwx  <span class="m">1</span> <span class="m">100000</span> <span class="m">100000</span>    <span class="m">7</span>  5月  <span class="m">6</span> <span class="m">11</span>:25 bin -&gt; usr/bin
dr-xr-xr-x  <span class="m">2</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  8月 <span class="m">12</span>  <span class="m">2015</span> boot
drwxr-xr-x  <span class="m">4</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  5月  <span class="m">6</span> <span class="m">11</span>:25 dev
drwxr-xr-x <span class="m">55</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  5月  <span class="m">7</span> <span class="m">12</span>:13 etc
drwxr-xr-x  <span class="m">2</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  8月 <span class="m">12</span>  <span class="m">2015</span> home
lrwxrwxrwx  <span class="m">1</span> <span class="m">100000</span> <span class="m">100000</span>    <span class="m">7</span>  5月  <span class="m">6</span> <span class="m">11</span>:25 lib -&gt; usr/lib
lrwxrwxrwx  <span class="m">1</span> <span class="m">100000</span> <span class="m">100000</span>    <span class="m">9</span>  5月  <span class="m">6</span> <span class="m">11</span>:25 lib64 -&gt; usr/lib64
drwxr-xr-x  <span class="m">2</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  8月 <span class="m">12</span>  <span class="m">2015</span> media
drwxr-xr-x  <span class="m">2</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  8月 <span class="m">12</span>  <span class="m">2015</span> mnt
drwxr-xr-x  <span class="m">2</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  8月 <span class="m">12</span>  <span class="m">2015</span> opt
dr-xr-xr-x  <span class="m">2</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  8月 <span class="m">12</span>  <span class="m">2015</span> proc
dr-xr-x---  <span class="m">3</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  5月  <span class="m">7</span> <span class="m">03</span>:42 root
drwxr-xr-x  <span class="m">7</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  5月  <span class="m">6</span> <span class="m">11</span>:25 run
lrwxrwxrwx  <span class="m">1</span> <span class="m">100000</span> <span class="m">100000</span>    <span class="m">8</span>  5月  <span class="m">6</span> <span class="m">11</span>:25 sbin -&gt; usr/sbin
drwxr-xr-x  <span class="m">2</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  5月  <span class="m">6</span> <span class="m">11</span>:25 selinux
drwxr-xr-x  <span class="m">2</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  8月 <span class="m">12</span>  <span class="m">2015</span> srv
dr-xr-xr-x  <span class="m">2</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  8月 <span class="m">12</span>  <span class="m">2015</span> sys
drwxrwxrwt  <span class="m">7</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  5月  <span class="m">7</span> <span class="m">12</span>:54 tmp
drwxr-xr-x <span class="m">13</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  5月  <span class="m">6</span> <span class="m">11</span>:25 usr
drwxr-xr-x <span class="m">19</span> <span class="m">100000</span> <span class="m">100000</span> <span class="m">4096</span>  5月  <span class="m">6</span> <span class="m">18</span>:56 var
</pre></div>


<p>イメージのファイルは <code>/var/lib/lxd/images/</code> にありました。 <code>lxc image list</code> で表示されるフィンガープリント名のファイルとフィンガープリントに <code>.rootfs</code> を追加した名前のファイルがあります。調べてみるとtar.xz形式のファイルになっていました。</p>
<div class="highlight"><pre><span></span>$ sudo ls -l /var/lib/lxd/images/
合計 <span class="m">205244</span>
-rw-r--r-- <span class="m">1</span> root root       <span class="m">588</span>  5月  <span class="m">6</span> <span class="m">18</span>:54 a027d59858d663fb2bc12b5ba767e92196a4aee8dbb2a607db53d718b91eb5d2
-rw-r--r-- <span class="m">1</span> root root  <span class="m">65931516</span>  5月  <span class="m">6</span> <span class="m">18</span>:55 a027d59858d663fb2bc12b5ba767e92196a4aee8dbb2a607db53d718b91eb5d2.rootfs
-rw-r--r-- <span class="m">1</span> root root       <span class="m">792</span>  5月  <span class="m">3</span> <span class="m">20</span>:32 f4c4c60a6b752a381288ae72a1689a9da00f8e03b732c8d1b8a8fcd1a8890800
-rw-r--r-- <span class="m">1</span> root root <span class="m">144223868</span>  5月  <span class="m">3</span> <span class="m">20</span>:46 f4c4c60a6b752a381288ae72a1689a9da00f8e03b732c8d1b8a8fcd1a8890800.rootfs
$ sudo file /var/lib/lxd/images/a027d59858d663fb2bc12b5ba767e92196a4aee8dbb2a607db53d718b91eb5d2
/var/lib/lxd/images/a027d59858d663fb2bc12b5ba767e92196a4aee8dbb2a607db53d718b91eb5d2: XZ compressed data
$ sudo file /var/lib/lxd/images/a027d59858d663fb2bc12b5ba767e92196a4aee8dbb2a607db53d718b91eb5d2.rootfs
/var/lib/lxd/images/a027d59858d663fb2bc12b5ba767e92196a4aee8dbb2a607db53d718b91eb5d2.rootfs: XZ compressed data
$ sudo tar tvf /var/lib/lxd/images/a027d59858d663fb2bc12b5ba767e92196a4aee8dbb2a607db53d718b91eb5d2
-rw-r--r-- <span class="m">0</span>/0             <span class="m">239</span> <span class="m">1970</span>-01-01 <span class="m">09</span>:00 templates/hosts.tpl
-rw-r--r-- <span class="m">0</span>/0             <span class="m">628</span> <span class="m">1970</span>-01-01 <span class="m">09</span>:00 metadata.yaml
-rw-r--r-- <span class="m">0</span>/0              <span class="m">21</span> <span class="m">1970</span>-01-01 <span class="m">09</span>:00 templates/hostname.tpl
$ sudo tar tvf /var/lib/lxd/images/a027d59858d663fb2bc12b5ba767e92196a4aee8dbb2a607db53d718b91eb5d2.rootfs <span class="p">|</span> head
dr-xr-xr-x <span class="m">0</span>/0               <span class="m">0</span> <span class="m">2016</span>-05-06 <span class="m">11</span>:25 ./
drwxr-xr-x <span class="m">0</span>/0               <span class="m">0</span> <span class="m">2016</span>-05-06 <span class="m">11</span>:25 ./dev/
crw-rw-rw- <span class="m">0</span>/0             <span class="m">5</span>,2 <span class="m">2016</span>-05-06 <span class="m">11</span>:25 ./dev/ptmx
prw------- <span class="m">0</span>/0               <span class="m">0</span> <span class="m">2016</span>-05-06 <span class="m">11</span>:25 ./dev/initctl
crw-rw-rw- <span class="m">0</span>/0             <span class="m">1</span>,7 <span class="m">2016</span>-05-06 <span class="m">11</span>:25 ./dev/full
crw------- <span class="m">0</span>/0             <span class="m">5</span>,1 <span class="m">2016</span>-05-06 <span class="m">11</span>:25 ./dev/console
crw-rw-rw- <span class="m">0</span>/0             <span class="m">4</span>,4 <span class="m">2016</span>-05-06 <span class="m">11</span>:25 ./dev/tty4
crw-rw-rw- <span class="m">0</span>/0             <span class="m">4</span>,3 <span class="m">2016</span>-05-06 <span class="m">11</span>:25 ./dev/tty3
crw-rw-rw- <span class="m">0</span>/0             <span class="m">4</span>,2 <span class="m">2016</span>-05-06 <span class="m">11</span>:25 ./dev/tty2
crw-rw-rw- <span class="m">0</span>/0             <span class="m">4</span>,1 <span class="m">2016</span>-05-06 <span class="m">11</span>:25 ./dev/tty1
</pre></div>


<p><code>/var/lib/lxd/</code> には他にもディレクトリやファイルが存在しています。</p>
<div class="highlight"><pre><span></span>$ ls -l /var/lib/lxd
合計 <span class="m">84</span>
drwx--x--x <span class="m">5</span> root root  <span class="m">4096</span>  5月  <span class="m">7</span> <span class="m">12</span>:54 containers
drwx--x--x <span class="m">5</span> root root  <span class="m">4096</span>  5月  <span class="m">7</span> <span class="m">12</span>:54 devices
drwxr-xr-x <span class="m">2</span> root root  <span class="m">4096</span>  5月  <span class="m">7</span> <span class="m">19</span>:41 devlxd
drwx------ <span class="m">2</span> root root  <span class="m">4096</span>  5月  <span class="m">7</span> <span class="m">06</span>:13 images
-rw-r--r-- <span class="m">1</span> root root <span class="m">43008</span>  5月  <span class="m">7</span> <span class="m">19</span>:46 lxd.db
drwx------ <span class="m">4</span> root root  <span class="m">4096</span>  5月  <span class="m">3</span> <span class="m">20</span>:46 security
-rw-r--r-- <span class="m">1</span> root root  <span class="m">2004</span>  5月  <span class="m">3</span> <span class="m">20</span>:26 server.crt
-rw------- <span class="m">1</span> root root  <span class="m">3247</span>  5月  <span class="m">3</span> <span class="m">20</span>:26 server.key
drwx--x--x <span class="m">5</span> root root  <span class="m">4096</span>  5月  <span class="m">7</span> <span class="m">12</span>:54 shmounts
drwx------ <span class="m">2</span> root root  <span class="m">4096</span>  5月  <span class="m">3</span> <span class="m">20</span>:26 snapshots
srw-rw---- <span class="m">1</span> root lxd      <span class="m">0</span>  5月  <span class="m">7</span> <span class="m">12</span>:51 unix.socket
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>