<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Vagrant + Virtualboxでのディスク追加</title>
        <link rel="stylesheet" href="../../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../../blog/2015/06/01/add_secondary_disk_to_vagrant_virtualbox/" rel="bookmark"
           title="Permalink to Vagrant + Virtualboxでのディスク追加">Vagrant + Virtualboxでのディスク追加</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-06-01T06:04:00+09:00">
                Published: 2015-06-01
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../../tag/vagrant.html">vagrant</a> <a href="../../../../../tag/virtualbox.html">virtualbox</a> </p>
</footer><!-- /.post-info -->      <p>Vagrant + Virtualboxでのディスク追加についてのメモです。</p>
<h2>ディスク追加の設定</h2>
<ul>
<li>http://stackoverflow.com/questions/21050496/vagrant-virtualbox-second-disk-path/26743144#26743144</li>
<li>https://gist.github.com/leifg/4713995#comment-1206250</li>
</ul>
<p>を参考に以下のようにしました。</p>
<div class="highlight"><pre><span></span><span class="c1"># -*- mode: ruby -*-</span>
<span class="c1"># vi: set ft=ruby :</span>

<span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s1">&#39;base&#39;</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
    <span class="n">vagrant_root</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">))</span>
    <span class="n">file_to_disk</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vagrant_root</span><span class="p">,</span> <span class="s1">&#39;ad1.vdi&#39;</span><span class="p">)</span>
    <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="n">file_to_disk</span><span class="p">)</span>
      <span class="n">vb</span><span class="o">.</span><span class="n">customize</span> <span class="o">[</span><span class="s1">&#39;createhd&#39;</span><span class="p">,</span> <span class="s1">&#39;--filename&#39;</span><span class="p">,</span> <span class="n">file_to_disk</span><span class="p">,</span> <span class="s1">&#39;--size&#39;</span><span class="p">,</span> <span class="mi">500</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">]</span>
    <span class="k">end</span>
    <span class="n">vb</span><span class="o">.</span><span class="n">customize</span> <span class="o">[</span><span class="s1">&#39;storageattach&#39;</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s1">&#39;--storagectl&#39;</span><span class="p">,</span> <span class="s1">&#39;SATA Controller&#39;</span><span class="p">,</span> <span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;--device&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;--type&#39;</span><span class="p">,</span> <span class="s1">&#39;hdd&#39;</span><span class="p">,</span> <span class="s1">&#39;--medium&#39;</span><span class="p">,</span> <span class="n">file_to_disk</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>上記の後者のリンク先では <code>Vagrantfile</code> のあるディレクトリを <code>VAGRANT_ROOT</code> と大文字で定数に設定していますが、私は <code>vagrant_root</code> と小文字で変数にしました。</p>
<p>デバッグプリントを入れてみてわかったのですが、このブロックは1度ではなく複数回呼ばれます。定数だと既に初期化済みの警告が出るので変数にしたというわけです。</p>
<h2>SATA Controllerの作成はpackerで行っておく</h2>
<p>上の設定だけでは https://github.com/hnakamur/freebsd-packer/tree/ef57aff51b02a03e658f0348eb5e463ed08735aa で作ったFreeBSD 10.1 amd64のboxではSATA Controllerが無いためうまく行きませんでした。</p>
<p>https://gist.github.com/leifg/4713995#comment-1374268 でVagrantにモンキーパッチで対応しようとしているがうまくいかない例がありました。</p>
<p><a href="https://github.com/mitchellh/vagrant/issues/4015#issuecomment-45930125">Rescue customization exception · Issue #4015 · mitchellh/vagrant</a>のVagrant開発者のコメントで、Vagrantfileの設定は手続き型ではなく宣言型なので、Vagrantfileの設定では無理でVagrantプラグインを作る必要があると書かれています。</p>
<p>結局 https://github.com/hnakamur/freebsd-packer/commit/fc041427ffd9de330d390036ebd0948f01e707fe のようにpackerのテンプレートを作る際にSATA Controllerも作っておくのがお手軽だったのでそうしました。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>