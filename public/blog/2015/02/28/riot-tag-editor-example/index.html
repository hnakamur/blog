<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Riot.jsでタグエディターのサンプルを作ってみた</title>
        <link rel="stylesheet" href="../../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../../blog/2015/02/28/riot-tag-editor-example/" rel="bookmark"
           title="Permalink to Riot.jsでタグエディターのサンプルを作ってみた">Riot.jsでタグエディターのサンプルを作ってみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-02-28T21:12:00+09:00">
                Published: 2015-02-28
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../../tag/javascript.html">javascript</a> <a href="../../../../../tag/riotjs.html">riot.js</a> </p>
</footer><!-- /.post-info -->      <h2>Riot.js</h2>
<p>Riot.jsについては<a href="http://qiita.com/cognitom/items/54ae38c9a50dbbe28367">Riot.js 2.0 情報まとめ - Qiita</a>に良いまとめがありますのでそちらをどうぞ。良いまとめをありがとうございます。</p>
<h2>本家が提供しているToDoアプリをgoemonでライブリロードして開発を高速化するサンプル</h2>
<p>今回のタグエディターの前に、環境整備ということで本家が提供しているToDoアプリをgoemonでライブリロードして開発を高速化するサンプルを作ってみました。</p>
<p><a href="https://github.com/hnakamur/riotjs-todo-goemon-livereload-example">hnakamur/riotjs-todo-goemon-livereload-example</a></p>
<p><a href="https://muut.com/riotjs/guide/">Riot developer guide</a>にあるアプリからどのように変更したかはgitのコミットを小分けにしてあるので、そちらをご参照ください。
<a href="https://github.com/hnakamur/riotjs-todo-goemon-livereload-example/commits/master">Commits · hnakamur/riotjs-todo-goemon-livereload-example</a></p>
<h2>タグエディターのサンプルをRiot.jsでも作ってみた</h2>
<p>で、本題のタグエディターのサンプルです。以前にjQuery, Backbone.js, Vue.jsで同じものを作っていました。</p>
<ul>
<li><a href="http://qiita.com/hnakamur/items/ac5f04930d0c08f141e5">jQuery - タグ・エディターを作ってみた - Qiita</a></li>
<li><a href="http://qiita.com/hnakamur/items/bfdade12bc5db21fa771">Backbone.jsでタグ・エディターを作ってみた - Qiita</a></li>
<li><a href="http://qiita.com/hnakamur/items/a73ff28621e06193a228">vue.jsでタグ・エディターを作ってみた - Qiita</a></li>
</ul>
<p>今回はRiot.jsで作ってみました。</p>
<p>ソース: <a href="https://github.com/hnakamur/riot-tag-editor-live-reload-example-with-goemon">hnakamur/riot-tag-editor-live-reload-example-with-goemon</a>
コンパイル済みのデモ: <a href="https://hnakamur.github.io/riot-tag-editor-live-reload-example-with-goemon/demo/">Riot tag editor example</a></p>
<p>セットアップ手順はソースの<a href="https://github.com/hnakamur/riot-tag-editor-live-reload-example-with-goemon/blob/master/README.md">README</a>を参照してください。</p>
<p>タグエディターのタグのソースは<a href="https://github.com/hnakamur/riot-tag-editor-live-reload-example-with-goemon/blob/master/assets/tag-editor.tag">tag-editor.tag</a>です。</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;tag-editor&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;tag-editor-field&quot;</span> <span class="na">onclick=</span><span class="s">{</span> <span class="err">click</span> <span class="err">}</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;tag-editor-tag tag-editor-tag-measure&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;measure&quot;</span> <span class="na">class=</span><span class="s">&quot;tag-editor-text&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;tag-editor-delete&quot;</span><span class="nt">&gt;</span>x<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">each=</span><span class="s">{</span> <span class="err">tags</span> <span class="err">}</span> <span class="na">class=</span><span class="s">&quot;tag-editor-tag&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;tag-editor-text&quot;</span><span class="nt">&gt;</span>{ name }<span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;tag-editor-delete&quot;</span> <span class="na">onclick=</span><span class="s">{</span> <span class="err">parent.clickDelete</span> <span class="err">}</span><span class="nt">&gt;</span>x<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;editor&quot;</span> <span class="na">class=</span><span class="s">&quot;tag-editor-input&quot;</span> <span class="na">style=</span><span class="s">&quot;width: 0&quot;</span> <span class="na">onkeyup=</span><span class="s">{</span> <span class="err">keyup</span> <span class="err">}</span> <span class="na">onkeydown=</span><span class="s">{</span> <span class="err">keydown</span> <span class="err">}</span> <span class="na">onblur=</span><span class="s">{</span> <span class="err">blur</span> <span class="err">}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;script&gt;</span>
    this.tags = opts.tags
    this.separator = /[, ]+/

    click(e) {
      adjustEditorWidth(this)
      this.editor.focus()
      return false
    }

    keyup(e) {
      var val = this.editor.value
      if (this.separator.test(val)) {
        mayInsertTags(this)
      } else {
        adjustEditorWidth(this)
      }
      return false
    }

    keydown(e) {
      if (e.which == 13 /* Enter */ <span class="err">&amp;&amp;</span> this.editor.value !== &#39;&#39;) {
        mayInsertTags(this)
        return true
      } else if (e.which == 8 /* Backspace */ <span class="err">&amp;&amp;</span> this.editor.value === &#39;&#39; <span class="err">&amp;&amp;</span> this.tags.length &gt; 0) {
        this.tags.pop()
      }
      return true
    }

    blur(e) {
      mayInsertTags(this)
      return true
    }

    clickDelete(e) {
      e.stopPropagation()
      this.tags.splice(this.tags.indexOf(e.item), 1)
      return false
    }

    function adjustEditorWidth(elem) {
      elem.measure.innerText = elem.editor.value + &#39;WW&#39;
      elem.editor.style.width = elem.measure.offsetWidth + &#39;px&#39;
    }

    function mayInsertTags(elem) {
      var values = elem.editor.value.split(elem.separator),
          i = 0,
          len = values.length,
          value
      elem.editor.value = &#39;&#39;
      adjustEditorWidth(elem)
      for (; i <span class="nt">&lt; len</span><span class="err">;</span> <span class="err">i++)</span> <span class="err">{</span>
        <span class="na">value =</span> <span class="s">values[i]</span>
        <span class="err">if</span> <span class="err">(value</span> <span class="err">!==</span> <span class="err">&#39;&#39;</span> <span class="err">&amp;&amp;</span> <span class="err">!containsTag(elem,</span> <span class="err">value))</span> <span class="err">{</span>
          <span class="err">elem.tags.push({name:</span> <span class="err">value})</span>
        <span class="err">}</span>
      <span class="err">}</span>
    <span class="err">}</span>

    <span class="err">function</span> <span class="err">containsTag(elem,</span> <span class="err">tag)</span> <span class="err">{</span>
      <span class="err">var</span> <span class="na">i =</span> <span class="s">0,</span> 
          <span class="na">len =</span> <span class="s">elem.tags.length</span>
      <span class="err">for</span> <span class="err">(;</span> <span class="err">i</span> <span class="err">&lt;</span> <span class="err">len;</span> <span class="err">i++)</span> <span class="err">{</span>
        <span class="err">if</span> <span class="err">(elem.tags[i]</span><span class="na">.name =</span><span class="s">==</span> <span class="err">tag)</span> <span class="err">{</span>
          <span class="err">return</span> <span class="err">true</span>
        <span class="err">}</span>
      <span class="err">}</span>
      <span class="err">return</span> <span class="err">false</span>
    <span class="err">}</span>
  <span class="err">&lt;/script</span><span class="nt">&gt;</span>

<span class="nt">&lt;/tag-editor&gt;</span>
</pre></div>


<p>HTMLのタグとJavaScriptのコードを一箇所にかけて、イベントもonclickとかで書くので、コンパクトで見やすいです。
onclickとかに指定した関数は <code>function</code> なしで書けるようになっていますが、そうでない関数には <code>function</code> を明記する必要がありました。</p>
<p>タグエディターを利用する側のHTMLのコードは以下の様な感じで、こちらもシンプルです。</p>
<p>https://github.com/hnakamur/riot-tag-editor-live-reload-example-with-goemon/blob/621d58d0d9774c710f61ad993da451cf948fce22/assets/index.html#L31-L41</p>
<div class="highlight"><pre><span></span>    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;tag-editor.tag&quot;</span> <span class="n">type</span><span class="o">=</span><span class="s">&quot;riot/tag&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;https://cdn.jsdelivr.net/g/riot@2.0(riot.min.js+compiler.min.js)&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
    <span class="n">riot</span><span class="p">.</span><span class="n">mount</span><span class="p">(</span><span class="err">&#39;</span><span class="n">tag</span><span class="o">-</span><span class="n">editor</span><span class="err">&#39;</span><span class="p">,</span> <span class="p">{</span>
      <span class="nl">tags</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span><span class="nl">name</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">foo</span><span class="err">&#39;</span><span class="p">},</span>
        <span class="p">{</span><span class="nl">name</span><span class="p">:</span> <span class="err">&#39;</span><span class="n">bar</span><span class="err">&#39;</span><span class="p">},</span>
      <span class="p">]</span>
    <span class="p">})</span>
    <span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>


<h2>プリコンパイル済みのソースの作成</h2>
<div class="highlight"><pre><span></span>riot assets/ demo/
</pre></div>


<p>で <code>assets/tag-editor.tag</code> から <code>demo/tag-editor.js</code> が生成されます。</p>
<p>利用する側のHTMLは以下のようにします。 riot.jsの読み込み方法と、タグエディターのソースを読み込む順番が開発時とは違うので要注意です。</p>
<p>https://github.com/hnakamur/riot-tag-editor-live-reload-example-with-goemon/blob/621d58d0d9774c710f61ad993da451cf948fce22/demo/index.html#L30-L40</p>
<div class="highlight"><pre><span></span>    <span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">&quot;https://cdn.jsdelivr.net/riot/2.0/riot.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script</span> <span class="na">src=</span><span class="s">&quot;tag-editor.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>

    <span class="nt">&lt;script&gt;</span>
    riot.mount(&#39;tag-editor&#39;, {
      tags: [
        {name: &#39;foo&#39;},
        {name: &#39;bar&#39;},
      ]
    })
    <span class="nt">&lt;/script&gt;</span>
</pre></div>


<h2>Riot.jsの魅力</h2>
<p><a href="https://muut.com/riotjs/compare.html">Riot vs React vs Polymer</a>を見ても、riot.min.jsは6.7KBとコンパクトなのが魅力です。それでいてカスタムタグもすっきりシンプルに書けますし。これは今後に期待ですね！</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>