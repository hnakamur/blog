<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>CentOS 7用にPython2最新版のrpmを作ってみた</title>
        <link rel="stylesheet" href="../../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../../blog/2015/12/19/build_latest_python2_rpm_for_centos7/" rel="bookmark"
           title="Permalink to CentOS 7用にPython2最新版のrpmを作ってみた">CentOS 7用にPython2最新版のrpmを作ってみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-12-19T11:51:00+09:00">
                Published: 2015-12-19
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../../tag/centos.html">centos</a> <a href="../../../../../tag/python.html">python</a> <a href="../../../../../tag/rpmbuild.html">rpmbuild</a> <a href="../../../../../tag/software-collections.html">software-collections</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p><a href="/blog/2015/12/16/calling_copr_api_with_curl/">coprのAPIをcurlで呼び出す · hnakamur's blog at github</a>にも書きましたが、CentOS 7のPythonは古くてhttps通信時にInsecurePlatformWarningが出てしまいます。</p>
<p>そこで、<a href="https://www.softwarecollections.org/repos/rhscl/python27/epel-7-x86_64/python27-python-2.7.8-3.el7/">Software CollectionsのPython27のpythonパッケージ</a>を改変してPython2の最新版2.7.11のrpmを作ってみました。
<a href="https://www.softwarecollections.org/en/">Software Collections</a>のrpmをベースにしていますので、CentOS 7にインストールされているPythonとは共存可能となっています。</p>
<h2>Python2の最新版rpmの利用方法</h2>
<p>先に利用方法を書いておきます。</p>
<h3>インストール手順</h3>
<p>dockerのcentos:7コンテナにインストールする例で説明します。まず以下のコマンドでコンテナを起動します。</p>
<div class="highlight"><pre><span></span>docker run -it centos:7 /bin/bash
</pre></div>


<p>次に以下のコマンドを実行してPython2をインストールします。</p>
<div class="highlight"><pre><span></span>curl -sL -o /etc/yum.repos.d/hnakamur-hnscl-python2.repo https://copr.fedoraproject.org/coprs/hnakamur/hnscl-python2/repo/epel-7/hnakamur-hnscl-python2-epel-7.repo
curl -sL -o /etc/yum.repos.d/hnakamur-hnscl-python2-python.repo https://copr.fedoraproject.org/coprs/hnakamur/hnscl-python2-python/repo/epel-7/hnakamur-hnscl-python2-python-epel-7.repo
yum -y install hn-python2-python
</pre></div>


<h3>使い方</h3>
<p>以下のコマンドでPython2最新版用のシェルを起動します。</p>
<div class="highlight"><pre><span></span>scl enable hn-python2 bash
</pre></div>


<p>あとは通常通りpythonコマンドを実行すればOKです。</p>
<div class="highlight"><pre><span></span># which python
/opt/hn/hn-python2/root/usr/bin/python
# python -V
Python 2.7.11
</pre></div>


<p>使い終わったら <code>exit</code> で上記で起動したシェルを抜けてください。</p>
<p>ちなみに、Software Collectionsで提供されているPython 2.7のインストール方法は<a href="https://www.softwarecollections.org/en/scls/rhscl/python27/">Python 2.7 — Software Collections</a>です。</p>
<h2>Python2の最新版rpmを作った時のメモ</h2>
<p>以下はrpmを作った時のメモです。<a href="https://www.softwarecollections.org/en/docs/guide/">Packaging Guide — Software Collections</a>を読みながら試行錯誤してrpmを作りました。</p>
<h3>Software Collectionsのメタパッケージ</h3>
<p><a href="https://www.softwarecollections.org/en/docs/guide/#sect-Package_Layout">Packaging Guide — Software Collections</a>で説明されていますが、Software Collectionsではメタパッケージというのを作成します。</p>
<p>例えば今回ベースにしたPython 2.7だと<a href="https://www.softwarecollections.org/repos/rhscl/python27/epel-7-x86_64/python27-1.1-20.el7/">python27</a>というのがメタパッケージで、　Python2本体のパッケージは<a href="https://www.softwarecollections.org/repos/rhscl/python27/epel-7-x86_64/python27-python-2.7.8-3.el7/">Software CollectionsのPython27のpythonパッケージ</a>です。</p>
<p>Software Collectionsを自作する場合は、パッケージ名が衝突しないように「組織名-」という接頭辞をつけるようにと<a href="https://www.softwarecollections.org/en/docs/guide/#sect-The_Software_Collections_Prefix">2.4. The Software Collection Prefix</a>に書かれています。公式のソフトウェアコレクションは接頭辞無しで <code>python27</code> のようなコレクション名になっています。</p>
<p>また、<a href="https://www.softwarecollections.org/en/docs/guide/#sect-The_File_System_Hierarchy">2.2. The File System Hierarchy</a>に書かれているように、ソフトウェアコレクションのrpmに含まれるファイルは <code>/opt/提供者名/ソフトウェアコレクション名/</code> というディレクトリ構成を取ります。公式のソフトウェアコレクションは <code>/opt/rh/ソフトウェアコレクション名/</code> というディレクトリになっています。rhはredhatの略だと思います。</p>
<p>今回は <code>hn-python2</code> というメタパッケージ名とし、ディレクトリは <code>/opt/hn/python2/</code> としました。</p>
<h3>Software Collectionsのメタパッケージのビルド</h3>
<p>ビルド用のファイルは<a href="https://github.com/hnakamur/hnscl-python2-rpm">hnakamur/hnscl-python2-rpm</a>に置いてあります。</p>
<p><a href="https://www.softwarecollections.org/en/docs/guide/#sect-The_Software_Collection_Root_Directory">2.3. The Software Collection Root Directory</a>によるとspecファイルに以下のように書けばよいそうです。providerの箇所は提供者ごとの値に変えます。</p>
<div class="highlight"><pre><span></span><span class="nf">%global</span> <span class="n">_scl_prefix</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">provider</span>
</pre></div>


<p>ですが、実際に試してみるとこの設定だけだと、ビルドされたrpm内のファイルパスだったりファイルの中身に <code>/opt/rh/</code> というパスが残ってしまいました。試行錯誤の結果以下のように書くことで全て <code>/opt/hn/</code> に変わりました。</p>
<p><a href="https://github.com/hnakamur/hnscl-python2-rpm/blob/06a6fa366bd485d722139f0637ce2def364eaef3/SPECS/hn-python2.spec#L1-L22">hn-python2-spec</a></p>
<div class="highlight"><pre><span></span><span class="nf">%global</span> <span class="n">scl_name_prefix</span> <span class="n">hn</span><span class="o">-</span>
<span class="nf">%global</span> <span class="n">scl_name_base</span> <span class="n">python</span>
<span class="nf">%global</span> <span class="n">scl_name_version</span> <span class="mi">2</span>
<span class="nf">%global</span> <span class="n">scl</span> <span class="o">%</span><span class="p">{</span><span class="n">scl_name_prefix</span><span class="p">}</span><span class="o">%</span><span class="p">{</span><span class="n">scl_name_base</span><span class="p">}</span><span class="o">%</span><span class="p">{</span><span class="n">scl_name_version</span><span class="p">}</span>

<span class="cp"># NOTE: You must set _scl_prefix before &#39;%scl_package %scl&#39;.</span>
<span class="nf">%global</span> <span class="n">_scl_prefix</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hn</span>
<span class="cp"># NOTE: The following variables must be re-evaluated after changing _scl_prefix above.</span>
<span class="cp"># I got these settings after trials and errors.</span>
<span class="cp"># I don&#39;t know this is the right way to set directories with my _scl_prefix.</span>
<span class="nf">%global</span> <span class="n">_scl_scripts</span>            <span class="o">%</span><span class="p">{</span><span class="n">_scl_prefix</span><span class="p">}</span><span class="o">/%</span><span class="p">{</span><span class="n">scl</span><span class="p">}</span>
<span class="nf">%global</span> <span class="n">_scl_root</span>               <span class="o">%</span><span class="p">{</span><span class="n">_scl_prefix</span><span class="p">}</span><span class="o">/%</span><span class="p">{</span><span class="n">scl</span><span class="p">}</span><span class="o">/</span><span class="n">root</span>
<span class="nf">%global</span> <span class="n">_prefix</span>                 <span class="o">%</span><span class="p">{</span><span class="n">_scl_root</span><span class="p">}</span><span class="o">/</span><span class="n">usr</span>
<span class="nf">%global</span> <span class="n">_sysconfdir</span>             <span class="o">%</span><span class="p">{</span><span class="n">_scl_root</span><span class="p">}</span><span class="o">/</span><span class="n">etc</span>
<span class="nf">%global</span> <span class="n">_sharedstatedir</span>         <span class="o">%</span><span class="p">{</span><span class="n">_scl_root</span><span class="p">}</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span>
<span class="nf">%global</span> <span class="n">_localstatedir</span>          <span class="o">%</span><span class="p">{</span><span class="n">_scl_root</span><span class="p">}</span><span class="o">/</span><span class="n">var</span>
<span class="nf">%global</span> <span class="n">_datadir</span>                <span class="o">%</span><span class="p">{</span><span class="n">_scl_root</span><span class="p">}</span><span class="o">/</span><span class="n">share</span>
<span class="nf">%global</span> <span class="n">_docdir</span>                 <span class="o">%</span><span class="p">{</span><span class="n">_datadir</span><span class="p">}</span><span class="o">/</span><span class="n">doc</span>
<span class="nf">%global</span> <span class="n">_mandir</span>                 <span class="o">%</span><span class="p">{</span><span class="n">_datadir</span><span class="p">}</span><span class="o">/</span><span class="n">man</span>


<span class="nf">%scl_package</span> <span class="nf">%scl</span>
<span class="p">...(</span><span class="n">snip</span><span class="p">)...</span>
</pre></div>


<h3>Python本体のパッケージのビルド</h3>
<p>ビルド用のファイルは<a href="https://github.com/hnakamur/hnscl-python2-python-rpm">hnakamur/hnscl-python2-python-rpm</a>に置いてあります。</p>
<p>インストールディレクトリを <code>/opt/hn/</code> 以下にするため、試行錯誤した結果specファイルに以下のように書けばOKでした。</p>
<p><a href="https://github.com/hnakamur/hnscl-python2-python-rpm/blob/3a13fe74587d6beca871d28a68149a2273488672/SPECS/python.spec#L1-L31">python.spec</a></p>
<div class="highlight"><pre><span></span><span class="nf">%global</span> <span class="n">scl_name_prefix</span> <span class="n">hn</span><span class="o">-</span>
<span class="nf">%global</span> <span class="n">scl_name_base</span> <span class="n">python</span>
<span class="nf">%global</span> <span class="n">scl_name_version</span> <span class="mi">2</span>
<span class="nf">%global</span> <span class="n">scl</span> <span class="o">%</span><span class="p">{</span><span class="n">scl_name_prefix</span><span class="p">}</span><span class="o">%</span><span class="p">{</span><span class="n">scl_name_base</span><span class="p">}</span><span class="o">%</span><span class="p">{</span><span class="n">scl_name_version</span><span class="p">}</span>

<span class="cp"># NOTE: You must set _scl_prefix before &#39;%scl_package %scl&#39;.</span>
<span class="nf">%global</span> <span class="n">_scl_prefix</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hn</span>
<span class="cp"># NOTE: The following variables must be re-evaluated after changing _scl_prefix above.</span>
<span class="nf">%global</span> <span class="n">_scl_scripts</span>            <span class="o">%</span><span class="p">{</span><span class="n">_scl_prefix</span><span class="p">}</span><span class="o">/%</span><span class="p">{</span><span class="n">scl</span><span class="p">}</span>
<span class="nf">%global</span> <span class="n">_scl_root</span>               <span class="o">%</span><span class="p">{</span><span class="n">_scl_prefix</span><span class="p">}</span><span class="o">/%</span><span class="p">{</span><span class="n">scl</span><span class="p">}</span><span class="o">/</span><span class="n">root</span>
<span class="nf">%global</span> <span class="n">_prefix</span>                 <span class="o">%</span><span class="p">{</span><span class="n">_scl_root</span><span class="p">}</span><span class="o">/</span><span class="n">usr</span>
<span class="nf">%global</span> <span class="n">_sysconfdir</span>             <span class="o">%</span><span class="p">{</span><span class="n">_scl_root</span><span class="p">}</span><span class="o">/</span><span class="n">etc</span>
<span class="nf">%global</span> <span class="n">_sharedstatedir</span>         <span class="o">%</span><span class="p">{</span><span class="n">_scl_root</span><span class="p">}</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span>
<span class="nf">%global</span> <span class="n">_localstatedir</span>          <span class="o">%</span><span class="p">{</span><span class="n">_scl_root</span><span class="p">}</span><span class="o">/</span><span class="n">var</span>

<span class="nf">%global</span> <span class="n">_includedir</span>             <span class="o">%</span><span class="p">{</span><span class="n">_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">include</span>
<span class="nf">%if</span> <span class="s">&quot;%{_lib}&quot;</span> <span class="o">==</span> <span class="s">&quot;lib64&quot;</span>
<span class="nf">%global</span> <span class="n">_libdir</span>                 <span class="o">%</span><span class="p">{</span><span class="n">_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">lib64</span>
<span class="nf">%else</span>
<span class="nf">%global</span> <span class="n">_libdir</span>                 <span class="o">%</span><span class="p">{</span><span class="n">_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">lib</span>
<span class="nf">%endif</span>
<span class="nf">%global</span> <span class="n">_datadir</span>                <span class="o">%</span><span class="p">{</span><span class="n">_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">share</span>
<span class="nf">%global</span> <span class="n">_docdir</span>                 <span class="o">%</span><span class="p">{</span><span class="n">_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span>
<span class="nf">%global</span> <span class="n">_datarootdir</span>            <span class="o">%</span><span class="p">{</span><span class="n">_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">share</span>
<span class="nf">%global</span> <span class="n">_infodir</span>                <span class="o">%</span><span class="p">{</span><span class="n">_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">info</span>
<span class="nf">%global</span> <span class="n">_mandir</span>                 <span class="o">%</span><span class="p">{</span><span class="n">_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">man</span>
<span class="nf">%global</span> <span class="n">_defaultdocdir</span>          <span class="o">%</span><span class="p">{</span><span class="n">_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span>

<span class="nf">%global</span> <span class="n">_exec_prefix</span>            <span class="o">%</span><span class="p">{</span><span class="n">_prefix</span><span class="p">}</span>
<span class="nf">%global</span> <span class="n">_bindir</span>                 <span class="o">%</span><span class="p">{</span><span class="n">_exec_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">bin</span>
<span class="nf">%global</span> <span class="n">_sbindir</span>                <span class="o">%</span><span class="p">{</span><span class="n">_exec_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">sbin</span>
<span class="p">...(</span><span class="n">snip</span><span class="p">)...</span>
</pre></div>


<h3>Python本体のspecファイルのパッチ更新</h3>
<p><a href="https://github.com/hnakamur/hnscl-python2-python-rpm/blob/3a13fe74587d6beca871d28a68149a2273488672/SPECS/python.spec">python.spec</a>には約60個のパッチが含まれています。</p>
<p>Pythonのソースのバージョンを上げたのでパッチが当たらなくなるケースが出てきました。patchを実行した時に生成される <code>*.rej</code> ファイルを見て、なんとなくこんな感じだろという軽いノリでパッチを一通り更新しました。</p>
<p>作業手順は<a href="/blog/2015/12/16/how_to_debug_errors_in_rpm_build_using_mock/">mockを使ったrpmビルドが失敗した時の調査方法 · hnakamur's blog at github</a>に書いた手順で、mockのchroot環境内でパッチを修正して <code>rpmbuild -bp specファイル名</code> でパッチを当てるというのをひたすら繰り返した感じです。</p>
<p>パッチ1つごとの修正を<a href="https://github.com/hnakamur/hnscl-python2-python-rpm/commits/master">Commits · hnakamur/hnscl-python2-python-rpm</a>のだいたい1つのコミットにしています。ただ、後からさらに修正が必要だったものは別コミットになっていますが。</p>
<p>また、CentOSのPythonのspecファイルではリリースビルドとデバッグビルドを作ってテストも実行するようになっています。これがかなり時間がかるので、ビルドが通らない段階では<a href="https://github.com/hnakamur/hnscl-python2-python-rpm/commit/ebb31040e3e5bfe0ceb62cd4eb67793bd1a333b0">リリースビルドだけにしてテストは実行しないようにしていました</a>。ビルドが落ち着いてきたところで<a href="https://github.com/hnakamur/hnscl-python2-python-rpm/commit/8a293e3dbd25f6cb6638b00efc07ce5cf962a397">この変更をgit revert</a>してビルド・テストするようにしました。</p>
<h2>おわりに</h2>
<p><a href="https://www.softwarecollections.org/repos/rhscl/python27/epel-7-x86_64/python27-python-2.7.8-3.el7/">Software CollectionsのPython27のpythonパッケージ</a>を改変して作ったPython2の最新版2.7.11のrpmについて説明しました。</p>
<p>CentOS 7でもPython2の最新版が手軽に利用可能になるので、ぜひご活用ください。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>