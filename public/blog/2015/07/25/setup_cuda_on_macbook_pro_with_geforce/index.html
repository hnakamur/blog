<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>GeForce搭載の旧モデルMacBook ProでCUDAをセットアップする手順のメモ</title>
        <link rel="stylesheet" href="../../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../../blog/2015/07/25/setup_cuda_on_macbook_pro_with_geforce/" rel="bookmark"
           title="Permalink to GeForce搭載の旧モデルMacBook ProでCUDAをセットアップする手順のメモ">GeForce搭載の旧モデルMacBook ProでCUDAをセットアップする手順のメモ</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-07-25T17:37:00+09:00">
                Published: 2015-07-25
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../../tag/cuda.html">cuda</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p><a href="http://www.apple.com/jp/macbook-pro/specs-retina/">MacBook Pro現行モデルの技術仕様</a>を見ると最上位機種のグラフィックスチップはIntel Iris Pro GraphicsとAMD Radeon R9 M370Xとなっており、NVIDIA GeForceは搭載されていません。</p>
<p>ですが、<a href="https://support.apple.com/kb/SP694?locale=ja_JP&amp;viewlocale=ja_JP">MacBook Pro (15-inch, Mid 2012) - 技術仕様</a>を見ると、私が持っているMacBook Proは15インチ2.6GHzモデルなのでNVIDIA GeForce GT 650M、1GB GDDR5メモリが搭載されています。</p>
<p><a href="http://www.nvidia.co.jp/object/geforce-gt-650m-jp.html#pdpContent=2">GeForce GT 650M | NVIDIA</a>には「プログラミング環境」の行に「CUDA」とあるのでCUDAが使えるようです。</p>
<p>ということでCUDAを試してみたので、手順をメモしておきます。試した時のOS Xのバージョンは10.10.4、Xcodeのバージョンは6.4です。</p>
<h2>CUDAドライバのインストールとアップデート</h2>
<p>後述のCUDAツールキットのインストール中の画面にCUDAドライバも含まれているような記述があったので、この手順は不要かもしれません。が、今回はそれを知らずに先にCUDAドライバを単体でインストールしたので、一応書いておきます。</p>
<p><a href="http://www.nvidia.co.jp/object/mac-driver-archive-jp.html">MAC アーカイブ用CUDA ドライバ | NVIDIA</a>から最新のドライバをダウンロード、インストールします。</p>
<p><a href="http://www.nvidia.co.jp/object/macosx-cuda-7.0.36-driver-jp.html">NVIDIA DRIVERS 7.0.36</a>の「リリースハイライト」によると、[システム環境設定]→[CUDA]でインストール済みのCUDAドライバのバージョンと最新バージョンの確認が出来て、アップデートもできるそうです。</p>
<p>早速確認してみると、インストール済みのCUDA Driver Versionは7.0.29となっており、CUDA 7.0.52 Driver update is availableと表示されていました。</p>
<p>7.0.36のドライバを単体でインストールしたのに7.0.29になっているのは後述のCUDAツールキットのインストールで上書きされたのだと思われます。ついでなので、[Install CUDA Update]ボタンを押してアップデートしておきました。</p>
<h2>CUDAツールキットのインストール</h2>
<p><a href="http://docs.nvidia.com/cuda/index.html#axzz3gt2fIbGh">CUDA Toolkit Documentation</a>のページから<a href="http://docs.nvidia.com/cuda/cuda-getting-started-guide-for-mac-os-x/index.html#axzz3gt2fIbGh">Getting Started Mac OS X</a>に進み、<a href="http://docs.nvidia.com/cuda/cuda-getting-started-guide-for-mac-os-x/index.html#installation">3. Installation</a>を参考にCUDAツールキットをインストールしました。</p>
<p><a href="https://developer.nvidia.com/cuda-downloads">CUDA 7 Downloads</a>で[Mac OSX]のタブに切り替えてインストーラをダウンロードします。最初Network Installerを試したのですが、ダウンロードしたdmgファイルを開いてCUDAMacOSXInstallerをダブルクリックしたら「“CUDAMacOSXInstaller”はこわれているため開けません。」というエラーが出たので、Local Installer (977MB)を試したら、こちらは無事インストール出来ました。</p>
<p>その後、cuFFT Patchをダウンロードして、<a href="http://developer.download.nvidia.com/compute/cuda/7_0/Prod/cufft_update/README_mac.txt">README</a>を参考にターミナルで以下のコマンドを実行してパッチを適用しました。</p>
<div class="highlight"><pre><span></span>sudo tar zxf ~/Downloads/cufft_patch_mac.tar.gz -C /Developer/NVIDIA/CUDA-7.0
</pre></div>


<h3>CUDAツールキット用の環境変数設定</h3>
<p><a href="http://docs.nvidia.com/cuda/cuda-getting-started-guide-for-mac-os-x/index.html#axzz3gt2fIbGh">Getting Started Mac OS X</a>の<a href="http://docs.nvidia.com/cuda/cuda-getting-started-guide-for-mac-os-x/index.html#install">3.2. Install</a>で環境変数 <code>PATH</code> と <code>DYLD_LIBRARY_PATH</code> の設定方法が書いてあるのですが、この通りだとあとでPyCUDAをインストールするときに <code>-lcuda</code> が見つからずリンクエラーになりました。</p>
<p>検索してみると<a href="https://code.google.com/p/pyrit/issues/detail?id=248">Issue 248 - pyrit - Build script can't find CUDA library directory on OS X. - WPA/WPA2-PSK and a world of affordable many-core platforms - Google Project Hosting</a> で <code>/usr/local/cuda</code> というディレクトリがあることを知り、<code>/usr/local/cuda/lib</code> と <code>/Developer/NVIDIA/CUDA-7.0/lib</code> の中身を見てみると <code>libcuda.dylib</code> だけは前者にしか無いことが判明しました。</p>
<p>結局以下のように設定する必要がありました (bash以外の場合は適宜変更してください)。</p>
<div class="highlight"><pre><span></span>echo &lt;&lt;&#39;EOF&#39; &gt;&gt; ~/.bash_profile
# CUDA
export CUDA_ROOT=/usr/local/cuda
export PATH=$CUDA_ROOT/bin:$PATH
export DYLD_LIBRARY_PATH=$CUDA_ROOT/lib:$PATH
EOF
</pre></div>


<p>設定ファイルを書き換えたら以下のコマンドでシェルを再起動して設定を読み込んでおきます。</p>
<div class="highlight"><pre><span></span>exec $SHELL -l
</pre></div>


<h3>統合GPUではなくGeForceを使うように切り替える設定</h3>
<p><a href="http://docs.nvidia.com/cuda/cuda-getting-started-guide-for-mac-os-x/index.html#axzz3gt2fIbGh">Getting Started Mac OS X</a>の<a href="http://docs.nvidia.com/cuda/cuda-getting-started-guide-for-mac-os-x/index.html#install">3.2. Install</a>の説明に従って、以下のように設定しました。</p>
<ul>
<li>[システム環境設定]→[省エネルギー]を開きます</li>
<li>[グラフィックスの自動切り替え]のチェックを外します</li>
<li>電源アダプタに繋いでいる場合は[電源アダプタ]、繋いでいない場合は[バッテリー]を選びます</li>
<li>[コンピュータのスリープ]のスライダーを[しない]に調節します。</li>
</ul>
<h2>CUDAのサンプルを試す</h2>
<p><a href="http://docs.nvidia.com/cuda/cuda-getting-started-guide-for-mac-os-x/index.html#axzz3gt2fIbGh">Getting Started Mac OS X</a>の<a href="http://docs.nvidia.com/cuda/cuda-getting-started-guide-for-mac-os-x/index.html#install">3.2. Install</a>の説明に従って、 <code>cuda-install-samples-7.0.sh</code> を使ってサンプルプログラムを取得して試してみました。</p>
<p><code>~/sandbox/cuda</code> という作業用のディレクトリを作って以下の手順で試しました。 <code>cuda-install-samples-7.0.sh</code> はインストール先のディレクトリを引数で指定する必要がありました。</p>
<div class="highlight"><pre><span></span>mkdir -p ~/sandbox/cuda
cd !$
cuda-install-samples-7.0.sh .
</pre></div>


<p>実行すると <code>NVIDIA_CUDA-7.0_Samples</code> というディレクトリが作成され、配下にサンプルプログラムのソースファイルが展開されていました。</p>
<p>そのうちの1つ <code>asyncAPI</code> というのを試してみました。以下の手順でビルドします。</p>
<div class="highlight"><pre><span></span>cd NVIDIA_CUDA-7.0_Samples/0_Simple/asyncAPI
make
</pre></div>


<p>実行してみました。</p>
<div class="highlight"><pre><span></span>$ ../../bin/x86_64/darwin/release/asyncAPI
<span class="o">[</span>../../bin/x86_64/darwin/release/asyncAPI<span class="o">]</span> - Starting...
GPU Device <span class="m">0</span>: <span class="s2">&quot;GeForce GT 650M&quot;</span> with compute capability <span class="m">3</span>.0

CUDA device <span class="o">[</span>GeForce GT 650M<span class="o">]</span>
<span class="nb">time</span> spent executing by the GPU: <span class="m">99</span>.45
<span class="nb">time</span> spent by CPU in CUDA calls: <span class="m">0</span>.05
CPU executed <span class="m">583004</span> iterations <span class="k">while</span> waiting <span class="k">for</span> GPU to finish
</pre></div>


<p>動きました！</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>