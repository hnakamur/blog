<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>GeForce搭載の旧モデルMacBook ProでCaffeをビルドする手順メモ</title>
        <link rel="stylesheet" href="../../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../../blog/2015/07/26/build_caffe_on_macbook_with_geforce/" rel="bookmark"
           title="Permalink to GeForce搭載の旧モデルMacBook ProでCaffeをビルドする手順メモ">GeForce搭載の旧モデルMacBook ProでCaffeをビルドする手順メモ</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2015-07-26T00:53:00+09:00">
                Published: 2015-07-26
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../../tag/machine-learning.html">machine-learning</a> <a href="../../../../../tag/caffe.html">caffe</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p><a href="/blog/2015/07/25/setup_cuda_on_macbook_pro_with_geforce/">GeForce搭載の旧モデルMacBook ProでCUDAをセットアップする手順のメモ</a>でCUDA 7.0.29をインストールしたMacBook Proで<a href="http://caffe.berkeleyvision.org/">Caffe | Deep Learning Framework</a>をビルドしてみた手順メモです。</p>
<p><a href="https://pypi.python.org/pypi?%3Aaction=search&amp;term=caffe&amp;submit=search">PyPIでCaffeで検索</a>しても出てこないので、ソースからビルドするしかないようです。</p>
<p><a href="http://caffe.berkeleyvision.org/install_osx.html">OS X Installation</a>を参考にしつつ、一部手順を変更してインストールしました。</p>
<h2>CaffeはPython3非対応</h2>
<p><a href="http://qiita.com/icoxfog417/items/65e800c3a2094457c3a0">Python - はじめるDeep learning - Qiita</a>で紹介されていた<a href="https://github.com/BVLC/caffe/issues/293">Python3 support · Issue #293 · BVLC/caffe</a>によると、オフィシャルでPython3対応の予定はないとのこと。Python3でも動かないこともないそうですが、初心者なのでまずはPython2で動かすことにします。</p>
<h2>依存ライブラリのインストール</h2>
<p>依存するライブラリを以下のコマンドでインストールしました。</p>
<div class="highlight"><pre><span></span>brew install -vd snappy leveldb gflags glog szip lmdb
brew tap homebrew/science
brew install hdf5 opencv
</pre></div>


<h3>protobufのインストール</h3>
<p>以下のコマンドでprotobufをインストールします。</p>
<div class="highlight"><pre><span></span>brew install protobuf
</pre></div>


<p><a href="http://caffe.berkeleyvision.org/install_osx.html">OS X Installation</a>の手順では <code>--with-python</code> オプションを指定していますが、 <code>brew info protobuf</code> で確認すると2.6.1用のformulaでは <code>--with-python</code> オプションは無くなって代わりに <code>--without-python</code> オプションが出来ていました。何も指定しなければpythonサポートが入るようです。</p>
<p>なお、インストール完了時に以下のメッセージが出ますが、後でvirtualenvで作った環境内で <code>pip install protobuf</code> すればいけるので、ここに書かれている対応は不要でした。</p>
<div class="highlight"><pre><span></span><span class="o">==&gt;</span> <span class="n">Caveats</span>
<span class="n">Editor</span> <span class="n">support</span> <span class="ow">and</span> <span class="n">examples</span> <span class="n">have</span> <span class="n">been</span> <span class="n">installed</span> <span class="n">to</span><span class="p">:</span>
  <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">Cellar</span><span class="o">/</span><span class="n">protobuf</span><span class="o">/</span><span class="mf">2.6</span><span class="o">.</span><span class="mi">1</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">protobuf</span>

<span class="n">Python</span> <span class="n">modules</span> <span class="n">have</span> <span class="n">been</span> <span class="n">installed</span> <span class="ow">and</span> <span class="n">Homebrew</span><span class="s1">&#39;s site-packages is not</span>
<span class="ow">in</span> <span class="n">your</span> <span class="n">Python</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">so</span> <span class="n">you</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">be</span> <span class="n">able</span> <span class="n">to</span> <span class="kn">import</span> <span class="nn">the</span> <span class="nn">modules</span>
<span class="n">this</span> <span class="n">formula</span> <span class="n">installed</span><span class="o">.</span> <span class="n">If</span> <span class="n">you</span> <span class="n">plan</span> <span class="n">to</span> <span class="n">develop</span> <span class="k">with</span> <span class="n">these</span> <span class="n">modules</span><span class="p">,</span>
<span class="n">please</span> <span class="n">run</span><span class="p">:</span>
  <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span>
  <span class="n">echo</span> <span class="s1">&#39;import site; site.addsitedir(&quot;/usr/local/lib/python2.7/site-packages&quot;)&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">homebrew</span><span class="o">.</span><span class="n">pth</span>
</pre></div>


<h3>boost 1.57.0, boost-python 1.57.0 のインストール</h3>
<p><code>brew install boost boost-python</code> だと1.58.0が入ったのですが、Caffeのビルド時にコンパイルエラーが出ました。<a href="http://itinerantbioinformaticist.blogspot.jp/2015/05/caffe-incompatible-with-boost-1580.html">Itinerant Bioinformaticist: Caffe incompatible with Boost 1.58.0</a>と同じエラーですが、ここに回避方法も書かれていたので、これに従いました。</p>
<p>まず、boost 1.58.0, boost-python 1.58.0が入っている場合はアンインストールします。</p>
<div class="highlight"><pre><span></span>brew uninstall boost boost-python
</pre></div>


<p>以下の手順で1.57.0をソースからインストールします。</p>
<div class="highlight"><pre><span></span>cd `brew --prefix`/Library/Formula
curl -O https://raw.githubusercontent.com/Homebrew/homebrew/6fd6a9b6b2f56139a44dd689d30b7168ac13effb/Library/Formula/boost.rb
curl -O https://raw.githubusercontent.com/Homebrew/homebrew/3141234b3473717e87f3958d4916fe0ada0baba9/Library/Formula/boost-python.rb
brew install --build-from-source -vd boost boost-python
</pre></div>


<h2>Python2でvirtualenvで作業用の環境を作成して依存ライブラリをインストール</h2>
<p>個人的にはAnaconda Pythonのようなオールインワンのインストーラはあまり好きではないので、<a href="https://github.com/riywo/anyenv">riywo/anyenv</a>と<a href="https://github.com/yyuu/pyenv">yyuu/pyenv</a>で入れたPython 2.7.10を使いました。</p>
<p>作業用のディレクトリ <code>~/work/caffe</code> を作ってvirtualenvで環境を作りました。</p>
<div class="highlight"><pre><span></span>mkdir -p ~/work/caffe
cd !$
pyenv local 2.7.10
virtualenv venv
source venv/bin/activate
</pre></div>


<p>HomebrewでインストールしたPython 2.7.10でも <code>pyenv local 2.7.10</code> の行を除けば同じ手順で行けました。</p>
<p>Caffeで必要なprotobufとnumpyを以下の手順でインストールします。</p>
<div class="highlight"><pre><span></span>pip install protobuf
pip install numpy
</pre></div>


<h2>Caffeのソースを取得してビルド</h2>
<p>ソースを取得してディレクトリに入ります。</p>
<div class="highlight"><pre><span></span>cd ~/work/caffe
git clone https://github.com/BVLC/caffe
cd caffe
</pre></div>


<p><a href="http://caffe.berkeleyvision.org/installation.html#compilation">Installation</a>を参考にビルドします。virtualenv環境のincludeとlibディレクトリを参照するように以下のように加工してMakefile.configを作成します。Caffeのソースを違うディレクトリに配置した場合は適宜変更してください。</p>
<div class="highlight"><pre><span></span><span class="err">sed</span> <span class="s1">&#39;</span>
<span class="s1">s|/usr/include/python2.7|$(HOME)/work/caffe/venv/include/python2.7|</span>
<span class="s1">s|/usr/lib/python2.7/dist-packages|$(HOME)/work/caffe/venv/lib/python2.7/site-packages|</span>
<span class="s1">&#39;</span> <span class="err">Makefile.config.example</span> <span class="err">&gt;</span> <span class="err">Makefile.config</span>
</pre></div>


<p>Caffeをビルドします。</p>
<div class="highlight"><pre><span></span>make all
</pre></div>


<p>テストコードをビルドします。</p>
<div class="highlight"><pre><span></span>make test
</pre></div>


<p>テストを実行します。</p>
<div class="highlight"><pre><span></span>(venv)$ make runtest
...(略)...
[----------] Global test environment tear-down
[==========] 1356 tests from 214 test cases ran. (306870 ms total)
[  PASSED  ] 1356 tests.

  YOU HAVE 2 DISABLED TESTS
</pre></div>


<p>ということで、Caffeをビルドする手順でした。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>