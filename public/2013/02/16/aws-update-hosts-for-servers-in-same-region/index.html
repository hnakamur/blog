<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>EC2で同じリージョンの全ホストのプライベートIPを起動時にhostsに自動登録</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2013/02/16/aws-update-hosts-for-servers-in-same-region/" rel="bookmark"
           title="Permalink to EC2で同じリージョンの全ホストのプライベートIPを起動時にhostsに自動登録">EC2で同じリージョンの全ホストのプライベートIPを起動時にhostsに自動登録</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-02-16T00:00:00+09:00">
                Published: 2013-02-16
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/aws.html">aws</a> </p>
</footer><!-- /.post-info -->      <p>Elastic IPの上限数にひっかかって使えない自体に遭遇したので作りました。</p>
<p><a href="http://aws.amazon.com/jp/contact-us/eip_limit_request/">Elastic IP アドレス上限緩和申請 | アマゾン ウェブ サービス（AWS 日本語）</a> から緩和申請できるようです。</p>
<p>が、申請完了画面で、3〜5営業日かかる、緊急の場合は、完了画面に表示されるCase Numberを添えて ec2-request@amazon.com に送るようにと書かれていました。</p>
<p>（Case Numberを添えてというのは今気付いた。再度メールしました。ブログに書くために読み返してよかった）</p>
<p>そこで、hostsにプライベートアドレスを登録するスクリプトを書くことにしました。</p>
<p><a href="http://frmmpgit.blog.fc2.com/blog-entry-123.html">EC2 - 動的プライベートIPアドレスをどうにかする | code up</a> を参考にしました。ありがとうございます。</p>
<p>最初は対象のホストの一覧を指定するようなスクリプトを書いていたのですが、ホストを増やすことを考えると編集と反映が面倒だと予想して、リージョン内の全ホストを一括登録することにしました。</p>
<h2>情報取得用のAIMユーザ作成</h2>
<p>AIMでUserを作ってUser PolicyにReadOnlyAccessを与えます。</p>
<h2>スクリプト設置</h2>
<p>以下の設定ファイルとスクリプトを設置します。</p>
<p>アクセスキーとシークレットキーは上で作ったユーザのものを設定します。</p>
<p>/root/.amazon_address_finder_key</p>
<div class="highlight"><pre><span></span>export AWS_ACCESS_KEY=<span class="cp">${</span><span class="n">your_access_key_here</span><span class="cp">}</span>
export AWS_SECRET_KEY=<span class="cp">${</span><span class="n">your_secret_key_here</span><span class="cp">}</span>
</pre></div>


<p>/usr/local/sbin/update_hosts.sh</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
. /root/.amazon_address_finder_key
<span class="nv">region</span><span class="o">=</span><span class="sb">`</span>ec2-metadata <span class="p">|</span> sed -n <span class="s1">&#39;s/^local-hostname: ip-[0-9-]*\.\(.*\)\.compute\.i</span>
<span class="s1">nternal/\1/p&#39;</span><span class="sb">`</span>

ec2-describe-instances --region <span class="nv">$region</span> -H --show-empty-fields <span class="p">|</span> gawk <span class="s1">&#39;</span>
<span class="s1">BEGIN {OFS=&quot;\t&quot;; print &quot;127.0.0.1&quot;, &quot;localhost localhost.localdomain&quot;}</span>
<span class="s1">/^INSTANCE/ {ip = $18}  </span>
<span class="s1">/^TAG/ {print ip, gensub(/.*\tName\t([^\t]*).*/, &quot;\\1&quot;, $0)}  </span>
<span class="s1">&#39;</span> &gt; /etc/hosts
</pre></div>
</td></tr></table>

<p>/etc/cron.d/update_hosts</p>
<div class="highlight"><pre><span></span>@reboot root /usr/local/sbin/update_hosts.sh
</pre></div>


<h2>実行</h2>
<p>これで、OS起動時にhostsが上書き更新されます。</p>
<p>インタンスのNameタグに設定した値がホスト名になります。</p>
<p>出力例</p>
<div class="highlight"><pre><span></span>127.0.0.1       localhost localhost.localdomain
10.132.102.199  web01
10.128.21.174   web02
10.120.32.111   app01
10.132.103.238  app02
</pre></div>


<h2>githubに移動しました</h2>
<p>さらにhostnameも更新するようにして、スクリプトが発展してきたので、
<a href="https://github.com/hnakamur/aws_scripts">hnakamur/aws_scripts · GitHub</a>
に移動しました。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>