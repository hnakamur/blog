<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Unboundで在宅時に自宅サーバの名前解決</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2013/02/02/use-unbound-dns-server/" rel="bookmark"
           title="Permalink to Unboundで在宅時に自宅サーバの名前解決">Unboundで在宅時に自宅サーバの名前解決</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-02-02T00:00:00+09:00">
                Published: 2013-02-02
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/centos.html">centos</a> <a href="../../../../tag/unbound.html">unbound</a> </p>
</footer><!-- /.post-info -->      <h2>背景</h2>
<p>私の自宅ではブロードバンドルータがグローバルIPを持っていて、DNSで自分のドメイン(以下ではexample.comとして説明します)のIPアドレスをそこにしています。ルータからLAN内のLinuxサーバ(CentOS 6.x)へはNATで繋いでいます。</p>
<p>外出時はこれでよいのですが、在宅時にLAN内からexample.comという名前でアクセスしようとするとサーバにアクセスできません。</p>
<p>今までは <a href="https://github.com/hnakamur/switch_net_configs">hnakamur/switch_net_configs · GitHub</a> を使って外出時と在宅時に/etc/hostsと~/.ssh/configを切り替えてしのいでいました。が、VirtualBoxのゲストとかを考えると面倒です。</p>
<p>そこで、自宅サーバにDNSサーバを入れてみることにしました。
bindはセキュリティフィクスが頻発しているから避けて他のにしようと思い、<a href="http://en.wikipedia.org/wiki/Comparison_of_DNS_server_software">Comparison of DNS server software - Wikipedia, the free encyclopedia</a> を見てみました。
moreに対してlessが生まれたように、bindに対してunboundというネーミングセンスが気に入ったのと、 <a href="http://www.atmarkit.co.jp/flinux/special/unbound/unbounda.html">＠IT：DNSリゾルバのニューフェイス「Unbound」（1/2）</a> の記事を読んで、簡単に導入できそうと思ったのでUnboundにしました。</p>
<h2>導入手順</h2>
<p>unboundはepelにあるので、yumでインストールします。</p>
<div class="highlight"><pre><span></span>yum install unbound
</pre></div>


<p>/etc/unbound/unbound.confを編集します。編集結果はこんな感じ。</p>
<div class="highlight"><pre><span></span><span class="cp"># diff -u /etc/unbound/unbound.conf.orig /etc/unbound/unbound.conf</span>
<span class="o">---</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">unbound</span><span class="o">/</span><span class="n">unbound</span><span class="p">.</span><span class="n">conf</span><span class="p">.</span><span class="n">orig</span>  <span class="mi">2013</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mo">02</span> <span class="mo">01</span><span class="o">:</span><span class="mi">56</span><span class="o">:</span><span class="mf">13.541249978</span> <span class="o">+</span><span class="mi">0900</span>
<span class="o">+++</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">unbound</span><span class="o">/</span><span class="n">unbound</span><span class="p">.</span><span class="n">conf</span> <span class="mi">2013</span><span class="o">-</span><span class="mo">02</span><span class="o">-</span><span class="mo">02</span> <span class="mo">02</span><span class="o">:</span><span class="mi">15</span><span class="o">:</span><span class="mf">52.559227483</span> <span class="o">+</span><span class="mi">0900</span>
<span class="p">@@</span> <span class="o">-</span><span class="mi">28</span><span class="p">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">28</span><span class="p">,</span><span class="mi">7</span> <span class="p">@@</span>
  <span class="n">extended</span><span class="o">-</span><span class="nl">statistics</span><span class="p">:</span> <span class="n">yes</span>

  <span class="cp"># number of threads to create. 1 disables threading.</span>
<span class="o">-</span> <span class="n">num</span><span class="o">-</span><span class="nl">threads</span><span class="p">:</span> <span class="mi">2</span>
<span class="o">+</span> <span class="n">num</span><span class="o">-</span><span class="nl">threads</span><span class="p">:</span> <span class="mi">1</span>

  <span class="cp"># specify the interfaces to answer queries from by ip-address.</span>
  <span class="cp"># The default is to listen to localhost (127.0.0.1 and ::1).</span>
<span class="p">@@</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">40</span><span class="p">,</span><span class="mi">8</span> <span class="p">@@</span>
  <span class="cp"># interface: 192.0.2.153</span>
  <span class="cp"># interface: 192.0.2.154</span>
  <span class="cp"># interface: 2001:DB8::5</span>
<span class="o">+</span> <span class="nl">interface</span><span class="p">:</span> <span class="mf">127.0.0.1</span>
<span class="o">+</span> <span class="nl">interface</span><span class="p">:</span> <span class="mf">192.168.11.103</span>
  <span class="cp">#</span>
  <span class="cp"># for dns over tls and raw dns over port 80</span>
  <span class="cp"># interface: 0.0.0.0@443</span>
<span class="p">@@</span> <span class="o">-</span><span class="mi">69</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">71</span><span class="p">,</span><span class="mi">10</span> <span class="p">@@</span>
  <span class="cp"># number of ports to allocate per thread, determines the size of the</span>
  <span class="cp"># port range that can be open simultaneously.</span>
  <span class="cp"># outgoing-range: 4096</span>
<span class="o">+</span> <span class="n">outgoing</span><span class="o">-</span><span class="nl">range</span><span class="p">:</span> <span class="mi">900</span>
<span class="o">+</span> <span class="err">#</span> <span class="nl">Note</span><span class="p">:</span> <span class="n">The</span> <span class="n">value</span> <span class="n">outgoing</span><span class="o">-</span><span class="n">range</span> <span class="n">was</span> <span class="n">set</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">the</span> <span class="n">warning</span> <span class="nl">below</span><span class="p">:</span>
<span class="o">+</span> <span class="err">#</span> <span class="n">unbound</span><span class="p">[</span><span class="mi">28716</span><span class="o">:</span><span class="mi">0</span><span class="p">]</span> <span class="nl">warning</span><span class="p">:</span> <span class="n">increased</span> <span class="n">limit</span><span class="p">(</span><span class="n">open</span> <span class="n">files</span><span class="p">)</span> <span class="n">from</span> <span class="mi">1024</span> <span class="n">to</span> <span class="mi">1080</span>
<span class="o">+</span> <span class="err">#</span> <span class="n">This</span> <span class="n">server</span> <span class="n">is</span> <span class="n">used</span> <span class="n">only</span> <span class="n">by</span> <span class="n">me</span><span class="p">,</span> <span class="n">so</span> <span class="n">a</span> <span class="n">small</span> <span class="n">value</span> <span class="n">should</span> <span class="n">be</span> <span class="n">OK</span><span class="p">.</span>

  <span class="cp"># permit unbound to use this port number or port range for</span>
  <span class="cp"># making outgoing queries, using an outgoing interface.</span>
<span class="p">@@</span> <span class="o">-</span><span class="mi">178</span><span class="p">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">184</span><span class="p">,</span><span class="mi">8</span> <span class="p">@@</span>
  <span class="cp"># access-control: ::0/0 refuse</span>
  <span class="cp"># access-control: ::1 allow</span>
  <span class="cp"># access-control: ::ffff:127.0.0.1 allow</span>
<span class="o">+</span> <span class="n">access</span><span class="o">-</span><span class="nl">control</span><span class="p">:</span> <span class="mf">127.0.0.0</span><span class="o">/</span><span class="mi">8</span> <span class="n">allow</span>
<span class="o">+</span> <span class="n">access</span><span class="o">-</span><span class="nl">control</span><span class="p">:</span> <span class="mf">192.168.11.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">allow</span>

  <span class="cp"># if given, a chroot(2) is done to the given directory.</span>
  <span class="cp"># i.e. you can chroot to the working directory, for example,</span>
</pre></div>


<ul>
<li>自宅サーバのCPUはシングルコアなのでnum-threadsは1にしました。</li>
<li>interfaceを0.0.0.0にしていないのは、KVMが別のネットワークインタフェースでdnsmaskでDNSのポート53を既に使っているためです。192.168.11.103はDNSサーバのアドレスです。</li>
<li>outgoing-rangeはopen filesの警告が出ないように下げてみました。どうせ使うのは私一人なので小さくてもいいだろうし。</li>
<li>access-controlはLAN内からのみ許可するようにしました。</li>
</ul>
<p>/etc/unbound/local.d/example.com.confにlocal-dataの設定を書きます。</p>
<div class="highlight"><pre><span></span>local-data: &quot;example.com A 192.168.11.103&quot;
</pre></div>


<p>あとは、iptablesでUDPのポート53を開けて、unboundのサービスを起動してchkconfigで自動起動をオンにすればOKです。</p>
<h2>クライアントの設定</h2>
<p>Linuxの場合は、
/etc/sysconfig/networkに</p>
<div class="highlight"><pre><span></span>DNS1=&quot;192.168.11.103&quot;
</pre></div>


<p>と書いて、以下のコマンドで反映します。</p>
<div class="highlight"><pre><span></span>service network restart
</pre></div>


<p>Macでは[システム環境設定]/[ネットワーク]→[詳細]ボタン→[DNS]タブで「192.168.11.103」を指定すれば設定出来ます。</p>
<p>が、iPhoneでDNSの設定が出来ないようなので(ちょっと試しただけで未調査)、どうせならルータ側で設定したいなーと思ったら、
<a href="http://matsh.jp/d/0365">ONU一体型ひかり電話ルータ PR-400KI のDNS設定 - matshのふらふら日記</a>
というブログ記事を見つけました。</p>
<p>[詳細設定]-[DNS設定]の[ローカルドメイン問合せテーブル]で、ドメイン名(ワイルドカード指定可能)に対してエントリを追加してドメイン毎にプライマリDNSサーバとセカンダリDNSサーバを登録できるようになっています。</p>
<p>ただし、サーバの指定がIPv6形式のみ受け付けるようになっています。IPv4射影アドレスをIPv6形式で指定すると解決するとのことでした。
<a href="http://kaworu.jpn.org/kaworu/2010-08-16-1.php">IPv6 IPv4射影アドレス とは</a></p>
<p>DNSサーバのIPv4アドレス192.168.11.103の各オクテットを16進数に変換すると
192→C0、168→A8、11→B、103→67となり、IPv4射影アドレスは
::FFFF:C0A8:B67
となりました。</p>
<p>これでMacでもiPhoneでもexample.comで参照できるようになりました。快適！</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>