<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Groonga on hnakamur&#39;s blog at github</title>
    <link>/blog/tags/groonga/</link>
    <description>Recent content in Groonga on hnakamur&#39;s blog at github</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-JP</language>
    <lastBuildDate>Sun, 26 Apr 2015 23:53:06 +0900</lastBuildDate>
    <atom:link href="/blog/tags/groonga/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Groongaのチュートリアルを試してみた</title>
      <link>/blog/2015/04/26/tried_groonga_tutorial/</link>
      <pubDate>Sun, 26 Apr 2015 23:53:06 +0900</pubDate>
      
      <guid>/blog/2015/04/26/tried_groonga_tutorial/</guid>
      <description>

&lt;p&gt;Groongaのチュートリアルを試してみたメモです。
試した環境は Groonga 5.0.2, Ubuntu 14.04.2 です。&lt;/p&gt;

&lt;h2 id=&#34;セットアップ手順:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;セットアップ手順&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://groonga.org/ja/docs/install/ubuntu.html#ppa-personal-package-archive&#34;&gt;2.4. Ubuntu — Groonga v5.0.2ドキュメント&lt;/a&gt;にそってセットアップしました。&lt;/p&gt;

&lt;p&gt;セットアップ手順は&lt;a href=&#34;https://github.com/hnakamur/groonga-dockerfiles/blob/b4d64e23eaf9afda47c31bc34794eb2e56b7614d/dockerfiles/trusty/Dockerfile&#34;&gt;Dockerfile&lt;/a&gt;にまとめておきました。&lt;/p&gt;

&lt;p&gt;さらにVirtualBox + VagrantでUbuntuにdockerとdocker-composeをインストールして、上のDockerfileでコンテナを作る手順を自動化するVagrantfileを作成して
&lt;a href=&#34;https://github.com/hnakamur/groonga-dockerfiles&#34;&gt;hnakamur/groonga-dockerfiles&lt;/a&gt;
で公開しています。&lt;/p&gt;

&lt;p&gt;VirtualBoxとVagrantをインストールしてあれば、以下の手順ですぐ試せます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;git clone https://github.com/hnakamur/groonga-dockerfiles
cd groonga-dockerfiles
vagrant up
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;起動後コンテナを作って起動するまでには結構時間がかかります。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ vagrant ssh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でVMにログインして、以下のようにCommandでgroonga-httpdが実行されたら起動完了です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cd /vagrant/dockerfiles
$ sudo docker-compose ps
      Name             Command             State              Ports
-------------------------------------------------------------------------
dockerfiles_groo   /usr/sbin          Up                 0.0.0.0:80-&amp;gt;1004
ngatrusty_1        /groonga-httpd                        1/tcp
                   -g ...
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;管理画面とgroongaコマンドの起動方法:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;管理画面とgroongaコマンドの起動方法&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://192.168.33.12/&#34;&gt;http://192.168.33.12/&lt;/a&gt; でgroongaの管理画面にアクセスできます。&lt;/p&gt;

&lt;p&gt;groongaコマンドの起動方法は以下の通りです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vagrant ssh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でVMにログインし、&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo docker exec -it dockerfiles_groongatrusty_1 /bin/bash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でコンテナ内に入り&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo -u groonga groonga /var/lib/groonga/db/db
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でgroongaコマンドを実行します。&lt;/p&gt;

&lt;h3 id=&#34;groongaコマンドの実行ユーザをrootにするとハマるので注意:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;groongaコマンドの実行ユーザをrootにするとハマるので注意&lt;/h3&gt;

&lt;p&gt;groongaコマンドはgroongaで実行するのが重要です。&lt;/p&gt;

&lt;p&gt;rootユーザで実行してしまうとエラーにはならないのですが、テーブルなどを作成してもgroongaの管理画面で表示されずハマりました。&lt;/p&gt;

&lt;p&gt;groongaのデータベースは最初は1つのファイルですが、テーブルなどを作るとファイルが追加で作成されます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;root@b95446c72160:/# cd /var/lib/groonga/db
root@b95446c72160:/var/lib/groonga/db# ll
total 15332
drwxr-xr-x 2 groonga groonga     4096 Apr 26 14:34 ./
drwxr-xr-x 3 groonga groonga     4096 Apr 26 01:49 ../
-rw-r--r-- 1 groonga groonga     4096 Apr 26 14:33 db
-rw-r--r-- 1 groonga groonga 21245952 Apr 26 14:33 db.0000000
-rw-r--r-- 1 groonga groonga 16842752 Apr 26 14:34 db.0000100
-rw-r--r-- 1 groonga groonga 12857344 Apr 26 14:26 db.0000101
-rw-r--r-- 1 groonga groonga  8437760 Apr 26 14:28 db.0000102
-rw-r--r-- 1 groonga groonga  1085440 Apr 26 14:28 db.0000103
-rw-r--r-- 1 groonga groonga  4198400 Apr 26 14:28 db.0000103.c
-rw-r--r-- 1 groonga groonga  8437760 Apr 26 14:34 db.0000104
-rw-r--r-- 1 groonga groonga  4198400 Apr 26 14:34 db.0000105
-rw-r--r-- 1 groonga groonga  1085440 Apr 26 14:34 db.0000106
-rw-r--r-- 1 groonga groonga  4198400 Apr 26 14:34 db.0000106.c
-rw-r--r-- 1 groonga groonga  1048576 Apr 26 14:34 db.001
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;rootユーザでgroongaコマンドを実行すると作成されたファイルの所有者がrootユーザになり、groonga-httpdから見えないようです。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;chown groonga: /var/lib/groonga/db/db*&lt;/code&gt; で所有者をgroongaユーザに変更すれば見えるようになりました。&lt;/p&gt;

&lt;p&gt;ということで、上記のようにgroongaユーザでgroongaコマンドを実行するのが良いです。&lt;/p&gt;

&lt;h2 id=&#34;チュートリアルの一部手順でエラーが出てハマった:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;チュートリアルの一部手順でエラーが出てハマった&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://groonga.org/ja/docs/tutorial.html&#34;&gt;4. チュートリアル — Groonga v5.0.2ドキュメント&lt;/a&gt;の手順で試してみました。ほとんどはすんなり実行できましたが、1箇所ハマりました。&lt;/p&gt;

&lt;h3 id=&#34;インデックス付きジオサーチのところでnonexistent-sourceというエラー:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;インデックス付きジオサーチのところでnonexistent sourceというエラー&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;http://groonga.org/ja/docs/tutorial/index.html#geo-location-search-with-index&#34;&gt;4.6.3. インデックス付きジオサーチ&lt;/a&gt;のところで以下の様なエラーが出ました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt; table_create --name GeoIndex --flags TABLE_PAT_KEY --key_type WGS84GeoPoint
[[0,1429178015.01179,0.00191092491149902],true]
&amp;gt; column_create --table GeoIndex --name index_point --type Site --flags COLUMN_INDEX --source location
[[-22,1429178020.73797,0.00554323196411133,&amp;quot;[column][create] nonexistent source: &amp;lt;location&amp;gt;&amp;quot;,[[&amp;quot;proc_column_create_resolve_source_name&amp;quot;,&amp;quot;proc.c&amp;quot;,1774]]],false]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Siteテーブルは&lt;a href=&#34;http://groonga.org/ja/docs/tutorial/introduction.html#create-a-table&#34;&gt;4.1.5. テーブルの作成&lt;/a&gt;で&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;table_create --name Site --flags TABLE_HASH_KEY --key_type ShortText
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;として作成していますが、その後 &lt;code&gt;location&lt;/code&gt; カラムを作る箇所がなかったようです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;column_create --table Site --name location --type WGS84GeoPoint
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のようにカラムを作成すれば大丈夫でした。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;table_create --name GeoIndex --flags TABLE_PAT_KEY --key_type WGS84GeoPoint
column_create --table GeoIndex --name index_point --type Site --flags COLUMN_INDEX --source location
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でインデクス用のテーブルとカラムを作成して、&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;load --table Site
[
 {&amp;quot;_key&amp;quot;:&amp;quot;http://example.org/&amp;quot;,&amp;quot;location&amp;quot;:&amp;quot;128452975x503157902&amp;quot;},
 {&amp;quot;_key&amp;quot;:&amp;quot;http://example.net/&amp;quot;,&amp;quot;location&amp;quot;:&amp;quot;128487316x502920929&amp;quot;}
]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で、データをロードします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt; select --table Site --filter &#39;geo_in_circle(location, &amp;quot;128515259x503187188&amp;quot;, 5000)&#39; --output_columns _key,location
[[0,1430061299.24235,0.00105690956115723],[[[1],[[&amp;quot;_key&amp;quot;,&amp;quot;ShortText&amp;quot;],[&amp;quot;location&amp;quot;,&amp;quot;WGS84GeoPoint&amp;quot;]],[&amp;quot;http://example.org/&amp;quot;,&amp;quot;128452975x503157902&amp;quot;]]]]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で検索できました。&lt;/p&gt;

&lt;h2 id=&#34;まとめ:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;2箇所ハマりましたが解決してとりあえず使えるようになりました。今後さらに調査していきたいと思います。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>