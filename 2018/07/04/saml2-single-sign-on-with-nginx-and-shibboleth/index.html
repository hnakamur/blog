<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.98.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>nginxとshibbolethでSAML2のシングルサインオンを試してみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2022. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>nginxとshibbolethでSAML2のシングルサインオンを試してみた</h1>
  <time datetime=2018-07-04T16:40:00&#43;0900 class="post-date">2018-07-04</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#nginx-http-shibbolethモジュール">nginx-http-shibbolethモジュール</a></li>
    <li><a href="#fastcgiサポートを有効にしたshibboleth-sp">FastCGIサポートを有効にしたShibboleth SP</a></li>
    <li><a href="#xml-security-c">xml-security-c</a></li>
  </ul>

  <ul>
    <li><a href="#shibbolethのsp用設定">ShibbolethのSP用設定</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#nginxの設定">nginxの設定</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#samlrequestの確認">SAMLRequestの確認</a></li>
    <li><a href="#samlresponseの確認">SAMLResponseの確認</a></li>
    <li><a href="#認証後にバックエンドに送られるリクエストヘッダ">認証後にバックエンドに送られるリクエストヘッダ</a></li>
    <li><a href="#ログアウトの動作確認">ログアウトの動作確認</a></li>
  </ul>
</nav>
  <h1 id="はじめに">はじめに</h1>
<p>勤務先でSAML2のシングルサインオンについて調査していたところ
<a href="https://github.com/nginx-shib/nginx-http-shibboleth/issues/16">Is this module compatible with SAML 2 in HTTP POST mode? · Issue #16 · nginx-shib/nginx-http-shibboleth</a>
というイシューを見つけました。
この nginx-http-shibboleth というモジュールを使えば実現できそうということで、
nginxとshibbolethでSAML2のシングルサインオンを試してみたメモです。</p>
<p>なお、とりあえず試してみただけで、セキュリティ上問題無い設定になっているかは未確認なのでご注意ください。</p>
<p>SAML認証についての概要は
<a href="https://qiita.com/khsk/items/10a136bded197272094a">SAML認証を勉強せずに理解したい私から勉強せずに理解したい私へ - Qiita</a>
で紹介されていた
<a href="http://blog.cybozu.io/entry/4224">SAML認証ができるまで - Cybozu Inside Out | サイボウズエンジニアのブログ</a>
がわかりやすかったです。</p>
<p>登場人物とサービスは以下の3つです。</p>
<ul>
<li>エンドユーザ</li>
<li>実際に認証を行う Identity Provider (IdP)</li>
<li>IdPを利用してサービスを提供する Service Provider (SP)</li>
</ul>
<p>今回はIdPは勤務先で用意されたテスト用のIdPを使いつつ、SPをnginxと <a href="https://www.internet2.edu/products-services/trust-identity/shibboleth/">Shibboleth</a> でCentOS7上で構築してみました。</p>
<p>ShibbolethについてはWikipediaの
<a href="https://ja.wikipedia.org/wiki/%E3%82%B7%E3%83%9C%E3%83%AC%E3%82%B9">シボレス - Wikipedia</a>
のページがわかりやすかったです。</p>
<h1 id="自作rpmパッケージ作成">自作rpmパッケージ作成</h1>
<p>nginx以外に以下のソフトウェアが必要になるので、自作rpmパッケージを作りました。</p>
<h2 id="nginx-http-shibbolethモジュール">nginx-http-shibbolethモジュール</h2>
<p>nginxからShibbolethに連携して認証を行うために
<a href="https://github.com/nginx-shib/nginx-http-shibboleth">nginx-shib/nginx-http-shibboleth: Shibboleth auth request module for nginx</a>
というモジュールを使うので、いつも利用しているnginxの自作rpm
<a href="https://copr.fedorainfracloud.org/coprs/hnakamur/nginx/">hnakamur/nginx Copr</a>
にこのモジュールを追加してビルドしました。</p>
<p>なお
<a href="https://github.com/nginx-shib/nginx-http-shibboleth">nginx-shib/nginx-http-shibboleth</a> が依存している
<a href="https://github.com/openresty/headers-more-nginx-module">openresty/headers-more-nginx-module</a> も必要ですが、これは既に自作rpmに含めていました。</p>
<h2 id="fastcgiサポートを有効にしたshibboleth-sp">FastCGIサポートを有効にしたShibboleth SP</h2>
<p><a href="https://github.com/nginx-shib/nginx-http-shibboleth/blob/master/CONFIG.rst#shibboleth-sp-with-fastcgi-support">Shibboleth SP with FastCGI Support</a> に説明があります。DebianとUbuntuでは shibboleth-sp-utils パッケージがFastCGIサポートを有効にしてビルドされていますが、CentOS 7で使うShibolleth公式レポジトリのrpmパッケージではFastCGIサポートが無効なので、有効にしたものを自分でビルドする必要があります。</p>
<p><a href="https://github.com/nginx-shib/shibboleth-fastcgi">nginx-shib/shibboleth-fastcgi</a> にFastCGIサポートを有効にしてrpmをビルドするための説明がありますので、これを参考にして自作rpmをビルドしました。</p>
<ul>
<li>FastCGIサポート有りのShibbolethの自作rpmのレポジトリ <a href="https://copr.fedorainfracloud.org/coprs/hnakamur/shibboleth/">hnakamur/shibboleth Copr</a></li>
<li>上記のrpmのソース <a href="https://github.com/hnakamur/shibboleth-fastcgi-rpm">hnakamur/shibboleth-fastcgi-rpm</a></li>
</ul>
<p>shibbolethのrpmをインストールすると <code>shibd</code> というサービスが追加されるのですが、FastCGIを有効にするとさらに <code>shibauthorizer</code> と <code>shibresponder</code> という2つのサービスが追加されます。</p>
<p>この2つを <a href="http://supervisord.org/">Supervisor (supervisord)</a> でFastCGIとして実行するための設定が
<a href="https://github.com/nginx-shib/nginx-http-shibboleth/blob/master/CONFIG.rst#running-the-fastcgi-authorizer-and-responder">Running the FastCGI authorizer and responder</a>
に書かれています。</p>
<p>今回はCentOS 7ということでsystemdを使ってFastCGIとして実行するようにしました。この方法は今回初めて知ったのでメモしておきます。</p>
<p><a href="https://redmine.lighttpd.net/projects/spawn-fcgi/wiki/Systemd">Systemd - spawn-fcgi - lighty labs</a>
と
<a href="https://gist.github.com/stbuehler/439a9849747279a1f0a9#gistcomment-1950602">systemd to FastCGI socket passing compatibility script</a>
を参考にして以下のようにsystemd用の <code>.socket</code> ファイルと <code>.service</code> を作りました。</p>
<p><code>/lib/systemd/system/shibauthorizer.socket</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">[Unit]
</span></span><span class="line"><span class="cl">Description=shibauthorizer socket
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Socket]
</span></span><span class="line"><span class="cl">SocketUser=shibd
</span></span><span class="line"><span class="cl">SocketGroup=shibd
</span></span><span class="line"><span class="cl">SocketMode=0660
</span></span><span class="line"><span class="cl">ListenStream=/run/shibboleth/shibauthorizer.sock
</span></span><span class="line"><span class="cl">Accept=false
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Install]
</span></span><span class="line"><span class="cl">WantedBy=sockets.target
</span></span></code></pre></div><p><code>/lib/systemd/system/shibauthorizer.service</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">[Unit]
</span></span><span class="line"><span class="cl">Description=shibauthorizer
</span></span><span class="line"><span class="cl">After=network.target
</span></span><span class="line"><span class="cl">Requires=shibauthorizer.socket
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Service]
</span></span><span class="line"><span class="cl">Type=simple
</span></span><span class="line"><span class="cl">ExecStart=/usr/lib64/shibboleth/shibauthorizer
</span></span><span class="line"><span class="cl">User=shibd
</span></span><span class="line"><span class="cl">Group=shibd
</span></span><span class="line"><span class="cl">StandardInput=socket
</span></span><span class="line"><span class="cl">StandardOutput=journal
</span></span><span class="line"><span class="cl">StandardError=journal
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Install]
</span></span><span class="line"><span class="cl">WantedBy=multi-user.target
</span></span></code></pre></div><p><code>.socket</code> ファイルの <code>ListenStream</code> でUnixドメインソケットを作成し、 <code>.service</code> ファイルで <code>StandardInput=socket</code> と指定することでそこから入力を読み取るというわけです。</p>
<p>上記の2つは <code>shibauthorizer</code> 用ですが、 <code>shibresponder</code> 用にも同様に2つ作りました。</p>
<h2 id="xml-security-c">xml-security-c</h2>
<p>Shibbolethのrpmをビルドするための <code>shibboleth.spec</code> ファイルに</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">BuildRequires:  libxml-security-c-devel &gt;= 1.7.3
</span></span></code></pre></div><p>という
<a href="https://github.com/hnakamur/shibboleth-fastcgi-rpm/blob/3952b09f2670f13ac343210eeb9580ce83d36e07/SPECS/shibboleth.spec#L31">行</a>
があり、 <code>libxml-security-c-devel</code> というパッケージに依存していることがわかりました。</p>
<p>yumでインストールしようとしたのですが、これはCentOS 7の標準レポジトリやepelにはありませんでした。
検索してみつけた
<a href="http://linuxsoft.cern.ch/cern/centos/7/cern/x86_64/repoview/libxml-security-c-devel.html">Linux @ CERN: /cern/centos/7/cern/x86_64/repoview/libxml-security-c-devel.html</a>
によると CentOS CERN 7 (CC7) という別のディストリビューションには入っているようです。</p>
<p><a href="http://linux.web.cern.ch/linux/centos7/">CC7: CERN CentOS 7</a> を見たところ、CentOS 7用の追加レポジトリというよりは、カスタム版の別ディストリビューションのようなので、これに依存するよりはrpmをリビルドして使うほうが良いと考えてCoprでビルドしました。</p>
<ul>
<li>xml-security-cの自作rpmのレポジトリ <a href="https://copr.fedorainfracloud.org/coprs/hnakamur/xml-security-c/">hnakamur/xml-security-c Copr</a></li>
<li>xml-security-cの自作rpmのソース <a href="https://github.com/hnakamur/xml-security-c-rpm">hnakamur/xml-security-c-rpm</a></li>
</ul>
<h1 id="インストール手順">インストール手順</h1>
<p>上記の自作rpmに加えて <code>xmltooling-schemas</code> と <code>opensaml-schemas</code> パッケージをインストールするためにShibbolethのレポジトリを追加する必要があります。</p>
<p><a href="https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPLinuxRPMInstall">NativeSPLinuxRPMInstall - Shibboleth 2 - Shibboleth Wiki</a> にrpmのインストール手順が書いてあるのですが、それとは別に
<a href="https://github.com/nginx-shib/shibboleth-fastcgi">nginx-shib/shibboleth-fastcgi</a> レポジトリに
以下のような <a href="https://github.com/nginx-shib/shibboleth-fastcgi/blob/master/configs/centos-7/shibboleth.repo">shibboleth.repo</a> ファイルがあったので、これを使わせてもらうことにしました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">[shibboleth]
</span></span><span class="line"><span class="cl">name=Shibboleth (CentOS_7)
</span></span><span class="line"><span class="cl"># Please report any problems to https://issues.shibboleth.net
</span></span><span class="line"><span class="cl">type=rpm-md
</span></span><span class="line"><span class="cl">mirrorlist=https://shibboleth.net/cgi-bin/mirrorlist.cgi/CentOS_7
</span></span><span class="line"><span class="cl">gpgcheck=1
</span></span><span class="line"><span class="cl">gpgkey=https://downloadcontent.opensuse.org/repositories/security:/shibboleth/CentOS_7/repodata/repomd.xml.key
</span></span><span class="line"><span class="cl">enabled=1
</span></span></code></pre></div><p>以下のコマンドを実行して必要なレポジトリを追加します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo curl -sSL -o /etc/yum.repos.d/shibboleth.repo https://raw.githubusercontent.com/nginx-shib/shibboleth-fastcgi/master/configs/centos-7/shibboleth.repo
</span></span></span><span class="line"><span class="cl"><span class="go">sudo curl -sSL -o /etc/yum.repos.d/hnakamur-nginx-epel-7.repo https://copr.fedorainfracloud.org/coprs/hnakamur/nginx/repo/epel-7/hnakamur-nginx-epel-7.repo
</span></span></span><span class="line"><span class="cl"><span class="go">sudo curl -sSL -o /etc/yum.repos.d/hnakamur-xml-security-c-epel-7.repo https://copr.fedorainfracloud.org/coprs/hnakamur/xml-security-c/repo/epel-7/hnakamur-xml-security-c-epel-7.repo
</span></span></span><span class="line"><span class="cl"><span class="go">sudo curl -sSL -o /etc/yum.repos.d/hnakamur-shibboleth-epel-7.repo https://copr.fedorainfracloud.org/coprs/hnakamur/shibboleth/repo/epel-7/hnakamur-shibboleth-epel-7.repo
</span></span></span></code></pre></div><p>以下のコマンドを実行して必要なrpmをインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo yum install nginx shibboleth xmltooling-schemas opensaml-schemas
</span></span></span></code></pre></div><p>2018-07-13 追記。
<code>nginx</code> ユーザが <code>/run/shibboleth/shibauthorizer.socket</code> と <code>/run/shibboleth/shibresponder.socket</code> に読み書きできるようにするため、 <code>shibd</code> グループに <code>nginx</code> ユーザを追加します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo usermod -a -G shibd nginx
</span></span></span></code></pre></div><h1 id="設定ファイルの編集">設定ファイルの編集</h1>
<h2 id="shibbolethのsp用設定">ShibbolethのSP用設定</h2>
<p>ShibbolethのSP用の設定については
<a href="https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPConfiguration">NativeSPConfiguration - Shibboleth 2 - Shibboleth Wiki</a>
にドキュメントがあります。</p>
<p>量が多くて読むのが大変なので、私はまだ必要なところだけを拾い読みしただけの状態です。</p>
<h4 id="idpのメタデータのxml">IdPのメタデータのXML</h4>
<p>SAMLのメタデータについては
<a href="https://docs.oasis-open.org/security/saml/v2.0/saml-metadata-2.0-os.pdf">Metadata for the OASIS Security Assertion Markup Language (SAML) V2.0</a>
が1次情報のドキュメントのようです（検索して見つけたのでリンク元は不明）。</p>
<p>今回は社内で教えてもらった
<a href="https://www.samltool.com/idp_metadata.php">SAML Identity Provider (IdP) XML Metadata Builder | SAMLTool.com</a>
というオンラインのツールを使いました。</p>
<p>この後は以下の構成例で説明します。</p>
<ul>
<li>IdPのエンティティID: <a href="https://idp.example.com/sso-test/idp">https://idp.example.com/sso-test/idp</a></li>
<li>HTTPリダイレクト先のシングルサインオンのエンドポイント: <a href="https://idp.example.com/sso-test/idp/sso_redirect">https://idp.example.com/sso-test/idp/sso_redirect</a></li>
<li>署名と暗号化に使う証明書:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">-----BEGIN CERTIFICATE-----
</span></span><span class="line"><span class="cl">MIIxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</span></span><span class="line"><span class="cl">…（略）…
</span></span><span class="line"><span class="cl">xxxxxxxxxxxxxxxxxxxTow==
</span></span><span class="line"><span class="cl">-----END CERTIFICATE-----
</span></span></code></pre></div><p>上記の項目を入力して &ldquo;BUILD IDP METADATA&rdquo; ボタンを押すとページの下の方に以下のようなXMLが出力されました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;md:EntityDescriptor</span> <span class="na">xmlns:md=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:metadata&#34;</span> <span class="na">validUntil=</span><span class="s">&#34;2018-06-30T08:00:05Z&#34;</span> <span class="na">cacheDuration=</span><span class="s">&#34;PT1530777605S&#34;</span> <span class="na">entityID=</span><span class="s">&#34;https://idp.example.com/sso-test/idp&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;md:IDPSSODescriptor</span> <span class="na">WantAuthnRequestsSigned=</span><span class="s">&#34;false&#34;</span> <span class="na">protocolSupportEnumeration=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:protocol&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;md:KeyDescriptor</span> <span class="na">use=</span><span class="s">&#34;signing&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ds:KeyInfo</span> <span class="na">xmlns:ds=</span><span class="s">&#34;http://www.w3.org/2000/09/xmldsig#&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;ds:X509Data&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;ds:X509Certificate&gt;</span>MIIxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx…（略）…xxxxxxxxxxxxxxxxxxxTow==<span class="nt">&lt;/ds:X509Certificate&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/ds:X509Data&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/ds:KeyInfo&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/md:KeyDescriptor&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;md:KeyDescriptor</span> <span class="na">use=</span><span class="s">&#34;encryption&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ds:KeyInfo</span> <span class="na">xmlns:ds=</span><span class="s">&#34;http://www.w3.org/2000/09/xmldsig#&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;ds:X509Data&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;ds:X509Certificate&gt;</span>MIIxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx…（略）…xxxxxxxxxxxxxxxxxxxTow==<span class="nt">&lt;/ds:X509Certificate&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/ds:X509Data&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/ds:KeyInfo&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/md:KeyDescriptor&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;md:NameIDFormat&gt;</span>urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified<span class="nt">&lt;/md:NameIDFormat&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;md:SingleSignOnService</span> <span class="na">Binding=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-Redirect&#34;</span> <span class="na">Location=</span><span class="s">&#34;https://idp.example.com/sso-test/idp/sso_redirect&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/md:IDPSSODescriptor&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/md:EntityDescriptor&gt;</span>
</span></span></code></pre></div><p><code>&lt;ds:X509Certificate&gt;</code> の値は証明書の
<code>-----BEGIN CERTIFICATE-----</code> と
<code>-----END CERTIFICATE-----</code> の間の行が連結されたものになっていました。</p>
<p>ちょっと脱線しますが、これで週末動作確認した後、週明けに再度確認したらエラーが起きるようになってしまいました。これは上記の <code>validUntil</code> の日付を過ぎていたのでこのメタデータが無効として扱われたからとわかりました。</p>
<p><a href="https://docs.oasis-open.org/security/saml/v2.0/saml-metadata-2.0-os.pdf">Metadata for the OASIS Security Assertion Markup Language (SAML) V2.0</a>
によると <code>validUntil</code> と <code>cacheDuration</code> はともに省略可能とのことなので、最終的には省略することにしました。</p>
<p>これを <code>/etc/shibboleth/idp-metadata.xml</code> というファイル名で保存しました。</p>
<h4 id="アトリビュートのマッピングのxml">アトリビュートのマッピングのXML</h4>
<p>当初IdPで認証通った後にアトリビュートは何も返さない設定になっていたのですが、認証後のページに以下のようなエラーが表示されたので、 <code>mail</code> という名前でメールアドレスをアトリビュートとして返してもらうように設定してもらいました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">xmltooling::ValidationException
</span></span><span class="line"><span class="cl">The system encountered an error at Fri Jun 29 02:08:20 2018
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To report this problem, please contact the site administrator at hnakamur@localhost.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Please include the following message in any email:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">xmltooling::ValidationException at (http://localhost/Shibboleth.sso/SAML2/POST)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">AttributeStatement must have at least one child element.
</span></span></code></pre></div><p>その後 <a href="https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPAddAttribute">NativeSPAddAttribute - Shibboleth 2 - Shibboleth Wiki</a> を読みつつ
<code>/etc/shibboleth/attribute-map.xml</code> というファイルを以下のように編集しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;Attributes</span> <span class="na">xmlns=</span><span class="s">&#34;urn:mace:shibboleth:2.0:attribute-map&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Attribute</span> <span class="na">name=</span><span class="s">&#34;mail&#34;</span> <span class="na">id=</span><span class="s">&#34;mail&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Attributes&gt;</span>
</span></span></code></pre></div><h4 id="shibbolethのメイン設定のxml">Shibbolethのメイン設定のXML</h4>
<p>上記のIdPの設定項目の例に加えて、SPの設定項目として以下の例で説明します。</p>
<ul>
<li>SPの管理者のメールアドレス: <a href="mailto:admin@sp.example.org">admin@sp.example.org</a></li>
<li>SPのエンティティID: <a href="https://sp.example.org/sso">https://sp.example.org/sso</a></li>
</ul>
<p>なお、SPでは証明書を使わない構成とし、SPのエンティティIDをIdPの管理者にお願いして登録してもらいました。</p>
<p><code>/etc/shibboleth/shibboleth2.xml</code> を以下のように変更しました。</p>
<p>下記の変更内容は以下のコマンドで表示しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">diff -u shibboleth-sp-2.6.1/configs/shibboleth2.xml shibboleth2.xml
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gd">--- shibboleth-sp-2.6.1/configs/shibboleth2.xml        2017-11-14 08:29:46.000000000 +0900
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ shibboleth2.xml        2018-07-04 10:12:32.283184405 +0900
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -19,8 +19,19 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>     file, and the https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPRequestMapHowTo topic.
</span></span><span class="line"><span class="cl">     --&gt;
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gi">+    &lt;RequestMapper type=&#34;XML&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi">+        &lt;RequestMap&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi">+            &lt;Host name=&#34;localhost&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi">+                  authType=&#34;shibboleth&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi">+                  requireSession=&#34;true&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi">+                  redirectToSSL=&#34;443&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi">+                &lt;Path name=&#34;/secure&#34; /&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi">+            &lt;/Host&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi">+        &lt;/RequestMap&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi">+    &lt;/RequestMapper&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>     &lt;!-- The ApplicationDefaults element is where most of Shibboleth&#39;s SAML bits are defined. --&gt;
</span></span><span class="line"><span class="cl"><span class="gd">-    &lt;ApplicationDefaults entityID=&#34;https://sp.example.org/shibboleth&#34;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+    &lt;ApplicationDefaults entityID=&#34;https://sp.example.org/sso&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>                          REMOTE_USER=&#34;eppn persistent-id targeted-id&#34;&gt;
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">         &lt;!--
</span></span><span class="line"><span class="cl"><span class="gu">@@ -35,14 +46,7 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>         &lt;Sessions lifetime=&#34;28800&#34; timeout=&#34;3600&#34; relayState=&#34;ss:mem&#34;
</span></span><span class="line"><span class="cl">                   checkAddress=&#34;false&#34; handlerSSL=&#34;false&#34; cookieProps=&#34;http&#34;&gt;
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gd">-            &lt;!--
</span></span></span><span class="line"><span class="cl"><span class="gd">-            Configures SSO for a default IdP. To allow for &gt;1 IdP, remove
</span></span></span><span class="line"><span class="cl"><span class="gd">-            entityID property and adjust discoveryURL to point to discovery service.
</span></span></span><span class="line"><span class="cl"><span class="gd">-            (Set discoveryProtocol to &#34;WAYF&#34; for legacy Shibboleth WAYF support.)
</span></span></span><span class="line"><span class="cl"><span class="gd">-            You can also override entityID on /Login query string, or in RequestMap/htaccess.
</span></span></span><span class="line"><span class="cl"><span class="gd">-            --&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-            &lt;SSO entityID=&#34;https://idp.example.org/idp/shibboleth&#34;
</span></span></span><span class="line"><span class="cl"><span class="gd">-                 discoveryProtocol=&#34;SAMLDS&#34; discoveryURL=&#34;https://ds.example.org/DS/WAYF&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+                  &lt;SSO entityID=&#34;https://idp.example.com/sso-test/idp&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>               SAML2 SAML1
</span></span><span class="line"><span class="cl">             &lt;/SSO&gt;
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gu">@@ -66,53 +70,16 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>         Allows overriding of error template information/filenames. You can
</span></span><span class="line"><span class="cl">         also add attributes with values that can be plugged into the templates.
</span></span><span class="line"><span class="cl">         --&gt;
</span></span><span class="line"><span class="cl"><span class="gd">-        &lt;Errors supportContact=&#34;root@localhost&#34;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+        &lt;Errors supportContact=&#34;admin@sp.example.org&#34;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>             helpLocation=&#34;/about.html&#34;
</span></span><span class="line"><span class="cl">             styleSheet=&#34;/shibboleth-sp/main.css&#34;/&gt;
</span></span><span class="line"><span class="cl"><span class="gd">-        
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;!-- Example of remotely supplied batch of signed metadata. --&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;!--
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;MetadataProvider type=&#34;XML&#34; validate=&#34;true&#34;
</span></span></span><span class="line"><span class="cl"><span class="gd">-              uri=&#34;http://example.org/federation-metadata.xml&#34;
</span></span></span><span class="line"><span class="cl"><span class="gd">-              backingFilePath=&#34;federation-metadata.xml&#34; reloadInterval=&#34;7200&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-            &lt;MetadataFilter type=&#34;RequireValidUntil&#34; maxValidityInterval=&#34;2419200&#34;/&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-            &lt;MetadataFilter type=&#34;Signature&#34; certificate=&#34;fedsigner.pem&#34;/&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-            &lt;DiscoveryFilter type=&#34;Blacklist&#34; matcher=&#34;EntityAttributes&#34; trimTags=&#34;true&#34; 
</span></span></span><span class="line"><span class="cl"><span class="gd">-              attributeName=&#34;http://macedir.org/entity-category&#34;
</span></span></span><span class="line"><span class="cl"><span class="gd">-              attributeNameFormat=&#34;urn:oasis:names:tc:SAML:2.0:attrname-format:uri&#34;
</span></span></span><span class="line"><span class="cl"><span class="gd">-              attributeValue=&#34;http://refeds.org/category/hide-from-discovery&#34; /&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;/MetadataProvider&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-        --&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span> 
</span></span><span class="line"><span class="cl">         &lt;!-- Example of locally maintained metadata. --&gt;
</span></span><span class="line"><span class="cl"><span class="gd">-        &lt;!--
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;MetadataProvider type=&#34;XML&#34; validate=&#34;true&#34; file=&#34;partner-metadata.xml&#34;/&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-        --&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+        &lt;MetadataProvider type=&#34;XML&#34; validate=&#34;true&#34; file=&#34;idp-metadata.xml&#34;/&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> 
</span></span><span class="line"><span class="cl">         &lt;!-- Map to extract attributes from SAML assertions. --&gt;
</span></span><span class="line"><span class="cl">         &lt;AttributeExtractor type=&#34;XML&#34; validate=&#34;true&#34; reloadChanges=&#34;false&#34; path=&#34;attribute-map.xml&#34;/&gt;
</span></span><span class="line"><span class="cl"><span class="gd">-        
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;!-- Use a SAML query if no attributes are supplied during SSO. --&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;AttributeResolver type=&#34;Query&#34; subjectMatch=&#34;true&#34;/&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;!-- Default filtering policy for recognized attributes, lets other data pass. --&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;AttributeFilter type=&#34;XML&#34; validate=&#34;true&#34; path=&#34;attribute-policy.xml&#34;/&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span> 
</span></span><span class="line"><span class="cl"><span class="gd">-        &lt;!-- Simple file-based resolver for using a single keypair. --&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;CredentialResolver type=&#34;File&#34; key=&#34;sp-key.pem&#34; certificate=&#34;sp-cert.pem&#34;/&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;!--
</span></span></span><span class="line"><span class="cl"><span class="gd">-        The default settings can be overridden by creating ApplicationOverride elements (see
</span></span></span><span class="line"><span class="cl"><span class="gd">-        the https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPApplicationOverride topic).
</span></span></span><span class="line"><span class="cl"><span class="gd">-        Resource requests are mapped by web server commands, or the RequestMapper, to an
</span></span></span><span class="line"><span class="cl"><span class="gd">-        applicationId setting.
</span></span></span><span class="line"><span class="cl"><span class="gd">-        
</span></span></span><span class="line"><span class="cl"><span class="gd">-        Example of a second application (for a second vhost) that has a different entityID.
</span></span></span><span class="line"><span class="cl"><span class="gd">-        Resources on the vhost would map to an applicationId of &#34;admin&#34;:
</span></span></span><span class="line"><span class="cl"><span class="gd">-        --&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;!--
</span></span></span><span class="line"><span class="cl"><span class="gd">-        &lt;ApplicationOverride id=&#34;admin&#34; entityID=&#34;https://admin.example.org/shibboleth&#34;/&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-        --&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>     &lt;/ApplicationDefaults&gt;
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl">     &lt;!-- Policies that determine how to process and authenticate runtime messages. --&gt;
</span></span></code></pre></div><p>変更後の <code>/etc/shibboleth/shibboleth2.xml</code> 全体は以下のとおりです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;SPConfig</span> <span class="na">xmlns=</span><span class="s">&#34;urn:mace:shibboleth:2.0:native:sp:config&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">xmlns:conf=</span><span class="s">&#34;urn:mace:shibboleth:2.0:native:sp:config&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">xmlns:saml=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:assertion&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">xmlns:samlp=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:protocol&#34;</span>    
</span></span><span class="line"><span class="cl">    <span class="na">xmlns:md=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:metadata&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="na">clockSkew=</span><span class="s">&#34;180&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--
</span></span></span><span class="line"><span class="cl"><span class="c">    By default, in-memory StorageService, ReplayCache, ArtifactMap, and SessionCache
</span></span></span><span class="line"><span class="cl"><span class="c">    are used. See example-shibboleth2.xml for samples of explicitly configuring them.
</span></span></span><span class="line"><span class="cl"><span class="c">    --&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!--
</span></span></span><span class="line"><span class="cl"><span class="c">    To customize behavior for specific resources on Apache, and to link vhosts or
</span></span></span><span class="line"><span class="cl"><span class="c">    resources to ApplicationOverride settings below, use web server options/commands.
</span></span></span><span class="line"><span class="cl"><span class="c">    See https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPConfigurationElements for help.
</span></span></span><span class="line"><span class="cl"><span class="c">    
</span></span></span><span class="line"><span class="cl"><span class="c">    For examples with the RequestMap XML syntax instead, see the example-shibboleth2.xml
</span></span></span><span class="line"><span class="cl"><span class="c">    file, and the https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPRequestMapHowTo topic.
</span></span></span><span class="line"><span class="cl"><span class="c">    --&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;RequestMapper</span> <span class="na">type=</span><span class="s">&#34;XML&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;RequestMap&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;Host</span> <span class="na">name=</span><span class="s">&#34;localhost&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="na">authType=</span><span class="s">&#34;shibboleth&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="na">requireSession=</span><span class="s">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="na">redirectToSSL=</span><span class="s">&#34;443&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&lt;Path</span> <span class="na">name=</span><span class="s">&#34;/secure&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/Host&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/RequestMap&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/RequestMapper&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- The ApplicationDefaults element is where most of Shibboleth&#39;s SAML bits are defined. --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ApplicationDefaults</span> <span class="na">entityID=</span><span class="s">&#34;https://sp.example.org/sso&#34;</span>
</span></span><span class="line"><span class="cl">                         <span class="na">REMOTE_USER=</span><span class="s">&#34;eppn persistent-id targeted-id&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--
</span></span></span><span class="line"><span class="cl"><span class="c">        Controls session lifetimes, address checks, cookie handling, and the protocol handlers.
</span></span></span><span class="line"><span class="cl"><span class="c">        You MUST supply an effectively unique handlerURL value for each of your applications.
</span></span></span><span class="line"><span class="cl"><span class="c">        The value defaults to /Shibboleth.sso, and should be a relative path, with the SP computing
</span></span></span><span class="line"><span class="cl"><span class="c">        a relative value based on the virtual host. Using handlerSSL=&#34;true&#34;, the default, will force
</span></span></span><span class="line"><span class="cl"><span class="c">        the protocol to be https. You should also set cookieProps to &#34;https&#34; for SSL-only sites.
</span></span></span><span class="line"><span class="cl"><span class="c">        Note that while we default checkAddress to &#34;false&#34;, this has a negative impact on the
</span></span></span><span class="line"><span class="cl"><span class="c">        security of your site. Stealing sessions via cookie theft is much easier with this disabled.
</span></span></span><span class="line"><span class="cl"><span class="c">        --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;Sessions</span> <span class="na">lifetime=</span><span class="s">&#34;28800&#34;</span> <span class="na">timeout=</span><span class="s">&#34;3600&#34;</span> <span class="na">relayState=</span><span class="s">&#34;ss:mem&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="na">checkAddress=</span><span class="s">&#34;false&#34;</span> <span class="na">handlerSSL=</span><span class="s">&#34;false&#34;</span> <span class="na">cookieProps=</span><span class="s">&#34;http&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                  <span class="nt">&lt;SSO</span> <span class="na">entityID=</span><span class="s">&#34;https://idp.example.com/sso-test/idp&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">              SAML2 SAML1
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;/SSO&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!-- SAML and local-only logout. --&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;Logout&gt;</span>SAML2 Local<span class="nt">&lt;/Logout&gt;</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!-- Extension service that generates &#34;approximate&#34; metadata based on SP configuration. --&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&#34;MetadataGenerator&#34;</span> <span class="na">Location=</span><span class="s">&#34;/Metadata&#34;</span> <span class="na">signing=</span><span class="s">&#34;false&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!-- Status reporting service. --&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&#34;Status&#34;</span> <span class="na">Location=</span><span class="s">&#34;/Status&#34;</span> <span class="na">acl=</span><span class="s">&#34;127.0.0.1 ::1&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!-- Session diagnostic service. --&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&#34;Session&#34;</span> <span class="na">Location=</span><span class="s">&#34;/Session&#34;</span> <span class="na">showAttributeValues=</span><span class="s">&#34;false&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c">&lt;!-- JSON feed of discovery information. --&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&lt;Handler</span> <span class="na">type=</span><span class="s">&#34;DiscoveryFeed&#34;</span> <span class="na">Location=</span><span class="s">&#34;/DiscoFeed&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/Sessions&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!--
</span></span></span><span class="line"><span class="cl"><span class="c">        Allows overriding of error template information/filenames. You can
</span></span></span><span class="line"><span class="cl"><span class="c">        also add attributes with values that can be plugged into the templates.
</span></span></span><span class="line"><span class="cl"><span class="c">        --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;Errors</span> <span class="na">supportContact=</span><span class="s">&#34;admin@sp.example.org&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="na">helpLocation=</span><span class="s">&#34;/about.html&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="na">styleSheet=</span><span class="s">&#34;/shibboleth-sp/main.css&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Example of locally maintained metadata. --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;MetadataProvider</span> <span class="na">type=</span><span class="s">&#34;XML&#34;</span> <span class="na">validate=</span><span class="s">&#34;true&#34;</span> <span class="na">file=</span><span class="s">&#34;idp-metadata.xml&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c">&lt;!-- Map to extract attributes from SAML assertions. --&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;AttributeExtractor</span> <span class="na">type=</span><span class="s">&#34;XML&#34;</span> <span class="na">validate=</span><span class="s">&#34;true&#34;</span> <span class="na">reloadChanges=</span><span class="s">&#34;false&#34;</span> <span class="na">path=</span><span class="s">&#34;attribute-map.xml&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/ApplicationDefaults&gt;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- Policies that determine how to process and authenticate runtime messages. --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;SecurityPolicyProvider</span> <span class="na">type=</span><span class="s">&#34;XML&#34;</span> <span class="na">validate=</span><span class="s">&#34;true&#34;</span> <span class="na">path=</span><span class="s">&#34;security-policy.xml&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c">&lt;!-- Low-level configuration about protocols and bindings available for use. --&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ProtocolProvider</span> <span class="na">type=</span><span class="s">&#34;XML&#34;</span> <span class="na">validate=</span><span class="s">&#34;true&#34;</span> <span class="na">reloadChanges=</span><span class="s">&#34;false&#34;</span> <span class="na">path=</span><span class="s">&#34;protocols.xml&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/SPConfig&gt;</span>
</span></span></code></pre></div><p><code>&lt;RequestMapper&gt;</code> の部分は
<a href="https://github.com/nginx-shib/nginx-http-shibboleth/blob/master/CONFIG.rst#configuring-shibboleths-shibboleth2xml-to-recognise-secured-paths">Configuring Shibboleth&rsquo;s shibboleth2.xml to recognise secured paths</a>
の例から <code>&lt;Path name=&quot;/secure2/shibboleth&quot; /&gt;</code> の行を消して、ホスト名を <code>localhost</code> に変更しました。</p>
<p>後述のnginxの設定例では <code>/secure</code> と <code>/secure2</code> という2つのロケーションが出てくるのですが、今回は前者しか使っていないので、後者の設定は消しました。</p>
<p><code>&lt;Host&gt;</code> タグの <code>name</code> 属性のホスト名を <code>localhost</code> にしているのは今回の検証では <code>localhost</code> で試したからで、実際の運用ではSPのホスト名（この記事の例では <code>sp.example.org</code> ）を設定してください。</p>
<h2 id="nginxの設定">nginxの設定</h2>
<p>nginxの自作rpmでは
<a href="https://github.com/nginx-shib/nginx-http-shibboleth">nginx-shib/nginx-http-shibboleth: Shibboleth auth request module for nginx</a>
を動的モジュールとしてビルドしたので、 <code>/etc/nginx/nginx.conf</code> の <code>events</code> の行の前に以下のようにモジュール読み込み設定が必要です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">load_module modules/ngx_http_shibboleth_module.so;
</span></span></code></pre></div><p>nginxのserver設定は
<a href="https://github.com/nginx-shib/nginx-http-shibboleth/blob/master/CONFIG.rst#configure-nginx">Configure Nginx</a>
から <code>location /secure2</code> を除いて <code>server_name</code> を <code>localhost</code> にしたものを使いました。</p>
<p><code>/etc/nginx/conf.d/ssl.conf</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    listen 443 ssl;
</span></span><span class="line"><span class="cl">    server_name localhost;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ssl_session_cache shared:SSL:10m;
</span></span><span class="line"><span class="cl">    ssl_session_timeout 5m;
</span></span><span class="line"><span class="cl">    ssl_ciphers AESGCM:HIGH:!EXP:!RC4:!LOW:!aNULL;
</span></span><span class="line"><span class="cl">    ssl_prefer_server_ciphers on;
</span></span><span class="line"><span class="cl">    ssl_protocols TLSv1.2;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ssl_certificate /etc/pki/tls/certs/localhost.crt;
</span></span><span class="line"><span class="cl">    ssl_certificate_key /etc/pki/tls/private/localhost.key;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    #FastCGI authorizer for Auth Request module
</span></span><span class="line"><span class="cl">    location = /shibauthorizer {
</span></span><span class="line"><span class="cl">        internal;
</span></span><span class="line"><span class="cl">        include fastcgi_params;
</span></span><span class="line"><span class="cl">        fastcgi_pass unix:/opt/shibboleth/shibauthorizer.sock;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    #FastCGI responder
</span></span><span class="line"><span class="cl">    location /Shibboleth.sso {
</span></span><span class="line"><span class="cl">        include fastcgi_params;
</span></span><span class="line"><span class="cl">        fastcgi_pass unix:/opt/shibboleth/shibresponder.sock;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    #Resources for the Shibboleth error pages. This can be customised.
</span></span><span class="line"><span class="cl">    location /shibboleth-sp {
</span></span><span class="line"><span class="cl">        alias /usr/share/shibboleth/;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    #A secured location.  Here all incoming requests query the
</span></span><span class="line"><span class="cl">    #FastCGI authorizer.  Watch out for performance issues and spoofing.
</span></span><span class="line"><span class="cl">    location /secure {
</span></span><span class="line"><span class="cl">        include shib_clear_headers;
</span></span><span class="line"><span class="cl">        #Add your attributes here. They get introduced as headers
</span></span><span class="line"><span class="cl">        #by the FastCGI authorizer so we must prevent spoofing.
</span></span><span class="line"><span class="cl">        more_clear_input_headers &#39;displayName&#39; &#39;mail&#39; &#39;persistent-id&#39;;
</span></span><span class="line"><span class="cl">        shib_request /shibauthorizer;
</span></span><span class="line"><span class="cl">        shib_request_use_headers on;
</span></span><span class="line"><span class="cl">        proxy_pass http://localhost:8080;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><h4 id="httpsの自己証明書作成">httpsの自己証明書作成</h4>
<p>以下のようにhttpsの自己証明書を生成しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">openssl req -new -newkey rsa:2048 -sha1 -x509 -nodes \
</span></span></span><span class="line"><span class="cl"><span class="go">    -set_serial 1 \
</span></span></span><span class="line"><span class="cl"><span class="go">    -days 365 \
</span></span></span><span class="line"><span class="cl"><span class="go">    -subj &#34;/C=JP/ST=Osaka/L=Osaka City/CN=localhost&#34; \
</span></span></span><span class="line"><span class="cl"><span class="go">    -out /etc/pki/tls/certs/localhost.crt \
</span></span></span><span class="line"><span class="cl"><span class="go">    -keyout /etc/pki/tls/private/localhost.key
</span></span></span></code></pre></div><h4 id="upstreamの設定">upstreamの設定</h4>
<p>上記で <code>proxy_pass</code> で指定している http://localhost:8080 では実運用ではSAML認証した状態で使用するアプリケーションを動かすのですが、今回の検証は以下のような設定でnginxで静的なページを表示するだけにしました。</p>
<p><code>/etc/nginx/conf.d/upstream.conf</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    listen       8080;
</span></span><span class="line"><span class="cl">    server_name  localhost;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    access_log /var/log/nginx/upstream.access.log main;
</span></span><span class="line"><span class="cl">    root /var/www/html-upstream;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>以下のコマンドを実行して <code>/secure</code> のURLパスに対応するファイルを作成しておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mkdir -p /var/www/html-upstream/secure
</span></span></span><span class="line"><span class="cl"><span class="go">echo &#39;secure index page&#39; | sudo tee /var/www/html-upstream/secure/index.html
</span></span></span></code></pre></div><h1 id="サーバ再起動">サーバ再起動</h1>
<p>以上で設定ができたので、以下のコマンドで関連するサーバを再起動します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">systemctl restart shibd
</span></span></span><span class="line"><span class="cl"><span class="go">systemctl restart shibauthorizer
</span></span></span><span class="line"><span class="cl"><span class="go">systemctl restart shibrsponder
</span></span></span><span class="line"><span class="cl"><span class="go">systemctl restart nginx
</span></span></span></code></pre></div><h1 id="動作確認">動作確認</h1>
<p>これでブラウザで <code>https://localhost/secure</code> にアクセスします。
自己証明書なので警告が出ますが無視して進むと
<code>https://idp.example.com/sso-test/idp/sso_redirect?SAMLRequest=xxx…(略)…&amp;RelayState=…(略)…</code> といったURLにリダイレクトされます。</p>
<h2 id="samlrequestの確認">SAMLRequestの確認</h2>
<p>ChromeのURL欄からコピーしたSAMLRequestの値は以下のようにしてデコードできました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">python3 -c &#39;import sys, urllib.parse as ul, base64, zlib; print(zlib.decompress(base64.b64decode(ul.unquote_plus(sys.argv[1])), -15).decode(&#34;utf-8&#34;))&#39; &#39;ブラウザのURL欄からコピーしたSAMLRequestの値&#39;
</span></span></span></code></pre></div><p>上記のコードはURLデコードを行ってから下記の <a href="https://github.com/onelogin/python-saml/blob/e2da620897fb78eb2095abe4f37bde87832c7d1d/src/onelogin/saml2/utils.py#L92-L113">python-saml/utils.py</a> の <code>decode_base64_and_inflate</code> の処理を行うようにしたものです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decode_base64_and_inflate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    base64 decodes and then inflates according to RFC1951
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param value: a deflated and encoded string
</span></span></span><span class="line"><span class="cl"><span class="s2">    :type value: string
</span></span></span><span class="line"><span class="cl"><span class="s2">    :returns: the string after decoding and inflating
</span></span></span><span class="line"><span class="cl"><span class="s2">    :rtype: string
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">zlib</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="o">-</span><span class="mi">15</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@staticmethod</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">deflate_and_base64_encode</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Deflates and then base64 encodes a string
</span></span></span><span class="line"><span class="cl"><span class="s2">    :param value: The string to deflate and encode
</span></span></span><span class="line"><span class="cl"><span class="s2">    :type value: string
</span></span></span><span class="line"><span class="cl"><span class="s2">    :returns: The deflated and encoded string
</span></span></span><span class="line"><span class="cl"><span class="s2">    :rtype: string
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">zlib</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">])</span>
</span></span></code></pre></div><p>デコードした結果の例を以下に示します（なお、実際はIdPとSPのエンティティIDとURLはこの記事と違う値で動作確認していて、以下に貼っているのはデコードした後それらの値を置換しています）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;samlp:AuthnRequest</span> <span class="na">xmlns:samlp=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:protocol&#34;</span> <span class="na">AssertionConsumerServiceURL=</span><span class="s">&#34;https://localhost/Shibboleth.sso/SAML2/POST&#34;</span> <span class="na">Destination=</span><span class="s">&#34;https://idp.example.com/sso-test/idp/sso_redirect&#34;</span> <span class="na">ID=</span><span class="s">&#34;_fbd5e55b3590bf5c947ce2dd3d9f0053&#34;</span> <span class="na">IssueInstant=</span><span class="s">&#34;2018-07-04T01:53:41Z&#34;</span> <span class="na">ProtocolBinding=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST&#34;</span> <span class="na">Version=</span><span class="s">&#34;2.0&#34;</span><span class="nt">&gt;&lt;saml:Issuer</span> <span class="na">xmlns:saml=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:assertion&#34;</span><span class="nt">&gt;</span>https://sp.example.org/sso<span class="nt">&lt;/saml:Issuer&gt;&lt;samlp:NameIDPolicy</span> <span class="na">AllowCreate=</span><span class="s">&#34;1&#34;</span><span class="nt">/&gt;&lt;/samlp:AuthnRequest&gt;</span>
</span></span></code></pre></div><h2 id="samlresponseの確認">SAMLResponseの確認</h2>
<p>今回検証したIdPでは二段階認証を行うようになっています。Chromeの開発ツールを開いた状態で二段階目の入力を行うと <code>https://localhost/Shibboleth.sso/SAML2/POST</code> にPOSTでリクエストを送っていて FormData に <code>SAMLResponse</code> と <code>RelayState</code> という項目が含まれていました。</p>
<p>SAMLResponseは以下のようにしてBase64デコードすればXMLを確認できました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">echo &#39;ブラウザからコピーしたSAMLResponseの値&#39; | base64 --decode
</span></span></span></code></pre></div><p>デコードしたXMLを機密情報を伏せた上で以下に示します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="cp">&lt;?xml version=&#34;1.0&#34;?&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;samlp:Response</span> <span class="na">xmlns:samlp=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:protocol&#34;</span> <span class="na">xmlns:saml=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:assertion&#34;</span> <span class="na">ID=</span><span class="s">&#34;_EXAMPLE_SSO_f1756be7-771c-4330-9bd2-568501fdc194&#34;</span> <span class="na">Version=</span><span class="s">&#34;2.0&#34;</span> <span class="na">IssueInstant=</span><span class="s">&#34;2018-07-04T03:22:14Z&#34;</span> <span class="na">Destination=</span><span class="s">&#34;https://localhost/Shibboleth.sso/SAML2/POST&#34;</span> <span class="na">InResponseTo=</span><span class="s">&#34;_fbd5e55b3590bf5c947ce2dd3d9f0053&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;saml:Issuer&gt;</span>https://idp.example.com/sso-test/idp<span class="nt">&lt;/saml:Issuer&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;ds:Signature</span> <span class="na">xmlns:ds=</span><span class="s">&#34;http://www.w3.org/2000/09/xmldsig#&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ds:SignedInfo&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ds:CanonicalizationMethod</span> <span class="na">Algorithm=</span><span class="s">&#34;http://www.w3.org/2001/10/xml-exc-c14n#&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ds:SignatureMethod</span> <span class="na">Algorithm=</span><span class="s">&#34;http://www.w3.org/2000/09/xmldsig#rsa-sha1&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ds:Reference</span> <span class="na">URI=</span><span class="s">&#34;#_EXAMPLE_SSO_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;ds:Transforms&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;ds:Transform</span> <span class="na">Algorithm=</span><span class="s">&#34;http://www.w3.org/2000/09/xmldsig#enveloped-signature&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&lt;ds:Transform</span> <span class="na">Algorithm=</span><span class="s">&#34;http://www.w3.org/2001/10/xml-exc-c14n#&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/ds:Transforms&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;ds:DigestMethod</span> <span class="na">Algorithm=</span><span class="s">&#34;http://www.w3.org/2000/09/xmldsig#sha1&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;ds:DigestValue&gt;</span>xxxxxxxxxxxxxxxxxxxxxxxxxxx=<span class="nt">&lt;/ds:DigestValue&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/ds:Reference&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/ds:SignedInfo&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ds:SignatureValue&gt;</span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</span></span><span class="line"><span class="cl">xxxx…(略)…xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</span></span><span class="line"><span class="cl">xxxxxxxxxxxxxxxxxxxxxx==<span class="nt">&lt;/ds:SignatureValue&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;ds:KeyInfo&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ds:X509Data&gt;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;ds:X509Certificate&gt;</span>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</span></span><span class="line"><span class="cl">xxxx…(略)…xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</span></span><span class="line"><span class="cl">xxxxxxxxxxxxxxxxxxxxxx==<span class="nt">&lt;/ds:X509Certificate&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;ds:X509SubjectName&gt;</span>CN=localhost:5000,OU=sso-test,O=xxxxxxxxxxxxxxxxxxxx,L=Osaka,ST=Osaka,C=JP<span class="nt">&lt;/ds:X509SubjectName&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;ds:X509IssuerSerial&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;ds:X509IssuerName&gt;</span>CN=localhost:5000,OU=sso-test,O=xxxxxxxxxxxxxxxxxxxx,L=Osaka,ST=Osaka,C=JP<span class="nt">&lt;/ds:X509IssuerName&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;ds:X509SerialNumber&gt;</span>99999999999999999999<span class="nt">&lt;/ds:X509SerialNumber&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/ds:X509IssuerSerial&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/ds:X509Data&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/ds:KeyInfo&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/ds:Signature&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;samlp:Status&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;samlp:StatusCode</span> <span class="na">Value=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:status:Success&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/samlp:Status&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;saml:Assertion</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span> <span class="na">xmlns:xs=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema&#34;</span> <span class="na">ID=</span><span class="s">&#34;_a_fbd5e55b3590bf5c947ce2dd3d9f0053&#34;</span> <span class="na">Version=</span><span class="s">&#34;2.0&#34;</span> <span class="na">IssueInstant=</span><span class="s">&#34;2018-07-04T03:22:14Z&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;saml:Issuer&gt;</span>https://idp.example.com/sso-test/idp<span class="nt">&lt;/saml:Issuer&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;saml:Subject&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;saml:NameID</span> <span class="na">Format=</span><span class="s">&#34;urn:oasis:names:tc:SAML:1.1:nameid-format:persistent&#34;</span> <span class="na">NameQualifier=</span><span class="s">&#34;idp.example.com&#34;</span> <span class="na">SPNameQualifier=</span><span class="s">&#34;https://sp.example.org/sso&#34;</span><span class="nt">&gt;</span>user1<span class="nt">&lt;/saml:NameID&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;saml:SubjectConfirmation</span> <span class="na">Method=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:cm:bearer&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;saml:SubjectConfirmationData</span> <span class="na">InResponseTo=</span><span class="s">&#34;_fbd5e55b3590bf5c947ce2dd3d9f0053&#34;</span> <span class="na">NotOnOrAfter=</span><span class="s">&#34;2018-07-04T03:27:14Z&#34;</span> <span class="na">Recipient=</span><span class="s">&#34;https://localhost/Shibboleth.sso/SAML2/POST&#34;</span><span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/saml:SubjectConfirmation&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/saml:Subject&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;saml:Conditions</span> <span class="na">NotBefore=</span><span class="s">&#34;2018-07-04T03:17:14Z&#34;</span> <span class="na">NotOnOrAfter=</span><span class="s">&#34;2018-07-04T03:27:14Z&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;saml:AudienceRestriction&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;saml:Audience&gt;</span>https://sp.example.org/sso<span class="nt">&lt;/saml:Audience&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/saml:AudienceRestriction&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/saml:Conditions&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;saml:AuthnStatement</span> <span class="na">AuthnInstant=</span><span class="s">&#34;2018-07-04T03:22:14Z&#34;</span> <span class="na">SessionNotOnOrAfter=</span><span class="s">&#34;2018-07-04T04:22:14Z&#34;</span> <span class="na">SessionIndex=</span><span class="s">&#34;_s_fbd5e55b3590bf5c947ce2dd3d9f0053&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;saml:AuthnContext&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;saml:AuthnContextClassRef&gt;</span>urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport<span class="nt">&lt;/saml:AuthnContextClassRef&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/saml:AuthnContext&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/saml:AuthnStatement&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;saml:AttributeStatement&gt;</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;saml:Attribute</span> <span class="na">Name=</span><span class="s">&#34;mail&#34;</span> <span class="na">NameFormat=</span><span class="s">&#34;urn:oasis:names:tc:SAML:2.0:attrname-format:unspecified&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;saml:AttributeValue</span> <span class="na">xsi:type=</span><span class="s">&#34;xs:anyType&#34;</span><span class="nt">&gt;</span>user1@example.net<span class="nt">&lt;/saml:AttributeValue&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&lt;/saml:Attribute&gt;</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/saml:AttributeStatement&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/saml:Assertion&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/samlp:Response&gt;</span>
</span></span></code></pre></div><p><code>&lt;saml:Subject&gt;</code> の <code>&lt;saml:NameID&gt;</code> の値 <code>user1</code> がログインしたときのユーザIDです。
<code>AttributeStatement</code> の中に <code>&lt;saml:Attribute Name=&quot;mail&quot;&gt;</code> というタグがあり、その子供の <code>&lt;saml:AttributeValue&gt;</code> の値にログインユーザのメールアドレス <code>user1@example.net</code> が入っています。</p>
<p>また <code>https://localhost/Shibboleth.sso/SAML2/POST</code> のレスポンスヘッダには以下のような <code>Set-Cookie</code> ヘッダが含まれていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Set-Cookie: _shibsession_64656661756c7468747470733a2f2f61706930312e6465762e776562616363656c2e6a702f61646d696e2f73736f=_d43354cfc784c22b046e22bf1c1d176f; path=/; HttpOnly
</span></span></code></pre></div><p>この後 <code>https://localhost/secure</code> →  <code>https://localhost/secure/</code> とリダイレクトされて、上記で作成した /var/www/html-upstream/secure/index.html の内容である「secure index page」が無事表示されました。</p>
<h2 id="認証後にバックエンドに送られるリクエストヘッダ">認証後にバックエンドに送られるリクエストヘッダ</h2>
<p>また、ポート8080で動かしているバックエンド（に見立てたnginx）へのリクエストヘッダに何が来るのかを確認するため、以下のコマンドを動かした状態で認証を実行しました（ヘッダ名がわかっていればnginxの設定を変えてログ出力すればよいのですが、どういうヘッダが来るかがわからないのでtcpdumpを使いました）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">tcpdump -X -i lo port 8080
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">…(略)…
</span></span><span class="line"><span class="cl">06:41:20.135840 IP localhost.48704 &gt; localhost.webcache: Flags [P.], seq 1:1338, ack 1, win 342, options [nop,nop,TS val 763708778 ecr 763708778], length 1337: HTTP: GET /secure/ HTTP/1.0
</span></span><span class="line"><span class="cl">        0x0000:  4500 056d 2757 4000 4006 1032 7f00 0001  E..m&#39;W@.@..2....
</span></span><span class="line"><span class="cl">        0x0010:  7f00 0001 be40 1f90 71ea bb02 c998 0fbf  .....@..q.......
</span></span><span class="line"><span class="cl">        0x0020:  8018 0156 0362 0000 0101 080a 2d85 456a  ...V.b......-.Ej
</span></span><span class="line"><span class="cl">        0x0030:  2d85 456a 4745 5420 2f73 6563 7572 652f  -.EjGET./secure/
</span></span><span class="line"><span class="cl">        0x0040:  2048 5454 502f 312e 300d 0a48 6f73 743a  .HTTP/1.0..Host:
</span></span><span class="line"><span class="cl">        0x0050:  2031 3237 2e30 2e30 2e31 3a38 3038 300d  .127.0.0.1:8080.
</span></span><span class="line"><span class="cl">        0x0060:  0a43 6f6e 6e65 6374 696f 6e3a 2063 6c6f  .Connection:.clo
</span></span><span class="line"><span class="cl">…(略)…
</span></span></code></pre></div><p>Shibboleth関連のリクエストヘッダを抜き出して整形したものを以下に示します（日時が前後しているのは上で書いたのより前に動作確認したときのログをコピペしているためです）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Cookie: _shibsession_64656661756c7468747470733a2f2f61706930312e6465762e776562616363656c2e6a702f61646d696e2f73736f=_d43354cfc784c22b046e22bf1c1d176f
</span></span><span class="line"><span class="cl">AUTH_TYPE: shibboleth
</span></span><span class="line"><span class="cl">Shib-Application-ID: default
</span></span><span class="line"><span class="cl">Shib-Authentication-Instant: 2018-06-29T06:41:19Z
</span></span><span class="line"><span class="cl">Shib-Authentication-Method: urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
</span></span><span class="line"><span class="cl">Shib-AuthnContext-Class: urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport
</span></span><span class="line"><span class="cl">Shib-Handler: http://localhost/Shibboleth.sso
</span></span><span class="line"><span class="cl">Shib-Identity-Provider: https://idp.example.com/sso-test/idp
</span></span><span class="line"><span class="cl">Shib-Session-ID: _d43354cfc784c22b046e22bf1c1d176f
</span></span><span class="line"><span class="cl">Shib-Session-Index: _s_f5f10d110e4c22f0514443f82971c730
</span></span><span class="line"><span class="cl">mail: user1@example.net
</span></span></code></pre></div><p>上記の <code>Set-Cookie</code> で設定されたクッキーのと同じ値が <code>Shib-Session-ID</code> というリクエストヘッダに付与されています。
また、 <code>mail</code> というリクエストヘッダにログインユーザのメールアドレスが設定されています。</p>
<p>上記のnginxの設定の <code>location /secure</code> で <code>include shib_clear_headers;</code> と指定して読み込んでいる <code>/etc/nginx/shib_clear_headers</code> を確認すると以下のようになっていました（コメントは省略）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">more_clear_input_headers
</span></span><span class="line"><span class="cl">    Auth-Type
</span></span><span class="line"><span class="cl">    Shib-Application-Id
</span></span><span class="line"><span class="cl">    Shib-Authentication-Instant
</span></span><span class="line"><span class="cl">    Shib-Authentication-Method
</span></span><span class="line"><span class="cl">    Shib-Authncontext-Class
</span></span><span class="line"><span class="cl">    Shib-Identity-Provider
</span></span><span class="line"><span class="cl">    Shib-Session-Id
</span></span><span class="line"><span class="cl">    Shib-Session-Index
</span></span><span class="line"><span class="cl">    Remote-User;
</span></span></code></pre></div><p>ということで攻撃の意図を持ってリクエスト時にこれらのリクエストヘッダを指定して上書きしようとしても、一旦クリアしてから Shibboleth が設定するので問題ないです。</p>
<p><code>mail</code> のリクエストヘッダについても以下の行で一旦クリアしているのでこちらも問題ないです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">more_clear_input_headers &#39;displayName&#39; &#39;mail&#39; &#39;persistent-id&#39;;
</span></span></code></pre></div><h2 id="ログアウトの動作確認">ログアウトの動作確認</h2>
<p>今回検証した構成ではIdPにログアウト用のエンドポイント(URL)は無いので、
_shibsession_xxxx
のクッキーを削除することでログアウトとするということにします。</p>
<p>もしこのクッキー名に紐付けてバックエンドのサーバサイドでセッションデータを保持する場合は、そちらの削除も行うようにします。</p>
<p>今回はChromeでクッキーの削除を行いました。</p>
<p>「設定」→「詳細設定」→「コンテンツの設定」→「Cookie」→「すべての Cookie とサイトデータを表示」と進み、「Cookieを検索」の入力欄に「localhost」と入力して絞り込んで、クッキーを削除します。</p>
<p>本来は _shibsession_xxxx のクッキーだけを削除したかったのですが、クッキーの名前が長すぎて削除の☓ボタンが枠内に表示されず押せないため、「localhost」のクッキー全てをまとめて消すことで回避しました。</p>
<p>何度も消す場合は「すべての Cookie とサイトデータ」のページを開いたままにしておいて、再度ログインした後に「すべての Cookie とサイトデータ」の左の「←」をクリックして「Cookie」のページに戻り、再度「すべての Cookie とサイトデータを表示」を押して「すべての Cookie とサイトデータ」に戻ると「localhost」でのフィルタリングが維持されているので、あとは消すだけでOKでした。</p>
<p>システム化する場合は例えば
<a href="https://github.com/openresty/lua-nginx-module">openresty/lua-nginx-module</a>
と
<a href="https://github.com/cloudflare/lua-resty-cookie">cloudflare/lua-resty-cookie</a>
を使って、以下のようなコードを書けば良いです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">lua_package_path &#34;/usr/lib/nginx/lua/?.lua;;&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    …(略)…
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location /signout {
</span></span><span class="line"><span class="cl">        content_by_lua_block {
</span></span><span class="line"><span class="cl">            ngx.header.content_type = &#39;text/plain&#39;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            local ck = require &#34;resty.cookie&#34;
</span></span><span class="line"><span class="cl">            local cookie, err = ck:new()
</span></span><span class="line"><span class="cl">            if not cookie then
</span></span><span class="line"><span class="cl">                ngx.log(ngx.ERR, err)
</span></span><span class="line"><span class="cl">                return
</span></span><span class="line"><span class="cl">            end
</span></span><span class="line"><span class="cl">            local fields, err = cookie:get_all()
</span></span><span class="line"><span class="cl">            if fields then
</span></span><span class="line"><span class="cl">                local prefix = &#34;_shibsession_&#34;
</span></span><span class="line"><span class="cl">                for k, v in pairs(fields) do
</span></span><span class="line"><span class="cl">                    if string.sub(k, 1, #prefix) == prefix then
</span></span><span class="line"><span class="cl">                        local ok, err = cookie:set({
</span></span><span class="line"><span class="cl">                            key = k, value = &#34;&#34;, path = &#34;/&#34;, httponly = true,
</span></span><span class="line"><span class="cl">                            expires = &#34;Thu Jan 01 1970 00:00:00 GMT&#34;
</span></span><span class="line"><span class="cl">                        })
</span></span><span class="line"><span class="cl">                        if not ok then
</span></span><span class="line"><span class="cl">                            ngx.log(ngx.ERR, err)
</span></span><span class="line"><span class="cl">                            return
</span></span><span class="line"><span class="cl">                        end
</span></span><span class="line"><span class="cl">                    end
</span></span><span class="line"><span class="cl">                end
</span></span><span class="line"><span class="cl">            else
</span></span><span class="line"><span class="cl">                if err ~= &#34;no cookie found in the current request&#34; then
</span></span><span class="line"><span class="cl">                    ngx.log(ngx.ERR, err)
</span></span><span class="line"><span class="cl">                    return
</span></span><span class="line"><span class="cl">                end
</span></span><span class="line"><span class="cl">            end
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            ngx.redirect(&#39;/&#39;)
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    …(略)…
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>私のnginxのrpmでは <code>/usr/lib/nginx/lua/resty/cookie.lua</code> というパスに lua-resty-cookie のluaファイルを置いているので <code>lua_package_path &quot;/usr/lib/nginx/lua/?.lua;;&quot;;</code> と <code>require &quot;resty.cookie&quot;</code> でアクセスできます。</p>
<p>この例では名前が <code>_shibsession_</code> で始まるクッキーの有効期限を過去の日付にしてブラウザがクッキーを削除するようにしています。</p>
<p>既にサインアウト済みの場合とサインアウトした後に <code>/</code> にリダイレクトするようにしています。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
