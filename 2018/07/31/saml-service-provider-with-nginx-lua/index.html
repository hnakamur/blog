<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.108.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>nginx luaでSAMLのService Providerを作ってみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2022. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>nginx luaでSAMLのService Providerを作ってみた</h1>
  <time datetime=2018-07-31T10:00:00&#43;0900 class="post-date">2018-07-31</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#nginx関連のセットアップ">nginx関連のセットアップ</a></li>
    <li><a href="#xmlsec1のインストール">xmlsec1のインストール</a></li>
    <li><a href="#libzso-のシンボリックリンク作成">libz.so のシンボリックリンク作成</a></li>
  </ul>
</nav>
  <h1 id="はじめに">はじめに</h1>
<p><a href="/blog/2018/07/04/saml2-single-sign-on-with-nginx-and-shibboleth/">nginxとshibbolethでSAML2のシングルサインオンを試してみた</a> では <a href="https://www.shibboleth.net/products/service-provider/">Service Provider – Shibboleth Consortium</a> を使いましたが、汎用的な分、設定方法のドキュメント
<a href="https://wiki.shibboleth.net/confluence/display/SHIB2/NativeSPConfiguration">NativeSPConfiguration - Shibboleth 2 - Shibboleth Wiki</a> を見ても圧倒される感がありました （なお、ページ上部の囲みを見ると Shibboleth SP は先日 3.x がリリースされて 2.x はEOLになったそうです）。</p>
<p>そこで、 nginx lua で SAML の Service Provider (以下 SP と略）を書いてみたところ、動くものが出来たので公開して説明を書いておきます。</p>
<p><a href="https://github.com/hnakamur/nginx-lua-saml-service-provider">hnakamur/nginx-lua-saml-service-provider</a></p>
<p>ただし、この Service Provider は職場で動いている内製（非公開）の ID Provider （以下 IdP と略）で認証できることが目的であって、SAML 認証の仕様を全てカバーするつもりは全く無いです。そもそも SAML の仕様を読んですら無いです。</p>
<h1 id="saml認証のシーケンス図">SAML認証のシーケンス図</h1>
<p>今回実装したSAML認証のシーケンス図です。</p>
<p><img src="/blog/images/2018/07/31/saml-sequence.svg" alt="SAML sequence diagram"></p>
<p>上記の構成ですが、背景として、今回 SAML 認証を実装するシステムがフロントに nginx を置く構成を採用しているというのがあります。また、今後いろんな社内サービスで SAML 認証対応することを考えると、 Upstream のアプリケーションの改修が最小限ですむほうが楽なので、極力 nginx 側で対応できる方が良いだろうと考えました。</p>
<p>今回の実装ですと、ログインしたユーザのメールアドレスが Upstream のリクエストへのリクエストヘッダに付与されるので、 Upstream 側は必要に応じてそれを利用するように改修します。特にユーザを区別必要する必要がなければ何もしなくて良いです。</p>
<p>実は当初は Service Provider は Go で実装したのですが、その後 nginx lua で実装できれば nginx 以外のデーモンが増えないので運用が楽だなと思って実装してみたというのが今回の経緯です。</p>
<p>図では役割として nginx と Service Provider を分けて書いていますが、今回の実装では nginx 上で Service Provider を動かしているので、プロセスとしては nginx と Service Provider は同一です。</p>
<h1 id="インストール手順">インストール手順</h1>
<p>今回の動作環境は CentOS 7 です。</p>
<h2 id="nginx関連のセットアップ">nginx関連のセットアップ</h2>
<p>nginx関連で必要なパッケージは自作のrpmに全て同梱しました。</p>
<ul>
<li><a href="https://copr.fedorainfracloud.org/coprs/hnakamur/nginx/">hnakamur/nginx Copr</a></li>
</ul>
<p>以下の手順でインストールできます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo yum install epel-release
</span></span></span><span class="line"><span class="cl"><span class="go">sudo curl -sSL -o /etc/yum.repos.d/hnakamur-luajit.repo https://copr.fedoraproject.org/coprs/hnakamur/luajit/repo/epel-7/hnakamur-luajit-epel-7.repo
</span></span></span><span class="line"><span class="cl"><span class="go">sudo curl -sSL -o /etc/yum.repos.d/hnakamur-nginx.repo https://copr.fedoraproject.org/coprs/hnakamur/nginx/repo/epel-7/hnakamur-nginx-epel-7.repo
</span></span></span><span class="line"><span class="cl"><span class="go">sudo yum install nginx
</span></span></span></code></pre></div><h2 id="xmlsec1のインストール">xmlsec1のインストール</h2>
<p>勤務先の IdP が <code>xmlsec1 --sign</code> で SAML Response XML の署名を行っていることもあり、今回作成した SAML Service Provider では <code>xmlsec1 --verify</code> で IdP から受け取った SAML Response XML の検証を行うように実装しました。</p>
<p>このため以下のようにして必要なパッケージをインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo yum install xmlsec1 xmlsec1-openssl
</span></span></span></code></pre></div><p>CentOS 7 の <code>xmlsec1</code> マニュアルページがウェブ上で見つけられなかったので Ubuntu のを貼っておきます。
<a href="http://manpages.ubuntu.com/manpages/bionic/en/man1/xmlsec1.1.html">man 1 xmlsec1</a></p>
<h2 id="libzso-のシンボリックリンク作成">libz.so のシンボリックリンク作成</h2>
<p><a href="https://github.com/hamishforbes/lua-ffi-zlib">hamishforbes/lua-ffi-zlib</a> が
LuaJIT の <a href="http://luajit.org/ext_ffi_api.html#ffi_load">ffi.load</a> を使って
<code>ffi.load(&quot;z&quot;)</code> というコード ( <a href="https://github.com/hamishforbes/lua-ffi-zlib/blob/3d6dbee710b4712b8d0e0235425abee04a22b1bd/lib/ffi-zlib.lua#L98">lua-ffi-zlib/ffi-zlib.lua:98</a> 参照)
を実行し、その結果 <code>libz.so</code> というファイル名を探すことになります。
しかし、 CentOS 7 では <code>libz.so.1</code> というファイルはあるのですが <code>libz.so</code> は無いため、以下のようにシンボリックリンクを作成する必要があります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ln -s libz.so.1 /lib64/libz.so
</span></span></span></code></pre></div><p>2018-08-01 追記。どうやらこれは LXD の CentOS 7 コンテナ特有の問題だったようで、他の環境では上記のシンボリックリンクは存在していました。</p>
<h1 id="設定例">設定例</h1>
<p><a href="https://github.com/hnakamur/nginx-lua-saml-service-provider">hnakamur/nginx-lua-saml-service-provider</a>
の
<a href="https://github.com/hnakamur/nginx-lua-saml-service-provider/tree/master/example_config/etc/nginx">/example_config/etc/nginx</a> 以下に設定例を入れておきました。</p>
<p><code>/etc/nginx/conf.d/default.conf</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">lua_package_path &#39;/usr/lib/nginx/lua/?.lua;/etc/nginx/lua/?.lua;;&#39;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">lua_shared_dict sso_sessions 1m;
</span></span><span class="line"><span class="cl">lua_shared_dict sso_redirect_urls 128k;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    listen 443 ssl;
</span></span><span class="line"><span class="cl">    server_name sp.example.com;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ssl_session_cache shared:SSL:10m;
</span></span><span class="line"><span class="cl">    ssl_session_timeout 5m;
</span></span><span class="line"><span class="cl">    ssl_ciphers AESGCM:HIGH:!EXP:!RC4:!LOW:!aNULL;
</span></span><span class="line"><span class="cl">    ssl_prefer_server_ciphers on;
</span></span><span class="line"><span class="cl">    #ssl_protocols TLSv1.2;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ssl_certificate /etc/pki/tls/certs/sp.example.com.crt;
</span></span><span class="line"><span class="cl">    ssl_certificate_key /etc/pki/tls/private/sp.example.com.key;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location / {
</span></span><span class="line"><span class="cl">	access_by_lua_block {
</span></span><span class="line"><span class="cl">	    local config = require &#34;saml.service_provider.config&#34;
</span></span><span class="line"><span class="cl">	    local sp = require(&#34;saml.service_provider&#34;):new(config)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	    local ok, err = sp:access()
</span></span><span class="line"><span class="cl">	    if err ~= nil then
</span></span><span class="line"><span class="cl">		ngx.log(ngx.ERR, err)
</span></span><span class="line"><span class="cl">		ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
</span></span><span class="line"><span class="cl">		return
</span></span><span class="line"><span class="cl">	    end
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	proxy_pass http://127.0.0.1:8080;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location /sso/finish-login {
</span></span><span class="line"><span class="cl">	content_by_lua_block {
</span></span><span class="line"><span class="cl">	    local config = require &#34;saml.service_provider.config&#34;
</span></span><span class="line"><span class="cl">	    local sp = require(&#34;saml.service_provider&#34;):new(config)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	    local ok, err = sp:finish_login()
</span></span><span class="line"><span class="cl">	    if err ~= nil then
</span></span><span class="line"><span class="cl">		ngx.log(ngx.ERR, err)
</span></span><span class="line"><span class="cl">		ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
</span></span><span class="line"><span class="cl">		return
</span></span><span class="line"><span class="cl">	    end
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location /sso/logout {
</span></span><span class="line"><span class="cl">	content_by_lua_block {
</span></span><span class="line"><span class="cl">	    local config = require &#34;saml.service_provider.config&#34;
</span></span><span class="line"><span class="cl">	    local sp = require(&#34;saml.service_provider&#34;):new(config)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	    local ok, err = sp:logout()
</span></span><span class="line"><span class="cl">	    if err ~= nil then
</span></span><span class="line"><span class="cl">		ngx.log(ngx.ERR, err)
</span></span><span class="line"><span class="cl">		ngx.exit(ngx.HTTP_INTERNAL_SERVER_ERROR)
</span></span><span class="line"><span class="cl">		return
</span></span><span class="line"><span class="cl">	    end
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>上記の設定例では <code>https://sp.example.com/sso/logout</code> にアクセスするとログアウトするようになっています。 Upstream 側の画面からログアウトできるようにするには、ここへのリンクを貼れば OK です。</p>
<p><code>/etc/nginx/lua/saml/service_provider/config.lua</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">return {
</span></span><span class="line"><span class="cl">    key_attribute_name = &#34;mail&#34;,
</span></span><span class="line"><span class="cl">    redirect = {
</span></span><span class="line"><span class="cl">	url_after_login = &#34;/&#34;,
</span></span><span class="line"><span class="cl">	url_after_logout = &#34;/&#34;
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    request = {
</span></span><span class="line"><span class="cl">	idp_dest_url = &#34;https://idp.example.net/sso_redirect&#34;,
</span></span><span class="line"><span class="cl">	sp_entity_id = &#34;https://sp.example.com/sso&#34;,
</span></span><span class="line"><span class="cl">	sp_saml_finish_url = &#34;https://sp.example.com/sso/finish-login&#34;,
</span></span><span class="line"><span class="cl">	urls_before_login = {
</span></span><span class="line"><span class="cl">	    dict_name = &#34;sso_redirect_urls&#34;,
</span></span><span class="line"><span class="cl">	    expire_seconds = 180
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    response = {
</span></span><span class="line"><span class="cl">	xmlsec_command = &#34;/usr/bin/xmlsec1&#34;,
</span></span><span class="line"><span class="cl">	idp_cert_filename = &#34;/usr/local/etc/idp.crt&#34;
</span></span><span class="line"><span class="cl">    },
</span></span><span class="line"><span class="cl">    session = {
</span></span><span class="line"><span class="cl">	cookie = {
</span></span><span class="line"><span class="cl">	    name = &#34;sso_session_id&#34;,
</span></span><span class="line"><span class="cl">	    path = &#34;/&#34;,
</span></span><span class="line"><span class="cl">	    secure = true
</span></span><span class="line"><span class="cl">	},
</span></span><span class="line"><span class="cl">	store = {
</span></span><span class="line"><span class="cl">	    dict_name = &#34;sso_sessions&#34;,
</span></span><span class="line"><span class="cl">	    expire_seconds = 600
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>この設定ファイルは <a href="https://www.lua.org/">Lua</a> で書いています。 Lua はこのように設定ファイルを書くときに読みやすくなるようにも設計されたと聞いたことがありますが、確かに良い感じです。なお、ここでは書いていませんが <code>--</code> で始まるコメント行を含めることも出来ます。</p>
<p>あとは <code>/usr/local/etc/idp.crt</code> に IdP の証明書（PEM形式）を配備します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">-----BEGIN CERTIFICATE-----
</span></span><span class="line"><span class="cl">MIIDbDCCAlQCCQC2lvI/q52P9zANBgkqhkiG9w0BAQUFADB4MQswCQYDVQQGEwJK
</span></span><span class="line"><span class="cl">…(略)…
</span></span><span class="line"><span class="cl">MOnar9vP8eOYXOtO9laTow==
</span></span><span class="line"><span class="cl">-----END CERTIFICATE-----
</span></span></code></pre></div><h1 id="sp-が保持する状態についての説明">SP が保持する状態についての説明</h1>
<p>今回の SP の実装では <a href="https://github.com/openresty/lua-nginx-module">openresty/lua-nginx-module</a> の
<a href="https://github.com/openresty/lua-nginx-module#ngxshareddict">ngx.shared.DICT</a> を 2 つ使っています。</p>
<p>上記の設定例では <code>sso_redirect_urls</code> と <code>sso_sessions</code> です。</p>
<p><code>sso_redirect_urls</code> はログイン直前に開いていた URL を保存しておいて、ログイン後にその URL にリダイレクトさせるようにさせるためのものです。ログインが必要な領域（上記の設定例では <code>/</code> 全般）に非ログイン状態でアクセスしたときに、 URL を保存して IdP のログイン画面にリダイレクトします。</p>
<p><code>sso_sessions</code> のほうはセッション情報を保存するための dict です。 IdP でのログイン成功後、 IdP から SP に Base64 エンコードされた署名付きの SAML Response XML が送られてきます。その署名を検証し、 Response に含まれるユーザのメールアドレス （これは IdP の設定次第です）を取り出します。セッション ID を暗号レベルの 128bit 乱数として生成して、それをキーとしメールアドレスを値として、 <code>sso_sessions</code> に保存しています。</p>
<p>1 つの nginx で複数のバックエンドシステムを扱う場合でも、上記の設定を発展させればログイン状態を共有することが出来るでしょう。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
