<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.64.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>VeraCryptでデータパーティションを暗号化してみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>VeraCryptでデータパーティションを暗号化してみた</h1>
  <time datetime=2018-04-22T20:45:00&#43;0900 class="post-date">2018-04-22</time>
  <h2 id="はじめに">はじめに</h2>
<p>Windows 10とUbuntu 16.04のデュアルブート環境でデータ用のパーティションを <a href="https://www.veracrypt.fr/en/Home.html">VeraCrypt - Free Open source disk encryption with strong security for the Paranoid</a> で暗号化して
両方からマウントするというのを試してみたのでメモです。</p>
<p><a href="https://ja.wikipedia.org/wiki/VeraCrypt">VeraCrypt - Wikipedia</a> によると開発が終了したTrueCryptというソフトウェアのフォークらしいです。</p>
<h2 id="ファイルシステムはntfsを選択">ファイルシステムはNTFSを選択</h2>
<p>データパーティションのファイルシステムは何にしようかと思って検索してみると
<a href="http://www.ext2fsd.com/">Ext2Fsd Project</a> というのもみつけました。
これで、Windowsからext3やext4をマウントするという案もちょっとだけ考えたのですが、
2017-11-02の &ldquo;Ext2Fsd 0.69 released !&rdquo; の記事を眺めてみるとまだデータ消失のリスクがありそうな感じでした。</p>
<p>FAT32はジャーナルが無いのでファイルシステムで不整合が起きたときのことを考えると
ジャーナルのあるNTFSをLinuxからマウントするほうが良さそうと思いました。</p>
<p>検索してみると <a href="https://www.tuxera.com/community/open-source-ntfs-3g/">NTFS-3G - Tuxera</a> という
ドライバがあって読み書きともに安定して使えるようです。
<a href="https://ja.wikipedia.org/wiki/NTFS-3G">NTFS-3G - Wikipedia</a> と
<a href="https://wiki.archlinux.jp/index.php/NTFS-3G">NTFS-3G - ArchWiki</a> も眺めてみましたが良さそうです。</p>
<p>ということでNTFSを選択しました。</p>
<h2 id="windowsにveracryptをインストールしてデータパーティションを暗号化">WindowsにVeraCryptをインストールしてデータパーティションを暗号化</h2>
<p>データのドライブの作成とNTFSでのフォーマットは
<a href="http://www.century.co.jp/support/faq/windows-10-format.html">Windows10でのハードディスク（HDD）のフォーマット方法 - 株式会社センチュリー</a>
のような感じで行いました。</p>
<p>「ドライブ文字またはパスの割り当て」では「ドライブ文字またはドライブパスを割り当てない」を選択しました。
VeraCrypt経由でアクセスするためのドライブを別に作るのでそちらにドライブ文字を割り当てるので、
元のパーティションでは不要という判断です。</p>
<p>ドライブ文字を割り当てても動作に問題はないのですが、エクスプローラで元のパーティションのドライブを選んでも
エラーになるだけなので割り当てる利点は薄いと思います。</p>
<p>VeraCryptについては <a href="https://freepc.jp/post-14806">「VeraCypt」で暗号化された仮想ドライブを作成する手順</a> を参考にしました。
ただしダウンロードは <a href="https://www.veracrypt.fr/en/Downloads.html">VeraCryptのダウンロードページ</a> からにしました。また、VeraCryptボリューム作成ウィザードの箇所では「非システムパーティション/ドライブを暗号化」を選んで、上記で作成したデータ用のパーティションを選択しました。</p>
<h4 id="windowsのログオン時に自動的にマウントする設定">Windowsのログオン時に自動的にマウントする設定</h4>
<p><a href="https://www.veracrypt.fr/en/FAQ.html">VeraCryptのFAQ</a> の
&ldquo;Can a volume be automatically mounted whenever I log on to Windows?&rdquo; に書かれていた手順で出来ました。</p>
<ol>
<li>対象のパーティションをマウントする。</li>
<li>VeraCryptのメインウィンドウでマウントしたドライブを選んで右クリックし &ldquo;Add to Favorites&rdquo; (お気に入りに追加)メニューを選択。</li>
<li>Favorites Orgranizerのウィンドウで &ldquo;Mount selected volume upon logon&rdquo; を有効にしてOKを押す。</li>
</ol>
<h4 id="windowsのシャットダウンや再起動時は自動的にアンマウント">Windowsのシャットダウンや再起動時は自動的にアンマウント</h4>
<p>また、同じページの
&ldquo;Do I have to dismount VeraCrypt volumes before shutting down or restarting Windows?&rdquo;
によるとWindowsのシャットダウンや再起動時は自動的にアンマウントされるとのことなので、手動でのアンマウントは不要です。</p>
<h2 id="ubuntuにveracryptをインストールしてwindowsのveracryptで暗号化したパーティションをマウント">UbuntuにVeraCryptをインストールしてWindowsのVeraCryptで暗号化したパーティションをマウント</h2>
<p><a href="https://www.veracrypt.fr/en/Downloads.html">VeraCryptのダウンロードページ</a> を見るとLinux用にもインストーラが用意されているのですが
<a href="https://launchpad.net/~unit193/+archive/ubuntu/encryption">Encryption software : Unit 193</a> というPPAにUbuntu 16.04用のパッケージがありましたので、これを使わせて頂きました。ありがとうございます！</p>
<pre><code class="language-console" data-lang="console">sudo add-apt-repository ppa:unit193/encryption
sudo apt update
sudo apt install veracrypt
</code></pre><p>インストール後は <a href="https://linuxfan.info/veracrypt">死んだ後も安心！？VeraCryptで秘密のファイル置き場を作る方法 | Linux Fan</a> を参考にして、上記でWindowsのVeraCryptで暗号化したパーティションをマウントしました。</p>
<p>マウントしたらWindowsのときと同様にお気に入りに追加しておきます。</p>
<h4 id="linuxのguiでのログイン時に自動的にマウントする設定">LinuxのGUIでのログイン時に自動的にマウントする設定</h4>
<ol>
<li>
<p>「アプリケーションを表示する」→「自動起動するアプリケーションの設定」をクリック。</p>
</li>
<li>
<p>追加を押して以下の内容を追加。</p>
<ul>
<li>名前: VeraCryptボリュームマウント</li>
<li>コマンド: <code>veracrypt --auto-mount=favorites --background-task</code></li>
</ul>
</li>
</ol>
<p>2018-05-21 追記。veracryptでお気に入りをマウントする際に <code>--background-task</code> オプションも指定したほうが良いことがわかりました。これを指定するとGNOMEのシステムトレイにVeraCryptのアイコンが追加されます。これをメニューから終了させようとすると以下のようなメッセージのダイアログが表示されます。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">WARNING: If VeraCrypt exits now, the following functions, depending on the platform,
will be disabled:

1) Auto-dismount (e.g., upon logoff, time-out, etc.)
2) Notifications (e.g., when damage to hidden volume is prevented)
3) Tray icon

Note: If you do not wish VeraCrypt to continue running in background after you close
its window, disable the Background Task in the Preferences.

Are you sure you want VeraCrypt to exit?
</code></pre></div><p>メッセージの内容を読むと終了させずに動かしておいたほうが良いと思いました。</p>
<h4 id="linuxのシャットダウンや再起動時も自動的にアンマウント">Linuxのシャットダウンや再起動時も自動的にアンマウント</h4>
<p><a href="https://askubuntu.com/questions/799277/do-i-have-to-dismount-veracrypt-volumes-before-shutting-down-or-restarting-ubunt/921884#921884">mount - Do I have to dismount VeraCrypt volumes before shutting down or restarting Ubuntu? - Ask Ubuntu</a> によるとLinuxではシャットダウン時に自動でアンマウントはされないとあったのですが、実際に試してみるとjournalログにアンマウントされたようなメッセージが表示されていました。</p>
<p>VeraCrypt_1.22_Source.tar.bz2 内の Driver/Fuse/FuseService.cpp にも以下のようなコードがあったのでシグナルを受けたらアンマウントするようです。</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="kt">void</span> <span class="n">FuseService</span><span class="o">:</span><span class="o">:</span><span class="n">OnSignal</span> <span class="p">(</span><span class="kt">int</span> <span class="n">signal</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
                <span class="n">shared_ptr</span> <span class="o">&lt;</span><span class="n">VolumeInfo</span><span class="o">&gt;</span> <span class="n">volume</span> <span class="o">=</span> <span class="n">Core</span><span class="o">-</span><span class="o">&gt;</span><span class="n">GetMountedVolume</span> <span class="p">(</span><span class="n">SlotNumber</span><span class="p">)</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">volume</span><span class="p">)</span>
                        <span class="n">Core</span><span class="o">-</span><span class="o">&gt;</span><span class="n">DismountVolume</span> <span class="p">(</span><span class="n">volume</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

        <span class="n">_exit</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><h4 id="マウント状態確認">マウント状態確認</h4>
<p>2018-05-21追記。VeraCryptでマウントされているボリューム一覧を端末上で表示するには以下のコマンドを実行します。</p>
<pre><code class="language-console" data-lang="console">veracrypt -t -l
</code></pre><p><code>-t</code> 無しで <code>-l</code> のみ指定すると端末上ではなくダイアログが開いて表示されます。</p>
<p><code>-t</code> (<code>--text</code>) はGUIを使わずテキストインタフェースを使うためのオプションです。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-t, --text
 Use text user interface. Graphical user interface is used by default if
  available. This option must be specified as the first argument.
</code></pre></div><p>オプション確認の <code>-h</code> も <code>-t</code> 無しで <code>veracrypt -h</code> と実行すると端末に表示しつつダイアログも表示されます。 <code>-t</code> 有りで <code>veracrypt -t -h</code> と実行すると端末のみに表示されます。</p>
<h2 id="おわりに">おわりに</h2>
<p>これで暗号化したパーティションをデュアルブートのWindowsとLinuxの両方からマウント出来ました。
KeePass のデータファイルなどを置いています。</p>
<p><a href="https://www.veracrypt.fr/en/System%20Encryption.html">System Encryption</a>
や <a href="https://www.howtogeek.com/howto/6169/use-truecrypt-to-secure-your-data/">How to Encrypt Your Windows System Drive With VeraCrypt</a> によるとWindowsのシステムパーティションの暗号化も出来るようなので、いつか気が向いたらこちらも試してみたいです。</p>

</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
