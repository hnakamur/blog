<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Windows10のパーティションを縮小するために移動できないファイルを消す</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/04/02/delete-unmovable-files-to-shrink-windows10-partition/" rel="bookmark"
           title="Permalink to Windows10のパーティションを縮小するために移動できないファイルを消す">Windows10のパーティションを縮小するために移動できないファイルを消す</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-04-02T00:16:00+09:00">
                Published: 2018-04-02
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/windows.html">windows</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>WindowsとUbuntuでデュアルブートするためにWindowsのパーティションを縮小
するのですが、前回試したときは移動できないファイルがあるというようなことを
言われてあまり縮小できませんでした。</p>
<p>その後調べてみると移動できないファイルを一時的に削除して、もっと縮小できた
のでメモです。今回試したのはWindows 10 Proです。</p>
</div>
<div class="section" id="url">
<h2>参考URL</h2>
<p>以下のページを参考にしました。有用な情報に感謝です。</p>
<ul class="simple">
<li><a class="reference external" href="https://superuser.com/questions/1017764/how-to-shrink-a-windows-10-partition">hard drive - How to shrink a Windows 10 partition - Super User</a></li>
<li><a class="reference external" href="https://freesoft.tvbok.com/tips/pc_windows/del_hiberfil_sys.html">ハイバネーション（hiberfil.sys）を無効にする･削除する - ぼくんちのTV 別館</a></li>
<li><a class="reference external" href="http://backupchain.com/i/how-to-delete-all-vss-shadows-and-orphaned-shadows">How to Delete All VSS Shadows and Orphaned Shadows</a></li>
<li><a class="reference external" href="https://www.brandonchecketts.com/archives/how-to-shrink-a-partition-with-unmovable-files-in-windows-7">How to shrink a partition with unmovable files in Windows 7 – Brandon Checketts</a></li>
</ul>
</div>
<div class="section" id="id2">
<h2>一時的に削除</h2>
<p>以下の各操作を実行するため、PowerShellを管理者権限で起動します。</p>
<p>Windowsキーを押してスタートメニューを開き powershell と入力して検索結果に PowerShell が表示されたら、マウスを右クリックして「管理者として実行」メニューを選ぶのが手軽でした。</p>
<p><a class="reference external" href="http://www.thewindowsclub.com/check-powershell-version-windows">How to check PowerShell version in Windows 10</a> にPowerShellのバージョンの確認方法が書いてありました。私の環境では以下のようになりました。</p>
<div class="highlight"><pre><span></span><span class="go">PS C:\WINDOWS\system32&gt; $PSversionTable</span>

<span class="go">Name                           Value</span>
<span class="go">----                           -----</span>
<span class="go">PSVersion                      5.1.16299.251</span>
<span class="go">PSEdition                      Desktop</span>
<span class="go">PSCompatibleVersions           {1.0, 2.0, 3.0, 4.0...}</span>
<span class="go">BuildVersion                   10.0.16299.251</span>
<span class="go">CLRVersion                     4.0.30319.42000</span>
<span class="go">WSManStackVersion              3.0</span>
<span class="go">PSRemotingProtocolVersion      2.3</span>
<span class="go">SerializationVersion           1.1.0.1</span>
</pre></div>
<div class="section" id="id3">
<h3>ページファイルを無効にする</h3>
<p>管理者権限のPowerShellで以下のように実行します。</p>
<p>ページファイル使用中であることを確認。</p>
<div class="highlight"><pre><span></span><span class="go">wmic pagefileset list</span>
</pre></div>
<p>ページファイルを無効にする。</p>
<div class="highlight"><pre><span></span><span class="go">wmic computersystem set AutomaticManagedPagefile=False</span>
<span class="go">wmic pagefileset delete</span>
</pre></div>
<p>参考ページでは <code>wmic pagefileset where name=&quot;C:\\pagefile.sys&quot; delete</code> と条件を指定していましたがエラーになってしまったので上記のようにしました。</p>
</div>
<div class="section" id="id4">
<h3>ハイバネーションを無効にする</h3>
<p>管理者権限のPowerShellで以下のように実行します。</p>
<div class="highlight"><pre><span></span><span class="go">powercfg /h off</span>
</pre></div>
<p>以下のコマンドで状態を確認できます。</p>
<div class="highlight"><pre><span></span><span class="go">powercfg /a</span>
</pre></div>
<p>実行例（再起動した後に実行しました）。</p>
<div class="highlight"><pre><span></span><span class="go">PS C:\WINDOWS\system32&gt; powercfg /a</span>
<span class="go">以下のスリープ状態がこのシステムで利用可能です:</span>
<span class="go">    スタンバイ (S3)</span>

<span class="go">以下のスリープ状態はこのシステムでは利用できません:</span>
<span class="go">    スタンバイ (S1)</span>
<span class="go">        システム ファームウェアはこのスタンバイ状態をサポートしていません。</span>

<span class="go">    スタンバイ (S2)</span>
<span class="go">        システム ファームウェアはこのスタンバイ状態をサポートしていません。</span>

<span class="go">    休止状態</span>
<span class="go">        休止状態は有効にされていません。</span>

<span class="go">    スタンバイ (S0 低電力アイドル)</span>
<span class="go">        システム ファームウェアはこのスタンバイ状態をサポートしていません。</span>

<span class="go">    ハイブリッド スリープ</span>
<span class="go">        休止状態は使用できません。</span>
<span class="go">        ハイパーバイザーはこのスタンバイ状態をサポートしていません。</span>

<span class="go">    高速スタートアップ</span>
<span class="go">        休止状態は使用できません。</span>
</pre></div>
</div>
<div class="section" id="id5">
<h3>システム復元を無効にする</h3>
<p>管理者権限のPowerShellで以下のように実行します。</p>
<div class="highlight"><pre><span></span><span class="go">Disable-ComputerRestore -Drive C:</span>
</pre></div>
<p>よくわからないままコピペで実行してしまいましたが、私は復元ポイントを作っていなかったので、この操作は不要だったかもしれません。</p>
<ul class="simple">
<li><a class="reference external" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/disable-computerrestore?view=powershell-5.1">Disable-ComputerRestore</a> のドキュメント。</li>
<li>状態確認には <a class="reference external" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-computerrestorepoint?view=powershell-5.1">Get-ComputerRestorePoint</a> を使うっぽい。</li>
</ul>
</div>
<div class="section" id="id6">
<h3>再起動</h3>
<p>「ページファイルを無効にする」、「ハイバネーションを無効にする」、「システム復元を無効にする」の3つを行った後、Windowsを再起動しました。</p>
</div>
</div>
<div class="section" id="id7">
<h2>さらに削除</h2>
<div class="section" id="id8">
<h3>一時ファイルを削除</h3>
<p><a class="reference external" href="https://pc-karuma.net/windows-10-delete-temporary-files/">Windows10 - 一時ファイルを削除する方法 - PC設定のカルマ</a> の手順で一時ファイルを削除しました。</p>
<ol class="arabic simple">
<li>コントロールパネルの設定のストレージを選択し、「PC (C:)」のグラフをクリック。</li>
<li>ストレージ使用量の下の各種内訳グラフが並ぶ中の「一時ファイル」をクリック。</li>
<li>「一時ファイル」画面で「一時ファイル」、「ダウンロードフォルダー」、「ごみ箱を空にする」のすべてにチェックして「ファイルの削除」ボタンを押す。</li>
</ol>
</div>
</div>
<div class="section" id="id9">
<h2>ボリュームの縮小を試すもいまいち</h2>
<p>「ディスクの管理」を開くのはWindowsキーを押してスタートメニューを開き disk と入力して検索結果に表示された「ハードディスク パーティションの作成とフォーマット」を選ぶのが手軽でした。</p>
<p>C: ドライブを選んでマウス右クリックでポップアップメニューを開き「ボリュームの縮小」を試しましたが、縮小可能な量はまだいまいちでした。</p>
</div>
<div class="section" id="vss-shadows">
<h2>VSS Shadows を削除</h2>
<p><a class="reference external" href="https://superuser.com/questions/1017764/how-to-shrink-a-windows-10-partition">hard drive - How to shrink a Windows 10 partition - Super User</a> の
<a class="reference external" href="https://superuser.com/questions/1017764/how-to-shrink-a-windows-10-partition#comment1760829_1060508">May 10 '17 at 2:11</a> にVSS Shadowsを全て消す必要があったいうコメントを見つけました。</p>
<p>検索してみると <a class="reference external" href="http://backupchain.com/i/how-to-delete-all-vss-shadows-and-orphaned-shadows">How to Delete All VSS Shadows and Orphaned Shadows</a> に削除の手順が書かれていました。</p>
<div class="section" id="id10">
<h3>移動不可なファイルの確認</h3>
<p>また、
<a class="reference external" href="https://www.brandonchecketts.com/archives/how-to-shrink-a-partition-with-unmovable-files-in-windows-7">How to shrink a partition with unmovable files in Windows 7 – Brandon Checketts</a>
に移動不可なファイルを確認する手順が書かれていました。</p>
<ol class="arabic simple">
<li>Windowsキーを押してスタートメニューを開き event と入力し検索結果に表示された「イベント ビューアー」を選んで起動します。</li>
<li>左のツリーで「Windows ログ」/「Application」を選びます。</li>
<li>右の「操作」のリストで「現在のログをフィルタ」を選び、ダイアログが開いたら「＜すべてのイベントID＞」のテキスト欄をクリックして「259」と入力しリターンキーを押します。</li>
<li>画面中央の一覧に検索結果が表示されますので一番上の最新のイベントを選択します。</li>
<li>「操作」/「コピー」/「詳細をテキストとしてコピー」メニューを選び、お好みのテキストエディタでペーストすればファイルのパスを確認できます。</li>
</ol>
<div class="highlight"><pre><span></span>ログの名前:         Application
ソース:           Microsoft-Windows-Defrag
日付:            2018/04/01 22:04:42
イベント ID:       259
タスクのカテゴリ:      なし
レベル:           情報
キーワード:         クラシック
ユーザー:          N/A
コンピューター:       sunshine7
説明:
ボリューム Windows (C:) に対して縮小の分析が開始されました。このイベント ログ エントリでは、再利用可能な最大領域 (バイト) の減少を招く可能性のある、最後に移動できなかったファイルについての詳細を提供します。

 診断の詳細:
 - 最後に移動できなかったと思われるファイル: \$BitMap::$DATA
 - このファイルの最後のクラスター: 0xbfbfe
 - 縮小対象の候補 (LCN アドレス): 0x7ca6b7
 - NTFS ファイル フラグ: -S--D
 - 縮小フェーズ: &lt;analysis&gt;

 このファイルの詳細については、&quot;fsutil volume querycluster \\?\Volume{6a1301d0-ab28-4b33-98ca-e063ddba90bc} 0xbfbfe&quot; コマンドを使用してください。
イベント XML:
&lt;Event xmlns=&quot;http://schemas.microsoft.com/win/2004/08/events/event&quot;&gt;
  &lt;System&gt;
    &lt;Provider Name=&quot;Microsoft-Windows-Defrag&quot; /&gt;
    &lt;EventID Qualifiers=&quot;16384&quot;&gt;259&lt;/EventID&gt;
    &lt;Level&gt;4&lt;/Level&gt;
    &lt;Task&gt;0&lt;/Task&gt;
    &lt;Keywords&gt;0x80000000000000&lt;/Keywords&gt;
    &lt;TimeCreated SystemTime=&quot;2018-04-01T13:04:42.083123700Z&quot; /&gt;
    &lt;EventRecordID&gt;25945&lt;/EventRecordID&gt;
    &lt;Channel&gt;Application&lt;/Channel&gt;
    &lt;Computer&gt;sunshine7&lt;/Computer&gt;
    &lt;Security /&gt;
  &lt;/System&gt;
  &lt;EventData&gt;
    &lt;Data&gt;Windows (C:)&lt;/Data&gt;
    &lt;Data&gt;\\?\Volume{6a1301d0-ab28-4b33-98ca-e063ddba90bc}&lt;/Data&gt;
    &lt;Data&gt;\$BitMap::$DATA&lt;/Data&gt;
    &lt;Data&gt;0xbfbfe&lt;/Data&gt;
    &lt;Data&gt;0x7ca6b7&lt;/Data&gt;
    &lt;Data&gt;-S--D&lt;/Data&gt;
    &lt;Data&gt;&amp;lt;analysis&amp;gt;&lt;/Data&gt;
    &lt;Binary&gt;00000000D7000000BF00000000000000223679625372B2B9637B71360E00000000000000&lt;/Binary&gt;
  &lt;/EventData&gt;
&lt;/Event&gt;
</pre></div>
</div>
<div class="section" id="id11">
<h3>VSS Shadowsの一覧表示</h3>
<p>以下のコマンドで一覧を確認しました。</p>
<div class="highlight"><pre><span></span><span class="go">vssadmin list shadows</span>
</pre></div>
<p>すると先ほどイベントビューアに出ていた 6a1301d0-ab28-4b33-98ca-e063ddba90bc と一致するものが一覧に出ていました。</p>
</div>
<div class="section" id="id12">
<h3>VSS Shadowsの削除</h3>
<p>以下のコマンドで削除できました。</p>
<div class="highlight"><pre><span></span><span class="go">vssadmin delete shadows /all</span>
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h2>再度ボリュームの縮小を試すと今度は良い感じ</h2>
<p>今度は縮小可能なサイズがエクスプローラで見た空き容量と同程度になっていました。</p>
<p>ただ、一気に40GBぐらい縮小しようとしたら作業領域がないという感じのエラーになったので、20GBずつ段階を踏んで縮小したら無事できました。</p>
<p>最終的にはWindowsのパーティションを80GBにしてみました。</p>
</div>
<div class="section" id="id14">
<h2>一時的に削除していたのを戻す</h2>
<div class="section" id="id15">
<h3>ページファイルを有効にする</h3>
<div class="highlight"><pre><span></span><span class="go">wmic pagefileset create name=&quot;C:\\pagefile.sys&quot;</span>
<span class="go">wmic computersystem set AutomaticManagedPagefile=True</span>
</pre></div>
</div>
<div class="section" id="id16">
<h3>ハイバネーションを有効にする</h3>
<div class="highlight"><pre><span></span><span class="go">powercfg /h on</span>
</pre></div>
</div>
<div class="section" id="id17">
<h3>システム復元を有効にする</h3>
<div class="highlight"><pre><span></span><span class="go">Enable-ComputerRestore -Drive C:</span>
</pre></div>
<p><a class="reference external" href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/enable-computerrestore?view=powershell-5.1">Enable-ComputerRestore</a></p>
</div>
<div class="section" id="id18">
<h3>再起動</h3>
<p>「ページファイルを有効にする」、「ハイバネーションを有効にする」、「システム復元を有効にする」の3つを行った後、Windowsを再起動しました。</p>
<p>管理者権限のPowerShellで以下のコマンドを実行してハイバネーション用のファイルとページファイルが作られたことを確認します。</p>
<div class="highlight"><pre><span></span><span class="go">PS C:\WINDOWS\system32&gt; get-childitem -force -file C:\</span>
</pre></div>
<p>実行例を以下に示します。 hiberfil.sys, pagefile.sys, swapfile.sys の3つがあればOKです。</p>
<div class="highlight"><pre><span></span><span class="go">PS C:\WINDOWS\system32&gt; get-childitem -force -file C:\</span>


<span class="go">    ディレクトリ: C:\</span>


<span class="go">Mode                LastWriteTime         Length Name</span>
<span class="go">----                -------------         ------ ----</span>
<span class="go">---h--       2018/02/18     22:15           1024 AMTAG.BIN</span>
<span class="go">-a-hs-       2018/04/02      1:20     6818037760 hiberfil.sys</span>
<span class="go">-a-hs-       2018/04/02      1:20     2550136832 pagefile.sys</span>
<span class="go">-a-hs-       2018/04/02      1:20       16777216 swapfile.sys</span>
</pre></div>
</div>
</div>
<div class="section" id="id19">
<h2>おわりに</h2>
<p>ちょっと手間はかかりましたが、サードパーティのパーティションエディターソフトを使わなくてもここまで出来るということがわかったので良かったです。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>