<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.111.2">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>私のnginxのカスタムrpmとdebをビルドする手順 &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>私のnginxのカスタムrpmとdebをビルドする手順</h1>
  <time datetime=2018-04-05T08:30:00&#43;0900 class="post-date">2018-04-05</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#srpmを作成">srpmを作成</a></li>
    <li><a href="#mockコマンドを使ってローカルでビルド">mockコマンドを使ってローカルでビルド</a></li>
    <li><a href="#coprでビルド">coprでビルド</a></li>
    <li><a href="#rpmのgitレポジトリの更新とリリース作成">rpmのgitレポジトリの更新とリリース作成</a></li>
  </ul>

  <ul>
    <li><a href="#debのソースパッケージ作成">debのソースパッケージ作成</a></li>
    <li><a href="#pbuilderを使ってローカルでdebパッケージをビルド">pbuilderを使ってローカルでdebパッケージをビルド</a></li>
    <li><a href="#ppaでdebパッケージをビルド">PPAでdebパッケージをビルド</a></li>
    <li><a href="#debのgitレポジトリの更新とリリース作成">debのgitレポジトリの更新とリリース作成</a></li>
  </ul>
</nav>
  <h1 id="はじめに">はじめに</h1>
<p>nginxのカスタムrpmとdebをビルドし始めてから結構経っていますが、自分のブログ記事に散らばっている
手順をピックアップしながら毎度ビルドしているのは良くないので、自分用にまとめておきます。
なおこの手順は私の手元の環境と自作コマンドに依存しているので、他の環境でコピペしても動きません。</p>
<p>以下ではバージョン1.13.11の例をメモします。</p>
<h1 id="必要に応じてluajitのrpmをビルド">必要に応じてluajitのrpmをビルド</h1>
<p><a href="https://github.com/openresty/luajit2/releases">Releases · openresty/luajit2</a> を見て新しいリリースが出ていたら
<a href="https://github.com/hnakamur/luajit-rpm">hnakamur/luajit-rpm</a> を更新してluajitのrpmを
<a href="https://copr.fedorainfracloud.org/coprs/hnakamur/luajit/">hnakamur/luajit Copr</a> でビルドします。手順はこのnginxのrpmとほぼ同様なので省略します。</p>
<h1 id="tarballのダウンロード">tarballのダウンロード</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cd ~/nginx-deb-work
</span></span></span></code></pre></div><pre><code>    curl -LO http://nginx.org/download/nginx-1.13.11.tar.gz
</code></pre>
<p><a href="https://www.openssl.org/">https://www.openssl.org/</a> を見てOpenSSLの新しいバージョンが出ていたらそれもダウンロード。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">curl -LO https://www.openssl.org/source/openssl-1.0.2o.tar.gz
</span></span></span></code></pre></div><h1 id="nginxのrpmをビルド">nginxのrpmをビルド</h1>
<h2 id="srpmを作成">srpmを作成</h2>
<p>rpmビルドの作業用gitレポジトリで新しいバージョン用にトピックブランチ作成。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cd ~/.ghq/github.com/hnakamur/nginx-rpm
</span></span></span><span class="line"><span class="cl"><span class="go">g co -b 1_13_11
</span></span></span></code></pre></div><p>新しいtarballをSOURCESディレクトリに追加し、古いtarballはgitレポジトリから削除。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cp ~/nginx-deb-work/nginx-1.13.11.tar.gz SOURCES/
</span></span></span><span class="line"><span class="cl"><span class="go">g rm SOURCES/nginx-1.13.10.tar.gz
</span></span></span></code></pre></div><p>OpenSSLを更新する場合、新しいtarballをSOURCESディレクトリに追加し、古いtarballはgitレポジトリから削除。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cp ~/nginx-deb-work/openssl-1.0.2o.tar.gz SOURCES/
</span></span></span><span class="line"><span class="cl"><span class="go">g rm SOURCES/openssl-1.0.2n.tar.gz
</span></span></span></code></pre></div><p>サードバーティモジュールのソースをダウンロード。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">./download-module-sources.sh
</span></span></span></code></pre></div><p>上記のスクリプトから出力される各モジュールのコミットハッシュをコピー。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">%define echo_nginx_module_commit c65f5c638d0501b482fbc3ebbda9a49648022d40
</span></span><span class="line"><span class="cl">%define headers_more_nginx_module_commit a9f7c7e86cc7441d04e2f11f01c2e3a9c4b0301d
</span></span><span class="line"><span class="cl">%define lua_nginx_module_commit 91a0ad236c9661f38b78cdc99e05025f7ce5cccb
</span></span><span class="line"><span class="cl">%define lua_upstream_nginx_module_commit 6ebcda3c1ee56a73ba73f3a36f5faa7821657115
</span></span><span class="line"><span class="cl">%define memc_nginx_module_commit 66de925b7da5931badf24c7e675e2ee62c697069
</span></span><span class="line"><span class="cl">%define redis2_nginx_module_commit 4b7ff9bdf669d487efd32ac3d06d3ee981f5a2f6
</span></span><span class="line"><span class="cl">%define set_misc_nginx_module_commit 77ae35bfb00e81196d8dbae48c359e1d591a8d01
</span></span><span class="line"><span class="cl">%define srcache_nginx_module_commit 53a98806b0a24cc736d11003662e8b769c3e7eb3
</span></span><span class="line"><span class="cl">%define lua_resty_core_commit 6ea0dea70647a54c68ca02be47c3deb83b15a6ad
</span></span><span class="line"><span class="cl">%define stream_lua_nginx_module_commit a9e856564ccae54a43f27d909ce9af80064f5688
</span></span><span class="line"><span class="cl">%define ngx_cache_purge_commit 331fe43e8d9a3d1fa5e0c9fec7d3201d431a9177
</span></span><span class="line"><span class="cl">%define nginx_rtmp_module_commit 791b6136f02bc9613daf178723ac09f4df5a3bbf
</span></span><span class="line"><span class="cl">%define nginx_dav_ext_module_commit 430fd774fe838a04f1a5defbf1dd571d42300cf9
</span></span><span class="line"><span class="cl">%define ngx_http_enhanced_memcached_module_commit a9b76b6c9e0623e3ee84fecb04284dc8c91dfdb4
</span></span><span class="line"><span class="cl">%define ngx_http_secure_download_commit f379a1acf2a76f63431a12fa483d9e22e718400b
</span></span><span class="line"><span class="cl">%define ngx_devel_kit_commit a22dade76c838e5f377d58d007f65d35b5ce1df3
</span></span><span class="line"><span class="cl">%define nginx_sorted_querystring_module_commit e5bbded07fd67e2977edc2bc145c45a7b3fc4d26
</span></span><span class="line"><span class="cl">%define ngx_http_pipelog_module_commit 2503d5ef853ff2542ee7e08d898a85a7747812e5
</span></span></code></pre></div><p>rpmのスペックファイルを更新。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">vi SPECS/nginx.spec
</span></span></span></code></pre></div><ul>
<li>上記のモジュールのコミットハッシュを更新。</li>
<li>OpenSSLのバージョンを更新する場合は <code>%define ngx_openssl_version 1.0.2o</code> の値を更新。</li>
<li>nginxのバージョンの行 <code>Version: 1.13.11</code> を更新。</li>
<li><code>%changelog</code> の先頭に以下のようにエントリを追加。モジュールのバージョンリストは上記の出力をコピペした後 <code>:'&lt;,'&gt;s/%define \(.*\)_commit/- \1/</code> で置換。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">%changelog
</span></span><span class="line"><span class="cl">* Mon Apr  5 2018 Hiroaki Nakamura &lt;hnakamur@gmail.com&gt; - 1.13.11-1
</span></span><span class="line"><span class="cl">- 1.13.11
</span></span><span class="line"><span class="cl">- echo_nginx_module c65f5c638d0501b482fbc3ebbda9a49648022d40
</span></span><span class="line"><span class="cl">- headers_more_nginx_module a9f7c7e86cc7441d04e2f11f01c2e3a9c4b0301d
</span></span><span class="line"><span class="cl">- lua_nginx_module 91a0ad236c9661f38b78cdc99e05025f7ce5cccb
</span></span><span class="line"><span class="cl">- lua_upstream_nginx_module 6ebcda3c1ee56a73ba73f3a36f5faa7821657115
</span></span><span class="line"><span class="cl">- memc_nginx_module 66de925b7da5931badf24c7e675e2ee62c697069
</span></span><span class="line"><span class="cl">- redis2_nginx_module 4b7ff9bdf669d487efd32ac3d06d3ee981f5a2f6
</span></span><span class="line"><span class="cl">- set_misc_nginx_module 77ae35bfb00e81196d8dbae48c359e1d591a8d01
</span></span><span class="line"><span class="cl">- srcache_nginx_module 53a98806b0a24cc736d11003662e8b769c3e7eb3
</span></span><span class="line"><span class="cl">- lua_resty_core 6ea0dea70647a54c68ca02be47c3deb83b15a6ad
</span></span><span class="line"><span class="cl">- stream_lua_nginx_module a9e856564ccae54a43f27d909ce9af80064f5688
</span></span><span class="line"><span class="cl">- ngx_cache_purge 331fe43e8d9a3d1fa5e0c9fec7d3201d431a9177
</span></span><span class="line"><span class="cl">- nginx_rtmp_module 791b6136f02bc9613daf178723ac09f4df5a3bbf
</span></span><span class="line"><span class="cl">- nginx_dav_ext_module 430fd774fe838a04f1a5defbf1dd571d42300cf9
</span></span><span class="line"><span class="cl">- ngx_http_enhanced_memcached_module a9b76b6c9e0623e3ee84fecb04284dc8c91dfdb4
</span></span><span class="line"><span class="cl">- ngx_http_secure_download f379a1acf2a76f63431a12fa483d9e22e718400b
</span></span><span class="line"><span class="cl">- ngx_devel_kit a22dade76c838e5f377d58d007f65d35b5ce1df3
</span></span><span class="line"><span class="cl">- nginx_sorted_querystring_module e5bbded07fd67e2977edc2bc145c45a7b3fc4d26
</span></span><span class="line"><span class="cl">- ngx_http_pipelog_module 2503d5ef853ff2542ee7e08d898a85a7747812e5
</span></span></code></pre></div><p>rpmビルドの作業用gitレポジトリに変更内容をコミット。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g a .
</span></span></span><span class="line"><span class="cl"><span class="go">g ci -m &#39;Update nginx to 1.13.11 and also update modules&#39;
</span></span></span></code></pre></div><p>srpmを作成。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mkdir ~/rpmbuild/SOURCES/nginx-1.13.10-1.ngx
</span></span></span><span class="line"><span class="cl"><span class="go">ln -s $PWD/SOURCES/* !$
</span></span></span><span class="line"><span class="cl"><span class="go">rpmbuild -bs SPECS/nginx.spec
</span></span></span></code></pre></div><p>ここで以下のように <code>warning: bogus date in %changelog</code> と出た場合は日付と曜日が不一致なので修正して
<code>g ci --amend -m 'Update nginx to 1.13.11 and also update modules' .</code> でコミットした後やり直す。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-rpm$ rpmbuild -bs SPECS/nginx.spec
</span></span></span><span class="line"><span class="cl"><span class="go">warning: bogus date in %changelog: Mon Apr  5 2018 Hiroaki Nakamura &lt;hnakamur@gmail.com&gt; - 1.13.11-1
</span></span></span><span class="line"><span class="cl"><span class="go">Wrote: /home/hnakamur/rpmbuild/SRPMS/nginx-1.13.11-1.ngx.src.rpm
</span></span></span></code></pre></div><h2 id="mockコマンドを使ってローカルでビルド">mockコマンドを使ってローカルでビルド</h2>
<p>mockコマンドを使ってローカルでビルド。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">/usr/bin/mock -r epel-7-x86_64-with-luajit --resultdir=~hnakamur/mockresult-nginx-1.13.11-1 --rebuild ~/rpmbuild/SRPMS/nginx-1.13.11-1.ngx.src.rpm
</span></span></span></code></pre></div><p>うまくビルドできたときは <code>~/mockresult-nginx-1.13.11-1/</code> 以下に生成された <code>*.rpm</code> をCentOS7の環境にコピーして <code>yum install -y nginx*.x86_64.rpm</code> でインストールして動作確認します。
ビルド失敗した場合はこのディレクトリの <code>build.log</code> を見てエラーの内容を確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-rpm$ ls -lt ~/mockresult-nginx-1.13.11-1/
</span></span></span><span class="line"><span class="cl"><span class="go">total 20748
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-rw-r-- 1 hnakamur hnakamur  116664 Apr  5 09:05 root.log
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-rw-r-- 1 hnakamur hnakamur    1610 Apr  5 09:05 state.log
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-rw-r-- 1 hnakamur hnakamur 1643094 Apr  5 09:05 build.log
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-rw-r-- 1 hnakamur mock     4617220 Apr  5 09:05 nginx-debuginfo-1.13.11-1.el7.centos.ngx.x86_64.rpm
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-rw-r-- 1 hnakamur mock     3681552 Apr  5 09:05 nginx-1.13.11-1.el7.centos.ngx.x86_64.rpm
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-rw-r-- 1 hnakamur mock       14935 Apr  5 08:59 installed_pkgs
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-rw-r-- 1 hnakamur mock     8356143 Apr  5 08:58 nginx-1.13.11-1.el7.centos.ngx.src.rpm
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-rw-r-- 1 root     root     2793745 Apr  5 08:58 available_pkgs
</span></span></span></code></pre></div><h2 id="coprでビルド">coprでビルド</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">copr-cli build hnakamur/nginx ~/mockresult-nginx-1.13.11-1/nginx-1.13.11-1.el7.centos.ngx.src.rpm
</span></span></span></code></pre></div><p>ビルドが完了したら
<a href="https://copr.fedorainfracloud.org/coprs/hnakamur/nginx/">hnakamur/nginx Copr</a> のレポジトリを追加しているテスト環境にてnginxを更新して動作確認します。</p>
<h2 id="rpmのgitレポジトリの更新とリリース作成">rpmのgitレポジトリの更新とリリース作成</h2>
<p>今回のトピックブランチをgithubにプッシュ。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g push origin 1_13_11
</span></span></span></code></pre></div><p><a href="https://github.com/hnakamur/nginx-rpm">hnakamur/nginx-rpm</a> でプルリクエストを作成してマージ。</p>
<p>ローカルのmasterブランチを更新してトピックブランチを削除。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g f
</span></span></span><span class="line"><span class="cl"><span class="go">g co master
</span></span></span><span class="line"><span class="cl"><span class="go">g me origin/master --ff
</span></span></span><span class="line"><span class="cl"><span class="go">g delete-merged-branches
</span></span></span></code></pre></div><p>タグを作成してプッシュ。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g tag 1.13.11-1
</span></span></span><span class="line"><span class="cl"><span class="go">g push origin !$
</span></span></span></code></pre></div><p>coprでビルドされたrpmをダウンロードし、githubレポジトリにリリースを作成してアップロード。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">copr-files-downloader -user hnakamur -repo nginx -dest ./tmp
</span></span></span><span class="line"><span class="cl"><span class="go">cd ./tmp
</span></span></span><span class="line"><span class="cl"><span class="go">github-release release --user hnakamur --repo nginx-rpm --tag 1.13.11-1
</span></span></span><span class="line"><span class="cl"><span class="go">for i in $(ls); do github-release upload --user hnakamur --repo nginx-rpm --tag 1.13.11-1 --name $i --file $i; done
</span></span></span><span class="line"><span class="cl"><span class="go">cd ..
</span></span></span><span class="line"><span class="cl"><span class="go">rm -r ./tmp
</span></span></span></code></pre></div><h1 id="nginxのdebをビルド">nginxのdebをビルド</h1>
<h2 id="debのソースパッケージ作成">debのソースパッケージ作成</h2>
<p>debビルドの作業用gitレポジトリで新しいtarballを取り込む。 <code>gbp import-orig</code> の <code>--pristine-tar</code> オプションを忘れないこと。これを忘れると後でソースパッケージをビルドする時にoriginのtarballがgitレポジトリから再構築され、後ほどPPAでビルドする時になってoriginのtarballが既に他のレポジトリでアップロードされていると同じファイル名で中身が一致しなくてエラーになってしまう。ただしこのnginxのパッケージの場合はサードパーティのモジュールを追加したものがoriginのtarballなので他でアップロードされていることはないので実はたぶん問題ない。が、他のパッケージで実際にハマったので、結論としては <code>--pristine-tar</code> 重要。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cd ~/.ghq/github.com/hnakamur/nginx-deb
</span></span></span><span class="line"><span class="cl"><span class="go">gbp import-orig --pristine-tar -u 1.13.11 ~/nginx-deb-work/nginx-1.13.11.tar.gz
</span></span></span></code></pre></div><p>サードバーティモジュールのソースをダウンロード。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g co upstream
</span></span></span><span class="line"><span class="cl"><span class="go">../download-module-sources.sh
</span></span></span></code></pre></div><p>上記のスクリプトの出力をコピーしておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">openresty/echo-nginx-module c65f5c638d0501b482fbc3ebbda9a49648022d40
</span></span><span class="line"><span class="cl">openresty/headers-more-nginx-module a9f7c7e86cc7441d04e2f11f01c2e3a9c4b0301d
</span></span><span class="line"><span class="cl">openresty/lua-nginx-module 91a0ad236c9661f38b78cdc99e05025f7ce5cccb
</span></span><span class="line"><span class="cl">openresty/lua-upstream-nginx-module 6ebcda3c1ee56a73ba73f3a36f5faa7821657115
</span></span><span class="line"><span class="cl">openresty/memc-nginx-module 66de925b7da5931badf24c7e675e2ee62c697069
</span></span><span class="line"><span class="cl">openresty/redis2-nginx-module 4b7ff9bdf669d487efd32ac3d06d3ee981f5a2f6
</span></span><span class="line"><span class="cl">openresty/set-misc-nginx-module 77ae35bfb00e81196d8dbae48c359e1d591a8d01
</span></span><span class="line"><span class="cl">openresty/srcache-nginx-module 53a98806b0a24cc736d11003662e8b769c3e7eb3
</span></span><span class="line"><span class="cl">openresty/lua-resty-core 6ea0dea70647a54c68ca02be47c3deb83b15a6ad
</span></span><span class="line"><span class="cl">openresty/stream-lua-nginx-module a9e856564ccae54a43f27d909ce9af80064f5688
</span></span><span class="line"><span class="cl">FRiCKLE/ngx_cache_purge 331fe43e8d9a3d1fa5e0c9fec7d3201d431a9177
</span></span><span class="line"><span class="cl">arut/nginx-rtmp-module 791b6136f02bc9613daf178723ac09f4df5a3bbf
</span></span><span class="line"><span class="cl">arut/nginx-dav-ext-module 430fd774fe838a04f1a5defbf1dd571d42300cf9
</span></span><span class="line"><span class="cl">bpaquet/ngx_http_enhanced_memcached_module a9b76b6c9e0623e3ee84fecb04284dc8c91dfdb4
</span></span><span class="line"><span class="cl">replay/ngx_http_secure_download f379a1acf2a76f63431a12fa483d9e22e718400b
</span></span><span class="line"><span class="cl">simplresty/ngx_devel_kit a22dade76c838e5f377d58d007f65d35b5ce1df3
</span></span><span class="line"><span class="cl">wandenberg/nginx-sorted-querystring-module e5bbded07fd67e2977edc2bc145c45a7b3fc4d26
</span></span><span class="line"><span class="cl">pandax381/ngx_http_pipelog_module 2503d5ef853ff2542ee7e08d898a85a7747812e5
</span></span></code></pre></div><p>upstreamモジュールにサードパーティのモジュールのソースを追加しコミットします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g a .
</span></span></span><span class="line"><span class="cl"><span class="go">g ci
</span></span></span></code></pre></div><p>コミットメッセージは以下のようにします。モジュールのコミットハッシュをペーストする前にvimで <code>:paste</code> を実行しておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Add module sources
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">openresty/echo-nginx-module c65f5c638d0501b482fbc3ebbda9a49648022d40
</span></span><span class="line"><span class="cl">openresty/headers-more-nginx-module a9f7c7e86cc7441d04e2f11f01c2e3a9c4b0301d
</span></span><span class="line"><span class="cl">openresty/lua-nginx-module 91a0ad236c9661f38b78cdc99e05025f7ce5cccb
</span></span><span class="line"><span class="cl">openresty/lua-upstream-nginx-module 6ebcda3c1ee56a73ba73f3a36f5faa7821657115
</span></span><span class="line"><span class="cl">openresty/memc-nginx-module 66de925b7da5931badf24c7e675e2ee62c697069
</span></span><span class="line"><span class="cl">openresty/redis2-nginx-module 4b7ff9bdf669d487efd32ac3d06d3ee981f5a2f6
</span></span><span class="line"><span class="cl">openresty/set-misc-nginx-module 77ae35bfb00e81196d8dbae48c359e1d591a8d01
</span></span><span class="line"><span class="cl">openresty/srcache-nginx-module 53a98806b0a24cc736d11003662e8b769c3e7eb3
</span></span><span class="line"><span class="cl">openresty/lua-resty-core 6ea0dea70647a54c68ca02be47c3deb83b15a6ad
</span></span><span class="line"><span class="cl">openresty/stream-lua-nginx-module a9e856564ccae54a43f27d909ce9af80064f5688
</span></span><span class="line"><span class="cl">FRiCKLE/ngx_cache_purge 331fe43e8d9a3d1fa5e0c9fec7d3201d431a9177
</span></span><span class="line"><span class="cl">arut/nginx-rtmp-module 791b6136f02bc9613daf178723ac09f4df5a3bbf
</span></span><span class="line"><span class="cl">arut/nginx-dav-ext-module 430fd774fe838a04f1a5defbf1dd571d42300cf9
</span></span><span class="line"><span class="cl">bpaquet/ngx_http_enhanced_memcached_module a9b76b6c9e0623e3ee84fecb04284dc8c91dfdb4
</span></span><span class="line"><span class="cl">replay/ngx_http_secure_download f379a1acf2a76f63431a12fa483d9e22e718400b
</span></span><span class="line"><span class="cl">simplresty/ngx_devel_kit a22dade76c838e5f377d58d007f65d35b5ce1df3
</span></span><span class="line"><span class="cl">wandenberg/nginx-sorted-querystring-module e5bbded07fd67e2977edc2bc145c45a7b3fc4d26
</span></span><span class="line"><span class="cl">pandax381/ngx_http_pipelog_module 2503d5ef853ff2542ee7e08d898a85a7747812e5
</span></span></code></pre></div><p>upstreamブランチにタグを打ちます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g tag upstream/1.13.11+mod.1
</span></span></span></code></pre></div><p>masterブランチに切り替えてupstreamブランチの内容をマージします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g co master
</span></span></span><span class="line"><span class="cl"><span class="go">g pull --no-edit . upstream
</span></span></span></code></pre></div><p><code>debian/patches/*</code> のパッチがnginxの新しいバージョンでも問題なく当たるか確認します。
パッチがうまく当たらないときはパッチを適宜調整します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">gbp pq rebase
</span></span></span><span class="line"><span class="cl"><span class="go">gbp pq export
</span></span></span></code></pre></div><p>実行例。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$ gbp pq rebase
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Switching to &#39;patch-queue/master&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">First, rewinding head to replay your work on top of it...
</span></span></span><span class="line"><span class="cl"><span class="go">Applying: Make replay/ngx_http_secure_download as dynamic module as well
</span></span></span><span class="line"><span class="cl"><span class="go">Applying: Convert a config file to build a dynamic module
</span></span></span><span class="line"><span class="cl"><span class="go">Applying: Fix compatibility with nginx-1.11.6+
</span></span></span><span class="line"><span class="cl"><span class="go">Applying: feat(purge all): Include option to purge all the cached files
</span></span></span><span class="line"><span class="cl"><span class="go">Applying: feat(partial keys): Support partial keys to purge multiple keys.
</span></span></span><span class="line"><span class="cl"><span class="go">Applying: added cache_purge_response_type directive, selecting a response type (html|json|xml|text)
</span></span></span><span class="line"><span class="cl"><span class="go">Applying: SSL: handled SSL_CTX_set_cert_cb() callback yielding.
</span></span></span><span class="line"><span class="cl"><span class="go">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$ gbp pq export
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: On &#39;patch-queue/master&#39;, switching to &#39;master&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Generating patches from git (master..patch-queue/master)
</span></span></span><span class="line"><span class="cl"><span class="go">On branch master
</span></span></span><span class="line"><span class="cl"><span class="go">nothing to commit, working tree clean
</span></span></span></code></pre></div><p><code>debian/changelog</code> の先頭にエントリを追加します。
以下のコマンドを実行すると前バージョンのタグ以降のコミットのコミットメッセージを並べて自動的にコミットメッセージを入力した状態で <code>debian/changelog</code> を開いてくれます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">gbp dch -R
</span></span></span></code></pre></div><p>前バージョンのタグをうまく見つけられなかったときは以下のようなエラーになります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$ gbp dch -R
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:error: Version 1.13.10+mod.1-1ubuntu1ppa1~ubuntu16.04.1 not found
</span></span></span></code></pre></div><p>この場合は <code>--since</code> オプションで前バージョンのタグを指定して実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">gbp dch -R --since=debian/1.13.10+mod.1-1ubuntu1ppa1-ubuntu16.04.1
</span></span></span></code></pre></div><p>今回の例では <code>debian/changelog</code> の先頭に以下のようにエントリが追加された状態で vim で開かれました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">nginx (1.13.11-1) xenial; urgency=medium
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  * Imported Upstream version 1.13.11
</span></span><span class="line"><span class="cl">  * Add module sources
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Thu, 05 Apr 2018 09:20:05 +0900
</span></span></code></pre></div><p>これを以下のように変更します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">nginx (1.13.11+mod.1-1ubuntu1ppa1~ubuntu16.04.1) xenial; urgency=medium
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  * Imported Upstream version 1.13.11
</span></span><span class="line"><span class="cl">  * Add module sources
</span></span><span class="line"><span class="cl">  * openresty/echo-nginx-module c65f5c638d0501b482fbc3ebbda9a49648022d40
</span></span><span class="line"><span class="cl">  * openresty/headers-more-nginx-module a9f7c7e86cc7441d04e2f11f01c2e3a9c4b0301d
</span></span><span class="line"><span class="cl">  * openresty/lua-nginx-module 91a0ad236c9661f38b78cdc99e05025f7ce5cccb
</span></span><span class="line"><span class="cl">  * openresty/lua-upstream-nginx-module 6ebcda3c1ee56a73ba73f3a36f5faa7821657115
</span></span><span class="line"><span class="cl">  * openresty/memc-nginx-module 66de925b7da5931badf24c7e675e2ee62c697069
</span></span><span class="line"><span class="cl">  * openresty/redis2-nginx-module 4b7ff9bdf669d487efd32ac3d06d3ee981f5a2f6
</span></span><span class="line"><span class="cl">  * openresty/set-misc-nginx-module 77ae35bfb00e81196d8dbae48c359e1d591a8d01
</span></span><span class="line"><span class="cl">  * openresty/srcache-nginx-module 53a98806b0a24cc736d11003662e8b769c3e7eb3
</span></span><span class="line"><span class="cl">  * openresty/lua-resty-core 6ea0dea70647a54c68ca02be47c3deb83b15a6ad
</span></span><span class="line"><span class="cl">  * openresty/stream-lua-nginx-module a9e856564ccae54a43f27d909ce9af80064f5688
</span></span><span class="line"><span class="cl">  * FRiCKLE/ngx_cache_purge 331fe43e8d9a3d1fa5e0c9fec7d3201d431a9177
</span></span><span class="line"><span class="cl">  * arut/nginx-rtmp-module 791b6136f02bc9613daf178723ac09f4df5a3bbf
</span></span><span class="line"><span class="cl">  * arut/nginx-dav-ext-module 430fd774fe838a04f1a5defbf1dd571d42300cf9
</span></span><span class="line"><span class="cl">  * bpaquet/ngx_http_enhanced_memcached_module a9b76b6c9e0623e3ee84fecb04284dc8c91dfdb4
</span></span><span class="line"><span class="cl">  * replay/ngx_http_secure_download f379a1acf2a76f63431a12fa483d9e22e718400b
</span></span><span class="line"><span class="cl">  * simplresty/ngx_devel_kit a22dade76c838e5f377d58d007f65d35b5ce1df3
</span></span><span class="line"><span class="cl">  * wandenberg/nginx-sorted-querystring-module e5bbded07fd67e2977edc2bc145c45a7b3fc4d26
</span></span><span class="line"><span class="cl">  * pandax381/ngx_http_pipelog_module 2503d5ef853ff2542ee7e08d898a85a7747812e5
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Thu, 05 Apr 2018 09:20:05 +0900
</span></span></code></pre></div><p><code>debian/changelog</code> の変更をコミットしてタグを打ちます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g ci . -m &#39;Release 1.13.11.mod.1-1ubuntu1ppa1~ubuntu16.04.1&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">g tag debian/1.13.11+mod.1-1ubuntu1ppa1-ubuntu16.04.1
</span></span></span></code></pre></div><h2 id="pbuilderを使ってローカルでdebパッケージをビルド">pbuilderを使ってローカルでdebパッケージをビルド</h2>
<p>debのソースパッケージをビルドします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">gbp buildpackage --git-export-dir=../build-area -p/home/hnakamur/bin/gpg-passphrase -S -sa
</span></span></span></code></pre></div><p><code>pbuilder</code> を使ってdebパッケージをビルドします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo pbuilder build ../build-area/nginx_1.13.11+mod.1-1ubuntu1ppa1~ubuntu16.04.1.dsc
</span></span></span></code></pre></div><p>無事にビルドが終わったら <code>/var/cache/pbuilder/result/nginx*1.13.11*</code> にdebパッケージが作られます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$ ls -lt /var/cache/pbuilder/result/nginx*1.13.11*
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 hnakamur hnakamur     3639 Apr  5 09:36 /var/cache/pbuilder/result/nginx_1.13.11+mod.1-1ubuntu1ppa1~ubuntu16.04.1_amd64.changes
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 hnakamur hnakamur 13551210 Apr  5 09:36 /var/cache/pbuilder/result/nginx-dbg_1.13.11+mod.1-1ubuntu1ppa1~ubuntu16.04.1_amd64.deb
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 hnakamur hnakamur  1215456 Apr  5 09:36 /var/cache/pbuilder/result/nginx_1.13.11+mod.1-1ubuntu1ppa1~ubuntu16.04.1_amd64.deb
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 hnakamur hnakamur     1185 Apr  5 09:32 /var/cache/pbuilder/result/nginx_1.13.11+mod.1-1ubuntu1ppa1~ubuntu16.04.1.dsc
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 hnakamur hnakamur   120532 Apr  5 09:32 /var/cache/pbuilder/result/nginx_1.13.11+mod.1-1ubuntu1ppa1~ubuntu16.04.1.debian.tar.xz
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 hnakamur hnakamur  2913781 Apr  5 09:28 /var/cache/pbuilder/result/nginx_1.13.11+mod.1.orig.tar.gz
</span></span></span></code></pre></div><p>作られたdebパッケージをfreightのローカルdebレポジトリに追加します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">pushd /var/www/html/my-debs
</span></span></span><span class="line"><span class="cl"><span class="go">sudo freight add /var/cache/pbuilder/result/nginx*1.13.11*.deb apt/xenial
</span></span></span><span class="line"><span class="cl"><span class="go">sudo freight cache -p /home/hnakamur/.gpg-passphrase apt/xenial
</span></span></span><span class="line"><span class="cl"><span class="go">popd
</span></span></span></code></pre></div><p>テスト用のUbuntu環境にてfreightのdebレポジトリからnginxを更新します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo apt update
</span></span></span><span class="line"><span class="cl"><span class="go">sudo apt upgrade -y nginx
</span></span></span></code></pre></div><h2 id="ppaでdebパッケージをビルド">PPAでdebパッケージをビルド</h2>
<p>動作確認して問題なければPPAでdebパッケージをビルドします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">dput ppa:hnakamur/nginx ../build-area/nginx_1.13.11+mod.1-1ubuntu1ppa1~ubuntu16.04.1_source.changes
</span></span></span></code></pre></div><p><a href="https://launchpad.net/~hnakamur/+archive/ubuntu/nginx/+packages">Packages in “nginx with thirdparty modules” : nginx with thirdparty modules : Hiroaki Nakamura</a> でこのバージョンのBuild Statusの列が緑のチェックマークになるまで待ちます（時計や緑の歯車のときはまだです）。</p>
<p>無事ビルドが完了したら <a href="https://launchpad.net/~hnakamur/+archive/ubuntu/nginx">nginx with thirdparty modules : Hiroaki Nakamura</a> のレポジトリを追加してあるテスト環境にてnginxを更新して動作確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo apt update
</span></span></span><span class="line"><span class="cl"><span class="go">sudo apt upgrade -y nginx
</span></span></span></code></pre></div><h2 id="debのgitレポジトリの更新とリリース作成">debのgitレポジトリの更新とリリース作成</h2>
<p>ローカルのgitレポジトリでの変更をgithubに反映します。</p>
<p>一旦以下のコマンドでプッシュを試みます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g push origin --all
</span></span></span></code></pre></div><p><code>patch-queue</code> ブランチがconflictする場合は、乱暴ですが <code>-f</code> つきで再度プッシュします。まあ、 <code>patch-queue</code> は一時的な作業用ブランチなのとこのgitレポジトリはチームではなく一人作業用なのでよしということで。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g push origin --all -f
</span></span></span></code></pre></div><p>タグもプッシュします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">g push origin --tags
</span></span></span></code></pre></div><p>PPAでビルドされたrpmをダウンロードし、githubレポジトリにリリースを作成してアップロード。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ppa-files-downloader -user hnakamur -repo nginx -pkg nginx -dest ./tmp
</span></span></span><span class="line"><span class="cl"><span class="go">cd ./tmp
</span></span></span><span class="line"><span class="cl"><span class="go">github-release release --user hnakamur --repo nginx-deb --tag debian/1.13.11+mod.1-1ubuntu1ppa1-ubuntu16.04.1
</span></span></span><span class="line"><span class="cl"><span class="go">for i in $(ls); do github-release upload --user hnakamur --repo nginx-deb --tag debian/1.13.11+mod.1-1ubuntu1ppa1-ubuntu16.04.1 --name $i --file $i; done
</span></span></span><span class="line"><span class="cl"><span class="go">cd ..
</span></span></span><span class="line"><span class="cl"><span class="go">rm -r ./tmp
</span></span></span></code></pre></div>
</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
