<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>go1.10rc1のdebパッケージを作ったときのメモ</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/01/27/build-go-1.10rc1-deb/" rel="bookmark"
           title="Permalink to go1.10rc1のdebパッケージを作ったときのメモ">go1.10rc1のdebパッケージを作ったときのメモ</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-01-27T10:00:00+09:00">
                Published: 2018-01-27
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/go.html">go</a> <a href="../../../../tag/deb.html">deb</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="/blog/2017/08/05/built-golang-1.9rc1-deb-package/">golang 1.9rc1のUbuntu 16.04用debパッケージをビルドした</a> 以降go1.9.xのdebパッケージを <a class="reference external" href="https://honk.sigxcpu.org/piki/projects/git-buildpackage/">git-buildpackage</a> で作っていましたが、今回 go1.10rc1 をビルドしたのでメモです。</p>
<p>上の記事ではよくわかっていなかったので手順に無駄がありましたが、今回は現状の私の理解での最適な手順を書きました。ビルドするところまでは。</p>
<p>ビルドが失敗して手直ししたのでそこは記録として残しておきます。</p>
</div>
<div class="section" id="x">
<h2>1.10.x用のブランチ作成</h2>
<div class="highlight"><pre><span></span><span class="go">git branch ubuntu-1.10 ubuntu-1.9</span>
<span class="go">git branch upstream-1.10 upstream-1.9</span>
</pre></div>
</div>
<div class="section" id="rc1tarball">
<h2>1.10rc1のtarballをダウンロード</h2>
<div class="highlight"><pre><span></span><span class="go">mkdir -p ~/go-deb-work</span>
<span class="go">cd ~/go-deb-work</span>
<span class="go">curl -LO https://dl.google.com/go/go1.10rc1.src.tar.gz</span>
</pre></div>
</div>
<div class="section" id="id2">
<h2>ビルド対象を1.10.xに切り替え</h2>
<div class="highlight"><pre><span></span><span class="go">cd ~/.ghq/github.com/hnakamur/golang-deb</span>
<span class="go">git checkout ubuntu-1.10</span>
<span class="go">vi debian/changelog</span>
</pre></div>
<p>先頭に以下の内容を追加。</p>
<div class="highlight"><pre><span></span>golang-1.10 (1.10~rc1-1ubuntu1~hnakamur1) xenial; urgency=medium

  * Imported Upstream version 1.10rc1

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Fri, 26 Jan 2018 22:53:00 +0900
</pre></div>
<div class="highlight"><pre><span></span><span class="go">git commit -m &#39;Release 1.10~rc1-1ubuntu1~hnakamur1&#39; debian/changelog</span>
</pre></div>
<p><code>debian/changelog</code> の先頭のエントリの <code>golang-1.10</code> の部分を元に
<code>debian/gbp.conf</code> などのファイルを上書き生成します。</p>
<div class="highlight"><pre><span></span><span class="go">./debian/rules gencontrol</span>
</pre></div>
<p>生成された debian/gbp.conf の内容を確認。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> cat debian/gbp.conf
<span class="gp">#</span>
<span class="gp">#</span> WARNING: <span class="s2">&quot;debian/gbp.conf&quot;</span> is generated via <span class="s2">&quot;debian/rules gencontrol&quot;</span> <span class="o">(</span>sourced from <span class="s2">&quot;debian/gbp.conf.in&quot;</span><span class="o">)</span>
<span class="gp">#</span>

<span class="go">[DEFAULT]</span>
<span class="go">debian-branch = ubuntu-1.10</span>
<span class="go">debian-tag = debian/%(version)s</span>
<span class="go">upstream-branch = upstream-1.10</span>
<span class="go">upstream-tag = upstream/%(version)s</span>
<span class="go">pristine-tar = True</span>

<span class="go">[dch]</span>
<span class="go">meta = 1</span>
</pre></div>
<p>他に以下のファイルも生成されていました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git status -s
<span class="go"> M debian/control</span>
<span class="go"> M debian/gbp.conf</span>
<span class="go"> M debian/source/lintian-overrides</span>
<span class="go"> M debian/watch</span>
</pre></div>
<p>変更されたファイルをコミットします。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git commit -m <span class="s1">&#39;Switch to go1.10.x&#39;</span> debian/
</pre></div>
</div>
<div class="section" id="id3">
<h2>1.10rc1のtarballをインポート</h2>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp import-orig --no-interactive -u1.10~rc1 ~/go-deb-work/go1.10rc1.src.tar.gz
<span class="go">gbp:info: Importing &#39;/home/hnakamur/go-deb-work/go1.10rc1.src.tar.gz&#39; to branch &#39;upstream-1.10&#39;...</span>
<span class="go">gbp:info: Source package is golang-1.10</span>
<span class="go">gbp:info: Upstream version is 1.10~rc1</span>
<span class="go">gbp:info: Merging to &#39;ubuntu-1.10&#39;</span>
<span class="go">gbp:info: Successfully imported version 1.10~rc1 of /home/hnakamur/go-deb-work/go1.10rc1.src.tar.gz</span>
</pre></div>
<p>これで以下の4つが実行されていました。</p>
<ul class="simple">
<li><code>pristine-tar</code> ブランチに 1.10rc1 用のコミットが追加された。</li>
<li><code>upstream-1.10</code> ブランチに 1.10rc1 をインポートしたコミットが追加された。</li>
<li>上記のコミットに <code>upstream/1.10_rc1</code> というタグが打たれた。</li>
<li><code>ubuntu-1.10</code> ブランチに <code>upstream-1.10</code> ブランチの内容がマージされた。</li>
</ul>
</div>
<div class="section" id="rc1">
<h2>1.10rc1のソースパッケージを作成</h2>
<p>以下のコマンドでソースパッケージを作成します。</p>
<div class="highlight"><pre><span></span><span class="go">gbp buildpackage --git-export-dir=../build-area -S -sa -p/home/hnakamur/bin/gpg-passphrase</span>
</pre></div>
<p>最後の <code>-p</code> オプションは <a class="reference external" href="/blog/2017/08/28/use-passphrase-file-in-git-buildpackage-and-freight/">git-buildpacakgeとfreightでパスフレーズをファイルから入力させる</a> にメモした通りパスフレーズを自動入力するためのものです。</p>
</div>
<div class="section" id="rc1deb">
<h2>1.10rc1のdebパッケージをローカルでビルド</h2>
<div class="highlight"><pre><span></span><span class="go">sudo pbuilder build ../build-area/golang-1.10_1.10~rc1-1ubuntu1~hnakamur1.dsc</span>
</pre></div>
</div>
<div class="section" id="id4">
<h2>ビルド失敗</h2>
<p>これで無事ビルドできるかと思いきや以下のようなエラーが出てビルド失敗しました。</p>
<div class="highlight"><pre><span></span>Building packages and commands for linux/amd64.
/build/golang-1.10-1.10~rc1/bin/go install -v -buildmode=shared \
        -ldflags &#39;-extldflags &quot;-Wl,-soname=libgolang-1.10-std.so.1&quot;&#39; \
        std
initializing cache in $GOCACHE: mkdir /nonexistent: permission denied
debian/rules:115: recipe for target &#39;override_dh_auto_build-arch&#39; failed
make[1]: *** [override_dh_auto_build-arch] Error 1
make[1]: Leaving directory &#39;/build/golang-1.10-1.10~rc1&#39;
debian/rules:26: recipe for target &#39;build&#39; failed
make: *** [build] Error 2
dpkg-buildpackage: error: debian/rules build gave error exit status 2
I: copying local configuration
E: Failed autobuilding of package
I: user script /var/cache/pbuilder/build/8740/tmp/hooks/C10shell starting
</pre></div>
<p>go1.10rc1のソースを見てみました。
<a class="reference external" href="https://github.com/golang/go/blob/go1.10rc1/src/cmd/go/internal/cache/default.go#L35-L55">https://github.com/golang/go/blob/go1.10rc1/src/cmd/go/internal/cache/default.go#L35-L55</a>
上記の <code>initializing cache in $GOCACHE: mkdir /nonexistent: permission denied</code>
のエラーは以下の43行目で出ているようです。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// initDefaultCache does the work of finding the default cache</span>
<span class="c1">// the first time Default is called.</span>
<span class="kd">func</span> <span class="nx">initDefaultCache</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">dir</span> <span class="o">:=</span> <span class="nx">DefaultDir</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">dir</span> <span class="o">==</span> <span class="s">&quot;off&quot;</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">MkdirAll</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="mo">0777</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">base</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;initializing cache in $GOCACHE: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="s">&quot;README&quot;</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="c1">// Best effort.</span>
        <span class="nx">ioutil</span><span class="p">.</span><span class="nx">WriteFile</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="s">&quot;README&quot;</span><span class="p">),</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">cacheREADME</span><span class="p">),</span> <span class="mo">0666</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">Open</span><span class="p">(</span><span class="nx">dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">base</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;initializing cache in $GOCACHE: %s&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">defaultCache</span> <span class="p">=</span> <span class="nx">c</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>debian/rules:115: recipe for target 'override_dh_auto_build-arch' failed</code>
のエラーに対応する <code>debian/rules</code> の 115行目あたりは以下のようになっていました。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>114
115
116
117
118
119
120
121
122</pre></div></td><td class="code"><div class="highlight"><pre><span></span>override_dh_auto_build-arch:
        [ -f VERSION ] || echo &quot;debian snapshot +$$(dpkg-parsechangelog -SVersion)&quot; &gt; VERSION
        export GOROOT_BOOTSTRAP=$$(env -i go env GOROOT) \
                &amp;&amp; cd src \
                &amp;&amp; $(CURDIR)/debian/helpers/goenv.sh \
                        bash ./make.bash --no-banner
        $(CURDIR)/bin/go install -v -buildmode=shared \
                -ldflags &#39;-extldflags &quot;-Wl,-soname=libgolang-$(GOVER)-std.so.1&quot;&#39; \
                std
</pre></div>
</td></tr></table><p><code>debian/rules</code> の先頭のほうを見ると <code>GOROOT</code> と <code>GOROOT_FINAL</code> という環境変数が設定されていました。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>export GOROOT := $(CURDIR)
export GOROOT_FINAL := /usr/lib/go-$(GOVER)
</pre></div>
</td></tr></table><p>ここに <code>GOCACHE</code> の設定を追加して試してみたら行けたりしないかな、と例によって雰囲気で思いついて以下のように変更して試してみました。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>7
8
9</pre></div></td><td class="code"><div class="highlight"><pre><span></span>export GOROOT := $(CURDIR)
export GOCACHE := $(CURDIR)
export GOROOT_FINAL := /usr/lib/go-$(GOVER)
</pre></div>
</td></tr></table><p>上記のビルド失敗の出力で
<code>I: user script /var/cache/pbuilder/build/8740/tmp/hooks/C10shell starting</code>
と出ているのは
<a class="reference external" href="/blog/2017/09/02/add-repositories-to-pbuilder-chroot-images/">pbuilderのchroot環境にレポジトリを追加する</a>
の「ビルド時にエラーになったときに chroot 環境に入る設定」の項の設定をしていたからです。</p>
<p>そこで chroot 環境内で <code>debian/rules</code> を上記のように書き換えて、以下のコマンドで再度ビルドを試みました。</p>
<div class="highlight"><pre><span></span><span class="go">debian/rules build</span>
</pre></div>
<p>今度は先ほどひっかかっていた箇所は無事通ってビルドは終わったのですが、その後のテストでひっかかってしまいました。</p>
<div class="highlight"><pre><span></span>make[1]: Entering directory &#39;/build/golang-1.10-1.10~rc1&#39;
set -ex; \
        cd src; \
        export PATH=&quot;/build/golang-1.10-1.10~rc1/bin:$PATH&quot;; \
        eval &quot;$(go tool dist env)&quot;; \
        bash run.bash -k -no-rebuild;
+ cd src
+ export PATH=/build/golang-1.10-1.10~rc1/bin:/usr/sbin:/usr/bin:/sbin:/bin
+ go tool dist env
+ eval GOROOT=&quot;/build/golang-1.10-1.10~rc1&quot;
GOBIN=&quot;/build/golang-1.10-1.10~rc1/bin&quot;
GOARCH=&quot;amd64&quot;
GOOS=&quot;linux&quot;
GOHOSTARCH=&quot;amd64&quot;
GOHOSTOS=&quot;linux&quot;
GOTOOLDIR=&quot;/build/golang-1.10-1.10~rc1/pkg/tool/linux_amd64&quot;
+ GOROOT=/build/golang-1.10-1.10~rc1
+ GOBIN=/build/golang-1.10-1.10~rc1/bin
+ GOARCH=amd64
+ GOOS=linux
+ GOHOSTARCH=amd64
+ GOHOSTOS=linux
+ GOTOOLDIR=/build/golang-1.10-1.10~rc1/pkg/tool/linux_amd64
+ bash run.bash -k -no-rebuild

##### Testing packages.
ok      archive/tar     0.044s
ok      archive/zip     1.872s
ok      bufio   0.047s
ok      bytes   0.595s
ok      compress/bzip2  0.058s
ok      compress/flate  0.834s
ok      compress/gzip   0.009s
ok      compress/lzw    0.005s
ok      compress/zlib   0.017s
ok      container/heap  0.012s
ok      container/list  0.002s
ok      container/ring  0.019s
ok      context 0.977s
ok      crypto  0.001s
ok      crypto/aes      0.022s
ok      crypto/cipher   0.011s
ok      crypto/des      0.007s
ok      crypto/dsa      0.003s
ok      crypto/ecdsa    0.147s
ok      crypto/elliptic 0.035s
ok      crypto/hmac     0.002s
ok      crypto/md5      0.002s
ok      crypto/rand     0.035s
ok      crypto/rc4      0.080s
ok      crypto/rsa      0.078s
ok      crypto/sha1     0.022s
ok      crypto/sha256   0.007s
ok      crypto/sha512   0.003s
ok      crypto/subtle   0.003s
ok      crypto/tls      0.904s
ok      crypto/x509     0.901s
ok      database/sql    0.545s
ok      database/sql/driver     0.001s
ok      debug/dwarf     0.007s
ok      debug/elf       0.022s
ok      debug/gosym     0.134s
ok      debug/macho     0.002s
ok      debug/pe        0.004s
ok      debug/plan9obj  0.001s
ok      encoding/ascii85        0.005s
ok      encoding/asn1   0.003s
ok      encoding/base32 0.003s
ok      encoding/base64 0.010s
ok      encoding/binary 0.012s
ok      encoding/csv    0.003s
ok      encoding/gob    0.029s
ok      encoding/hex    0.002s
ok      encoding/json   0.416s
ok      encoding/pem    0.009s
ok      encoding/xml    0.015s
ok      errors  0.001s
ok      expvar  0.003s
ok      flag    0.004s
ok      fmt     0.085s
ok      go/ast  0.003s
ok      go/build        0.088s
ok      go/constant     0.011s
ok      go/doc  0.029s
ok      go/format       0.007s
ok      go/importer     0.071s
ok      go/internal/gccgoimporter       0.008s
ok      go/internal/gcimporter  0.181s
ok      go/internal/srcimporter 0.663s
ok      go/parser       0.029s
ok      go/printer      0.312s
ok      go/scanner      0.003s
ok      go/token        0.016s
ok      go/types        0.757s
ok      hash    0.002s
ok      hash/adler32    0.006s
ok      hash/crc32      0.011s
ok      hash/crc64      0.002s
ok      hash/fnv        0.002s
ok      html    0.004s
ok      html/template   0.028s
ok      image   0.086s
ok      image/color     0.019s
ok      image/draw      0.045s
ok      image/gif       0.437s
ok      image/jpeg      0.201s
ok      image/png       0.032s
ok      index/suffixarray       0.007s
ok      internal/cpu    0.001s
ok      internal/poll   0.005s
ok      internal/singleflight   0.015s
ok      internal/trace  0.829s
ok      io      0.022s
ok      io/ioutil       0.007s
ok      log     0.011s
ok      log/syslog      1.214s
ok      math    0.003s
ok      math/big        1.796s
ok      math/bits       0.003s
ok      math/cmplx      0.002s
ok      math/rand       0.257s
ok      mime    0.005s
ok      mime/multipart  0.405s
ok      mime/quotedprintable    0.130s
ok      net     1.931s
ok      net/http        6.404s
ok      net/http/cgi    0.304s
ok      net/http/cookiejar      0.006s
ok      net/http/fcgi   0.004s
ok      net/http/httptest       0.019s
ok      net/http/httptrace      0.003s
ok      net/http/httputil       0.049s
ok      net/http/internal       0.002s
ok      net/internal/socktest   0.002s
ok      net/mail        0.016s
ok      net/rpc 0.022s
ok      net/rpc/jsonrpc 0.006s
ok      net/smtp        0.008s
ok      net/textproto   0.005s
ok      net/url 0.004s
ok      os      0.615s
ok      os/exec 0.457s
ok      os/signal       4.619s
ok      os/user 0.003s
ok      path    0.002s
ok      path/filepath   0.009s
ok      reflect 0.101s
ok      regexp  0.111s
ok      regexp/syntax   0.345s
ok      runtime 22.006s
ok      runtime/debug   0.006s
ok      runtime/internal/atomic 0.056s
ok      runtime/internal/sys    0.012s
ok      runtime/pprof   3.213s
ok      runtime/pprof/internal/profile  0.016s
ok      runtime/trace   3.187s
ok      sort    0.104s
ok      strconv 0.825s
ok      strings 0.145s
ok      sync    0.185s
ok      sync/atomic     0.081s
--- FAIL: TestUnshareMountNameSpace (0.02s)
        exec_linux_test.go:345: unshare failed: , fork/exec /tmp/go-build208380392/b645/syscall.test: invalid argument
--- FAIL: TestUnshareMountNameSpaceChroot (2.10s)
        exec_linux_test.go:404: unshare failed: , fork/exec /syscall.test: invalid argument
FAIL
FAIL    syscall 2.169s
ok      testing 0.805s
ok      testing/quick   0.107s
ok      text/scanner    0.002s
ok      text/tabwriter  0.010s
ok      text/template   0.298s
ok      text/template/parse     0.006s
ok      time    2.587s
ok      unicode 0.013s
ok      unicode/utf16   0.002s
ok      unicode/utf8    0.003s
ok      vendor/golang_org/x/crypto/chacha20poly1305     0.141s
ok      vendor/golang_org/x/crypto/chacha20poly1305/internal/chacha20   0.001s
ok      vendor/golang_org/x/crypto/cryptobyte   0.003s
ok      vendor/golang_org/x/crypto/curve25519   0.020s
ok      vendor/golang_org/x/crypto/poly1305     0.001s
ok      vendor/golang_org/x/net/http2/hpack     0.004s
ok      vendor/golang_org/x/net/idna    0.002s
ok      vendor/golang_org/x/net/lex/httplex     0.002s
ok      vendor/golang_org/x/net/nettest 1.177s
ok      vendor/golang_org/x/net/proxy   0.003s
ok      vendor/golang_org/x/text/transform      0.002s
ok      vendor/golang_org/x/text/unicode/norm   0.002s
ok      cmd/addr2line   1.309s
ok      cmd/api 0.005s
ok      cmd/asm/internal/asm    0.268s
ok      cmd/asm/internal/lex    0.002s
ok      cmd/compile     7.194s
ok      cmd/compile/internal/gc 36.331s
ok      cmd/compile/internal/ssa        0.101s
ok      cmd/compile/internal/syntax     0.017s
ok      cmd/compile/internal/test       0.016s [no tests to run]
ok      cmd/compile/internal/types      0.028s
ok      cmd/cover       1.274s
ok      cmd/doc 0.093s
ok      cmd/fix 1.907s
ok      cmd/go  43.690s
ok      cmd/go/internal/cache   0.531s
ok      cmd/go/internal/generate        0.002s
ok      cmd/go/internal/get     0.008s
ok      cmd/go/internal/load    0.004s
ok      cmd/go/internal/work    0.003s
ok      cmd/gofmt       0.040s
ok      cmd/internal/buildid    0.189s
ok      cmd/internal/dwarf      0.001s
ok      cmd/internal/edit       0.001s
ok      cmd/internal/goobj      0.360s
ok      cmd/internal/obj        0.001s
ok      cmd/internal/obj/arm64  0.001s
ok      cmd/internal/obj/x86    0.251s
ok      cmd/internal/objabi     0.013s
ok      cmd/internal/src        0.002s
ok      cmd/internal/test2json  0.102s
ok      cmd/link        0.430s
ok      cmd/link/internal/ld    44.080s
ok      cmd/nm  3.856s
ok      cmd/objdump     2.208s
ok      cmd/pack        2.345s
ok      cmd/trace       0.006s
ok      cmd/vendor/github.com/google/pprof/internal/binutils    0.031s
ok      cmd/vendor/github.com/google/pprof/internal/driver      12.204s
ok      cmd/vendor/github.com/google/pprof/internal/elfexec     0.001s
ok      cmd/vendor/github.com/google/pprof/internal/graph       0.010s
ok      cmd/vendor/github.com/google/pprof/internal/measurement 0.002s
ok      cmd/vendor/github.com/google/pprof/internal/report      0.079s
ok      cmd/vendor/github.com/google/pprof/internal/symbolizer  0.004s
ok      cmd/vendor/github.com/google/pprof/internal/symbolz     0.004s
ok      cmd/vendor/github.com/google/pprof/profile      0.046s
ok      cmd/vendor/github.com/ianlancetaylor/demangle   0.015s
ok      cmd/vendor/golang.org/x/arch/arm/armasm 0.007s
ok      cmd/vendor/golang.org/x/arch/arm64/arm64asm     0.072s
ok      cmd/vendor/golang.org/x/arch/ppc64/ppc64asm     0.002s
ok      cmd/vendor/golang.org/x/arch/x86/x86asm 0.067s
ok      cmd/vet 1.567s
ok      cmd/vet/internal/cfg    0.002s
2018/01/26 14:46:50 Failed: exit status 1

##### GOMAXPROCS=2 runtime -cpu=1,2,4 -quick
ok      runtime 14.556s

##### cmd/go terminal test
PASS
ok      _/build/golang-1.10-1.10~rc1/src/cmd/go/testdata/testterminal18153      0.001s

##### Testing without libgcc.
ok      crypto/x509     1.875s
ok      net     0.042s
ok      os/user 0.018s

##### internal linking of -buildmode=pie
ok      reflect 2.078s

##### sync -cpu=10
ok      sync    0.391s

##### Testing race detector
ok      runtime/race    22.385s
ok      flag    1.035s
ok      os      1.085s
ok      os/exec 3.085s
ok      encoding/gob    1.033s
PASS
scatter = 0x60c450
hello from C
sqrt is: 0
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/test      5.404s
ok      flag    1.033s
ok      os/exec 3.055s

##### ../misc/cgo/stdio

##### ../misc/cgo/life

##### ../misc/cgo/test
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/test      1.943s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/test      2.266s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/test      2.087s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/testtls   0.011s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/testtls   0.012s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/testtls   0.026s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/nocgo     0.001s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/nocgo     0.024s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/nocgo     0.001s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/test      2.000s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/testtls   0.014s
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/nocgo     0.013s

##### ../misc/cgo/testgodefs

##### ../misc/cgo/testso

##### ../misc/cgo/testsovar

##### ../misc/cgo/testcarchive
PASS

##### ../misc/cgo/testcshared
PASS

##### ../misc/cgo/testshared
PASS
ok      _/build/golang-1.10-1.10~rc1/misc/cgo/testshared        25.360s

##### ../misc/cgo/testplugin
PASS
something

##### ../misc/cgo/testasan

##### ../misc/cgo/testsanitizers
PASS

##### ../misc/cgo/errors
PASS

##### ../misc/cgo/testsigfwd

##### ../test/bench/go1
testing: warning: no tests to run
PASS
ok      _/build/golang-1.10-1.10~rc1/test/bench/go1     4.439s

##### ../test

##### API check
Go version is &quot;go1.10rc1&quot;, ignoring -next /build/golang-1.10-1.10~rc1/api/next.txt

FAILED
debian/rules:62: recipe for target &#39;override_dh_auto_test-arch&#39; failed
make[1]: *** [override_dh_auto_test-arch] Error 1
make[1]: Leaving directory &#39;/build/golang-1.10-1.10~rc1&#39;
debian/rules:27: recipe for target &#39;build&#39; failed
make: *** [build] Error 2
</pre></div>
<p><code>unshare failed</code> というエラーが2か所出ています。おそらく chroot 環境内ではうまく動かないのだろうと推測してテスト対象外にすることにします。</p>
<p>失敗しているテスト <code>TestUnshareMountNameSpace</code> と <code>TestUnshareMountNameSpaceChroot</code> のコードは
<a class="reference external" href="https://github.com/golang/go/blob/go1.10rc1/src/syscall/exec_linux_test.go#L314-L425">https://github.com/golang/go/blob/go1.10rc1/src/syscall/exec_linux_test.go#L314-L425</a>
です。共に先頭で <code>skipInContainer(t)</code> という関数を呼んでいます。</p>
<p>実装を見てみると以下のようになっていました。
<a class="reference external" href="https://github.com/golang/go/blob/go1.10rc1/src/syscall/exec_linux_test.go#L26-L42">https://github.com/golang/go/blob/go1.10rc1/src/syscall/exec_linux_test.go#L26-L42</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">isDocker</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="s">&quot;/.dockerenv&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">isLXC</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;container&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;lxc&quot;</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">skipInContainer</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">isDocker</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Skip</span><span class="p">(</span><span class="s">&quot;skip this test in Docker container&quot;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">isLXC</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">Skip</span><span class="p">(</span><span class="s">&quot;skip this test in LXC container&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>というわけで <code>debian/rules</code> の先頭のほうを以下のように変えることにしました。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span>export GOROOT := $(CURDIR)
export GOROOT_FINAL := /usr/lib/go-$(GOVER)

# NOTE: Set GOCACHE environment variable to avoid the following error.
#   initializing cache in $GOCACHE: mkdir /nonexistent: permission denied
# See https://github.com/golang/go/blob/go1.10rc1/src/cmd/go/internal/cache/default.go#L35-L55
export GOCACHE := $(CURDIR)

# NOTE: Set container environment variable to skip tests which fail in pbuilder chroot.
# See https://github.com/golang/go/blob/go1.10rc1/src/syscall/exec_linux_test.go#L26-L42
export container = lxc
</pre></div>
</td></tr></table><p>これで再度以下のコマンドでビルドしてみると今度は無事にビルドできました。</p>
<div class="highlight"><pre><span></span><span class="go">debian/rules build</span>
</pre></div>
<p>Ctrl-D を押してpbuilderのchroot環境を抜け、 <code>debian/rules</code> を上記の通り変更してコミットしてソースパッケージを作り直して再度ビルドしました。</p>
<p>コミット後の差分は以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git diff HEAD~
<span class="go">diff --git a/debian/rules b/debian/rules</span>
<span class="go">index b6d44ae..20751cf 100755</span>
<span class="go">--- a/debian/rules</span>
<span class="go">+++ b/debian/rules</span>
<span class="go">@@ -7,6 +7,15 @@ export GOVER := $(shell perl -w -mDpkg::Version -e &#39;Dpkg::Version-&gt;new(`dpkg-par</span>
<span class="go"> export GOROOT := $(CURDIR)</span>
<span class="go"> export GOROOT_FINAL := /usr/lib/go-$(GOVER)</span>

<span class="go">+# NOTE: Set GOCACHE environment variable to avoid the following error.</span>
<span class="go">+#   initializing cache in $GOCACHE: mkdir /nonexistent: permission denied</span>
<span class="go">+# See https://github.com/golang/go/blob/go1.10rc1/src/cmd/go/internal/cache/default.go#L35-L55</span>
<span class="go">+export GOCACHE := $(CURDIR)</span>
<span class="go">+</span>
<span class="go">+# NOTE: Set container environment variable to skip tests which fail in pbuilder chroot.</span>
<span class="go">+# See https://github.com/golang/go/blob/go1.10rc1/src/syscall/exec_linux_test.go#L26-L42</span>
<span class="go">+export container = lxc</span>
<span class="go">+</span>
<span class="go"> DEB_HOST_ARCH := $(shell dpkg-architecture -qDEB_HOST_ARCH 2&gt;/dev/null)</span>
<span class="go"> RUN_TESTS := true</span>
<span class="gp"> #</span> armel: ???
</pre></div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>