<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.74.3" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>sbuildで外部レポジトリを使う &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>sbuildで外部レポジトリを使う</h1>
  <time datetime=2018-06-15T10:12:00&#43;0900 class="post-date">2018-06-15</time>
  <nav id="TableOfContents"></nav>
  <h1 id="はじめに">はじめに</h1>
<p>外部レポジトリのdebパッケージに依存したdebパッケージをsbuildでビルドするための手順メモです。</p>
<p>以下の2つの方法がありますが、別のchroot環境を作る必要がないので2つめのほうが良いです。1つめの方法は別の用途にも使えるかもしれないので一応メモしておきます。</p>
<ol>
<li>外部レポジトリを追加したchroot環境を作成してそれを使ってビルド。</li>
<li>sbuildの <code>--extra-repository</code> オプションを使ってビルド。</li>
</ol>
<p>以下では拙作の
<a href="https://launchpad.net/~hnakamur/+archive/ubuntu/golang-1.10">golang 1.10 : Hiroaki Nakamura</a>
というPPAのレポジトリを追加する例で説明します。</p>
<p>Ubuntu 18.04 LTS では2018-06-13時点では go1.10.1 が配布されていますが、このPPAでは go1.10.3 を配布しています。</p>
<h1 id="外部レポジトリを追加したchroot環境を作成してそれを使ってビルド">外部レポジトリを追加したchroot環境を作成してそれを使ってビルド</h1>
<p>bionic-latest-golang という名前のchroot環境を新しく作成します。</p>
<pre><code class="language-console" data-lang="console">mk-sbuild --name bionic-latest-golang bionic
</code></pre><p>作成したchroot環境に入ります。</p>
<pre><code class="language-console" data-lang="console">schroot -c source:bionic-latest-golang-amd64 -u root -d /root
</code></pre><p>golang-1.10の自作PPAのレポジトリを追加します。</p>
<pre><code class="language-console" data-lang="console">apt install software-properties-common
add-apt-repository ppa:hnakamur/golang-1.0
</code></pre><p>chroot環境から抜けます。</p>
<pre><code class="language-console" data-lang="console">exit
</code></pre><p>あとはdebパッケージをビルドする際にこのchroot環境を指定します。</p>
<pre><code class="language-console" data-lang="console">TERM=unknown DEB_BUILD_OPTIONS=parallel=2 V=1 sbuild --sbuild-mode=buildd -c bionic-latest-golang-amd64
</code></pre><h1 id="sbuildの---extra-repository-オプションを使ってビルド">sbuildの <code>--extra-repository</code> オプションを使ってビルド</h1>
<p>chroot環境のホストで
<a href="https://launchpad.net/~hnakamur/+archive/ubuntu/golang-1.10">golang 1.10 : Hiroaki Nakamura</a>
のレポジトリを追加してあれば、以下のコマンドでdebパッケージをビルドできました。</p>
<pre><code class="language-console" data-lang="console">TERM=unknown DEB_BUILD_OPTIONS=parallel=2 V=1 sbuild --sbuild-mode=buildd \
        --extra-repository=&quot;deb http://ppa.launchpad.net/hnakamur/golang-1.10/ubuntu bionic main&quot; \
        --extra-repository-key /etc/apt/trusted.gpg.d/hnakamur_ubuntu_golang-1_10.gpg
</code></pre><p><code>--extra-repository</code> オプションに指定する値は <code>/etc/apt/sources.list.d/hnakamur-ubuntu-golang-1_10-bionic.list</code> の <code>deb</code> の行の内容です。</p>
<p>chroot環境のホスト側に
<a href="https://launchpad.net/~hnakamur/+archive/ubuntu/golang-1.10">golang 1.10 : Hiroaki Nakamura</a>
のレポジトリを追加していない場合は、このページで
&ldquo;Technical details about this PPA&rdquo; をクリックして &ldquo;Display sources.list entries for: &quot; の右の
ドロップダウンで &ldquo;Bionic (18.04)&rdquo; を選べば同じ内容が表示されます。</p>
<p><code>--extra-repository</code> オプションに指定する値は
<a href="http://manpages.ubuntu.com/manpages/bionic/en/man1/sbuild.1.html">man 1 sbuild</a> では
<code>--extra-repository=file.asc</code> のように書かれていて、ASCIIのPEM形式のGPG公開鍵のファイルを指定する
必要があるようです。</p>
<p>ですが、 <code>apt-key list</code> で表示される拡張子 <code>.gpg</code> のファイルパスを指定してみたら、それでも動きました。</p>
<p>きちんとASCIIのPEM形式のGPG公開鍵を取り出すには以下のようにします。</p>
<pre><code class="language-console" data-lang="console">apt-key --keyring /etc/apt/trusted.gpg.d/hnakamur_ubuntu_golang-1_10.gpg exportall
</code></pre><p>標準出力に以下のように鍵が表示されるので、ファイルにリダイレクトして使えばOKです。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBFcTVU8BEADjFbrMyBLXPRodLMF4pGKdjd6FDn/5URnwx1g10NkPzM6jxK9J
4CKkQWWMHpM1Qtk/r1z6e1CJEDdWdWds0TDyRh18bwEPFGE9FYsQWJihBb1GNKWa
AM++FwArbTc0tInaLBWcrJsL0NPqJE0ttvL2g7ZFfOlS8VTzYr+sKWWReq9kCyaA
DUe7aKgft+q7Rw/5Y+gw47msWh2ESnLUltPP71C7FRaFp8k5CrNHRLCXqL0LggTQ
aWzyZBdfmD7tzqTn4szOz0BMM1DyyzZmj5W/zzpRx1vLOCICpedYg99w+5ZeeoLp
egVYjCkYzQnKIK7kq4GDX/9SUgLMrNFJFbilxJd1ibEsMrWB+NzIO1jcL/t+rF4J
YShtsOeNiwc6qzAT+tMLFR4hxpVwTY7RWTIU/+4Y2fOosw1mdcaWHvxavef6Yt8B
qy2G51RKctcO1jt4U9IPjUKVKeXdTW5Y9sGpag91z15+GHuerrj3DKZa8om+nMls
Oz1V4yASz7JyhFPedLNPHURE6rgexDk8ebb1gOf5sc5G3iVNpev0agbq+1msqxdg
pEV78cILERVxWCyEUCjSHk7aNKpJnnZN1+J3vpSj53A/dcovR8fkkxkILCMWJjFn
ClbyLx8brJkAuwHEBdXYPxUFKM2rzKT2AvcPHA+4cm/Gy0uXBC16ht+4/QARAQAB
tCJMYXVuY2hwYWQgUFBBIGZvciBIaXJvYWtpIE5ha2FtdXJhiQI4BBMBAgAiBQJX
E1VPAhsDBgsJCAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAKCRBg2VShEBc0Hig+D/9i
LGIqiLESEYPq+LrLE29ZU63h9kShsg89kJVxu1G5Knj6c9oAut8faS7MyA92vbXq
kEa3IygxbpXhFj79MAq2d1RHzg37A/1vvdY1rRBoPTBCUNkl9E9jDiUFw10w3Rma
QN3Ap3saqf+wCA1OIIgdmJDsnYk8WEDCYtfKsCHoHJCa8iSoRsNo2GpVnyNpSNrE
J2m8VldFJ1BGC6pYP77XcbG/jb01g2mG7XoHDnVtGeTma/8ps85W+0FlzFxyEfU4
pr86RfwALSkUmGglNlYqv6yyhKQx4mj3Dq4qrxrmFIw49volysWdruYZp69YZmc7
aBNH98EpIKSJgbW78eeH0MbGY5bp9rMK1SzxYz5DLktT57AbsIqzu0fZ4HzeLjn1
UFYs5g5MTt1iTLypLhsDYmeFoYqi8XYaWHKYnp4PTUitvGfLeevg7Z7PcgIGZ6Su
5AWC8xYn/tHiOg5Pzl4GtxA4A01UGirRfF8kAB7C8rpJkhS0IG4xbvVjArVeApPV
jXdrDiuT17US1RCJ0hztA/NCDYA2800/U9U83d1yxza04miyY++a1crSKAuR3+kM
L8XtToVZNBbFZsIuitx30xhm1uhF8+saAZhavwmhzCa5Z5vKVFxvt8MC+I1uik06
5KY++bMCM+8GWGvPCJ/XYSKwrMDVdZzQZ1cTNwY9yA==
=4arz
-----END PGP PUBLIC KEY BLOCK-----
</code></pre></div><p>chroot環境のホスト側に
<a href="https://launchpad.net/~hnakamur/+archive/ubuntu/golang-1.10">golang 1.10 : Hiroaki Nakamura</a>
のレポジトリを追加していない場合は、このページで
&ldquo;Technical details about this PPA&rdquo; をクリックして &ldquo;Signing key:&rdquo; の下の
&ldquo;4096R/532A4A026239FC3BAEB7869C60D954A11017341E&rdquo;
リンクをクリックし、
遷移先のページのkeyIDのリンクをクリックすると鍵が表示されます。</p>
<p>今回の例では以下の1017341EがkeyIDです。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">Type bits/keyID     Date       User ID

pub  4096R/1017341E 2016-04-17 Launchpad PPA for Hiroaki Nakamura
         Fingerprint=532A 4A02 6239 FC3B AEB7  869C 60D9 54A1 1017 341E
</code></pre></div><p>リンク先のURLは <code>https://keyserver.ubuntu.com/pks/lookup?op=get&amp;search=0x60D954A11017341E</code>
で、中身は以下のようなHTMLになっています。</p>
<div class="highlight"><pre class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span class="cp">&lt;!DOCTYPE html PUBLIC &#34;-//W3C//DTD XHTML 1.0 Strict//EN&#34; &#34;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&#34; &gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&#34;http://www.w3.org/1999/xhtml&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Public Key Server -- Get &#34;0x60d954a11017341e &#34;<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&#34;Content-Type&#34;</span> <span class="na">content</span><span class="o">=</span><span class="s">&#34;text/html;charset=utf-8&#34;</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">style</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/css&#34;</span><span class="p">&gt;</span>
<span class="c">/*&lt;![CDATA[*/</span>
 <span class="p">.</span><span class="nc">uid</span> <span class="p">{</span> <span class="k">color</span><span class="p">:</span> <span class="kc">green</span><span class="p">;</span> <span class="k">text-decoration</span><span class="p">:</span> <span class="kc">underline</span><span class="p">;</span> <span class="p">}</span>
 <span class="p">.</span><span class="nc">warn</span> <span class="p">{</span> <span class="k">color</span><span class="p">:</span> <span class="kc">red</span><span class="p">;</span> <span class="k">font-weight</span><span class="p">:</span> <span class="kc">bold</span><span class="p">;</span> <span class="p">}</span>
<span class="c">/*]]&gt;*/</span>
<span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;&lt;/</span><span class="nt">head</span><span class="p">&gt;&lt;</span><span class="nt">body</span><span class="p">&gt;&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Public Key Server -- Get &#34;0x60d954a11017341e &#34;<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">pre</span><span class="p">&gt;</span>
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: SKS 1.1.6
Comment: Hostname: keyserver.ubuntu.com

mQINBFcTVU8BEADjFbrMyBLXPRodLMF4pGKdjd6FDn/5URnwx1g10NkPzM6jxK9J4CKkQWWM
HpM1Qtk/r1z6e1CJEDdWdWds0TDyRh18bwEPFGE9FYsQWJihBb1GNKWaAM++FwArbTc0tIna
LBWcrJsL0NPqJE0ttvL2g7ZFfOlS8VTzYr+sKWWReq9kCyaADUe7aKgft+q7Rw/5Y+gw47ms
Wh2ESnLUltPP71C7FRaFp8k5CrNHRLCXqL0LggTQaWzyZBdfmD7tzqTn4szOz0BMM1DyyzZm
j5W/zzpRx1vLOCICpedYg99w+5ZeeoLpegVYjCkYzQnKIK7kq4GDX/9SUgLMrNFJFbilxJd1
ibEsMrWB+NzIO1jcL/t+rF4JYShtsOeNiwc6qzAT+tMLFR4hxpVwTY7RWTIU/+4Y2fOosw1m
dcaWHvxavef6Yt8Bqy2G51RKctcO1jt4U9IPjUKVKeXdTW5Y9sGpag91z15+GHuerrj3DKZa
8om+nMlsOz1V4yASz7JyhFPedLNPHURE6rgexDk8ebb1gOf5sc5G3iVNpev0agbq+1msqxdg
pEV78cILERVxWCyEUCjSHk7aNKpJnnZN1+J3vpSj53A/dcovR8fkkxkILCMWJjFnClbyLx8b
rJkAuwHEBdXYPxUFKM2rzKT2AvcPHA+4cm/Gy0uXBC16ht+4/QARAQABtCJMYXVuY2hwYWQg
UFBBIGZvciBIaXJvYWtpIE5ha2FtdXJhiQI4BBMBAgAiBQJXE1VPAhsDBgsJCAcDAgYVCAIJ
CgsEFgIDAQIeAQIXgAAKCRBg2VShEBc0Hig+D/9iLGIqiLESEYPq+LrLE29ZU63h9kShsg89
kJVxu1G5Knj6c9oAut8faS7MyA92vbXqkEa3IygxbpXhFj79MAq2d1RHzg37A/1vvdY1rRBo
PTBCUNkl9E9jDiUFw10w3RmaQN3Ap3saqf+wCA1OIIgdmJDsnYk8WEDCYtfKsCHoHJCa8iSo
RsNo2GpVnyNpSNrEJ2m8VldFJ1BGC6pYP77XcbG/jb01g2mG7XoHDnVtGeTma/8ps85W+0Fl
zFxyEfU4pr86RfwALSkUmGglNlYqv6yyhKQx4mj3Dq4qrxrmFIw49volysWdruYZp69YZmc7
aBNH98EpIKSJgbW78eeH0MbGY5bp9rMK1SzxYz5DLktT57AbsIqzu0fZ4HzeLjn1UFYs5g5M
Tt1iTLypLhsDYmeFoYqi8XYaWHKYnp4PTUitvGfLeevg7Z7PcgIGZ6Su5AWC8xYn/tHiOg5P
zl4GtxA4A01UGirRfF8kAB7C8rpJkhS0IG4xbvVjArVeApPVjXdrDiuT17US1RCJ0hztA/NC
DYA2800/U9U83d1yxza04miyY++a1crSKAuR3+kML8XtToVZNBbFZsIuitx30xhm1uhF8+sa
AZhavwmhzCa5Z5vKVFxvt8MC+I1uik065KY++bMCM+8GWGvPCJ/XYSKwrMDVdZzQZ1cTNwY9
yA==
=4arz
-----END PGP PUBLIC KEY BLOCK-----
<span class="p">&lt;/</span><span class="nt">pre</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div><p>鍵の部分だけを切り出すには以下のようなコマンドを使い、あとはファイルにリダイレクトするようにすればOKです。</p>
<pre><code class="language-console" data-lang="console">curl -sSL 'https://keyserver.ubuntu.com/pks/lookup?op=get&amp;search=0x60D954A11017341E' \
        | sed -n '/^-----BEGIN/,/^-----END/p'
</code></pre>
</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
