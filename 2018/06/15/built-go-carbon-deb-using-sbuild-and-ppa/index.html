<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.96.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>go-carbonのdebパッケージをsbuildとPPAでビルドした &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2022. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>go-carbonのdebパッケージをsbuildとPPAでビルドした</h1>
  <time datetime=2018-06-15T10:55:00&#43;0900 class="post-date">2018-06-15</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#debiancontrolを編集">debian/controlを編集</a></li>
    <li><a href="#debiango-carbondirsを作成">debian/go-carbon.dirsを作成</a></li>
    <li><a href="#debiango-carbonpostinstを作成">debian/go-carbon.postinstを作成</a></li>
    <li><a href="#debiango-carbonpostrmを作成">debian/go-carbon.postrmを作成</a></li>
    <li><a href="#go-carbonのソースに含まれていたsystemd-service定義ファイルを改良">go-carbonのソースに含まれていたsystemd service定義ファイルを改良</a></li>
  </ul>

  <ul>
    <li><a href="#ソースパッケージのビルド">ソースパッケージのビルド</a></li>
    <li><a href="#バイナリパッケージのビルド">バイナリパッケージのビルド</a></li>
  </ul>
</nav>
  <h1 id="はじめに">はじめに</h1>
<p><a href="https://github.com/lomik/go-carbon">lomik/go-carbon: Golang implementation of Graphite/Carbon server with classic architecture: Agent -&gt; Cache -&gt; Persister</a>
のdebパッケージをsbuildとPPAでビルドしたときのメモです。</p>
<p>成果物は以下に有ります。</p>
<ul>
<li>PPA: <a href="https://launchpad.net/~hnakamur/+archive/ubuntu/go-carbon">go-carbon : Hiroaki Nakamura</a></li>
<li>debソースレポジトリ: <a href="https://github.com/hnakamur/go-carbon-deb">hnakamur/go-carbon-deb: go-carbon deb package for Ubuntu 18.04 LTS</a></li>
</ul>
<h1 id="debianでのgoのパッケージング方針">debianでのgoのパッケージング方針</h1>
<ul>
<li><a href="https://wiki.debian.org/MichaelStapelberg/GoPackaging">MichaelStapelberg/GoPackaging - Debian Wiki</a></li>
<li><a href="https://go-team.pages.debian.net/packaging.html">Debian Go Packaging</a></li>
</ul>
<p>に書いてあります。</p>
<p>Goのバイナリ実行ファイルを作る場合に依存ライブラリを別パッケージで作る方針になっていますが、現時点では個人的にはこれは賛同できないです。複数のバイナリパッケージがあるときに同じライブラリに依存するけど必要なバージョンが異なるケースがあり得るからです。</p>
<p>現状だとベンダリングとスタティックリンクで個々のバイナリパッケージ単独で完結するほうがお手軽なので、自作のdebパッケージではそうすることにしました。都合の良いことに go-carbon は dep を使ってベンダリングしており、依存ライブラリのソースは全て vendor ディレクトリに含まれています。</p>
<h1 id="dh-golangとdh-make-golangをインストール">dh-golangとdh-make-golangをインストール</h1>
<p>dh-golang は goのパッケージを作るための dh (debhelper) のアドオンです。
dh-make-golang はgoのパッケージのソースからdebパッケージを作成するのを自動化するツールです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo apt install dh-golang dh-make-golang
</span></span></span></code></pre></div><h1 id="dh-make-golangでdebパッケージのソースのベースを作成">dh-make-golangでdebパッケージのソースのベースを作成</h1>
<p>dh-make-golang というツールを使えばdebianのgoのパッケージ方針に従ってパッケージを作成してくれるようなのですが、上記のように依存ライブラリの方針が違うので、debパッケージのソースを生成するところだけ使って、そこから先は手で編集することにしました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mkdir -p ~/go-carbon-deb-work
</span></span></span><span class="line"><span class="cl"><span class="go">cd !$
</span></span></span></code></pre></div><p><code>dh-make-golang ビルド対象のgoパッケージ名</code> でdebパッケージのソースが作成されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> dh-make-golang github.com/lomik/go-carbon
</span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:33:49 Downloading &#34;github.com/lomik/go-carbon/...&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:33:52 Deleting upstream vendor/ directory, installing remaining dependencies
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:35:57 Determining upstream version number
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:35:57 Package version is &#34;0.12.0+git20180608.b1e6baf&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:35:57 Determining package type
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:35:57 Assuming you are packaging a program (because &#34;github.com/lomik/go-carbon&#34; defines a main package), use -type to override
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:35:57 Determining dependencies
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:02 Build-Dependency &#34;github.com/go-graphite/carbonzipper&#34; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:02 Build-Dependency &#34;github.com/lomik/stop&#34; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:02 Build-Dependency &#34;github.com/dgryski/go-expirecache&#34; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:02 Build-Dependency &#34;github.com/lomik/og-rek&#34; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:02 Build-Dependency &#34;github.com/dgryski/go-trigram&#34; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:02 Build-Dependency &#34;github.com/dgryski/httputil&#34; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:02 Build-Dependency &#34;github.com/go-graphite/go-whisper&#34; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:02 Build-Dependency &#34;github.com/go-graphite/protocol&#34; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:02 Build-Dependency &#34;github.com/lomik/zapwriter&#34; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:02 Build-Dependency &#34;github.com/lomik/graphite-pickle&#34; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06 Packaging successfully created in /home/hnakamur/go-carbon-deb-work/go-carbon
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06 Resolve all TODOs in itp-go-carbon.txt, then email it out:
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06     sendmail -t &lt; itp-go-carbon.txt
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06 Resolve all the TODOs in debian/, find them using:
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06     grep -r TODO debian
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06 To build the package, commit the packaging and use gbp buildpackage:
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06     git add debian &amp;&amp; git commit -a -m &#39;Initial packaging&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06     gbp buildpackage --git-pbuilder
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06 To create the packaging git repository on alioth, use:
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06     ssh git.debian.org &#34;/git/pkg-go/setup-repository go-carbon &#39;Packaging for go-carbon&#39;&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06 Once you are happy with your packaging, push it to alioth using:
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06     git remote set-url origin git+ssh://git.debian.org/git/pkg-go/packages/go-carbon.git
</span></span></span><span class="line"><span class="cl"><span class="go">2018/06/15 11:36:06     gbp push
</span></span></span></code></pre></div><p><code>~/go-carbon-deb-work/go-carbon</code> ディレクトリが新たに作られてdebパッケージのソースがそこに生成されています。
上記の出力にあるとおり、go-carbonに含まれるvendorディレクトリは削除されて、依存ライブラリのソースが別途取得されています。</p>
<p>というわけで <code>debian/*</code> ファイルだけ頂くことにします。</p>
<h1 id="gbp-import-origでgo-carbonのソースをインポート">gbp import-origでgo-carbonのソースをインポート</h1>
<p>まず今回ビルドする go-carbon の v0.12.0 のソースを取得します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mkdir -p ~/go-carbon-deb-work
</span></span></span><span class="line"><span class="cl"><span class="go">cd !$
</span></span></span><span class="line"><span class="cl"><span class="go">curl -LO https://github.com/lomik/go-carbon/archive/v0.12.0.tar.gz
</span></span></span></code></pre></div><p>debパッケージ用の作業ディレクトリを作成してそちらに移動しgitレポジトリを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mkdir -p ~/.ghq/github.com/hnakamur/go-carbon-deb
</span></span></span><span class="line"><span class="cl"><span class="go">cd !$
</span></span></span><span class="line"><span class="cl"><span class="go">git init
</span></span></span></code></pre></div><p><code>gbp import-orig</code> でgo-carbonのソースをインポートします。以下のようにソースパッケージ名を聞かれるので go-carbon と入力します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp import-orig --pristine-tar -u 0.12.0 ~/go-carbon-deb-work/v0.12.0.tar.gz
</span></span><span class="line"><span class="cl"><span class="go">What will be the source package name? [] go-carbon
</span></span></span></code></pre></div><h1 id="dh-make-golangで生成したdebianディレクトリのファイルをコピー">dh-make-golangで生成したdebianディレクトリのファイルをコピー</h1>
<p>上記で dh-make-golangで生成した <code>debian/*</code> ファイルをコピーして、一旦コミットします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">rsync -a ~/go-carbon-deb-work/go-carbon/debian .
</span></span></span><span class="line"><span class="cl"><span class="go">git add .
</span></span></span><span class="line"><span class="cl"><span class="go">git commit -m &#34;Add debian/* files generated by dh-make-golang&#34;
</span></span></span></code></pre></div><h1 id="debianディレクトリのファイルを編集">debianディレクトリのファイルを編集</h1>
<p>以下は主なところだけ説明します。</p>
<h2 id="debiancontrolを編集">debian/controlを編集</h2>
<p>Build-Dependsから依存ライブラリを外します。
また、Maintainerなど他の項目も適宜変更しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/debian/control b/debian/control
</span></span></span><span class="line"><span class="cl"><span class="gh">index 486eb87..b5ee819 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/debian/control
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/debian/control
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -1,397 +1,19 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> Source: go-carbon
</span></span><span class="line"><span class="cl"> Section: devel
</span></span><span class="line"><span class="cl"> Priority: optional
</span></span><span class="line"><span class="cl"><span class="gd">-Maintainer: Debian Go Packaging Team &lt;pkg-go-maintainers@lists.alioth.debian.org&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd">-Uploaders: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+Maintainer: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> Build-Depends: debhelper (&gt;= 10),
</span></span><span class="line"><span class="cl">		dh-golang,
</span></span><span class="line"><span class="cl"><span class="gd">-               golang-any,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-github-klauspost-compress-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-github-nytimes-gziphandler-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-github-sevlyar-go-daemon-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-github-shopify-sarama-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-github-stretchr-testify-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-go.uber-zap-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-gogoprotobuf-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-golang-x-net-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-goleveldb-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-google-api-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-google-cloud-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-google-grpc-dev,
</span></span></span><span class="line"><span class="cl"><span class="gd">-               golang-toml-dev
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+               golang-any
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>…（略） …
</span></span></code></pre></div><h2 id="debiango-carbondirsを作成">debian/go-carbon.dirsを作成</h2>
<p>インストール時に作成するディレクトリを指定します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">/etc/go-carbon
</span></span><span class="line"><span class="cl">/var/lib/graphite/whisper
</span></span><span class="line"><span class="cl">/var/log/go-carbon
</span></span></code></pre></div><h2 id="debiango-carbonpostinstを作成">debian/go-carbon.postinstを作成</h2>
<p>インストール後に実行するスクリプトを作成します。</p>
<p>nginx.orgのdebパッケージに含まれる debian/nginx.postinst を参考にしました。そちらではsystemdではないinit.dにも対応していましたが、私は不要なのでsystemd限定にしています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> !<span class="o">=</span> <span class="s2">&#34;configure&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">exit</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set permisions on default data directory on installation</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$2</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    chown carbon:carbon /var/lib/graphite/whisper
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> -f /var/run/go-carbon.pid <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> -0 <span class="k">$(</span>cat /var/run/nginx.pid<span class="k">)</span> &gt;/dev/null<span class="p">;</span> <span class="k">then</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;######################################&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;# Please restart go-carbon manually. #&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">echo</span> <span class="s2">&#34;######################################&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>
</span></span><span class="line"><span class="cl">    invoke-rc.d go-carbon start <span class="o">||</span> <span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#DEBHELPER#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span></code></pre></div><p><code>invoke-rc.d</code> コマンドは今回初めて知ったのですが
<a href="http://manpages.ubuntu.com/manpages/bionic/en/man8/invoke-rc.d.8.html">man invoke-rc.d</a>
のDESCRIPTIONに以下のように書かれているので、debパッケージのスクリプトでサービス起動するときは <code>systemctl</code> ではなくこちらを使うのが良いようです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">All access to the init scripts by Debian packages&#39; maintainer scripts should be done through invoke-rc.d.
</span></span></code></pre></div><p>また、go-carbonは graceful restart に対応していないので、プロセス起動中にパッケージアップデートする場合はメッセージを表示するだけで再起動はしないようにしました。別途再起動を行う想定です。</p>
<h2 id="debiango-carbonpostrmを作成">debian/go-carbon.postrmを作成</h2>
<p>アンインストール後に実行するスクリプトを作成します。</p>
<p>nginxの <code>debian/nginx.postrm</code> ではサービスを止めるようなコマンドも含まれていたのですが、試してみると自分で書かなくても止めてくれたので省きました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="cp">#!/bin/sh
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="nb">set</span> -e
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> in
</span></span><span class="line"><span class="cl">    purge<span class="o">)</span>
</span></span><span class="line"><span class="cl">	rm -rf /var/lib/graphite/whisper /var/log/go-carbon
</span></span><span class="line"><span class="cl">	<span class="p">;;</span>
</span></span><span class="line"><span class="cl">    remove<span class="p">|</span>upgrade<span class="p">|</span>failed-upgrade<span class="p">|</span>abort-install<span class="p">|</span>abort-upgrade<span class="p">|</span>disappear<span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">;;</span>
</span></span><span class="line"><span class="cl">    *<span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s2">&#34;postrm called with unknown argument \`</span><span class="nv">$1</span><span class="s2">&#39;&#34;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">	<span class="nb">exit</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="k">esac</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#DEBHELPER#</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">exit</span> <span class="m">0</span>
</span></span></code></pre></div><p><code>apt remove go-carbon</code> でアンインストールした後
<code>apt purge go-carbon</code> を実行すると、whisperファイルとログファイルを消すようにしました。</p>
<p>nginxの <code>debian/nginx.postrm</code> では設定ファイルのディレクトリ <code>/etc/nginx/</code> も消すように書かれていましたが、試してみるとgo-carbonの設定ファイルのディレクトリ <code>/etc/go-carbon</code> は明示的に消すように書かなくても自動で消されたので上記のスクリプトでは省いています。</p>
<h2 id="go-carbonのソースに含まれていたsystemd-service定義ファイルを改良">go-carbonのソースに含まれていたsystemd service定義ファイルを改良</h2>
<p><code>PIDFile</code> の項目がなかったので追加しました。
これを書いておくと <code>systemctl stop go-carbon</code> でサービスを止めたり、起動中に <code>apt remove go-carbon</code> でアンインストールしたときにPIDファイルを自動で消してくれました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">diff --git a/debian/go-carbon.service b/debian/go-carbon.service
</span></span><span class="line"><span class="cl">index 0d933dd..a421bb7 100644
</span></span><span class="line"><span class="cl">--- a/debian/go-carbon.service
</span></span><span class="line"><span class="cl">+++ b/debian/go-carbon.service
</span></span><span class="line"><span class="cl">@@ -6,6 +6,7 @@ After=network.target
</span></span><span class="line"><span class="cl"> [Service]
</span></span><span class="line"><span class="cl"> Type=forking
</span></span><span class="line"><span class="cl"> ExecStart=/usr/bin/go-carbon -config /etc/go-carbon/go-carbon.conf -pidfile /var/run/go-carbon.pid -daemon
</span></span><span class="line"><span class="cl">+PIDFile=/var/run/go-carbon.pid
</span></span><span class="line"><span class="cl"> ExecReload=/bin/kill -HUP $MAINPID
</span></span><span class="line"><span class="cl"> KillSignal=USR2
</span></span><span class="line"><span class="cl"> Restart=on-failure
</span></span><span class="line"><span class="cl">@@ -15,4 +16,4 @@ LimitNOFILE=55555
</span></span><span class="line"><span class="cl"> LimitMEMLOCK=infinity
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> [Install]
</span></span><span class="line"><span class="cl">-WantedBy=multi-user.target
</span></span><span class="line"><span class="cl">\ No newline at end of file
</span></span><span class="line"><span class="cl">+WantedBy=multi-user.target
</span></span></code></pre></div><h1 id="ビルド手順">ビルド手順</h1>
<p>他にも <code>debian/changelog</code> などを編集、コミット、タグ打ちをして準備ができた状態で、以下のコマンドでビルドしました。</p>
<h2 id="ソースパッケージのビルド">ソースパッケージのビルド</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">gbp buildpackage --git-export-dir=.. -p/home/hnakamur/bin/gpg-passphrase -S -sa -d
</span></span></span></code></pre></div><p>以前は <code>--git-export-dir</code> は <code>../build-area</code> としていましたが、この後のsbuildでupstreamのソースを <code>../go-carbon_0.12.0.orig.tar.gz</code> というパスで参照しようとするので <code>..</code> に変えました。</p>
<h2 id="バイナリパッケージのビルド">バイナリパッケージのビルド</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">TERM=unknown DEB_BUILD_OPTIONS=parallel=2 V=1 sbuild --sbuild-mode=buildd \
</span></span></span><span class="line"><span class="cl"><span class="go">    --extra-repository=&#34;deb http://ppa.launchpad.net/hnakamur/golang-1.10/ubuntu bionic main&#34; \
</span></span></span><span class="line"><span class="cl"><span class="go">    --extra-repository-key /etc/apt/trusted.gpg.d/hnakamur_ubuntu_golang-1_10.gpg
</span></span></span></code></pre></div><p>何度も試行錯誤しているとPPAからダウンロードする時間が気になってくるので、以下のコマンドでchrootのホストのfreightを使うようにしました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">TERM=unknown DEB_BUILD_OPTIONS=parallel=2 V=1 sbuild --sbuild-mode=buildd \
</span></span></span><span class="line"><span class="cl"><span class="go">	--extra-repository=&#34;deb http://127.0.0.1/freight bionic main&#34; \
</span></span></span><span class="line"><span class="cl"><span class="go">	--extra-repository-key /var/cache/freight/pubkey.gpg
</span></span></span></code></pre></div><p><code>/etc/nginx/conf.d/default.conf</code> には以下のように設定しています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">server {
</span></span><span class="line"><span class="cl">    listen       80;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">…（略） …
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    location /freight {
</span></span><span class="line"><span class="cl">	alias  /var/cache/freight;
</span></span><span class="line"><span class="cl">	index  index.html index.htm;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">…（略） …
</span></span></code></pre></div><p>2018-06-19 追記。 <a href="http://manpages.ubuntu.com/manpages/bionic/en/man1/sbuild.1.html">man sbuild</a> によると sbuild は引数に .dsc ファイルのパスを渡すこともできます。当初は省略して使っていたのですが、こうすると親ディレクトリの <code>*.dsc</code> や <code>*_source.changes</code> が署名なしのファイルで上書きされ <code>dput</code> でPPAにアップロードしようとするとエラーになってしまうことがわかりました。</p>
<p>sbuild でも署名する方法もあるようなのですがchroot環境でgpgを使えるようにセットアップが必要そうで面倒そうです。sbuildの引数に .dsc ファイルのパスを渡せば、指定したファイルを読み込んでビルドし上書きはしないことがわかったので、渡すようにしました。</p>
<p>例えば以下のように実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">TERM=unknown DEB_BUILD_OPTIONS=parallel=2 V=1 sbuild --sbuild-mode=buildd \
</span></span></span><span class="line"><span class="cl"><span class="go">	--extra-repository=&#34;deb http://127.0.0.1/freight bionic main&#34; \
</span></span></span><span class="line"><span class="cl"><span class="go">	--extra-repository-key /var/cache/freight/pubkey.gpg \
</span></span></span></code></pre></div><pre><code>            ../go-carbon_0.12.0-1ppa6~ubuntu18.04.1.dsc
</code></pre>
<p>.dscファイルパスを書くときにbashのコマンドライン補完が効かなかったので、事前に <code>ls</code> とかで補完して tmux でコピーしてから、上記のコマンドを書いてペーストするようにしました。</p>
<p>引数に .dsc ファイルを指定した場合は、ビルドの成果物は親ディレクトリではなくカレントディレクトリに作られました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ls -1 go-carbon_*
</span></span><span class="line"><span class="cl"><span class="go">go-carbon_0.12.0-1ppa6~ubuntu18.04.1_amd64.buildinfo
</span></span></span><span class="line"><span class="cl"><span class="go">go-carbon_0.12.0-1ppa6~ubuntu18.04.1_amd64.changes
</span></span></span><span class="line"><span class="cl"><span class="go">go-carbon_0.12.0-1ppa6~ubuntu18.04.1_amd64.deb
</span></span></span></code></pre></div>
</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
