<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>go-carbonのdebパッケージをsbuildとPPAでビルドした</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/06/15/built-go-carbon-deb-using-sbuild-and-ppa/" rel="bookmark"
           title="Permalink to go-carbonのdebパッケージをsbuildとPPAでビルドした">go-carbonのdebパッケージをsbuildとPPAでビルドした</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-06-15T10:55:00+09:00">
                Published: 2018-06-15
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/ubuntu.html">ubuntu</a> <a href="../../../../tag/deb.html">deb</a> <a href="../../../../tag/sbuild.html">sbuild</a> <a href="../../../../tag/go-carbon.html">go-carbon</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="https://github.com/lomik/go-carbon">lomik/go-carbon: Golang implementation of Graphite/Carbon server with classic architecture: Agent -&gt; Cache -&gt; Persister</a>
のdebパッケージをsbuildとPPAでビルドしたときのメモです。</p>
<p>成果物は以下に有ります。</p>
<ul class="simple">
<li>PPA: <a class="reference external" href="https://launchpad.net/~hnakamur/+archive/ubuntu/go-carbon">go-carbon : Hiroaki Nakamura</a></li>
<li>debソースレポジトリ: <a class="reference external" href="https://github.com/hnakamur/go-carbon-deb">hnakamur/go-carbon-deb: go-carbon deb package for Ubuntu 18.04 LTS</a></li>
</ul>
</div>
<div class="section" id="debiango">
<h2>debianでのgoのパッケージング方針</h2>
<ul class="simple">
<li><a class="reference external" href="https://wiki.debian.org/MichaelStapelberg/GoPackaging">MichaelStapelberg/GoPackaging - Debian Wiki</a></li>
<li><a class="reference external" href="https://go-team.pages.debian.net/packaging.html">Debian Go Packaging</a></li>
</ul>
<p>に書いてあります。</p>
<p>Goのバイナリ実行ファイルを作る場合に依存ライブラリを別パッケージで作る方針になっていますが、現時点では個人的にはこれは賛同できないです。複数のバイナリパッケージがあるときに同じライブラリに依存するけど必要なバージョンが異なるケースがあり得るからです。</p>
<p>現状だとベンダリングとスタティックリンクで個々のバイナリパッケージ単独で完結するほうがお手軽なので、自作のdebパッケージではそうすることにしました。都合の良いことに go-carbon は dep を使ってベンダリングしており、依存ライブラリのソースは全て vendor ディレクトリに含まれています。</p>
</div>
<div class="section" id="dh-golangdh-make-golang">
<h2>dh-golangとdh-make-golangをインストール</h2>
<p>dh-golang は goのパッケージを作るための dh (debhelper) のアドオンです。
dh-make-golang はgoのパッケージのソースからdebパッケージを作成するのを自動化するツールです。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt install dh-golang dh-make-golang</span>
</pre></div>
</div>
<div class="section" id="dh-make-golangdeb">
<h2>dh-make-golangでdebパッケージのソースのベースを作成</h2>
<p>dh-make-golang というツールを使えばdebianのgoのパッケージ方針に従ってパッケージを作成してくれるようなのですが、上記のように依存ライブラリの方針が違うので、debパッケージのソースを生成するところだけ使って、そこから先は手で編集することにしました。</p>
<div class="highlight"><pre><span></span><span class="go">mkdir -p ~/go-carbon-deb-work</span>
<span class="go">cd !$</span>
</pre></div>
<p><code>dh-make-golang ビルド対象のgoパッケージ名</code> でdebパッケージのソースが作成されます。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> dh-make-golang github.com/lomik/go-carbon
<span class="go">2018/06/15 11:33:49 Downloading &quot;github.com/lomik/go-carbon/...&quot;</span>
<span class="go">2018/06/15 11:33:52 Deleting upstream vendor/ directory, installing remaining dependencies</span>
<span class="go">2018/06/15 11:35:57 Determining upstream version number</span>
<span class="go">2018/06/15 11:35:57 Package version is &quot;0.12.0+git20180608.b1e6baf&quot;</span>
<span class="go">2018/06/15 11:35:57 Determining package type</span>
<span class="go">2018/06/15 11:35:57 Assuming you are packaging a program (because &quot;github.com/lomik/go-carbon&quot; defines a main package), use -type to override</span>
<span class="go">2018/06/15 11:35:57 Determining dependencies</span>
<span class="go">2018/06/15 11:36:02 Build-Dependency &quot;github.com/go-graphite/carbonzipper&quot; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control</span>
<span class="go">2018/06/15 11:36:02 Build-Dependency &quot;github.com/lomik/stop&quot; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control</span>
<span class="go">2018/06/15 11:36:02 Build-Dependency &quot;github.com/dgryski/go-expirecache&quot; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control</span>
<span class="go">2018/06/15 11:36:02 Build-Dependency &quot;github.com/lomik/og-rek&quot; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control</span>
<span class="go">2018/06/15 11:36:02 Build-Dependency &quot;github.com/dgryski/go-trigram&quot; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control</span>
<span class="go">2018/06/15 11:36:02 Build-Dependency &quot;github.com/dgryski/httputil&quot; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control</span>
<span class="go">2018/06/15 11:36:02 Build-Dependency &quot;github.com/go-graphite/go-whisper&quot; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control</span>
<span class="go">2018/06/15 11:36:02 Build-Dependency &quot;github.com/go-graphite/protocol&quot; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control</span>
<span class="go">2018/06/15 11:36:02 Build-Dependency &quot;github.com/lomik/zapwriter&quot; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control</span>
<span class="go">2018/06/15 11:36:02 Build-Dependency &quot;github.com/lomik/graphite-pickle&quot; is not yet available in Debian, or has not yet been converted to use XS-Go-Import-Path in debian/control</span>
<span class="go">2018/06/15 11:36:06</span>
<span class="go">2018/06/15 11:36:06 Packaging successfully created in /home/hnakamur/go-carbon-deb-work/go-carbon</span>
<span class="go">2018/06/15 11:36:06</span>
<span class="go">2018/06/15 11:36:06 Resolve all TODOs in itp-go-carbon.txt, then email it out:</span>
<span class="go">2018/06/15 11:36:06     sendmail -t &lt; itp-go-carbon.txt</span>
<span class="go">2018/06/15 11:36:06</span>
<span class="go">2018/06/15 11:36:06 Resolve all the TODOs in debian/, find them using:</span>
<span class="go">2018/06/15 11:36:06     grep -r TODO debian</span>
<span class="go">2018/06/15 11:36:06</span>
<span class="go">2018/06/15 11:36:06 To build the package, commit the packaging and use gbp buildpackage:</span>
<span class="go">2018/06/15 11:36:06     git add debian &amp;&amp; git commit -a -m &#39;Initial packaging&#39;</span>
<span class="go">2018/06/15 11:36:06     gbp buildpackage --git-pbuilder</span>
<span class="go">2018/06/15 11:36:06</span>
<span class="go">2018/06/15 11:36:06 To create the packaging git repository on alioth, use:</span>
<span class="go">2018/06/15 11:36:06     ssh git.debian.org &quot;/git/pkg-go/setup-repository go-carbon &#39;Packaging for go-carbon&#39;&quot;</span>
<span class="go">2018/06/15 11:36:06</span>
<span class="go">2018/06/15 11:36:06 Once you are happy with your packaging, push it to alioth using:</span>
<span class="go">2018/06/15 11:36:06     git remote set-url origin git+ssh://git.debian.org/git/pkg-go/packages/go-carbon.git</span>
<span class="go">2018/06/15 11:36:06     gbp push</span>
</pre></div>
<p><code>~/go-carbon-deb-work/go-carbon</code> ディレクトリが新たに作られてdebパッケージのソースがそこに生成されています。
上記の出力にあるとおり、go-carbonに含まれるvendorディレクトリは削除されて、依存ライブラリのソースが別途取得されています。</p>
<p>というわけで <code>debian/*</code> ファイルだけ頂くことにします。</p>
</div>
<div class="section" id="gbp-import-origgo-carbon">
<h2>gbp import-origでgo-carbonのソースをインポート</h2>
<p>まず今回ビルドする go-carbon の v0.12.0 のソースを取得します。</p>
<div class="highlight"><pre><span></span><span class="go">mkdir -p ~/go-carbon-deb-work</span>
<span class="go">cd !$</span>
<span class="go">curl -LO https://github.com/lomik/go-carbon/archive/v0.12.0.tar.gz</span>
</pre></div>
<p>debパッケージ用の作業ディレクトリを作成してそちらに移動しgitレポジトリを作成します。</p>
<div class="highlight"><pre><span></span><span class="go">mkdir -p ~/.ghq/github.com/hnakamur/go-carbon-deb</span>
<span class="go">cd !$</span>
<span class="go">git init</span>
</pre></div>
<p><code>gbp import-orig</code> でgo-carbonのソースをインポートします。以下のようにソースパッケージ名を聞かれるので go-carbon と入力します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp import-orig --pristine-tar -u <span class="m">0</span>.12.0 ~/go-carbon-deb-work/v0.12.0.tar.gz
<span class="go">What will be the source package name? [] go-carbon</span>
</pre></div>
</div>
<div class="section" id="dh-make-golangdebian">
<h2>dh-make-golangで生成したdebianディレクトリのファイルをコピー</h2>
<p>上記で dh-make-golangで生成した <code>debian/*</code> ファイルをコピーして、一旦コミットします。</p>
<div class="highlight"><pre><span></span><span class="go">rsync -a ~/go-carbon-deb-work/go-carbon/debian .</span>
<span class="go">git add .</span>
<span class="go">git commit -m &quot;Add debian/* files generated by dh-make-golang&quot;</span>
</pre></div>
</div>
<div class="section" id="debian">
<h2>debianディレクトリのファイルを編集</h2>
<p>以下は主なところだけ説明します。</p>
<div class="section" id="debian-control">
<h3>debian/controlを編集</h3>
<p>Build-Dependsから依存ライブラリを外します。
また、Maintainerなど他の項目も適宜変更しました。</p>
<div class="highlight"><pre><span></span><span class="gh">diff --git a/debian/control b/debian/control</span>
<span class="gh">index 486eb87..b5ee819 100644</span>
<span class="gd">--- a/debian/control</span>
<span class="gi">+++ b/debian/control</span>
<span class="gu">@@ -1,397 +1,19 @@</span>
 Source: go-carbon
 Section: devel
 Priority: optional
<span class="gd">-Maintainer: Debian Go Packaging Team &lt;pkg-go-maintainers@lists.alioth.debian.org&gt;</span>
<span class="gd">-Uploaders: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;</span>
<span class="gi">+Maintainer: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;</span>
 Build-Depends: debhelper (&gt;= 10),
                dh-golang,
<span class="gd">-               golang-any,</span>
<span class="gd">-               golang-github-klauspost-compress-dev,</span>
<span class="gd">-               golang-github-nytimes-gziphandler-dev,</span>
<span class="gd">-               golang-github-sevlyar-go-daemon-dev,</span>
<span class="gd">-               golang-github-shopify-sarama-dev,</span>
<span class="gd">-               golang-github-stretchr-testify-dev,</span>
<span class="gd">-               golang-go.uber-zap-dev,</span>
<span class="gd">-               golang-gogoprotobuf-dev,</span>
<span class="gd">-               golang-golang-x-net-dev,</span>
<span class="gd">-               golang-goleveldb-dev,</span>
<span class="gd">-               golang-google-api-dev,</span>
<span class="gd">-               golang-google-cloud-dev,</span>
<span class="gd">-               golang-google-grpc-dev,</span>
<span class="gd">-               golang-toml-dev</span>
<span class="gi">+               golang-any</span>
…（略） …
</pre></div>
</div>
<div class="section" id="debian-go-carbon-dirs">
<h3>debian/go-carbon.dirsを作成</h3>
<p>インストール時に作成するディレクトリを指定します。</p>
<div class="highlight"><pre><span></span>/etc/go-carbon
/var/lib/graphite/whisper
/var/log/go-carbon
</pre></div>
</div>
<div class="section" id="debian-go-carbon-postinst">
<h3>debian/go-carbon.postinstを作成</h3>
<p>インストール後に実行するスクリプトを作成します。</p>
<p>nginx.orgのdebパッケージに含まれる debian/nginx.postinst を参考にしました。そちらではsystemdではないinit.dにも対応していましたが、私は不要なのでsystemd限定にしています。</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="nb">set</span> -e

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;configure&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">exit</span> <span class="m">0</span>
<span class="k">fi</span>

<span class="c1"># Set permisions on default data directory on installation</span>
<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    chown carbon:carbon /var/lib/graphite/whisper
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> -f /var/run/go-carbon.pid <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> -0 <span class="k">$(</span>cat /var/run/nginx.pid<span class="k">)</span> &gt;/dev/null<span class="p">;</span> <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;######################################&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;# Please restart go-carbon manually. #&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;######################################&quot;</span>
<span class="k">else</span>
    invoke-rc.d go-carbon start <span class="o">||</span> <span class="nb">true</span>
<span class="k">fi</span>

<span class="c1">#DEBHELPER#</span>

<span class="nb">exit</span> <span class="m">0</span>
</pre></div>
<p><code>invoke-rc.d</code> コマンドは今回初めて知ったのですが
<a class="reference external" href="http://manpages.ubuntu.com/manpages/bionic/en/man8/invoke-rc.d.8.html">man invoke-rc.d</a>
のDESCRIPTIONに以下のように書かれているので、debパッケージのスクリプトでサービス起動するときは <code>systemctl</code> ではなくこちらを使うのが良いようです。</p>
<div class="highlight"><pre><span></span>All access to the init scripts by Debian packages&#39; maintainer scripts should be done through invoke-rc.d.
</pre></div>
<p>また、go-carbonは graceful restart に対応していないので、プロセス起動中にパッケージアップデートする場合はメッセージを表示するだけで再起動はしないようにしました。別途再起動を行う想定です。</p>
</div>
<div class="section" id="debian-go-carbon-postrm">
<h3>debian/go-carbon.postrmを作成</h3>
<p>アンインストール後に実行するスクリプトを作成します。</p>
<p>nginxの <code>debian/nginx.postrm</code> ではサービスを止めるようなコマンドも含まれていたのですが、試してみると自分で書かなくても止めてくれたので省きました。</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="nb">set</span> -e

<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> in
    purge<span class="o">)</span>
        rm -rf /var/lib/graphite/whisper /var/log/go-carbon
        <span class="p">;;</span>
    remove<span class="p">|</span>upgrade<span class="p">|</span>failed-upgrade<span class="p">|</span>abort-install<span class="p">|</span>abort-upgrade<span class="p">|</span>disappear<span class="o">)</span>
        <span class="p">;;</span>
    *<span class="o">)</span>
        <span class="nb">echo</span> <span class="s2">&quot;postrm called with unknown argument \`</span><span class="nv">$1</span><span class="s2">&#39;&quot;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
        <span class="nb">exit</span> <span class="m">1</span>
<span class="k">esac</span>

<span class="c1">#DEBHELPER#</span>

<span class="nb">exit</span> <span class="m">0</span>
</pre></div>
<p><code>apt remove go-carbon</code> でアンインストールした後
<code>apt purge go-carbon</code> を実行すると、whisperファイルとログファイルを消すようにしました。</p>
<p>nginxの <code>debian/nginx.postrm</code> では設定ファイルのディレクトリ <code>/etc/nginx/</code> も消すように書かれていましたが、試してみるとgo-carbonの設定ファイルのディレクトリ <code>/etc/go-carbon</code> は明示的に消すように書かなくても自動で消されたので上記のスクリプトでは省いています。</p>
</div>
<div class="section" id="go-carbonsystemd-service">
<h3>go-carbonのソースに含まれていたsystemd service定義ファイルを改良</h3>
<p><code>PIDFile</code> の項目がなかったので追加しました。
これを書いておくと <code>systemctl stop go-carbon</code> でサービスを止めたり、起動中に <code>apt remove go-carbon</code> でアンインストールしたときにPIDファイルを自動で消してくれました。</p>
<div class="highlight"><pre><span></span>diff --git a/debian/go-carbon.service b/debian/go-carbon.service
index 0d933dd..a421bb7 100644
--- a/debian/go-carbon.service
+++ b/debian/go-carbon.service
@@ -6,6 +6,7 @@ After=network.target
 [Service]
 Type=forking
 ExecStart=/usr/bin/go-carbon -config /etc/go-carbon/go-carbon.conf -pidfile /var/run/go-carbon.pid -daemon
+PIDFile=/var/run/go-carbon.pid
 ExecReload=/bin/kill -HUP $MAINPID
 KillSignal=USR2
 Restart=on-failure
@@ -15,4 +16,4 @@ LimitNOFILE=55555
 LimitMEMLOCK=infinity

 [Install]
-WantedBy=multi-user.target
\ No newline at end of file
+WantedBy=multi-user.target
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>ビルド手順</h2>
<p>他にも <code>debian/changelog</code> などを編集、コミット、タグ打ちをして準備ができた状態で、以下のコマンドでビルドしました。</p>
<div class="section" id="id3">
<h3>ソースパッケージのビルド</h3>
<div class="highlight"><pre><span></span><span class="go">gbp buildpackage --git-export-dir=.. -p/home/hnakamur/bin/gpg-passphrase -S -sa -d</span>
</pre></div>
<p>以前は <code>--git-export-dir</code> は <code>../build-area</code> としていましたが、この後のsbuildでupstreamのソースを <code>../go-carbon_0.12.0.orig.tar.gz</code> というパスで参照しようとするので <code>..</code> に変えました。</p>
</div>
<div class="section" id="id4">
<h3>バイナリパッケージのビルド</h3>
<div class="highlight"><pre><span></span><span class="go">TERM=unknown DEB_BUILD_OPTIONS=parallel=2 V=1 sbuild --sbuild-mode=buildd \</span>
<span class="go">    --extra-repository=&quot;deb http://ppa.launchpad.net/hnakamur/golang-1.10/ubuntu bionic main&quot; \</span>
<span class="go">    --extra-repository-key /etc/apt/trusted.gpg.d/hnakamur_ubuntu_golang-1_10.gpg</span>
</pre></div>
</div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>