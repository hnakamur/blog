<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>ClamAVをUbuntu MATE 18.04 LTSにセットアップ</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/05/21/setup-clamav-on-ubuntu-mate-18.04-lts/" rel="bookmark"
           title="Permalink to ClamAVをUbuntu MATE 18.04 LTSにセットアップ">ClamAVをUbuntu MATE 18.04 LTSにセットアップ</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-05-21T15:00:00+09:00">
                Published: 2018-05-21
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/ubuntu.html">ubuntu</a> <a href="../../../../tag/ubuntu-mate.html">ubuntu-mate</a> <a href="../../../../tag/clamav.html">clamav</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>Ubuntu MATE 18.04 LTSの環境にオープンソースのアンチウィルスソフト <a class="reference external" href="https://www.clamav.net/">ClamAV</a> をセットアップしてみたメモです。例によっていろいろ試行錯誤した後に思い出しながら書いているので、多少抜けがあるかも。</p>
</div>
<div class="section" id="id2">
<h2>インストール</h2>
<div class="highlight"><pre><span></span><span class="go">sudo apt install clamav-daemon clamav-freshclam</span>
</pre></div>
</div>
<div class="section" id="id3">
<h2>初回のパターンファイル更新と手動スキャンの動作確認</h2>
<p><a class="reference external" href="https://www.server-world.info/query?os=Ubuntu_18.04&amp;p=clamav">Ubuntu 18.04 LTS : Clamav アンチウィルス : Server World</a>
を参考に試しました。</p>
<div class="section" id="id4">
<h3>初回のパターンファイル更新</h3>
<p>以下の手順で初回のパターンファイル更新を行います。</p>
<div class="highlight"><pre><span></span><span class="go">sudo sed -i -e &quot;s/^NotifyClamd/#NotifyClamd/g&quot; /etc/clamav/freshclam.conf</span>
<span class="go">sudo systemctl stop clamav-freshclam</span>
<span class="go">sudo freshclam</span>
<span class="go">sudo systemctl start clamav-freshclam</span>
<span class="go">sudo sed -i -e &quot;s/^#NotifyClamd/NotifyClamd/g&quot; /etc/clamav/freshclam.conf</span>
</pre></div>
</div>
<div class="section" id="id5">
<h3>手動スキャンの動作確認</h3>
<p>ウィルスがない状態での手動スキャンの動作確認。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> clamscan --infected --remove --recursive ~/Downloads/

<span class="go">----------- SCAN SUMMARY -----------</span>
<span class="go">Known viruses: 9436590</span>
<span class="go">Engine version: 0.99.4</span>
<span class="go">Scanned directories: 1</span>
<span class="go">Scanned files: 1</span>
<span class="go">Infected files: 0</span>
<span class="go">Data scanned: 0.64 MB</span>
<span class="go">Data read: 0.19 MB (ratio 3.40:1)</span>
<span class="go">Time: 13.025 sec (0 m 13 s)</span>
</pre></div>
<p>実験用の無害なウィルスをダウンロード。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> curl -o ~/Downloads/eicar.com http://www.eicar.org/download/eicar.com
</pre></div>
<p>ウィルスがある状態での手動スキャンの動作確認。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> clamscan --infected --remove --recursive ~/Downloads/
<span class="go">/home/hnakamur/Downloads/eicar.com: Eicar-Test-Signature FOUND</span>
<span class="go">/home/hnakamur/Downloads/eicar.com: Removed.</span>

<span class="go">----------- SCAN SUMMARY -----------</span>
<span class="go">Known viruses: 9436590</span>
<span class="go">Engine version: 0.99.4</span>
<span class="go">Scanned directories: 1</span>
<span class="go">Scanned files: 2</span>
<span class="go">Infected files: 1</span>
<span class="go">Data scanned: 0.64 MB</span>
<span class="go">Data read: 0.19 MB (ratio 3.40:1)</span>
<span class="go">Time: 12.698 sec (0 m 12 s)</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h2>設定</h2>
<p>scan on-access というリアルタイムスキャンと <a class="reference external" href="https://www.thunderbird.net/ja/">Thunderbird</a> の <a class="reference external" href="https://addons.mozilla.org/ja/thunderbird/addon/clamdrib-lin/">clamdrib LIN</a> アドオンでメールをスキャンするのを試しました。</p>
<p><a class="reference external" href="https://askubuntu.com/questions/591325/how-to-scan-on-access-with-clamav-in-14-04/821510#821510">how to scan on-access with clamav in 14.04 - Ask Ubuntu</a> と
<a class="reference external" href="https://help.ubuntu.com/community/ScanningEmail">ScanningEmail - Community Help Wiki</a>
を参考にしました。</p>
<p>aptでインストールした時点ではclamavユーザでclamdを動かすようになっていたのですが、
<code>/etc/clamav/clamd.conf</code> で <code>ScanOnAccess</code> をtrueにして動かすと
journalログに <code>ScanOnAccess: clamd must be started by root</code> というエラーが出たので
rootユーザで動かすように変更しました。</p>
<p><code>/etc/clamav/clamd.conf</code> の変更内容は以下のとおりです。</p>
<div class="highlight"><pre><span></span><span class="gd">--- /etc/clamav/clamd.conf.orig 2018-05-21 09:10:20.517179341 +0900</span>
<span class="gi">+++ /etc/clamav/clamd.conf      2018-05-21 15:16:22.140152503 +0900</span>
<span class="gu">@@ -7,7 +7,7 @@</span>
 LocalSocketMode 666
 # TemporaryDirectory is not set to its default /tmp here to make overriding
 # the default with environment variables TMPDIR/TMP/TEMP possible
<span class="gd">-User clamav</span>
<span class="gi">+#User clamav</span>
 ScanMail true
 ScanArchive true
 ArchiveBlockEncrypted false
<span class="gu">@@ -58,15 +58,15 @@</span>
 MaxQueue 100
 ExtendedDetectionInfo true
 OLE2BlockMacros false
<span class="gd">-ScanOnAccess false</span>
<span class="gi">+#ScanOnAccess false</span>
 AllowAllMatchScan true
 ForceToDisk false
 DisableCertCheck false
 DisableCache false
<span class="gd">-MaxScanSize 100M</span>
<span class="gd">-MaxFileSize 25M</span>
<span class="gi">+#MaxScanSize 100M</span>
<span class="gi">+#MaxFileSize 25M</span>
 MaxRecursion 16
<span class="gd">-MaxFiles 10000</span>
<span class="gi">+#MaxFiles 10000</span>
 MaxPartitions 50
 MaxIconsPE 100
 PCREMatchLimit 10000
<span class="gu">@@ -87,3 +87,26 @@</span>
 Bytecode true
 BytecodeSecurity TrustSigned
 BytecodeTimeout 60000
<span class="gi">+</span>
<span class="gi">+# NOTE: The max possible value for MaxScanSize and MaxFileSize is 4000M.</span>
<span class="gi">+# When I used the value like 4096M, I got the following warnings.</span>
<span class="gi">+# WARNING: Numerical value for option MaxScanSize too high, resetting to 4G</span>
<span class="gi">+# WARNING: Numerical value for option MaxFileSize too high, resetting to 4G</span>
<span class="gi">+MaxScanSize 4000M</span>
<span class="gi">+MaxFileSize 4000M</span>
<span class="gi">+MaxFiles 100000</span>
<span class="gi">+</span>
<span class="gi">+# NOTE: User must be root in order to use ScanOnAccess.</span>
<span class="gi">+# When I ran clamav-daemon with clamav User with ScanOnAccess true,</span>
<span class="gi">+# I got the following error in journalctl.</span>
<span class="gi">+# clamd[14963]: ScanOnAccess: clamd must be started by root</span>
<span class="gi">+User root</span>
<span class="gi">+ScanOnAccess true</span>
<span class="gi">+OnAccessMountPath /home</span>
<span class="gi">+VirusEvent /usr/local/bin/clamd-response</span>
<span class="gi">+</span>
<span class="gi">+# Config for Thunderbird clamdrib LIN extension</span>
<span class="gi">+TCPSocket 3310</span>
<span class="gi">+TCPAddr 127.0.0.1</span>
</pre></div>
<p><code>/etc/systemd/system/clamav-daemon.socket</code> というファイルを以下のコマンドで作成しました。</p>
<div class="highlight"><pre><span></span><span class="go">cat &lt;&lt;&#39;EOF&#39; | sudo tee /etc/systemd/system/clamav-daemon.socket</span>
<span class="go">[Unit]</span>
<span class="go">Description=clamav clamd socket</span>

<span class="go">[Socket]</span>
<span class="go">SocketUser=clamav</span>
<span class="go">ListenStream=127.0.0.1:3310</span>
<span class="go">EOF</span>
</pre></div>
<p>さらに以下のコマンドを実行して設定ファイルの変更をsystemdに反映させます。</p>
<div class="highlight"><pre><span></span><span class="go">sudo systemctl daemon-reload</span>
</pre></div>
<p>上記の <code>VirusEvent</code> に指定した <code>/usr/local/bin/clamd-response</code> は以下のコマンドで作成しました。ユーザ名の hnakamur の箇所は適宜変更してください。</p>
<div class="highlight"><pre><span></span><span class="go">cat &lt;&lt;&#39;EOF&#39; | sudo tee /usr/local/bin/clamd-response</span>
<span class="gp">#</span>!/bin/sh
<span class="go">echo &quot;$(date) - $CLAM_VIRUSEVENT_VIRUSNAME &gt; $CLAM_VIRUSEVENT_FILENAME&quot; &gt;&gt; /var/log/clamav/infected.log</span>
<span class="go">rm $CLAM_VIRUSEVENT_FILENAME</span>
<span class="go">sudo -u hnakamur DISPLAY=:0.0 notify-send &quot;Virus Found $CLAM_VIRUSEVENT_VIRUSNAME&quot; &quot;$CLAM_VIRUSEVENT_FILENAME has been removed&quot;</span>
<span class="go">EOF</span>
<span class="go">sudo chmod +x /usr/local/bin/clamd-response</span>
</pre></div>
<p>以下のコマンドでサービスを再起動します。</p>
<div class="highlight"><pre><span></span><span class="go">sudo systemctl restart clamav-daemon.service clamav-daemon.socket clamav-freshclam.service</span>
</pre></div>
<p>以下のコマンドでサービスの状態を確認します。</p>
<div class="highlight"><pre><span></span><span class="go">sudo systemctl status clamav-daemon.service clamav-daemon.socket clamav-freshclam.service</span>
</pre></div>
</div>
<div class="section" id="scan-on-access">
<h2>Scan On Accessの動作確認</h2>
<p>上記の実験用の無害なウィルスをChromeでダウンロードすると、上記のスクリプト <code>/usr/local/bin/clamd-response</code> が動いて <code>/var/log/clamav/infected.log</code> にメッセージが追記され、通知ポップアップが表示されることを確認しました。</p>
</div>
<div class="section" id="id7">
<h2>Thunderbirdでのウィルスチェックの動作確認</h2>
<p><a class="reference external" href="http://spacesheriffsharivan.blog9.fc2.com/blog-entry-98.html">ぺんぎん戦記 Thnderbirdアドオン clamdribの導入</a> を参考に動作確認しました。</p>
<p>Thunderbirdとcramdlib LINアドオンをセットアップした状態で、clamdへの接続確認は cramdlib LINアドオンの設定画面の <code>Test settings</code> ボタンを押して Success と表示されればOKです。</p>
<p>動作確認ですが、メールを1件選択すると「返信」ボタンが並んでいる上に <code>ClamAV status: CLEAN</code> (CLEANは緑で表示)と無事表示されました。</p>
<p>ちなみに <code>clamav-daemon</code> サービスを止めて試すと
<code>ClamAV status: CONNECTION PROBLEMS</code> (CONNECTION PROBLEMSは黄色で表示)という表示になりました。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>