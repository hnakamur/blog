<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.109.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>MacBook Pro上のUbuntu 18.04でサスペンドが動くようにする &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>MacBook Pro上のUbuntu 18.04でサスペンドが動くようにする</h1>
  <time datetime=2018-05-06T09:45:00&#43;0900 class="post-date">2018-05-06</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#設定方法">設定方法</a></li>
    <li><a href="#参考-etcrclocalはtypeforkingを使っていた">(参考) /etc/rc.localはType=forkingを使っていた</a></li>
  </ul>
</nav>
  <h1 id="はじめに">はじめに</h1>
<p>MacBook Pro 15-inch, Mid 2012 (機種ID: MacBookPro10,1)にUbuntu 18.04をインストールしてみたのですが、動かしたまま画面を閉じるとAppleマークのライトは消えるのですがファンは回り続け、その後画面を開いても復帰しない状態でした。</p>
<p>検索してみると <a href="https://joshtronic.com/2017/03/13/getting-suspend-in-linux-working-on-a-macbook-pro/">Getting suspend in Linux working on a MacBook Pro</a> という記事があったので、これを参考に設定してみました。</p>
<h2 id="設定方法">設定方法</h2>
<p>ちょうど良さそうなので
<a href="http://manpages.ubuntu.com/manpages/bionic/en/man5/systemd.service.5.html">systemd.service (5)</a>
の <code>type=oneshot</code> を使ってみました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/workaround-for-suspend.service &gt; /dev/null
</span></span></span><span class="line"><span class="cl"><span class="go">[Unit]
</span></span></span><span class="line"><span class="cl"><span class="go">Description=A workaround to get suspend work properly when lid are closed
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> https://joshtronic.com/2017/03/13/getting-suspend-in-linux-working-on-a-macbook-pro/
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[Service]
</span></span></span><span class="line"><span class="cl"><span class="go">Type=oneshot
</span></span></span><span class="line"><span class="cl"><span class="go">ExecStart=/bin/sh -c &#39;echo XHC1 &gt; /proc/acpi/wakeup &amp;&amp; echo LID0 &gt; /proc/acpi/wakeup&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">RemainAfterExit=yes
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[Install]
</span></span></span><span class="line"><span class="cl"><span class="go">WantedBy=multi-user.target
</span></span></span><span class="line"><span class="cl"><span class="go">EOF
</span></span></span><span class="line"><span class="cl"><span class="go">sudo systemctl daemon-reload
</span></span></span><span class="line"><span class="cl"><span class="go">sudo systemctl start workaround-for-suspend
</span></span></span><span class="line"><span class="cl"><span class="go">sudo systemctl enable workaround-for-suspend
</span></span></span></code></pre></div><p>今回知ったのですが、ずっと稼働し続けるようなサービスではなくて、実行して終了するようなプログラムを指定する場合は <code>RemainAfterExit=yes</code> を指定しておけば、サービスの状態確認では <code>active</code> と表示されます。意図通り正常に実行されているというのがわかりやすいのでつけてみました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> sudo systemctl status workaround-for-suspend
</span></span><span class="line"><span class="cl"><span class="go">● workaround-for-suspend.service - A workaround to get suspend work properly when lid are closed
</span></span></span><span class="line"><span class="cl"><span class="go">   Loaded: loaded (/etc/systemd/system/workaround-for-suspend.service; enabled; vendor preset: enabled)
</span></span></span><span class="line"><span class="cl"><span class="go">   Active: active (exited) since Sun 2018-05-06 09:39:59 JST; 14min ago
</span></span></span><span class="line"><span class="cl"><span class="go"> Main PID: 2976 (code=exited, status=0/SUCCESS)
</span></span></span><span class="line"><span class="cl"><span class="go">    Tasks: 0 (limit: 4915)
</span></span></span><span class="line"><span class="cl"><span class="go">   CGroup: /system.slice/workaround-for-suspend.service
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go"> 5月 06 09:39:59 sunshine7 systemd[1]: Starting A workaround to get suspend work properly when lid are closed...
</span></span></span><span class="line"><span class="cl"><span class="go"> 5月 06 09:39:59 sunshine7 systemd[1]: Started A workaround to get suspend work properly when lid are closed.
</span></span></span></code></pre></div><h2 id="参考-etcrclocalはtypeforkingを使っていた">(参考) /etc/rc.localはType=forkingを使っていた</h2>
<p><code>/etc/rc.local</code> について調べていたら、これもsystemdのサービスとして実装されていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> <span class="nv">LC_ALL</span><span class="o">=</span>C ls -l /lib/systemd/system/rc?local.service
</span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 716 Apr 21 01:55 /lib/systemd/system/rc-local.service
</span></span></span><span class="line"><span class="cl"><span class="go">lrwxrwxrwx 1 root root  16 Apr 29 00:52 /lib/systemd/system/rc.local.service -&gt; rc-local.service
</span></span></span></code></pre></div><p>脱線しますが、上のコマンドで <code>LC_ALL=C</code> のところを最初は <code>LANG=C</code> にして試したら日付が日本語で出てしまいました。検索してみると
<a href="https://deginzabi163.wordpress.com/2014/01/05/%E8%A6%9A%E6%9B%B8langc%E3%81%97%E3%81%A6%E3%82%82%E5%87%BA%E5%8A%9B%E3%81%8C%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%81%AE%E3%81%BE%E3%81%BE%EF%BC%81%EF%BC%81%EF%BC%81%E3%81%A8%E5%AF%BE%E7%AD%96/">[覚書]ざけんな。”LANG=C” “LANGUAGE=C”で日本語！！英語にならない！！の怒りの対策。”LC_ALL＝C”？”LANG=POSIX”?、suでdpkg-reconfigure locales情けないぞ！ | Deginzabi163&rsquo;s Blog</a> という記事がありました。</p>
<p>Ansibleのモジュール内でコマンドを実行するときも <code>LANG=C</code> を使っている箇所があるのでこれは困るなーと思うのですが、なぜこんなことになっていたのか。</p>
<p>話を戻して <code>/lib/systemd/system/rc-local.service</code> の中身は以下のようになっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">#  SPDX-License-Identifier: LGPL-2.1+
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl">#  This file is part of systemd.
</span></span><span class="line"><span class="cl">#
</span></span><span class="line"><span class="cl">#  systemd is free software; you can redistribute it and/or modify it
</span></span><span class="line"><span class="cl">#  under the terms of the GNU Lesser General Public License as published by
</span></span><span class="line"><span class="cl">#  the Free Software Foundation; either version 2.1 of the License, or
</span></span><span class="line"><span class="cl">#  (at your option) any later version.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># This unit gets pulled automatically into multi-user.target by
</span></span><span class="line"><span class="cl"># systemd-rc-local-generator if /etc/rc.local is executable.
</span></span><span class="line"><span class="cl">[Unit]
</span></span><span class="line"><span class="cl">Description=/etc/rc.local Compatibility
</span></span><span class="line"><span class="cl">Documentation=man:systemd-rc-local-generator(8)
</span></span><span class="line"><span class="cl">ConditionFileIsExecutable=/etc/rc.local
</span></span><span class="line"><span class="cl">After=network.target
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Service]
</span></span><span class="line"><span class="cl">Type=forking
</span></span><span class="line"><span class="cl">ExecStart=/etc/rc.local start
</span></span><span class="line"><span class="cl">TimeoutSec=0
</span></span><span class="line"><span class="cl">RemainAfterExit=yes
</span></span><span class="line"><span class="cl">GuessMainPID=no
</span></span></code></pre></div><p>Typeはoneshotではなくforkingを使っています。理由はわからないです。
ここでも <code>RemainAfterExit=yes</code> を使っています。というより、実はこれを見て知りました。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
