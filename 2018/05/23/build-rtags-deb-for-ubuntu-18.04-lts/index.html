<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.101.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Ubuntu 18.04 LTS用にrtagsのdebパッケージを作成した &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2022. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Ubuntu 18.04 LTS用にrtagsのdebパッケージを作成した</h1>
  <time datetime=2018-05-23T14:10:00&#43;0900 class="post-date">2018-05-23</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#参考-gcc-8とllvm-60入りのpbuilderのchroot環境作成">(参考) gcc-8とLLVM 6.0入りのpbuilderのchroot環境作成</a></li>
    <li><a href="#gitサブモジュールのソースも含めてオリジンのソースtarball作成">gitサブモジュールのソースも含めてオリジンのソースtarball作成</a></li>
    <li><a href="#作成したtarballをdebパッケージビルド用レポジトリにインポート">作成したtarballをdebパッケージビルド用レポジトリにインポート</a></li>
    <li><a href="#rtagsのテストの実行方法を修正するパッチ作成">rtagsのテストの実行方法を修正するパッチ作成</a></li>
  </ul>

  <ul>
    <li><a href="#インストール手順">インストール手順</a></li>
    <li><a href="#vim-rtagsのインストール">vim-rtagsのインストール</a></li>
    <li><a href="#rtagsのサーバ起動">rtagsのサーバ起動</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#読みたいソースのインデクス作成">読みたいソースのインデクス作成</a></li>
    <li><a href="#rtagsを利用してソースを読む">rtagsを利用してソースを読む</a></li>
  </ul>
</nav>
  <h1 id="はじめに">はじめに</h1>
<p><a href="/blog/2017/09/05/built-rtags-deb/">rtagsのdebパッケージを作成した</a> のときのメモを端折りすぎて、Ubuntu 18.04 LTS用に rtags 2.18のパッケージを作ろうと思ったら苦労したのでメモしておきます。</p>
<h1 id="ビルドのメモ">ビルドのメモ</h1>
<h2 id="参考-gcc-8とllvm-60入りのpbuilderのchroot環境作成">(参考) gcc-8とLLVM 6.0入りのpbuilderのchroot環境作成</h2>
<p>よくよく考えたらこの手順は不要ですが、今後別件で使うかもしれないのでメモ。</p>
<p>まず既存のchroot環境のtarballをお好みの名前のファイルにコピーします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo cp /var/cache/pbuilder/bionic-{base,gcc8-llvm6}.tar.gz
</span></span></span></code></pre></div><p><code>--save-after-login</code> オプションを指定しつつ、新しく作成したchroot環境にログインします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo pbuilder login --save-after-login --basetgz /var/cache/pbuilder/bionic-gcc8-llvm6.tar.gz
</span></span></span></code></pre></div><p>chroot環境内でお好みのパッケージをインストールし、exitで抜ければ保存されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt install gcc-8 g++-8 llvm-6.0-dev libclang-6.0-dev
</span></span></span><span class="line"><span class="cl"><span class="go">exit
</span></span></span></code></pre></div><p>利用時は pbuilder に <code>--basetgz /var/cache/pbuilder/bionic-gcc8-llvm6.tar.gz</code> を指定して実行します。</p>
<p>ただ、今回は <code>debian/control</code> の <code>Build-Depends</code> に必要なパッケージを書いているので上記の手順は不要でした。</p>
<h2 id="gitサブモジュールのソースも含めてオリジンのソースtarball作成">gitサブモジュールのソースも含めてオリジンのソースtarball作成</h2>
<p><a href="https://github.com/Andersbakken/rtags">Andersbakken/rtags: A c/c++ client/server indexer for c/c++/objc[++] with integration for Emacs based on clang.</a> ではgitサブモジュールを使っているので、オリジンのソースtarballを作成する際はサブモジュールのソースも含めておく必要が有ります。</p>
<p>rtagsの <a href="https://github.com/Andersbakken/rtags/blob/163c81ea636c2aaca78e76df174bfd5679015bd7/.gitmodules">.gitmodules</a> は以下のようになっていてサブモジュールの特定のコミットを指定するのではなく master で最新のコミットを参照するようになっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">[submodule &#34;src/rct&#34;]
</span></span><span class="line"><span class="cl">        path = src/rct
</span></span><span class="line"><span class="cl">        url = https://github.com/Andersbakken/rct
</span></span><span class="line"><span class="cl">        branch = master
</span></span><span class="line"><span class="cl">[submodule &#34;src/selene&#34;]
</span></span><span class="line"><span class="cl">        path = src/selene
</span></span><span class="line"><span class="cl">        url = https://github.com/jeremyong/Selene.git
</span></span><span class="line"><span class="cl">    branch = master
</span></span><span class="line"><span class="cl">[submodule &#34;src/lua&#34;]
</span></span><span class="line"><span class="cl">        path = src/lua
</span></span><span class="line"><span class="cl">        url = https://github.com/LuaDist/lua.git
</span></span><span class="line"><span class="cl">    branch = master
</span></span></code></pre></div><p>ということでrtagsの過去のリリースの際に参照していたサブモジュールのコミットはわからないので、最新を使うことにします。</p>
<p>以下のコマンドでサブモジュール入りのソースtarballを作成しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">git clone --recursive https://github.com/Andersbakken/rtags.git
</span></span></span><span class="line"><span class="cl"><span class="go">cd rtags
</span></span></span><span class="line"><span class="cl"><span class="go">git checkout v2.18
</span></span></span><span class="line"><span class="cl"><span class="go">cd ..
</span></span></span><span class="line"><span class="cl"><span class="go">mkdir -p ~/rtags-deb-work
</span></span></span><span class="line"><span class="cl"><span class="go">tar cf - --exclude=.git ./rtags | gzip -9 &gt; ~/rtags-deb-work/rtags-2.18-with-submodules.tar.gz
</span></span></span></code></pre></div><h2 id="作成したtarballをdebパッケージビルド用レポジトリにインポート">作成したtarballをdebパッケージビルド用レポジトリにインポート</h2>
<p>debパッケージビルド用レポジトリの作業ディレクトリに移動して以下のようにインポートしました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cd ~/.ghq/github.com/hnakamur/rtags-deb
</span></span></span><span class="line"><span class="cl"><span class="go">gbp import-orig --pristine-tar -u 2.18 ~/rtags-deb-work/rtags-2.18-with-submodules.tar.gz
</span></span></span></code></pre></div><h2 id="rtagsのテストの実行方法を修正するパッチ作成">rtagsのテストの実行方法を修正するパッチ作成</h2>
<p>あとはいつもの手順でdebパッケージをビルドすればOKかと思いきや、テストの実行時に <code>/usr/bin/rdm</code> というファイルがないというエラーになってしまいました。</p>
<p><code>rdm</code> は rtags で提供されるサーバプログラムですが、ビルド時はまだ /usr/bin/ にはインストールしていないので /usr/bin/rdm を参照するのは不適切です。</p>
<p><a href="https://cmake.org/cmake/help/v3.0/manual/cmake-variables.7.html">cmake-variables(7) — CMake 3.0.2 Documentation</a> を参照しつつ、twitter で <a href="https://twitter.com/objectxplosive/status/999151356249235456">眼力 玉壱號さんからのアドバイス</a> を頂いて以下のような
<a href="https://github.com/hnakamur/rtags-deb/blob/e63073a4275260a446af3fe3201e13749bd1b345/debian/patches/0001-Fix-bin-dir-for-tests.patch">パッチ</a>
を作成しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl">From: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
</span></span><span class="line"><span class="cl">Date: Wed, 23 May 2018 12:08:35 +0900
</span></span><span class="line"><span class="cl">Subject: Fix bin dir for tests
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gd">---
</span></span></span><span class="line"><span class="cl"><span class="gd"></span> CMakeLists.txt | 2 +-
</span></span><span class="line"><span class="cl"> 1 file changed, 1 insertion(+), 1 deletion(-)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/CMakeLists.txt b/CMakeLists.txt
</span></span></span><span class="line"><span class="cl"><span class="gh">index 4284e30..e7accfe 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/CMakeLists.txt
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/CMakeLists.txt
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -87,7 +87,7 @@ set(BIN ${CMAKE_INSTALL_PREFIX}/bin)
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> if (RTAGS_NO_INSTALL)
</span></span><span class="line"><span class="cl">     set(BIN ${CMAKE_BINARY_DIR}/bin)
</span></span><span class="line"><span class="cl"> endif ()
</span></span><span class="line"><span class="cl"><span class="gd">-add_test(SBRootTest perl &#34;${CMAKE_SOURCE_DIR}/tests/sbroot/sbroot_test.pl&#34; &#34;${BIN}&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+add_test(SBRootTest perl &#34;${CMAKE_SOURCE_DIR}/tests/sbroot/sbroot_test.pl&#34; &#34;${CMAKE_BINARY_DIR}/bin&#34;)
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> find_program(NOSETEST NAMES nosetests nosetests-2.7 PATHS &#34;$ENV{HOME}/.local/bin&#34;)
</span></span><span class="line"><span class="cl"> if (NOSETEST)
</span></span><span class="line"><span class="cl">     add_test(nosetests ${NOSETEST} -w ${CMAKE_SOURCE_DIR} -v)
</span></span></code></pre></div><p>あとはいつもどおりの手順でビルドできました。</p>
<h1 id="使い方">使い方</h1>
<h2 id="インストール手順">インストール手順</h2>
<p>ビルドしたパッケージは
<a href="https://launchpad.net/~hnakamur/+archive/ubuntu/vim">vim : Hiroaki Nakamura</a>
で公開しています。</p>
<p>以下の手順でインストール出来ます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo apt install software-properties-common
</span></span></span><span class="line"><span class="cl"><span class="go">sudo add-apt-repository ppa:hnakamur/vim
</span></span></span><span class="line"><span class="cl"><span class="go">sudo apt update
</span></span></span><span class="line"><span class="cl"><span class="go">sudo apt install rtags
</span></span></span></code></pre></div><p><a href="/blog/2017/09/05/built-rtags-deb/">rtagsのdebパッケージを作成した</a> のときとは違って、
Ubuntu 18.04 LTSでは標準パッケージのvim8で問題なく動きました。また <code>~/.rdmrc</code> の作成も不要でした。</p>
<h2 id="vim-rtagsのインストール">vim-rtagsのインストール</h2>
<p><a href="https://github.com/lyuts/vim-rtags">lyuts/vim-rtags: Vim bindings for rtags, llvm/clang based c++ code indexer.</a> の手順に沿ってインストールします。</p>
<p>私は <a href="https://github.com/junegunn/vim-plug">junegunn/vim-plug: Minimalist Vim Plugin Manager</a> を使っているので <code>vim ~/.vimrc</code> で <code>~/.vimrc</code> を開き
<code>call plug#begin('~/.vim/plugged')</code> と <code>call plug#end()</code> の間に</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Plug &#39;lyuts/vim-rtags&#39;
</span></span></code></pre></div><p>の行を追加して vim 上で以下のように実行してインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-vim" data-lang="vim"><span class="line"><span class="cl"><span class="p">:</span><span class="nx">so</span> %<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="p">:</span><span class="nx">PlugInstall</span><span class="err">
</span></span></span></code></pre></div><h2 id="rtagsのサーバ起動">rtagsのサーバ起動</h2>
<h4 id="起動方法1-単にバックグラウンドで起動">起動方法1: 単にバックグラウンドで起動</h4>
<p>以下のようにバックグラウンドで rdm を起動します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">rdm -L ~/.rdm.log &amp;
</span></span></span></code></pre></div><p><code>-L</code> でログファイルを指定しておくと、後から <code>tail -f ~/.rdm.log</code> としてインデクスの作成状況や問い合わせ状況を確認できて便利です。</p>
<h4 id="起動方法2-systemdのユーザ毎サービスとして起動">起動方法2: systemdのユーザ毎サービスとして起動</h4>
<p>Ubuntuのデスクトップ環境のようにD-busが使える環境であればsystemdのユーザ毎サービスとして起動するという手もあります。
以下のような内容で <code>~/.config/systemd/user/rtags-daemon.service</code> を作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">[Unit]
</span></span><span class="line"><span class="cl">Description=Rtags daemon
</span></span><span class="line"><span class="cl">Documentation=man:rdm(7) https://github.com/Andersbakken/rtags
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Service]
</span></span><span class="line"><span class="cl">ExecStart=/usr/bin/rdm
</span></span><span class="line"><span class="cl">StandardOutput=syslog
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">[Install]
</span></span><span class="line"><span class="cl">WantedBy=default.target
</span></span></code></pre></div><p>作成から起動と自動起動設定まで行うコマンドは以下のとおりです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mkdir -p ~/.config/systemd/user
</span></span></span><span class="line"><span class="cl"><span class="go">cat &lt;&lt;&#39;EOF&#39; &gt; ~/.config/systemd/user/rtags-daemon.service
</span></span></span><span class="line"><span class="cl"><span class="go">[Unit]
</span></span></span><span class="line"><span class="cl"><span class="go">Description=Rtags daemon
</span></span></span><span class="line"><span class="cl"><span class="go">Documentation=man:rdm(7) https://github.com/Andersbakken/rtags
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[Service]
</span></span></span><span class="line"><span class="cl"><span class="go">ExecStart=/usr/bin/rdm
</span></span></span><span class="line"><span class="cl"><span class="go">StandardOutput=syslog
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[Install]
</span></span></span><span class="line"><span class="cl"><span class="go">WantedBy=default.target
</span></span></span><span class="line"><span class="cl"><span class="go">EOF
</span></span></span><span class="line"><span class="cl"><span class="go">systemctl daemon-reload --user
</span></span></span><span class="line"><span class="cl"><span class="go">systemctl start --user rtags-daemon
</span></span></span><span class="line"><span class="cl"><span class="go">systemctl enable --user rtags-daemon
</span></span></span></code></pre></div><p>こちらの方法で起動した場合は <code>journalctl --user -f</code> でログを見つつ、下記の <code>rc -J</code> でインデクス作成などを行うことができます。</p>
<h2 id="読みたいソースのインデクス作成">読みたいソースのインデクス作成</h2>
<p>酔いたいソースがあるディレクトリに移動して rtags の README の <a href="https://github.com/Andersbakken/rtags#setup">Setup</a> のいずれかの手順に従って、 <code>compile_commands.json</code> というファイルを生成し、生成したディクレクトリで</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">rc -J
</span></span></span></code></pre></div><p>を実行してインデクスを作成します。実行すると <code>~/.cache/rtags/</code> 以下にディレクトリとバイナリ形式のインデクスデータファイルが生成されます。</p>
<h2 id="rtagsを利用してソースを読む">rtagsを利用してソースを読む</h2>
<p>lyuts/vim-rtags の <a href="https://github.com/lyuts/vim-rtags#mappings">Mappings</a> のキー操作により定義にジャンプしたり関数などの参照箇所を表示します。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
