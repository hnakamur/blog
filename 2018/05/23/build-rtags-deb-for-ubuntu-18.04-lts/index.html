<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Ubuntu 18.04 LTS用にrtagsのdebパッケージを作成した</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2018/05/23/build-rtags-deb-for-ubuntu-18.04-lts/" rel="bookmark"
           title="Permalink to Ubuntu 18.04 LTS用にrtagsのdebパッケージを作成した">Ubuntu 18.04 LTS用にrtagsのdebパッケージを作成した</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2018-05-23T14:10:00+09:00">
                Published: 2018-05-23
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/ubuntu.html">ubuntu</a> <a href="../../../../tag/rtags.html">rtags</a> <a href="../../../../tag/deb.html">deb</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="/blog/2017/09/05/built-rtags-deb/">rtagsのdebパッケージを作成した</a> のときのメモを端折りすぎて、Ubuntu 18.04 LTS用に rtags 2.18のパッケージを作ろうと思ったら苦労したのでメモしておきます。</p>
</div>
<div class="section" id="id2">
<h2>ビルドのメモ</h2>
<div class="section" id="gcc-8llvm-6-0pbuilderchroot">
<h3>(参考) gcc-8とLLVM 6.0入りのpbuilderのchroot環境作成</h3>
<p>よくよく考えたらこの手順は不要ですが、今後別件で使うかもしれないのでメモ。</p>
<p>まず既存のchroot環境のtarballをお好みの名前のファイルにコピーします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo cp /var/cache/pbuilder/bionic-{base,gcc8-llvm6}.tar.gz</span>
</pre></div>
<p><code>--save-after-login</code> オプションを指定しつつ、新しく作成したchroot環境にログインします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo pbuilder login --save-after-login --basetgz /var/cache/pbuilder/bionic-gcc8-llvm6.tar.gz</span>
</pre></div>
<p>chroot環境内でお好みのパッケージをインストールし、exitで抜ければ保存されます。</p>
<div class="highlight"><pre><span></span><span class="go">apt install gcc-8 g++-8 llvm-6.0-dev libclang-6.0-dev</span>
<span class="go">exit</span>
</pre></div>
<p>利用時は pbuilder に <code>--basetgz /var/cache/pbuilder/bionic-gcc8-llvm6.tar.gz</code> を指定して実行します。</p>
<p>ただ、今回は <code>debian/control</code> の <code>Build-Depends</code> に必要なパッケージを書いているので上記の手順は不要でした。</p>
</div>
<div class="section" id="gittarball">
<h3>gitサブモジュールのソースも含めてオリジンのソースtarball作成</h3>
<p><a class="reference external" href="https://github.com/Andersbakken/rtags">Andersbakken/rtags: A c/c++ client/server indexer for c/c++/objc[++] with integration for Emacs based on clang.</a> ではgitサブモジュールを使っているので、オリジンのソースtarballを作成する際はサブモジュールのソースも含めておく必要が有ります。</p>
<p>rtagsの <a class="reference external" href="https://github.com/Andersbakken/rtags/blob/163c81ea636c2aaca78e76df174bfd5679015bd7/.gitmodules">.gitmodules</a> は以下のようになっていてサブモジュールの特定のコミットを指定するのではなく master で最新のコミットを参照するようになっていました。</p>
<div class="highlight"><pre><span></span>[submodule &quot;src/rct&quot;]
        path = src/rct
        url = https://github.com/Andersbakken/rct
        branch = master
[submodule &quot;src/selene&quot;]
        path = src/selene
        url = https://github.com/jeremyong/Selene.git
    branch = master
[submodule &quot;src/lua&quot;]
        path = src/lua
        url = https://github.com/LuaDist/lua.git
    branch = master
</pre></div>
<p>ということでrtagsの過去のリリースの際に参照していたサブモジュールのコミットはわからないので、最新を使うことにします。</p>
<p>以下のコマンドでサブモジュール入りのソースtarballを作成しました。</p>
<div class="highlight"><pre><span></span><span class="go">git clone --recursive https://github.com/Andersbakken/rtags.git</span>
<span class="go">cd rtags</span>
<span class="go">git checkout v2.18</span>
<span class="go">cd ..</span>
<span class="go">mkdir -p ~/rtags-deb-work</span>
<span class="go">tar cf - --exclude=.git ./rtags | gzip -9 &gt; ~/rtags-deb-work/rtags-2.18-with-submodules.tar.gz</span>
</pre></div>
</div>
<div class="section" id="tarballdeb">
<h3>作成したtarballをdebパッケージビルド用レポジトリにインポート</h3>
<p>debパッケージビルド用レポジトリの作業ディレクトリに移動して以下のようにインポートしました。</p>
<div class="highlight"><pre><span></span><span class="go">cd ~/.ghq/github.com/hnakamur/rtags-deb</span>
<span class="go">gbp import-orig --pristine-tar -u 2.18 ~/rtags-deb-work/rtags-2.18-with-submodules.tar.gz</span>
</pre></div>
</div>
<div class="section" id="rtags">
<h3>rtagsのテストの実行方法を修正するパッチ作成</h3>
<p>あとはいつもの手順でdebパッケージをビルドすればOKかと思いきや、テストの実行時に <code>/usr/bin/rdm</code> というファイルがないというエラーになってしまいました。</p>
<p><code>rdm</code> は rtags で提供されるサーバプログラムですが、ビルド時はまだ /usr/bin/ にはインストールしていないので /usr/bin/rdm を参照するのは不適切です。</p>
<p><a class="reference external" href="https://cmake.org/cmake/help/v3.0/manual/cmake-variables.7.html">cmake-variables(7) — CMake 3.0.2 Documentation</a> を参照しつつ、twitter で <a class="reference external" href="https://twitter.com/objectxplosive/status/999151356249235456">眼力 玉壱號さんからのアドバイス</a> を頂いて以下のような
<a class="reference external" href="https://github.com/hnakamur/rtags-deb/blob/e63073a4275260a446af3fe3201e13749bd1b345/debian/patches/0001-Fix-bin-dir-for-tests.patch">パッチ</a>
を作成しました。</p>
<div class="highlight"><pre><span></span>From: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
Date: Wed, 23 May 2018 12:08:35 +0900
Subject: Fix bin dir for tests

<span class="gd">---</span>
 CMakeLists.txt | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

<span class="gh">diff --git a/CMakeLists.txt b/CMakeLists.txt</span>
<span class="gh">index 4284e30..e7accfe 100644</span>
<span class="gd">--- a/CMakeLists.txt</span>
<span class="gi">+++ b/CMakeLists.txt</span>
<span class="gu">@@ -87,7 +87,7 @@ set(BIN ${CMAKE_INSTALL_PREFIX}/bin)</span>
 if (RTAGS_NO_INSTALL)
     set(BIN ${CMAKE_BINARY_DIR}/bin)
 endif ()
<span class="gd">-add_test(SBRootTest perl &quot;${CMAKE_SOURCE_DIR}/tests/sbroot/sbroot_test.pl&quot; &quot;${BIN}&quot;)</span>
<span class="gi">+add_test(SBRootTest perl &quot;${CMAKE_SOURCE_DIR}/tests/sbroot/sbroot_test.pl&quot; &quot;${CMAKE_BINARY_DIR}/bin&quot;)</span>
 find_program(NOSETEST NAMES nosetests nosetests-2.7 PATHS &quot;$ENV{HOME}/.local/bin&quot;)
 if (NOSETEST)
     add_test(nosetests ${NOSETEST} -w ${CMAKE_SOURCE_DIR} -v)
</pre></div>
<p>あとはいつもどおりの手順でビルドできました。</p>
</div>
</div>
<div class="section" id="id5">
<h2>使い方</h2>
<div class="section" id="id6">
<h3>インストール手順</h3>
<p>ビルドしたパッケージは
<a class="reference external" href="https://launchpad.net/~hnakamur/+archive/ubuntu/vim">vim : Hiroaki Nakamura</a>
で公開しています。</p>
<p>以下の手順でインストール出来ます。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt install software-properties-common</span>
<span class="go">sudo add-apt-repository ppa:hnakamur/vim</span>
<span class="go">sudo apt update</span>
<span class="go">sudo apt install rtags</span>
</pre></div>
<p><a class="reference external" href="/blog/2017/09/05/built-rtags-deb/">rtagsのdebパッケージを作成した</a> のときとは違って、
Ubuntu 18.04 LTSでは標準パッケージのvim8で問題なく動きました。また <code>~/.rdmrc</code> の作成も不要でした。</p>
</div>
<div class="section" id="vim-rtags">
<h3>vim-rtagsのインストール</h3>
<p><a class="reference external" href="https://github.com/lyuts/vim-rtags">lyuts/vim-rtags: Vim bindings for rtags, llvm/clang based c++ code indexer.</a> の手順に沿ってインストールします。</p>
<p>私は <a class="reference external" href="https://github.com/junegunn/vim-plug">junegunn/vim-plug: Minimalist Vim Plugin Manager</a> を使っているので <code>vim ~/.vimrc</code> で <code>~/.vimrc</code> を開き
<code>call plug#begin('~/.vim/plugged')</code> と <code>call plug#end()</code> の間に</p>
<div class="highlight"><pre><span></span>Plug &#39;lyuts/vim-rtags&#39;
</pre></div>
<p>の行を追加して vim 上で以下のように実行してインストールします。</p>
<div class="highlight"><pre><span></span><span class="p">:</span><span class="k">so</span> %
<span class="p">:</span>PlugInstall
</pre></div>
</div>
<div class="section" id="id7">
<h3>rtagsのサーバ起動</h3>
<div class="section" id="id8">
<h4>起動方法1: 単にバックグラウンドで起動</h4>
<p>以下のようにバックグラウンドで rdm を起動します。</p>
<div class="highlight"><pre><span></span><span class="go">rdm -L ~/.rdm.log &amp;</span>
</pre></div>
<p><code>-L</code> でログファイルを指定しておくと、後から <code>tail -f ~/.rdm.log</code> としてインデクスの作成状況や問い合わせ状況を確認できて便利です。</p>
</div>
<div class="section" id="systemd">
<h4>起動方法2: systemdのユーザ毎サービスとして起動</h4>
<p>Ubuntuのデスクトップ環境のようにD-busが使える環境であればsystemdのユーザ毎サービスとして起動するという手もあります。
以下のような内容で <code>~/.config/systemd/user/rtags-daemon.service</code> を作成します。</p>
<div class="highlight"><pre><span></span>[Unit]
Description=Rtags daemon
Documentation=man:rdm(7) https://github.com/Andersbakken/rtags

[Service]
ExecStart=/usr/bin/rdm
StandardOutput=syslog

[Install]
WantedBy=default.target
</pre></div>
<p>作成から起動と自動起動設定まで行うコマンドは以下のとおりです。</p>
<div class="highlight"><pre><span></span><span class="go">mkdir -p ~/.config/systemd/user</span>
<span class="go">cat &lt;&lt;&#39;EOF&#39; &gt; ~/.config/systemd/user/rtags-daemon.service</span>
<span class="go">[Unit]</span>
<span class="go">Description=Rtags daemon</span>
<span class="go">Documentation=man:rdm(7) https://github.com/Andersbakken/rtags</span>

<span class="go">[Service]</span>
<span class="go">ExecStart=/usr/bin/rdm</span>
<span class="go">StandardOutput=syslog</span>

<span class="go">[Install]</span>
<span class="go">WantedBy=default.target</span>
<span class="go">EOF</span>
<span class="go">systemctl daemon-reload --user</span>
<span class="go">systemctl start --user rtags-daemon</span>
<span class="go">systemctl enable --user rtags-daemon</span>
</pre></div>
<p>こちらの方法で起動した場合は <code>journalctl --user -f</code> でログを見つつ、下記の <code>rc -J</code> でインデクス作成などを行うことができます。</p>
</div>
</div>
<div class="section" id="id9">
<h3>読みたいソースのインデクス作成</h3>
<p>酔いたいソースがあるディレクトリに移動して rtags の README の <a class="reference external" href="https://github.com/Andersbakken/rtags#setup">Setup</a> のいずれかの手順に従って、 <code>compile_commands.json</code> というファイルを生成し、生成したディクレクトリで</p>
<div class="highlight"><pre><span></span><span class="go">rc -J</span>
</pre></div>
<p>を実行してインデクスを作成します。実行すると <code>~/.cache/rtags/</code> 以下にディレクトリとバイナリ形式のインデクスデータファイルが生成されます。</p>
</div>
<div class="section" id="id10">
<h3>rtagsを利用してソースを読む</h3>
<p>lyuts/vim-rtags の <a class="reference external" href="https://github.com/lyuts/vim-rtags#mappings">Mappings</a> のキー操作により定義にジャンプしたり関数などの参照箇所を表示します。</p>
</div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>