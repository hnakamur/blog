<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.140.1">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>debパッケージを使ってnginxモジュールをビルド・デバッグする &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2025. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>debパッケージを使ってnginxモジュールをビルド・デバッグする</h1>
  <time datetime=2018-05-10T09:25:00&#43;0900 class="post-date">2018-05-10</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#lxdコンテナ作成">LXDコンテナ作成</a></li>
    <li><a href="#ビルドに必要なパッケージをインストール">ビルドに必要なパッケージをインストール</a></li>
    <li><a href="#自作debパッケージのソースを取得">自作debパッケージのソースを取得</a></li>
    <li><a href="#hello_worldモジュールのソースを取得">hello_worldモジュールのソースを取得</a></li>
    <li><a href="#hello_worldモジュール開発用にdebパッケージのファイルを編集">hello_worldモジュール開発用にdebパッケージのファイルを編集</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#依存ライブラリのインストール">依存ライブラリのインストール</a></li>
  </ul>

  <ul>
    <li><a href="#hello_world-モジュールのソース変更">hello_world モジュールのソース変更</a></li>
    <li><a href="#ビルドインストール動作確認">ビルド、インストール、動作確認</a></li>
  </ul>
</nav>
  <h1 id="はじめに">はじめに</h1>
<p>私は <a href="https://hnakamur.github.io/blog/2018/04/05/building-my-custom-nginx-rpm-and-deb/">私のnginxのカスタムrpmとdebをビルドする手順</a> でサードパーティモジュールを含んだnginxのパッケージをビルドしています。</p>
<p>このパッケージに自作モジュールを追加して開発するためのビルド手順を考えてみたのでメモです。</p>
<p>普通にソースのtarballを展開してconfigure, make, make installでも良いのですが、本番運用時はdebパッケージを使うので同じ構成のほうが良いというのとnginx-dbgというデバッグシンボルパッケージも作ってくれるのでこれも活用したいということで、以下の手順にしてみました。</p>
<p>例として <a href="http://cubicdaiya.github.io/blog/ja/blog/2013/01/08/nginx1/">nginx moduleをつくろう その1〜Hello, World〜 - bokko bokkoにしてやんよ</a> の <a href="https://github.com/cubicdaiya/ngx_http_hello_world">cubicdaiya/ngx_http_hello_world: Hello, World with nginx</a> を使わせて頂きました。</p>
<h1 id="セットアップ手順">セットアップ手順</h1>
<h2 id="lxdコンテナ作成">LXDコンテナ作成</h2>
<p>ホストの環境を汚したくないので、開発用にLXDのコンテナを作ってそこで作業します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">lxc launch images:ubuntu/18.04 nginx-dev
</span></span></span><span class="line"><span class="cl"><span class="go">lxc exec nginx-dev bash
</span></span></span></code></pre></div><p>ここ以降は全てコンテナ内で実行します。 <code>lxc exec</code> ではコンテナ内で root ユーザになっているので <code>sudo</code> は使いません。また、以下のコマンド実行例でプロンプトを示す場合はrootユーザということで <code>#</code> とします。</p>
<h2 id="ビルドに必要なパッケージをインストール">ビルドに必要なパッケージをインストール</h2>
<p>debパッケージのビルドに必要なツールをインストールします。 <code>equivs</code> は後述の <code>mk-build-deps</code> コマンドで必要になります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt install build-essential devscripts equivs
</span></span></span></code></pre></div><h2 id="自作debパッケージのソースを取得">自作debパッケージのソースを取得</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">git clone https://github.com/hnakamur/nginx-deb
</span></span></span><span class="line"><span class="cl"><span class="go">cd nginx-deb
</span></span></span></code></pre></div><h2 id="hello_worldモジュールのソースを取得">hello_worldモジュールのソースを取得</h2>
<p>gitサブモジュールとして追加します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">git submodule add https://github.com/cubicdaiya/ngx_http_hello_world
</span></span></span></code></pre></div><h2 id="hello_worldモジュール開発用にdebパッケージのファイルを編集">hello_worldモジュール開発用にdebパッケージのファイルを編集</h2>
<h4 id="debianrules">debian/rules</h4>
<p><code>debian/rules</code> は1行目に <code>#!/usr/bin/make -f</code> と書いてあるので Makefile の書式になっています。
通常の Makefile なら <code>make ターゲット</code> と実行するところを <code>./debian/rules ターゲット</code> で実行できます。</p>
<p>hello_worldモジュールをビルドするために以下の2つの変更を行います。</p>
<ul>
<li>リリースビルドとデバッグビルドのソースをビルド用のディレクトリにコピーするためのターゲット <code>config.env.%</code></li>
<li>リリースビルドとデバッグビルドのconfigureのオプションにhello_worldをダイナミックモジュールとしてビルドするためのオプションを追加。</li>
</ul>
<p>さらにhello_worldモジュールを変更・ビルド・動作確認のサイクルを効率化するために以下の2つの変更を行います。
ビルドディレクトリを残したままhello_worldモジュールのソースのみをビルドディレクトリに上書きコピーしてdebパッケージを作るための変更です。</p>
<ul>
<li>hello_worldモジュールのソースだけをビルドディレクトリにコピーするためのmakeターゲット <code>copy_hello_src</code> を追加し、 <code>.PHONY</code> に <code>copy_hello_src</code> を追加。</li>
<li>post-build と install ターゲットでシンボリックリンク作成する際に <code>-f</code> オプションを追加して、リンクが既にあってもエラーにならないようにする。</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/debian/rules b/debian/rules
</span></span></span><span class="line"><span class="cl"><span class="gh">index c97ab1a..3eef083 100755
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/debian/rules
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/debian/rules
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -50,8 +50,14 @@ config.env.%:
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>        cp -Pa $(CURDIR)/redis2-nginx-module $(BUILDDIR_$*)/
</span></span><span class="line"><span class="cl">        cp -Pa $(CURDIR)/set-misc-nginx-module $(BUILDDIR_$*)/
</span></span><span class="line"><span class="cl">        cp -Pa $(CURDIR)/srcache-nginx-module $(BUILDDIR_$*)/
</span></span><span class="line"><span class="cl"><span class="gi">+	cp -Pa $(CURDIR)/ngx_http_hello_world $(BUILDDIR_$*)/
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>        touch $@
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gi">+copy_hello_src.%:
</span></span></span><span class="line"><span class="cl"><span class="gi">+	cp -Pa $(CURDIR)/ngx_http_hello_world $(BUILDDIR_$*)/
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi">+copy_hello_src: copy_hello_src.nginx copy_hello_src.nginx_debug
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> config.status.nginx: config.env.nginx
</span></span><span class="line"><span class="cl">        cd $(BUILDDIR_nginx) &amp;&amp; \
</span></span><span class="line"><span class="cl">        CFLAGS=&#34;&#34; ./configure \
</span></span><span class="line"><span class="cl"><span class="gu">@@ -114,6 +120,7 @@ config.status.nginx: config.env.nginx
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>                --add-dynamic-module=./redis2-nginx-module \
</span></span><span class="line"><span class="cl">                --add-dynamic-module=./set-misc-nginx-module \
</span></span><span class="line"><span class="cl">                --add-dynamic-module=./srcache-nginx-module \
</span></span><span class="line"><span class="cl"><span class="gi">+		--add-dynamic-module=./ngx_http_hello_world \
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>                --with-cc-opt=&#34;$(CFLAGS)&#34; \
</span></span><span class="line"><span class="cl">                --with-ld-opt=&#34;$(LDFLAGS)&#34;
</span></span><span class="line"><span class="cl">        touch $@
</span></span><span class="line"><span class="cl"><span class="gu">@@ -180,6 +187,7 @@ config.status.nginx_debug: config.env.nginx_debug
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>                --add-dynamic-module=./redis2-nginx-module \
</span></span><span class="line"><span class="cl">                --add-dynamic-module=./set-misc-nginx-module \
</span></span><span class="line"><span class="cl">                --add-dynamic-module=./srcache-nginx-module \
</span></span><span class="line"><span class="cl"><span class="gi">+		--add-dynamic-module=./ngx_http_hello_world \
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>                --with-cc-opt=&#34;$(CFLAGS)&#34; \
</span></span><span class="line"><span class="cl">                --with-ld-opt=&#34;$(LDFLAGS)&#34; \
</span></span><span class="line"><span class="cl">                --with-debug
</span></span><span class="line"><span class="cl"><span class="gu">@@ -221,7 +229,7 @@ clean:
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> 
</span></span><span class="line"><span class="cl"> post-build:
</span></span><span class="line"><span class="cl">        mv $(BUILDDIR_nginx_debug)/objs/nginx $(BUILDDIR_nginx_debug)/objs/nginx-debug
</span></span><span class="line"><span class="cl"><span class="gd">-	ln -s $(BUILDDIR_nginx)/objs $(CURDIR)/objs
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+	ln -sf $(BUILDDIR_nginx)/objs $(CURDIR)/objs
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>        cp $(BUILDDIR_nginx)/objs/nginx.8 $(BUILDDIR_nginx)/objs/nginx-debug.8
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> install:
</span></span><span class="line"><span class="cl"><span class="gu">@@ -235,7 +243,7 @@ install:
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>        mkdir -p $(INSTALLDIR)/usr/share/doc/nginx
</span></span><span class="line"><span class="cl">        install -m 644 debian/CHANGES $(INSTALLDIR)/usr/share/doc/nginx/changelog
</span></span><span class="line"><span class="cl">        install -m 644 debian/nginx.vh.default.conf $(INSTALLDIR)/etc/nginx/conf.d/default.conf
</span></span><span class="line"><span class="cl"><span class="gd">-	ln -s /usr/lib/nginx/modules $(INSTALLDIR)/etc/nginx/modules
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+	ln -sf /usr/lib/nginx/modules $(INSTALLDIR)/etc/nginx/modules
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> 
</span></span><span class="line"><span class="cl"> binary-indep: build post-build install
</span></span><span class="line"><span class="cl">        dh_testdir
</span></span><span class="line"><span class="cl"><span class="gu">@@ -272,4 +280,4 @@ binary-arch: install build-dbg
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> 
</span></span><span class="line"><span class="cl"> binary: binary-indep binary-arch
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gd">-.PHONY: build clean binary-indep binary-arch binary install
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+.PHONY: build clean binary-indep binary-arch binary install copy_hello_src
</span></span></span></code></pre></div><h4 id="debiannginxinstall">debian/nginx.install</h4>
<p>ビルドしたhello_worldモジュールをdebパッケージに含めるために以下のように変更します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/debian/nginx.install b/debian/nginx.install
</span></span></span><span class="line"><span class="cl"><span class="gh">index 7f2825a..f692042 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/debian/nginx.install
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/debian/nginx.install
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -16,6 +16,7 @@ objs/ngx_http_echo_module.so		usr/lib/nginx/modules
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> objs/ngx_http_enhanced_memcached_module.so	usr/lib/nginx/modules
</span></span><span class="line"><span class="cl"> objs/ngx_http_geoip_module.so		usr/lib/nginx/modules
</span></span><span class="line"><span class="cl"> objs/ngx_http_headers_more_filter_module.so	usr/lib/nginx/modules
</span></span><span class="line"><span class="cl"><span class="gi">+objs/ngx_http_hello_world_module.so	usr/lib/nginx/modules
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> objs/ngx_http_image_filter_module.so	usr/lib/nginx/modules
</span></span><span class="line"><span class="cl"> objs/ngx_http_lua_upstream_module.so	usr/lib/nginx/modules
</span></span><span class="line"><span class="cl"> objs/ngx_http_memc_module.so		usr/lib/nginx/modules
</span></span></code></pre></div><h4 id="debiannginxconf">debian/nginx.conf</h4>
<p><code>/etc/nginx/nginx.conf</code> で hello_world モジュールをロードするように以下のように変更します。
なお、後述のgdbでワーカープロセスのプロセスにアタッチしてデバッグする場合は、以下のように <code>worker_processes</code> は 1 にしておくのが楽です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/debian/nginx.conf b/debian/nginx.conf
</span></span></span><span class="line"><span class="cl"><span class="gh">index e4bad8d..e89be3d 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/debian/nginx.conf
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/debian/nginx.conf
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -2,6 +2,8 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span> user  nginx;
</span></span><span class="line"><span class="cl"> worker_processes  1;
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gi">+load_module modules/ngx_http_hello_world_module.so;
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span> error_log  /var/log/nginx/error.log warn;
</span></span><span class="line"><span class="cl"> pid        /var/run/nginx.pid;
</span></span></code></pre></div><h4 id="debiannginxvhdefaultconf">debian/nginx.vh.default.conf</h4>
<p><code>/etc/nginx/conf.d/default.conf</code> に hello_world モジュールをテストするためのロケーションを追加するため以下のように変更します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/debian/nginx.vh.default.conf b/debian/nginx.vh.default.conf
</span></span></span><span class="line"><span class="cl"><span class="gh">index 299c622..6f856d7 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/debian/nginx.vh.default.conf
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/debian/nginx.vh.default.conf
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -10,6 +10,10 @@ server {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>         index  index.html index.htm;
</span></span><span class="line"><span class="cl">     }
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gi">+    location ~ /hello_world$ {
</span></span></span><span class="line"><span class="cl"><span class="gi">+        hello_world;
</span></span></span><span class="line"><span class="cl"><span class="gi">+    }
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>     #error_page  404              /404.html;
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">     # redirect server error pages to the static page /50x.html
</span></span></code></pre></div><h4 id="debiancontrol">debian/control</h4>
<p>今回は不要ですが、ビルド時の依存ライブラリが増える場合は <code>debian/control</code> の <code>Build-Depends</code> に追加します。</p>
<h2 id="依存ライブラリのインストール">依存ライブラリのインストール</h2>
<p><code>mk-build-deps</code> コマンドを使って依存ライブラリをインストールするためのdebパッケージを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> mk-build-deps debian/control
</span></span><span class="line"><span class="cl"><span class="go">…(略)…
</span></span></span><span class="line"><span class="cl"><span class="go">dpkg-deb: building package &#39;nginx-build-deps&#39; in &#39;../nginx-build-deps_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_all.deb&#39;.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">The package has been created.
</span></span></span><span class="line"><span class="cl"><span class="go">Attention, the package has been created in the current directory,
</span></span></span><span class="line"><span class="cl"><span class="go">not in &#34;..&#34; as indicated by the message above!
</span></span></span></code></pre></div><p>上記のように作成されたdebパッケージ名が表示されるので、それを指定してインストールします。
最後の3行で説明されているように親ディレクトリ <code>..</code> ではなくカレントディレクトリ <code>.</code> に作られているので以下のようにします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">dpkg -i ./nginx-build-deps_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_all.deb
</span></span></span></code></pre></div><p>これでこのパッケージ自体はインストールされるのですが、依存ライブラリはまだインストールされていない状態です。</p>
<p><a href="https://askubuntu.com/questions/40011/how-to-let-dpkg-i-install-dependencies-for-me?utm_medium=organic&amp;utm_source=google_rich_qa&amp;utm_campaign=google_rich_qa">How to let `dpkg -i` install dependencies for me? - Ask Ubuntu</a> を参考に以下のようにしてインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt install -f -y
</span></span></span></code></pre></div><h1 id="初回のビルドと動作確認">初回のビルドと動作確認</h1>
<p>初回のビルドは通常通り行います。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> dpkg-buildpackage -b
</span></span><span class="line"><span class="cl"><span class="go">…(略)…
</span></span></span><span class="line"><span class="cl"><span class="go">dpkg-deb: building package &#39;nginx&#39; in &#39;../nginx_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_amd64.deb&#39;.
</span></span></span><span class="line"><span class="cl"><span class="go">dpkg-deb: building package &#39;nginx-dbg&#39; in &#39;../nginx-dbg_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_amd64.deb&#39;.
</span></span></span><span class="line"><span class="cl"><span class="go">…(略)…
</span></span></span></code></pre></div><p>作成されたdebパッケージのファイル名が表示されるので、これを指定してインストールします。
ここでは手抜きしてワイルドカードで指定します。この手順どおりでは無いはずですが、もし親ディレクトリにこれでマッチする他のファイルがある場合は上記の2つのファイルだけがマッチするように指定してください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">dpkg -i ../nginx*.deb
</span></span></span></code></pre></div><p>nginxのサービスを起動します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">systemctl start nginx
</span></span></span></code></pre></div><p><code>/hello_world</code> のロケーションにアクセスして動作確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> curl localhost/hello_world
</span></span><span class="line"><span class="cl"><span class="go">Hello, World!
</span></span></span></code></pre></div><h1 id="2回め以降のビルドと動作確認">2回め以降のビルドと動作確認</h1>
<p>初回のビルドが終わると <code>debian/build-nginx</code> にリリースビルド、 <code>debian/build-nginx-debug</code> にデバッグビルドのソースとビルド結果が残っています。</p>
<p>hello_world モジュールのソースを変更してビルド、インストール、動作確認をしてみます。</p>
<h2 id="hello_world-モジュールのソース変更">hello_world モジュールのソース変更</h2>
<p><code>vim ngx_http_hello_world/ngx_http_hello_world_module.c</code> でソースを変更します。</p>
<p>なお <code>ngx_http_hello_world</code> はgitサブモジュールにした関係で、差分を表示するときは <code>git diff ngx_http_hello_world/ngx_http_hello_world_module.c</code> ではなく以下のようにする必要がありました（サブシェルで実行しているのはカレントディレクトリを移動したくないため）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">(cd ngx_http_hello_world/; git diff)
</span></span></span></code></pre></div><p>.. code-block:: diff</p>
<pre><code>diff --git a/ngx_http_hello_world_module.c b/ngx_http_hello_world_module.c
index 2760468..6a84d12 100644
--- a/ngx_http_hello_world_module.c
+++ b/ngx_http_hello_world_module.c
@@ -6,7 +6,7 @@
 #include &lt;ngx_core.h&gt;
 #include &lt;ngx_http.h&gt;

-#define NGX_HTTP_HELLO_WORLD &quot;Hello, World!\n&quot;
+#define NGX_HTTP_HELLO_WORLD &quot;Hello, World!!\n&quot;

 static char *ngx_http_hello_world(ngx_conf_t *cf, ngx_command_t *cmd, void *conf);
 static ngx_int_t ngx_http_hello_world_handler(ngx_http_request_t *r);
</code></pre>
<h2 id="ビルドインストール動作確認">ビルド、インストール、動作確認</h2>
<p>ソース変更とビルド、インストール、動作確認は繰り返し行うので以下のように <code>&amp;&amp;</code> で繋いで一連で実行するようにします。あるいはシェルスクリプトファイルを作って実行しても良いでしょう。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">./debian/rules copy_hello_src &amp;&amp; \
</span></span></span><span class="line"><span class="cl"><span class="go">  dpkg-buildpackage -nc &amp;&amp; \
</span></span></span><span class="line"><span class="cl"><span class="go">  dpkg -i --force-overwrite ../nginx_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_amd64.deb ../nginx-dbg_1.13.11+mod.1-1ubuntu1ppa2~ubuntu18.04_amd64.deb &amp;&amp; \
</span></span></span><span class="line"><span class="cl"><span class="go">  systemctl restart nginx &amp;&amp; \
</span></span></span><span class="line"><span class="cl"><span class="go">  curl -v localhost/hello_world
</span></span></span></code></pre></div><p><code>curl</code> の実行結果は以下のようになり、上記の変更がただしく反映されたことを確認できました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">*   Trying ::1...
</span></span><span class="line"><span class="cl">* TCP_NODELAY set
</span></span><span class="line"><span class="cl">* connect to ::1 port 80 failed: Connection refused
</span></span><span class="line"><span class="cl">*   Trying 127.0.0.1...
</span></span><span class="line"><span class="cl">* TCP_NODELAY set
</span></span><span class="line"><span class="cl">* Connected to localhost (127.0.0.1) port 80 (#0)
</span></span><span class="line"><span class="cl">&gt; GET /hello_world HTTP/1.1
</span></span><span class="line"><span class="cl">&gt; Host: localhost
</span></span><span class="line"><span class="cl">&gt; User-Agent: curl/7.58.0
</span></span><span class="line"><span class="cl">&gt; Accept: */*
</span></span><span class="line"><span class="cl">&gt;
</span></span><span class="line"><span class="cl">&lt; HTTP/1.1 200 OK
</span></span><span class="line"><span class="cl">&lt; Server: nginx/1.13.11
</span></span><span class="line"><span class="cl">&lt; Date: Thu, 10 May 2018 01:59:43 GMT
</span></span><span class="line"><span class="cl">&lt; Content-Type: text/plain
</span></span><span class="line"><span class="cl">&lt; Content-Length: 15
</span></span><span class="line"><span class="cl">&lt; Connection: keep-alive
</span></span><span class="line"><span class="cl">&lt;
</span></span><span class="line"><span class="cl">Hello, World!!
</span></span></code></pre></div><h1 id="デバッガの実行">デバッガの実行</h1>
<p>ついでにデバッガで実行する手順もメモしておきます。</p>
<p>gdbの操作方法は公式ドキュメントのページ  <a href="http://www.gnu.org/software/gdb/documentation/">GDB Documentation</a> にあるGDB User Manualを参照してください。</p>
<p>まずgdbをインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt install gdb
</span></span></span></code></pre></div><p>リリースビルドのnginxのサービスを停止し、デバッグビルドのnginxのサービスを起動します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">systemctl stop nginx &amp;&amp; systemctl start nginx-debug
</span></span></span></code></pre></div><p>nginxのワーカープロセスのPIDを確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> ps auxwwf <span class="p">|</span> grep <span class="o">[</span>n<span class="o">]</span>ginx
</span></span><span class="line"><span class="cl"><span class="go">root     11380  0.0  0.0  43844   988 ?        Ss   02:21   0:00 nginx: master process /usr/sbin/nginx-debug -c /etc/nginx/nginx.conf
</span></span></span><span class="line"><span class="cl"><span class="go">nginx    11381  0.0  0.0  48664  4744 ?        S    02:21   0:00  \_ nginx: worker process
</span></span></span></code></pre></div><p>デバッグビルドのnginxのソースディレクトリとnginxワーカープロセスのPIDを指定してgdbを起動してワーカープロセスにアタッチします。 <a href="http://www.geekpage.jp/blog/?id=2007/1/17">既に起動しているプロセスをgdbで制御する:Geekなぺーじ</a> にわかりやすい解説がありました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">gdb --directory debian/build-nginx-debug -p 11381
</span></span></span></code></pre></div><p>あるいはデバッグビルドのソースディレクトリに移動して実行しても良いです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cd debian/build-nginx-debug; gdb -p 11381
</span></span></span></code></pre></div><p>起動すると以下のようなメッセージが出力された後、gdbのプロンプトが出力されます。</p>
<p>PID 11381のプロセスにアタッチし、nginx-debugのシンボルが読み込めたことがわかります。
一方 <code>epoll_wait.c</code> が無いので <code>epoll_wait</code> のシンボル情報は読み込めていませんが、ここをデバッガで追わない場合は無視して構いません。デバッガで負いたい場合は対応するデバッグパッケージをインストールすれば良いはずです。</p>
<p>nginx-debugのシンボルは</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">…(略)…
</span></span><span class="line"><span class="cl">Attaching to process 11381
</span></span><span class="line"><span class="cl">Reading symbols from /usr/sbin/nginx-debug...Reading symbols from /usr/lib/debug/.build-id/92/48720f057ba2391859b2bade2edabb6f050487.debug...done.
</span></span><span class="line"><span class="cl">done.
</span></span><span class="line"><span class="cl">…(略)…
</span></span><span class="line"><span class="cl">0x00007fecd781fb77 in epoll_wait (epfd=8, events=0x55ca9383b300, maxevents=512, timeout=timeout@entry=-1)
</span></span><span class="line"><span class="cl">    at ../sysdeps/unix/sysv/linux/epoll_wait.c:30
</span></span><span class="line"><span class="cl">30      ../sysdeps/unix/sysv/linux/epoll_wait.c: No such file or directory.
</span></span><span class="line"><span class="cl">(gdb)
</span></span></code></pre></div><p><a href="https://ccrma.stanford.edu/~jos/stkintro/Useful_commands_gdb.html">Useful commands in gdb</a> にgdbのよく使うコマンド一覧がありました。</p>
<p>gdbのプロンプトに <code>b ngx_http_hello_world/ngx_http_hello_world_module.c:ngx_http_hello_world_handler</code> と入力し、hello_worldモジュールの <code>ngx_http_hello_world_handler</code> 関数にブレークポイントを設定してみます。
以下のように、このあと共有ライブラリがロードされたらブレークポイントを設定するか聞かれるので <code>y</code> と入力します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">(gdb) b ngx_http_hello_world/ngx_http_hello_world_module.c:ngx_http_hello_world_handler
</span></span><span class="line"><span class="cl">No source file named ngx_http_hello_world/ngx_http_hello_world_module.c.
</span></span><span class="line"><span class="cl">Make breakpoint pending on future shared library load? (y or [n]) y
</span></span><span class="line"><span class="cl">Breakpoint 1 (ngx_http_hello_world/ngx_http_hello_world_module.c:ngx_http_hello_world_handler) pending.
</span></span></code></pre></div><p>念のためgdbのプロンプトに <code>i b</code> と入力してブレークポイントが設定されたことを確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">(gdb) i b
</span></span><span class="line"><span class="cl">Num     Type           Disp Enb Address            What
</span></span><span class="line"><span class="cl">1       breakpoint     keep y   0x00007fecd67048f0 in ngx_http_hello_world_handler
</span></span><span class="line"><span class="cl">						   at ./ngx_http_hello_world/ngx_http_hello_world_module.c:57
</span></span></code></pre></div><p>gdbのプロンプトに <code>c</code> を入力して処理を続行 (continue) します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">(gdb) c
</span></span><span class="line"><span class="cl">Continuing.
</span></span></code></pre></div><p>別の端末で <code>curl localhost/hello_world</code> と実行すると、gdbがブレークポイントで止まって以下のようにプロンプトが表示されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Breakpoint 1, ngx_http_hello_world_handler (r=0x55ca9385efd0)
</span></span><span class="line"><span class="cl">    at ./ngx_http_hello_world/ngx_http_hello_world_module.c:57
</span></span><span class="line"><span class="cl">warning: Source file is more recent than executable.
</span></span><span class="line"><span class="cl">57      {
</span></span><span class="line"><span class="cl">(gdb)
</span></span></code></pre></div><p>ここで <code>C-x C-a</code> と入力すると画面が上下に分割され、上にソースコード、下にgdbのプロンプトが表示されます。
これはTUIモードと呼ばれるもので <a href="https://sourceware.org/gdb/current/onlinedocs/gdb/TUI.html#TUI">Debugging with GDB: TUI</a> に説明があります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">┌──./ngx_http_hello_world/ngx_http_hello_world_module.c────────────────────────────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│46          NULL,                             /* init master */                                                   │
</span></span><span class="line"><span class="cl">│47          NULL,                             /* init module */                                                   │
</span></span><span class="line"><span class="cl">│48          NULL,                             /* init process */                                                  │
</span></span><span class="line"><span class="cl">│49          NULL,                             /* init thread */                                                   │
</span></span><span class="line"><span class="cl">│50          NULL,                             /* exit thread */                                                   │
</span></span><span class="line"><span class="cl">│51          NULL,                             /* exit process */                                                  │
</span></span><span class="line"><span class="cl">│52          NULL,                             /* exit master */                                                   │
</span></span><span class="line"><span class="cl">│53          NGX_MODULE_V1_PADDING                                                                                 │
</span></span><span class="line"><span class="cl">│54      };                                                                                                        │
</span></span><span class="line"><span class="cl">│55                                                                                                                │
</span></span><span class="line"><span class="cl">│56      static ngx_int_t ngx_http_hello_world_handler(ngx_http_request_t *r)                                      │
</span></span></code></pre></div><pre><code>B+&gt;│57      {                                                                                                         │
   │58          ngx_int_t                    rc;                                                                      │
   │59          ngx_chain_t                  out;                                                                     │
   │60          ngx_buf_t                   *b;                                                                       │
   │61          ngx_str_t                    body = ngx_string(NGX_HTTP_HELLO_WORLD);                                 │
   │62                                                                                                                │
   │63          if (r-&gt;method != NGX_HTTP_GET &amp;&amp; r-&gt;method != NGX_HTTP_HEAD) {                                        │
   │64              return NGX_HTTP_NOT_ALLOWED;                                                                      │
   │65          }                                                                                                     │
   │66                                                                                                                │
   │67          if (r-&gt;headers_in.if_modified_since) {                                                                │
   │68              return NGX_HTTP_NOT_MODIFIED;                                                                     │
   │69          }                                                                                                     │
   │70                                                                                                                │
   └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
multi-thre Thread 0x7fecd914b7 In: ngx_http_hello_world_handler                               L57   PC: 0x7fecd67048f0
(gdb)
</code></pre>
<p>TUIモードのキー操作については <a href="https://sourceware.org/gdb/current/onlinedocs/gdb/TUI-Keys.html#TUI-Keys">Debugging with GDB: TUI Keys</a> を参照してください。</p>
<p>gdbプロンプトで <code>C-x 2</code> と入力するとCとアセンブラのウィンドウが表示されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">┌──./ngx_http_hello_world/ngx_http_hello_world_module.c────────────────────────────────────────────────────────────┐
</span></span></code></pre></div><pre><code>B+&gt;│57      {                                                                                                         │
   │58          ngx_int_t                    rc;                                                                      │
   │59          ngx_chain_t                  out;                                                                     │
   │60          ngx_buf_t                   *b;                                                                       │
   │61          ngx_str_t                    body = ngx_string(NGX_HTTP_HELLO_WORLD);                                 │
   │62                                                                                                                │
   │63          if (r-&gt;method != NGX_HTTP_GET &amp;&amp; r-&gt;method != NGX_HTTP_HEAD) {                                        │
   │64              return NGX_HTTP_NOT_ALLOWED;                                                                      │
   │65          }                                                                                                     │
   │66                                                                                                                │
   │67          if (r-&gt;headers_in.if_modified_since) {                                                                │
   │68              return NGX_HTTP_NOT_MODIFIED;                                                                     │
   │69          }                                                                                                     │
   └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
B+&gt;│0x7fecd67048f0 &lt;ngx_http_hello_world_handler&gt;           push   %rbx                                               │
   │0x7fecd67048f1 &lt;ngx_http_hello_world_handler+1&gt;         sub    $0x20,%rsp                                         │
   │0x7fecd67048f5 &lt;ngx_http_hello_world_handler+5&gt;         mov    %fs:0x28,%rax                                      │
   │0x7fecd67048fe &lt;ngx_http_hello_world_handler+14&gt;        mov    %rax,0x18(%rsp)                                    │
   │0x7fecd6704903 &lt;ngx_http_hello_world_handler+19&gt;        xor    %eax,%eax                                          │
   │0x7fecd6704905 &lt;ngx_http_hello_world_handler+21&gt;        mov    0x3d0(%rdi),%rax                                   │
   │0x7fecd670490c &lt;ngx_http_hello_world_handler+28&gt;        lea    -0x2(%rax),%rdx                                    │
   │0x7fecd6704910 &lt;ngx_http_hello_world_handler+32&gt;        mov    $0x195,%eax                                        │
   │0x7fecd6704915 &lt;ngx_http_hello_world_handler+37&gt;        test   $0xfffffffffffffffd,%rdx                           │
   │0x7fecd670491c &lt;ngx_http_hello_world_handler+44&gt;        jne    0x7fecd6704930 &lt;ngx_http_hello_world_handler+64&gt;   │
   │0x7fecd670491e &lt;ngx_http_hello_world_handler+46&gt;        cmpq   $0x0,0xb0(%rdi)                                    │
   │0x7fecd6704926 &lt;ngx_http_hello_world_handler+54&gt;        mov    %rdi,%rbx                                          │
   │0x7fecd6704929 &lt;ngx_http_hello_world_handler+57&gt;        mov    $0x130,%eax                                        │
   │0x7fecd670492e &lt;ngx_http_hello_world_handler+62&gt;        je     0x7fecd6704950 &lt;ngx_http_hello_world_handler+96&gt;   │
   └──────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
multi-thre Thread 0x7fecd914b7 In: ngx_http_hello_world_handler                               L57   PC: 0x7fecd67048f0
    …(略)…
(gdb)
</code></pre>
<p><code>C-x o</code> でアクティブウィンドウを切り替えられます。押す度に、ソース、アセンブラ、コマンドと切り替わっていきます。あるいは <code>TUI-specific Commands](https://sourceware.org/gdb/current/onlinedocs/gdb/TUI-Commands.html#TUI-Commands) の </code>focus` コマンドを使って切り替えることもできます。ソースかアセンブラがアクティブな場合はウィンドウ枠が反転表示になります。</p>
<p>ソースかアセンブラのウィンドウがアクティブな時に、カーソルキーの上下か PgUp, PgDown キーを押すと前後のソースまたはアセンブリコードが見られます。</p>
<p><code>wh</code> (winheightの省略形) コマンドでウィンドウの高さを調節できます。引数なしで実行すると使い方が表示されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">(gdb) wh
</span></span><span class="line"><span class="cl">Usage: winheight &lt;win_name&gt; [+ | -] &lt;#lines&gt;
</span></span></code></pre></div><p>ウィンドウの名前と現在の高さを見るには <code>i win</code> (info winの省略形) を実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">(gdb) i win
</span></span><span class="line"><span class="cl">	src     (15 lines)
</span></span><span class="line"><span class="cl">	asm     (16 lines)
</span></span><span class="line"><span class="cl">	cmd     (11 lines)  &lt;has focus&gt;
</span></span></code></pre></div><p>例えば <code>src</code> ウィンドウの高さを30行にするなら <code>winheight src 30</code> 、現在の行数より5行広げるなら <code>winheight src +5</code> のようにします。</p>
<p>ソースだけの表示に戻すには <code>C-x 1</code> 、TUIモードを抜けるには <code>C-x a</code> を押します。</p>
<p><a href="https://sourceware.org/gdb/current/onlinedocs/gdb/TUI-Single-Key-Mode.html#TUI-Single-Key-Mode">Single Key Mode</a> というのも便利でした。
これを知るまでは <a href="https://sourceware.org/gdb/current/onlinedocs/gdb/Continuing-and-Stepping.html#Continuing-and-Stepping">Continuing and Stepping</a> の <code>next</code> コマンドの省略形の <code>n</code> を使って <code>n</code> リターンを繰り返してステップ実行していました。
<code>C-x s</code> でシングルキーモードに入れば <code>n</code> だけでステップ実行できるので楽です。 <code>q</code> でシングルキーモードから抜けてgdbのプロンプトに戻ります。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>
  </body>
</html>
