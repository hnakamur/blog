<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.88.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>PXEブートでVyOSをインストール &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>PXEブートでVyOSをインストール</h1>
  <time datetime=2018-10-08T18:40:00&#43;0900 class="post-date">2018-10-08</time>
  <nav id="TableOfContents"></nav>
  <h1 id="はじめに">はじめに</h1>
<p>半年前くらいに <a href="https://twitter.com/yamamasa23">yamamasa23</a> さんの真似して中古で買った
<a href="https://store.atworks.co.jp/eol/eol2012/quad-beagle-zg/">Quad Beagle ZG</a>
に PXE ブートで <a href="https://vyos.io/">VyOS</a> をインストールしてみたメモです。</p>
<p>手順は <a href="https://wiki.vyos.net/wiki/PXE">PXE - VyOS Wiki</a> を参考にしました。</p>
<p>私は EdgeRouter-Lite で EdgeOS は利用していますが、 VyOS は今回が初めてです。</p>
<p>一通り設定してから、まとめてブログを書きたいのですが、分量が増えると書くのが
大変 (自分用のメモといっても、後から読んで理解できるように書こうとすると
なんだかんだで結構時間がかかってます) になるので、小分けにして書くことにします。</p>
<h1 id="debianのpxe-ブート環境の整備">DebianのPXE ブート環境の整備</h1>
<p><a href="https://wiki.vyos.net/wiki/PXE">PXE - VyOS Wiki</a> に PXELINUX の設定が必要と
書かれているので、整備しました。</p>
<p><a href="/blog/2018/04/23/setup-router-on-ubuntu16.04/">Ubuntu 16.04をルーター化</a> と
<a href="/blog/2018/04/24/ubuntu18.04-pxe-boot-server-on-ubuntu16.04/">Ubuntu 16.04上にUbuntu 18.04のPXEブートサーバをセットアップ</a>
に書いた環境を今回は Ubuntu 18.04 上で構築しました。</p>
<p>一言で言うと <code>tftpd-hpa</code> と <code>isc-dhcp-server</code> の2つのパッケージを
インストールします。</p>
<pre tabindex="0"><code class="language-console" data-lang="console">sudo apt install tftpd-hpa isc-dhcp-server
</code></pre><p>なお私は以前使っていた <code>/var/lib/tftpboot</code> ディレクトリは <code>/var/lib/tftpboot.bak</code> に退避して、空のディレクトリを作りました。</p>
<p><a href="https://ja.wikipedia.org/wiki/VyOS">VyOS - Wikipedia</a> によると VyOS は
Debian 6.0 (Squeeze) をベースにしているとのことなので、
<a href="http://ftp.riken.jp/Linux/debian/debian/dists/">http://ftp.riken.jp/Linux/debian/debian/dists/</a> 以下から
<a href="http://ftp.riken.jp/Linux/debian/debian/dists/wheezy/main/installer-amd64/current/images/netboot/netboot.tar.gz">http://ftp.riken.jp/Linux/debian/debian/dists/wheezy/main/installer-amd64/current/images/netboot/netboot.tar.gz</a>
をダウンロードして <code>/var/lib/tftpboot</code> 以下に展開しました。</p>
<pre tabindex="0"><code class="language-console" data-lang="console">curl -L http://ftp.riken.jp/Linux/debian/debian/dists/wheezy/main/installer-amd64/current/images/netboot/netboot.tar.gz | sudo tar xf - -C /var/lib/tftpboot
</code></pre><p><code>/etc/dhcp/dhcpd.conf</code> には以下の設定を追加しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">subnet 192.168.3.0 netmask 255.255.255.0 {
  option domain-name-servers 192.168.2.1;
  option routers 192.168.3.1;
  filename &#34;pxelinux.0&#34;;
}

host beagle {
  hardware ethernet XX:XX:XX:XX:XX:XX;
  fixed-address 192.168.3.2;
}
</code></pre></div><h1 id="vyosのpxe-ブート環境の整備">VyOSのPXE ブート環境の整備</h1>
<p><a href="https://wiki.vyos.net/wiki/PXE">PXE - VyOS Wiki</a> にはパッチを当てた initrd.img を使ったと書いていましたが、リンク切れになっていたのと <a href="https://github.com/vyos/live-initramfs/pull/1">Fix PXE booting helium · Pull Request #1 · vyos/live-initramfs</a> のコメントによると VyOS 1.1.8 には取り込まれたようだったので、 1.1.8 のをそのまま使いました。</p>
<p>作業用ディレクトリを作成して、VyOS のダウンロードページから ISO イメージをダウンロードし、マウント用ディレクトリ mnt を作ってそこにループバックマウントします。</p>
<pre tabindex="0"><code class="language-console" data-lang="console">mkdir ~/vyos
cd !$
curl -LO https://downloads.vyos.io/release/1.1.8/vyos-1.1.8-amd64.iso
mkdir mnt
sudo mount -o loop vyos-1.1.8-amd64.iso mnt
</code></pre><p>mnt/live ディレクトリ内の vmlinuz と initrd.img を tftpd の公開領域に vyos というディレクトリを作ってコピーします。</p>
<pre tabindex="0"><code class="language-console" data-lang="console">sudo mkdir /var/lib/tftpboot/vyos
sudo cp -p mnt/live/{vmlinuz,initrd.img} !$
</code></pre><p>HTTP サーバで配信するためのディレクトリを作り、 mnt/live ディレクトリ内の filesystem.squashfs をそこにコピーします。</p>
<pre tabindex="0"><code class="language-console" data-lang="console">sudo mkdir -p /opt/kickstart/export/vyos
sudo cp -p mnt/live/filesystem.squashfs !$
</code></pre><p>nginx で以下の設定を <code>/etc/nginx/conf.d/vyos-pxe-boot.conf</code> として作成し(他の設定がある場合は適宜調整し) <code>systemctl reload nginx</code> で反映させます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">server {
    listen 80;
    server_name localhost;

    location /vyos {
        root /opt/kickstart/export;
    }
}
</code></pre></div><p><code>/var/lib/tftpboot/pxelinux.cfg/default</code> に以下の内容を追加します。
<code>append</code> 行の最後の <code>verbose debug=vc</code> の部分はデバッグ用なので無くても良いですが、指定しておくとシェルスクリプトが <code>set -x</code> つきで実行されるので便利です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">label vyos
   kernel /vyos/vmlinuz
   append initrd=/vyos/initrd.img console=ttyS0 console=tty0 boot=live nopersistent noautologin nonetworking nouser hostname=vyos fetch=http://192.168.3.1/vyos/filesystem.squashfs verbose debug=vc
   ipappend 2
</code></pre></div><h1 id="pxeブートしてインストール">PXEブートしてインストール</h1>
<p>PXEブートし、上記で追加した vyos メニューを選び、あとは
<a href="https://wiki.vyos.net/wiki/User_Guide#Installation">Installation - User Guide - VyOS Wiki</a>
(<a href="https://wiki.vyos-users.jp/index.php/%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%82%AC%E3%82%A4%E3%83%89#.E3.82.A4.E3.83.B3.E3.82.B9.E3.83.88.E3.83.BC.E3.83.AB">日本語訳</a>
に従ってインストールすれば OK でした。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
