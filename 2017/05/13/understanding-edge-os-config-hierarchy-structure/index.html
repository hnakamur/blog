<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.62.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>EdgeOSの設定項目の階層構造を理解する &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>EdgeOSの設定項目の階層構造を理解する</h1>
  <time datetime=2017-05-13T10:48:00&#43;0900 class="post-date">2017-05-13</time>
  <h2 id="heading">はじめに</h2>
<p>EdgeRouter Lite (ERLite-3)をCLI (Command Line Interface)で設定しているうちにようやく基本が理解できたのでメモです。</p>
<h2 id="edgeos">EdgeOSとは</h2>
<p><a href="http://edge-os.net/wiki/view/%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%9A%E3%83%BC%E3%82%B8">EdgeOS 日本語Wiki [非公式]</a> の「EdgeOS とは」と「VyOS・Vyatta との違い」の説明がわかりやすかったです。</p>
<h2 id="cli">CLIの設定の基本操作</h2>
<p><a href="http://edge-os.net/wiki/view/%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89_%EF%BC%9E_%E3%82%B3%E3%83%9E%E3%83%B3%E3%83%89%E4%B8%80%E8%A6%A7">コマンド ＞ コマンド一覧 - EdgeOS 日本語Wiki [非公式]</a> の「CLI の基本操作」がとっかかりとしては良かったです。</p>
<h2 id="edgeos-user-guide">公式のEdgeOS User Guideのダウンロード</h2>
<p><a href="https://www.ubnt.com/download/edgemax/edgerouter-lite/erlite3">Ubiquiti NetworksのERLite-3用のファームウェアとドキュメントのダウンロードページ</a> から &ldquo;EdgeOS(TM) User Guide&rdquo; がダウンロードできました。</p>
<p>.. image:: {attach}/images/2017/05/13/Ubiquiti-Networks-Downloads-ERLite-3.png
:width: 538px
:height: 410px
:alt: ERLite-3 document and firmware download page</p>
<p>このページへの行き方もメモしておきます。</p>
<ol>
<li><a href="https://www.ubnt.com/">Ubiquiti Networks - Wireless networking products for broadband and enterprise</a> の右上の &ldquo;Support&rdquo; をクリック。</li>
<li><a href="https://help.ubnt.com/hc/en-us">Ubiquiti Networks Support and Help Center</a> で &ldquo;EdgeMax&rdquo; をクリック。</li>
<li><a href="https://help.ubnt.com/hc/en-us/categories/200321064-EdgeMAX">EdgeMAX – Ubiquiti Networks Support and Help Center</a> で &ldquo;Latest Software&rdquo; をクリック。</li>
<li><a href="https://www.ubnt.com/download/edgemax/">Ubiquiti Networks - Downloads</a> の左のツリーで &ldquo;EdgeRouter Lite&rdquo; の &ldquo;ERLite-3&rdquo; を選択。</li>
</ol>
<h2 id="edgeos-user-guidecli">EdgeOS User GuideのCLIでの設定の流れの説明</h2>
<p>Appendix AのCommand Line Interfaceにコマンドラインでの設定の流れについて図入りで詳しく説明されていますのでぜひご覧ください。</p>
<h2 id="cli-1">CLIの補完とコマンド履歴検索</h2>
<ul>
<li>CLIではTABキーでコマンドやサブコマンドの補完が効きます。</li>
<li>またCtrl-Rでコマンド履歴検索も使えます。</li>
</ul>
<h2 id="heading-1">設定の流れ</h2>
<ul>
<li>CLIには操作 (Operational) モードと設定 (Configuration) モードという2つのモードがあります。</li>
<li>操作モードでは <code>ubnt@ubnt:~$</code> のように ユーザ名、ホスト名、カレントディレクトリの後に <code>$</code> が付いたプロンプトになっています。</li>
<li><code>configure</code> コマンドで設定モードに入ります。</li>
<li>設定モードでは <code>ubnt@ubnt#</code> のようにユーザ名、ホスト名の後に <code>#</code> がついたプロンプトになっています。</li>
<li>設定の追加・上書きは <code>set</code> コマンドを使い、ざっくり言うと「set 設定項目 値」のように指定します。</li>
<li>設定の削除は <code>delete</code> コマンドを使い、ざっくり言うと「delete 設定項目」のように指定します。</li>
<li>さらには設定項目のコピーやリネームも出来ます。詳細はEdgeOS User Guideを参照してください。</li>
<li>設定項目は階層構造になっています。上で「ざっくり言うと」と書いた「設定項目」のところは階層構造のパスを指定することに相当します。</li>
<li>設定を変更したら <code>compare</code> コマンドで変更点を一覧できます。</li>
<li>さらに <code>show</code> コマンドを実行して設定内容全体をJSON形式で表示します。削除された行の先頭には <code>-</code> 、追加された行の先頭には <code>+</code> 、変更された行の先頭には <code>&gt;</code> が表示されます。また <code>show</code> の後に設定項目名または項目名のパスの一部を指定することで、一部の設定を確認することも出来ます。後ほど例を示します。</li>
<li>変更内容に問題がなければ <code>commit</code> コマンドで確定します。変更内容を破棄したい場合は <code>discard</code> コマンドを実行します。</li>
<li><code>commit</code> コマンドを実行した時点ではメモリ上の設定のみが更新されています。動作確認して問題がなければ <code>save</code> コマンドを実行して、設定内容をディスク上のファイル <code>/config/config.boot</code> に保存しておきます。するとEdgeRouterが再起動しても設定が維持されます。</li>
<li><code>save</code> コマンドの後にファイル名を指定して別名で保存したり、EdgeRouterから別のマシンにscp、ftp、tftpで接続して設定ファイルを保存したり、コミット履歴を指定した数だけ保持しておくということも可能です。が、私はPCのほうから <code>scp</code> コマンドを実行して <code>/config/config.boot</code> をEdgeRouterからPCにコピーして <code>git</code> でバージョン管理することにしました。</li>
<li>最後に <code>exit</code> コマンドを実行して設定モードから抜けて操作モードに戻ります。変更を破棄して抜けたいときは <code>discard</code> と <code>exit</code> を順に実行する代わりに <code>exit discard</code> でも可能です。</li>
</ul>
<h2 id="heading-2">設定の構造を意識する必要がある例</h2>
<p>DHCPサーバーの設定を例として示します。</p>
<pre><code class="language-console" data-lang="console">set service dhcp-server shared-network-name LAN2 subnet 192.168.3.0/24 start 192.168.3.2 stop 192.168.3.99
</code></pre><p>この設定を削除するには以下のコマンドを実行すれば良いかと当初は思っていました。</p>
<pre><code class="language-console" data-lang="console">delete service dhcp-server shared-network-name LAN2 subnet 192.168.3.0/24 start 192.168.3.2 stop 192.168.3.99
</code></pre><p><code>compare</code> コマンドを実行すると以下のように表示されました。</p>
<pre><code class="language-console" data-lang="console">ubnt@ubnt# compare
[edit service dhcp-server shared-network-name LAN2 subnet 192.168.3.0/24 start 192.168.3.2]
-stop 192.168.3.99
[edit]
</code></pre><p>仕組みを一旦理解した後ならこの出力でもわかるのですが、 <code>show</code> コマンドを実行したほうがわかりやすいです。出力が長いので以下では抜粋して示します。</p>
<pre><code class="language-console" data-lang="console">ubnt@ubnt# show
…(略)…
 service {
     dhcp-server {
         disabled false
         hostfile-update disable
…(略)…
         shared-network-name LAN2 {
             authoritative disable
             subnet 192.168.3.0/24 {
                 default-router 192.168.3.1
                 dns-server 192.168.3.1
                 lease 86400
                 start 192.168.3.2 {
-                    stop 192.168.3.99
                 }
             }
         }
         use-dnsmasq disable
     }
…(略)…
</code></pre><p><code>service</code> &gt; <code>dhcp-server</code> &gt; <code>shared-network-name LAN2</code> というキーのパスになっていることがわかったので、以下のコマンドでその部分だけを表示してみます。</p>
<pre><code class="language-console" data-lang="console">ubnt@ubnt# show service dhcp-server shared-network-name LAN2
 authoritative disable
 subnet 192.168.3.0/24 {
     default-router 192.168.3.1
     dns-server 192.168.3.1
     lease 86400
     start 192.168.3.2 {
-        stop 192.168.3.99
     }
 }
[edit]
</code></pre><p>この後、以下のようにDHCPで払い出すIPアドレスの範囲の終端だけを違う値に設定するのであれば、変更内容は以下のようになり問題はありません。</p>
<pre><code class="language-console" data-lang="console">ubnt@ubnt# set service dhcp-server shared-network-name LAN2 subnet 192.168.3.0/24 start 192.168.3.2 stop 192.168.3.199
[edit]
ubnt@ubnt# show service dhcp-server shared-network-name LAN2
 authoritative disable
 subnet 192.168.3.0/24 {
     default-router 192.168.3.1
     dns-server 192.168.3.1
     lease 86400
     start 192.168.3.2 {
&gt;        stop 192.168.3.199
     }
 }
[edit]
</code></pre><p>ですが、開始と終端のアドレスを両方変えたい場合は、以下の手順ではまずいです。
ここでは上の変更を破棄するため一旦 <code>discard</code> コマンドを実行して <code>delete</code> をやり直した後、開始と終端のアドレスを変えようとしています。が、差分を見ると変更前の開始アドレス <code>start 192.168.3.2</code> の設定が残ってしまっています。</p>
<pre><code class="language-console" data-lang="console">ubnt@ubnt# discard
Changes have been discarded
[edit]
ubnt@ubnt# delete service dhcp-server shared-network-name LAN2 subnet 192.168.3.0/24 start 192.168.3.2 stop 192.168.3.99
[edit]
ubnt@ubnt# show service dhcp-server shared-network-name LAN2
 authoritative disable
 subnet 192.168.3.0/24 {
     default-router 192.168.3.1
     dns-server 192.168.3.1
     lease 86400
     start 192.168.3.2 {
-        stop 192.168.3.99
     }
 }
[edit]
ubnt@ubnt# set service dhcp-server shared-network-name LAN2 subnet 192.168.3.0/24 start 192.168.3.100 stop 192.168.3.199
[edit]
ubnt@ubnt# show service dhcp-server shared-network-name LAN2
 authoritative disable
 subnet 192.168.3.0/24 {
     default-router 192.168.3.1
     dns-server 192.168.3.1
     lease 86400
     start 192.168.3.2 {
-        stop 192.168.3.99
     }
+    start 192.168.3.100 {
+        stop 192.168.3.199
+    }
 }
[edit]
</code></pre><p>また、上記のように別の設定を追加するのではなく、単に削除したい場合も上記の手順ではまずいです。
今回の場合、古い設定の削除は以下のように <code>start</code> とその値までを指定して <code>stop</code> 以降は含めないのが正解でした。</p>
<pre><code class="language-console" data-lang="console">ubnt@ubnt# delete service dhcp-server shared-network-name LAN2 subnet 192.168.3.0/24 start 192.168.3.2
[edit]
ubnt@ubnt# show service dhcp-server shared-network-name LAN2
 authoritative disable
 subnet 192.168.3.0/24 {
     default-router 192.168.3.1
     dns-server 192.168.3.1
     lease 86400
-    start 192.168.3.2 {
-        stop 192.168.3.99
-    }
+    start 192.168.3.100 {
+        stop 192.168.3.199
+    }
 }
[edit]
</code></pre><p>ということで、設定項目の階層構造を把握しつつ設定の削除や変更を行う必要があるという話でした。</p>

</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
