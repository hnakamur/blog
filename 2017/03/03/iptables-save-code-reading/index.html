<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>iptables-saveのコードリーディング</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/03/03/iptables-save-code-reading/" rel="bookmark"
           title="Permalink to iptables-saveのコードリーディング">iptables-saveのコードリーディング</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-03-03T23:45:00+09:00">
                Published: 2017-03-03
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/iptables.html">iptables</a> <a href="../../../../tag/code-reading.html">code-reading</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="/blog/2017/02/24/iptables-restore-code-reading/">iptables-restoreのコードリーディング</a> の続きです。</p>
<p><tt class="docutils literal"><span class="pre">iptables-save</span></tt> でルールを出力する部分のコードリーディングのメモです。</p>
</div>
<div class="section" id="iptables-save-main">
<h2><tt class="docutils literal">iptables_save_main</tt> 関数からの流れ</h2>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables-save.c?id=482c6d3731e2681cb4baae835c294840300197e6#n120">iptables/iptables-save.c#L120-#L168</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Format:</span>
<span class="cm"> * :Chain name POLICY packets bytes</span>
<span class="cm"> * rule</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">iptables_save_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tablename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>

    <span class="n">iptables_globals</span><span class="p">.</span><span class="n">program_name</span> <span class="o">=</span> <span class="s">&quot;iptables-save&quot;</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">xtables_init_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iptables_globals</span><span class="p">,</span> <span class="n">NFPROTO_IPV4</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s/%s Failed to initialize xtables</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">iptables_globals</span><span class="p">.</span><span class="n">program_name</span><span class="p">,</span>
                            <span class="n">iptables_globals</span><span class="p">.</span><span class="n">program_version</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#if defined(ALL_INCLUSIVE) || defined(NO_SHARED_LIBS)</span>
    <span class="n">init_extensions</span><span class="p">();</span>
    <span class="n">init_extensions4</span><span class="p">();</span>
<span class="cp">#endif</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&quot;bcdt:&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="sc">&#39;c&#39;</span><span class="o">:</span>
                    <span class="n">show_counters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>

            <span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>
                    <span class="cm">/* Select specific table. */</span>
                    <span class="n">tablename</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;M&#39;</span><span class="o">:</span>
                    <span class="n">xtables_modprobe_program</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span>
                    <span class="n">do_output</span><span class="p">(</span><span class="n">tablename</span><span class="p">);</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Unknown arguments found on commandline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">!</span><span class="n">do_output</span><span class="p">(</span><span class="n">tablename</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal"><span class="pre">-t</span></tt> オプションを指定しない場合は <tt class="docutils literal">tablename = NULL</tt> で <tt class="docutils literal">do_output</tt> 関数を呼び出します。</p>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/ip6tables-save.c?id=482c6d3731e2681cb4baae835c294840300197e6#n25">iptables/ip6tables-save.c#L25</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">show_counters</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables-save.c?id=482c6d3731e2681cb4baae835c294840300197e6#n59">iptables/iptables-save.c#L59-#L118</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">do_output</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tablename</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">xtc_handle</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tablename</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">for_each_table</span><span class="p">(</span><span class="o">&amp;</span><span class="n">do_output</span><span class="p">);</span>

    <span class="n">h</span> <span class="o">=</span> <span class="n">iptc_init</span><span class="p">(</span><span class="n">tablename</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">xtables_load_ko</span><span class="p">(</span><span class="n">xtables_modprobe_program</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">iptc_init</span><span class="p">(</span><span class="n">tablename</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">h</span><span class="p">)</span>
            <span class="n">xtables_error</span><span class="p">(</span><span class="n">OTHER_PROBLEM</span><span class="p">,</span> <span class="s">&quot;Cannot initialize: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                       <span class="n">iptc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

    <span class="kt">time_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;# Generated by iptables-save v%s on %s&quot;</span><span class="p">,</span>
           <span class="n">IPTABLES_VERSION</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">));</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;*%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tablename</span><span class="p">);</span>

    <span class="cm">/* Dump out chain names first,</span>
<span class="cm">     * thereby preventing dependency conflicts */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">chain</span> <span class="o">=</span> <span class="n">iptc_first_chain</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
         <span class="n">chain</span><span class="p">;</span>
         <span class="n">chain</span> <span class="o">=</span> <span class="n">iptc_next_chain</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="p">{</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;:%s &quot;</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">iptc_builtin</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">struct</span> <span class="n">xt_counters</span> <span class="n">count</span><span class="p">;</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span>
                           <span class="n">iptc_get_policy</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="n">h</span><span class="p">));</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[%llu:%llu]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">count</span><span class="p">.</span><span class="n">pcnt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">count</span><span class="p">.</span><span class="n">bcnt</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;- [0:0]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">chain</span> <span class="o">=</span> <span class="n">iptc_first_chain</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>
         <span class="n">chain</span><span class="p">;</span>
         <span class="n">chain</span> <span class="o">=</span> <span class="n">iptc_next_chain</span><span class="p">(</span><span class="n">h</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">const</span> <span class="k">struct</span> <span class="n">ipt_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

            <span class="cm">/* Dump out rules */</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">iptc_first_rule</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
            <span class="k">while</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">print_rule4</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">show_counters</span><span class="p">);</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">iptc_next_rule</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
            <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;COMMIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;# Completed on %s&quot;</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">));</span>
    <span class="n">iptc_free</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">tablename</tt> が <tt class="docutils literal">NULL</tt> で呼び出された場合 <tt class="docutils literal">for_each_table</tt> 関数で各テーブルごとに <tt class="docutils literal">do_output</tt> 関数を呼び出します。</p>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables-save.c?id=482c6d3731e2681cb4baae835c294840300197e6#n34">iptables/iptables-save.c#L34-#L56</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Debugging prototype. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">for_each_table</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tablename</span><span class="p">))</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">procfile</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">tablename</span><span class="p">[</span><span class="n">XT_TABLE_MAXNAMELEN</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

    <span class="n">procfile</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;/proc/net/ip_tables_names&quot;</span><span class="p">,</span> <span class="s">&quot;re&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">procfile</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tablename</span><span class="p">),</span> <span class="n">procfile</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tablename</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
                    <span class="n">xtables_error</span><span class="p">(</span><span class="n">OTHER_PROBLEM</span><span class="p">,</span>
                               <span class="s">&quot;Badly formed tablename `%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                               <span class="n">tablename</span><span class="p">);</span>
            <span class="n">tablename</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">tablename</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
            <span class="n">ret</span> <span class="o">&amp;=</span> <span class="n">func</span><span class="p">(</span><span class="n">tablename</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">fclose</span><span class="p">(</span><span class="n">procfile</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">/proc/net/ip_tables_names</tt> の出力結果の各行がテーブル名になっていて、各テーブルごとに引数 <tt class="docutils literal">func</tt> で指定された関数を実行します。</p>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n1069">iptables/iptables.c#L1069-#L1148</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081
1082
1083
1084
1085
1086
1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097
1098
1099
1100
1101
1102
1103
1104
1105
1106
1107
1108
1109
1110
1111
1112
1113
1114
1115
1116
1117
1118
1119
1120
1121
1122
1123
1124
1125
1126
1127
1128
1129
1130
1131
1132
1133
1134
1135
1136
1137
1138
1139
1140
1141
1142
1143
1144
1145
1146
1147
1148</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* We want this to be readable, so only print out neccessary fields.</span>
<span class="cm"> * Because that&#39;s the kind of world I want to live in.  */</span>
<span class="kt">void</span> <span class="nf">print_rule4</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ipt_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
            <span class="k">struct</span> <span class="n">xtc_handle</span> <span class="o">*</span><span class="n">h</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">counters</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">xt_entry_target</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">target_name</span><span class="p">;</span>

    <span class="cm">/* print counters for iptables-save */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">counters</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;[%llu:%llu] &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">pcnt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">bcnt</span><span class="p">);</span>

    <span class="cm">/* print chain name */</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;-A %s&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>

    <span class="cm">/* Print IP part. */</span>
    <span class="n">print_ip</span><span class="p">(</span><span class="s">&quot;-s&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">src</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">smsk</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
                    <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span> <span class="o">&amp;</span> <span class="n">IPT_INV_SRCIP</span><span class="p">);</span>

    <span class="n">print_ip</span><span class="p">(</span><span class="s">&quot;-d&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">dst</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">dmsk</span><span class="p">.</span><span class="n">s_addr</span><span class="p">,</span>
                    <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span> <span class="o">&amp;</span> <span class="n">IPT_INV_DSTIP</span><span class="p">);</span>

    <span class="n">print_iface</span><span class="p">(</span><span class="sc">&#39;i&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">iniface</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">iniface_mask</span><span class="p">,</span>
                <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span> <span class="o">&amp;</span> <span class="n">IPT_INV_VIA_IN</span><span class="p">);</span>

    <span class="n">print_iface</span><span class="p">(</span><span class="sc">&#39;o&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">outiface</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">outiface_mask</span><span class="p">,</span>
                <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span> <span class="o">&amp;</span> <span class="n">IPT_INV_VIA_OUT</span><span class="p">);</span>

    <span class="n">print_proto</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">proto</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span> <span class="o">&amp;</span> <span class="n">XT_INV_PROTO</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPT_F_FRAG</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s -f&quot;</span><span class="p">,</span>
                   <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span> <span class="o">&amp;</span> <span class="n">IPT_INV_FRAG</span> <span class="o">?</span> <span class="s">&quot; !&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

    <span class="cm">/* Print matchinfo part */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">target_offset</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">IPT_MATCH_ITERATE</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">print_match_save</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* print counters for iptables -R */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">counters</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot; -c %llu %llu&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">pcnt</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">bcnt</span><span class="p">);</span>

    <span class="cm">/* Print target name and targinfo part */</span>
    <span class="n">target_name</span> <span class="o">=</span> <span class="n">iptc_get_target</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">ipt_get_target</span><span class="p">((</span><span class="k">struct</span> <span class="n">ipt_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">e</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">const</span> <span class="k">struct</span> <span class="n">xtables_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span>
                    <span class="n">xtables_find_target</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">XTF_TRY_LOAD</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Can&#39;t find library for target `%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">t</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">&quot; -j %s&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">alias</span> <span class="o">?</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">:</span> <span class="n">target_name</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">)</span>
                    <span class="n">target</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
            <span class="k">else</span> <span class="p">{</span>
                    <span class="cm">/* If the target size is greater than xt_entry_target</span>
<span class="cm">                     * there is something to be saved, we just don&#39;t know</span>
<span class="cm">                     * how to print it */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">target_size</span> <span class="o">!=</span>
                        <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_entry_target</span><span class="p">))</span> <span class="p">{</span>
                            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Target `%s&#39; is missing &quot;</span>
                                            <span class="s">&quot;save function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                    <span class="n">t</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
                            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                    <span class="p">}</span>
            <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">target_name</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">target_name</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">))</span>
<span class="cp">#ifdef IPT_F_GOTO</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot; -%c %s&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">ip</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPT_F_GOTO</span> <span class="o">?</span> <span class="sc">&#39;g&#39;</span> <span class="o">:</span> <span class="sc">&#39;j&#39;</span><span class="p">,</span> <span class="n">target_name</span><span class="p">);</span>
<span class="cp">#else</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot; -j %s&quot;</span><span class="p">,</span> <span class="n">target_name</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>ルールの出力は以下のようになっています。</p>
<ul class="simple">
<li>1082行目: <tt class="docutils literal"><span class="pre">-A</span> チェイン名</tt> を出力します。</li>
<li>1088行目: <tt class="docutils literal"><span class="pre">-s</span> ソースアドレス</tt> を出力します。ただし場合によっては出力しません（下記 <tt class="docutils literal">print_ip</tt> 関数参照）。</li>
<li>1088行目: <tt class="docutils literal"><span class="pre">-d</span> デスティネーションアドレス</tt> を出力します。ただし場合によっては出力しません（下記 <tt class="docutils literal">print_ip</tt> 関数参照）。</li>
<li>1091行目: 入力インターフェースの情報を出力します。ただし場合によっては出力しません（下記 <tt class="docutils literal">print_iface</tt> 関数参照）。</li>
<li>1094行目: 出力インターフェースの情報を出力します。ただし場合によっては出力しません（下記 <tt class="docutils literal">print_iface</tt> 関数参照）。</li>
<li>1097行目: <tt class="docutils literal"><span class="pre">-p</span></tt> オプションでのプロトコルの指定を出力します。ただし場合によっては出力しません（下記 <tt class="docutils literal">print_proto</tt> 関数参照）。</li>
<li>1099行目: ルールがフラグメントルールの場合は <tt class="docutils literal"><span class="pre">-f</span></tt> オプションを出力します。</li>
<li>1104行目: <tt class="docutils literal"><span class="pre">e-&gt;target_offset</span></tt> が <tt class="docutils literal">0</tt> 以外の場合は <tt class="docutils literal">print_match_save</tt> 関数を <tt class="docutils literal">IPT_MATCH_ITERATE</tt> マクロでループして <tt class="docutils literal"><span class="pre">-m</span></tt> オプションを出力します。</li>
<li>1109行目: <tt class="docutils literal">counters</tt> が負の場合は <tt class="docutils literal"><span class="pre">-c</span></tt> オプションでカウンタの数値を出力します。</li>
<li>1115～1145行目: いろいろ分岐はありますが場合によって <tt class="docutils literal"><span class="pre">-j</span></tt> か <tt class="docutils literal"><span class="pre">-g</span></tt> オプションでターゲット名と場合によってその後に <tt class="docutils literal">targinfo</tt> のオプションを出力します。</li>
</ul>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/include/linux/netfilter_ipv4/ip_tables.h?id=482c6d3731e2681cb4baae835c294840300197e6#n217">include/linux/netfilter_ipv4/ip_tables.h#L217-#L222</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>217
218
219
220
221
222</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Helper functions */</span>
<span class="k">static</span> <span class="n">__inline__</span> <span class="k">struct</span> <span class="n">xt_entry_target</span> <span class="o">*</span>
<span class="nf">ipt_get_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">ipt_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">e</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">target_offset</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/include/linux/netfilter/x_tables.h?id=482c6d3731e2681cb4baae835c294840300197e6#n33">include/linux/netfilter/x_tables.h#L33-#L54</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">xt_entry_target</span> <span class="p">{</span>
    <span class="k">union</span> <span class="p">{</span>
            <span class="k">struct</span> <span class="p">{</span>
                    <span class="n">__u16</span> <span class="n">target_size</span><span class="p">;</span>

                    <span class="cm">/* Used by userspace */</span>
                    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">XT_EXTENSION_MAXNAMELEN</span><span class="p">];</span>
                    <span class="n">__u8</span> <span class="n">revision</span><span class="p">;</span>
            <span class="p">}</span> <span class="n">user</span><span class="p">;</span>
            <span class="k">struct</span> <span class="p">{</span>
                    <span class="n">__u16</span> <span class="n">target_size</span><span class="p">;</span>

                    <span class="cm">/* Used inside the kernel */</span>
                    <span class="k">struct</span> <span class="n">xt_target</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
            <span class="p">}</span> <span class="n">kernel</span><span class="p">;</span>

            <span class="cm">/* Total length */</span>
            <span class="n">__u16</span> <span class="n">target_size</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">u</span><span class="p">;</span>

    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/include/xtables.h?id=482c6d3731e2681cb4baae835c294840300197e6#n283">include/xtables.h#L283-#L358</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">xtables_target</span>
<span class="p">{</span>
    <span class="cm">/*</span>
<span class="cm">     * ABI/API version this module requires. Must be first member,</span>
<span class="cm">     * as the rest of this struct may be subject to ABI changes.</span>
<span class="cm">     */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">xtables_target</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>


    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

    <span class="cm">/* Real target behind this, if any. */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">real_name</span><span class="p">;</span>

    <span class="cm">/* Revision of target (0 by default). */</span>
    <span class="n">u_int8_t</span> <span class="n">revision</span><span class="p">;</span>

    <span class="cm">/* Extension flags */</span>
    <span class="n">u_int8_t</span> <span class="n">ext_flags</span><span class="p">;</span>

    <span class="n">u_int16_t</span> <span class="n">family</span><span class="p">;</span>


    <span class="cm">/* Size of target data. */</span>
    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>

    <span class="cm">/* Size of target data relevant for userspace comparison purposes */</span>
    <span class="kt">size_t</span> <span class="n">userspacesize</span><span class="p">;</span>

    <span class="cm">/* Function which prints out usage message. */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">help</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

    <span class="cm">/* Initialize the target. */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">xt_entry_target</span> <span class="o">*</span><span class="n">t</span><span class="p">);</span>

    <span class="cm">/* Function which parses command options; returns true if it</span>
<span class="cm">           ate an option */</span>
    <span class="cm">/* entry is struct ipt_entry for example */</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">parse</span><span class="p">)(</span><span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">invert</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
                 <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
                 <span class="k">struct</span> <span class="n">xt_entry_target</span> <span class="o">**</span><span class="n">targetinfo</span><span class="p">);</span>

    <span class="cm">/* Final check; exit if not ok. */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">final_check</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>

    <span class="cm">/* Prints out the target iff non-NULL: put space at end */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">print</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
                  <span class="k">const</span> <span class="k">struct</span> <span class="n">xt_entry_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numeric</span><span class="p">);</span>

    <span class="cm">/* Saves the targinfo in parsable form to stdout. */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">save</span><span class="p">)(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span>
                 <span class="k">const</span> <span class="k">struct</span> <span class="n">xt_entry_target</span> <span class="o">*</span><span class="n">target</span><span class="p">);</span>

    <span class="cm">/* Print target name or alias */</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">alias</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_entry_target</span> <span class="o">*</span><span class="n">target</span><span class="p">);</span>

    <span class="cm">/* Pointer to list of extra command-line options */</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">extra_opts</span><span class="p">;</span>

    <span class="cm">/* New parser */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">x6_parse</span><span class="p">)(</span><span class="k">struct</span> <span class="n">xt_option_call</span> <span class="o">*</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">x6_fcheck</span><span class="p">)(</span><span class="k">struct</span> <span class="n">xt_fcheck_call</span> <span class="o">*</span><span class="p">);</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">xt_option_entry</span> <span class="o">*</span><span class="n">x6_options</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="n">udata_size</span><span class="p">;</span>

    <span class="cm">/* Ignore these men behind the curtain: */</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">udata</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">option_offset</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">xt_entry_target</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tflags</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">used</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loaded</span><span class="p">;</span> <span class="cm">/* simulate loading so options are merged properly */</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/include/linux/netfilter_ipv4/ip_tables.h?id=482c6d3731e2681cb4baae835c294840300197e6#n99">include/linux/netfilter_ipv4/ip_tables.h#L99-#L121</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* This structure defines each of the firewall rules.  Consists of 3</span>
<span class="cm">   parts which are 1) general IP header stuff 2) match specific</span>
<span class="cm">   stuff 3) the target to perform if the rule matches */</span>
<span class="k">struct</span> <span class="n">ipt_entry</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">ipt_ip</span> <span class="n">ip</span><span class="p">;</span>

    <span class="cm">/* Mark with fields that we care about. */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nfcache</span><span class="p">;</span>

    <span class="cm">/* Size of ipt_entry + matches */</span>
    <span class="n">u_int16_t</span> <span class="n">target_offset</span><span class="p">;</span>
    <span class="cm">/* Size of ipt_entry + matches + target */</span>
    <span class="n">u_int16_t</span> <span class="n">next_offset</span><span class="p">;</span>

    <span class="cm">/* Back pointer */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">comefrom</span><span class="p">;</span>

    <span class="cm">/* Packet and byte counters. */</span>
    <span class="k">struct</span> <span class="n">xt_counters</span> <span class="n">counters</span><span class="p">;</span>

    <span class="cm">/* The matches (if any), then the target. */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">elems</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal"><span class="pre">target-&gt;save</span></tt> の例。拡張ごとに <tt class="docutils literal">struct xtables_target</tt> の配列が定義されています。</p>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/extensions/libxt_MARK.c?id=482c6d3731e2681cb4baae835c294840300197e6#n248">extensions/libxt_MARK.c#L248-#L262</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>248
249
250
251
252
253
254
255
256
257
258
259
260
261
262</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="n">xtables_target</span> <span class="n">mark_tg_reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span>
            <span class="p">.</span><span class="n">family</span>        <span class="o">=</span> <span class="n">NFPROTO_UNSPEC</span><span class="p">,</span>
            <span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;MARK&quot;</span><span class="p">,</span>
            <span class="p">.</span><span class="n">version</span>       <span class="o">=</span> <span class="n">XTABLES_VERSION</span><span class="p">,</span>
            <span class="p">.</span><span class="n">revision</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">.</span><span class="n">size</span>          <span class="o">=</span> <span class="n">XT_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_mark_target_info</span><span class="p">)),</span>
            <span class="p">.</span><span class="n">userspacesize</span> <span class="o">=</span> <span class="n">XT_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_mark_target_info</span><span class="p">)),</span>
            <span class="p">.</span><span class="n">help</span>          <span class="o">=</span> <span class="n">MARK_help</span><span class="p">,</span>
            <span class="p">.</span><span class="n">print</span>         <span class="o">=</span> <span class="n">MARK_print_v0</span><span class="p">,</span>
            <span class="p">.</span><span class="n">save</span>          <span class="o">=</span> <span class="n">MARK_save_v0</span><span class="p">,</span>
            <span class="p">.</span><span class="n">x6_parse</span>      <span class="o">=</span> <span class="n">MARK_parse_v0</span><span class="p">,</span>
            <span class="p">.</span><span class="n">x6_fcheck</span>     <span class="o">=</span> <span class="n">MARK_check</span><span class="p">,</span>
            <span class="p">.</span><span class="n">x6_options</span>    <span class="o">=</span> <span class="n">MARK_opts</span><span class="p">,</span>
    <span class="p">},</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/extensions/libxt_MARK.c?id=482c6d3731e2681cb4baae835c294840300197e6#n176">extensions/libxt_MARK.c#L176-#L183</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>176
177
178
179
180
181
182
183</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">MARK_save_v0</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ip</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">xt_entry_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">xt_mark_target_info</span> <span class="o">*</span><span class="n">markinfo</span> <span class="o">=</span>
            <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_mark_target_info</span> <span class="o">*</span><span class="p">)</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot; --set-mark&quot;</span><span class="p">);</span>
    <span class="n">print_mark</span><span class="p">(</span><span class="n">markinfo</span><span class="o">-&gt;</span><span class="n">mark</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>この拡張の場合は <tt class="docutils literal"><span class="pre">--set-mark</span></tt> というオプションが出力されるようです。</p>
<p><a class="reference external" href="https://git.netfilter.org/iptables/tree/include/linux/netfilter_ipv4/ip_tables.h?id=482c6d3731e2681cb4baae835c294840300197e6#n66">include/linux/netfilter_ipv4/ip_tables.h#L66-#L82</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Yes, Virginia, you have to zero the padding. */</span>
<span class="k">struct</span> <span class="n">ipt_ip</span> <span class="p">{</span>
    <span class="cm">/* Source and destination IP addr */</span>
    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">;</span>
    <span class="cm">/* Mask for src and dest IP addr */</span>
    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">smsk</span><span class="p">,</span> <span class="n">dmsk</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">iniface</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">],</span> <span class="n">outiface</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iniface_mask</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">],</span> <span class="n">outiface_mask</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

    <span class="cm">/* Protocol, 0 = ANY */</span>
    <span class="n">u_int16_t</span> <span class="n">proto</span><span class="p">;</span>

    <span class="cm">/* Flags word */</span>
    <span class="n">u_int8_t</span> <span class="n">flags</span><span class="p">;</span>
    <span class="cm">/* Inverse flags */</span>
    <span class="n">u_int8_t</span> <span class="n">invflags</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/include/linux/netfilter_ipv4/ip_tables.h?id=482c6d3731e2681cb4baae835c294840300197e6#n83">include/linux/netfilter_ipv4/ip_tables.h#L83-#L87</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>83
84
85
86</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Values for &quot;flag&quot; field in struct ipt_ip (general ip structure). */</span>
<span class="cp">#define IPT_F_FRAG          0x01    </span><span class="cm">/* Set if rule is a fragment rule */</span><span class="cp"></span>
<span class="cp">#define IPT_F_GOTO          0x02    </span><span class="cm">/* Set if jump is a goto */</span><span class="cp"></span>
<span class="cp">#define IPT_F_MASK          0x03    </span><span class="cm">/* All possible flag bits mask. */</span><span class="cp"></span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n1039">iptables/iptables.c#L1039-#L1067</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1039
1040
1041
1042
1043
1044
1045
1046
1047
1048
1049
1050
1051
1052
1053
1054
1055
1056
1057
1058
1059
1060
1061
1062
1063
1064
1065
1066
1067</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* print a given ip including mask if neccessary */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_ip</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ip</span><span class="p">,</span>
                 <span class="kt">uint32_t</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">invert</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">bits</span><span class="p">,</span> <span class="n">hmask</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ip</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">invert</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s %s %u.%u.%u.%u&quot;</span><span class="p">,</span>
            <span class="n">invert</span> <span class="o">?</span> <span class="s">&quot; !&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
            <span class="n">prefix</span><span class="p">,</span>
            <span class="n">IP_PARTS</span><span class="p">(</span><span class="n">ip</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mh">0xFFFFFFFFU</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;/32&quot;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">i</span>    <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
    <span class="n">bits</span> <span class="o">=</span> <span class="mh">0xFFFFFFFEU</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hmask</span> <span class="o">!=</span> <span class="n">bits</span><span class="p">)</span>
            <span class="n">bits</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;/%u&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">else</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;/%u.%u.%u.%u&quot;</span><span class="p">,</span> <span class="n">IP_PARTS</span><span class="p">(</span><span class="n">mask</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n989">iptables/iptables.c#L989-#L1013</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 989
 990
 991
 992
 993
 994
 995
 996
 997
 998
 999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* This assumes that mask is contiguous, and byte-bounded. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">print_iface</span><span class="p">(</span><span class="kt">char</span> <span class="n">letter</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iface</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mask</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">invert</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s -%c &quot;</span><span class="p">,</span> <span class="n">invert</span> <span class="o">?</span> <span class="s">&quot; !&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">letter</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IFNAMSIZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">iface</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="cm">/* we can access iface[i-1] here, because</span>
<span class="cm">                     * a few lines above we make sure that mask[0] != 0 */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;+&quot;</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n958">iptables/iptables.c#L958-#L979</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>958
959
960
961
962
963
964
965
966
967
968
969
970
971
972
973
974
975
976
977
978
979</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">print_proto</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="n">proto</span><span class="p">,</span> <span class="kt">int</span> <span class="n">invert</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">invertstr</span> <span class="o">=</span> <span class="n">invert</span> <span class="o">?</span> <span class="s">&quot; !&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

            <span class="k">const</span> <span class="k">struct</span> <span class="n">protoent</span> <span class="o">*</span><span class="n">pent</span> <span class="o">=</span> <span class="n">getprotobynumber</span><span class="p">(</span><span class="n">proto</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pent</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s -p %s&quot;</span><span class="p">,</span> <span class="n">invertstr</span><span class="p">,</span> <span class="n">pent</span><span class="o">-&gt;</span><span class="n">p_name</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">xtables_chain_protos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">xtables_chain_protos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span> <span class="o">==</span> <span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s -p %s&quot;</span><span class="p">,</span>
                                   <span class="n">invertstr</span><span class="p">,</span> <span class="n">xtables_chain_protos</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
                            <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>

            <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s -p %u&quot;</span><span class="p">,</span> <span class="n">invertstr</span><span class="p">,</span> <span class="n">proto</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/include/linux/netfilter_ipv4/ip_tables.h?id=482c6d3731e2681cb4baae835c294840300197e6#n58">include/linux/netfilter_ipv4/ip_tables.h#L58-#L60</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>58
59
60</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* fn returns 0 to continue iteration */</span>
<span class="cp">#define IPT_MATCH_ITERATE(e, fn, args...) \</span>
<span class="cp">    XT_MATCH_ITERATE(struct ipt_entry, e, fn, ## args)</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/include/linux/netfilter/x_tables.h?id=482c6d3731e2681cb4baae835c294840300197e6#n126">include/linux/netfilter/x_tables.h#L126-#L143</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* fn returns 0 to continue iteration */</span>
<span class="cp">#define XT_MATCH_ITERATE(type, e, fn, args...)                      \</span>
<span class="cp">({                                                          \</span>
<span class="cp">    unsigned int __i;                                       \</span>
<span class="cp">    int __ret = 0;                                          \</span>
<span class="cp">    struct xt_entry_match *__m;                             \</span>
<span class="cp">                                                            \</span>
<span class="cp">    for (__i = sizeof(type);                                \</span>
<span class="cp">         __i &lt; (e)-&gt;target_offset;                          \</span>
<span class="cp">         __i += __m-&gt;u.match_size) {                        \</span>
<span class="cp">            __m = (void *)e + __i;                          \</span>
<span class="cp">                                                            \</span>
<span class="cp">            __ret = fn(__m , ## args);                      \</span>
<span class="cp">            if (__ret != 0)                                 \</span>
<span class="cp">                    break;                                  \</span>
<span class="cp">    }                                                       \</span>
<span class="cp">    __ret;                                                  \</span>
<span class="cp">})</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n1015">iptables/iptables.c#L1015-#L1037</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036
1037</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">print_match_save</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">xt_entry_match</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
                    <span class="k">const</span> <span class="k">struct</span> <span class="n">ipt_ip</span> <span class="o">*</span><span class="n">ip</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">xtables_match</span> <span class="o">*</span><span class="n">match</span> <span class="o">=</span>
            <span class="n">xtables_find_match</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">XTF_TRY_LOAD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">&quot; -m %s&quot;</span><span class="p">,</span>
                    <span class="n">match</span><span class="o">-&gt;</span><span class="n">alias</span> <span class="o">?</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">alias</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">:</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

            <span class="cm">/* some matches don&#39;t provide a save function */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">match</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">)</span>
                    <span class="n">match</span><span class="o">-&gt;</span><span class="n">save</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">match_size</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
                            <span class="s">&quot;Can&#39;t find library for match `%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                            <span class="n">e</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>