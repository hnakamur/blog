<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.74.3" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>golang 1.9rc1のUbuntu 16.04用debパッケージをビルドした &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>golang 1.9rc1のUbuntu 16.04用debパッケージをビルドした</h1>
  <time datetime=2017-08-05T10:15:00&#43;0900 class="post-date">2017-08-05</time>
  <h2 id="はじめに">はじめに</h2>
<p><a href="https://github.com/golang/go/wiki/Ubuntu">Ubuntu · golang/go Wiki</a> で紹介されている
<a href="https://launchpad.net/~longsleep/+archive/ubuntu/golang-backports">Golang Backports : Simon Eisenmann</a> を改変してgo 1.9rc1のUbuntu 16.04用debパッケージをビルドしたのでメモです。</p>
<p><a href="https://launchpad.net/~hnakamur/+archive/ubuntu/golang-1.9">golang 1.9 : Hiroaki Nakamura</a> というPPAで配布しています。</p>
<p>この記事の手順は <a href="https://hnakamur.github.io/blog/2017/07/05/how-to-build-deb-with-git-buildpackage/">git-buildpackageでdebパッケージをビルドしてPPAにアップロードする手順</a> で書いたセットアップが済んでいることが前提です。</p>
<h2 id="今回ビルドしたdebのインストール手順">今回ビルドしたdebのインストール手順</h2>
<p>今回ビルドしたdebパッケージのインストール手順は以下の通りです。</p>
<pre><code class="language-console" data-lang="console">sudo apt update
sudo apt install software-properties-common
sudo add-apt-repository ppa:hnakamur/golang-1.9
sudo apt update
sudo apt install golang-go
</code></pre><p>LXDのコンテナを新規に作って試す場合の手順も書いておきます。以下ではコンテナ名を <code>go19</code> としていますが適宜変更してください。</p>
<pre><code class="language-console" data-lang="console">lxc launch images:ubuntu/xenial go19
lxc exec go19 bash
apt update
apt install software-properties-common
add-apt-repository ppa:hnakamur/golang-1.9
apt update
apt install golang-go
</code></pre><h2 id="goのdebパッケージの作成手順メモ">goのdebパッケージの作成手順メモ</h2>
<p>作成と言っても一からではなくて、 Simon Eisenmann (LaunchPadのアカウントID: longsleep) さんのdebパッケージのソースを取って来て、オリジンのソースを入れ替えて適宜書き換えるだけです。</p>
<h3 id="simon-さんのdebパッケージのソースをダウンロード">Simon さんのdebパッケージのソースをダウンロード</h3>
<p><a href="https://launchpad.net/~longsleep/+archive/ubuntu/golang-backports/+packages">Packages in “Golang Backports” : Golang Backports : Simon Eisenmann</a> でパッケージ名のリストを確認すると、以下の3つのパッケージがあります。</p>
<ul>
<li>golang-1.8</li>
<li>golang-1.8-race-detector-runtime</li>
<li>golang-defaults</li>
</ul>
<p>golang-1.8 のリンクをクリックして展開すると複数のパッケージファイルが並んでいますが、そのうち
golang-1.8-go というパッケージファイルをインストールすると /usr/lib/go-1.8/ 以下に /usr/lib/go-1.8/bin/go のように配置されるようになっています。</p>
<p>同様に golang-defaults のリンクをクリックして展開すると、 golang-go というパッケージファイルがあり、これをインストールすると <code>/usr/bin/go -&gt; ../lib/go-1.8/bin/go</code> というシンボリックリンクなどが作られるようになっています。</p>
<p>golang-1.8-race-detector-runtime はよくわかってないので今回はスキップします。</p>
<p>以下のコマンドを実行して golang-1.8 と golang-defaults のソースパッケージをダウンロードします。
ここでは <code>~/longsleep-go-deb</code> という作業ディレクトリを作成していますが、適宜変更してください。</p>
<pre><code class="language-console" data-lang="console">sudo add-apt-repository ppa:longsleep/golang-backports
sudo apt-get update
mkdir ~/longsleep-go-deb
cd !$
apt source golang-1.8-go golang-defaults
</code></pre><h3 id="golang-18のパッケージを改変してgolang-19のパッケージを作成">golang-1.8のパッケージを改変してgolang-1.9のパッケージを作成</h3>
<p>最終結果は <a href="https://github.com/hnakamur/golang-deb">https://github.com/hnakamur/golang-deb</a> で公開しています。
以下の手順は何回か試行錯誤した結果なのですが、上記のレポジトリと多少ずれているかもしれません。もう一度一からやり直して確認するの面倒なので、そのまま書いてしまいます。</p>
<p>以下ではレポジトリの作業ディレクトリを <code>~/.ghq/github.com/hnakamur/golang-deb</code> として説明します。適宜変更してください。</p>
<p>まず、 <code>.dsc</code> ファイルをインポートして、レポジトリを新規作成します。
ディレクトリ名を <code>golang</code> から <code>golang-deb</code> に変更して、そこに移動します。</p>
<pre><code class="language-console" data-lang="console">cd ~/.ghq/github.com/hnakamur
gbp import-dsc --pristine-tar \
	--debian-branch=ubuntu-1.8 --upstream-branch=upstream-1.8 \
	~/longsleep-go-deb/golang-1.8/golang-1.8_1.8.3-2ubuntu1~longsleep1-xenial.dsc
mv golang golang-deb
cd !$
</code></pre><p>ブランチを確認します。</p>
<pre><code class="language-console" data-lang="console">$ git branch
* master
  pristine-tar
  ubuntu-1.8
  upstream-1.8
</code></pre><p>タグを確認します。</p>
<pre><code class="language-console" data-lang="console">$ git tag
debian/1.8.3-2ubuntu1_longsleep1-xenial
upstream/1.8.3-2ubuntu1_longsleep1
</code></pre><p>このレポジトリには <code>debian/gbp.conf.in</code> というファイルがあって、gbp (git-buildpackage) 用のブランチやタグの形式が記載されています。</p>
<p>アップストリームのブランチは <code>upstream-X.Y</code> で、debパッケージのブランチは <code>ubuntu-X.Y</code> だということがわかります。 <code>X.Y</code> の部分は <code>debian/changelog</code> ファイルからバージョンを読み取って展開されるようになっています。</p>
<pre><code class="language-console" data-lang="console">$ cat debian/gbp.conf.in
[DEFAULT]
debian-branch = ubuntu-X.Y
debian-tag = debian/%(version)s
upstream-branch = upstream-X.Y
upstream-tag = upstream/%(version)s
pristine-tar = True

[git-dch]
meta = 1
</code></pre><p>試行錯誤していた時に、 <code>[git-dch]</code> というセクション名は古いので <code>[dch]</code> にせよという主旨の警告が出ました。そこで以下のコマンドを実行して変更しました。</p>
<pre><code class="language-console" data-lang="console">sed -i -e 's/^\[git-dch\]/[dch]/' debian/gbp.conf.in
</code></pre><p>さらに以下のコマンドを実行して <code>debian/gbp.conf.in</code> から <code>debian/gbp.conf</code> を生成して上書きします。</p>
<pre><code class="language-console" data-lang="console">debian/rules gencontrol
</code></pre><p>変更した <code>debian/gbp.conf.in</code> と <code>debian/gbp.conf</code> をコミットします。</p>
<pre><code class="language-console" data-lang="console">git commit -m 'Rename git-dch to dch in debian.gbp.conf.in' debian/gbp.conf.in debian/gbp.conf
</code></pre><p><code>ubuntu-1.8</code> ブランチにも上記の変更をマージします。</p>
<pre><code class="language-console" data-lang="console">git checkout ubuntu-1.8
git merge --ff master
</code></pre><p><code>upstream-1.8</code> ブランチから <code>upstream-1.9</code> ブランチを、
<code>ubuntu-1.8</code> ブランチから <code>ubuntu-1.9</code> ブランチを作成し、
<code>ubuntu-1.9</code> ブランチに切り替えます。</p>
<pre><code class="language-console" data-lang="console">git branch upstream-1.9 upstream-1.8
git checkout -b ubuntu-1.9 ubuntu-1.8
</code></pre><p>以下のコマンドを実行して <code>debian/changelog</code> にエントリを追加します。</p>
<pre><code class="language-console" data-lang="console">gbp dch -R --debian-branch ubuntu-1.9
</code></pre><p>エディタ (私の場合は vim) が起動しますので、先頭に追加されたエントリを以下のように編集します。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">golang-1.9 (1.9~rc1-1ubuntu1~hnakamur1-xenial) xenial; urgency=medium

  * New upstream release.

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Sat, 29 Jul 2017 00:38:32 +0900
</code></pre></div><p>以下のコマンドを実行して、ソースパッケージ内のgoのバージョンに依存したファイルを再生成します。</p>
<pre><code class="language-console" data-lang="console">debian/rules gencontrol
</code></pre><p>更新したファイルをコミットします。</p>
<pre><code class="language-console" data-lang="console">git add .
git commit -m 'Change control file to golang-1.9'
</code></pre><p>次に go 1.9rc1 のアップストリームのソースをインポートします。</p>
<pre><code class="language-console" data-lang="console">$ gbp import-orig --no-merge --no-interactive \
   --debian-branch=ubuntu-1.9 --upstream-branch=upstream-1.9 \
   --upstream-version=1.9~rc1 ~/go1.9rc1.src.tar.gz
gbp:info: Importing '/home/hnakamur/go1.9rc1.src.tar.gz' to branch 'upstream-1.9'...
gbp:info: Source package is golang-1.9
gbp:info: Upstream version is 1.9~rc1
gbp:info: Successfully imported version 1.9~rc1 of /home/hnakamur/go1.9rc1.src.tar.gz
</code></pre><p><code>ubuntu-1.9</code> ブランチに切り替えて <code>upstream-1.9</code> ブランチの変更をマージします。</p>
<pre><code class="language-console" data-lang="console">git checkout ubuntu-1.9
git merge --no-ff upstream-1.9
</code></pre><p>今回作成するdebパッケージのバージョン <code>1.9~rc1-1ubuntu1~hnakamur1-xenial</code> の <code>~</code> を <code>_</code> に置き換えたタグを打っておきます。</p>
<pre><code class="language-console" data-lang="console">git tag upstream/1.9_rc1-1ubuntu1_hnakamur1 upstream-1.9
</code></pre><p>さらに <code>master</code> ブランチに <code>upstream-1.9</code> ブランチの内容をマージしておきました。</p>
<pre><code class="language-console" data-lang="console">git checkout master
git merge ubuntu-1.9
</code></pre><p>以下のコマンドでソースパッケージをビルドします。</p>
<pre><code class="language-console" data-lang="console">gbp buildpackage --git-pristine-tar-commit --git-export-dir=../build-area --git-debian-branch=ubuntu-1.9 -S -sa
</code></pre><p>以下のコマンドでバイナリパッケージをビルドします。</p>
<pre><code class="language-console" data-lang="console">sudo pbuilder build ../build-area/golang-1.9_1.9~rc1-1ubuntu1~hnakamur1-xenial.dsc
</code></pre><p><code>/var/cache/pbuilder/result/</code> に生成されたdebファイルを、LXDの新規コンテナにコピー、インストールし、動作確認しました。動作確認と言っても <code>/usr/lib/go-1.9/bin/go version</code> を実行して出力を確認しただけです。</p>
<h3 id="golang-19のppaを作成してソースパッケージをアップロード">golang-1.9のPPAを作成してソースパッケージをアップロード</h3>
<p><a href="https://launchpad.net/">Launchpad</a> にログインして自分のページに移動して <code>golang-1.9</code> というPPAを作成しました。</p>
<p>すると Uploading packages to this PPA というところに
<code>dput ppa:hnakamur/golang-1.9 &lt;source.changes&gt;</code>
と書かれていますので、以下のコマンドを実行してソースパッケージをアップロードしました。</p>
<pre><code class="language-console" data-lang="console">dput ppa:hnakamur/golang-1.9 ../build-area/golang-1.9_1.9~rc1-1ubuntu1~hnakamur1-xenial_source.changes
</code></pre><p>しばらく待ってビルド結果を見ると amd64 は通ったのですが i386 はビルドエラーになっていました。
自分で使うのは amd64 だけなので
<a href="https://hnakamur.github.io/blog/2017/07/18/created-nginx-custom-deb-package/">nginx+luaのカスタムdebパッケージを作ってみた</a>
の「PPAでビルドするアーキテクチャの変更」の手順で i386 は以降のビルド対象から外しました。</p>
<h3 id="go-18用のgolang-defaultsパッケージgo-19用に改変">go 1.8用のgolang-defaultsパッケージgo 1.9用に改変</h3>
<p>まず、 <code>.dsc</code> ファイルをインポートして自分のレポジトリを作ります。</p>
<pre><code class="language-console" data-lang="console">cd ~/.ghq/github.com/hnakamur
gbp import-dsc --pristine-tar ~/longsleep-go-deb/golang-defaults_1.8~1ubuntu2~xenial.dsc
mv golang-defaults golang-defaults-deb
cd !$
</code></pre><p>新しいリリースを <code>gbp dch -R</code> で作ろうとしたらタグが無くてエラーになったので、直接 <code>dch</code> を使うようにしました。</p>
<pre><code class="language-console" data-lang="console">dch -R
</code></pre><p>前のエントリ</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">golang-defaults (2:1.8~1ubuntu2~xenial) xenial; urgency=medium

  * Backport to 16.04.
  * Use Golang 1.8.

 -- Simon Eisenmann &lt;simon@longsleep.org&gt;  Tue, 03 Jan 2017 16:49:41 +0100
</code></pre></div><p>を参考にして、先頭に追加されたエントリを以下のように編集しました。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">golang-defaults (2:1.9~1ubuntu1~hnakamur1) xenial; urgency=medium

  * Use Golang 1.9.

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Sat, 05 Aug 2017 09:38:34 +0900
</code></pre></div><p>バージョンに対応したタグを打ちます。</p>
<pre><code class="language-console" data-lang="console">git tag debian/1.9_1ubuntu1_hnakamur1
</code></pre><p>ソースパッケージをビルドします。</p>
<pre><code class="language-console" data-lang="console">gbp buildpackage --git-export-dir=../build-area -S -sa
</code></pre><p>バイナリパッケージをビルドします。</p>
<pre><code class="language-console" data-lang="console">sudo pbuilder build ../build-area/golang-defaults_1.9~1ubuntu1~hnakamur1.dsc
</code></pre><p>生成されたバイナリパッケージの中身を確認します。</p>
<pre><code class="language-console" data-lang="console">$ dpkg -c /var/cache/pbuilder/result/golang-go_1.9~1ubuntu1~hnakamur1_amd64.deb
drwxr-xr-x root/root         0 2017-08-05 09:43 ./
drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/
drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/lib/
drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/share/
drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/share/doc/
drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/share/doc/golang-go/
-rw-r--r-- root/root       870 2017-08-05 09:39 ./usr/share/doc/golang-go/changelog.gz
-rw-r--r-- root/root      2890 2017-08-05 09:39 ./usr/share/doc/golang-go/copyright
drwxr-xr-x root/root         0 2017-08-05 09:43 ./usr/bin/
lrwxrwxrwx root/root         0 2017-08-05 09:43 ./usr/lib/go -&gt; go-1.9
lrwxrwxrwx root/root         0 2017-08-05 09:43 ./usr/bin/gofmt -&gt; ../lib/go-1.9/bin/gofmt
lrwxrwxrwx root/root         0 2017-08-05 09:43 ./usr/bin/go -&gt; ../lib/go-1.9/bin/go
</code></pre><p>LXDコンテナにパッケージをコピーして動作確認した後、
PPAにソースパッケージをアップロードしてビルドしました。</p>
<pre><code class="language-console" data-lang="console">dput ppa:hnakamur/golang-1.9 ../build-area/golang-defaults_1.9~1ubuntu1~hnakamur1_source.changes
</code></pre><h2 id="おわりに">おわりに</h2>
<p>使い方は先頭の「今回ビルドしたdebのインストール手順」の項に書いた通りです。
今後、go 1.9.xの新しいリリース候補や正式版が出たら、debパッケージもすぐ更新するつもりです。</p>
<p>一方で dh-make-golang パッケージなどは Simon さんのパッケージに依存していますので、
正式版が出たら Simon さんにも更新をお願いしようと思います。
以前 1.8.3 を Simon さんにメールでお願いしたら数日で作ってくれました。</p>
<p>さらに、goで書かれたコマンドやサーバのうち自分で使うものはdebパッケージを作っていきたいと
考えています。というより、それがしたいからgoのパッケージを作ったわけなので。</p>

</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
