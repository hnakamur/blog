<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>monitのif failed urlのコードリーディング</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/02/20/monit-if-failed-url-code-reading/" rel="bookmark"
           title="Permalink to monitのif failed urlのコードリーディング">monitのif failed urlのコードリーディング</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-02-20T11:14:00+09:00">
                Published: 2017-02-20
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/monit.html">monit</a> <a href="../../../../tag/code-reading.html">code-reading</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>以下のページで紹介されているような <tt class="docutils literal">if failed url ...</tt> の挙動をコードリーディングしてみたメモです。</p>
<ul class="simple">
<li><a class="reference external" href="https://fak3r.com/2010/04/10/howto-use-monit-to-monitor-sites-and-alert-users/">HOWTO use monit to monitor sites and alert users · fak3r</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/akishin999/20121030/1351555542">Monit でお手軽に外部のサーバを監視する - akishin999の日記</a></li>
</ul>
<div class="highlight"><pre><span></span><span class="go">check host fak3r.com with address fak3r.com</span>
<span class="go">if failed url http://fak3r.com</span>
<span class="go">timeout 10 seconds for 1 cycles then alert</span>
<span class="go">then alert</span>
</pre></div>
<p>コードリーディングの対象のmonitのバージョンは5.11.0です。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/?at=release-5-11-0">monit 5.11.0のソースコード</a></p>
</div>
<div class="section" id="if-failed-url">
<h2>if failed urlの設定ファイルの文法</h2>
<p><a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-1009:1029">src/p.y#L1009-L1029</a></p>
<p><tt class="docutils literal">connection</tt> の文法定義。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029</pre></div></td><td class="code"><div class="highlight"><pre><span></span>connection      : IF FAILED host port type protocol urloption nettimeout retry rate1
                  THEN action1 recovery {
                    portset.timeout = $&lt;number&gt;8;
                    portset.retry = $&lt;number&gt;9;
                    /* This is a workaround to support content match without having to create
                     an URL object. &#39;urloption&#39; creates the Request_T object we need minus the
                     URL object, but with enough information to perform content test.
                     TODO: Parser is in need of refactoring */
                    portset.url_request = urlrequest;
                    addeventaction(&amp;(portset).action, $&lt;number&gt;12, $&lt;number&gt;13);
                    addport(&amp;portset);
                  }
                | IF FAILED URL URLOBJECT urloption nettimeout retry rate1
                  THEN action1 recovery {
                    prepare_urlrequest($&lt;url&gt;4);
                    portset.timeout = $&lt;number&gt;6;
                    portset.retry = $&lt;number&gt;7;
                    addeventaction(&amp;(portset).action, $&lt;number&gt;10, $&lt;number&gt;11);
                    addport(&amp;portset);
                  }
                ;
</pre></div>
</td></tr></table><p><tt class="docutils literal">nettimeout</tt> の文法定義。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-1421:1427">src/p.y#L1421-L1427</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1421
1422
1423
1424
1425
1426
1427</pre></div></td><td class="code"><div class="highlight"><pre><span></span>nettimeout      : /* EMPTY */ {
                   $&lt;number&gt;$ = NET_TIMEOUT; // timeout is in milliseconds
                  }
                | TIMEOUT NUMBER SECOND {
                   $&lt;number&gt;$ = $2 * 1000; // net timeout is in milliseconds internally
                  }
                ;
</pre></div>
</td></tr></table><p><tt class="docutils literal">NET_TIMEOUT</tt> の定義。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/net.h?at=release-5-11-0&amp;fileviewer=file-view-default#net.h-40:44">src/net.h#L40-L44</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>40
41
42
43
44</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Standard milliseconds to wait for a socket connection or for socket read</span>
<span class="cm"> * i/o before aborting</span>
<span class="cm"> */</span>
<span class="cp">#define NET_TIMEOUT 5000</span>
</pre></div>
</td></tr></table><p>ということで <tt class="docutils literal">if failed url ...</tt> のデフォルトのタイムアウトは 5秒。</p>
<p><tt class="docutils literal">retry</tt> の文法定義。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-1429:1435">src/p.y#L1429-L1435</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1429
1430
1431
1432
1433
1434
1435</pre></div></td><td class="code"><div class="highlight"><pre><span></span>retry           : /* EMPTY */ {
                   $&lt;number&gt;$ = 1;
                  }
                | RETRY NUMBER {
                   $&lt;number&gt;$ = $2;
                  }
                ;
</pre></div>
</td></tr></table><p>デフォルトのリトライ回数は1。</p>
<p><tt class="docutils literal">rate1</tt> の文法定義。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-1765:1780">src/p.y#L1765-L1780</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1765
1766
1767
1768
1769
1770
1771
1772
1773
1774
1775
1776
1777
1778
1779
1780</pre></div></td><td class="code"><div class="highlight"><pre><span></span>rate1           : /* EMPTY */
                | NUMBER CYCLE {
                    rate1.count  = $&lt;number&gt;1;
                    rate1.cycles = $&lt;number&gt;1;
                    if (rate1.cycles &lt; 1 || rate1.cycles &gt; BITMAP_MAX)
                      yyerror2(&quot;The number of cycles must be between 1 and %d&quot;, BITMAP_MAX);
                  }
                | NUMBER NUMBER CYCLE {
                    rate1.count  = $&lt;number&gt;1;
                    rate1.cycles = $&lt;number&gt;2;
                    if (rate1.cycles &lt; 1 || rate1.cycles &gt; BITMAP_MAX)
                      yyerror2(&quot;The number of cycles must be between 1 and %d&quot;, BITMAP_MAX);
                    if (rate1.count &lt; 1 || rate1.count &gt; rate1.cycles)
                      yyerror2(&quot;The number of events must be bigger then 0 and less than poll cycles&quot;);
                  }
                ;
</pre></div>
</td></tr></table><p><tt class="docutils literal">rate1</tt> の変数定義
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-186">src/p.y#L186</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>186</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="n">myrate</span> <span class="n">rate1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">myrate</tt> 構造体の定義。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-132:135">src/p.y#L132-L135</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>132
133
134
135</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="k">struct</span> <span class="n">myrate</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">count</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">cycles</span><span class="p">;</span>
  <span class="p">};</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">addeventaction</tt> 関数の実装。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-3116:3147">src/p.y#L3116-L3147</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>3116
3117
3118
3119
3120
3121
3122
3123
3124
3125
3126
3127
3128
3129
3130
3131
3132
3133
3134
3135
3136
3137
3138
3139
3140
3141
3142
3143
3144
3145
3146
3147</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Set EventAction object</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">addeventaction</span><span class="p">(</span><span class="n">EventAction_T</span> <span class="o">*</span><span class="n">_ea</span><span class="p">,</span> <span class="kt">int</span> <span class="n">failed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">EventAction_T</span> <span class="n">ea</span><span class="p">;</span>

  <span class="n">ASSERT</span><span class="p">(</span><span class="n">_ea</span><span class="p">);</span>

  <span class="n">NEW</span><span class="p">(</span><span class="n">ea</span><span class="p">);</span>
  <span class="n">NEW</span><span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">failed</span><span class="p">);</span>
  <span class="n">NEW</span><span class="p">(</span><span class="n">ea</span><span class="o">-&gt;</span><span class="n">succeeded</span><span class="p">);</span>

  <span class="n">ea</span><span class="o">-&gt;</span><span class="n">failed</span><span class="o">-&gt;</span><span class="n">id</span>     <span class="o">=</span> <span class="n">failed</span><span class="p">;</span>
  <span class="n">ea</span><span class="o">-&gt;</span><span class="n">failed</span><span class="o">-&gt;</span><span class="n">count</span>  <span class="o">=</span> <span class="n">rate1</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
  <span class="n">ea</span><span class="o">-&gt;</span><span class="n">failed</span><span class="o">-&gt;</span><span class="n">cycles</span> <span class="o">=</span> <span class="n">rate1</span><span class="p">.</span><span class="n">cycles</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">failed</span> <span class="o">==</span> <span class="n">ACTION_EXEC</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">command1</span><span class="p">);</span>
    <span class="n">ea</span><span class="o">-&gt;</span><span class="n">failed</span><span class="o">-&gt;</span><span class="n">exec</span> <span class="o">=</span> <span class="n">command1</span><span class="p">;</span>
    <span class="n">command1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">ea</span><span class="o">-&gt;</span><span class="n">succeeded</span><span class="o">-&gt;</span><span class="n">id</span>     <span class="o">=</span> <span class="n">succeeded</span><span class="p">;</span>
  <span class="n">ea</span><span class="o">-&gt;</span><span class="n">succeeded</span><span class="o">-&gt;</span><span class="n">count</span>  <span class="o">=</span> <span class="n">rate2</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
  <span class="n">ea</span><span class="o">-&gt;</span><span class="n">succeeded</span><span class="o">-&gt;</span><span class="n">cycles</span> <span class="o">=</span> <span class="n">rate2</span><span class="p">.</span><span class="n">cycles</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span> <span class="o">==</span> <span class="n">ACTION_EXEC</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">command2</span><span class="p">);</span>
    <span class="n">ea</span><span class="o">-&gt;</span><span class="n">succeeded</span><span class="o">-&gt;</span><span class="n">exec</span> <span class="o">=</span> <span class="n">command2</span><span class="p">;</span>
    <span class="n">command2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">*</span><span class="n">_ea</span> <span class="o">=</span> <span class="n">ea</span><span class="p">;</span>
  <span class="n">reset_rateset</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">addport</tt> 関数の実装。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-2543:2602">src/p.y#L2543-L2602</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>2543
2544
2545
2546
2547
2548
2549
2550
2551
2552
2553
2554
2555
2556
2557
2558
2559
2560
2561
2562
2563
2564
2565
2566
2567
2568
2569
2570
2571
2572
2573
2574
2575
2576
2577
2578
2579
2580
2581
2582
2583
2584
2585
2586
2587
2588
2589
2590
2591
2592
2593
2594
2595
2596
2597
2598
2599
2600
2601
2602</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * Add the given portset to the current service&#39;s portlist</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">addport</span><span class="p">(</span><span class="n">Port_T</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Port_T</span> <span class="n">p</span><span class="p">;</span>

  <span class="n">ASSERT</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

  <span class="n">NEW</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">port</span>               <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">type</span>               <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">socket</span>             <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">family</span>             <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">action</span>             <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">timeout</span>            <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">retry</span>              <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">request</span>            <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">generic</span>            <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">generic</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol</span>           <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">pathname</span>           <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">pathname</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">hostname</span>           <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hostname</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">url_request</span>        <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">url_request</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">request_checksum</span>   <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">request_checksum</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">request_hostheader</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">request_hostheader</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">http_headers</span>       <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">http_headers</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">version</span>            <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">operator</span>           <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">operator</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">status</span>             <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ApacheStatus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ApacheStatus</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">apache_status</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">request_checksum</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cleanup_hash_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">request_checksum</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">request_checksum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">request_hashtype</span> <span class="o">=</span> <span class="n">HASH_MD5</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">request_checksum</span><span class="p">)</span> <span class="o">==</span> <span class="mi">40</span><span class="p">)</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">request_hashtype</span> <span class="o">=</span> <span class="n">HASH_SHA1</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">yyerror2</span><span class="p">(</span><span class="s">&quot;invalid checksum [%s]&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">request_checksum</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">request_hashtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">use_ssl</span> <span class="o">==</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_ssl</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">yyerror</span><span class="p">(</span><span class="s">&quot;ssl check cannot be activated. SSL is not supported&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">certmd5</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">certmd5</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">certmd5</span><span class="p">;</span>
        <span class="n">cleanup_hash_string</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">certmd5</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">maxforward</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">maxforward</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">portlist</span><span class="p">;</span>
  <span class="n">current</span><span class="o">-&gt;</span><span class="n">portlist</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

  <span class="n">reset_portset</span><span class="p">();</span>

<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">Port_T</tt> の型定義。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/monit.h?at=release-5-11-0&amp;fileviewer=file-view-default#monit.h-457:510">src/monit.h#L457-L510</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/** Defines a port object */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">myport</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">;</span>                                     <span class="cm">/**&lt; Hostname to check */</span>
        <span class="n">List_T</span> <span class="n">http_headers</span><span class="p">;</span> <span class="cm">/**&lt; Optional list of HTTP headers to send with request */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>                              <span class="cm">/**&lt; Specific protocol request */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">request_checksum</span><span class="p">;</span>     <span class="cm">/**&lt; The optional checksum for a req. document */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">request_hostheader</span><span class="p">;</span>            <span class="cm">/**&lt; The optional Host: header to use. Deprecated */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">;</span>                   <span class="cm">/**&lt; Pathname, in case of an UNIX socket */</span>
        <span class="n">Generic_T</span> <span class="n">generic</span><span class="p">;</span>                                <span class="cm">/**&lt; Generic test handle */</span>
        <span class="k">volatile</span> <span class="kt">int</span> <span class="n">socket</span><span class="p">;</span>                       <span class="cm">/**&lt; Socket used for connection */</span>
        <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>                   <span class="cm">/**&lt; Socket type used for connection (UDP/TCP) */</span>
        <span class="kt">int</span> <span class="n">family</span><span class="p">;</span>             <span class="cm">/**&lt; Socket family used for connection (INET/UNIX) */</span>
        <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>                                                  <span class="cm">/**&lt; Portnumber */</span>
        <span class="kt">int</span> <span class="n">request_hashtype</span><span class="p">;</span>   <span class="cm">/**&lt; The optional type of hash for a req. document */</span>
        <span class="kt">int</span> <span class="n">maxforward</span><span class="p">;</span>            <span class="cm">/**&lt; Optional max forward for protocol checking */</span>
        <span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span> <span class="cm">/**&lt; The timeout in millseconds to wait for connect or read i/o */</span>
        <span class="kt">int</span> <span class="n">retry</span><span class="p">;</span>       <span class="cm">/**&lt; Number of connection retry before reporting an error */</span>
        <span class="kt">int</span> <span class="n">is_available</span><span class="p">;</span>                <span class="cm">/**&lt; TRUE if the server/port is available */</span>
        <span class="kt">int</span> <span class="n">version</span><span class="p">;</span>                                         <span class="cm">/**&lt; Protocol version */</span>
        <span class="n">Operator_Type</span> <span class="n">operator</span><span class="p">;</span>                           <span class="cm">/**&lt; Comparison operator */</span>
        <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>                                           <span class="cm">/**&lt; Protocol status */</span>
        <span class="kt">double</span> <span class="n">response</span><span class="p">;</span>                      <span class="cm">/**&lt; Socket connection response time */</span>
        <span class="n">EventAction_T</span> <span class="n">action</span><span class="p">;</span>  <span class="cm">/**&lt; Description of the action upon event occurence */</span>
        <span class="cm">/** Apache-status specific parameters */</span>
        <span class="k">struct</span> <span class="n">apache_status</span> <span class="p">{</span>
                <span class="kt">short</span> <span class="n">loglimit</span><span class="p">;</span>                  <span class="cm">/**&lt; Max percentage of logging processes */</span>
                <span class="kt">short</span> <span class="n">loglimitOP</span><span class="p">;</span>                                  <span class="cm">/**&lt; loglimit operator */</span>
                <span class="kt">short</span> <span class="n">closelimit</span><span class="p">;</span>             <span class="cm">/**&lt; Max percentage of closinging processes */</span>
                <span class="kt">short</span> <span class="n">closelimitOP</span><span class="p">;</span>                              <span class="cm">/**&lt; closelimit operator */</span>
                <span class="kt">short</span> <span class="n">dnslimit</span><span class="p">;</span>         <span class="cm">/**&lt; Max percentage of processes doing DNS lookup */</span>
                <span class="kt">short</span> <span class="n">dnslimitOP</span><span class="p">;</span>                                  <span class="cm">/**&lt; dnslimit operator */</span>
                <span class="kt">short</span> <span class="n">keepalivelimit</span><span class="p">;</span>          <span class="cm">/**&lt; Max percentage of keepalive processes */</span>
                <span class="kt">short</span> <span class="n">keepalivelimitOP</span><span class="p">;</span>                      <span class="cm">/**&lt; keepalivelimit operator */</span>
                <span class="kt">short</span> <span class="n">replylimit</span><span class="p">;</span>               <span class="cm">/**&lt; Max percentage of replying processes */</span>
                <span class="kt">short</span> <span class="n">replylimitOP</span><span class="p">;</span>                              <span class="cm">/**&lt; replylimit operator */</span>
                <span class="kt">short</span> <span class="n">requestlimit</span><span class="p">;</span>     <span class="cm">/**&lt; Max percentage of processes reading requests */</span>
                <span class="kt">short</span> <span class="n">requestlimitOP</span><span class="p">;</span>                          <span class="cm">/**&lt; requestlimit operator */</span>
                <span class="kt">short</span> <span class="n">startlimit</span><span class="p">;</span>            <span class="cm">/**&lt; Max percentage of processes starting up */</span>
                <span class="kt">short</span> <span class="n">startlimitOP</span><span class="p">;</span>                              <span class="cm">/**&lt; startlimit operator */</span>
                <span class="kt">short</span> <span class="n">waitlimit</span><span class="p">;</span>  <span class="cm">/**&lt; Min percentage of processes waiting for connection */</span>
                <span class="kt">short</span> <span class="n">waitlimitOP</span><span class="p">;</span>                                <span class="cm">/**&lt; waitlimit operator */</span>
                <span class="kt">short</span> <span class="n">gracefullimit</span><span class="p">;</span><span class="cm">/**&lt; Max percentage of processes gracefully finishing */</span>
                <span class="kt">short</span> <span class="n">gracefullimitOP</span><span class="p">;</span>                        <span class="cm">/**&lt; gracefullimit operator */</span>
                <span class="kt">short</span> <span class="n">cleanuplimit</span><span class="p">;</span>      <span class="cm">/**&lt; Max percentage of processes in idle cleanup */</span>
                <span class="kt">short</span> <span class="n">cleanuplimitOP</span><span class="p">;</span>                          <span class="cm">/**&lt; cleanuplimit operator */</span>
        <span class="p">}</span> <span class="n">ApacheStatus</span><span class="p">;</span>

        <span class="n">Ssl_T</span> <span class="n">SSL</span><span class="p">;</span>                                             <span class="cm">/**&lt; SSL definition */</span>
        <span class="n">Protocol_T</span> <span class="n">protocol</span><span class="p">;</span>     <span class="cm">/**&lt; Protocol object for testing a port&#39;s service */</span>
        <span class="n">Request_T</span> <span class="n">url_request</span><span class="p">;</span>             <span class="cm">/**&lt; Optional url client request object */</span>

        <span class="cm">/** For internal use */</span>
        <span class="k">struct</span> <span class="n">myport</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>                               <span class="cm">/**&lt; next port in chain */</span>
<span class="p">}</span> <span class="o">*</span><span class="n">Port_T</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="check-process">
<h2>check_process 関数の実装</h2>
<p><tt class="docutils literal">check_process</tt> 関数の実装。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/validate.c?at=release-5-11-0&amp;fileviewer=file-view-default#validate.c-989:1037">src/validate.c#L989-L1037</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 989
 990
 991
 992
 993
 994
 995
 996
 997
 998
 999
1000
1001
1002
1003
1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024
1025
1026
1027
1028
1029
1030
1031
1032
1033
1034
1035
1036
1037</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Validate a given process service s. Events are posted according to</span>
<span class="cm"> * its configuration. In case of a fatal event FALSE is returned.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">check_process</span><span class="p">(</span><span class="n">Service_T</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">pid_t</span>  <span class="n">pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">Port_T</span> <span class="n">pp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">Resource_T</span> <span class="n">pr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">ASSERT</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
        <span class="cm">/* Test for running process */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="n">Util_isProcessRunning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Nonexist</span><span class="p">,</span> <span class="n">STATE_FAILED</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">action_NONEXIST</span><span class="p">,</span> <span class="s">&quot;process is not running&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Nonexist</span><span class="p">,</span> <span class="n">STATE_SUCCEEDED</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">action_NONEXIST</span><span class="p">,</span> <span class="s">&quot;process is running with pid %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pid</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/* Reset the exec and timeout errors if active ... the process is running (most probably after manual intervention) */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_EVENT_SET</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">,</span> <span class="n">Event_Exec</span><span class="p">))</span>
                <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Exec</span><span class="p">,</span> <span class="n">STATE_SUCCEEDED</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">action_EXEC</span><span class="p">,</span> <span class="s">&quot;process is running after previous exec error (slow starting or manually recovered?)&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_EVENT_SET</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">,</span> <span class="n">Event_Timeout</span><span class="p">))</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">ActionRate_T</span> <span class="n">ar</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">actionratelist</span><span class="p">;</span> <span class="n">ar</span><span class="p">;</span> <span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
                        <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Timeout</span><span class="p">,</span> <span class="n">STATE_SUCCEEDED</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">,</span> <span class="s">&quot;process is running after previous restart timeout (manually recovered?)&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Run</span><span class="p">.</span><span class="n">doprocess</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">update_process_data</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ptree</span><span class="p">,</span> <span class="n">ptreesize</span><span class="p">,</span> <span class="n">pid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">check_process_state</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                        <span class="n">check_process_pid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                        <span class="n">check_process_ppid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">)</span>
                                <span class="n">check_uid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">euid</span><span class="p">)</span>
                                <span class="n">check_euid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">gid</span><span class="p">)</span>
                                <span class="n">check_gid</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">uptimelist</span><span class="p">)</span>
                                <span class="n">check_uptime</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">pr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">resourcelist</span><span class="p">;</span> <span class="n">pr</span><span class="p">;</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
                                <span class="n">check_process_resources</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pr</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span>
                        <span class="n">LogError</span><span class="p">(</span><span class="s">&quot;&#39;%s&#39; failed to get service data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/* Test each host:port and protocol in the service&#39;s portlist */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">portlist</span><span class="p">)</span>
                <span class="cm">/* skip further tests during startup timeout */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">process</span><span class="p">.</span><span class="n">uptime</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">start</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">pp</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">portlist</span><span class="p">;</span> <span class="n">pp</span><span class="p">;</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
                        <span class="n">check_connection</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pp</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">check_connection</tt> 関数の実装。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/validate.c?at=release-5-11-0&amp;fileviewer=file-view-default#validate.c-138:206">src/validate.c#L138-L206</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Test the connection and protocol</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_connection</span><span class="p">(</span><span class="n">Service_T</span> <span class="n">s</span><span class="p">,</span> <span class="n">Port_T</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Socket_T</span> <span class="n">socket</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">STRLEN</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">report</span><span class="p">[</span><span class="n">STRLEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">struct</span> <span class="n">timeval</span> <span class="n">t1</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">timeval</span> <span class="n">t2</span><span class="p">;</span>

        <span class="n">ASSERT</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="p">);</span>
<span class="nl">retry</span><span class="p">:</span>
        <span class="cm">/* Get time of connection attempt beginning */</span>
        <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

        <span class="cm">/* Open a socket to the destination INET[hostname:port] or UNIX[pathname] */</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="n">socket_create</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">STRLEN</span><span class="p">,</span> <span class="s">&quot;failed, cannot open a connection to %s&quot;</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;&#39;%s&#39; succeeded connecting to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">-&gt;</span><span class="n">check</span> <span class="o">==</span> <span class="n">check_default</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">socket_is_udp</span><span class="p">(</span><span class="n">socket</span><span class="p">))</span> <span class="p">{</span>
                        <span class="c1">// Only test &quot;connected&quot; UDP sockets without protocol, TCP connect is verified on create</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">socket_is_ready</span><span class="p">(</span><span class="n">socket</span><span class="p">))</span> <span class="p">{</span>
                                <span class="n">snprintf</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">STRLEN</span><span class="p">,</span> <span class="s">&quot;connection failed, %s is not ready for i|o -- %s&quot;</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)),</span> <span class="n">STRERROR</span><span class="p">);</span>
                                <span class="n">rv</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                                <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="cm">/* Run the protocol verification routine through the socket */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">-&gt;</span><span class="n">check</span><span class="p">(</span><span class="n">socket</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">STRLEN</span><span class="p">,</span> <span class="s">&quot;failed protocol test [%s] at %s -- %s&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)),</span> <span class="n">socket_getError</span><span class="p">(</span><span class="n">socket</span><span class="p">));</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;&#39;%s&#39; succeeded testing protocol [%s] at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>
        <span class="p">}</span>

        <span class="cm">/* Get time of connection attempt finish */</span>
        <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

        <span class="cm">/* Get the response time */</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">t2</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">t1</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kt">double</span><span class="p">)(</span><span class="n">t2</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">t1</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>

<span class="nl">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">)</span>
                <span class="n">socket_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&quot;&#39;%s&#39; %s (attempt %d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">-</span> <span class="n">retry_count</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">);</span>
                        <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">is_available</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Connection</span><span class="p">,</span> <span class="n">STATE_FAILED</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">report</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">p</span><span class="o">-&gt;</span><span class="n">is_available</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Connection</span><span class="p">,</span> <span class="n">STATE_SUCCEEDED</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">,</span> <span class="s">&quot;connection succeeded to %s&quot;</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)));</span>
        <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table><p>上記の200行と203行で呼んでいる <tt class="docutils literal">Event_post</tt> 関数やイベントループの処理も気になりますが、この記事が長くなりすぎるので別記事にします。</p>
<p><tt class="docutils literal">Protocol_T</tt> の型定義。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/monit.h?at=release-5-11-0&amp;fileviewer=file-view-default#monit.h-438:442">src/monit.h#L438-L442</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>438
439
440
441
442</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/** Defines a protocol object with protocol functions */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">Protocol_T</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>                                       <span class="cm">/**&lt; Protocol name */</span>
        <span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">check</span><span class="p">)(</span><span class="n">Socket_T</span><span class="p">);</span>                 <span class="cm">/**&lt; Protocol verification function */</span>
<span class="p">}</span> <span class="o">*</span><span class="n">Protocol_T</span><span class="p">;</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">Protocol_T</tt> 型の配列の値定義。monitで扱うプロトコル一覧。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/protocols/protocol.c?at=release-5-11-0&amp;fileviewer=file-view-default#protocol.c-41:83">src/protocols/protocol.c#L41-L83</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">Protocol_T</span> <span class="n">protocols</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;DEFAULT&quot;</span><span class="p">,</span>         <span class="n">check_default</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;HTTP&quot;</span><span class="p">,</span>            <span class="n">check_http</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;FTP&quot;</span><span class="p">,</span>             <span class="n">check_ftp</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;SMTP&quot;</span><span class="p">,</span>            <span class="n">check_smtp</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;POP&quot;</span><span class="p">,</span>             <span class="n">check_pop</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;IMAP&quot;</span><span class="p">,</span>            <span class="n">check_imap</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;NNTP&quot;</span><span class="p">,</span>            <span class="n">check_nntp</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;SSH&quot;</span><span class="p">,</span>             <span class="n">check_ssh</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;DWP&quot;</span><span class="p">,</span>             <span class="n">check_dwp</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;LDAP2&quot;</span><span class="p">,</span>           <span class="n">check_ldap2</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;LDAP3&quot;</span><span class="p">,</span>           <span class="n">check_ldap3</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;RDATE&quot;</span><span class="p">,</span>           <span class="n">check_rdate</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;RSYNC&quot;</span><span class="p">,</span>           <span class="n">check_rsync</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;generic&quot;</span><span class="p">,</span>         <span class="n">check_generic</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;APACHESTATUS&quot;</span><span class="p">,</span>    <span class="n">check_apache_status</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;NTP3&quot;</span><span class="p">,</span>            <span class="n">check_ntp3</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;MYSQL&quot;</span><span class="p">,</span>           <span class="n">check_mysql</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;DNS&quot;</span><span class="p">,</span>             <span class="n">check_dns</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;POSTFIX-POLICY&quot;</span><span class="p">,</span>  <span class="n">check_postfix_policy</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;TNS&quot;</span><span class="p">,</span>             <span class="n">check_tns</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;PGSQL&quot;</span><span class="p">,</span>           <span class="n">check_pgsql</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;CLAMAV&quot;</span><span class="p">,</span>          <span class="n">check_clamav</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;SIP&quot;</span><span class="p">,</span>             <span class="n">check_sip</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;LMTP&quot;</span><span class="p">,</span>            <span class="n">check_lmtp</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;GPS&quot;</span><span class="p">,</span>             <span class="n">check_gps</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;RADIUS&quot;</span><span class="p">,</span>          <span class="n">check_radius</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;MEMCACHE&quot;</span><span class="p">,</span>        <span class="n">check_memcache</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;WEBSOCKET&quot;</span><span class="p">,</span>       <span class="n">check_websocket</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;REDIS&quot;</span><span class="p">,</span>           <span class="n">check_redis</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;MONGODB&quot;</span><span class="p">,</span>         <span class="n">check_mongodb</span><span class="p">},</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">){</span><span class="s">&quot;SIEVE&quot;</span><span class="p">,</span>           <span class="n">check_sieve</span><span class="p">}</span>
<span class="p">};</span>


<span class="cm">/* ------------------------------------------------------------------ Public */</span>


<span class="n">Protocol_T</span> <span class="nf">Protocol_get</span><span class="p">(</span><span class="n">Protocol_Type</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">protocols</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">protocols</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">return</span> <span class="n">protocols</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">return</span> <span class="n">protocols</span><span class="p">[</span><span class="n">type</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="check-http">
<h2>check_http 関数の実装</h2>
<p><tt class="docutils literal">check_http</tt> 関数の実装。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/protocols/http.c?at=release-5-11-0&amp;fileviewer=file-view-default#http.c-276:321">src/protocols/http.c#L276-L321</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">check_http</span><span class="p">(</span><span class="n">Socket_T</span> <span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Port_T</span> <span class="n">P</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">host</span><span class="p">[</span><span class="n">STRLEN</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">auth</span><span class="p">[</span><span class="n">STRLEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostheader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="n">ASSERT</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">socket_get_Port</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>

        <span class="n">ASSERT</span><span class="p">(</span><span class="n">P</span><span class="p">);</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">?</span> <span class="n">P</span><span class="o">-&gt;</span><span class="nl">request</span> <span class="p">:</span> <span class="s">&quot;/&quot;</span><span class="p">;</span>

        <span class="n">hostheader</span> <span class="o">=</span> <span class="n">_findHostHeaderIn</span><span class="p">(</span><span class="n">P</span><span class="o">-&gt;</span><span class="n">http_headers</span><span class="p">);</span>
        <span class="n">hostheader</span> <span class="o">=</span> <span class="n">hostheader</span> <span class="o">?</span> <span class="nl">hostheader</span> <span class="p">:</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">request_hostheader</span>
                                <span class="o">?</span> <span class="n">P</span><span class="o">-&gt;</span><span class="nl">request_hostheader</span> <span class="p">:</span> <span class="n">Util_getHTTPHostHeader</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">STRLEN</span><span class="p">);</span> <span class="c1">// Otherwise use deprecated request_hostheader or default host</span>
        <span class="n">StringBuffer_T</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">StringBuffer_create</span><span class="p">(</span><span class="mi">168</span><span class="p">);</span>
        <span class="n">StringBuffer_append</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
                            <span class="s">&quot;GET %s HTTP/1.1</span><span class="se">\r\n</span><span class="s">&quot;</span>
                            <span class="s">&quot;Host: %s</span><span class="se">\r\n</span><span class="s">&quot;</span>
                            <span class="s">&quot;Accept: */*</span><span class="se">\r\n</span><span class="s">&quot;</span>
                            <span class="s">&quot;User-Agent: Monit/%s</span><span class="se">\r\n</span><span class="s">&quot;</span>
                            <span class="s">&quot;%s&quot;</span><span class="p">,</span>
                            <span class="n">request</span><span class="p">,</span> <span class="n">hostheader</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                            <span class="n">get_auth_header</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="n">STRLEN</span><span class="p">));</span>
        <span class="c1">// Add headers if we have them</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">-&gt;</span><span class="n">http_headers</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">list_t</span> <span class="n">p</span> <span class="o">=</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">http_headers</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kt">char</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">Str_startsWith</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="s">&quot;Host&quot;</span><span class="p">))</span> <span class="c1">// Already set contrived above</span>
                                <span class="k">continue</span><span class="p">;</span>
                        <span class="n">StringBuffer_append</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">header</span><span class="p">);</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">StringBuffer_append</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">send_status</span> <span class="o">=</span> <span class="n">socket_write</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">StringBuffer_toString</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">StringBuffer_length</span><span class="p">(</span><span class="n">sb</span><span class="p">));</span>
        <span class="n">StringBuffer_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">send_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;HTTP: error sending data -- %s&quot;</span><span class="p">,</span> <span class="n">STRERROR</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">check_request</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">P</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">Socket_T</tt> の型定義。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/socket.c?at=release-5-11-0&amp;fileviewer=file-view-default#socket.c-85:103">src/socket.c#L85-L103</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#define TYPE_LOCAL   0</span>
<span class="cp">#define TYPE_ACCEPT  1</span>
<span class="c1">// One TCP frame data size</span>
<span class="cp">#define RBUFFER_SIZE 1500</span>

<span class="k">struct</span> <span class="n">Socket_T</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">socket</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
        <span class="n">Port_T</span> <span class="n">Port</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span> <span class="c1">// milliseconds</span>
        <span class="kt">int</span> <span class="n">connection_type</span><span class="p">;</span>
        <span class="n">ssl_connection</span> <span class="o">*</span><span class="n">ssl</span><span class="p">;</span>
        <span class="n">ssl_server_connection</span> <span class="o">*</span><span class="n">sslserver</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">RBUFFER_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">check_request</tt> 関数の実装。
<a class="reference external" href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/protocols/http.c?at=release-5-11-0&amp;fileviewer=file-view-default#http.c-199:242">src/protocols/http.c#L199-L242</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Check that the server returns a valid HTTP response as well as checksum</span>
<span class="cm"> * or content regex if required</span>
<span class="cm"> * @param s A socket</span>
<span class="cm"> * @return TRUE if the response is valid otherwise FALSE</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_request</span><span class="p">(</span><span class="n">Socket_T</span> <span class="n">socket</span><span class="p">,</span> <span class="n">Port_T</span> <span class="n">P</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">content_length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LINE_SIZE</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">socket_readln</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">LINE_SIZE</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;HTTP: Error receiving data -- %s&quot;</span><span class="p">,</span> <span class="n">STRERROR</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Str_chomp</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%*s %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;HTTP error: Cannot parse HTTP status in response: %s&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">Util_evalQExpression</span><span class="p">(</span><span class="n">P</span><span class="o">-&gt;</span><span class="n">operator</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;HTTP error: Server returned status %d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* Get Content-Length header value */</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">socket_readln</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">LINE_SIZE</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="n">Str_chomp</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Str_startsWith</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Content-Length&quot;</span><span class="p">))</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%*s%*[: ]%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">content_length</span><span class="p">))</span> <span class="p">{</span>
                                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;HTTP error: Parsing Content-Length response header &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
                                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">content_length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s">&quot;HTTP error: Illegal Content-Length response header &#39;%s&#39;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
                                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">-&gt;</span><span class="n">url_request</span> <span class="o">&amp;&amp;</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">url_request</span><span class="o">-&gt;</span><span class="n">regex</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">do_regex</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">url_request</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">-&gt;</span><span class="n">request_checksum</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">check_request_checksum</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">request_checksum</span><span class="p">,</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">request_hashtype</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><a class="reference external" href="/blog/2017/02/20/monit-event-loop-code-reading/">monitのイベントループのコードリーディング</a> に続きます。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>