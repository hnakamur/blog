<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.88.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>monitのイベントループのコードリーディング &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>monitのイベントループのコードリーディング</h1>
  <time datetime=2017-02-20T16:46:00&#43;0900 class="post-date">2017-02-20</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#event_post関数の実装">Event_post関数の実装</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="/blog/2017/02/20/monit-if-failed-url-code-reading/">monitのif failed urlのコードリーディング</a> からの続きです。</p>
<h2 id="event_post関数の実装">Event_post関数の実装</h2>
<p><a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/event.c?at=release-5-11-0&amp;fileviewer=file-view-default#event.c-123:222">src/event.c#L123-L222</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/**
</span><span class="cm"> * Post a new Event
</span><span class="cm"> * @param service The Service the event belongs to
</span><span class="cm"> * @param id The event identification
</span><span class="cm"> * @param state The event state
</span><span class="cm"> * @param action Description of the event action
</span><span class="cm"> * @param s Optional message describing the event
</span><span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">Event_post</span><span class="p">(</span><span class="n">Service_T</span> <span class="n">service</span><span class="p">,</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">short</span> <span class="n">state</span><span class="p">,</span> <span class="n">EventAction_T</span> <span class="n">action</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
  <span class="n">ASSERT</span><span class="p">(</span><span class="n">service</span><span class="p">);</span>
  <span class="n">ASSERT</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
  <span class="n">ASSERT</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
  <span class="n">ASSERT</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_FAILED</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">STATE_SUCCEEDED</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">STATE_CHANGED</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">STATE_CHANGEDNOT</span><span class="p">);</span>

  <span class="n">va_list</span> <span class="n">ap</span><span class="p">;</span>
  <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="n">Str_vcat</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
  <span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

  <span class="n">Event_T</span> <span class="n">e</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">eventlist</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Only first failed/changed event can initialize the queue for given event type, thus succeeded events are ignored until first error. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_SUCCEEDED</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">STATE_CHANGEDNOT</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;&#39;%s&#39; %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
      <span class="n">free</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Initialize event list and add first event. The manadatory informations
</span><span class="cm">     * are cloned so the event is as standalone as possible and may be saved
</span><span class="cm">     * to the queue without the dependency on the original service, thus
</span><span class="cm">     * persistent and managable across monit restarts */</span>
    <span class="n">NEW</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collected</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">Str_dup</span><span class="p">(</span><span class="n">service</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_INIT</span><span class="p">;</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">state_map</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
    <span class="n">service</span><span class="o">-&gt;</span><span class="n">eventlist</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="cm">/* Try to find the event with the same origin and type identification. Each service and each test have its own custom actions object, so we share actions object address to identify event source. */</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">action</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collected</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

        <span class="cm">/* Shift the existing event flags to the left and set the first bit based on actual state */</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">state_map</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">state_map</span> <span class="o">|=</span> <span class="p">((</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_SUCCEEDED</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">STATE_CHANGEDNOT</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

        <span class="cm">/* Update the message */</span>
        <span class="n">FREE</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
        <span class="n">e</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">e</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* Only first failed/changed event can initialize the queue for given event type, thus succeeded events are ignored until first error. */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_SUCCEEDED</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">STATE_CHANGEDNOT</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;&#39;%s&#39; %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="p">);</span>
        <span class="n">free</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="cm">/* Event was not found in the pending events list, we will add it.
</span><span class="cm">       * The manadatory informations are cloned so the event is as standalone
</span><span class="cm">       * as possible and may be saved to the queue without the dependency on
</span><span class="cm">       * the original service, thus persistent and managable across monit
</span><span class="cm">       * restarts */</span>
      <span class="n">NEW</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
      <span class="n">e</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
      <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">collected</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="n">e</span><span class="o">-&gt;</span><span class="n">source</span> <span class="o">=</span> <span class="n">Str_dup</span><span class="p">(</span><span class="n">service</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
      <span class="n">e</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
      <span class="n">e</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
      <span class="n">e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">STATE_INIT</span><span class="p">;</span>
      <span class="n">e</span><span class="o">-&gt;</span><span class="n">state_map</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">e</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>
      <span class="n">e</span><span class="o">-&gt;</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="p">;</span>
      <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">service</span><span class="o">-&gt;</span><span class="n">eventlist</span><span class="p">;</span>
      <span class="n">service</span><span class="o">-&gt;</span><span class="n">eventlist</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">e</span><span class="o">-&gt;</span><span class="n">state_changed</span> <span class="o">=</span> <span class="n">Event_check_state</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

  <span class="cm">/* In the case that the state changed, update it and reset the counter */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">state_changed</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span>
    <span class="n">e</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>

  <span class="n">handle_event</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>handle_event</code> 関数の実装。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/event.c?at=release-5-11-0&amp;fileviewer=file-view-default#event.c-605:655">src/event.c#L605-L655</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * Handle the event
</span><span class="cm"> * @param E An event
</span><span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_event</span><span class="p">(</span><span class="n">Service_T</span> <span class="n">S</span><span class="p">,</span> <span class="n">Event_T</span> <span class="n">E</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ASSERT</span><span class="p">(</span><span class="n">E</span><span class="p">);</span>
  <span class="n">ASSERT</span><span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
  <span class="n">ASSERT</span><span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">failed</span><span class="p">);</span>
  <span class="n">ASSERT</span><span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">succeeded</span><span class="p">);</span>

  <span class="cm">/* We will handle only first succeeded event, recurrent succeeded events
</span><span class="cm">   * or insufficient succeeded events during failed service state are
</span><span class="cm">   * ignored. Failed events are handled each time. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">state_changed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_SUCCEEDED</span> <span class="o">||</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_CHANGEDNOT</span> <span class="o">||</span> <span class="p">((</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">state_map</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x1</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">DEBUG</span><span class="p">(</span><span class="s">&#34;&#39;%s&#39; %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">S</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* In the case that the service state is initializing yet and error
</span><span class="cm">     * occured, log it and exit. Succeeded events in init state are not
</span><span class="cm">     * logged. Instance and action events are logged always with priority
</span><span class="cm">     * info. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">STATE_INIT</span> <span class="o">||</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">state_map</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_SUCCEEDED</span> <span class="o">||</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_CHANGEDNOT</span> <span class="o">||</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">Event_Instance</span> <span class="o">||</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">Event_Action</span><span class="p">)</span>
        <span class="n">LogInfo</span><span class="p">(</span><span class="s">&#34;&#39;%s&#39; %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">S</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">LogError</span><span class="p">(</span><span class="s">&#34;&#39;%s&#39; %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">S</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_INIT</span><span class="p">)</span>
      <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_FAILED</span> <span class="o">||</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_CHANGED</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">Event_Instance</span> <span class="o">&amp;&amp;</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">Event_Action</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// We are not interested in setting error flag for instance and action events
</span><span class="c1"></span>      <span class="n">S</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">|=</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
      <span class="cm">/* The error hint provides second dimension for error bitmap and differentiates between failed/changed event states (failed=0, chaged=1) */</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_CHANGED</span><span class="p">)</span>
        <span class="n">S</span><span class="o">-&gt;</span><span class="n">error_hint</span> <span class="o">|=</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">S</span><span class="o">-&gt;</span><span class="n">error_hint</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">handle_action</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">failed</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">S</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">E</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
    <span class="n">handle_action</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="n">E</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">-&gt;</span><span class="n">succeeded</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* Possible event state change was handled so we will reset the flag. */</span>
  <span class="n">E</span><span class="o">-&gt;</span><span class="n">state_changed</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
