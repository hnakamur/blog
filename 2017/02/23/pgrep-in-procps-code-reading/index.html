<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>procpsのpgrepのコードリーディング</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/02/23/pgrep-in-procps-code-reading/" rel="bookmark"
           title="Permalink to procpsのpgrepのコードリーディング">procpsのpgrepのコードリーディング</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-02-23T18:30:00+09:00">
                Published: 2017-02-23
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/pgrep.html">pgrep</a> <a href="../../../../tag/procps.html">procps</a> <a href="../../../../tag/code-reading.html">code-reading</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="blog/2017/02/23/pgrep-in-procps-ng-code-reading/">procps-ngのpgrepのコードリーディング</a> に続いて CentOS 6 の pgrep についてもコードリーディングしてみました。
<tt class="docutils literal">pgrep</tt> を含むパッケージは <tt class="docutils literal">procps</tt> でバージョンは3.2.8でした。</p>
<div class="highlight"><pre><span></span><span class="gp">[root@centos6 ~]#</span> rpm -qf <span class="sb">`</span>which pgrep<span class="sb">`</span>
<span class="go">procps-3.2.8-36.el6.x86_64</span>
</pre></div>
<p><tt class="docutils literal">procps</tt> のプロジェクトページは <a class="reference external" href="http://procps.sourceforge.net/">procps - Home Page</a> で、
<a class="reference external" href="http://procps.cvs.sourceforge.net/viewvc/procps/">SourceForge.net Repository - [procps] Index of /</a> でソースコードが見られます。</p>
<p>一方で以下のコマンドで srpm をダウンロードしてそこから <tt class="docutils literal">pgrep.c</tt> を取り出しました。</p>
<div class="highlight"><pre><span></span><span class="gp">[root@centos6 ~]#</span> curl -sO http://vault.centos.org/6.8/os/Source/SPackages/procps-3.2.8-36.el6.src.rpm
<span class="gp">[root@centos6 ~]#</span> mkdir procps-srpm
<span class="gp">[root@centos6 ~]#</span> rpm2cpio procps-3.2.8-36.el6.src.rpm <span class="p">|</span> <span class="o">(</span><span class="nb">cd</span> procps-srpm <span class="o">&amp;&amp;</span> cpio -idm --quiet<span class="o">)</span>
<span class="gp">[root@centos6 ~]#</span> tar xf procps-srpm/procps-3.2.8.tar.gz -C procps-srpm
</pre></div>
<p><a class="reference external" href="http://procps.cvs.sourceforge.net/viewvc/procps/procps/pgrep.c?view=log">SourceForge.net Repository - [procps] Log of /procps/pgrep.c</a> の各リビジョンと上記で取り出した <tt class="docutils literal">pgrep.c</tt> を比較したところ <a class="reference external" href="http://procps.cvs.sourceforge.net/viewvc/procps/procps/pgrep.c?revision=1.29&amp;view=markup">SourceForge.net Repository - [procps] Contents of /procps/pgrep.c revision 1.29</a> と一致していました。</p>
</div>
<div class="section" id="pgrep-c">
<h2>pgrep.cのコードリーディング</h2>
<p><tt class="docutils literal">main</tt> 関数の実装。
<a class="reference external" href="http://procps.cvs.sourceforge.net/viewvc/procps/procps/pgrep.c?revision=1.29&amp;view=markup#l709">pgrep.c#L709-#L732</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="k">union</span> <span class="n">el</span> <span class="o">*</span><span class="n">procs</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>

    <span class="n">parse_opts</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

    <span class="n">procs</span> <span class="o">=</span> <span class="n">select_procs</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">num</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i_am_pkill</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">kill</span> <span class="p">(</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">,</span> <span class="n">opt_signal</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span><span class="o">==</span><span class="n">ESRCH</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">// gone now, which is OK</span>
                    <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;pkill: %ld - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                             <span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">,</span> <span class="n">strerror</span> <span class="p">(</span><span class="n">errno</span><span class="p">));</span>
            <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">opt_long</span><span class="p">)</span>
                    <span class="n">output_strlist</span><span class="p">(</span><span class="n">procs</span><span class="p">,</span><span class="n">num</span><span class="p">);</span>
            <span class="k">else</span>
                    <span class="n">output_numlist</span><span class="p">(</span><span class="n">procs</span><span class="p">,</span><span class="n">num</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">!</span><span class="n">num</span><span class="p">;</span> <span class="c1">// exit(EXIT_SUCCESS) if match, otherwise exit(EXIT_FAILURE)</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">parse_opts</tt> 関数の実装。
<a class="reference external" href="http://procps.cvs.sourceforge.net/viewvc/procps/procps/pgrep.c?revision=1.29&amp;view=markup#l539">pgrep.c#L539-#L706</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664
665
666
667
668
669
670
671
672
673
674
675
676
677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_opts</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">opts</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">opt</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">criteria_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;pkill&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">i_am_pkill</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">progname</span> <span class="o">=</span> <span class="s">&quot;pkill&quot;</span><span class="p">;</span>
            <span class="cm">/* Look for a signal name or number as first argument */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">sig</span><span class="p">;</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="n">signal_name_to_number</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">isdigit</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">sig</span> <span class="o">=</span> <span class="n">atoi</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">sig</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                                    <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                            <span class="o">--</span><span class="n">argc</span><span class="p">;</span>
                            <span class="n">opt_signal</span> <span class="o">=</span> <span class="n">sig</span><span class="p">;</span>
                    <span class="p">}</span>
            <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="cm">/* These options are for pgrep only */</span>
            <span class="n">strcat</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;ld:&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">strcat</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;LF:fnovxP:g:s:u:U:G:t:?V&quot;</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">getopt</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">opts</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//          case &#39;D&#39;:   // FreeBSD: print info about non-matches for debugging</span>
<span class="c1">//                  break;</span>
            <span class="k">case</span> <span class="sc">&#39;F&#39;</span><span class="o">:</span>   <span class="c1">// FreeBSD: the arg is a file containing a PID to match</span>
                    <span class="n">opt_pidfile</span> <span class="o">=</span> <span class="n">strdup</span> <span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;G&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: match rgid/rgroup</span>
                    <span class="n">opt_rgid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_gid</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_rgid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="c1">//          case &#39;I&#39;:   // FreeBSD: require confirmation before killing</span>
<span class="c1">//                  break;</span>
<span class="c1">//          case &#39;J&#39;:   // Solaris: match by project ID (name or number)</span>
<span class="c1">//                  break;</span>
            <span class="k">case</span> <span class="sc">&#39;L&#39;</span><span class="o">:</span>   <span class="c1">// FreeBSD: fail if pidfile (see -F) not locked</span>
                    <span class="n">opt_lock</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="c1">//          case &#39;M&#39;:   // FreeBSD: specify core (OS crash dump) file</span>
<span class="c1">//                  break;</span>
<span class="c1">//          case &#39;N&#39;:   // FreeBSD: specify alternate namelist file (for us, System.map -- but we don&#39;t need it)</span>
<span class="c1">//                  break;</span>
            <span class="k">case</span> <span class="sc">&#39;P&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: match by PPID</span>
                    <span class="n">opt_ppid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_num</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_ppid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="c1">//          case &#39;S&#39;:   // FreeBSD: don&#39;t ignore the built-in kernel tasks</span>
<span class="c1">//                  break;</span>
<span class="c1">//          case &#39;T&#39;:   // Solaris: match by &quot;task ID&quot; (probably not a Linux task)</span>
<span class="c1">//                  break;</span>
            <span class="k">case</span> <span class="sc">&#39;U&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: match by ruid/rgroup</span>
                    <span class="n">opt_ruid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_uid</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_ruid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;V&#39;</span><span class="o">:</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;%s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">progname</span><span class="p">,</span> <span class="n">procps_version</span><span class="p">);</span>
                    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="c1">//          case &#39;c&#39;:   // Solaris: match by contract ID</span>
<span class="c1">//                  break;</span>
            <span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: change the delimiter</span>
                    <span class="n">opt_delim</span> <span class="o">=</span> <span class="n">strdup</span> <span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: match full process name (as in &quot;ps -f&quot;)</span>
                    <span class="n">opt_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;g&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: match pgrp</span>
                    <span class="n">opt_pgrp</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_pgrp</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_pgrp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="c1">//          case &#39;i&#39;:   // FreeBSD: ignore case. OpenBSD: withdrawn. See -I. This sucks.</span>
<span class="c1">//                  if (opt_case)</span>
<span class="c1">//                          usage (opt);</span>
<span class="c1">//                  opt_case = REG_ICASE;</span>
<span class="c1">//                  break;</span>
<span class="c1">//          case &#39;j&#39;:   // FreeBSD: restricted to the given jail ID</span>
<span class="c1">//                  break;</span>
            <span class="k">case</span> <span class="sc">&#39;l&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: long output format (pgrep only) Should require -f for beyond argv[0] maybe?</span>
                    <span class="n">opt_long</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: match only the newest</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="o">|</span><span class="n">opt_negate</span><span class="o">|</span><span class="n">opt_newest</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="n">opt_newest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;o&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: match only the oldest</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="o">|</span><span class="n">opt_negate</span><span class="o">|</span><span class="n">opt_newest</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="n">opt_oldest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;s&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: match by session ID -- zero means self</span>
                    <span class="n">opt_sid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_sid</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_sid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: match by tty</span>
                    <span class="n">opt_term</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_str</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_term</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;u&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: match by euid/egroup</span>
                    <span class="n">opt_euid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_uid</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_euid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: as in grep, invert the matching (uh... applied after selection I think)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="o">|</span><span class="n">opt_negate</span><span class="o">|</span><span class="n">opt_newest</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="n">opt_negate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="c1">// OpenBSD -x, being broken, does a plain string</span>
            <span class="k">case</span> <span class="sc">&#39;x&#39;</span><span class="o">:</span>   <span class="c1">// Solaris: use ^(regexp)$ in place of regexp (FreeBSD too)</span>
                    <span class="n">opt_exact</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="c1">//          case &#39;z&#39;:   // Solaris: match by zone ID</span>
<span class="c1">//                  break;</span>
            <span class="k">case</span> <span class="sc">&#39;?&#39;</span><span class="o">:</span>
                    <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">opt_lock</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">opt_pidfile</span><span class="p">){</span>
            <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: -L without -F makes no sense</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">progname</span><span class="p">);</span>
            <span class="n">usage</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">opt_pidfile</span><span class="p">){</span>
            <span class="n">opt_pid</span> <span class="o">=</span> <span class="n">read_pidfile</span><span class="p">();</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">opt_pid</span><span class="p">){</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: pidfile not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">progname</span><span class="p">);</span>
                    <span class="n">usage</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
    <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="n">optind</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">opt_pattern</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">];</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="n">optind</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">usage</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">criteria_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fprintf</span> <span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s: No matching criteria specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                     <span class="n">progname</span><span class="p">);</span>
            <span class="n">usage</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal"><span class="pre">-f</span></tt> オプションで <tt class="docutils literal">opt_full = 1;</tt> が実行され <tt class="docutils literal"><span class="pre">-l</span></tt> オプションで <tt class="docutils literal">opt_long = 1;</tt> が実行されます。</p>
<p><tt class="docutils literal">output_strlist</tt> 関数の実装。
<a class="reference external" href="http://procps.cvs.sourceforge.net/viewvc/procps/procps/pgrep.c?revision=1.29&amp;view=markup#l343">pgrep.c#L343-#L353</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>343
344
345
346
347
348
349
350
351
352
353</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">output_strlist</span> <span class="p">(</span><span class="k">const</span> <span class="k">union</span> <span class="n">el</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
<span class="c1">// FIXME: escape codes</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">delim</span> <span class="o">=</span> <span class="n">opt_delim</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="n">num</span><span class="p">)</span>
                    <span class="n">delim</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">,</span> <span class="n">delim</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">select_procs</tt> 関数の実装。
<a class="reference external" href="http://procps.cvs.sourceforge.net/viewvc/procps/procps/pgrep.c?revision=1.29&amp;view=markup#l416">pgrep.c#L416-#L536</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">union</span> <span class="n">el</span> <span class="o">*</span> <span class="nf">select_procs</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PROCTAB</span> <span class="o">*</span><span class="n">ptp</span><span class="p">;</span>
    <span class="n">proc_t</span> <span class="n">task</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">saved_start_time</span><span class="p">;</span>      <span class="c1">// for new/old support</span>
    <span class="kt">pid_t</span> <span class="n">saved_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                      <span class="c1">// for new/old support</span>
    <span class="kt">int</span> <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">regex_t</span> <span class="o">*</span><span class="n">preg</span><span class="p">;</span>
    <span class="kt">pid_t</span> <span class="n">myself</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
    <span class="k">union</span> <span class="n">el</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>

    <span class="n">ptp</span> <span class="o">=</span> <span class="n">do_openproc</span><span class="p">();</span>
    <span class="n">preg</span> <span class="o">=</span> <span class="n">do_regcomp</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span><span class="p">)</span> <span class="n">saved_start_time</span> <span class="o">=</span>  <span class="mi">0ULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="p">)</span> <span class="n">saved_start_time</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span><span class="p">)</span> <span class="n">saved_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="p">)</span> <span class="n">saved_pid</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">task</span><span class="p">));</span>
    <span class="k">while</span><span class="p">(</span><span class="n">readproc</span><span class="p">(</span><span class="n">ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">XXXID</span> <span class="o">==</span> <span class="n">myself</span><span class="p">)</span>
                    <span class="k">continue</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">saved_start_time</span><span class="p">)</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">saved_start_time</span><span class="p">)</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_ppid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">ppid</span><span class="p">,</span> <span class="n">opt_ppid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_pid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">tgid</span><span class="p">,</span> <span class="n">opt_pid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_pgrp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">pgrp</span><span class="p">,</span> <span class="n">opt_pgrp</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_euid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">euid</span><span class="p">,</span> <span class="n">opt_euid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_ruid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">ruid</span><span class="p">,</span> <span class="n">opt_ruid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_rgid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">rgid</span><span class="p">,</span> <span class="n">opt_rgid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_sid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="n">opt_sid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_term</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">tty</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="kt">char</span> <span class="n">tty</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
                            <span class="n">dev_to_tty</span> <span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="n">task</span><span class="p">.</span><span class="n">tty</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">,</span> <span class="n">ABBREV_DEV</span><span class="p">);</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="n">match_strlist</span> <span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">opt_term</span><span class="p">);</span>
                    <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">opt_long</span> <span class="o">||</span> <span class="p">(</span><span class="n">match</span> <span class="o">&amp;&amp;</span> <span class="n">opt_pattern</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_full</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                            <span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

                            <span class="cm">/* make sure it is always NUL-terminated */</span>
                            <span class="n">cmd</span><span class="p">[</span><span class="n">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                            <span class="cm">/* make room for SPC in loop below */</span>
                            <span class="o">--</span><span class="n">bytes</span><span class="p">;</span>

                            <span class="n">strncpy</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bytes</span><span class="p">);</span>
                            <span class="n">bytes</span> <span class="o">-=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>
                            <span class="k">while</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="n">strncat</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
                                    <span class="n">strncat</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bytes</span><span class="p">);</span>
                                    <span class="n">bytes</span> <span class="o">-=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                            <span class="p">}</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">strcpy</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
                    <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">&amp;&amp;</span> <span class="n">opt_pattern</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">regexec</span> <span class="p">(</span><span class="n">preg</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">^</span> <span class="n">opt_negate</span><span class="p">)</span> <span class="p">{</span>       <span class="cm">/* Exclusive OR is neat */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">saved_start_time</span> <span class="o">==</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&amp;&amp;</span>
                                <span class="n">saved_pid</span> <span class="o">&gt;</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">)</span>
                                    <span class="k">continue</span><span class="p">;</span>
                            <span class="n">saved_start_time</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span><span class="p">;</span>
                            <span class="n">saved_pid</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
                            <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">saved_start_time</span> <span class="o">==</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&amp;&amp;</span>
                                <span class="n">saved_pid</span> <span class="o">&lt;</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">)</span>
                                    <span class="k">continue</span><span class="p">;</span>
                            <span class="n">saved_start_time</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span><span class="p">;</span>
                            <span class="n">saved_pid</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
                            <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">matches</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
                            <span class="n">list</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">list</span><span class="p">);</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                                    <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FATAL</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_long</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">5096</span><span class="p">];</span>  <span class="c1">// FIXME</span>
                            <span class="n">sprintf</span> <span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="s">&quot;%d %s&quot;</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
                            <span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="o">++</span><span class="p">].</span><span class="n">str</span> <span class="o">=</span> <span class="n">strdup</span> <span class="p">(</span><span class="n">buff</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="o">++</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
                    <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">task</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">closeproc</span> <span class="p">(</span><span class="n">ptp</span><span class="p">);</span>

    <span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">matches</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">list</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">stat2proc</tt> 関数の実装。
<a class="reference external" href="http://procps.cvs.sourceforge.net/viewvc/procps/procps/proc/readproc.c?revision=1.56&amp;view=markup#l336">proc/readproc.c#L336-#L356</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Reads /proc/*/stat files, being careful not to trip over processes with</span>
<span class="c1">// names like &quot;:-) 1 2 3 4 5 6&quot;.</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stat2proc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">S</span><span class="p">,</span> <span class="n">proc_t</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">P</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">num</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">tmp</span><span class="p">;</span>

<span class="n">ENTER</span><span class="p">(</span><span class="mh">0x160</span><span class="p">);</span>

    <span class="cm">/* fill in default values for older kernels */</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">processor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">rtprio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">nlwp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">);</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">S</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="k">sizeof</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">))</span> <span class="n">num</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>                 <span class="c1">// skip &quot;) &quot;</span>
</pre></div>
</td></tr></table><p>ということで <tt class="docutils literal"><span class="pre">/proc/${PID}/stat</span></tt> の出力の <tt class="docutils literal">(</tt> と <tt class="docutils literal">)</tt> の間が <tt class="docutils literal">task.cmd</tt> に設定され、 <tt class="docutils literal"><span class="pre">-f</span></tt> を指定しない場合はこれがマッチの対象になります。
<tt class="docutils literal"><span class="pre">-f</span></tt> を設定した場合はコマンドライン全体がマッチの対象になります。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>