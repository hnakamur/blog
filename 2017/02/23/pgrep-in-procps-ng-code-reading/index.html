<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.74.3" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>procps-ngのpgrepのコードリーディング &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>procps-ngのpgrepのコードリーディング</h1>
  <time datetime=2017-02-23T00:20:00&#43;0900 class="post-date">2017-02-23</time>
  <h2 id="はじめに">はじめに</h2>
<p>CentOS 7の環境でApache Traffic Server 7.0.0のサービスを起動すると <code>traffic_cop</code>, <code>traffic_manager</code>, <code>traffic_server</code> という3つのプロセスが立ち上がります。</p>
<pre><code class="language-console" data-lang="console">[root@ats7 ~]# ps auxww | grep traffic
root     20837  0.0  0.0 143076  6276 ?        Ssl  15:14   0:00 /opt/trafficserver/bin/traffic_cop
ats      20838  0.0  0.0 448784 11960 ?        Sl   15:14   0:00 /opt/trafficserver/bin/traffic_manager --bind_stdout /opt/trafficserver/var/logs/traffic.out --bind_stderr /opt/trafficserver/var/logs/traffic.out
ats      20877  0.0  0.3 1047868 55464 ?       Sl   15:14   0:00 /opt/trafficserver/bin/traffic_server -M --bind_stdout /opt/trafficserver/var/logs/traffic.out --bind_stderr /opt/trafficserver/var/logs/traffic.out --httpport 8080:fd=9,8080:fd=10:ipv6
root     20992  0.0  0.0   9040   852 ?        S+   15:15   0:00 grep --color=auto traffic
</code></pre><p>しかし <code>pgrep -a traffic</code> で検索すると <code>traffic_cop</code> と <code>traffic_manager</code> のみが表示されました。</p>
<pre><code class="language-console" data-lang="console">[root@ats7 ~]# pgrep -a traffic
20837 /opt/trafficserver/bin/traffic_cop
20838 /opt/trafficserver/bin/traffic_manager --bind_stdout /opt/trafficserver/var/logs/traffic.out --bind_stderr /opt/trafficserver/var/logs/traffic.out
</code></pre><p><code>pgrep</code> を含むパッケージは <code>procps-ng</code> でバージョンは3.3.10でした。</p>
<pre><code class="language-console" data-lang="console">[root@ats7 ~]# rpm -qf `which pgrep`
procps-ng-3.3.10-10.el7.x86_64
</code></pre><p><a href="https://gitlab.com/procps-ng/procps"><code>procps-ng`` のレポジトリは </code>procps-ng / procps · GitLab</a> です。</p>
<h2 id="pgrepcのコードリーディング">pgrep.cのコードリーディング</h2>
<p><code>main</code> 関数の実装。
<a href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/pgrep.c#L902-944">pgrep.c#L902-#L944</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">902
</span><span class="lnt">903
</span><span class="lnt">904
</span><span class="lnt">905
</span><span class="lnt">906
</span><span class="lnt">907
</span><span class="lnt">908
</span><span class="lnt">909
</span><span class="lnt">910
</span><span class="lnt">911
</span><span class="lnt">912
</span><span class="lnt">913
</span><span class="lnt">914
</span><span class="lnt">915
</span><span class="lnt">916
</span><span class="lnt">917
</span><span class="lnt">918
</span><span class="lnt">919
</span><span class="lnt">920
</span><span class="lnt">921
</span><span class="lnt">922
</span><span class="lnt">923
</span><span class="lnt">924
</span><span class="lnt">925
</span><span class="lnt">926
</span><span class="lnt">927
</span><span class="lnt">928
</span><span class="lnt">929
</span><span class="lnt">930
</span><span class="lnt">931
</span><span class="lnt">932
</span><span class="lnt">933
</span><span class="lnt">934
</span><span class="lnt">935
</span><span class="lnt">936
</span><span class="lnt">937
</span><span class="lnt">938
</span><span class="lnt">939
</span><span class="lnt">940
</span><span class="lnt">941
</span><span class="lnt">942
</span><span class="lnt">943
</span><span class="lnt">944
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">el</span> <span class="o">*</span><span class="n">procs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>

<span class="cp">#ifdef HAVE_PROGRAM_INVOCATION_NAME
</span><span class="cp"></span>	<span class="n">program_invocation_name</span> <span class="o">=</span> <span class="n">program_invocation_short_name</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="cp"></span>	<span class="n">setlocale</span> <span class="p">(</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">);</span>
	<span class="n">bindtextdomain</span><span class="p">(</span><span class="n">PACKAGE</span><span class="p">,</span> <span class="n">LOCALEDIR</span><span class="p">);</span>
	<span class="n">textdomain</span><span class="p">(</span><span class="n">PACKAGE</span><span class="p">);</span>
	<span class="n">atexit</span><span class="p">(</span><span class="n">close_stdout</span><span class="p">);</span>

	<span class="n">parse_opts</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

	<span class="n">procs</span> <span class="o">=</span> <span class="n">select_procs</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i_am_pkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kill</span> <span class="p">(</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">,</span> <span class="n">opt_signal</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">opt_echo</span><span class="p">)</span>
					<span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#34;%s killed (pid %lu)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">),</span> <span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">,</span> <span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errno</span><span class="o">==</span><span class="n">ESRCH</span><span class="p">)</span>
				 <span class="cm">/* gone now, which is OK */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">xwarn</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#34;killing pid %ld failed&#34;</span><span class="p">),</span> <span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt_count</span><span class="p">)</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#34;%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_long</span> <span class="o">||</span> <span class="n">opt_longlong</span><span class="p">)</span>
				<span class="n">output_strlist</span> <span class="p">(</span><span class="n">procs</span><span class="p">,</span><span class="n">num</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">output_numlist</span> <span class="p">(</span><span class="n">procs</span><span class="p">,</span><span class="n">num</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">num</span><span class="p">;</span> <span class="cm">/* exit(EXIT_SUCCESS) if match, otherwise exit(EXIT_FAILURE) */</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>parse_opts</code> 関数の実装。
<a href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/pgrep.c#L677-899">pgrep.c#L677-#L899</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span><span class="lnt">737
</span><span class="lnt">738
</span><span class="lnt">739
</span><span class="lnt">740
</span><span class="lnt">741
</span><span class="lnt">742
</span><span class="lnt">743
</span><span class="lnt">744
</span><span class="lnt">745
</span><span class="lnt">746
</span><span class="lnt">747
</span><span class="lnt">748
</span><span class="lnt">749
</span><span class="lnt">750
</span><span class="lnt">751
</span><span class="lnt">752
</span><span class="lnt">753
</span><span class="lnt">754
</span><span class="lnt">755
</span><span class="lnt">756
</span><span class="lnt">757
</span><span class="lnt">758
</span><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span><span class="lnt">786
</span><span class="lnt">787
</span><span class="lnt">788
</span><span class="lnt">789
</span><span class="lnt">790
</span><span class="lnt">791
</span><span class="lnt">792
</span><span class="lnt">793
</span><span class="lnt">794
</span><span class="lnt">795
</span><span class="lnt">796
</span><span class="lnt">797
</span><span class="lnt">798
</span><span class="lnt">799
</span><span class="lnt">800
</span><span class="lnt">801
</span><span class="lnt">802
</span><span class="lnt">803
</span><span class="lnt">804
</span><span class="lnt">805
</span><span class="lnt">806
</span><span class="lnt">807
</span><span class="lnt">808
</span><span class="lnt">809
</span><span class="lnt">810
</span><span class="lnt">811
</span><span class="lnt">812
</span><span class="lnt">813
</span><span class="lnt">814
</span><span class="lnt">815
</span><span class="lnt">816
</span><span class="lnt">817
</span><span class="lnt">818
</span><span class="lnt">819
</span><span class="lnt">820
</span><span class="lnt">821
</span><span class="lnt">822
</span><span class="lnt">823
</span><span class="lnt">824
</span><span class="lnt">825
</span><span class="lnt">826
</span><span class="lnt">827
</span><span class="lnt">828
</span><span class="lnt">829
</span><span class="lnt">830
</span><span class="lnt">831
</span><span class="lnt">832
</span><span class="lnt">833
</span><span class="lnt">834
</span><span class="lnt">835
</span><span class="lnt">836
</span><span class="lnt">837
</span><span class="lnt">838
</span><span class="lnt">839
</span><span class="lnt">840
</span><span class="lnt">841
</span><span class="lnt">842
</span><span class="lnt">843
</span><span class="lnt">844
</span><span class="lnt">845
</span><span class="lnt">846
</span><span class="lnt">847
</span><span class="lnt">848
</span><span class="lnt">849
</span><span class="lnt">850
</span><span class="lnt">851
</span><span class="lnt">852
</span><span class="lnt">853
</span><span class="lnt">854
</span><span class="lnt">855
</span><span class="lnt">856
</span><span class="lnt">857
</span><span class="lnt">858
</span><span class="lnt">859
</span><span class="lnt">860
</span><span class="lnt">861
</span><span class="lnt">862
</span><span class="lnt">863
</span><span class="lnt">864
</span><span class="lnt">865
</span><span class="lnt">866
</span><span class="lnt">867
</span><span class="lnt">868
</span><span class="lnt">869
</span><span class="lnt">870
</span><span class="lnt">871
</span><span class="lnt">872
</span><span class="lnt">873
</span><span class="lnt">874
</span><span class="lnt">875
</span><span class="lnt">876
</span><span class="lnt">877
</span><span class="lnt">878
</span><span class="lnt">879
</span><span class="lnt">880
</span><span class="lnt">881
</span><span class="lnt">882
</span><span class="lnt">883
</span><span class="lnt">884
</span><span class="lnt">885
</span><span class="lnt">886
</span><span class="lnt">887
</span><span class="lnt">888
</span><span class="lnt">889
</span><span class="lnt">890
</span><span class="lnt">891
</span><span class="lnt">892
</span><span class="lnt">893
</span><span class="lnt">894
</span><span class="lnt">895
</span><span class="lnt">896
</span><span class="lnt">897
</span><span class="lnt">898
</span><span class="lnt">899
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_opts</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">opts</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">opt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">criteria_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">SIGNAL_OPTION</span> <span class="o">=</span> <span class="n">CHAR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		<span class="n">NS_OPTION</span><span class="p">,</span>
		<span class="n">NSLIST_OPTION</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">longopts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="s">&#34;signal&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SIGNAL_OPTION</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;count&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;delimiter&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;d&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;list-name&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;l&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;list-full&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;full&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;pgroup&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;group&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;newest&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;n&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;oldest&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;o&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;parent&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;session&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;s&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;terminal&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;euid&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;u&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;uid&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;inverse&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;v&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;lightweight&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;exact&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;x&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;pidfile&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;logpidfile&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;echo&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;e&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;ns&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">NS_OPTION</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;nslist&#34;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">NSLIST_OPTION</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;help&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;h&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="s">&#34;version&#34;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">},</span>
		<span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span> <span class="p">(</span><span class="n">program_invocation_short_name</span><span class="p">,</span> <span class="s">&#34;pkill&#34;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">sig</span><span class="p">;</span>
		<span class="n">i_am_pkill</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sig</span> <span class="o">=</span> <span class="n">signal_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">sig</span><span class="p">)</span>
			<span class="n">opt_signal</span> <span class="o">=</span> <span class="n">sig</span><span class="p">;</span>
		<span class="cm">/* These options are for pkill only */</span>
		<span class="n">strcat</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#34;e&#34;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* These options are for pgrep only */</span>
		<span class="n">strcat</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#34;lad:vw&#34;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">strcat</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#34;LF:cfnoxP:g:s:u:U:G:t:?Vh&#34;</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">getopt_long</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">longopts</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nl">SIGNAL_OPTION</span><span class="p">:</span>
			<span class="n">opt_signal</span> <span class="o">=</span> <span class="n">signal_name_to_number</span> <span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_signal</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">isdigit</span> <span class="p">(</span><span class="n">optarg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
				<span class="n">opt_signal</span> <span class="o">=</span> <span class="n">atoi</span> <span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;e&#39;</span><span class="o">:</span>
			<span class="n">opt_echo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cm">/*		case &#39;D&#39;:   / * FreeBSD: print info about non-matches for debugging * /
</span><span class="cm"> *			break; */</span>
		<span class="k">case</span> <span class="sc">&#39;F&#39;</span><span class="o">:</span>   <span class="cm">/* FreeBSD: the arg is a file containing a PID to match */</span>
			<span class="n">opt_pidfile</span> <span class="o">=</span> <span class="n">xstrdup</span> <span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;G&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match rgid/rgroup */</span>
			<span class="n">opt_rgid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_gid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_rgid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cm">/*		case &#39;I&#39;:   / * FreeBSD: require confirmation before killing * /
</span><span class="cm"> *			break; */</span>
<span class="cm">/*		case &#39;J&#39;:   / * Solaris: match by project ID (name or number) * /
</span><span class="cm"> *			break; */</span>
		<span class="k">case</span> <span class="sc">&#39;L&#39;</span><span class="o">:</span>   <span class="cm">/* FreeBSD: fail if pidfile (see -F) not locked */</span>
			<span class="n">opt_lock</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cm">/*		case &#39;M&#39;:   / * FreeBSD: specify core (OS crash dump) file * /
</span><span class="cm"> *			break; */</span>
<span class="cm">/*		case &#39;N&#39;:   / * FreeBSD: specify alternate namelist file (for us, System.map -- but we don&#39;t need it) * /
</span><span class="cm"> *			break; */</span>
		<span class="k">case</span> <span class="sc">&#39;P&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match by PPID */</span>
			<span class="n">opt_ppid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_num</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_ppid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cm">/*		case &#39;S&#39;:   / * FreeBSD: don&#39;t ignore the built-in kernel tasks * /
</span><span class="cm"> *			break; */</span>
<span class="cm">/*		case &#39;T&#39;:   / * Solaris: match by &#34;task ID&#34; (probably not a Linux task) * /
</span><span class="cm"> *			break; */</span>
		<span class="k">case</span> <span class="sc">&#39;U&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match by ruid/rgroup */</span>
			<span class="n">opt_ruid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_uid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_ruid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;V&#39;</span><span class="o">:</span>
			<span class="n">printf</span><span class="p">(</span><span class="n">PROCPS_NG_VERSION</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="cm">/*		case &#39;c&#39;:   / * Solaris: match by contract ID * /
</span><span class="cm"> *			break; */</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span><span class="o">:</span>
			<span class="n">opt_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: change the delimiter */</span>
			<span class="n">opt_delim</span> <span class="o">=</span> <span class="n">xstrdup</span> <span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match full process name (as in &#34;ps -f&#34;) */</span>
			<span class="n">opt_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;g&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match pgrp */</span>
			<span class="n">opt_pgrp</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_pgrp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_pgrp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cm">/*		case &#39;i&#39;:   / * FreeBSD: ignore case. OpenBSD: withdrawn. See -I. This sucks. * /
</span><span class="cm"> *			if (opt_case)
</span><span class="cm"> *				usage (opt);
</span><span class="cm"> *			opt_case = REG_ICASE;
</span><span class="cm"> *			break; */</span>
<span class="cm">/*		case &#39;j&#39;:   / * FreeBSD: restricted to the given jail ID * /
</span><span class="cm"> *			break; */</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: long output format (pgrep only) Should require -f for beyond argv[0] maybe? */</span>
			<span class="n">opt_long</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;a&#39;</span><span class="o">:</span>
			<span class="n">opt_longlong</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match only the newest */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="o">|</span><span class="n">opt_negate</span><span class="o">|</span><span class="n">opt_newest</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="n">opt_newest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;o&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match only the oldest */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="o">|</span><span class="n">opt_negate</span><span class="o">|</span><span class="n">opt_newest</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="n">opt_oldest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match by session ID -- zero means self */</span>
			<span class="n">opt_sid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_sid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_sid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match by tty */</span>
			<span class="n">opt_term</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_str</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_term</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;u&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match by euid/egroup */</span>
			<span class="n">opt_euid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_uid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_euid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: as in grep, invert the matching (uh... applied after selection I think) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="o">|</span><span class="n">opt_negate</span><span class="o">|</span><span class="n">opt_newest</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="n">opt_negate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;w&#39;</span><span class="o">:</span>   <span class="c1">// Linux: show threads (lightweight process) too
</span><span class="c1"></span>			<span class="n">opt_threads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* OpenBSD -x, being broken, does a plain string */</span>
		<span class="k">case</span> <span class="sc">&#39;x&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: use ^(regexp)$ in place of regexp (FreeBSD too) */</span>
			<span class="n">opt_exact</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cm">/*		case &#39;z&#39;:   / * Solaris: match by zone ID * /
</span><span class="cm"> *			break; */</span>
		<span class="k">case</span> <span class="nl">NS_OPTION</span><span class="p">:</span>
			<span class="n">opt_ns_pid</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_ns_pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="nl">NSLIST_OPTION</span><span class="p">:</span>
			<span class="n">opt_nslist</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_ns</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_nslist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
		<span class="k">case</span> <span class="sc">&#39;?&#39;</span><span class="o">:</span>
			<span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">opt_lock</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">opt_pidfile</span><span class="p">)</span>
		<span class="n">xerrx</span><span class="p">(</span><span class="n">EXIT_USAGE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&#34;-L without -F makes no sense</span><span class="se">\n</span><span class="s">&#34;</span>
				     <span class="s">&#34;Try `%s --help&#39; for more information.&#34;</span><span class="p">),</span>
				     <span class="n">program_invocation_short_name</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="n">opt_pidfile</span><span class="p">){</span>
		<span class="n">opt_pid</span> <span class="o">=</span> <span class="n">read_pidfile</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">opt_pid</span><span class="p">)</span>
			<span class="n">xerrx</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&#34;pidfile not valid</span><span class="se">\n</span><span class="s">&#34;</span>
					     <span class="s">&#34;Try `%s --help&#39; for more information.&#34;</span><span class="p">),</span>
					     <span class="n">program_invocation_short_name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="n">optind</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">opt_pattern</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="n">optind</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">xerrx</span><span class="p">(</span><span class="n">EXIT_USAGE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&#34;only one pattern can be provided</span><span class="se">\n</span><span class="s">&#34;</span>
				     <span class="s">&#34;Try `%s --help&#39; for more information.&#34;</span><span class="p">),</span>
				     <span class="n">program_invocation_short_name</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">criteria_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">xerrx</span><span class="p">(</span><span class="n">EXIT_USAGE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&#34;no matching criteria specified</span><span class="se">\n</span><span class="s">&#34;</span>
				     <span class="s">&#34;Try `%s --help&#39; for more information.&#34;</span><span class="p">),</span>
				     <span class="n">program_invocation_short_name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>parse_opts</code> 関数の811〜812行目で <code>-a</code> を指定すると <code>opt_longlong = 1</code> と設定されることがわかります。
<code>main</code> 関数を見ると <code>pgrep</code> で <code>-a</code> を指定した場合は <code>opt_count</code> は 0 で <code>opt_longlong</code> が 1なので、938行目の <code>output_strlist</code> が呼ばれます。</p>
<p><code>output_strlist</code> 関数の実装。
<a href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/pgrep.c#L410-420">pgrep.c#L410-#L420</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">output_strlist</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">el</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* FIXME: escape codes */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">delim</span> <span class="o">=</span> <span class="n">opt_delim</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="n">num</span><span class="p">)</span>
			<span class="n">delim</span> <span class="o">=</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
		<span class="n">printf</span> <span class="p">(</span><span class="s">&#34;%lu %s%s&#34;</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">,</span> <span class="n">delim</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ここは単に出力しているだけでした。</p>
<p><code>struct el</code> の定義。
<a href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/pgrep.c#L60-63">pgrep.c#L60-#L63</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">el</span> <span class="p">{</span>
	<span class="kt">long</span>	<span class="n">num</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span>	<span class="n">str</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p><code>main</code> 関数の917行目の <code>select_procs</code> 関数が中核です。</p>
<p><code>select_procs</code> 関数の実装。
<a href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/pgrep.c#L482-655">pgrep.c#L482-#L655</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">struct</span> <span class="n">el</span> <span class="o">*</span> <span class="nf">select_procs</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PROCTAB</span> <span class="o">*</span><span class="n">ptp</span><span class="p">;</span>
	<span class="n">proc_t</span> <span class="n">task</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">saved_start_time</span><span class="p">;</span>      <span class="cm">/* for new/old support */</span>
	<span class="n">pid_t</span> <span class="n">saved_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                      <span class="cm">/* for new/old support */</span>
	<span class="kt">int</span> <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">regex_t</span> <span class="o">*</span><span class="n">preg</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">myself</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
	<span class="k">struct</span> <span class="n">el</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cmdline</span><span class="p">[</span><span class="n">CMDSTRSIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">cmdsearch</span><span class="p">[</span><span class="n">CMDSTRSIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">cmdoutput</span><span class="p">[</span><span class="n">CMDSTRSIZE</span><span class="p">];</span>
	<span class="n">proc_t</span> <span class="n">ns_task</span><span class="p">;</span>

	<span class="n">ptp</span> <span class="o">=</span> <span class="n">do_openproc</span><span class="p">();</span>
	<span class="n">preg</span> <span class="o">=</span> <span class="n">do_regcomp</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span><span class="p">)</span> <span class="n">saved_start_time</span> <span class="o">=</span>  <span class="mi">0ULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">saved_start_time</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span><span class="p">)</span> <span class="n">saved_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="p">)</span> <span class="n">saved_pid</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opt_ns_pid</span> <span class="o">&amp;&amp;</span> <span class="n">ns_read</span><span class="p">(</span><span class="n">opt_ns_pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns_task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fputs</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&#34;Error reading reference namespace information</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">),</span>
		      <span class="n">stderr</span><span class="p">);</span>
		<span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FATAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">task</span><span class="p">));</span>
	<span class="k">while</span><span class="p">(</span><span class="n">readproc</span><span class="p">(</span><span class="n">ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">XXXID</span> <span class="o">==</span> <span class="n">myself</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">saved_start_time</span><span class="p">)</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">saved_start_time</span><span class="p">)</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_ppid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">ppid</span><span class="p">,</span> <span class="n">opt_ppid</span><span class="p">))</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_pid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">tgid</span><span class="p">,</span> <span class="n">opt_pid</span><span class="p">))</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_pgrp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">pgrp</span><span class="p">,</span> <span class="n">opt_pgrp</span><span class="p">))</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_euid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">euid</span><span class="p">,</span> <span class="n">opt_euid</span><span class="p">))</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_ruid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">ruid</span><span class="p">,</span> <span class="n">opt_ruid</span><span class="p">))</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_rgid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">rgid</span><span class="p">,</span> <span class="n">opt_rgid</span><span class="p">))</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_sid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="n">opt_sid</span><span class="p">))</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_ns_pid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_ns</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns_task</span><span class="p">))</span>
			<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_term</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">tty</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">tty</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
				<span class="n">dev_to_tty</span> <span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">task</span><span class="p">.</span><span class="n">tty</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">,</span> <span class="n">ABBREV_DEV</span><span class="p">);</span>
				<span class="n">match</span> <span class="o">=</span> <span class="n">match_strlist</span> <span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">opt_term</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">opt_longlong</span> <span class="o">||</span> <span class="n">opt_full</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* make sure it is always NUL-terminated */</span>
			<span class="n">cmdline</span><span class="p">[</span><span class="n">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* make room for SPC in loop below */</span>
			<span class="o">--</span><span class="n">bytes</span><span class="p">;</span>

			<span class="n">strncpy</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bytes</span><span class="p">);</span>
			<span class="n">bytes</span> <span class="o">-=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">strncat</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="s">&#34; &#34;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
				<span class="n">strncat</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bytes</span><span class="p">);</span>
				<span class="n">bytes</span> <span class="o">-=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">opt_long</span> <span class="o">||</span> <span class="n">opt_longlong</span> <span class="o">||</span> <span class="p">(</span><span class="n">match</span> <span class="o">&amp;&amp;</span> <span class="n">opt_pattern</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_longlong</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">)</span>
				<span class="n">strncpy</span> <span class="p">(</span><span class="n">cmdoutput</span><span class="p">,</span> <span class="n">cmdline</span><span class="p">,</span> <span class="n">CMDSTRSIZE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">strncpy</span> <span class="p">(</span><span class="n">cmdoutput</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">CMDSTRSIZE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">&amp;&amp;</span> <span class="n">opt_pattern</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_full</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">)</span>
				<span class="n">strncpy</span> <span class="p">(</span><span class="n">cmdsearch</span><span class="p">,</span> <span class="n">cmdline</span><span class="p">,</span> <span class="n">CMDSTRSIZE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">strncpy</span> <span class="p">(</span><span class="n">cmdsearch</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">CMDSTRSIZE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">regexec</span> <span class="p">(</span><span class="n">preg</span><span class="p">,</span> <span class="n">cmdsearch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">^</span> <span class="n">opt_negate</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Exclusive OR is neat */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">saved_start_time</span> <span class="o">==</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&amp;&amp;</span>
				    <span class="n">saved_pid</span> <span class="o">&gt;</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">saved_start_time</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span><span class="p">;</span>
				<span class="n">saved_pid</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
				<span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">saved_start_time</span> <span class="o">==</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&amp;&amp;</span>
				    <span class="n">saved_pid</span> <span class="o">&lt;</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">saved_start_time</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span><span class="p">;</span>
				<span class="n">saved_pid</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
				<span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">matches</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">list</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">list</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">opt_long</span> <span class="o">||</span> <span class="n">opt_longlong</span> <span class="o">||</span> <span class="n">opt_echo</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
				<span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="o">++</span><span class="p">].</span><span class="n">str</span> <span class="o">=</span> <span class="n">xstrdup</span> <span class="p">(</span><span class="n">cmdoutput</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="o">++</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">xerrx</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&#34;internal error&#34;</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="c1">// pkill does not need subtasks!
</span><span class="c1"></span>			<span class="c1">// this control is still done at
</span><span class="c1"></span>			<span class="c1">// argparse time, but a further
</span><span class="c1"></span>			<span class="c1">// control is free
</span><span class="c1"></span>			<span class="k">if</span> <span class="p">(</span><span class="n">opt_threads</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">i_am_pkill</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">proc_t</span> <span class="n">subtask</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subtask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">subtask</span><span class="p">));</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">readtask</span><span class="p">(</span><span class="n">ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subtask</span><span class="p">)){</span>
					<span class="c1">// don&#39;t add redundand tasks
</span><span class="c1"></span>					<span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">XXXID</span> <span class="o">==</span> <span class="n">subtask</span><span class="p">.</span><span class="n">XXXID</span><span class="p">)</span>
						<span class="k">continue</span><span class="p">;</span>

					<span class="c1">// eventually grow output buffer
</span><span class="c1"></span>					<span class="k">if</span> <span class="p">(</span><span class="n">matches</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
						<span class="n">list</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">list</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
							<span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FATAL</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">opt_long</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="p">].</span><span class="n">str</span> <span class="o">=</span> <span class="n">xstrdup</span> <span class="p">(</span><span class="n">cmdoutput</span><span class="p">);</span>
						<span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="o">++</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">subtask</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="o">++</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">subtask</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subtask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">subtask</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">task</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">closeproc</span> <span class="p">(</span><span class="n">ptp</span><span class="p">);</span>
	<span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">matches</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">list</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>574〜580行目で <code>opt_full</code> が0以外かつ <code>task.cmdline</code> がNULL以外なら <code>cmdline</code> が、そうでなければ <code>task.cmd</code> が検索対象になることがわかりました。</p>
<p>呼び出しの途中は省略しますが、 <code>stat2proc</code> 関数の実装（抜粋）
<a href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/proc/readproc.c#L548-567">proc/readproc.c#L548-#L567</a>
を見ると <code>task.cmd</code> は <code>/proc/*/stat</code> の <code>(</code> と <code>)</code> の間の部分になることがわかりました。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">// Reads /proc/*/stat files, being careful not to trip over processes with
</span><span class="c1">// names like &#34;:-) 1 2 3 4 5 6&#34;.
</span><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">stat2proc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">S</span><span class="p">,</span> <span class="n">proc_t</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">P</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">num</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">tmp</span><span class="p">;</span>

<span class="n">ENTER</span><span class="p">(</span><span class="mh">0x160</span><span class="p">);</span>

    <span class="cm">/* fill in default values for older kernels */</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">processor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">rtprio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">nlwp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">);</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">S</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="k">sizeof</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">))</span> <span class="n">num</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ps auxww | grep traffic</code> と <code>cat /proc/${PID}/stat</code> の結果を比べてみました。</p>
<pre><code class="language-console" data-lang="console">[root@ats7 ~]# cat /proc/20837/stat
20837 (traffic_cop) S 1 20837 20837 0 -1 1077936384 489 0 6 0 4 24 0 0 20 0 2 0 553918400 146509824 1569 18446744073709551615 94079978950656 94079979051376 140726768039552 140726768030720 140350454315997 0 0 3674113 91342 0 0 0 17 0 0 0 9 0 0 94079981152352 94079981203568 94079988858880 140726768041851 140726768041886 140726768041886 140726768041941 0
[root@ats7 ~]# cat /proc/20838/stat
20838 (traffic_manager) S 20837 20837 20837 0 -1 4194560 1461 0 1 0 472 63 0 0 20 0 6 0 553918413 459685888 2990 18446744073709551615 94657453907968 94657455120371 140723571977072 140723571830272 139779374492579 0 2147193488 3670016 93263 0 0 0 17 1 0 0 0 0 0 94657457217984 94657457272704 94657464983552 140723571982087 140723571982234 140723571982234 140723571982289 0
[root@ats7 ~]# cat /proc/20877/stat
20877 ([TS_MAIN]) S 20838 20837 20837 0 -1 1077936384 26656 0 0 0 1108 3458 0 0 20 0 20 0 553918517 1140125696 13869 18446744073709551615 94103198183424 94103202477292 140734131727600 140734131721984 46982532413037 0 0 3674113 20222 0 0 0 17 0 0 0 1 0 0 94103204576832 94103204684656 94103237705728 140734131732164 140734131732350 140734131732350 140734131732434 0
[root@ats7 ~]# cat /proc/20878/stat
20878 (traffic_server) S 20838 20837 20837 0 -1 1077936448 26787 0 0 0 1115 3478 0 0 20 0 20 0 553918520 1140125696 13870 18446744073709551615 94103198183424 94103202477292 140734131727600 46982562638768 46982532413037 0 2147193488 3674113 20222 0 0 0 -1 1 0 0 0 0 0 94103204576832 94103204684656 94103237705728 140734131732164 140734131732350 140734131732350 140734131732434 0
</code></pre><p>20877 のプロセスは <code>ps auxww</code> で見るとコマンドラインのコマンド部分は <code>/opt/trafficserver/bin/traffic_server</code> となっていますが、
<code>/proc/20877/stat</code> の <code>(</code> と <code>)</code> の間は <code>[TS_MAIN]</code> となっているので <code>pgrep</code> では検索がマッチせず出力されないんですね。</p>
<p>試しに <code>/proc/20878/stat</code> を見るとそちらは <code>(</code> と <code>)</code> の間が <code>traffic_server</code> となっていました。
が、 <code>ps auxww</code> で見ると PID=20878 のプロセスは存在していませんでした。</p>
<p>以下のように <code>pgrep -fa traffic</code> にすれば <code>traffic_server</code> もマッチしました。コマンドライン全体でマッチするので指定した文字列が引数に含まれる場合もマッチになる点が要注意ですが、必要なものがマッチしないよりはこちらのほうが良いと思います。</p>
<pre><code class="language-console" data-lang="console">[root@ats7 ~]# pgrep -fa traffic
20837 /opt/trafficserver/bin/traffic_cop
20838 /opt/trafficserver/bin/traffic_manager --bind_stdout /opt/trafficserver/var/logs/traffic.out --bind_stderr /opt/trafficserver/var/logs/traffic.out
20877 /opt/trafficserver/bin/traffic_server -M --bind_stdout /opt/trafficserver/var/logs/traffic.out --bind_stderr /opt/trafficserver/var/logs/traffic.out --httpport 8080:fd=9,8080:fd=10:ipv6
</code></pre>
</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
