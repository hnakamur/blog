<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>procps-ngのpgrepのコードリーディング</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/02/23/pgrep-in-procps-ng-code-reading/" rel="bookmark"
           title="Permalink to procps-ngのpgrepのコードリーディング">procps-ngのpgrepのコードリーディング</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-02-23T00:20:00+09:00">
                Published: 2017-02-23
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/pgrep.html">pgrep</a> <a href="../../../../tag/procps-ng.html">procps-ng</a> <a href="../../../../tag/code-reading.html">code-reading</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>CentOS 7の環境でApache Traffic Server 7.0.0のサービスを起動すると <tt class="docutils literal">traffic_cop</tt>, <tt class="docutils literal">traffic_manager</tt>, <tt class="docutils literal">traffic_server</tt> という3つのプロセスが立ち上がります。</p>
<div class="highlight"><pre><span></span><span class="gp">[root@ats7 ~]#</span> ps auxww <span class="p">|</span> grep traffic
<span class="go">root     20837  0.0  0.0 143076  6276 ?        Ssl  15:14   0:00 /opt/trafficserver/bin/traffic_cop</span>
<span class="go">ats      20838  0.0  0.0 448784 11960 ?        Sl   15:14   0:00 /opt/trafficserver/bin/traffic_manager --bind_stdout /opt/trafficserver/var/logs/traffic.out --bind_stderr /opt/trafficserver/var/logs/traffic.out</span>
<span class="go">ats      20877  0.0  0.3 1047868 55464 ?       Sl   15:14   0:00 /opt/trafficserver/bin/traffic_server -M --bind_stdout /opt/trafficserver/var/logs/traffic.out --bind_stderr /opt/trafficserver/var/logs/traffic.out --httpport 8080:fd=9,8080:fd=10:ipv6</span>
<span class="go">root     20992  0.0  0.0   9040   852 ?        S+   15:15   0:00 grep --color=auto traffic</span>
</pre></div>
<p>しかし <tt class="docutils literal">pgrep <span class="pre">-a</span> traffic</tt> で検索すると <tt class="docutils literal">traffic_cop</tt> と <tt class="docutils literal">traffic_manager</tt> のみが表示されました。</p>
<div class="highlight"><pre><span></span><span class="gp">[root@ats7 ~]#</span> pgrep -a traffic
<span class="go">20837 /opt/trafficserver/bin/traffic_cop</span>
<span class="go">20838 /opt/trafficserver/bin/traffic_manager --bind_stdout /opt/trafficserver/var/logs/traffic.out --bind_stderr /opt/trafficserver/var/logs/traffic.out</span>
</pre></div>
<p><tt class="docutils literal">pgrep</tt> を含むパッケージは <tt class="docutils literal"><span class="pre">procps-ng</span></tt> でバージョンは3.3.10でした。</p>
<div class="highlight"><pre><span></span><span class="gp">[root@ats7 ~]#</span> rpm -qf <span class="sb">`</span>which pgrep<span class="sb">`</span>
<span class="go">procps-ng-3.3.10-10.el7.x86_64</span>
</pre></div>
<p><tt class="docutils literal"><span class="pre">procps-ng</span></tt> のレポジトリは <a class="reference external" href="https://gitlab.com/procps-ng/procps">procps-ng / procps · GitLab</a> です。</p>
</div>
<div class="section" id="pgrep-c">
<h2>pgrep.cのコードリーディング</h2>
<p><tt class="docutils literal">main</tt> 関数の実装。
<a class="reference external" href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/pgrep.c#L902-944">pgrep.c#L902-#L944</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>902
903
904
905
906
907
908
909
910
911
912
913
914
915
916
917
918
919
920
921
922
923
924
925
926
927
928
929
930
931
932
933
934
935
936
937
938
939
940
941
942
943
944</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">el</span> <span class="o">*</span><span class="n">procs</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>

<span class="cp">#ifdef HAVE_PROGRAM_INVOCATION_NAME</span>
    <span class="n">program_invocation_name</span> <span class="o">=</span> <span class="n">program_invocation_short_name</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="n">setlocale</span> <span class="p">(</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">bindtextdomain</span><span class="p">(</span><span class="n">PACKAGE</span><span class="p">,</span> <span class="n">LOCALEDIR</span><span class="p">);</span>
    <span class="n">textdomain</span><span class="p">(</span><span class="n">PACKAGE</span><span class="p">);</span>
    <span class="n">atexit</span><span class="p">(</span><span class="n">close_stdout</span><span class="p">);</span>

    <span class="n">parse_opts</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

    <span class="n">procs</span> <span class="o">=</span> <span class="n">select_procs</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">num</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i_am_pkill</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">kill</span> <span class="p">(</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">,</span> <span class="n">opt_signal</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">opt_echo</span><span class="p">)</span>
                                    <span class="n">printf</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;%s killed (pid %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span> <span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">,</span> <span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">);</span>
                            <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span><span class="o">==</span><span class="n">ESRCH</span><span class="p">)</span>
                             <span class="cm">/* gone now, which is OK */</span>
                            <span class="k">continue</span><span class="p">;</span>
                    <span class="n">xwarn</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;killing pid %ld failed&quot;</span><span class="p">),</span> <span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">opt_count</span><span class="p">)</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">opt_count</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">fprintf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_long</span> <span class="o">||</span> <span class="n">opt_longlong</span><span class="p">)</span>
                            <span class="n">output_strlist</span> <span class="p">(</span><span class="n">procs</span><span class="p">,</span><span class="n">num</span><span class="p">);</span>
                    <span class="k">else</span>
                            <span class="n">output_numlist</span> <span class="p">(</span><span class="n">procs</span><span class="p">,</span><span class="n">num</span><span class="p">);</span>
            <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">!</span><span class="n">num</span><span class="p">;</span> <span class="cm">/* exit(EXIT_SUCCESS) if match, otherwise exit(EXIT_FAILURE) */</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">parse_opts</tt> 関数の実装。
<a class="reference external" href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/pgrep.c#L677-899">pgrep.c#L677-#L899</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>677
678
679
680
681
682
683
684
685
686
687
688
689
690
691
692
693
694
695
696
697
698
699
700
701
702
703
704
705
706
707
708
709
710
711
712
713
714
715
716
717
718
719
720
721
722
723
724
725
726
727
728
729
730
731
732
733
734
735
736
737
738
739
740
741
742
743
744
745
746
747
748
749
750
751
752
753
754
755
756
757
758
759
760
761
762
763
764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779
780
781
782
783
784
785
786
787
788
789
790
791
792
793
794
795
796
797
798
799
800
801
802
803
804
805
806
807
808
809
810
811
812
813
814
815
816
817
818
819
820
821
822
823
824
825
826
827
828
829
830
831
832
833
834
835
836
837
838
839
840
841
842
843
844
845
846
847
848
849
850
851
852
853
854
855
856
857
858
859
860
861
862
863
864
865
866
867
868
869
870
871
872
873
874
875
876
877
878
879
880
881
882
883
884
885
886
887
888
889
890
891
892
893
894
895
896
897
898
899</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">parse_opts</span> <span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">opts</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">opt</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">criteria_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">enum</span> <span class="p">{</span>
            <span class="n">SIGNAL_OPTION</span> <span class="o">=</span> <span class="n">CHAR_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">NS_OPTION</span><span class="p">,</span>
            <span class="n">NSLIST_OPTION</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">longopts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">{</span><span class="s">&quot;signal&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SIGNAL_OPTION</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;c&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;delimiter&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;d&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;list-name&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;l&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;list-full&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;full&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;f&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;pgroup&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;g&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;group&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;newest&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;n&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;oldest&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;o&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;parent&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;session&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;s&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;terminal&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;t&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;euid&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;u&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;uid&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;inverse&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;v&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;lightweight&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;w&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;exact&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;x&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;pidfile&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;logpidfile&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;L&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;echo&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;e&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;ns&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">NS_OPTION</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;nslist&quot;</span><span class="p">,</span> <span class="n">required_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">NSLIST_OPTION</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;help&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;h&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="n">no_argument</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
    <span class="p">};</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span> <span class="p">(</span><span class="n">program_invocation_short_name</span><span class="p">,</span> <span class="s">&quot;pkill&quot;</span><span class="p">))</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">sig</span><span class="p">;</span>
            <span class="n">i_am_pkill</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">signal_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">sig</span><span class="p">)</span>
                    <span class="n">opt_signal</span> <span class="o">=</span> <span class="n">sig</span><span class="p">;</span>
            <span class="cm">/* These options are for pkill only */</span>
            <span class="n">strcat</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;e&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="cm">/* These options are for pgrep only */</span>
            <span class="n">strcat</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;lad:vw&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">strcat</span> <span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;LF:cfnoxP:g:s:u:U:G:t:?Vh&quot;</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">((</span><span class="n">opt</span> <span class="o">=</span> <span class="n">getopt_long</span> <span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">longopts</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nl">SIGNAL_OPTION</span><span class="p">:</span>
                    <span class="n">opt_signal</span> <span class="o">=</span> <span class="n">signal_name_to_number</span> <span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_signal</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">isdigit</span> <span class="p">(</span><span class="n">optarg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="n">opt_signal</span> <span class="o">=</span> <span class="n">atoi</span> <span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;e&#39;</span><span class="o">:</span>
                    <span class="n">opt_echo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="cm">/*          case &#39;D&#39;:   / * FreeBSD: print info about non-matches for debugging * /</span>
<span class="cm"> *                  break; */</span>
            <span class="k">case</span> <span class="sc">&#39;F&#39;</span><span class="o">:</span>   <span class="cm">/* FreeBSD: the arg is a file containing a PID to match */</span>
                    <span class="n">opt_pidfile</span> <span class="o">=</span> <span class="n">xstrdup</span> <span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;G&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match rgid/rgroup */</span>
                    <span class="n">opt_rgid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_gid</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_rgid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="cm">/*          case &#39;I&#39;:   / * FreeBSD: require confirmation before killing * /</span>
<span class="cm"> *                  break; */</span>
<span class="cm">/*          case &#39;J&#39;:   / * Solaris: match by project ID (name or number) * /</span>
<span class="cm"> *                  break; */</span>
            <span class="k">case</span> <span class="sc">&#39;L&#39;</span><span class="o">:</span>   <span class="cm">/* FreeBSD: fail if pidfile (see -F) not locked */</span>
                    <span class="n">opt_lock</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="cm">/*          case &#39;M&#39;:   / * FreeBSD: specify core (OS crash dump) file * /</span>
<span class="cm"> *                  break; */</span>
<span class="cm">/*          case &#39;N&#39;:   / * FreeBSD: specify alternate namelist file (for us, System.map -- but we don&#39;t need it) * /</span>
<span class="cm"> *                  break; */</span>
            <span class="k">case</span> <span class="sc">&#39;P&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match by PPID */</span>
                    <span class="n">opt_ppid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_num</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_ppid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="cm">/*          case &#39;S&#39;:   / * FreeBSD: don&#39;t ignore the built-in kernel tasks * /</span>
<span class="cm"> *                  break; */</span>
<span class="cm">/*          case &#39;T&#39;:   / * Solaris: match by &quot;task ID&quot; (probably not a Linux task) * /</span>
<span class="cm"> *                  break; */</span>
            <span class="k">case</span> <span class="sc">&#39;U&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match by ruid/rgroup */</span>
                    <span class="n">opt_ruid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_uid</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_ruid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;V&#39;</span><span class="o">:</span>
                    <span class="n">printf</span><span class="p">(</span><span class="n">PROCPS_NG_VERSION</span><span class="p">);</span>
                    <span class="n">exit</span><span class="p">(</span><span class="n">EXIT_SUCCESS</span><span class="p">);</span>
<span class="cm">/*          case &#39;c&#39;:   / * Solaris: match by contract ID * /</span>
<span class="cm"> *                  break; */</span>
            <span class="k">case</span> <span class="sc">&#39;c&#39;</span><span class="o">:</span>
                    <span class="n">opt_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: change the delimiter */</span>
                    <span class="n">opt_delim</span> <span class="o">=</span> <span class="n">xstrdup</span> <span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match full process name (as in &quot;ps -f&quot;) */</span>
                    <span class="n">opt_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;g&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match pgrp */</span>
                    <span class="n">opt_pgrp</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_pgrp</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_pgrp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="cm">/*          case &#39;i&#39;:   / * FreeBSD: ignore case. OpenBSD: withdrawn. See -I. This sucks. * /</span>
<span class="cm"> *                  if (opt_case)</span>
<span class="cm"> *                          usage (opt);</span>
<span class="cm"> *                  opt_case = REG_ICASE;</span>
<span class="cm"> *                  break; */</span>
<span class="cm">/*          case &#39;j&#39;:   / * FreeBSD: restricted to the given jail ID * /</span>
<span class="cm"> *                  break; */</span>
            <span class="k">case</span> <span class="sc">&#39;l&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: long output format (pgrep only) Should require -f for beyond argv[0] maybe? */</span>
                    <span class="n">opt_long</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;a&#39;</span><span class="o">:</span>
                    <span class="n">opt_longlong</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match only the newest */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="o">|</span><span class="n">opt_negate</span><span class="o">|</span><span class="n">opt_newest</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="n">opt_newest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;o&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match only the oldest */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="o">|</span><span class="n">opt_negate</span><span class="o">|</span><span class="n">opt_newest</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="n">opt_oldest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;s&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match by session ID -- zero means self */</span>
                    <span class="n">opt_sid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_sid</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_sid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match by tty */</span>
                    <span class="n">opt_term</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_str</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_term</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;u&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: match by euid/egroup */</span>
                    <span class="n">opt_euid</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_uid</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_euid</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: as in grep, invert the matching (uh... applied after selection I think) */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="o">|</span><span class="n">opt_negate</span><span class="o">|</span><span class="n">opt_newest</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="n">opt_negate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;w&#39;</span><span class="o">:</span>   <span class="c1">// Linux: show threads (lightweight process) too</span>
                    <span class="n">opt_threads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="cm">/* OpenBSD -x, being broken, does a plain string */</span>
            <span class="k">case</span> <span class="sc">&#39;x&#39;</span><span class="o">:</span>   <span class="cm">/* Solaris: use ^(regexp)$ in place of regexp (FreeBSD too) */</span>
                    <span class="n">opt_exact</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
<span class="cm">/*          case &#39;z&#39;:   / * Solaris: match by zone ID * /</span>
<span class="cm"> *                  break; */</span>
            <span class="k">case</span> <span class="nl">NS_OPTION</span><span class="p">:</span>
                    <span class="n">opt_ns_pid</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_ns_pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="o">++</span><span class="n">criteria_count</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">NSLIST_OPTION</span><span class="p">:</span>
                    <span class="n">opt_nslist</span> <span class="o">=</span> <span class="n">split_list</span> <span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">conv_ns</span><span class="p">);</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_nslist</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                            <span class="n">usage</span> <span class="p">(</span><span class="sc">&#39;?&#39;</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
            <span class="k">case</span> <span class="sc">&#39;?&#39;</span><span class="o">:</span>
                    <span class="n">usage</span> <span class="p">(</span><span class="n">opt</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">opt_lock</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">opt_pidfile</span><span class="p">)</span>
            <span class="n">xerrx</span><span class="p">(</span><span class="n">EXIT_USAGE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;-L without -F makes no sense</span><span class="se">\n</span><span class="s">&quot;</span>
                                 <span class="s">&quot;Try `%s --help&#39; for more information.&quot;</span><span class="p">),</span>
                                 <span class="n">program_invocation_short_name</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">opt_pidfile</span><span class="p">){</span>
            <span class="n">opt_pid</span> <span class="o">=</span> <span class="n">read_pidfile</span><span class="p">();</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">opt_pid</span><span class="p">)</span>
                    <span class="n">xerrx</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;pidfile not valid</span><span class="se">\n</span><span class="s">&quot;</span>
                                         <span class="s">&quot;Try `%s --help&#39; for more information.&quot;</span><span class="p">),</span>
                                         <span class="n">program_invocation_short_name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="n">optind</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">opt_pattern</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">];</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="n">optind</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">xerrx</span><span class="p">(</span><span class="n">EXIT_USAGE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;only one pattern can be provided</span><span class="se">\n</span><span class="s">&quot;</span>
                                 <span class="s">&quot;Try `%s --help&#39; for more information.&quot;</span><span class="p">),</span>
                                 <span class="n">program_invocation_short_name</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">criteria_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">xerrx</span><span class="p">(</span><span class="n">EXIT_USAGE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;no matching criteria specified</span><span class="se">\n</span><span class="s">&quot;</span>
                                 <span class="s">&quot;Try `%s --help&#39; for more information.&quot;</span><span class="p">),</span>
                                 <span class="n">program_invocation_short_name</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">parse_opts</tt> 関数の811〜812行目で <tt class="docutils literal"><span class="pre">-a</span></tt> を指定すると <tt class="docutils literal">opt_longlong = 1</tt> と設定されることがわかります。
<tt class="docutils literal">main</tt> 関数を見ると <tt class="docutils literal">pgrep</tt> で <tt class="docutils literal"><span class="pre">-a</span></tt> を指定した場合は <tt class="docutils literal">opt_count</tt> は 0 で <tt class="docutils literal">opt_longlong</tt> が 1なので、938行目の <tt class="docutils literal">output_strlist</tt> が呼ばれます。</p>
<p><tt class="docutils literal">output_strlist</tt> 関数の実装。
<a class="reference external" href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/pgrep.c#L410-420">pgrep.c#L410-#L420</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>410
411
412
413
414
415
416
417
418
419
420</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">output_strlist</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">el</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* FIXME: escape codes */</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">delim</span> <span class="o">=</span> <span class="n">opt_delim</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="n">num</span><span class="p">)</span>
                    <span class="n">delim</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
            <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;%lu %s%s&quot;</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">,</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">str</span><span class="p">,</span> <span class="n">delim</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>ここは単に出力しているだけでした。</p>
<p><tt class="docutils literal">struct el</tt> の定義。
<a class="reference external" href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/pgrep.c#L60-63">pgrep.c#L60-#L63</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>60
61
62
63</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">el</span> <span class="p">{</span>
    <span class="kt">long</span>    <span class="n">num</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span>  <span class="n">str</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">main</tt> 関数の917行目の <tt class="docutils literal">select_procs</tt> 関数が中核です。</p>
<p><tt class="docutils literal">select_procs</tt> 関数の実装。
<a class="reference external" href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/pgrep.c#L482-655">pgrep.c#L482-#L655</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647
648
649
650
651
652
653
654
655</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="k">struct</span> <span class="n">el</span> <span class="o">*</span> <span class="nf">select_procs</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PROCTAB</span> <span class="o">*</span><span class="n">ptp</span><span class="p">;</span>
    <span class="n">proc_t</span> <span class="n">task</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">saved_start_time</span><span class="p">;</span>      <span class="cm">/* for new/old support */</span>
    <span class="kt">pid_t</span> <span class="n">saved_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                      <span class="cm">/* for new/old support */</span>
    <span class="kt">int</span> <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">regex_t</span> <span class="o">*</span><span class="n">preg</span><span class="p">;</span>
    <span class="kt">pid_t</span> <span class="n">myself</span> <span class="o">=</span> <span class="n">getpid</span><span class="p">();</span>
    <span class="k">struct</span> <span class="n">el</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">cmdline</span><span class="p">[</span><span class="n">CMDSTRSIZE</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">cmdsearch</span><span class="p">[</span><span class="n">CMDSTRSIZE</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">cmdoutput</span><span class="p">[</span><span class="n">CMDSTRSIZE</span><span class="p">];</span>
    <span class="n">proc_t</span> <span class="n">ns_task</span><span class="p">;</span>

    <span class="n">ptp</span> <span class="o">=</span> <span class="n">do_openproc</span><span class="p">();</span>
    <span class="n">preg</span> <span class="o">=</span> <span class="n">do_regcomp</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span><span class="p">)</span> <span class="n">saved_start_time</span> <span class="o">=</span>  <span class="mi">0ULL</span><span class="p">;</span>
    <span class="k">else</span> <span class="n">saved_start_time</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0ULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span><span class="p">)</span> <span class="n">saved_pid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="p">)</span> <span class="n">saved_pid</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">opt_ns_pid</span> <span class="o">&amp;&amp;</span> <span class="n">ns_read</span><span class="p">(</span><span class="n">opt_ns_pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns_task</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">fputs</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Error reading reference namespace information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
                  <span class="n">stderr</span><span class="p">);</span>
            <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FATAL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">task</span><span class="p">));</span>
    <span class="k">while</span><span class="p">(</span><span class="n">readproc</span><span class="p">(</span><span class="n">ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task</span><span class="p">))</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">XXXID</span> <span class="o">==</span> <span class="n">myself</span><span class="p">)</span>
                    <span class="k">continue</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&lt;</span> <span class="n">saved_start_time</span><span class="p">)</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">saved_start_time</span><span class="p">)</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_ppid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">ppid</span><span class="p">,</span> <span class="n">opt_ppid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_pid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">tgid</span><span class="p">,</span> <span class="n">opt_pid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_pgrp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">pgrp</span><span class="p">,</span> <span class="n">opt_pgrp</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_euid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">euid</span><span class="p">,</span> <span class="n">opt_euid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_ruid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">ruid</span><span class="p">,</span> <span class="n">opt_ruid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_rgid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">rgid</span><span class="p">,</span> <span class="n">opt_rgid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_sid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_numlist</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">session</span><span class="p">,</span> <span class="n">opt_sid</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_ns_pid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">match_ns</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns_task</span><span class="p">))</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">opt_term</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">tty</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="kt">char</span> <span class="n">tty</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
                            <span class="n">dev_to_tty</span> <span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="n">task</span><span class="p">.</span><span class="n">tty</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">,</span> <span class="n">ABBREV_DEV</span><span class="p">);</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="n">match_strlist</span> <span class="p">(</span><span class="n">tty</span><span class="p">,</span> <span class="n">opt_term</span><span class="p">);</span>
                    <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">opt_longlong</span> <span class="o">||</span> <span class="n">opt_full</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

                    <span class="cm">/* make sure it is always NUL-terminated */</span>
                    <span class="n">cmdline</span><span class="p">[</span><span class="n">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="cm">/* make room for SPC in loop below */</span>
                    <span class="o">--</span><span class="n">bytes</span><span class="p">;</span>

                    <span class="n">strncpy</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bytes</span><span class="p">);</span>
                    <span class="n">bytes</span> <span class="o">-=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>
                    <span class="k">while</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">strncat</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
                            <span class="n">strncat</span> <span class="p">(</span><span class="n">cmdline</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bytes</span><span class="p">);</span>
                            <span class="n">bytes</span> <span class="o">-=</span> <span class="n">strlen</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">opt_long</span> <span class="o">||</span> <span class="n">opt_longlong</span> <span class="o">||</span> <span class="p">(</span><span class="n">match</span> <span class="o">&amp;&amp;</span> <span class="n">opt_pattern</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_longlong</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">)</span>
                            <span class="n">strncpy</span> <span class="p">(</span><span class="n">cmdoutput</span><span class="p">,</span> <span class="n">cmdline</span><span class="p">,</span> <span class="n">CMDSTRSIZE</span><span class="p">);</span>
                    <span class="k">else</span>
                            <span class="n">strncpy</span> <span class="p">(</span><span class="n">cmdoutput</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">CMDSTRSIZE</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">&amp;&amp;</span> <span class="n">opt_pattern</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_full</span> <span class="o">&amp;&amp;</span> <span class="n">task</span><span class="p">.</span><span class="n">cmdline</span><span class="p">)</span>
                            <span class="n">strncpy</span> <span class="p">(</span><span class="n">cmdsearch</span><span class="p">,</span> <span class="n">cmdline</span><span class="p">,</span> <span class="n">CMDSTRSIZE</span><span class="p">);</span>
                    <span class="k">else</span>
                            <span class="n">strncpy</span> <span class="p">(</span><span class="n">cmdsearch</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">CMDSTRSIZE</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">regexec</span> <span class="p">(</span><span class="n">preg</span><span class="p">,</span> <span class="n">cmdsearch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">^</span> <span class="n">opt_negate</span><span class="p">)</span> <span class="p">{</span>       <span class="cm">/* Exclusive OR is neat */</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_newest</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">saved_start_time</span> <span class="o">==</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&amp;&amp;</span>
                                <span class="n">saved_pid</span> <span class="o">&gt;</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">)</span>
                                    <span class="k">continue</span><span class="p">;</span>
                            <span class="n">saved_start_time</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span><span class="p">;</span>
                            <span class="n">saved_pid</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
                            <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_oldest</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">saved_start_time</span> <span class="o">==</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span> <span class="o">&amp;&amp;</span>
                                <span class="n">saved_pid</span> <span class="o">&lt;</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">)</span>
                                    <span class="k">continue</span><span class="p">;</span>
                            <span class="n">saved_start_time</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">start_time</span><span class="p">;</span>
                            <span class="n">saved_pid</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
                            <span class="n">matches</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">matches</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
                            <span class="n">list</span> <span class="o">=</span> <span class="n">xrealloc</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">list</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">opt_long</span> <span class="o">||</span> <span class="n">opt_longlong</span> <span class="o">||</span> <span class="n">opt_echo</span><span class="p">))</span> <span class="p">{</span>
                            <span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
                            <span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="o">++</span><span class="p">].</span><span class="n">str</span> <span class="o">=</span> <span class="n">xstrdup</span> <span class="p">(</span><span class="n">cmdoutput</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="o">++</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">xerrx</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;internal error&quot;</span><span class="p">));</span>
                    <span class="p">}</span>

                    <span class="c1">// pkill does not need subtasks!</span>
                    <span class="c1">// this control is still done at</span>
                    <span class="c1">// argparse time, but a further</span>
                    <span class="c1">// control is free</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_threads</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">i_am_pkill</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">proc_t</span> <span class="n">subtask</span><span class="p">;</span>
                            <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subtask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">subtask</span><span class="p">));</span>
                            <span class="k">while</span> <span class="p">(</span><span class="n">readtask</span><span class="p">(</span><span class="n">ptp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">task</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">subtask</span><span class="p">)){</span>
                                    <span class="c1">// don&#39;t add redundand tasks</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">XXXID</span> <span class="o">==</span> <span class="n">subtask</span><span class="p">.</span><span class="n">XXXID</span><span class="p">)</span>
                                            <span class="k">continue</span><span class="p">;</span>

                                    <span class="c1">// eventually grow output buffer</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">matches</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
                                            <span class="n">list</span> <span class="o">=</span> <span class="n">realloc</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">list</span><span class="p">);</span>
                                            <span class="k">if</span> <span class="p">(</span><span class="n">list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
                                                    <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FATAL</span><span class="p">);</span>
                                    <span class="p">}</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="n">opt_long</span><span class="p">)</span> <span class="p">{</span>
                                            <span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="p">].</span><span class="n">str</span> <span class="o">=</span> <span class="n">xstrdup</span> <span class="p">(</span><span class="n">cmdoutput</span><span class="p">);</span>
                                            <span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="o">++</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">subtask</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
                                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                            <span class="n">list</span><span class="p">[</span><span class="n">matches</span><span class="o">++</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">subtask</span><span class="p">.</span><span class="n">XXXID</span><span class="p">;</span>
                                    <span class="p">}</span>
                                    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">subtask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">subtask</span><span class="p">));</span>
                            <span class="p">}</span>
                    <span class="p">}</span>



            <span class="p">}</span>





            <span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">task</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">closeproc</span> <span class="p">(</span><span class="n">ptp</span><span class="p">);</span>
    <span class="o">*</span><span class="n">num</span> <span class="o">=</span> <span class="n">matches</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">list</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>574〜580行目で <tt class="docutils literal">opt_full</tt> が0以外かつ <tt class="docutils literal">task.cmdline</tt> がNULL以外なら <tt class="docutils literal">cmdline</tt> が、そうでなければ <tt class="docutils literal">task.cmd</tt> が検索対象になることがわかりました。</p>
<p>呼び出しの途中は省略しますが、 <tt class="docutils literal">stat2proc</tt> 関数の実装（抜粋）
<a class="reference external" href="https://gitlab.com/procps-ng/procps/blob/v3.3.10/proc/readproc.c#L548-567">proc/readproc.c#L548-#L567</a>
を見ると <tt class="docutils literal">task.cmd</tt> は <tt class="docutils literal"><span class="pre">/proc/*/stat</span></tt> の <tt class="docutils literal">(</tt> と <tt class="docutils literal">)</tt> の間の部分になることがわかりました。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Reads /proc/*/stat files, being careful not to trip over processes with</span>
<span class="c1">// names like &quot;:-) 1 2 3 4 5 6&quot;.</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stat2proc</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">S</span><span class="p">,</span> <span class="n">proc_t</span> <span class="o">*</span><span class="kr">restrict</span> <span class="n">P</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">num</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">tmp</span><span class="p">;</span>

<span class="n">ENTER</span><span class="p">(</span><span class="mh">0x160</span><span class="p">);</span>

    <span class="cm">/* fill in default values for older kernels */</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">processor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">rtprio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">nlwp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">S</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="sc">&#39;(&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">strrchr</span><span class="p">(</span><span class="n">S</span><span class="p">,</span> <span class="sc">&#39;)&#39;</span><span class="p">);</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">S</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="k">sizeof</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">))</span> <span class="n">num</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">num</span><span class="p">);</span>
    <span class="n">P</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</pre></div>
</td></tr></table><p><tt class="docutils literal">ps auxww | grep traffic</tt> と <tt class="docutils literal">cat <span class="pre">/proc/${PID}/stat</span></tt> の結果を比べてみました。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">[root@ats7 ~]#</span> ps auxww <span class="p">|</span> grep traffic
<span class="go">root     20837  0.0  0.0 143076  6276 ?        Ssl  15:14   0:00 /opt/trafficserver/bin/traffic_cop</span>
<span class="go">ats      20838  0.0  0.0 448784 11960 ?        Sl   15:14   0:00 /opt/trafficserver/bin/traffic_manager --bind_stdout /opt/trafficserver/var/logs/traffic.out --bind_stderr /opt/trafficserver/var/logs/traffic.out</span>
<span class="go">ats      20877  0.0  0.3 1047868 55464 ?       Sl   15:14   0:00 /opt/trafficserver/bin/traffic_server -M --bind_stdout /opt/trafficserver/var/logs/traffic.out --bind_stderr /opt/trafficserver/var/logs/traffic.out --httpport 8080:fd=9,8080:fd=10:ipv6</span>
<span class="go">root     20992  0.0  0.0   9040   852 ?        S+   15:15   0:00 grep --color=auto traffic</span>
<span class="gp">[root@ats7 ~]#</span> cat /proc/20837/stat
<span class="go">20837 (traffic_cop) S 1 20837 20837 0 -1 1077936384 489 0 6 0 4 24 0 0 20 0 2 0 553918400 146509824 1569 18446744073709551615 94079978</span>
<span class="go">950656 94079979051376 140726768039552 140726768030720 140350454315997 0 0 3674113 91342 0 0 0 17 0 0 0 9 0 0 94079981152352 9407998120</span>
<span class="go">3568 94079988858880 140726768041851 140726768041886 140726768041886 140726768041941 0</span>
<span class="gp">[root@ats7 ~]#</span> cat /proc/20838/stat
<span class="go">20838 (traffic_manager) S 20837 20837 20837 0 -1 4194560 1461 0 1 0 472 63 0 0 20 0 6 0 553918413 459685888 2990 18446744073709551615</span>
<span class="go">94657453907968 94657455120371 140723571977072 140723571830272 139779374492579 0 2147193488 3670016 93263 0 0 0 17 1 0 0 0 0 0 94657457</span>
<span class="go">217984 94657457272704 94657464983552 140723571982087 140723571982234 140723571982234 140723571982289 0</span>
<span class="gp">[root@ats7 ~]#</span> cat /proc/20877/stat
<span class="go">20877 ([TS_MAIN]) S 20838 20837 20837 0 -1 1077936384 26525 0 0 0 1101 3438 0 0 20 0 20 0 553918517 1140125696 13868 18446744073709551</span>
<span class="go">615 94103198183424 94103202477292 140734131727600 140734131721984 46982532413037 0 0 3674113 20222 0 0 0 17 1 0 0 1 0 0 94103204576832</span>
<span class="go"> 94103204684656 94103237705728 140734131732164 140734131732350 140734131732350 140734131732434 0</span>
<span class="gp">[root@ats7 ~]#</span> cat /proc/20878/stat
<span class="go">20878 (traffic_server) S 20838 20837 20837 0 -1 1077936448 26787 0 0 0 1115 3478 0 0 20 0 20 0 553918520 1140125696 13870 184467440737</span>
<span class="go">09551615 94103198183424 94103202477292 140734131727600 46982562638768 46982532413037 0 2147193488 3674113 20222 0 0 0 -1 1 0 0 0 0 0 9</span>
<span class="go">4103204576832 94103204684656 94103237705728 140734131732164 140734131732350 140734131732350 140734131732434 0</span>
</pre></div>
</td></tr></table><p>20877 のプロセスは <tt class="docutils literal">ps auxww</tt> で見るとコマンドラインのコマンド部分は <tt class="docutils literal">/opt/trafficserver/bin/traffic_server</tt> となっていますが、
<tt class="docutils literal">/proc/20877/stat</tt> の <tt class="docutils literal">(</tt> と <tt class="docutils literal">)</tt> の間は <tt class="docutils literal">[TS_MAIN]</tt> となっているので <tt class="docutils literal">pgrep</tt> では検索がマッチせず出力されないんですね。</p>
<p>試しに <tt class="docutils literal">/proc/20878/stat</tt> を見るとそちらは <tt class="docutils literal">(</tt> と <tt class="docutils literal">)</tt> の間が <tt class="docutils literal">traffic_server</tt> となっていました。
が、 <tt class="docutils literal">ps auxww</tt> で見ると PID=20878 のプロセスは存在していませんでした。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>