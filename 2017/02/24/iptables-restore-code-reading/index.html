<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.87.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>iptables-restoreのコードリーディング &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>iptables-restoreのコードリーディング</h1>
  <time datetime=2017-02-24T00:25:00&#43;0900 class="post-date">2017-02-24</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#main関数からの流れ">main関数からの流れ</a></li>
    <li><a href="#set_policy関連">set_policy関連</a></li>
    <li><a href="#do_command4">do_command4</a></li>
    <li><a href="#commit">commit</a></li>
    <li><a href="#まとめ">まとめ</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><code>iptables-restore</code> のコードリーディングをしてみました。
対象バージョンは CentOS 7 のパッケージに合わせて 1.4.21 です。</p>
<pre><code class="language-console" data-lang="console">$ rpm -qf `which iptables-restore`
iptables-1.4.21-17.el7.x86_64
</code></pre><p>プロジェクトページは <a href="http://www.netfilter.org/">netfilter/iptables project homepage - The netfilter.org project</a> で、
ブラウザで見られるレポジトリは <a href="https://git.netfilter.org/iptables/">iptables - iptables tree</a> です。</p>
<h2 id="main関数からの流れ">main関数からの流れ</h2>
<p><code>main</code> 関数の定義。
<a href="https://git.netfilter.org/iptables/tree/xtables-multi.c?id=482c6d3731e2681cb4baae835c294840300197e6#n16">xtables-multi.c#L16-#L41</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">subcommand</span> <span class="n">multi_subcommands</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef ENABLE_IPV4
</span><span class="cp"></span>	<span class="p">{</span><span class="s">&#34;iptables&#34;</span><span class="p">,</span>            <span class="n">iptables_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;main4&#34;</span><span class="p">,</span>               <span class="n">iptables_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;iptables-save&#34;</span><span class="p">,</span>       <span class="n">iptables_save_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;save4&#34;</span><span class="p">,</span>               <span class="n">iptables_save_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;iptables-restore&#34;</span><span class="p">,</span>    <span class="n">iptables_restore_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;restore4&#34;</span><span class="p">,</span>            <span class="n">iptables_restore_main</span><span class="p">},</span>
<span class="cp">#endif
</span><span class="cp"></span>	<span class="p">{</span><span class="s">&#34;iptables-xml&#34;</span><span class="p">,</span>        <span class="n">iptables_xml_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;xml&#34;</span><span class="p">,</span>                 <span class="n">iptables_xml_main</span><span class="p">},</span>
<span class="cp">#ifdef ENABLE_IPV6
</span><span class="cp"></span>	<span class="p">{</span><span class="s">&#34;ip6tables&#34;</span><span class="p">,</span>           <span class="n">ip6tables_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;main6&#34;</span><span class="p">,</span>               <span class="n">ip6tables_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;ip6tables-save&#34;</span><span class="p">,</span>      <span class="n">ip6tables_save_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;save6&#34;</span><span class="p">,</span>               <span class="n">ip6tables_save_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;ip6tables-restore&#34;</span><span class="p">,</span>   <span class="n">ip6tables_restore_main</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&#34;restore6&#34;</span><span class="p">,</span>            <span class="n">ip6tables_restore_main</span><span class="p">},</span>
<span class="cp">#endif
</span><span class="cp"></span>	<span class="p">{</span><span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">subcmd_main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="n">multi_subcommands</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>subcmd_main</code> 関数の実装。
<a href="https://git.netfilter.org/iptables/tree/xshared.c?id=482c6d3731e2681cb4baae835c294840300197e6#n191">xshared.c#L191-#L214</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">subcmd_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">subcommand</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">basename</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">);</span>
	<span class="n">mainfunc_t</span> <span class="n">f</span> <span class="o">=</span> <span class="n">subcmd_get</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*
</span><span class="cm">		 * Unable to find a main method for our command name?
</span><span class="cm">		 * Let&#39;s try again with the first argument!
</span><span class="cm">		 */</span>
		<span class="o">++</span><span class="n">argv</span><span class="p">;</span>
		<span class="o">--</span><span class="n">argc</span><span class="p">;</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">subcmd_get</span><span class="p">(</span><span class="o">*</span><span class="n">argv</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* now we should have a valid function pointer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;ERROR: No valid subcommand given.</span><span class="se">\n</span><span class="s">Valid subcommands:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="o">++</span><span class="n">cb</span><span class="p">)</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34; * %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>subcmd_get</code> 関数の実装。
<a href="https://git.netfilter.org/iptables/tree/xshared.c?id=482c6d3731e2681cb4baae835c294840300197e6#n183">xshared.c#L183-#L189</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">mainfunc_t</span> <span class="nf">subcmd_get</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">subcommand</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="o">++</span><span class="n">cb</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">cb</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>iptables_restore_main</code> 関数の実装。
<a href="https://git.netfilter.org/iptables/tree/iptables-restore.c?id=482c6d3731e2681cb4baae835c294840300197e6#n180">iptables-restore.c#L180-#L462</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span>
<span class="nf">iptables_restore_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xtc_handle</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">10240</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">curtable</span><span class="p">[</span><span class="n">XT_TABLE_MAXNAMELEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">FILE</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_table</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">testing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tablename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">xtc_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iptc_ops</span><span class="p">;</span>

	<span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iptables_globals</span><span class="p">.</span><span class="n">program_name</span> <span class="o">=</span> <span class="s">&#34;iptables-restore&#34;</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">xtables_init_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iptables_globals</span><span class="p">,</span> <span class="n">NFPROTO_IPV4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;%s/%s Failed to initialize xtables</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
				<span class="n">iptables_globals</span><span class="p">.</span><span class="n">program_name</span><span class="p">,</span>
				<span class="n">iptables_globals</span><span class="p">.</span><span class="n">program_version</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#if defined(ALL_INCLUSIVE) || defined(NO_SHARED_LIBS)
</span><span class="cp"></span>	<span class="n">init_extensions</span><span class="p">();</span>
	<span class="n">init_extensions4</span><span class="p">();</span>
<span class="cp">#endif
</span><span class="cp"></span>
	<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="s">&#34;bcvthnM:T:&#34;</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;b&#39;</span><span class="o">:</span>
				<span class="n">binary</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;c&#39;</span><span class="o">:</span>
				<span class="n">counters</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>
				<span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>
				<span class="n">testing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
				<span class="n">print_usage</span><span class="p">(</span><span class="s">&#34;iptables-restore&#34;</span><span class="p">,</span>
					    <span class="n">IPTABLES_VERSION</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>
				<span class="n">noflush</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;M&#39;</span><span class="o">:</span>
				<span class="n">xtables_modprobe_program</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;T&#39;</span><span class="o">:</span>
				<span class="n">tablename</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">==</span> <span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">in</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">],</span> <span class="s">&#34;re&#34;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Can&#39;t open %s: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">],</span>
				<span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Unknown arguments found on commandline</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="n">in</span> <span class="o">=</span> <span class="n">stdin</span><span class="p">;</span>

	<span class="cm">/* Grab standard input. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">in</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">line</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
				<span class="n">fputs</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&#34;COMMIT</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">in_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">testing</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;Calling commit</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">commit</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
				<span class="n">ops</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
				<span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;Not calling commit, testing</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">in_table</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">in_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* New table */</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>

			<span class="n">table</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34; </span><span class="se">\t\n</span><span class="s">&#34;</span><span class="p">);</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;line %u, table &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">table</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					<span class="s">&#34;%s: line %u table name invalid</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
					<span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">curtable</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">XT_TABLE_MAXNAMELEN</span><span class="p">);</span>
			<span class="n">curtable</span><span class="p">[</span><span class="n">XT_TABLE_MAXNAMELEN</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tablename</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="p">)</span>
				<span class="n">ops</span><span class="o">-&gt;</span><span class="n">free</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

			<span class="n">handle</span> <span class="o">=</span> <span class="n">create_handle</span><span class="p">(</span><span class="n">table</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">noflush</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;Cleaning all chains of table &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
					<span class="n">table</span><span class="p">);</span>
				<span class="n">for_each_chain4</span><span class="p">(</span><span class="n">flush_entries4</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						<span class="n">handle</span><span class="p">);</span>

				<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;Deleting all user-defined chains &#34;</span>
				       <span class="s">&#34;of table &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>
				<span class="n">for_each_chain4</span><span class="p">(</span><span class="n">delete_chain4</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">handle</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">in_table</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">in_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* New chain. */</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">policy</span><span class="p">,</span> <span class="o">*</span><span class="n">chain</span><span class="p">;</span>

			<span class="n">chain</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34; </span><span class="se">\t\n</span><span class="s">&#34;</span><span class="p">);</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;line %u, chain &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;%s: line %u chain name invalid</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
					   <span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">XT_EXTENSION_MAXNAMELEN</span><span class="p">)</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;Invalid chain name `%s&#39; &#34;</span>
					   <span class="s">&#34;(%u chars max)&#34;</span><span class="p">,</span>
					   <span class="n">chain</span><span class="p">,</span> <span class="n">XT_EXTENSION_MAXNAMELEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">builtin</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">noflush</span> <span class="o">&amp;&amp;</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;Flushing existing user defined chain &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_entries</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">handle</span><span class="p">))</span>
						<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
							   <span class="s">&#34;error flushing chain &#34;</span>
							   <span class="s">&#34;&#39;%s&#39;:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span>
							   <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;Creating new chain &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">create_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">handle</span><span class="p">))</span>
						<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
							   <span class="s">&#34;error creating chain &#34;</span>
							   <span class="s">&#34;&#39;%s&#39;:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span>
							   <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">policy</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34; </span><span class="se">\t\n</span><span class="s">&#34;</span><span class="p">);</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;line %u, policy &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">policy</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">policy</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;%s: line %u policy invalid</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
					   <span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
				<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="s">&#34;-&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">xt_counters</span> <span class="n">count</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">counters</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">ctrs</span><span class="p">;</span>
					<span class="n">ctrs</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34; </span><span class="se">\t\n</span><span class="s">&#34;</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrs</span> <span class="o">||</span> <span class="o">!</span><span class="n">parse_counters</span><span class="p">(</span><span class="n">ctrs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">))</span>
						<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
							   <span class="s">&#34;invalid policy counters &#34;</span>
							   <span class="s">&#34;for chain &#39;%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">count</span><span class="p">));</span>
				<span class="p">}</span>

				<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;Setting policy of chain %s to %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
					<span class="n">chain</span><span class="p">,</span> <span class="n">policy</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_policy</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">count</span><span class="p">,</span>
						     <span class="n">handle</span><span class="p">))</span>
					<span class="n">xtables_error</span><span class="p">(</span><span class="n">OTHER_PROBLEM</span><span class="p">,</span>
						<span class="s">&#34;Can&#39;t set policy `%s&#39;&#34;</span>
						<span class="s">&#34; on `%s&#39; line %u: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
						<span class="n">policy</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span>
						<span class="n">ops</span><span class="o">-&gt;</span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">in_table</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">pcnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">bcnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">parsestart</span><span class="p">;</span>

			<span class="cm">/* reset the newargv */</span>
			<span class="n">newargc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* we have counters in our input */</span>
				<span class="n">ptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="sc">&#39;]&#39;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
					<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
						   <span class="s">&#34;Bad line %u: need ]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
						   <span class="n">line</span><span class="p">);</span>

				<span class="n">pcnt</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#34;:&#34;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcnt</span><span class="p">)</span>
					<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
						   <span class="s">&#34;Bad line %u: need :</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
						   <span class="n">line</span><span class="p">);</span>

				<span class="n">bcnt</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;]&#34;</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcnt</span><span class="p">)</span>
					<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
						   <span class="s">&#34;Bad line %u: need ]</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
						   <span class="n">line</span><span class="p">);</span>

				<span class="cm">/* start command parsing after counter */</span>
				<span class="n">parsestart</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* start command parsing at start of line */</span>
				<span class="n">parsestart</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">add_argv</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">add_argv</span><span class="p">(</span><span class="s">&#34;-t&#34;</span><span class="p">);</span>
			<span class="n">add_argv</span><span class="p">(</span><span class="n">curtable</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">counters</span> <span class="o">&amp;&amp;</span> <span class="n">pcnt</span> <span class="o">&amp;&amp;</span> <span class="n">bcnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">add_argv</span><span class="p">(</span><span class="s">&#34;--set-counters&#34;</span><span class="p">);</span>
				<span class="n">add_argv</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pcnt</span><span class="p">);</span>
				<span class="n">add_argv</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">bcnt</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">add_param_to_argv</span><span class="p">(</span><span class="n">parsestart</span><span class="p">);</span>

			<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;calling do_command4(%u, argv, &amp;%s, handle):</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
				<span class="n">newargc</span><span class="p">,</span> <span class="n">curtable</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">newargc</span><span class="p">;</span> <span class="n">a</span><span class="o">++</span><span class="p">)</span>
				<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;argv[%u]: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">newargv</span><span class="p">[</span><span class="n">a</span><span class="p">]);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">do_command4</span><span class="p">(</span><span class="n">newargc</span><span class="p">,</span> <span class="n">newargv</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">newargv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

			<span class="n">free_argv</span><span class="p">();</span>
			<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tablename</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">tablename</span><span class="p">,</span> <span class="n">curtable</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;%s: line %u failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
					<span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;%s: COMMIT expected at line %u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
				<span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fclose</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>256行目: 空行はスキップ。</p>
</li>
<li>
<p>258行目: <code>#</code> で始まる行はスキップ(コメント)。</p>
</li>
<li>
<p>262行目: テーブル内を処理中に <code>COMMIT</code> の行が来たらコミット処理を行い、テーブル終了。</p>
</li>
<li>
<p>273行目: テーブルの外にいるときに行頭が <code>*</code> のときはテーブル開始。</p>
<ul>
<li><code>*</code> の後 <code>' '</code>, <code>'\t'</code>, <code>'\n'</code> のどれかの手前までをテーブル名と解釈。</li>
</ul>
</li>
<li>
<p>309行目: テーブル内で行頭が <code>:</code> のときはチェーン開始。</p>
<ul>
<li><code>:</code> の後 <code>' '</code>, <code>'\t'</code>, <code>'\n'</code>  のどれかの手前までをチェーン名と解釈。</li>
<li>その後次の <code>' '</code>, <code>'\t'</code>, <code>'\n'</code>  のどれかの手前までをポリシーと解釈。</li>
<li>ポリシーが <code>-</code> 以外の場合は <code>-c</code> オプションを指定していた場合はその後のカウンター部分を解釈。</li>
</ul>
</li>
<li>
<p>385行目: テーブル内で行頭が <code>:</code> 以外の時</p>
<ul>
<li>行頭が <code>[</code> の時はカウンタ( <code>[整数:整数]</code> 形式)とコマンドを処理。</li>
<li>行頭が <code>[</code> でない時はコマンドを処理。</li>
</ul>
</li>
<li>
<p>454行目: ファイルの終端まで来てテーブル内のままの時は <code>COMMIT</code> の呼び忘れとみなしてエラーで終了。</p>
</li>
</ul>
<p><code>parse_counters</code> 関数の定義。
<a href="https://git.netfilter.org/iptables/tree/iptables-restore.c?id=482c6d3731e2681cb4baae835c294840300197e6#n79">iptables-restore.c#L79-#L88</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_counters</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">string</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xt_counters</span> <span class="o">*</span><span class="n">ctr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">pcnt</span><span class="p">,</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">&#34;[%llu:%llu]&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcnt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bcnt</span><span class="p">);</span>
	<span class="n">ctr</span><span class="o">-&gt;</span><span class="n">pcnt</span> <span class="o">=</span> <span class="n">pcnt</span><span class="p">;</span>
	<span class="n">ctr</span><span class="o">-&gt;</span><span class="n">bcnt</span> <span class="o">=</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="set_policy関連">set_policy関連</h2>
<p><a href="https://git.netfilter.org/iptables/tree/libiptc/libiptc.c?id=482c6d3731e2681cb4baae835c294840300197e6#n2747">libiptc/libiptc.c#L2747-#L2756</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2747
</span><span class="lnt">2748
</span><span class="lnt">2749
</span><span class="lnt">2750
</span><span class="lnt">2751
</span><span class="lnt">2752
</span><span class="lnt">2753
</span><span class="lnt">2754
</span><span class="lnt">2755
</span><span class="lnt">2756
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">const</span> <span class="k">struct</span> <span class="n">xtc_ops</span> <span class="n">TC_OPS</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">commit</span>        <span class="o">=</span> <span class="n">TC_COMMIT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span>          <span class="o">=</span> <span class="n">TC_FREE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">builtin</span>       <span class="o">=</span> <span class="n">TC_BUILTIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_chain</span>      <span class="o">=</span> <span class="n">TC_IS_CHAIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_entries</span> <span class="o">=</span> <span class="n">TC_FLUSH_ENTRIES</span><span class="p">,</span>
	<span class="p">.</span><span class="n">create_chain</span>  <span class="o">=</span> <span class="n">TC_CREATE_CHAIN</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_policy</span>    <span class="o">=</span> <span class="n">TC_SET_POLICY</span><span class="p">,</span>
	<span class="p">.</span><span class="n">strerror</span>      <span class="o">=</span> <span class="n">TC_STRERROR</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libiptc/libip4tc.c?id=482c6d3731e2681cb4baae835c294840300197e6#n85">libiptc/libip4tc.c#L85</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define TC_SET_POLICY		iptc_set_policy
</span></code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libiptc/libiptc.c?id=482c6d3731e2681cb4baae835c294840300197e6#n2406">libiptc/libiptc.c#L2406-#L2449</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2406
</span><span class="lnt">2407
</span><span class="lnt">2408
</span><span class="lnt">2409
</span><span class="lnt">2410
</span><span class="lnt">2411
</span><span class="lnt">2412
</span><span class="lnt">2413
</span><span class="lnt">2414
</span><span class="lnt">2415
</span><span class="lnt">2416
</span><span class="lnt">2417
</span><span class="lnt">2418
</span><span class="lnt">2419
</span><span class="lnt">2420
</span><span class="lnt">2421
</span><span class="lnt">2422
</span><span class="lnt">2423
</span><span class="lnt">2424
</span><span class="lnt">2425
</span><span class="lnt">2426
</span><span class="lnt">2427
</span><span class="lnt">2428
</span><span class="lnt">2429
</span><span class="lnt">2430
</span><span class="lnt">2431
</span><span class="lnt">2432
</span><span class="lnt">2433
</span><span class="lnt">2434
</span><span class="lnt">2435
</span><span class="lnt">2436
</span><span class="lnt">2437
</span><span class="lnt">2438
</span><span class="lnt">2439
</span><span class="lnt">2440
</span><span class="lnt">2441
</span><span class="lnt">2442
</span><span class="lnt">2443
</span><span class="lnt">2444
</span><span class="lnt">2445
</span><span class="lnt">2446
</span><span class="lnt">2447
</span><span class="lnt">2448
</span><span class="lnt">2449
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* Sets the policy on a built-in chain. */</span>
<span class="kt">int</span>
<span class="nf">TC_SET_POLICY</span><span class="p">(</span><span class="k">const</span> <span class="n">IPT_CHAINLABEL</span> <span class="n">chain</span><span class="p">,</span>
	      <span class="k">const</span> <span class="n">IPT_CHAINLABEL</span> <span class="n">policy</span><span class="p">,</span>
	      <span class="n">STRUCT_COUNTERS</span> <span class="o">*</span><span class="n">counters</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">xtc_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">chain_head</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">iptc_fn</span> <span class="o">=</span> <span class="n">TC_SET_POLICY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">iptcc_find_label</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;cannot find chain `%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iptcc_is_builtin</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;cannot set policy of userdefinedchain `%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">LABEL_ACCEPT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">verdict</span> <span class="o">=</span> <span class="o">-</span><span class="n">NF_ACCEPT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">LABEL_DROP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">verdict</span> <span class="o">=</span> <span class="o">-</span><span class="n">NF_DROP</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">counters</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set byte and packet counters */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">,</span> <span class="n">counters</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STRUCT_COUNTERS</span><span class="p">));</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">counter_map</span><span class="p">.</span><span class="n">maptype</span> <span class="o">=</span> <span class="n">COUNTER_MAP_SET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">counter_map</span><span class="p">.</span><span class="n">maptype</span> <span class="o">=</span> <span class="n">COUNTER_MAP_NOMAP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_changed</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>2438行目のif文を見ると引数の <code>counters</code> が <code>NULL</code> の場合は2443行目で <code>c-&gt;counter_map.maptype</code> が <code>COUNTER_MAP_NOMAP</code> にセットされます。
ですが <code>iptables_restore_main</code> 関数の356〜380行目を見ると <code>-c</code> オプションを指定するしないに関わらず、 <code>set_policy</code> の <code>counters</code> に <code>NULL</code> でない値を渡していますので、 2441行目で <code>c-&gt;counter_map.maptype</code> が <code>COUNTER_MAP_SET</code> にセットされます。</p>
<p><a href="https://git.netfilter.org/iptables/tree/libiptc/libiptc.c?id=482c6d3731e2681cb4baae835c294840300197e6#n107">libiptc/libiptc.c#L107-#L125</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">chain_head</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">TABLE_MAXNAMELEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hooknum</span><span class="p">;</span>		<span class="cm">/* hook number+1 if builtin */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">references</span><span class="p">;</span>	<span class="cm">/* how many jumps reference us */</span>
	<span class="kt">int</span> <span class="n">verdict</span><span class="p">;</span>			<span class="cm">/* verdict if builtin */</span>

	<span class="n">STRUCT_COUNTERS</span> <span class="n">counters</span><span class="p">;</span>	<span class="cm">/* per-chain counters */</span>
	<span class="k">struct</span> <span class="n">counter_map</span> <span class="n">counter_map</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_rules</span><span class="p">;</span>		<span class="cm">/* number of rules in list */</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">rules</span><span class="p">;</span>		<span class="cm">/* list of rules */</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>		<span class="cm">/* index (needed for jump resolval) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">head_offset</span><span class="p">;</span>	<span class="cm">/* offset in rule blob */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">foot_index</span><span class="p">;</span>	<span class="cm">/* index (needed for counter_map) */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">foot_offset</span><span class="p">;</span>	<span class="cm">/* offset in rule blob */</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libiptc/linux_list.h?id=482c6d3731e2681cb4baae835c294840300197e6#n43">libiptc/linux_list.h#L43-#L55</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * Simple doubly linked list implementation.
</span><span class="cm"> *
</span><span class="cm"> * Some of the internal functions (&#34;__xxx&#34;) are useful when
</span><span class="cm"> * manipulating whole lists rather than single entries, as
</span><span class="cm"> * sometimes we already know the next/prev entries and we can
</span><span class="cm"> * generate better code by using them directly rather than
</span><span class="cm"> * using the generic single-entry routines.
</span><span class="cm"> */</span>

<span class="k">struct</span> <span class="n">list_head</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libiptc/libiptc.c?id=482c6d3731e2681cb4baae835c294840300197e6#n710">libiptc/libiptc.c#L710-#L785</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span><span class="lnt">732
</span><span class="lnt">733
</span><span class="lnt">734
</span><span class="lnt">735
</span><span class="lnt">736
</span><span class="lnt">737
</span><span class="lnt">738
</span><span class="lnt">739
</span><span class="lnt">740
</span><span class="lnt">741
</span><span class="lnt">742
</span><span class="lnt">743
</span><span class="lnt">744
</span><span class="lnt">745
</span><span class="lnt">746
</span><span class="lnt">747
</span><span class="lnt">748
</span><span class="lnt">749
</span><span class="lnt">750
</span><span class="lnt">751
</span><span class="lnt">752
</span><span class="lnt">753
</span><span class="lnt">754
</span><span class="lnt">755
</span><span class="lnt">756
</span><span class="lnt">757
</span><span class="lnt">758
</span><span class="lnt">759
</span><span class="lnt">760
</span><span class="lnt">761
</span><span class="lnt">762
</span><span class="lnt">763
</span><span class="lnt">764
</span><span class="lnt">765
</span><span class="lnt">766
</span><span class="lnt">767
</span><span class="lnt">768
</span><span class="lnt">769
</span><span class="lnt">770
</span><span class="lnt">771
</span><span class="lnt">772
</span><span class="lnt">773
</span><span class="lnt">774
</span><span class="lnt">775
</span><span class="lnt">776
</span><span class="lnt">777
</span><span class="lnt">778
</span><span class="lnt">779
</span><span class="lnt">780
</span><span class="lnt">781
</span><span class="lnt">782
</span><span class="lnt">783
</span><span class="lnt">784
</span><span class="lnt">785
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* Returns chain head if found, otherwise NULL. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">chain_head</span> <span class="o">*</span>
<span class="nf">iptcc_find_label</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xtc_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list_start_pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chains</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* First look at builtin chains */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chains</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">chain_head</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">chain_head</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iptcc_is_builtin</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find a smart place to start the search via chain index */</span>
  	<span class="c1">//list_start_pos = iptcc_linearly_search_chain_index(name, handle);
</span><span class="c1"></span>  	<span class="n">list_start_pos</span> <span class="o">=</span> <span class="n">iptcc_bsearch_chain_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="cm">/* Handel if bsearch bails out early */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_start_pos</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chains</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_start_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG
</span><span class="cp"></span>	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Verify result of bsearch against linearly index search */</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">test_pos</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">chain_head</span> <span class="o">*</span><span class="n">test_c</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_c</span><span class="p">;</span>
		<span class="n">test_pos</span> <span class="o">=</span> <span class="n">iptcc_linearly_search_chain_index</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_start_pos</span> <span class="o">!=</span> <span class="n">test_pos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&#34;BUG in chain_index search</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
			<span class="n">test_c</span><span class="o">=</span><span class="n">list_entry</span><span class="p">(</span><span class="n">test_pos</span><span class="p">,</span>      <span class="k">struct</span> <span class="n">chain_head</span><span class="p">,</span><span class="n">list</span><span class="p">);</span>
			<span class="n">tmp_c</span> <span class="o">=</span><span class="n">list_entry</span><span class="p">(</span><span class="n">list_start_pos</span><span class="p">,</span><span class="k">struct</span> <span class="n">chain_head</span><span class="p">,</span><span class="n">list</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&#34;Verify search found:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&#34; Chain:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">test_c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&#34;BSearch found:</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&#34; Chain:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">tmp_c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif
</span><span class="cp"></span>
	<span class="cm">/* Initial/special case, no user defined chains */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">num_chains</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Start searching through the chain list */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">list_start_pos</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">chain_head</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">chain_head</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">debug</span><span class="p">(</span><span class="s">&#34;List search name:%s == %s res:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">c</span><span class="p">;</span>

		<span class="cm">/* We can stop earlier as we know list is sorted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">&gt;</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">iptcc_is_builtin</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* Walked too far*/</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&#34; Not in list, walked too far, sorted list</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Stop on wrap around, if list head is reached */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chains</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">debug</span><span class="p">(</span><span class="s">&#34;Stop, list head reached</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">debug</span><span class="p">(</span><span class="s">&#34;List search NOT found name:%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libiptc/libiptc.c?id=482c6d3731e2681cb4baae835c294840300197e6#n642">libiptc/libiptc.c#L642-#L646</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* Is the given chain builtin (1) or user-defined (0) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">iptcc_is_builtin</span><span class="p">(</span><span class="k">struct</span> <span class="n">chain_head</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">hooknum</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libiptc/linux_list.h?id=482c6d3731e2681cb4baae835c294840300197e6#n324">libiptc/linux_list.h#L324-#L331</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/**
</span><span class="cm"> * list_entry - get the struct for this entry
</span><span class="cm"> * @ptr:	the &amp;struct list_head pointer.
</span><span class="cm"> * @type:	the type of the struct this is embedded in.
</span><span class="cm"> * @member:	the name of the list_struct within the struct.
</span><span class="cm"> */</span>
<span class="cp">#define list_entry(ptr, type, member) \
</span><span class="cp">	container_of(ptr, type, member)
</span></code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libiptc/linux_list.h?id=482c6d3731e2681cb4baae835c294840300197e6#n7">libiptc/linux_list.h#L7-#L17</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/**
</span><span class="cm"> * container_of - cast a member of a structure out to the containing structure
</span><span class="cm"> *
</span><span class="cm"> * @ptr:	the pointer to the member.
</span><span class="cm"> * @type:	the type of the container struct this is embedded in.
</span><span class="cm"> * @member:	the name of the member within the struct.
</span><span class="cm"> *
</span><span class="cm"> */</span>
<span class="cp">#define container_of(ptr, type, member) ({			\
</span><span class="cp">        const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);	\
</span><span class="cp">        (type *)( (char *)__mptr - offsetof(type,member) );})
</span></code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libiptc/libiptc.c?id=482c6d3731e2681cb4baae835c294840300197e6#n184">libiptc/libiptc.c#L184-#L189</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* notify us that the ruleset has been modified by the user */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">set_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">xtc_handle</span> <span class="o">*</span><span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">h</span><span class="o">-&gt;</span><span class="n">changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="do_command4">do_command4</h2>
<p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n1311">iptables/iptables.c#L1311-#L1955</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1311
</span><span class="lnt">1312
</span><span class="lnt">1313
</span><span class="lnt">1314
</span><span class="lnt">1315
</span><span class="lnt">1316
</span><span class="lnt">1317
</span><span class="lnt">1318
</span><span class="lnt">1319
</span><span class="lnt">1320
</span><span class="lnt">1321
</span><span class="lnt">1322
</span><span class="lnt">1323
</span><span class="lnt">1324
</span><span class="lnt">1325
</span><span class="lnt">1326
</span><span class="lnt">1327
</span><span class="lnt">1328
</span><span class="lnt">1329
</span><span class="lnt">1330
</span><span class="lnt">1331
</span><span class="lnt">1332
</span><span class="lnt">1333
</span><span class="lnt">1334
</span><span class="lnt">1335
</span><span class="lnt">1336
</span><span class="lnt">1337
</span><span class="lnt">1338
</span><span class="lnt">1339
</span><span class="lnt">1340
</span><span class="lnt">1341
</span><span class="lnt">1342
</span><span class="lnt">1343
</span><span class="lnt">1344
</span><span class="lnt">1345
</span><span class="lnt">1346
</span><span class="lnt">1347
</span><span class="lnt">1348
</span><span class="lnt">1349
</span><span class="lnt">1350
</span><span class="lnt">1351
</span><span class="lnt">1352
</span><span class="lnt">1353
</span><span class="lnt">1354
</span><span class="lnt">1355
</span><span class="lnt">1356
</span><span class="lnt">1357
</span><span class="lnt">1358
</span><span class="lnt">1359
</span><span class="lnt">1360
</span><span class="lnt">1361
</span><span class="lnt">1362
</span><span class="lnt">1363
</span><span class="lnt">1364
</span><span class="lnt">1365
</span><span class="lnt">1366
</span><span class="lnt">1367
</span><span class="lnt">1368
</span><span class="lnt">1369
</span><span class="lnt">1370
</span><span class="lnt">1371
</span><span class="lnt">1372
</span><span class="lnt">1373
</span><span class="lnt">1374
</span><span class="lnt">1375
</span><span class="lnt">1376
</span><span class="lnt">1377
</span><span class="lnt">1378
</span><span class="lnt">1379
</span><span class="lnt">1380
</span><span class="lnt">1381
</span><span class="lnt">1382
</span><span class="lnt">1383
</span><span class="lnt">1384
</span><span class="lnt">1385
</span><span class="lnt">1386
</span><span class="lnt">1387
</span><span class="lnt">1388
</span><span class="lnt">1389
</span><span class="lnt">1390
</span><span class="lnt">1391
</span><span class="lnt">1392
</span><span class="lnt">1393
</span><span class="lnt">1394
</span><span class="lnt">1395
</span><span class="lnt">1396
</span><span class="lnt">1397
</span><span class="lnt">1398
</span><span class="lnt">1399
</span><span class="lnt">1400
</span><span class="lnt">1401
</span><span class="lnt">1402
</span><span class="lnt">1403
</span><span class="lnt">1404
</span><span class="lnt">1405
</span><span class="lnt">1406
</span><span class="lnt">1407
</span><span class="lnt">1408
</span><span class="lnt">1409
</span><span class="lnt">1410
</span><span class="lnt">1411
</span><span class="lnt">1412
</span><span class="lnt">1413
</span><span class="lnt">1414
</span><span class="lnt">1415
</span><span class="lnt">1416
</span><span class="lnt">1417
</span><span class="lnt">1418
</span><span class="lnt">1419
</span><span class="lnt">1420
</span><span class="lnt">1421
</span><span class="lnt">1422
</span><span class="lnt">1423
</span><span class="lnt">1424
</span><span class="lnt">1425
</span><span class="lnt">1426
</span><span class="lnt">1427
</span><span class="lnt">1428
</span><span class="lnt">1429
</span><span class="lnt">1430
</span><span class="lnt">1431
</span><span class="lnt">1432
</span><span class="lnt">1433
</span><span class="lnt">1434
</span><span class="lnt">1435
</span><span class="lnt">1436
</span><span class="lnt">1437
</span><span class="lnt">1438
</span><span class="lnt">1439
</span><span class="lnt">1440
</span><span class="lnt">1441
</span><span class="lnt">1442
</span><span class="lnt">1443
</span><span class="lnt">1444
</span><span class="lnt">1445
</span><span class="lnt">1446
</span><span class="lnt">1447
</span><span class="lnt">1448
</span><span class="lnt">1449
</span><span class="lnt">1450
</span><span class="lnt">1451
</span><span class="lnt">1452
</span><span class="lnt">1453
</span><span class="lnt">1454
</span><span class="lnt">1455
</span><span class="lnt">1456
</span><span class="lnt">1457
</span><span class="lnt">1458
</span><span class="lnt">1459
</span><span class="lnt">1460
</span><span class="lnt">1461
</span><span class="lnt">1462
</span><span class="lnt">1463
</span><span class="lnt">1464
</span><span class="lnt">1465
</span><span class="lnt">1466
</span><span class="lnt">1467
</span><span class="lnt">1468
</span><span class="lnt">1469
</span><span class="lnt">1470
</span><span class="lnt">1471
</span><span class="lnt">1472
</span><span class="lnt">1473
</span><span class="lnt">1474
</span><span class="lnt">1475
</span><span class="lnt">1476
</span><span class="lnt">1477
</span><span class="lnt">1478
</span><span class="lnt">1479
</span><span class="lnt">1480
</span><span class="lnt">1481
</span><span class="lnt">1482
</span><span class="lnt">1483
</span><span class="lnt">1484
</span><span class="lnt">1485
</span><span class="lnt">1486
</span><span class="lnt">1487
</span><span class="lnt">1488
</span><span class="lnt">1489
</span><span class="lnt">1490
</span><span class="lnt">1491
</span><span class="lnt">1492
</span><span class="lnt">1493
</span><span class="lnt">1494
</span><span class="lnt">1495
</span><span class="lnt">1496
</span><span class="lnt">1497
</span><span class="lnt">1498
</span><span class="lnt">1499
</span><span class="lnt">1500
</span><span class="lnt">1501
</span><span class="lnt">1502
</span><span class="lnt">1503
</span><span class="lnt">1504
</span><span class="lnt">1505
</span><span class="lnt">1506
</span><span class="lnt">1507
</span><span class="lnt">1508
</span><span class="lnt">1509
</span><span class="lnt">1510
</span><span class="lnt">1511
</span><span class="lnt">1512
</span><span class="lnt">1513
</span><span class="lnt">1514
</span><span class="lnt">1515
</span><span class="lnt">1516
</span><span class="lnt">1517
</span><span class="lnt">1518
</span><span class="lnt">1519
</span><span class="lnt">1520
</span><span class="lnt">1521
</span><span class="lnt">1522
</span><span class="lnt">1523
</span><span class="lnt">1524
</span><span class="lnt">1525
</span><span class="lnt">1526
</span><span class="lnt">1527
</span><span class="lnt">1528
</span><span class="lnt">1529
</span><span class="lnt">1530
</span><span class="lnt">1531
</span><span class="lnt">1532
</span><span class="lnt">1533
</span><span class="lnt">1534
</span><span class="lnt">1535
</span><span class="lnt">1536
</span><span class="lnt">1537
</span><span class="lnt">1538
</span><span class="lnt">1539
</span><span class="lnt">1540
</span><span class="lnt">1541
</span><span class="lnt">1542
</span><span class="lnt">1543
</span><span class="lnt">1544
</span><span class="lnt">1545
</span><span class="lnt">1546
</span><span class="lnt">1547
</span><span class="lnt">1548
</span><span class="lnt">1549
</span><span class="lnt">1550
</span><span class="lnt">1551
</span><span class="lnt">1552
</span><span class="lnt">1553
</span><span class="lnt">1554
</span><span class="lnt">1555
</span><span class="lnt">1556
</span><span class="lnt">1557
</span><span class="lnt">1558
</span><span class="lnt">1559
</span><span class="lnt">1560
</span><span class="lnt">1561
</span><span class="lnt">1562
</span><span class="lnt">1563
</span><span class="lnt">1564
</span><span class="lnt">1565
</span><span class="lnt">1566
</span><span class="lnt">1567
</span><span class="lnt">1568
</span><span class="lnt">1569
</span><span class="lnt">1570
</span><span class="lnt">1571
</span><span class="lnt">1572
</span><span class="lnt">1573
</span><span class="lnt">1574
</span><span class="lnt">1575
</span><span class="lnt">1576
</span><span class="lnt">1577
</span><span class="lnt">1578
</span><span class="lnt">1579
</span><span class="lnt">1580
</span><span class="lnt">1581
</span><span class="lnt">1582
</span><span class="lnt">1583
</span><span class="lnt">1584
</span><span class="lnt">1585
</span><span class="lnt">1586
</span><span class="lnt">1587
</span><span class="lnt">1588
</span><span class="lnt">1589
</span><span class="lnt">1590
</span><span class="lnt">1591
</span><span class="lnt">1592
</span><span class="lnt">1593
</span><span class="lnt">1594
</span><span class="lnt">1595
</span><span class="lnt">1596
</span><span class="lnt">1597
</span><span class="lnt">1598
</span><span class="lnt">1599
</span><span class="lnt">1600
</span><span class="lnt">1601
</span><span class="lnt">1602
</span><span class="lnt">1603
</span><span class="lnt">1604
</span><span class="lnt">1605
</span><span class="lnt">1606
</span><span class="lnt">1607
</span><span class="lnt">1608
</span><span class="lnt">1609
</span><span class="lnt">1610
</span><span class="lnt">1611
</span><span class="lnt">1612
</span><span class="lnt">1613
</span><span class="lnt">1614
</span><span class="lnt">1615
</span><span class="lnt">1616
</span><span class="lnt">1617
</span><span class="lnt">1618
</span><span class="lnt">1619
</span><span class="lnt">1620
</span><span class="lnt">1621
</span><span class="lnt">1622
</span><span class="lnt">1623
</span><span class="lnt">1624
</span><span class="lnt">1625
</span><span class="lnt">1626
</span><span class="lnt">1627
</span><span class="lnt">1628
</span><span class="lnt">1629
</span><span class="lnt">1630
</span><span class="lnt">1631
</span><span class="lnt">1632
</span><span class="lnt">1633
</span><span class="lnt">1634
</span><span class="lnt">1635
</span><span class="lnt">1636
</span><span class="lnt">1637
</span><span class="lnt">1638
</span><span class="lnt">1639
</span><span class="lnt">1640
</span><span class="lnt">1641
</span><span class="lnt">1642
</span><span class="lnt">1643
</span><span class="lnt">1644
</span><span class="lnt">1645
</span><span class="lnt">1646
</span><span class="lnt">1647
</span><span class="lnt">1648
</span><span class="lnt">1649
</span><span class="lnt">1650
</span><span class="lnt">1651
</span><span class="lnt">1652
</span><span class="lnt">1653
</span><span class="lnt">1654
</span><span class="lnt">1655
</span><span class="lnt">1656
</span><span class="lnt">1657
</span><span class="lnt">1658
</span><span class="lnt">1659
</span><span class="lnt">1660
</span><span class="lnt">1661
</span><span class="lnt">1662
</span><span class="lnt">1663
</span><span class="lnt">1664
</span><span class="lnt">1665
</span><span class="lnt">1666
</span><span class="lnt">1667
</span><span class="lnt">1668
</span><span class="lnt">1669
</span><span class="lnt">1670
</span><span class="lnt">1671
</span><span class="lnt">1672
</span><span class="lnt">1673
</span><span class="lnt">1674
</span><span class="lnt">1675
</span><span class="lnt">1676
</span><span class="lnt">1677
</span><span class="lnt">1678
</span><span class="lnt">1679
</span><span class="lnt">1680
</span><span class="lnt">1681
</span><span class="lnt">1682
</span><span class="lnt">1683
</span><span class="lnt">1684
</span><span class="lnt">1685
</span><span class="lnt">1686
</span><span class="lnt">1687
</span><span class="lnt">1688
</span><span class="lnt">1689
</span><span class="lnt">1690
</span><span class="lnt">1691
</span><span class="lnt">1692
</span><span class="lnt">1693
</span><span class="lnt">1694
</span><span class="lnt">1695
</span><span class="lnt">1696
</span><span class="lnt">1697
</span><span class="lnt">1698
</span><span class="lnt">1699
</span><span class="lnt">1700
</span><span class="lnt">1701
</span><span class="lnt">1702
</span><span class="lnt">1703
</span><span class="lnt">1704
</span><span class="lnt">1705
</span><span class="lnt">1706
</span><span class="lnt">1707
</span><span class="lnt">1708
</span><span class="lnt">1709
</span><span class="lnt">1710
</span><span class="lnt">1711
</span><span class="lnt">1712
</span><span class="lnt">1713
</span><span class="lnt">1714
</span><span class="lnt">1715
</span><span class="lnt">1716
</span><span class="lnt">1717
</span><span class="lnt">1718
</span><span class="lnt">1719
</span><span class="lnt">1720
</span><span class="lnt">1721
</span><span class="lnt">1722
</span><span class="lnt">1723
</span><span class="lnt">1724
</span><span class="lnt">1725
</span><span class="lnt">1726
</span><span class="lnt">1727
</span><span class="lnt">1728
</span><span class="lnt">1729
</span><span class="lnt">1730
</span><span class="lnt">1731
</span><span class="lnt">1732
</span><span class="lnt">1733
</span><span class="lnt">1734
</span><span class="lnt">1735
</span><span class="lnt">1736
</span><span class="lnt">1737
</span><span class="lnt">1738
</span><span class="lnt">1739
</span><span class="lnt">1740
</span><span class="lnt">1741
</span><span class="lnt">1742
</span><span class="lnt">1743
</span><span class="lnt">1744
</span><span class="lnt">1745
</span><span class="lnt">1746
</span><span class="lnt">1747
</span><span class="lnt">1748
</span><span class="lnt">1749
</span><span class="lnt">1750
</span><span class="lnt">1751
</span><span class="lnt">1752
</span><span class="lnt">1753
</span><span class="lnt">1754
</span><span class="lnt">1755
</span><span class="lnt">1756
</span><span class="lnt">1757
</span><span class="lnt">1758
</span><span class="lnt">1759
</span><span class="lnt">1760
</span><span class="lnt">1761
</span><span class="lnt">1762
</span><span class="lnt">1763
</span><span class="lnt">1764
</span><span class="lnt">1765
</span><span class="lnt">1766
</span><span class="lnt">1767
</span><span class="lnt">1768
</span><span class="lnt">1769
</span><span class="lnt">1770
</span><span class="lnt">1771
</span><span class="lnt">1772
</span><span class="lnt">1773
</span><span class="lnt">1774
</span><span class="lnt">1775
</span><span class="lnt">1776
</span><span class="lnt">1777
</span><span class="lnt">1778
</span><span class="lnt">1779
</span><span class="lnt">1780
</span><span class="lnt">1781
</span><span class="lnt">1782
</span><span class="lnt">1783
</span><span class="lnt">1784
</span><span class="lnt">1785
</span><span class="lnt">1786
</span><span class="lnt">1787
</span><span class="lnt">1788
</span><span class="lnt">1789
</span><span class="lnt">1790
</span><span class="lnt">1791
</span><span class="lnt">1792
</span><span class="lnt">1793
</span><span class="lnt">1794
</span><span class="lnt">1795
</span><span class="lnt">1796
</span><span class="lnt">1797
</span><span class="lnt">1798
</span><span class="lnt">1799
</span><span class="lnt">1800
</span><span class="lnt">1801
</span><span class="lnt">1802
</span><span class="lnt">1803
</span><span class="lnt">1804
</span><span class="lnt">1805
</span><span class="lnt">1806
</span><span class="lnt">1807
</span><span class="lnt">1808
</span><span class="lnt">1809
</span><span class="lnt">1810
</span><span class="lnt">1811
</span><span class="lnt">1812
</span><span class="lnt">1813
</span><span class="lnt">1814
</span><span class="lnt">1815
</span><span class="lnt">1816
</span><span class="lnt">1817
</span><span class="lnt">1818
</span><span class="lnt">1819
</span><span class="lnt">1820
</span><span class="lnt">1821
</span><span class="lnt">1822
</span><span class="lnt">1823
</span><span class="lnt">1824
</span><span class="lnt">1825
</span><span class="lnt">1826
</span><span class="lnt">1827
</span><span class="lnt">1828
</span><span class="lnt">1829
</span><span class="lnt">1830
</span><span class="lnt">1831
</span><span class="lnt">1832
</span><span class="lnt">1833
</span><span class="lnt">1834
</span><span class="lnt">1835
</span><span class="lnt">1836
</span><span class="lnt">1837
</span><span class="lnt">1838
</span><span class="lnt">1839
</span><span class="lnt">1840
</span><span class="lnt">1841
</span><span class="lnt">1842
</span><span class="lnt">1843
</span><span class="lnt">1844
</span><span class="lnt">1845
</span><span class="lnt">1846
</span><span class="lnt">1847
</span><span class="lnt">1848
</span><span class="lnt">1849
</span><span class="lnt">1850
</span><span class="lnt">1851
</span><span class="lnt">1852
</span><span class="lnt">1853
</span><span class="lnt">1854
</span><span class="lnt">1855
</span><span class="lnt">1856
</span><span class="lnt">1857
</span><span class="lnt">1858
</span><span class="lnt">1859
</span><span class="lnt">1860
</span><span class="lnt">1861
</span><span class="lnt">1862
</span><span class="lnt">1863
</span><span class="lnt">1864
</span><span class="lnt">1865
</span><span class="lnt">1866
</span><span class="lnt">1867
</span><span class="lnt">1868
</span><span class="lnt">1869
</span><span class="lnt">1870
</span><span class="lnt">1871
</span><span class="lnt">1872
</span><span class="lnt">1873
</span><span class="lnt">1874
</span><span class="lnt">1875
</span><span class="lnt">1876
</span><span class="lnt">1877
</span><span class="lnt">1878
</span><span class="lnt">1879
</span><span class="lnt">1880
</span><span class="lnt">1881
</span><span class="lnt">1882
</span><span class="lnt">1883
</span><span class="lnt">1884
</span><span class="lnt">1885
</span><span class="lnt">1886
</span><span class="lnt">1887
</span><span class="lnt">1888
</span><span class="lnt">1889
</span><span class="lnt">1890
</span><span class="lnt">1891
</span><span class="lnt">1892
</span><span class="lnt">1893
</span><span class="lnt">1894
</span><span class="lnt">1895
</span><span class="lnt">1896
</span><span class="lnt">1897
</span><span class="lnt">1898
</span><span class="lnt">1899
</span><span class="lnt">1900
</span><span class="lnt">1901
</span><span class="lnt">1902
</span><span class="lnt">1903
</span><span class="lnt">1904
</span><span class="lnt">1905
</span><span class="lnt">1906
</span><span class="lnt">1907
</span><span class="lnt">1908
</span><span class="lnt">1909
</span><span class="lnt">1910
</span><span class="lnt">1911
</span><span class="lnt">1912
</span><span class="lnt">1913
</span><span class="lnt">1914
</span><span class="lnt">1915
</span><span class="lnt">1916
</span><span class="lnt">1917
</span><span class="lnt">1918
</span><span class="lnt">1919
</span><span class="lnt">1920
</span><span class="lnt">1921
</span><span class="lnt">1922
</span><span class="lnt">1923
</span><span class="lnt">1924
</span><span class="lnt">1925
</span><span class="lnt">1926
</span><span class="lnt">1927
</span><span class="lnt">1928
</span><span class="lnt">1929
</span><span class="lnt">1930
</span><span class="lnt">1931
</span><span class="lnt">1932
</span><span class="lnt">1933
</span><span class="lnt">1934
</span><span class="lnt">1935
</span><span class="lnt">1936
</span><span class="lnt">1937
</span><span class="lnt">1938
</span><span class="lnt">1939
</span><span class="lnt">1940
</span><span class="lnt">1941
</span><span class="lnt">1942
</span><span class="lnt">1943
</span><span class="lnt">1944
</span><span class="lnt">1945
</span><span class="lnt">1946
</span><span class="lnt">1947
</span><span class="lnt">1948
</span><span class="lnt">1949
</span><span class="lnt">1950
</span><span class="lnt">1951
</span><span class="lnt">1952
</span><span class="lnt">1953
</span><span class="lnt">1954
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">do_command4</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[],</span> <span class="kt">char</span> <span class="o">**</span><span class="n">table</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">xtc_handle</span> <span class="o">**</span><span class="n">handle</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">restore</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iptables_command_state</span> <span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipt_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nsaddrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ndaddrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">saddrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">smasks</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">daddrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">dmasks</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">wait</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">shostnetworkmask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">dhostnetworkmask</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">policy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">newname</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rulenum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">command</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pcnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">bcnt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtables_match</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtables_rule_match</span> <span class="o">*</span><span class="n">matchp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xtables_target</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
	<span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="p">;</span>
	<span class="n">cs</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="n">argv</span><span class="p">;</span>

	<span class="cm">/* re-set optind to 0 in case do_command4 gets called
</span><span class="cm">	 * a second time */</span>
	<span class="n">optind</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* clear mflags in case do_command4 gets called a second time
</span><span class="cm">	 * (we clear the global list of all matches for security)*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="n">xtables_matches</span><span class="p">;</span> <span class="n">m</span><span class="p">;</span> <span class="n">m</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">m</span><span class="o">-&gt;</span><span class="n">mflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">xtables_targets</span><span class="p">;</span> <span class="n">t</span><span class="p">;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">tflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Suppress error messages: we may add new options if we
</span><span class="cm">           demand-load a protocol. */</span>
	<span class="n">opterr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">opts</span> <span class="o">=</span> <span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">orig_opts</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">cs</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">getopt_long</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span>
	   <span class="s">&#34;-:A:C:D:R:I:L::S::M:F::Z::N:X::E:P:Vh::o:p:s:d:j:i:fbvwnt:m:xc:g:46&#34;</span><span class="p">,</span>
					   <span class="n">opts</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*
</span><span class="cm">			 * Command selection
</span><span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;A&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_APPEND</span><span class="p">,</span> <span class="n">CMD_NONE</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;C&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_CHECK</span><span class="p">,</span> <span class="n">CMD_NONE</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;D&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_DELETE</span><span class="p">,</span> <span class="n">CMD_NONE</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
			    <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rulenum</span> <span class="o">=</span> <span class="n">parse_rulenumber</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">]);</span>
				<span class="n">command</span> <span class="o">=</span> <span class="n">CMD_DELETE_NUM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;R&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_REPLACE</span><span class="p">,</span> <span class="n">CMD_NONE</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
			    <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">rulenum</span> <span class="o">=</span> <span class="n">parse_rulenumber</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;-%c requires a rule number&#34;</span><span class="p">,</span>
					   <span class="n">cmd2char</span><span class="p">(</span><span class="n">CMD_REPLACE</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;I&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_INSERT</span><span class="p">,</span> <span class="n">CMD_NONE</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
			    <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">rulenum</span> <span class="o">=</span> <span class="n">parse_rulenumber</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">]);</span>
			<span class="k">else</span> <span class="n">rulenum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;L&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_LIST</span><span class="p">,</span>
				    <span class="n">CMD_ZERO</span> <span class="o">|</span> <span class="n">CMD_ZERO_NUM</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optarg</span><span class="p">)</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
				 <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">chain</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
			    <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">rulenum</span> <span class="o">=</span> <span class="n">parse_rulenumber</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;S&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_LIST_RULES</span><span class="p">,</span>
				    <span class="n">CMD_ZERO</span><span class="o">|</span><span class="n">CMD_ZERO_NUM</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optarg</span><span class="p">)</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
				 <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">chain</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
			    <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">rulenum</span> <span class="o">=</span> <span class="n">parse_rulenumber</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;F&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_FLUSH</span><span class="p">,</span> <span class="n">CMD_NONE</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optarg</span><span class="p">)</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
				 <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">chain</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;Z&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_ZERO</span><span class="p">,</span> <span class="n">CMD_LIST</span><span class="o">|</span><span class="n">CMD_LIST_RULES</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optarg</span><span class="p">)</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
				<span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">chain</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
				<span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rulenum</span> <span class="o">=</span> <span class="n">parse_rulenumber</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">]);</span>
				<span class="n">command</span> <span class="o">=</span> <span class="n">CMD_ZERO_NUM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;N&#39;</span><span class="o">:</span>
			<span class="n">parse_chain</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_NEW_CHAIN</span><span class="p">,</span> <span class="n">CMD_NONE</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;X&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_DELETE_CHAIN</span><span class="p">,</span> <span class="n">CMD_NONE</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optarg</span><span class="p">)</span> <span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
				 <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">chain</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;E&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_RENAME_CHAIN</span><span class="p">,</span> <span class="n">CMD_NONE</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
			    <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">newname</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;-%c requires old-chain-name and &#34;</span>
					   <span class="s">&#34;new-chain-name&#34;</span><span class="p">,</span>
					    <span class="n">cmd2char</span><span class="p">(</span><span class="n">CMD_RENAME_CHAIN</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;P&#39;</span><span class="o">:</span>
			<span class="n">add_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">command</span><span class="p">,</span> <span class="n">CMD_SET_POLICY</span><span class="p">,</span> <span class="n">CMD_NONE</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">chain</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
			    <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">policy</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;-%c requires a chain and a policy&#34;</span><span class="p">,</span>
					   <span class="n">cmd2char</span><span class="p">(</span><span class="n">CMD_SET_POLICY</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;h&#39;</span><span class="o">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">optarg</span><span class="p">)</span>
				<span class="n">optarg</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">];</span>

			<span class="cm">/* iptables -p icmp -h */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">.</span><span class="n">matches</span> <span class="o">&amp;&amp;</span> <span class="n">cs</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span>
				<span class="n">xtables_find_match</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">protocol</span><span class="p">,</span>
					<span class="n">XTF_TRY_LOAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">matches</span><span class="p">);</span>

			<span class="n">exit_printhelp</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">matches</span><span class="p">);</span>

			<span class="cm">/*
</span><span class="cm">			 * Option selection
</span><span class="cm">			 */</span>
		<span class="k">case</span> <span class="sc">&#39;p&#39;</span><span class="o">:</span>
			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_PROTOCOL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>

			<span class="cm">/* Canonicalize into lower case */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span> <span class="o">*</span><span class="n">cs</span><span class="p">.</span><span class="n">protocol</span><span class="p">;</span> <span class="n">cs</span><span class="p">.</span><span class="n">protocol</span><span class="o">++</span><span class="p">)</span>
				<span class="o">*</span><span class="n">cs</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">tolower</span><span class="p">(</span><span class="o">*</span><span class="n">cs</span><span class="p">.</span><span class="n">protocol</span><span class="p">);</span>

			<span class="n">cs</span><span class="p">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">xtables_parse_protocol</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">protocol</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">proto</span> <span class="o">==</span> <span class="mi">0</span>
			    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span> <span class="o">&amp;</span> <span class="n">XT_INV_PROTO</span><span class="p">))</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;rule would never match protocol&#34;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;s&#39;</span><span class="o">:</span>
			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_SOURCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">shostnetworkmask</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span>
			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_DESTINATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">dhostnetworkmask</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef IPT_F_GOTO
</span><span class="cp"></span>		<span class="k">case</span> <span class="sc">&#39;g&#39;</span><span class="o">:</span>
			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_JUMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPT_F_GOTO</span><span class="p">;</span>
			<span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span> <span class="o">=</span> <span class="n">parse_target</span><span class="p">(</span><span class="n">optarg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="cp"></span>
		<span class="k">case</span> <span class="sc">&#39;j&#39;</span><span class="o">:</span>
			<span class="n">command_jump</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;i&#39;</span><span class="o">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">optarg</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					<span class="s">&#34;Empty interface is likely to be &#34;</span>
					<span class="s">&#34;undesired&#34;</span><span class="p">);</span>
			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_VIANAMEIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">xtables_parse_interface</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span>
					<span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">iniface</span><span class="p">,</span>
					<span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">iniface_mask</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;o&#39;</span><span class="o">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">optarg</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					<span class="s">&#34;Empty interface is likely to be &#34;</span>
					<span class="s">&#34;undesired&#34;</span><span class="p">);</span>
			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_VIANAMEOUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">xtables_parse_interface</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span>
					<span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">outiface</span><span class="p">,</span>
					<span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">outiface_mask</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="o">:</span>
			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_FRAGMENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IPT_F_FRAG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;v&#39;</span><span class="o">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">verbose</span><span class="p">)</span>
				<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_VERBOSE</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">verbose</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;w&#39;</span><span class="o">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">restore</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					      <span class="s">&#34;You cannot use `-w&#39; from &#34;</span>
					      <span class="s">&#34;iptables-restore&#34;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">wait</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;m&#39;</span><span class="o">:</span>
			<span class="n">command_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>
			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_NUMERIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">)</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;unexpected ! flag before --table&#34;</span><span class="p">);</span>
			<span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;x&#39;</span><span class="o">:</span>
			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_EXPANDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;V&#39;</span><span class="o">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">)</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;Not %s ;-)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">prog_vers</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printf</span><span class="p">(</span><span class="s">&#34;%s v%s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
				       <span class="n">prog_name</span><span class="p">,</span> <span class="n">prog_vers</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

		<span class="k">case</span> <span class="sc">&#39;0&#39;</span><span class="o">:</span>
			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_LINENUMBERS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;M&#39;</span><span class="o">:</span>
			<span class="n">xtables_modprobe_program</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;c&#39;</span><span class="o">:</span>

			<span class="n">set_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">,</span> <span class="n">OPT_COUNTERS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">);</span>
			<span class="n">pcnt</span> <span class="o">=</span> <span class="n">optarg</span><span class="p">;</span>
			<span class="n">bcnt</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">pcnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bcnt</span><span class="p">)</span>
			    <span class="n">bcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcnt</span> <span class="o">&amp;&amp;</span> <span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span>
			    <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
				<span class="n">bcnt</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="o">++</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcnt</span><span class="p">)</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					<span class="s">&#34;-%c requires packet and byte counter&#34;</span><span class="p">,</span>
					<span class="n">opt2char</span><span class="p">(</span><span class="n">OPT_COUNTERS</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">pcnt</span><span class="p">,</span> <span class="s">&#34;%llu&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					<span class="s">&#34;-%c packet counter not numeric&#34;</span><span class="p">,</span>
					<span class="n">opt2char</span><span class="p">(</span><span class="n">OPT_COUNTERS</span><span class="p">));</span>
			<span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">counters</span><span class="p">.</span><span class="n">pcnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">bcnt</span><span class="p">,</span> <span class="s">&#34;%llu&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					<span class="s">&#34;-%c byte counter not numeric&#34;</span><span class="p">,</span>
					<span class="n">opt2char</span><span class="p">(</span><span class="n">OPT_COUNTERS</span><span class="p">));</span>
			<span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">counters</span><span class="p">.</span><span class="n">bcnt</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;4&#39;</span><span class="o">:</span>
			<span class="cm">/* This is indeed the IPv4 iptables */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="sc">&#39;6&#39;</span><span class="o">:</span>
			<span class="cm">/* This is not the IPv6 ip6tables */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* success: line ignored */</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;This is the IPv4 version of iptables.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
			<span class="n">exit_tryhelp</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

		<span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="cm">/* non option */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">optarg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;!&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">optarg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">)</span>
					<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
						   <span class="s">&#34;multiple consecutive ! not&#34;</span>
						   <span class="s">&#34; allowed&#34;</span><span class="p">);</span>
				<span class="n">cs</span><span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
				<span class="n">optarg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Bad argument `%s&#39;</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">optarg</span><span class="p">);</span>
			<span class="n">exit_tryhelp</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

		<span class="k">default</span><span class="o">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">command_default</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iptables_globals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="cm">/* cf. ip6tables.c */</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cs</span><span class="p">.</span><span class="n">invert</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="s">&#34;nat&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">policy</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="s">&#34;DROP&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span><span class="p">,</span> <span class="s">&#34;DROP&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
			<span class="s">&#34;</span><span class="se">\n</span><span class="s">The </span><span class="se">\&#34;</span><span class="s">nat</span><span class="se">\&#34;</span><span class="s"> table is not intended for filtering, &#34;</span>
		        <span class="s">&#34;the use of DROP is therefore inhibited.</span><span class="se">\n\n</span><span class="s">&#34;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">matchp</span> <span class="o">=</span> <span class="n">cs</span><span class="p">.</span><span class="n">matches</span><span class="p">;</span> <span class="n">matchp</span><span class="p">;</span> <span class="n">matchp</span> <span class="o">=</span> <span class="n">matchp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
		<span class="n">xtables_option_mfcall</span><span class="p">(</span><span class="n">matchp</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">target</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">xtables_option_tfcall</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>

	<span class="cm">/* Fix me: must put inverse options checking here --MN */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">optind</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span>
		<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
			   <span class="s">&#34;unknown arguments found on commandline&#34;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">command</span><span class="p">)</span>
		<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span> <span class="s">&#34;no command specified&#34;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
			   <span class="s">&#34;nothing appropriate following !&#34;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CMD_REPLACE</span> <span class="o">|</span> <span class="n">CMD_INSERT</span> <span class="o">|</span> <span class="n">CMD_DELETE</span> <span class="o">|</span> <span class="n">CMD_APPEND</span> <span class="o">|</span> <span class="n">CMD_CHECK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPT_DESTINATION</span><span class="p">))</span>
			<span class="n">dhostnetworkmask</span> <span class="o">=</span> <span class="s">&#34;0.0.0.0/0&#34;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPT_SOURCE</span><span class="p">))</span>
			<span class="n">shostnetworkmask</span> <span class="o">=</span> <span class="s">&#34;0.0.0.0/0&#34;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">shostnetworkmask</span><span class="p">)</span>
		<span class="n">xtables_ipparse_multiple</span><span class="p">(</span><span class="n">shostnetworkmask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saddrs</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">smasks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nsaddrs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dhostnetworkmask</span><span class="p">)</span>
		<span class="n">xtables_ipparse_multiple</span><span class="p">(</span><span class="n">dhostnetworkmask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">daddrs</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">dmasks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ndaddrs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nsaddrs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ndaddrs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">invflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IPT_INV_SRCIP</span> <span class="o">|</span> <span class="n">IPT_INV_DSTIP</span><span class="p">)))</span>
		<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span> <span class="s">&#34;! not allowed with multiple&#34;</span>
			   <span class="s">&#34; source or destination IP addresses&#34;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">CMD_REPLACE</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">nsaddrs</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ndaddrs</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span> <span class="s">&#34;Replacement rule does not &#34;</span>
			   <span class="s">&#34;specify a unique address&#34;</span><span class="p">);</span>

	<span class="n">generic_opt_check</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="p">);</span>

	<span class="cm">/* Attempt to acquire the xtables lock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">restore</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">xtables_lock</span><span class="p">(</span><span class="n">wait</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Another app is currently holding the xtables lock. &#34;</span>
			<span class="s">&#34;Perhaps you want to use the -w option?</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
		<span class="n">xtables_free_opts</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">RESOURCE_PROBLEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* only allocate handle if we weren&#39;t called with a handle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">handle</span><span class="p">)</span>
		<span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">iptc_init</span><span class="p">(</span><span class="o">*</span><span class="n">table</span><span class="p">);</span>

	<span class="cm">/* try to insmod the module if iptc_init failed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">handle</span> <span class="o">&amp;&amp;</span> <span class="n">xtables_load_ko</span><span class="p">(</span><span class="n">xtables_modprobe_program</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">iptc_init</span><span class="p">(</span><span class="o">*</span><span class="n">table</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">handle</span><span class="p">)</span>
		<span class="n">xtables_error</span><span class="p">(</span><span class="n">VERSION_PROBLEM</span><span class="p">,</span>
			   <span class="s">&#34;can&#39;t initialize iptables table `%s&#39;: %s&#34;</span><span class="p">,</span>
			   <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="n">iptc_strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">CMD_APPEND</span>
	    <span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">CMD_DELETE</span>
	    <span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">CMD_CHECK</span>
	    <span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">CMD_INSERT</span>
	    <span class="o">||</span> <span class="n">command</span> <span class="o">==</span> <span class="n">CMD_REPLACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="s">&#34;PREROUTING&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		    <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="s">&#34;INPUT&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* -o not valid with incoming packets. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPT_VIANAMEOUT</span><span class="p">)</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;Can&#39;t use -%c with %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
					   <span class="n">opt2char</span><span class="p">(</span><span class="n">OPT_VIANAMEOUT</span><span class="p">),</span>
					   <span class="n">chain</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="s">&#34;POSTROUTING&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		    <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="s">&#34;OUTPUT&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* -i not valid with outgoing packets */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">options</span> <span class="o">&amp;</span> <span class="n">OPT_VIANAMEIN</span><span class="p">)</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;Can&#39;t use -%c with %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
					   <span class="n">opt2char</span><span class="p">(</span><span class="n">OPT_VIANAMEIN</span><span class="p">),</span>
					   <span class="n">chain</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">target</span> <span class="o">&amp;&amp;</span> <span class="n">iptc_is_chain</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
				<span class="s">&#34;Warning: using chain %s, not extension</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
				<span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">)</span>
				<span class="n">free</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">);</span>

			<span class="n">cs</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If they didn&#39;t specify a target, or it&#39;s a chain
</span><span class="cm">		   name, use standard. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">.</span><span class="n">target</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
			<span class="o">||</span> <span class="n">iptc_is_chain</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">size_t</span> <span class="n">size</span><span class="p">;</span>

			<span class="n">cs</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">xtables_find_target</span><span class="p">(</span><span class="n">XT_STANDARD_TARGET</span><span class="p">,</span>
					 <span class="n">XTF_LOAD_MUST_SUCCEED</span><span class="p">);</span>

			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_entry_target</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
			<span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">t</span> <span class="o">=</span> <span class="n">xtables_calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">target_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iptc_is_chain</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">))</span>
				<span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">user</span><span class="p">.</span><span class="n">revision</span> <span class="o">=</span> <span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
			<span class="n">xs_init_target</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* it is no chain, and we can&#39;t load a plugin.
</span><span class="cm">			 * We cannot know if the plugin is corrupt, non
</span><span class="cm">			 * existant OR if the user just misspelled a
</span><span class="cm">			 * chain. */</span>
<span class="cp">#ifdef IPT_F_GOTO
</span><span class="cp"></span>			<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="n">ip</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IPT_F_GOTO</span><span class="p">)</span>
				<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
					   <span class="s">&#34;goto &#39;%s&#39; is not a chain</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
					   <span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span><span class="p">);</span>
<span class="cp">#endif
</span><span class="cp"></span>			<span class="n">xtables_find_target</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">jumpto</span><span class="p">,</span> <span class="n">XTF_LOAD_MUST_SUCCEED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">e</span> <span class="o">=</span> <span class="n">generate_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">matches</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">);</span>
			<span class="n">free</span><span class="p">(</span><span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">t</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nl">CMD_APPEND</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">append_entry</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
				   <span class="n">nsaddrs</span><span class="p">,</span> <span class="n">saddrs</span><span class="p">,</span> <span class="n">smasks</span><span class="p">,</span>
				   <span class="n">ndaddrs</span><span class="p">,</span> <span class="n">daddrs</span><span class="p">,</span> <span class="n">dmasks</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span>
				   <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_DELETE</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">delete_entry</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
				   <span class="n">nsaddrs</span><span class="p">,</span> <span class="n">saddrs</span><span class="p">,</span> <span class="n">smasks</span><span class="p">,</span>
				   <span class="n">ndaddrs</span><span class="p">,</span> <span class="n">daddrs</span><span class="p">,</span> <span class="n">dmasks</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span>
				   <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">matches</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_DELETE_NUM</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iptc_delete_num_entry</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">rulenum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_CHECK</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">check_entry</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span>
				   <span class="n">nsaddrs</span><span class="p">,</span> <span class="n">saddrs</span><span class="p">,</span> <span class="n">smasks</span><span class="p">,</span>
				   <span class="n">ndaddrs</span><span class="p">,</span> <span class="n">daddrs</span><span class="p">,</span> <span class="n">dmasks</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span>
				   <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">matches</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_REPLACE</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">replace_entry</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">rulenum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				    <span class="n">saddrs</span><span class="p">,</span> <span class="n">smasks</span><span class="p">,</span> <span class="n">daddrs</span><span class="p">,</span> <span class="n">dmasks</span><span class="p">,</span>
				    <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_INSERT</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">insert_entry</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">rulenum</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="n">nsaddrs</span><span class="p">,</span> <span class="n">saddrs</span><span class="p">,</span> <span class="n">smasks</span><span class="p">,</span>
				   <span class="n">ndaddrs</span><span class="p">,</span> <span class="n">daddrs</span><span class="p">,</span> <span class="n">dmasks</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span>
				   <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_FLUSH</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">flush_entries4</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_ZERO</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">zero_entries</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_ZERO_NUM</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iptc_zero_counter</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">rulenum</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_LIST</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">CMD_LIST</span><span class="o">|</span><span class="nl">CMD_ZERO</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">CMD_LIST</span><span class="o">|</span><span class="nl">CMD_ZERO_NUM</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">list_entries</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span>
				   <span class="n">rulenum</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_NUMERIC</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_EXPANDED</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_LINENUMBERS</span><span class="p">,</span>
				   <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_ZERO</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">zero_entries</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span>
					   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_ZERO_NUM</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">iptc_zero_counter</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">rulenum</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_LIST_RULES</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">CMD_LIST_RULES</span><span class="o">|</span><span class="nl">CMD_ZERO</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">CMD_LIST_RULES</span><span class="o">|</span><span class="nl">CMD_ZERO_NUM</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">list_rules</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span>
				   <span class="n">rulenum</span><span class="p">,</span>
				   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span>
				   <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_ZERO</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">zero_entries</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span>
					   <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="n">CMD_ZERO_NUM</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">iptc_zero_counter</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">rulenum</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_NEW_CHAIN</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iptc_create_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_DELETE_CHAIN</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">delete_chain4</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_VERBOSE</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_RENAME_CHAIN</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iptc_rename_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">newname</span><span class="p">,</span>	<span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="nl">CMD_SET_POLICY</span><span class="p">:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iptc_set_policy</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">policy</span><span class="p">,</span> <span class="n">cs</span><span class="p">.</span><span class="n">options</span><span class="o">&amp;</span><span class="n">OPT_COUNTERS</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">fw</span><span class="p">.</span><span class="nl">counters</span> <span class="p">:</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="cm">/* We should never reach this... */</span>
		<span class="n">exit_tryhelp</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dump_entries</span><span class="p">(</span><span class="o">*</span><span class="n">handle</span><span class="p">);</span>

	<span class="n">xtables_rule_matches_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">.</span><span class="n">matches</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
		<span class="n">e</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">saddrs</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">smasks</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">daddrs</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">dmasks</span><span class="p">);</span>
	<span class="n">xtables_free_opts</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n341">iptables/iptables.c#L341-#L351</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span>
<span class="nf">add_command</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">newcmd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">othercmds</span><span class="p">,</span> 
	    <span class="kt">int</span> <span class="n">invert</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
		<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span> <span class="s">&#34;unexpected ! flag&#34;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">othercmds</span><span class="p">))</span>
		<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span> <span class="s">&#34;Cannot use -%c with -%c</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
			   <span class="n">cmd2char</span><span class="p">(</span><span class="n">newcmd</span><span class="p">),</span> <span class="n">cmd2char</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">othercmds</span><span class="p">)));</span>
	<span class="o">*</span><span class="n">cmd</span> <span class="o">|=</span> <span class="n">newcmd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="commit">commit</h2>
<p><a href="https://git.netfilter.org/iptables/tree/libiptc/libiptc.c?id=482c6d3731e2681cb4baae835c294840300197e6#n2517">libiptc/libiptc.c#L2517-#L2695</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2517
</span><span class="lnt">2518
</span><span class="lnt">2519
</span><span class="lnt">2520
</span><span class="lnt">2521
</span><span class="lnt">2522
</span><span class="lnt">2523
</span><span class="lnt">2524
</span><span class="lnt">2525
</span><span class="lnt">2526
</span><span class="lnt">2527
</span><span class="lnt">2528
</span><span class="lnt">2529
</span><span class="lnt">2530
</span><span class="lnt">2531
</span><span class="lnt">2532
</span><span class="lnt">2533
</span><span class="lnt">2534
</span><span class="lnt">2535
</span><span class="lnt">2536
</span><span class="lnt">2537
</span><span class="lnt">2538
</span><span class="lnt">2539
</span><span class="lnt">2540
</span><span class="lnt">2541
</span><span class="lnt">2542
</span><span class="lnt">2543
</span><span class="lnt">2544
</span><span class="lnt">2545
</span><span class="lnt">2546
</span><span class="lnt">2547
</span><span class="lnt">2548
</span><span class="lnt">2549
</span><span class="lnt">2550
</span><span class="lnt">2551
</span><span class="lnt">2552
</span><span class="lnt">2553
</span><span class="lnt">2554
</span><span class="lnt">2555
</span><span class="lnt">2556
</span><span class="lnt">2557
</span><span class="lnt">2558
</span><span class="lnt">2559
</span><span class="lnt">2560
</span><span class="lnt">2561
</span><span class="lnt">2562
</span><span class="lnt">2563
</span><span class="lnt">2564
</span><span class="lnt">2565
</span><span class="lnt">2566
</span><span class="lnt">2567
</span><span class="lnt">2568
</span><span class="lnt">2569
</span><span class="lnt">2570
</span><span class="lnt">2571
</span><span class="lnt">2572
</span><span class="lnt">2573
</span><span class="lnt">2574
</span><span class="lnt">2575
</span><span class="lnt">2576
</span><span class="lnt">2577
</span><span class="lnt">2578
</span><span class="lnt">2579
</span><span class="lnt">2580
</span><span class="lnt">2581
</span><span class="lnt">2582
</span><span class="lnt">2583
</span><span class="lnt">2584
</span><span class="lnt">2585
</span><span class="lnt">2586
</span><span class="lnt">2587
</span><span class="lnt">2588
</span><span class="lnt">2589
</span><span class="lnt">2590
</span><span class="lnt">2591
</span><span class="lnt">2592
</span><span class="lnt">2593
</span><span class="lnt">2594
</span><span class="lnt">2595
</span><span class="lnt">2596
</span><span class="lnt">2597
</span><span class="lnt">2598
</span><span class="lnt">2599
</span><span class="lnt">2600
</span><span class="lnt">2601
</span><span class="lnt">2602
</span><span class="lnt">2603
</span><span class="lnt">2604
</span><span class="lnt">2605
</span><span class="lnt">2606
</span><span class="lnt">2607
</span><span class="lnt">2608
</span><span class="lnt">2609
</span><span class="lnt">2610
</span><span class="lnt">2611
</span><span class="lnt">2612
</span><span class="lnt">2613
</span><span class="lnt">2614
</span><span class="lnt">2615
</span><span class="lnt">2616
</span><span class="lnt">2617
</span><span class="lnt">2618
</span><span class="lnt">2619
</span><span class="lnt">2620
</span><span class="lnt">2621
</span><span class="lnt">2622
</span><span class="lnt">2623
</span><span class="lnt">2624
</span><span class="lnt">2625
</span><span class="lnt">2626
</span><span class="lnt">2627
</span><span class="lnt">2628
</span><span class="lnt">2629
</span><span class="lnt">2630
</span><span class="lnt">2631
</span><span class="lnt">2632
</span><span class="lnt">2633
</span><span class="lnt">2634
</span><span class="lnt">2635
</span><span class="lnt">2636
</span><span class="lnt">2637
</span><span class="lnt">2638
</span><span class="lnt">2639
</span><span class="lnt">2640
</span><span class="lnt">2641
</span><span class="lnt">2642
</span><span class="lnt">2643
</span><span class="lnt">2644
</span><span class="lnt">2645
</span><span class="lnt">2646
</span><span class="lnt">2647
</span><span class="lnt">2648
</span><span class="lnt">2649
</span><span class="lnt">2650
</span><span class="lnt">2651
</span><span class="lnt">2652
</span><span class="lnt">2653
</span><span class="lnt">2654
</span><span class="lnt">2655
</span><span class="lnt">2656
</span><span class="lnt">2657
</span><span class="lnt">2658
</span><span class="lnt">2659
</span><span class="lnt">2660
</span><span class="lnt">2661
</span><span class="lnt">2662
</span><span class="lnt">2663
</span><span class="lnt">2664
</span><span class="lnt">2665
</span><span class="lnt">2666
</span><span class="lnt">2667
</span><span class="lnt">2668
</span><span class="lnt">2669
</span><span class="lnt">2670
</span><span class="lnt">2671
</span><span class="lnt">2672
</span><span class="lnt">2673
</span><span class="lnt">2674
</span><span class="lnt">2675
</span><span class="lnt">2676
</span><span class="lnt">2677
</span><span class="lnt">2678
</span><span class="lnt">2679
</span><span class="lnt">2680
</span><span class="lnt">2681
</span><span class="lnt">2682
</span><span class="lnt">2683
</span><span class="lnt">2684
</span><span class="lnt">2685
</span><span class="lnt">2686
</span><span class="lnt">2687
</span><span class="lnt">2688
</span><span class="lnt">2689
</span><span class="lnt">2690
</span><span class="lnt">2691
</span><span class="lnt">2692
</span><span class="lnt">2693
</span><span class="lnt">2694
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span>
<span class="nf">TC_COMMIT</span><span class="p">(</span><span class="k">struct</span> <span class="n">xtc_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Replace, then map back the counters. */</span>
	<span class="n">STRUCT_REPLACE</span> <span class="o">*</span><span class="n">repl</span><span class="p">;</span>
	<span class="n">STRUCT_COUNTERS_INFO</span> <span class="o">*</span><span class="n">newcounters</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chain_head</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">size_t</span> <span class="n">counterlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_number</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_size</span><span class="p">;</span>

	<span class="n">iptc_fn</span> <span class="o">=</span> <span class="n">TC_COMMIT</span><span class="p">;</span>
	<span class="n">CHECK</span><span class="p">(</span><span class="o">*</span><span class="n">handle</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t commit if nothing changed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">changed</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>

	<span class="n">new_number</span> <span class="o">=</span> <span class="n">iptcc_compile_table_prep</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_number</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_zero</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">repl</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">repl</span><span class="p">)</span> <span class="o">+</span> <span class="n">new_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">repl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_zero</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">repl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">repl</span><span class="p">)</span> <span class="o">+</span> <span class="n">new_size</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c">
</span><span class="c">	TC_DUMP_ENTRIES(*handle);
</span><span class="c"></span><span class="cp">#endif
</span><span class="cp"></span>
	<span class="n">counterlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STRUCT_COUNTERS_INFO</span><span class="p">)</span>
			<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">STRUCT_COUNTERS</span><span class="p">)</span> <span class="o">*</span> <span class="n">new_number</span><span class="p">;</span>

	<span class="cm">/* These are the old counters we will get from kernel */</span>
	<span class="n">repl</span><span class="o">-&gt;</span><span class="n">counters</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">STRUCT_COUNTERS</span><span class="p">)</span>
				<span class="o">*</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">num_entries</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">repl</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_repl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* These are the counters we&#39;re going to put back, later. */</span>
	<span class="n">newcounters</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="n">counterlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newcounters</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_repl_counters</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">newcounters</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">counterlen</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">repl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">repl</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">new_number</span><span class="p">;</span>
	<span class="n">repl</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>

	<span class="n">repl</span><span class="o">-&gt;</span><span class="n">num_counters</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">num_entries</span><span class="p">;</span>
	<span class="n">repl</span><span class="o">-&gt;</span><span class="n">valid_hooks</span>  <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">valid_hooks</span><span class="p">;</span>

	<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;num_entries=%u, size=%u, num_counters=%u</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
		<span class="n">repl</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">,</span> <span class="n">repl</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">repl</span><span class="o">-&gt;</span><span class="n">num_counters</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iptcc_compile_table</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">repl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errno</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_newcounters</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef IPTC_DEBUG2
</span><span class="cp"></span>	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/tmp/libiptc-so_set_replace.blob&#34;</span><span class="p">,</span>
				<span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_WRONLY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">repl</span><span class="p">)</span> <span class="o">+</span> <span class="n">repl</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif
</span><span class="cp"></span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">setsockopt</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">TC_IPPROTO</span><span class="p">,</span> <span class="n">SO_SET_REPLACE</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">repl</span><span class="p">)</span> <span class="o">+</span> <span class="n">repl</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_newcounters</span><span class="p">;</span>

	<span class="cm">/* Put counters back. */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">newcounters</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">newcounters</span><span class="o">-&gt;</span><span class="n">num_counters</span> <span class="o">=</span> <span class="n">new_number</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chains</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rule_head</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

		<span class="cm">/* Builtin chains have their own counters */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iptcc_is_builtin</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;counter for chain-index %u: &#34;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">foot_index</span><span class="p">);</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">counter_map</span><span class="p">.</span><span class="n">maptype</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nl">COUNTER_MAP_NOMAP</span><span class="p">:</span>
				<span class="n">counters_nomap</span><span class="p">(</span><span class="n">newcounters</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">foot_index</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nl">COUNTER_MAP_NORMAL_MAP</span><span class="p">:</span>
				<span class="n">counters_normal_map</span><span class="p">(</span><span class="n">newcounters</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span>
						    <span class="n">c</span><span class="o">-&gt;</span><span class="n">foot_index</span><span class="p">,</span>
						    <span class="n">c</span><span class="o">-&gt;</span><span class="n">counter_map</span><span class="p">.</span><span class="n">mappos</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nl">COUNTER_MAP_ZEROED</span><span class="p">:</span>
				<span class="n">counters_map_zeroed</span><span class="p">(</span><span class="n">newcounters</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span>
						    <span class="n">c</span><span class="o">-&gt;</span><span class="n">foot_index</span><span class="p">,</span>
						    <span class="n">c</span><span class="o">-&gt;</span><span class="n">counter_map</span><span class="p">.</span><span class="n">mappos</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="nl">COUNTER_MAP_SET</span><span class="p">:</span>
				<span class="n">counters_map_set</span><span class="p">(</span><span class="n">newcounters</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">foot_index</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">rules</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DEBUGP</span><span class="p">(</span><span class="s">&#34;counter for index %u: &#34;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">counter_map</span><span class="p">.</span><span class="n">maptype</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="nl">COUNTER_MAP_NOMAP</span><span class="p">:</span>
				<span class="n">counters_nomap</span><span class="p">(</span><span class="n">newcounters</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="nl">COUNTER_MAP_NORMAL_MAP</span><span class="p">:</span>
				<span class="n">counters_normal_map</span><span class="p">(</span><span class="n">newcounters</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span>
						    <span class="n">r</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
						    <span class="n">r</span><span class="o">-&gt;</span><span class="n">counter_map</span><span class="p">.</span><span class="n">mappos</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="nl">COUNTER_MAP_ZEROED</span><span class="p">:</span>
				<span class="n">counters_map_zeroed</span><span class="p">(</span><span class="n">newcounters</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span>
						    <span class="n">r</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
						    <span class="n">r</span><span class="o">-&gt;</span><span class="n">counter_map</span><span class="p">.</span><span class="n">mappos</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="nl">COUNTER_MAP_SET</span><span class="p">:</span>
				<span class="n">counters_map_set</span><span class="p">(</span><span class="n">newcounters</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef IPTC_DEBUG2
</span><span class="cp"></span>	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&#34;/tmp/libiptc-so_set_add_counters.blob&#34;</span><span class="p">,</span>
				<span class="n">O_CREAT</span><span class="o">|</span><span class="n">O_WRONLY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">newcounters</span><span class="p">,</span> <span class="n">counterlen</span><span class="p">);</span>
			<span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif
</span><span class="cp"></span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">setsockopt</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">TC_IPPROTO</span><span class="p">,</span> <span class="n">SO_SET_ADD_COUNTERS</span><span class="p">,</span>
			 <span class="n">newcounters</span><span class="p">,</span> <span class="n">counterlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_newcounters</span><span class="p">;</span>

	<span class="n">free</span><span class="p">(</span><span class="n">repl</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">repl</span><span class="p">);</span>
	<span class="n">free</span><span class="p">(</span><span class="n">newcounters</span><span class="p">);</span>

<span class="nl">finished</span><span class="p">:</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out_free_newcounters</span><span class="p">:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">newcounters</span><span class="p">);</span>
<span class="nl">out_free_repl_counters</span><span class="p">:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">repl</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">);</span>
<span class="nl">out_free_repl</span><span class="p">:</span>
	<span class="n">free</span><span class="p">(</span><span class="n">repl</span><span class="p">);</span>
<span class="nl">out_zero</span><span class="p">:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libiptc/libiptc.c?id=482c6d3731e2681cb4baae835c294840300197e6#n2505">libiptc/libiptc.c#L2505-#L2514</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2505
</span><span class="lnt">2506
</span><span class="lnt">2507
</span><span class="lnt">2508
</span><span class="lnt">2509
</span><span class="lnt">2510
</span><span class="lnt">2511
</span><span class="lnt">2512
</span><span class="lnt">2513
</span><span class="lnt">2514
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">counters_map_set</span><span class="p">(</span><span class="n">STRUCT_COUNTERS_INFO</span> <span class="o">*</span><span class="n">newcounters</span><span class="p">,</span>
                             <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">STRUCT_COUNTERS</span> <span class="o">*</span><span class="n">counters</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Want to set counter (iptables-restore) */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newcounters</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">counters</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">STRUCT_COUNTERS</span><span class="p">));</span>

	<span class="n">DEBUGP_C</span><span class="p">(</span><span class="s">&#34;SET</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libiptc/libiptc.c?id=482c6d3731e2681cb4baae835c294840300197e6#n2467">libiptc/libiptc.c#L2467-#L2471</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">2467
</span><span class="lnt">2468
</span><span class="lnt">2469
</span><span class="lnt">2470
</span><span class="lnt">2471
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">counters_nomap</span><span class="p">(</span><span class="n">STRUCT_COUNTERS_INFO</span> <span class="o">*</span><span class="n">newcounters</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">newcounters</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">STRUCT_COUNTERS</span><span class="p">)</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">});</span>
	<span class="n">DEBUGP_C</span><span class="p">(</span><span class="s">&#34;NOMAP =&gt; zero</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ということで <code>iptc_set_policy</code> 関数の2443行目で <code>c-&gt;counter_map.maptype</code> が <code>COUNTER_MAP_NOMAP</code> にセットされたとしても、
<code>counters_nomap</code> 関数で <code>counters</code> は <code>{0, 0}</code> にセットされることになります。</p>
<h2 id="まとめ">まとめ</h2>
<p><code>iptables-restore</code> に <code>:INPUT ACCEPT [191890:367927864]</code> のような行を入力しても <code>-c</code> オプションを指定しない場合はカウンタは0にリセットされます。</p>
<p><a href="/blog/2017/02/26/iptables-code-reading/">iptablesのコードリーディング</a> に続きます。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
