<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.89.4" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>iptablesのコードリーディング &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>iptablesのコードリーディング</h1>
  <time datetime=2017-02-26T11:40:00&#43;0900 class="post-date">2017-02-26</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#synonymで検索した結果">synonymで検索した結果</a></li>
    <li><a href="#tcp_opts-の参照箇所"><code>tcp_opts</code> の参照箇所</a>
      <ul>
        <li><a href="#original_opts-の参照箇所"><code>original_opts</code> の参照箇所</a></li>
      </ul>
    </li>
    <li><a href="#equivalentで検索した結果">equivalentで検索した結果</a></li>
    <li><a href="#コマンドとオプションの有効な組み合わせ">コマンドとオプションの有効な組み合わせ</a></li>
    <li><a href="#tcp-flags-の値定義"><code>tcp-flags</code> の値定義</a></li>
    <li><a href="#--dports-などの値定義"><code>--dports</code> などの値定義</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="/blog/2017/02/24/iptables-restore-code-reading/">iptables-restoreのコードリーディング</a> の続きです。</p>
<p>サーバ上の <code>iptables</code> の現状の設定が、自分が意図した設定と一致しているか確認したいというニーズがあります。
シェルスクリプトで <code>iptables</code> コマンドを順次実行する方式は大変すぎるので、 <code>iptables-restore</code> に自分の設定ファイルを渡して設定を反映させ、現在の状態は <code>iptables-save</code> で出力して、設定ファイルとこの出力を比較したらどうかと考えました。</p>
<p>しかし、この方式でもいくつか気をつける必要があります (これで全部ではないかもしれません)。</p>
<ul>
<li><code>iptables-restore</code> への入力ファイルに書いていないテーブル (<code>*</code> テーブル名 の行から <code>COMMIT</code> の行まで)も <code>iptables-save</code> では出力される。</li>
<li><code>iptables-restore</code> への入力ファイルで複数のテーブルを指定した場合、 <code>iptables-save</code> では特定の順序で出力される。</li>
<li><code>iptables-restore</code> への入力ファイルにコメント行(<code>#</code> で始まる行)を含めていても、 <code>iptables-save</code> では出力されない。</li>
<li><code>iptables-save</code> ではテーブルの前後に <code># Generated by iptables-save v1.4.21 on Sun Feb 26 03:40:03 2017</code> と <code># Completed on Sun Feb 26 03:40:03 2017</code> のようなコメント行が出力される。</li>
<li>チェーン (<code>:</code> で始まる行) のカウンタ (<code>[整数:整数]</code>) の値は <code>iptables-restore</code> への入力ファイルと <code>iptables-save</code> の出力ではほとんどのケースは一致しない。 <code>iptables-restore</code> 実行時から <code>iptables-save</code> 実行時までにそのチェーンでパケットを処理していなければ一致するが、設定直後に確認するケースを除いてたいていは一致しないことになる。</li>
<li>既に追加したルールセットの途中に <code>-I</code> でルールを追加すると、 <code>iptables-save</code> ではソートされた <code>-A</code> のリストとして出力される。</li>
<li>1つのコマンド内で複数の引数の順序は任意に指定可能だが、 <code>iptables-save</code> では特定の順番で出力される。</li>
<li><code>--destination-port</code> と <code>-dport</code> のように同一のオプションに2通りの書き方（シノニム）が用意されているものがある。</li>
<li><code>--tcp-flags</code> の値に <code>ALL</code> を指定すると、 <code>iptables-save</code> では <code>FIN,SYN,RST,PSH,ACK,URG</code> に展開される。</li>
<li><code>--tcp-flags</code> の値に複数の値を指定した場合、 <code>iptables-save</code> では特定の順番で出力される。</li>
<li><code>--syn</code> を指定すると、 <code>iptables-save</code> では <code>--tcp-flags FIN,SYN,RST,ACK SYN</code> に展開される。</li>
<li><code>--src</code> や <code>--destination</code> に <code>0.0.0.0/0</code> を指定した場合、 <code>iptables-save</code> では出力が省略される。</li>
</ul>
<p>以下に例を示します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">[root@centos7 iptables-experiment]# cat iptables.conf
</span><span class="go">*filter
</span><span class="go">:INPUT DROP [0:0]
</span><span class="go">:FORWARD ACCEPT [0:0]
</span><span class="go">:OUTPUT ACCEPT [0:0]
</span><span class="go">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
</span><span class="go"></span><span class="gp"># </span>this comment will not be printed with iptables-save
<span class="go">-A INPUT -p tcp -m tcp --tcp-flags ALL NONE -j DROP
</span><span class="go">-A INPUT -p tcp -m tcp ! --syn -m state --state NEW -j DROP
</span><span class="go">-A INPUT -p tcp -m tcp --tcp-flags ALL ALL -j DROP
</span><span class="go">-A INPUT -i lo -j ACCEPT
</span><span class="go">-A INPUT -p icmp -j ACCEPT
</span><span class="go">-A INPUT -p tcp -m tcp --destination 0.0.0.0/0 --dport 443 -j ACCEPT
</span><span class="go">-I INPUT 7 -p tcp -m tcp --src 0.0.0.0/0 --destination-port 80 -j ACCEPT
</span><span class="go">-I INPUT 7 -p tcp -m tcp --src 192.168.0.0/24 --destination-port 22 -j ACCEPT
</span><span class="go">COMMIT
</span><span class="go">*nat
</span><span class="go">:PREROUTING ACCEPT [0:0]
</span><span class="go">:INPUT ACCEPT [0:0]
</span><span class="go">:OUTPUT ACCEPT [0:0]
</span><span class="go">:POSTROUTING ACCEPT [0:0]
</span><span class="go">COMMIT
</span><span class="go">[root@centos7 iptables-experiment]# iptables-restore &lt; iptables.conf
</span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">[root@centos7 iptables-experiment]# iptables-save
</span><span class="go"></span><span class="gp"># </span>Generated by iptables-save v1.4.21 on Sun Feb <span class="m">26</span> 03:40:03 <span class="m">2017</span>
<span class="go">*mangle
</span><span class="go">:PREROUTING ACCEPT [2:668]
</span><span class="go">:INPUT ACCEPT [2:668]
</span><span class="go">:FORWARD ACCEPT [0:0]
</span><span class="go">:OUTPUT ACCEPT [2:656]
</span><span class="go">:POSTROUTING ACCEPT [2:656]
</span><span class="go">COMMIT
</span><span class="go"></span><span class="gp"># </span>Completed on Sun Feb <span class="m">26</span> 03:40:03 <span class="m">2017</span>
<span class="gp"># </span>Generated by iptables-save v1.4.21 on Sun Feb <span class="m">26</span> 03:40:03 <span class="m">2017</span>
<span class="go">*nat
</span><span class="go">:PREROUTING ACCEPT [0:0]
</span><span class="go">:INPUT ACCEPT [0:0]
</span><span class="go">:OUTPUT ACCEPT [0:0]
</span><span class="go">:POSTROUTING ACCEPT [0:0]
</span><span class="go">COMMIT
</span><span class="go"></span><span class="gp"># </span>Completed on Sun Feb <span class="m">26</span> 03:40:03 <span class="m">2017</span>
<span class="gp"># </span>Generated by iptables-save v1.4.21 on Sun Feb <span class="m">26</span> 03:40:03 <span class="m">2017</span>
<span class="go">*filter
</span><span class="go">:INPUT DROP [0:0]
</span><span class="go">:FORWARD ACCEPT [0:0]
</span><span class="go">:OUTPUT ACCEPT [0:0]
</span><span class="go">-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
</span><span class="go">-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP
</span><span class="go">-A INPUT -p tcp -m tcp ! --tcp-flags FIN,SYN,RST,ACK SYN -m state --state NEW -j DROP
</span><span class="go">-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,PSH,ACK,URG -j DROP
</span><span class="go">-A INPUT -i lo -j ACCEPT
</span><span class="go">-A INPUT -p icmp -j ACCEPT
</span><span class="go">-A INPUT -s 192.168.0.0/24 -p tcp -m tcp --dport 22 -j ACCEPT
</span><span class="go">-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
</span><span class="go">-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
</span><span class="go">COMMIT
</span><span class="go"></span><span class="gp"># </span>Completed on Sun Feb <span class="m">26</span> 03:40:03 <span class="m">2017</span>
</code></pre></div><h2 id="synonymで検索した結果">synonymで検索した結果</h2>
<p>なお、 IPv6 関連は省略しています。</p>
<p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n29">extensions/libxt_tcp.c#L29-#L38</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">tcp_opts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;source-port&#34;</span><span class="p">,</span>      <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;1&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;sport&#34;</span><span class="p">,</span>            <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;1&#39;</span><span class="p">},</span> <span class="cm">/* synonym */</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;destination-port&#34;</span><span class="p">,</span> <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;2&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;dport&#34;</span><span class="p">,</span>            <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;2&#39;</span><span class="p">},</span> <span class="cm">/* synonym */</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;syn&#34;</span><span class="p">,</span>              <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;3&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;tcp-flags&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;4&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;tcp-option&#34;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;5&#39;</span><span class="p">},</span>
	<span class="n">XT_GETOPT_TABLEEND</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div><p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n76">iptables/iptables.c#L76-#L114</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">original_opts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;append&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;delete&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;D&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;check&#34;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;C&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;insert&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;I&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;replace&#34;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;list&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;L&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;list-rules&#34;</span><span class="p">,</span>    <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;S&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;flush&#34;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;F&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;zero&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;Z&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;new-chain&#34;</span><span class="p">,</span>     <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;N&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;delete-chain&#34;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;X&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;rename-chain&#34;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;E&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;policy&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;P&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;source&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;s&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;destination&#34;</span><span class="p">,</span>   <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;src&#34;</span><span class="p">,</span>           <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;s&#39;</span><span class="p">},</span> <span class="cm">/* synonym */</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;dst&#34;</span><span class="p">,</span>           <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;d&#39;</span><span class="p">},</span> <span class="cm">/* synonym */</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;protocol&#34;</span><span class="p">,</span>      <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;p&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;in-interface&#34;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;i&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;jump&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;j&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;table&#34;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;t&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;match&#34;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;m&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;numeric&#34;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;n&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;out-interface&#34;</span><span class="p">,</span> <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;o&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;verbose&#34;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;v&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;wait&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;w&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;exact&#34;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;x&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;fragments&#34;</span><span class="p">,</span>     <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;f&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;version&#34;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;V&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;help&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;h&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;line-numbers&#34;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;modprobe&#34;</span><span class="p">,</span>      <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;M&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;set-counters&#34;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;c&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;goto&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;g&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;ipv4&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;4&#39;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;ipv6&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sc">&#39;6&#39;</span><span class="p">},</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>
</code></pre></div><h2 id="tcp_opts-の参照箇所"><code>tcp_opts</code> の参照箇所</h2>
<p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n365">extensions/libxt_tcp.c#L365-#L383</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">struct</span> <span class="n">xtables_match</span> <span class="n">tcp_match</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>		<span class="o">=</span> <span class="n">NFPROTO_UNSPEC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">XTABLES_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">XT_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_tcp</span><span class="p">)),</span>
	<span class="p">.</span><span class="n">userspacesize</span>	<span class="o">=</span> <span class="n">XT_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_tcp</span><span class="p">)),</span>
	<span class="p">.</span><span class="n">help</span>		<span class="o">=</span> <span class="n">tcp_help</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">tcp_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parse</span>		<span class="o">=</span> <span class="n">tcp_parse</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print</span>		<span class="o">=</span> <span class="n">tcp_print</span><span class="p">,</span>
	<span class="p">.</span><span class="n">save</span>		<span class="o">=</span> <span class="n">tcp_save</span><span class="p">,</span>
	<span class="p">.</span><span class="n">extra_opts</span>	<span class="o">=</span> <span class="n">tcp_opts</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xtables_register_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_match</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p><a href="https://git.netfilter.org/iptables/tree/libxtables/xtables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n821">libxtables/xtables.c#L821-#L861</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">xtables_register_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">xtables_match</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;%s: match %s&lt;%u&gt; is missing a version</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
		        <span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">XTABLES_VERSION</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;%s: match </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> has version </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, &#34;</span>
		        <span class="s">&#34;but </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> is required.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
			<span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">me</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">XTABLES_VERSION</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">XT_EXTENSION_MAXNAMELEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;%s: match `%s&#39; has invalid name</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
			<span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&gt;=</span> <span class="n">NPROTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="s">&#34;%s: BUG: match %s has invalid protocol family</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
			<span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">x6_options</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">xtables_option_metavalidate</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">x6_options</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">extra_opts</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">xtables_check_options</span><span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">extra_opts</span><span class="p">);</span>

	<span class="cm">/* ignore not interested match */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">afinfo</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&amp;&amp;</span> <span class="n">me</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">!=</span> <span class="n">AF_UNSPEC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* place on linked list of matches pending full registration */</span>
	<span class="n">me</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">xtables_pending_matches</span><span class="p">;</span>
	<span class="n">xtables_pending_matches</span> <span class="o">=</span> <span class="n">me</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p><a href="https://git.netfilter.org/iptables/tree/libxtables/xtables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n810">libxtables/xtables.c#L810-#L819</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">xtables_check_options</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="o">++</span><span class="n">opt</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">XT_OPTION_OFFSET_SCALE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;%s: Extension %s uses invalid &#34;</span>
			        <span class="s">&#34;option value %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">xt_params</span><span class="o">-&gt;</span><span class="n">program_name</span><span class="p">,</span>
			        <span class="n">name</span><span class="p">,</span> <span class="n">opt</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="original_opts-の参照箇所"><code>original_opts</code> の参照箇所</h3>
<p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n118">iptables/iptables.c#L118-#L123</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">xtables_globals</span> <span class="n">iptables_globals</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">option_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">program_version</span> <span class="o">=</span> <span class="n">IPTABLES_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">orig_opts</span> <span class="o">=</span> <span class="n">original_opts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit_err</span> <span class="o">=</span> <span class="n">iptables_exit_error</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div><p><code>iptables_globals.orig_opts</code> の参照箇所のうちの1つ。</p>
<p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n1300">iptables/iptables.c#L1300-#L1306</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* Merge options for non-cloned matches */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">x6_options</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="n">opts</span> <span class="o">=</span> <span class="n">xtables_options_xfrm</span><span class="p">(</span><span class="n">iptables_globals</span><span class="p">.</span><span class="n">orig_opts</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span>
				    <span class="n">m</span><span class="o">-&gt;</span><span class="n">x6_options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">option_offset</span><span class="p">);</span>
<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">extra_opts</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="n">opts</span> <span class="o">=</span> <span class="n">xtables_merge_options</span><span class="p">(</span><span class="n">iptables_globals</span><span class="p">.</span><span class="n">orig_opts</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span>
				     <span class="n">m</span><span class="o">-&gt;</span><span class="n">extra_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">option_offset</span><span class="p">);</span>
</code></pre></div><p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n171">iptables/iptables.c#L171</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define opts iptables_globals.opts
</span></code></pre></div><h2 id="equivalentで検索した結果">equivalentで検索した結果</h2>
<p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n12">extensions/libxt_tcp.c#L12-#L27</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_help</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span>
<span class="s">&#34;tcp match options:</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34;[!] --tcp-flags mask comp	match when TCP flags &amp; mask == comp</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34;				(Flags: SYN ACK FIN RST URG PSH ALL NONE)</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34;[!] --syn			match when only SYN flag set</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34;				(equivalent to --tcp-flags SYN,RST,ACK,FIN SYN)</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34;[!] --source-port port[:port]</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34; --sport ...</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34;				match source port(s)</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34;[!] --destination-port port[:port]</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34; --dport ...</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34;				match destination port(s)</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="s">&#34;[!] --tcp-option number        match if TCP option set</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><h2 id="コマンドとオプションの有効な組み合わせ">コマンドとオプションの有効な組み合わせ</h2>
<p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n125">iptables/iptables.c#L125-#L169</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* Table of legal combinations of commands and options.  If any of the
</span><span class="cm"> * given commands make an option legal, that option is legal (applies to
</span><span class="cm"> * CMD_LIST and CMD_ZERO only).
</span><span class="cm"> * Key:
</span><span class="cm"> *  +  compulsory
</span><span class="cm"> *  x  illegal
</span><span class="cm"> *     optional
</span><span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">commands_v_options</span><span class="p">[</span><span class="n">NUMBER_OF_CMD</span><span class="p">][</span><span class="n">NUMBER_OF_OPT</span><span class="p">]</span> <span class="o">=</span>
<span class="cm">/* Well, it&#39;s better than &#34;Re: Linux vs FreeBSD&#34; */</span>
<span class="p">{</span>
	<span class="cm">/*     -n  -s  -d  -p  -j  -v  -x  -i  -o --line -c -f */</span>
<span class="cm">/*INSERT*/</span>    <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">},</span>
<span class="cm">/*DELETE*/</span>    <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">},</span>
<span class="cm">/*DELETE_NUM*/</span><span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*REPLACE*/</span>   <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">},</span>
<span class="cm">/*APPEND*/</span>    <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">},</span>
<span class="cm">/*LIST*/</span>      <span class="p">{</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*FLUSH*/</span>     <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*ZERO*/</span>      <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*NEW_CHAIN*/</span> <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*DEL_CHAIN*/</span> <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*SET_POLICY*/</span><span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*RENAME*/</span>    <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*LIST_RULES*/</span><span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*ZERO_NUM*/</span>  <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">},</span>
<span class="cm">/*CHECK*/</span>     <span class="p">{</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39;x&#39;</span><span class="p">,</span><span class="sc">&#39; &#39;</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">inverse_for_options</span><span class="p">[</span><span class="n">NUMBER_OF_OPT</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
<span class="cm">/* -n */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -s */</span> <span class="n">IPT_INV_SRCIP</span><span class="p">,</span>
<span class="cm">/* -d */</span> <span class="n">IPT_INV_DSTIP</span><span class="p">,</span>
<span class="cm">/* -p */</span> <span class="n">XT_INV_PROTO</span><span class="p">,</span>
<span class="cm">/* -j */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -v */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -x */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -i */</span> <span class="n">IPT_INV_VIA_IN</span><span class="p">,</span>
<span class="cm">/* -o */</span> <span class="n">IPT_INV_VIA_OUT</span><span class="p">,</span>
<span class="cm">/*--line*/</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -c */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -f */</span> <span class="n">IPT_INV_FRAG</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div><h2 id="tcp-flags-の値定義"><code>tcp-flags</code> の値定義</h2>
<p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n63">extensions/libxt_tcp.c#L63-#L77</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">tcp_flag_names</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_flag_names</span> <span class="n">tcp_flag_names</span><span class="p">[]</span>
<span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="s">&#34;FIN&#34;</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&#34;SYN&#34;</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&#34;RST&#34;</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&#34;PSH&#34;</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&#34;ACK&#34;</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&#34;URG&#34;</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&#34;ALL&#34;</span><span class="p">,</span> <span class="mh">0x3F</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&#34;NONE&#34;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>
</code></pre></div><p><code>strcasecmp</code> で大文字小文字無視で比較していました。
<a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n79">extensions/libxt_tcp.c#L79-#L102</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">parse_tcp_flag</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">);</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&#34;,&#34;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tcp_flag_names</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">tcp_flag_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">|=</span> <span class="n">tcp_flag_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flag</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tcp_flag_names</span><span class="p">))</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="s">&#34;Unknown TCP flag `%s&#39;&#34;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><h2 id="--dports-などの値定義"><code>--dports</code> などの値定義</h2>
<p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n135">extensions/libxt_tcp.c#L135-#L138</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="cp">#define TCP_SRC_PORTS 0x01
</span><span class="cp">#define TCP_DST_PORTS 0x02
</span><span class="cp">#define TCP_FLAGS 0x04
</span><span class="cp">#define TCP_OPTION	0x08
</span></code></pre></div><p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n140">extensions/libxt_tcp.c#L140-#L204</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">int</span>
<span class="nf">tcp_parse</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">invert</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
          <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xt_entry_match</span> <span class="o">**</span><span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xt_tcp</span> <span class="o">*</span><span class="n">tcpinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xt_tcp</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="n">match</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;1&#39;</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_SRC_PORTS</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="s">&#34;Only one `--source-port&#39; allowed&#34;</span><span class="p">);</span>
		<span class="n">parse_tcp_ports</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">spts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
			<span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">invflags</span> <span class="o">|=</span> <span class="n">XT_TCP_INV_SRCPT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCP_SRC_PORTS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;2&#39;</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_DST_PORTS</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="s">&#34;Only one `--destination-port&#39; allowed&#34;</span><span class="p">);</span>
		<span class="n">parse_tcp_ports</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">dpts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
			<span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">invflags</span> <span class="o">|=</span> <span class="n">XT_TCP_INV_DSTPT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCP_DST_PORTS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;3&#39;</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_FLAGS</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="s">&#34;Only one of `--syn&#39; or `--tcp-flags&#39; &#34;</span>
				   <span class="s">&#34; allowed&#34;</span><span class="p">);</span>
		<span class="n">parse_tcp_flags</span><span class="p">(</span><span class="n">tcpinfo</span><span class="p">,</span> <span class="s">&#34;SYN,RST,ACK,FIN&#34;</span><span class="p">,</span> <span class="s">&#34;SYN&#34;</span><span class="p">,</span> <span class="n">invert</span><span class="p">);</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCP_FLAGS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;4&#39;</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_FLAGS</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="s">&#34;Only one of `--syn&#39; or `--tcp-flags&#39; &#34;</span>
				   <span class="s">&#34; allowed&#34;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">]</span>
		    <span class="o">||</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span> <span class="o">||</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;!&#39;</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="s">&#34;--tcp-flags requires two args.&#34;</span><span class="p">);</span>

		<span class="n">parse_tcp_flags</span><span class="p">(</span><span class="n">tcpinfo</span><span class="p">,</span> <span class="n">optarg</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">],</span>
				<span class="n">invert</span><span class="p">);</span>
		<span class="n">optind</span><span class="o">++</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCP_FLAGS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;5&#39;</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_OPTION</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="s">&#34;Only one `--tcp-option&#39; allowed&#34;</span><span class="p">);</span>
		<span class="n">parse_tcp_option</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">option</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
			<span class="n">tcpinfo</span><span class="o">-&gt;</span><span class="n">invflags</span> <span class="o">|=</span> <span class="n">XT_TCP_INV_OPTION</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">TCP_OPTION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
