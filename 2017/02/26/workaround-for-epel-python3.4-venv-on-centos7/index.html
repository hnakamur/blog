<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>CentOS 7のepelでインストールしたpython3.4でvenvを使うとエラーになる件の回避策</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/02/26/workaround-for-epel-python3.4-venv-on-centos7/" rel="bookmark"
           title="Permalink to CentOS 7のepelでインストールしたpython3.4でvenvを使うとエラーになる件の回避策">CentOS 7のepelでインストールしたpython3.4でvenvを使うとエラーになる件の回避策</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-02-25T00:45:00+09:00">
                Published: 2017-02-25
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/centos.html">centos</a> <a href="../../../../tag/python.html">python</a> <a href="../../../../tag/venv.html">venv</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>CentOS 7のpythonパッケージは2.7.xなので、3系を使うには別途インストールする必要があります。
EPELの <tt class="docutils literal">python34</tt> パッケージを使うと <tt class="docutils literal">python3 <span class="pre">-m</span> venv venv</tt> でエラーになるという問題が起きたのですが、 <a class="reference external" href="https://f-o.org.uk/2016/python3-centos-and-pip.html">Floating Octothorpe: Python3, CentOS and pip</a> の記事で解決したのでメモです。</p>
</div>
<div class="section" id="ius-community-repo-python-3-6-x">
<h2>IUS Community Repo のPython 3.6.x</h2>
<p><a class="reference external" href="https://wiki.centos.org/AdditionalResources/Repositories">AdditionalResources/Repositories - CentOS Wiki</a> の <a class="reference external" href="https://ius.io/">IUS Community Repo</a> なら <tt class="docutils literal">python36u</tt> というパッケージ名でPython 3.6.xがインストールできます。
<a class="reference external" href="https://github.com/iuscommunity-pkg?utf8=%E2%9C%93&amp;q=python36u&amp;type=&amp;language=">IUS Community Project Packages</a> を見ると他に <tt class="docutils literal"><span class="pre">python36u-setuptools</span></tt>, <tt class="docutils literal"><span class="pre">uwsgi-plugin-python36u</span></tt>, <tt class="docutils literal"><span class="pre">python36u-pip</span></tt>, <tt class="docutils literal"><span class="pre">python36u-lxml</span></tt>, <tt class="docutils literal"><span class="pre">python36u-psycopg2</span></tt> パッケージが提供されています。</p>
<p>こちらは <tt class="docutils literal">python3.6 <span class="pre">-m</span> venv venv</tt> で問題なくvirtualenv環境が作成できました。</p>
</div>
<div class="section" id="extra-packages-for-enterprise-linux-epel-python-3-4-x">
<h2>Extra Packages for Enterprise Linux (EPEL)のPython 3.4.x</h2>
<p>EPELでも <tt class="docutils literal">python34</tt> というパッケージ名でPython 3.4.xがインストールできます。 IUS Community Repoの3.6.xよりは古いですが、 <tt class="docutils literal"><span class="pre">python34-*</span></tt> のパッケージはこちらのほうが多いです（とは言え <tt class="docutils literal">venv</tt> を使うのであればあまり関係無いとも言えますが）。
また、EPELは他でも使うので私は常に有効にしています。
サードパーティのレポジトリの種類はなるべく限定しておきたいと考えるとIUS Community Repoは使わずにEPELの <tt class="docutils literal">python34</tt> を使うという選択肢もありえます。</p>
</div>
<div class="section" id="epelpython-3-4venv">
<h2>EPELのPython 3.4でvenvを使うとエラー</h2>
<p><tt class="docutils literal">python3.4 <span class="pre">-m</span> venv venv</tt> を実行すると以下のようなエラーが出ました（ここでは <tt class="docutils literal">/home/admin/blog</tt> というディレクトリで実行しました）。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> python3.4 -m venv venv
<span class="go">Error: Command &#39;[&#39;/home/admin/blog/venv/bin/python3.4&#39;, &#39;-Im&#39;, &#39;ensurepip&#39;, &#39;--upgrade&#39;, &#39;--default-pip&#39;]&#39; returned non-zero exit status 1</span>
</pre></div>
<p>エラーになったコマンドを直接実行すると <tt class="docutils literal"><span class="pre">/usr/lib64/python3.4/ensurepip/_bundled/setuptools-20.10.1-py2.py3-none-any.whl</span></tt> というファイルが無くてエラーになっていることがわかります。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> /home/admin/blog/venv/bin/python3.4 -Im ensurepip --upgrade --default-pip
<span class="go">Traceback (most recent call last):</span>
<span class="go">  File &quot;/usr/lib64/python3.4/runpy.py&quot;, line 170, in _run_module_as_main</span>
<span class="go">    &quot;__main__&quot;, mod_spec)</span>
<span class="go">  File &quot;/usr/lib64/python3.4/runpy.py&quot;, line 85, in _run_code</span>
<span class="go">    exec(code, run_globals)</span>
<span class="go">  File &quot;/usr/lib64/python3.4/ensurepip/__main__.py&quot;, line 4, in &lt;module&gt;</span>
<span class="go">    ensurepip._main()</span>
<span class="go">  File &quot;/usr/lib64/python3.4/ensurepip/__init__.py&quot;, line 209, in _main</span>
<span class="go">    default_pip=args.default_pip,</span>
<span class="go">  File &quot;/usr/lib64/python3.4/ensurepip/__init__.py&quot;, line 98, in bootstrap</span>
<span class="go">    &quot;_bundled/{}&quot;.format(wheel_name),</span>
<span class="go">  File &quot;/usr/lib64/python3.4/pkgutil.py&quot;, line 629, in get_data</span>
<span class="go">    return loader.get_data(resource_name)</span>
<span class="go">  File &quot;&lt;frozen importlib._bootstrap&gt;&quot;, line 1623, in get_data</span>
<span class="go">FileNotFoundError: [Errno 2] No such file or directory: &#39;/usr/lib64/python3.4/ensurepip/_bundled/setuptools-20.10.1-py2.py3-none-any.whl&#39;</span>
</pre></div>
<p>この問題は
<a class="reference external" href="https://bugzilla.redhat.com/show_bug.cgi?id=1263057">Bug 1263057 – pyvenv3.4 doesn't work without pip</a>
に報告されています。</p>
</div>
<div class="section" id="id2">
<h2>EPELのPython 3.4でvenvを使うための回避策</h2>
<p>EPELのインストールからのコマンドをまとめると以下のようになります。</p>
<div class="highlight"><pre><span></span><span class="go">sudo yum install epel-release</span>
<span class="go">sudo yum install python34 python34-setuptools python34-pip</span>
<span class="go">sudo mkdir -p /usr/lib64/python3.4/ensurepip/_bundled</span>
<span class="go">sudo curl -o /usr/lib64/python3.4/ensurepip/_bundled/setuptools-20.10.1-py2.py3-none-any.whl \</span>
<span class="go">    https://pypi.python.org/packages/c5/e2/72d706eeda837564b9fecdc8b2bf48b33467ae928ed05d4ac157463c90fb/setuptools-20.10.1-py2.py3-none-any.whl</span>
<span class="go">sudo curl -o /usr/lib64/python3.4/ensurepip/_bundled/pip-8.1.1-py2.py3-none-any.whl \</span>
<span class="go">    https://pypi.python.org/packages/31/6a/0f19a7edef6c8e5065f4346137cc2a08e22e141942d66af2e1e72d851462/pip-8.1.1-py2.py3-none-any.whl</span>
</pre></div>
<p><a class="reference external" href="https://f-o.org.uk/2016/python3-centos-and-pip.html">Floating Octothorpe: Python3, CentOS and pip</a> に詳しく書かれていますが、
上記の <tt class="docutils literal">setuptools</tt> と <tt class="docutils literal">pip</tt> のバージョンは <tt class="docutils literal">/usr/lib64/python3.4/ensurepip/__init__.py</tt> に書いてあるバージョンに一致させる必要があります。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">_SETUPTOOLS_VERSION</span> <span class="o">=</span> <span class="s2">&quot;20.10.1&quot;</span>

<span class="n">_PIP_VERSION</span> <span class="o">=</span> <span class="s2">&quot;8.1.1&quot;</span>
</pre></div>
</td></tr></table></div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>