<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.84.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>git-buildpackageのpatch-queue機能を試してみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>git-buildpackageのpatch-queue機能を試してみた</h1>
  <time datetime=2017-07-14T11:20:00&#43;0900 class="post-date">2017-07-14</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#パッチの準備">パッチの準備</a>
      <ul>
        <li><a href="#hg形式のパッチをgit形式のパッチに変換するスクリプト">hg形式のパッチをgit形式のパッチに変換するスクリプト</a></li>
        <li><a href="#hg形式のパッチを保存">hg形式のパッチを保存</a></li>
        <li><a href="#git形式のパッチに変換">git形式のパッチに変換</a></li>
      </ul>
    </li>
    <li><a href="#パッチのインポート">パッチのインポート</a></li>
    <li><a href="#パッチの適用">パッチの適用</a></li>
    <li><a href="#パッチの再生成">パッチの再生成</a></li>
    <li><a href="#debianchangelog編集">debian/changelog編集</a></li>
    <li><a href="#ソースパッケージのビルド">ソースパッケージのビルド</a></li>
    <li><a href="#バイナリパッケージのビルド">バイナリパッケージのビルド</a></li>
    <li><a href="#gitのタグ作成">gitのタグ作成</a></li>
    <li><a href="#upstreamのソースをバージョンアップしたときのパッチ更新">upstreamのソースをバージョンアップしたときのパッチ更新</a></li>
    <li><a href="#おわりに">おわりに</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="/blog/2017/07/14/build-nginx-deb-with-ngx_http_v2_upstream/">ngx_http_v2_upstreamモジュールを追加したnginxのdebパッケージを作ってみた</a> で <code>quilt</code> を使ったパッチ適用を経験してみて、不慣れなこともありちょっと面倒な気がしました。</p>
<p>そこで、 <code>git-buildpackage</code> の `Working with patches](<a href="http://honk.sigxcpu.org/projects/git-buildpackage/manual-html/gbp.patches.html">http://honk.sigxcpu.org/projects/git-buildpackage/manual-html/gbp.patches.html</a>) を試してみることにしました。</p>
<p>前回作業したgitのレポジトリで以下のコミットに戻してから、以下の手順を試しました。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">commit a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60
Author: Konstantin Pavlov &lt;thresh@nginx.com&gt;
Date:   Tue Jul 11 22:06:07 2017

	Imported Debian patch 1.13.3-1~xenial
</code></pre></div><h2 id="パッチの準備">パッチの準備</h2>
<p>上記のページを見ると <code>debian/patches/</code> ディレクトリに <code>git-quiltimport (1)</code> でパース可能なパッチファイルをおいておく必要があるとのことです。</p>
<h3 id="hg形式のパッチをgit形式のパッチに変換するスクリプト">hg形式のパッチをgit形式のパッチに変換するスクリプト</h3>
<p>今回は元のパッチが <code>hg (mercurial)</code> の形式なので、これを変換できないかと検索してみると</p>
<p><a href="https://github.com/mozilla/moz-git-tools/blob/master/hg-patch-to-git-patch">moz-git-tools/hg-patch-to-git-patch at master · mozilla/moz-git-tools</a></p>
<p>というPythonスクリプトが見つかったので、ありがたくこれを使わせていただくことにしました。</p>
<p>私が試したバージョンは以下の通りです。</p>
<p><a href="https://github.com/mozilla/moz-git-tools/blob/d9009081a467ace43c0a8f535089a7c66a22c587/hg-patch-to-git-patch">moz-git-tools/hg-patch-to-git-patch at d9009081a467ace43c0a8f535089a7c66a22c587 · mozilla/moz-git-tools</a></p>
<p>これを <code>/usr/local/bin/hg-patch-to-git-patch</code> というファイル名で保存し、実行パーミションをつけておきます。　</p>
<h3 id="hg形式のパッチを保存">hg形式のパッチを保存</h3>
<p><code>~/nginx.org-deb/ngx_http_v2_upstream-hg-patches</code> というディレクトリにhg形式のパッチを保存することにしました。
スパムメール防止用に変換されているメールアドレス内の <code>at</code> と前後のスペースを <code>@</code> に戻してパッチを保存します。</p>
<pre><code class="language-console" data-lang="console">$ ls
ngx_http_v2_upstream-01-of-14.diff  ngx_http_v2_upstream-06-of-14.diff  ngx_http_v2_upstream-11-of-14.diff
ngx_http_v2_upstream-02-of-14.diff  ngx_http_v2_upstream-07-of-14.diff  ngx_http_v2_upstream-12-of-14.diff
ngx_http_v2_upstream-03-of-14.diff  ngx_http_v2_upstream-08-of-14.diff  ngx_http_v2_upstream-13-of-14.diff
ngx_http_v2_upstream-04-of-14.diff  ngx_http_v2_upstream-09-of-14.diff  ngx_http_v2_upstream-14-of-14.diff
ngx_http_v2_upstream-05-of-14.diff  ngx_http_v2_upstream-10-of-14.diff
</code></pre><h3 id="git形式のパッチに変換">git形式のパッチに変換</h3>
<p>git形式のパッチを保存するディレクトリ <code>~/nginx.org-deb/ngx_http_v2_upstream-git-patches</code> を作成し、上記のスクリプトで変換します。</p>
<pre><code class="language-console" data-lang="console">$ mkdir ../ngx_http_v2_upstream-git-patches
$ for i in *; do hg-patch-to-git-patch $i &gt; ../ngx_http_v2_upstream-git-patches/$i ; done
</code></pre><p>変換後のgit形式のパッチの先頭は以下のようになっていました（メールアドレス内の <code>@</code> はスパムメール防止用に <code>at</code> ＋前後の空白に置換しています）。</p>
<pre><code class="language-console" data-lang="console">$ head ../ngx_http_v2_upstream-git-patches/ngx_http_v2_upstream-01-of-14.diff
From: Piotr Sikora &lt;piotrsikora at google.com&gt;
Date: 1491708381 -0700
Subject: Output chain: propagate last_buf flag to c-&gt;send_chain().

Signed-off-by: Piotr Sikora &lt;piotrsikora at google.com&gt;

diff -r a39bc74873fa -r 5f5d70428655 src/core/ngx_output_chain.c
--- a/src/core/ngx_output_chain.c
+++ b/src/core/ngx_output_chain.c
@@ -658,6 +658,7 @@ ngx_chain_writer(void *data, ngx_chain_t
</code></pre><pre><code class="language-console" data-lang="console">$ head -13 ../ngx_http_v2_upstream-git-patches/ngx_http_v2_upstream-09-of-14.diff
From: Piotr Sikora &lt;piotrsikora at google.com&gt;
Date: 1489621682 -0700
Subject: Proxy: add &quot;proxy_ssl_alpn&quot; directive.

ALPN is used here only to indicate which version of the HTTP protocol
is going to be used and we doesn't verify that upstream agreed to it.

Please note that upstream is allowed to reject SSL connection with a
fatal &quot;no_application_protocol&quot; alert if it doesn't support it.

Signed-off-by: Piotr Sikora &lt;piotrsikora at google.com&gt;

diff -r 154ca6c5e62a -r 96075d4cd2a6 src/event/ngx_event_openssl.c
</code></pre><h2 id="パッチのインポート">パッチのインポート</h2>
<p>パッチをインポートは前回同様 <code>dquilt import</code> で行います。
パッチはスタックとして管理されるので14番のパッチから1番のパッチへと逆順にインポートしています。</p>
<pre><code class="language-console" data-lang="console">$ cd ~/.ghq/github.com/hnakamur/nginx-deb
$ for i in {14..01}; do dquilt import ~/nginx.org-deb/ngx_http_v2_upstream-git-patches/ngx_http_v2_upstream-$i-of-14.diff; done
</code></pre><p>インポートしたパッチをgitに追加してコミットしておきます。</p>
<pre><code class="language-console" data-lang="console">$ git status -sb
## patch-queue/master
?? debian/patches/
$ git add .
$ git status -sb
## patch-queue/master
A  debian/patches/ngx_http_v2_upstream-01-of-14.diff
A  debian/patches/ngx_http_v2_upstream-02-of-14.diff
A  debian/patches/ngx_http_v2_upstream-03-of-14.diff
A  debian/patches/ngx_http_v2_upstream-04-of-14.diff
A  debian/patches/ngx_http_v2_upstream-05-of-14.diff
A  debian/patches/ngx_http_v2_upstream-06-of-14.diff
A  debian/patches/ngx_http_v2_upstream-07-of-14.diff
A  debian/patches/ngx_http_v2_upstream-08-of-14.diff
A  debian/patches/ngx_http_v2_upstream-09-of-14.diff
A  debian/patches/ngx_http_v2_upstream-10-of-14.diff
A  debian/patches/ngx_http_v2_upstream-11-of-14.diff
A  debian/patches/ngx_http_v2_upstream-12-of-14.diff
A  debian/patches/ngx_http_v2_upstream-13-of-14.diff
A  debian/patches/ngx_http_v2_upstream-14-of-14.diff
A  debian/patches/series
$ git commit -m 'Add ngx_http_v2_upstream patches'
</code></pre><h2 id="パッチの適用">パッチの適用</h2>
<p>次は <code>gbp pq import</code> コマンドを実行します。8番目のパッチが当たらずエラーになりました。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq import
gbp:info: Trying to apply patches at 'a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60'
gbp:error: Failed to apply 'debian/patches/ngx_http_v2_upstream-08-of-14.diff': Error running git apply: error: patch failed: src/http/ngx_http_upstream.c:1709
error: src/http/ngx_http_upstream.c: patch does not apply

gbp:error: Couldn't apply patches
</code></pre><p><code>-v</code> を付けて再度試してみました。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq import -v
gbp:debug: ['git', 'rev-parse', '--show-cdup']
gbp:debug: ['git', 'rev-parse', '--is-bare-repository']
gbp:debug: ['git', 'symbolic-ref', 'HEAD']
gbp:debug: ['git', 'show-ref', 'refs/heads/master']
gbp:debug: ['git', 'show-ref', 'refs/heads/patch-queue/master']
gbp:debug: ['git', 'log', '--pretty=format:%H', '-1', '--first-parent', '--']
gbp:info: Trying to apply patches at 'a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60'
gbp:debug: ['git', 'branch', 'patch-queue/master', 'a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60']
gbp:debug: ['git', 'symbolic-ref', 'HEAD']
gbp:debug: ['git', 'show-ref', 'refs/heads/master']
gbp:debug: ['git', 'checkout', 'patch-queue/master']
gbp:debug: Applying debian/patches/ngx_http_v2_upstream-01-of-14.diff
…(略)…
gbp:debug: ['git', 'apply', '--index', 'debian/patches/ngx_http_v2_upstream-07-of-14.diff']
gbp:debug: ['git', 'write-tree']
gbp:debug: ['git', 'rev-parse', '--quiet', '--verify', 'HEAD']
gbp:debug: ['git', 'commit-tree', '04ca7796412675740f5b1b89f0ca19ad8dd19756', '-p', '43b9919966a4321ec76d9ccdd9921bac449abf8c']
gbp:debug: ['git', 'update-ref', '-m', 'gbp-pq import debian/patches/ngx_http_v2_upstream-07-of-14.diff', 'HEAD', 'd8e3319aac2d07f18f719df074cf21de90482a16']
gbp:debug: Applying debian/patches/ngx_http_v2_upstream-08-of-14.diff
gbp:debug: ['git', 'apply', '--index', 'debian/patches/ngx_http_v2_upstream-08-of-14.diff']
gbp:error: Failed to apply 'debian/patches/ngx_http_v2_upstream-08-of-14.diff': Error running git apply: error: patch failed: src/http/ngx_http_upstream.c:1709
error: src/http/ngx_http_upstream.c: patch does not apply

gbp:debug: ['git', 'rev-parse', '--quiet', '--verify', 'HEAD']
gbp:debug: ['git', 'reset', '--quiet', '--hard', 'd8e3319aac2d07f18f719df074cf21de90482a16', '--']
gbp:debug: ['git', 'symbolic-ref', 'HEAD']
gbp:debug: ['git', 'show-ref', 'refs/heads/patch-queue/master']
gbp:debug: ['git', 'checkout', 'master']
gbp:debug: ['git', 'symbolic-ref', 'HEAD']
gbp:debug: ['git', 'show-ref', 'refs/heads/master']
gbp:debug: ['git', 'branch', '-D', 'patch-queue/master']
gbp:error: Couldn't apply patches
</code></pre><p><code>man gbp-pq</code> すると <code>apply</code> サブコマンドで1つずつパッチを当てられるようなので、そちらを試してみました。
<code>apply</code> の後に何も指定せずに実行するとパッチ名が無いというエラーになりました。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq apply
gbp:error: No patch name given.
</code></pre><p>ファイル名を指定して実行してみるとうまく動きました。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq apply debian/patches/ngx_http_v2_upstream-01-of-14.diff
gbp:info: Switching to 'patch-queue/master'
gbp:info: Applied ngx_http_v2_upstream-01-of-14.diff
</code></pre><p>gitレポジトリの状態を確認すると <code>patch-queue/master</code> ブランチが作られてそこに切り替わっていました。</p>
<pre><code class="language-console" data-lang="console">$ git status -sb
  master
* patch-queue/master
  pristine-tar
  upstream
</code></pre><p>gitのログを確認すると1番目のパッチを取り込んだコミットが作られています。</p>
<pre><code class="language-console" data-lang="console">$ git log
commit bdd197591d9f85f9a2f9c95ce9e38d4557947bce
Author: Piotr Sikora &lt;piotrsikora@google.com&gt;
Date:   Sun Apr 9 12:26:21 2017

	Output chain: propagate last_buf flag to c-&gt;send_chain().

	Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;

commit 2f8475f406a170123a9598b6a0a3a217c66421f3
Author: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
Date:   Fri Jul 14 14:50:43 2017

	Add ngx_http_v2_upstream patches

commit a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60
Author: Konstantin Pavlov &lt;thresh@nginx.com&gt;
Date:   Tue Jul 11 22:06:07 2017

	Imported Debian patch 1.13.3-1~xenial

commit 8483de20a8ef51e65ca23e855c8354ad4193cbe5
Author: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
Date:   Fri Jul 14 00:25:32 2017

	Imported Upstream version 1.13.3
</code></pre><p><code>git diff HEAD^</code> を実行すると1番目のパッチと同じ差分になっていました。</p>
<p>同様にして7番目のパッチまで適用します。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq apply debian/patches/ngx_http_v2_upstream-02-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-02-of-14.diff
$ gbp pq apply debian/patches/ngx_http_v2_upstream-03-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-03-of-14.diff
$ gbp pq apply debian/patches/ngx_http_v2_upstream-04-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-04-of-14.diff
$ gbp pq apply debian/patches/ngx_http_v2_upstream-05-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-05-of-14.diff
$ gbp pq apply debian/patches/ngx_http_v2_upstream-06-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-06-of-14.diff
$ gbp pq apply debian/patches/ngx_http_v2_upstream-07-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-07-of-14.diff
</code></pre><p>8番目のパッチはうまく当たらずエラーになるのは同じです。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq apply debian/patches/ngx_http_v2_upstream-08-of-14.diff
gbp:error: Error running git apply: error: patch failed: src/http/ngx_http_upstream.c:1709
error: src/http/ngx_http_upstream.c: patch does not apply
</code></pre><p><code>git-buildpackage</code> の Working with patches のページにはパッチが当たらない場合の手順は書いてないので、試行錯誤してみることにしました。</p>
<p>まず <code>git am</code> コマンドでパッチを当てて見ると以下のようになりました。</p>
<pre><code class="language-console" data-lang="console">$ git am debian/patches/ngx_http_v2_upstream-08-of-14.diff
Applying: HTTP/2: add HTTP/2 to upstreams.
error: patch failed: src/http/ngx_http_upstream.c:1709
error: src/http/ngx_http_upstream.c: patch does not apply
Patch failed at 0001 HTTP/2: add HTTP/2 to upstreams.
The copy of the patch that failed is found in: .git/rebase-apply/patch
When you have resolved this problem, run &quot;git am --continue&quot;.
If you prefer to skip this patch, run &quot;git am --skip&quot; instead.
To restore the original branch and stop patching, run &quot;git am --abort&quot;.
</code></pre><p><code>man git-am</code> を見ると <code>--reject</code> オプションがあったので、一旦 <code>git am --abort</code> で中断してからこれを試しました。</p>
<pre><code class="language-console" data-lang="console">$ git am --abort
$ git am --reject debian/patches/ngx_http_v2_upstream-08-of-14.diff
Applying: HTTP/2: add HTTP/2 to upstreams.
Checking patch auto/modules...
Checking patch src/core/ngx_connection.h...
Checking patch src/http/ngx_http_upstream.c...
Hunk #2 succeeded at 190 (offset 2 lines).
Hunk #3 succeeded at 1523 (offset 7 lines).
Hunk #4 succeeded at 1558 (offset 7 lines).
Hunk #5 succeeded at 1626 (offset 7 lines).
Hunk #6 succeeded at 1649 (offset 7 lines).
error: while searching for:
		c-&gt;write-&gt;handler = ngx_http_upstream_handler;
		c-&gt;read-&gt;handler = ngx_http_upstream_handler;

		c = r-&gt;connection;

		ngx_http_upstream_send_request(r, u, 1);

error: patch failed: src/http/ngx_http_upstream.c:1709
Hunk #8 succeeded at 1878 (offset 5 lines).
Hunk #9 succeeded at 2017 (offset 5 lines).
Hunk #10 succeeded at 2219 (offset 5 lines).
Hunk #11 succeeded at 2282 (offset 5 lines).
Hunk #12 succeeded at 2400 (offset 5 lines).
Hunk #13 succeeded at 2436 (offset 5 lines).
Hunk #14 succeeded at 2684 (offset 5 lines).
Hunk #15 succeeded at 4192 (offset 5 lines).
Hunk #16 succeeded at 4373 (offset 5 lines).
Checking patch src/http/ngx_http_upstream.h...
Checking patch src/http/v2/ngx_http_v2.c...
Checking patch src/http/v2/ngx_http_v2.h...
Checking patch src/http/v2/ngx_http_v2_filter_module.c...
Checking patch src/http/v2/ngx_http_v2_module.c...
Checking patch src/http/v2/ngx_http_v2_upstream.c...
Applied patch auto/modules cleanly.
Applied patch src/core/ngx_connection.h cleanly.
Applying patch src/http/ngx_http_upstream.c with 1 reject...
Hunk #1 applied cleanly.
Hunk #2 applied cleanly.
Hunk #3 applied cleanly.
Hunk #4 applied cleanly.
Hunk #5 applied cleanly.
Hunk #6 applied cleanly.
Rejected hunk #7.
Hunk #8 applied cleanly.
Hunk #9 applied cleanly.
Hunk #10 applied cleanly.
Hunk #11 applied cleanly.
Hunk #12 applied cleanly.
Hunk #13 applied cleanly.
Hunk #14 applied cleanly.
Hunk #15 applied cleanly.
Hunk #16 applied cleanly.
Applied patch src/http/ngx_http_upstream.h cleanly.
Applied patch src/http/v2/ngx_http_v2.c cleanly.
Applied patch src/http/v2/ngx_http_v2.h cleanly.
Applied patch src/http/v2/ngx_http_v2_filter_module.c cleanly.
Applied patch src/http/v2/ngx_http_v2_module.c cleanly.
Applied patch src/http/v2/ngx_http_v2_upstream.c cleanly.
Patch failed at 0001 HTTP/2: add HTTP/2 to upstreams.
The copy of the patch that failed is found in: .git/rebase-apply/patch
When you have resolved this problem, run &quot;git am --continue&quot;.
If you prefer to skip this patch, run &quot;git am --skip&quot; instead.
To restore the original branch and stop patching, run &quot;git am --abort&quot;.
</code></pre><p>gitのレポジトリの状態は以下のようになっていました。</p>
<pre><code class="language-console" data-lang="console">$ git status -sb
## patch-queue/master
 M auto/modules
 M src/core/ngx_connection.h
 M src/http/ngx_http_upstream.c
 M src/http/ngx_http_upstream.h
 M src/http/v2/ngx_http_v2.c
 M src/http/v2/ngx_http_v2.h
 M src/http/v2/ngx_http_v2_filter_module.c
 M src/http/v2/ngx_http_v2_module.c
?? src/http/ngx_http_upstream.c.rej
?? src/http/v2/ngx_http_v2_upstream.c
</code></pre><p><code>src/http/ngx_http_upstream.c.rej</code> を見ながら <code>src/http/ngx_http_upstream.c</code> を編集します。</p>
<p>その後 <code>src/http/ngx_http_upstream.c.rej</code> は消して <code>git add</code> で変更のあったファイルを追加して
<code>git am --continue</code> を実行するとパッチが適用できました。</p>
<pre><code class="language-console" data-lang="console">$ rm src/http/ngx_http_upstream.c.rej
$ git add .
$ g am --continue

Applying: HTTP/2: add HTTP/2 to upstreams.
</code></pre><p>ログで最新2つのコミットを見てみると、前のコミットと同様に <code>Author</code> や <code>Date</code> の内容も正しく設定されているようです。</p>
<pre><code class="language-console" data-lang="console">$ git log -2
commit b2ea482abd9c1cfbd9966316370759bc01095df3
Author: Piotr Sikora &lt;piotrsikora@google.com&gt;
Date:   Wed Mar 29 14:59:40 2017

	HTTP/2: add HTTP/2 to upstreams.

	Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;

commit 052e2e79cb13eff69bffcfa2cd4bc2bcfdb54fc1
Author: Piotr Sikora &lt;piotrsikora@google.com&gt;
Date:   Fri Mar 10 12:00:45 2017

	HTTP/2: introduce ngx_http_v2_handle_event().

	No functional changes.

	Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;
</code></pre><p>9番目と10番目のパッチは <code>gbp pq apply</code> で適用します。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq apply debian/patches/ngx_http_v2_upstream-09-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-09-of-14.diff
$ gbp pq apply debian/patches/ngx_http_v2_upstream-10-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-10-of-14.diff
</code></pre><p>11番目のパッチは再びエラーになります。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq apply debian/patches/ngx_http_v2_upstream-11-of-14.diff
gbp:error: Error running git apply: error: patch failed: src/http/modules/ngx_http_proxy_module.c:1151
error: src/http/modules/ngx_http_proxy_module.c: patch does not apply
</code></pre><p><code>git am --reject</code> で適用を試みます。</p>
<pre><code class="language-console" data-lang="console">$ git am --reject debian/patches/ngx_http_v2_upstream-11-of-14.diff
</code></pre><p>gitレポジトリの状態を確認します。</p>
<pre><code class="language-console" data-lang="console">$ git status -sb
## patch-queue/master
?? src/http/modules/ngx_http_proxy_module.c.rej
</code></pre><p>前回の記事に書いたように、このパッチと等価な変更が既に適用されているので、このパッチはスキップします。</p>
<pre><code class="language-console" data-lang="console">$ rm src/http/modules/ngx_http_proxy_module.c.rej
$ git am --skip
</code></pre><p>12番目から14番目のパッチは <code>gbp pq apply</code> で適用します。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq apply debian/patches/ngx_http_v2_upstream-12-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-12-of-14.diff
$ gbp pq apply debian/patches/ngx_http_v2_upstream-13-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-13-of-14.diff
$ gbp pq apply debian/patches/ngx_http_v2_upstream-14-of-14.diff
gbp:info: Applied ngx_http_v2_upstream-14-of-14.diff
</code></pre><h2 id="パッチの再生成">パッチの再生成</h2>
<p>上記で作成したコミットの内容からパッチを再生成して <code>debian/patches/</code> ディレクトリのファイルを上書き更新してコミットします
。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq export --commit
gbp:info: On 'patch-queue/master', switching to 'master'
gbp:info: Generating patches from git (master..patch-queue/master)
gbp:info: Added patches 0003-HTTP-2-add-debug-logging-of-control-frames.patch, 0011-Proxy-add-HTTP-2-support.patch, 0007-HTTP-2-introduce-ngx_http_v2_handle_event.patch, 0013-Cache-add-HTTP-2-support.patch, 0010-Proxy-always-emit-Host-header-first.patch, 0008-HTTP-2-add-HTTP-2-to-upstreams.patch, 0001-Output-chain-propagate-last_buf-flag-to-c-send_chain.patch, 0004-HTTP-2-s-client-peer.patch, 0009-Proxy-add-proxy_ssl_alpn-directive.patch, 0006-HTTP-2-introduce-stream-fake_connection.patch, 0005-HTTP-2-introduce-h2c-conf_ctx.patch, 0002-Upstream-keepalive-preserve-c-data.patch, 0012-Proxy-add-proxy_pass_trailers-directive.patch to patch series
gbp:info: Removed patches ngx_http_v2_upstream-08-of-14.diff, ngx_http_v2_upstream-13-of-14.diff, ngx_http_v2_upstream-09-of-14.diff, ngx_http_v2_upstream-06-of-14.diff, ngx_http_v2_upstream-03-of-14.diff, ngx_http_v2_upstream-04-of-14.diff, ngx_http_v2_upstream-10-of-14.diff, ngx_http_v2_upstream-12-of-14.diff, ngx_http_v2_upstream-07-of-14.diff, ngx_http_v2_upstream-01-of-14.diff, ngx_http_v2_upstream-05-of-14.diff, ngx_http_v2_upstream-02-of-14.diff, ngx_http_v2_upstream-14-of-14.diff, ngx_http_v2_upstream-11-of-14.diff from patch series
</code></pre><p>gitレポジトリの状態を確認すると、 <code>master</code> ブランチに切り替わっていました。</p>
<pre><code class="language-console" data-lang="console">$ git status -sb
## master
</code></pre><p>gitのログを確認すると <code>patch-queue/master</code> ブランチはそのままでした。</p>
<pre><code class="language-console" data-lang="console">$ git log -1 patch-queue/master
commit 9e63d82fcbc542cd7fb19bb1facad31998b7d7f8
Author: Piotr Sikora &lt;piotrsikora@google.com&gt;
Date:   Wed Apr 12 08:51:41 2017

	Cache: add HTTP/2 support.

Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;
</code></pre><p><code>master</code> ブランチには <code>gbp pq export --commit</code> によってコミットが作られていました。</p>
<pre><code class="language-console" data-lang="console">$ git log -1 master
commit 359f8e450d47336bc5c798961472c022efd39f1a
Author: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
Date:   Fri Jul 14 15:32:49 2017

	Rediff patches

	Added 0003-HTTP-2-add-debug-logging-of-control-frames.patch: &lt;REASON&gt;
	Added 0011-Proxy-add-HTTP-2-support.patch: &lt;REASON&gt;
	Added 0007-HTTP-2-introduce-ngx_http_v2_handle_event.patch: &lt;REASON&gt;
	Added 0013-Cache-add-HTTP-2-support.patch: &lt;REASON&gt;
	Added 0010-Proxy-always-emit-Host-header-first.patch: &lt;REASON&gt;
	Added 0008-HTTP-2-add-HTTP-2-to-upstreams.patch: &lt;REASON&gt;
	Added 0001-Output-chain-propagate-last_buf-flag-to-c-send_chain.patch: &lt;REASON&gt;
	Added 0004-HTTP-2-s-client-peer.patch: &lt;REASON&gt;
	Added 0009-Proxy-add-proxy_ssl_alpn-directive.patch: &lt;REASON&gt;
	Added 0006-HTTP-2-introduce-stream-fake_connection.patch: &lt;REASON&gt;
	Added 0005-HTTP-2-introduce-h2c-conf_ctx.patch: &lt;REASON&gt;
	Added 0002-Upstream-keepalive-preserve-c-data.patch: &lt;REASON&gt;
	Added 0012-Proxy-add-proxy_pass_trailers-directive.patch: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-08-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-13-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-09-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-06-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-03-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-04-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-10-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-12-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-07-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-01-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-05-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-02-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-14-of-14.diff: &lt;REASON&gt;
	Dropped ngx_http_v2_upstream-11-of-14.diff: &lt;REASON&gt;
</code></pre><p><code>debian/patches/</code> ディレクトリを確認すると、 <code>&lt;4桁の連番&gt;-&lt;Subject&gt;patch</code> という形式のファイル名で
パッチファイルが作られていました。</p>
<p>8番目のパッチの中身は上記でパッチが当たらなくて修正した部分が反映されたものになっていました。
また11番目のパッチは削除されてそれ以降のパッチが番号を詰められて作られていました。</p>
<pre><code class="language-console" data-lang="console">$ ls -1 debian/patches/
0001-Output-chain-propagate-last_buf-flag-to-c-send_chain.patch
0002-Upstream-keepalive-preserve-c-data.patch
0003-HTTP-2-add-debug-logging-of-control-frames.patch
0004-HTTP-2-s-client-peer.patch
0005-HTTP-2-introduce-h2c-conf_ctx.patch
0006-HTTP-2-introduce-stream-fake_connection.patch
0007-HTTP-2-introduce-ngx_http_v2_handle_event.patch
0008-HTTP-2-add-HTTP-2-to-upstreams.patch
0009-Proxy-add-proxy_ssl_alpn-directive.patch
0010-Proxy-always-emit-Host-header-first.patch
0011-Proxy-add-HTTP-2-support.patch
0012-Proxy-add-proxy_pass_trailers-directive.patch
0013-Cache-add-HTTP-2-support.patch
series
</code></pre><h2 id="debianchangelog編集">debian/changelog編集</h2>
<p>後は前回と同様です。</p>
<p>まず、 <code>debian/changelog</code> を編集します。</p>
<pre><code class="language-console" data-lang="console">$ gbp dch -R
</code></pre><p>エディタで表示される内容の先頭のほうは以下のようになっていました。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">nginx (1.13.3-1~xenialubuntu1) xenial; urgency=medium

  * Add ngx_http_v2_upstream patches
  * Rediff patches

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Fri, 14 Jul 2017 16:07:32 +0900

nginx (1.13.3-1~xenial) xenial; urgency=low
</code></pre></div><p>これを以下のように編集しました。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">nginx (1.13.3-1~xenial1ppa1) xenial; urgency=medium

  * Add ngx_http_v2_upstream patches

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Fri, 14 Jul 2017 16:07:32 +0900

nginx (1.13.3-1~xenial) xenial; urgency=low
</code></pre></div><p>gitレポジトリの状態を確認し、 <code>debian/changelog</code> をコミットします。</p>
<pre><code class="language-console" data-lang="console">$ git status -sb
## master
 M debian/changelog
</code></pre><pre><code class="language-console" data-lang="console">$ git commit -m 'Release 1.13.3-1~xenial1ppa1' debian/changelog
</code></pre><h2 id="ソースパッケージのビルド">ソースパッケージのビルド</h2>
<p>ソースパッケージのビルドですが、今回はupstreamのソースに対してdfsg対応の修正は加えておらずそのままなので <code>--git-pristine-tar-commit</code> オプションは指定せず以下のコマンドを実行します。</p>
<pre><code class="language-console" data-lang="console">$ gbp buildpackage --git-export-dir=../build-area -S -sa
</code></pre><p>gpgのパスフレーズを2回聞かれるので入力します。</p>
<h2 id="バイナリパッケージのビルド">バイナリパッケージのビルド</h2>
<p>以下のコマンドでバイナリパッケージをビルドします。</p>
<pre><code class="language-console" data-lang="console">$ sudo pbuilder build ../build-area/nginx_1.13.3-1~xenial1ppa1.dsc
</code></pre><h2 id="gitのタグ作成">gitのタグ作成</h2>
<p>前回と同じタグなので <code>-f</code> を指定して付け替えます。</p>
<pre><code class="language-console" data-lang="console">$ git tag -f debian/1.13.3-1_xenial1ppa1
Updated tag 'debian/1.13.3-1_xenial1ppa1' (was d718489)
</code></pre><h2 id="upstreamのソースをバージョンアップしたときのパッチ更新">upstreamのソースをバージョンアップしたときのパッチ更新</h2>
<p>今回は試していませんが、 <code>git-buildpackage</code> の Working with patches のページによると
今後upstreamのソースの新しいバージョンを取り込んだときには以下のコマンドでパッチを更新できるようです。</p>
<pre><code class="language-console" data-lang="console">$ gbp pq rebase
$ gbp pq export
</code></pre><h2 id="おわりに">おわりに</h2>
<p>以前は <code>git-quiltimport (1)</code> でパース可能なパッチファイルを作る手順がわかってなかったので
挫折しましたが、そこがわかってしまえば <code>quilt</code> コマンドは不慣れで <code>git</code> は慣れている私には
こちらのほうが作業しやすそうに感じました。</p>
<p>パッチの適用順序を入れ替えるのも <code>git rebase</code> でコミットの順序を入れ替えれば良さそうです。
ということで今後はこちらの方式を主に使うようにしてみます。</p>

</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
