<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>git-buildpackageのpatch-queue機能を試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/07/14/tried-git-buildpackage-patch-queue/" rel="bookmark"
           title="Permalink to git-buildpackageのpatch-queue機能を試してみた">git-buildpackageのpatch-queue機能を試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-07-14T11:20:00+09:00">
                Published: 2017-07-14
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/deb.html">deb</a> <a href="../../../../tag/nginx.html">nginx</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="/blog/2017/07/14/build-nginx-deb-with-ngx_http_v2_upstream/">ngx_http_v2_upstreamモジュールを追加したnginxのdebパッケージを作ってみた</a> で <code>quilt</code> を使ったパッチ適用を経験してみて、不慣れなこともありちょっと面倒な気がしました。</p>
<p>そこで、 <code>git-buildpackage</code> の <a class="reference external" href="http://honk.sigxcpu.org/projects/git-buildpackage/manual-html/gbp.patches.html">Working with patches</a> を試してみることにしました。</p>
<p>前回作業したgitのレポジトリで以下のコミットに戻してから、以下の手順を試しました。</p>
<div class="highlight"><pre><span></span>commit a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60
Author: Konstantin Pavlov &lt;thresh@nginx.com&gt;
Date:   Tue Jul 11 22:06:07 2017

        Imported Debian patch 1.13.3-1~xenial
</pre></div>
</div>
<div class="section" id="id2">
<h2>パッチの準備</h2>
<p>上記のページを見ると <code>debian/patches/</code> ディレクトリに <code>git-quiltimport (1)</code> でパース可能なパッチファイルをおいておく必要があるとのことです。</p>
<div class="section" id="hggit">
<h3>hg形式のパッチをgit形式のパッチに変換するスクリプト</h3>
<p>今回は元のパッチが <code>hg (mercurial)</code> の形式なので、これを変換できないかと検索してみると</p>
<p><a class="reference external" href="https://github.com/mozilla/moz-git-tools/blob/master/hg-patch-to-git-patch">moz-git-tools/hg-patch-to-git-patch at master · mozilla/moz-git-tools</a></p>
<p>というPythonスクリプトが見つかったので、ありがたくこれを使わせていただくことにしました。</p>
<p>私が試したバージョンは以下の通りです。</p>
<p><a class="reference external" href="https://github.com/mozilla/moz-git-tools/blob/d9009081a467ace43c0a8f535089a7c66a22c587/hg-patch-to-git-patch">moz-git-tools/hg-patch-to-git-patch at d9009081a467ace43c0a8f535089a7c66a22c587 · mozilla/moz-git-tools</a></p>
<p>これを <code>/usr/local/bin/hg-patch-to-git-patch</code> というファイル名で保存し、実行パーミションをつけておきます。</p>
</div>
<div class="section" id="hg">
<h3>hg形式のパッチを保存</h3>
<p><code>~/nginx.org-deb/ngx_http_v2_upstream-hg-patches</code> というディレクトリにhg形式のパッチを保存することにしました。
スパムメール防止用に変換されているメールアドレス内の <code>at</code> と前後のスペースを <code>&#64;</code> に戻してパッチを保存します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ls
<span class="go">ngx_http_v2_upstream-01-of-14.diff  ngx_http_v2_upstream-06-of-14.diff  ngx_http_v2_upstream-11-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-02-of-14.diff  ngx_http_v2_upstream-07-of-14.diff  ngx_http_v2_upstream-12-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-03-of-14.diff  ngx_http_v2_upstream-08-of-14.diff  ngx_http_v2_upstream-13-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-04-of-14.diff  ngx_http_v2_upstream-09-of-14.diff  ngx_http_v2_upstream-14-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-05-of-14.diff  ngx_http_v2_upstream-10-of-14.diff</span>
</pre></div>
</div>
<div class="section" id="git">
<h3>git形式のパッチに変換</h3>
<p>git形式のパッチを保存するディレクトリ <code>~/nginx.org-deb/ngx_http_v2_upstream-git-patches</code> を作成し、上記のスクリプトで変換します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> mkdir ../ngx_http_v2_upstream-git-patches
<span class="gp">$</span> <span class="k">for</span> i in *<span class="p">;</span> <span class="k">do</span> hg-patch-to-git-patch <span class="nv">$i</span> &gt; ../ngx_http_v2_upstream-git-patches/<span class="nv">$i</span> <span class="p">;</span> <span class="k">done</span>
</pre></div>
<p>変換後のgit形式のパッチの先頭は以下のようになっていました（メールアドレス内の <code>&#64;</code> はスパムメール防止用に :code:&#64;`at` ＋前後の空白に置換しています）。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> head ../ngx_http_v2_upstream-git-patches/ngx_http_v2_upstream-01-of-14.diff
<span class="go">From: Piotr Sikora &lt;piotrsikora at google.com&gt;</span>
<span class="go">Date: 1491708381 -0700</span>
<span class="go">Subject: Output chain: propagate last_buf flag to c-&gt;send_chain().</span>

<span class="go">Signed-off-by: Piotr Sikora &lt;piotrsikora at google.com&gt;</span>

<span class="go">diff -r a39bc74873fa -r 5f5d70428655 src/core/ngx_output_chain.c</span>
<span class="go">--- a/src/core/ngx_output_chain.c</span>
<span class="go">+++ b/src/core/ngx_output_chain.c</span>
<span class="go">@@ -658,6 +658,7 @@ ngx_chain_writer(void *data, ngx_chain_t</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> head -13 ../ngx_http_v2_upstream-git-patches/ngx_http_v2_upstream-09-of-14.diff
<span class="go">From: Piotr Sikora &lt;piotrsikora at google.com&gt;</span>
<span class="go">Date: 1489621682 -0700</span>
<span class="go">Subject: Proxy: add &quot;proxy_ssl_alpn&quot; directive.</span>

<span class="go">ALPN is used here only to indicate which version of the HTTP protocol</span>
<span class="go">is going to be used and we doesn&#39;t verify that upstream agreed to it.</span>

<span class="go">Please note that upstream is allowed to reject SSL connection with a</span>
<span class="go">fatal &quot;no_application_protocol&quot; alert if it doesn&#39;t support it.</span>

<span class="go">Signed-off-by: Piotr Sikora &lt;piotrsikora at google.com&gt;</span>

<span class="go">diff -r 154ca6c5e62a -r 96075d4cd2a6 src/event/ngx_event_openssl.c</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>パッチのインポート</h2>
<p>パッチをインポートは前回同様 <code>dquilt import</code> で行います。
パッチはスタックとして管理されるので14番のパッチから1番のパッチへと逆順にインポートしています。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> ~/.ghq/github.com/hnakamur/nginx-deb
<span class="gp">$</span> <span class="k">for</span> i in <span class="o">{</span><span class="m">14</span>..01<span class="o">}</span><span class="p">;</span> <span class="k">do</span> dquilt import ~/nginx.org-deb/ngx_http_v2_upstream-git-patches/ngx_http_v2_upstream-<span class="nv">$i</span>-of-14.diff<span class="p">;</span> <span class="k">done</span>
</pre></div>
<p>インポートしたパッチをgitに追加してコミットしておきます。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git status -sb
<span class="gp">#</span><span class="c1"># patch-queue/master</span>
<span class="go">?? debian/patches/</span>
<span class="gp">$</span> git add .
<span class="gp">$</span> git status -sb
<span class="gp">#</span><span class="c1"># patch-queue/master</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-01-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-02-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-03-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-04-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-05-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-06-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-07-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-08-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-09-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-10-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-11-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-12-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-13-of-14.diff</span>
<span class="go">A  debian/patches/ngx_http_v2_upstream-14-of-14.diff</span>
<span class="go">A  debian/patches/series</span>
<span class="gp">$</span> git commit -m <span class="s1">&#39;Add ngx_http_v2_upstream patches&#39;</span>
</pre></div>
</div>
<div class="section" id="id4">
<h2>パッチの適用</h2>
<p>次は <code>gbp pq import</code> コマンドを実行します。8番目のパッチが当たらずエラーになりました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq import
<span class="go">gbp:info: Trying to apply patches at &#39;a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60&#39;</span>
<span class="go">gbp:error: Failed to apply &#39;debian/patches/ngx_http_v2_upstream-08-of-14.diff&#39;: Error running git apply: error: patch failed: src/http/ngx_http_upstream.c:1709</span>
<span class="go">error: src/http/ngx_http_upstream.c: patch does not apply</span>

<span class="go">gbp:error: Couldn&#39;t apply patches</span>
</pre></div>
<p><code>-v</code> を付けて再度試してみました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq import -v
<span class="go">gbp:debug: [&#39;git&#39;, &#39;rev-parse&#39;, &#39;--show-cdup&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;rev-parse&#39;, &#39;--is-bare-repository&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;symbolic-ref&#39;, &#39;HEAD&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;show-ref&#39;, &#39;refs/heads/master&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;show-ref&#39;, &#39;refs/heads/patch-queue/master&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;log&#39;, &#39;--pretty=format:%H&#39;, &#39;-1&#39;, &#39;--first-parent&#39;, &#39;--&#39;]</span>
<span class="go">gbp:info: Trying to apply patches at &#39;a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60&#39;</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;branch&#39;, &#39;patch-queue/master&#39;, &#39;a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;symbolic-ref&#39;, &#39;HEAD&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;show-ref&#39;, &#39;refs/heads/master&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;checkout&#39;, &#39;patch-queue/master&#39;]</span>
<span class="go">gbp:debug: Applying debian/patches/ngx_http_v2_upstream-01-of-14.diff</span>
<span class="go">…(略)…</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;apply&#39;, &#39;--index&#39;, &#39;debian/patches/ngx_http_v2_upstream-07-of-14.diff&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;write-tree&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;rev-parse&#39;, &#39;--quiet&#39;, &#39;--verify&#39;, &#39;HEAD&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;commit-tree&#39;, &#39;04ca7796412675740f5b1b89f0ca19ad8dd19756&#39;, &#39;-p&#39;, &#39;43b9919966a4321ec76d9ccdd9921bac449abf8c&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;update-ref&#39;, &#39;-m&#39;, &#39;gbp-pq import debian/patches/ngx_http_v2_upstream-07-of-14.diff&#39;, &#39;HEAD&#39;, &#39;d8e3319aac2d07f18f719df074cf21de90482a16&#39;]</span>
<span class="go">gbp:debug: Applying debian/patches/ngx_http_v2_upstream-08-of-14.diff</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;apply&#39;, &#39;--index&#39;, &#39;debian/patches/ngx_http_v2_upstream-08-of-14.diff&#39;]</span>
<span class="go">gbp:error: Failed to apply &#39;debian/patches/ngx_http_v2_upstream-08-of-14.diff&#39;: Error running git apply: error: patch failed: src/http/ngx_http_upstream.c:1709</span>
<span class="go">error: src/http/ngx_http_upstream.c: patch does not apply</span>

<span class="go">gbp:debug: [&#39;git&#39;, &#39;rev-parse&#39;, &#39;--quiet&#39;, &#39;--verify&#39;, &#39;HEAD&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;reset&#39;, &#39;--quiet&#39;, &#39;--hard&#39;, &#39;d8e3319aac2d07f18f719df074cf21de90482a16&#39;, &#39;--&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;symbolic-ref&#39;, &#39;HEAD&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;show-ref&#39;, &#39;refs/heads/patch-queue/master&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;checkout&#39;, &#39;master&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;symbolic-ref&#39;, &#39;HEAD&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;show-ref&#39;, &#39;refs/heads/master&#39;]</span>
<span class="go">gbp:debug: [&#39;git&#39;, &#39;branch&#39;, &#39;-D&#39;, &#39;patch-queue/master&#39;]</span>
<span class="go">gbp:error: Couldn&#39;t apply patches</span>
</pre></div>
<p><code>man gbp-pq</code> すると <code>apply</code> サブコマンドで1つずつパッチを当てられるようなので、そちらを試してみました。
<code>apply</code> の後に何も指定せずに実行するとパッチ名が無いというエラーになりました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq apply
<span class="go">gbp:error: No patch name given.</span>
</pre></div>
<p>ファイル名を指定して実行してみるとうまく動きました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-01-of-14.diff
<span class="go">gbp:info: Switching to &#39;patch-queue/master&#39;</span>
<span class="go">gbp:info: Applied ngx_http_v2_upstream-01-of-14.diff</span>
</pre></div>
<p>gitレポジトリの状態を確認すると <code>patch-queue/master</code> ブランチが作られてそこに切り替わっていました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git status -sb
<span class="go">  master</span>
<span class="go">* patch-queue/master</span>
<span class="go">  pristine-tar</span>
<span class="go">  upstream</span>
</pre></div>
<p>gitのログを確認すると1番目のパッチを取り込んだコミットが作られています。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git log
<span class="go">commit bdd197591d9f85f9a2f9c95ce9e38d4557947bce</span>
<span class="go">Author: Piotr Sikora &lt;piotrsikora@google.com&gt;</span>
<span class="go">Date:   Sun Apr 9 12:26:21 2017</span>

<span class="go">        Output chain: propagate last_buf flag to c-&gt;send_chain().</span>

<span class="go">        Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;</span>

<span class="go">commit 2f8475f406a170123a9598b6a0a3a217c66421f3</span>
<span class="go">Author: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;</span>
<span class="go">Date:   Fri Jul 14 14:50:43 2017</span>

<span class="go">        Add ngx_http_v2_upstream patches</span>

<span class="go">commit a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60</span>
<span class="go">Author: Konstantin Pavlov &lt;thresh@nginx.com&gt;</span>
<span class="go">Date:   Tue Jul 11 22:06:07 2017</span>

<span class="go">        Imported Debian patch 1.13.3-1~xenial</span>

<span class="go">commit 8483de20a8ef51e65ca23e855c8354ad4193cbe5</span>
<span class="go">Author: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;</span>
<span class="go">Date:   Fri Jul 14 00:25:32 2017</span>

<span class="go">        Imported Upstream version 1.13.3</span>
</pre></div>
<p><code>git diff HEAD^</code> を実行すると1番目のパッチと同じ差分になっていました。</p>
<p>同様にして7番目のパッチまで適用します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-02-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-02-of-14.diff</span>
<span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-03-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-03-of-14.diff</span>
<span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-04-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-04-of-14.diff</span>
<span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-05-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-05-of-14.diff</span>
<span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-06-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-06-of-14.diff</span>
<span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-07-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-07-of-14.diff</span>
</pre></div>
<p>8番目のパッチはうまく当たらずエラーになるのは同じです。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-08-of-14.diff
<span class="go">gbp:error: Error running git apply: error: patch failed: src/http/ngx_http_upstream.c:1709</span>
<span class="go">error: src/http/ngx_http_upstream.c: patch does not apply</span>
</pre></div>
<p><code>git-buildpackage</code> の Working with patches のページにはパッチが当たらない場合の手順は書いてないので、試行錯誤してみることにしました。</p>
<p>まず <code>git am</code> コマンドでパッチを当てて見ると以下のようになりました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git am debian/patches/ngx_http_v2_upstream-08-of-14.diff
<span class="go">Applying: HTTP/2: add HTTP/2 to upstreams.</span>
<span class="go">error: patch failed: src/http/ngx_http_upstream.c:1709</span>
<span class="go">error: src/http/ngx_http_upstream.c: patch does not apply</span>
<span class="go">Patch failed at 0001 HTTP/2: add HTTP/2 to upstreams.</span>
<span class="go">The copy of the patch that failed is found in: .git/rebase-apply/patch</span>
<span class="go">When you have resolved this problem, run &quot;git am --continue&quot;.</span>
<span class="go">If you prefer to skip this patch, run &quot;git am --skip&quot; instead.</span>
<span class="go">To restore the original branch and stop patching, run &quot;git am --abort&quot;.</span>
</pre></div>
<p><code>man git-am</code> を見ると <code>--reject</code> オプションがあったので、一旦 <code>git am --abort</code> で中断してからこれを試しました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git am --abort
<span class="gp">$</span> git am --reject debian/patches/ngx_http_v2_upstream-08-of-14.diff
<span class="go">Applying: HTTP/2: add HTTP/2 to upstreams.</span>
<span class="go">Checking patch auto/modules...</span>
<span class="go">Checking patch src/core/ngx_connection.h...</span>
<span class="go">Checking patch src/http/ngx_http_upstream.c...</span>
<span class="go">Hunk #2 succeeded at 190 (offset 2 lines).</span>
<span class="go">Hunk #3 succeeded at 1523 (offset 7 lines).</span>
<span class="go">Hunk #4 succeeded at 1558 (offset 7 lines).</span>
<span class="go">Hunk #5 succeeded at 1626 (offset 7 lines).</span>
<span class="go">Hunk #6 succeeded at 1649 (offset 7 lines).</span>
<span class="go">error: while searching for:</span>
<span class="go">                c-&gt;write-&gt;handler = ngx_http_upstream_handler;</span>
<span class="go">                c-&gt;read-&gt;handler = ngx_http_upstream_handler;</span>

<span class="go">                c = r-&gt;connection;</span>

<span class="go">                ngx_http_upstream_send_request(r, u, 1);</span>

<span class="go">error: patch failed: src/http/ngx_http_upstream.c:1709</span>
<span class="go">Hunk #8 succeeded at 1878 (offset 5 lines).</span>
<span class="go">Hunk #9 succeeded at 2017 (offset 5 lines).</span>
<span class="go">Hunk #10 succeeded at 2219 (offset 5 lines).</span>
<span class="go">Hunk #11 succeeded at 2282 (offset 5 lines).</span>
<span class="go">Hunk #12 succeeded at 2400 (offset 5 lines).</span>
<span class="go">Hunk #13 succeeded at 2436 (offset 5 lines).</span>
<span class="go">Hunk #14 succeeded at 2684 (offset 5 lines).</span>
<span class="go">Hunk #15 succeeded at 4192 (offset 5 lines).</span>
<span class="go">Hunk #16 succeeded at 4373 (offset 5 lines).</span>
<span class="go">Checking patch src/http/ngx_http_upstream.h...</span>
<span class="go">Checking patch src/http/v2/ngx_http_v2.c...</span>
<span class="go">Checking patch src/http/v2/ngx_http_v2.h...</span>
<span class="go">Checking patch src/http/v2/ngx_http_v2_filter_module.c...</span>
<span class="go">Checking patch src/http/v2/ngx_http_v2_module.c...</span>
<span class="go">Checking patch src/http/v2/ngx_http_v2_upstream.c...</span>
<span class="go">Applied patch auto/modules cleanly.</span>
<span class="go">Applied patch src/core/ngx_connection.h cleanly.</span>
<span class="go">Applying patch src/http/ngx_http_upstream.c with 1 reject...</span>
<span class="go">Hunk #1 applied cleanly.</span>
<span class="go">Hunk #2 applied cleanly.</span>
<span class="go">Hunk #3 applied cleanly.</span>
<span class="go">Hunk #4 applied cleanly.</span>
<span class="go">Hunk #5 applied cleanly.</span>
<span class="go">Hunk #6 applied cleanly.</span>
<span class="go">Rejected hunk #7.</span>
<span class="go">Hunk #8 applied cleanly.</span>
<span class="go">Hunk #9 applied cleanly.</span>
<span class="go">Hunk #10 applied cleanly.</span>
<span class="go">Hunk #11 applied cleanly.</span>
<span class="go">Hunk #12 applied cleanly.</span>
<span class="go">Hunk #13 applied cleanly.</span>
<span class="go">Hunk #14 applied cleanly.</span>
<span class="go">Hunk #15 applied cleanly.</span>
<span class="go">Hunk #16 applied cleanly.</span>
<span class="go">Applied patch src/http/ngx_http_upstream.h cleanly.</span>
<span class="go">Applied patch src/http/v2/ngx_http_v2.c cleanly.</span>
<span class="go">Applied patch src/http/v2/ngx_http_v2.h cleanly.</span>
<span class="go">Applied patch src/http/v2/ngx_http_v2_filter_module.c cleanly.</span>
<span class="go">Applied patch src/http/v2/ngx_http_v2_module.c cleanly.</span>
<span class="go">Applied patch src/http/v2/ngx_http_v2_upstream.c cleanly.</span>
<span class="go">Patch failed at 0001 HTTP/2: add HTTP/2 to upstreams.</span>
<span class="go">The copy of the patch that failed is found in: .git/rebase-apply/patch</span>
<span class="go">When you have resolved this problem, run &quot;git am --continue&quot;.</span>
<span class="go">If you prefer to skip this patch, run &quot;git am --skip&quot; instead.</span>
<span class="go">To restore the original branch and stop patching, run &quot;git am --abort&quot;.</span>
</pre></div>
<p>gitのレポジトリの状態は以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git status -sb
<span class="gp">#</span><span class="c1"># patch-queue/master</span>
<span class="go"> M auto/modules</span>
<span class="go"> M src/core/ngx_connection.h</span>
<span class="go"> M src/http/ngx_http_upstream.c</span>
<span class="go"> M src/http/ngx_http_upstream.h</span>
<span class="go"> M src/http/v2/ngx_http_v2.c</span>
<span class="go"> M src/http/v2/ngx_http_v2.h</span>
<span class="go"> M src/http/v2/ngx_http_v2_filter_module.c</span>
<span class="go"> M src/http/v2/ngx_http_v2_module.c</span>
<span class="go">?? src/http/ngx_http_upstream.c.rej</span>
<span class="go">?? src/http/v2/ngx_http_v2_upstream.c</span>
</pre></div>
<p><code>src/http/ngx_http_upstream.c.rej</code> を見ながら <code>src/http/ngx_http_upstream.c</code> を編集します。</p>
<p>その後 <code>src/http/ngx_http_upstream.c.rej</code> は消して <code>git add</code> で変更のあったファイルを追加して
<code>git am --continue</code> を実行するとパッチが適用できました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> rm src/http/ngx_http_upstream.c.rej
<span class="gp">$</span> git add .
<span class="gp">$</span> g am --continue

<span class="go">Applying: HTTP/2: add HTTP/2 to upstreams.</span>
</pre></div>
<p>ログで最新2つのコミットを見てみると、前のコミットと同様に <code>Author</code> や <code>Date</code> の内容も正しく設定されているようです。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git log -2
<span class="go">commit b2ea482abd9c1cfbd9966316370759bc01095df3</span>
<span class="go">Author: Piotr Sikora &lt;piotrsikora@google.com&gt;</span>
<span class="go">Date:   Wed Mar 29 14:59:40 2017</span>

<span class="go">        HTTP/2: add HTTP/2 to upstreams.</span>

<span class="go">        Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;</span>

<span class="go">commit 052e2e79cb13eff69bffcfa2cd4bc2bcfdb54fc1</span>
<span class="go">Author: Piotr Sikora &lt;piotrsikora@google.com&gt;</span>
<span class="go">Date:   Fri Mar 10 12:00:45 2017</span>

<span class="go">        HTTP/2: introduce ngx_http_v2_handle_event().</span>

<span class="go">        No functional changes.</span>

<span class="go">        Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;</span>
</pre></div>
<p>9番目と10番目のパッチは <code>gbp pq apply</code> で適用します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-09-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-09-of-14.diff</span>
<span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-10-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-10-of-14.diff</span>
</pre></div>
<p>11番目のパッチは再びエラーになります。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-11-of-14.diff
<span class="go">gbp:error: Error running git apply: error: patch failed: src/http/modules/ngx_http_proxy_module.c:1151</span>
<span class="go">error: src/http/modules/ngx_http_proxy_module.c: patch does not apply</span>
</pre></div>
<p><code>git am --reject</code> で適用を試みます。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git am --reject debian/patches/ngx_http_v2_upstream-11-of-14.diff
</pre></div>
<p>gitレポジトリの状態を確認します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git status -sb
<span class="gp">#</span><span class="c1"># patch-queue/master</span>
<span class="go">?? src/http/modules/ngx_http_proxy_module.c.rej</span>
</pre></div>
<p>前回の記事に書いたように、このパッチと等価な変更が既に適用されているので、このパッチはスキップします。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> rm src/http/modules/ngx_http_proxy_module.c.rej
<span class="gp">$</span> git am --skip
</pre></div>
<p>12番目から14番目のパッチは <code>gbp pq apply</code> で適用します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-12-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-12-of-14.diff</span>
<span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-13-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-13-of-14.diff</span>
<span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-14-of-14.diff
<span class="go">gbp:info: Applied ngx_http_v2_upstream-14-of-14.diff</span>
</pre></div>
</div>
<div class="section" id="id5">
<h2>パッチの再生成</h2>
<p>上記で作成したコミットの内容からパッチを再生成して <code>debian/patches/</code> ディレクトリのファイルを上書き更新してコミットします
。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq <span class="nb">export</span> --commit
<span class="go">gbp:info: On &#39;patch-queue/master&#39;, switching to &#39;master&#39;</span>
<span class="go">gbp:info: Generating patches from git (master..patch-queue/master)</span>
<span class="go">gbp:info: Added patches 0003-HTTP-2-add-debug-logging-of-control-frames.patch, 0011-Proxy-add-HTTP-2-support.patch, 0007-HTTP-2-introduce-ngx_http_v2_handle_event.patch, 0013-Cache-add-HTTP-2-support.patch, 0010-Proxy-always-emit-Host-header-first.patch, 0008-HTTP-2-add-HTTP-2-to-upstreams.patch, 0001-Output-chain-propagate-last_buf-flag-to-c-send_chain.patch, 0004-HTTP-2-s-client-peer.patch, 0009-Proxy-add-proxy_ssl_alpn-directive.patch, 0006-HTTP-2-introduce-stream-fake_connection.patch, 0005-HTTP-2-introduce-h2c-conf_ctx.patch, 0002-Upstream-keepalive-preserve-c-data.patch, 0012-Proxy-add-proxy_pass_trailers-directive.patch to patch series</span>
<span class="go">gbp:info: Removed patches ngx_http_v2_upstream-08-of-14.diff, ngx_http_v2_upstream-13-of-14.diff, ngx_http_v2_upstream-09-of-14.diff, ngx_http_v2_upstream-06-of-14.diff, ngx_http_v2_upstream-03-of-14.diff, ngx_http_v2_upstream-04-of-14.diff, ngx_http_v2_upstream-10-of-14.diff, ngx_http_v2_upstream-12-of-14.diff, ngx_http_v2_upstream-07-of-14.diff, ngx_http_v2_upstream-01-of-14.diff, ngx_http_v2_upstream-05-of-14.diff, ngx_http_v2_upstream-02-of-14.diff, ngx_http_v2_upstream-14-of-14.diff, ngx_http_v2_upstream-11-of-14.diff from patch series</span>
</pre></div>
<p>gitレポジトリの状態を確認すると、 <code>master</code> ブランチに切り替わっていました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git status -sb
<span class="gp">#</span><span class="c1"># master</span>
</pre></div>
<p>gitのログを確認すると <code>patch-queue/master</code> ブランチはそのままでした。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git log -1 patch-queue/master
<span class="go">commit 9e63d82fcbc542cd7fb19bb1facad31998b7d7f8</span>
<span class="go">Author: Piotr Sikora &lt;piotrsikora@google.com&gt;</span>
<span class="go">Date:   Wed Apr 12 08:51:41 2017</span>

<span class="go">        Cache: add HTTP/2 support.</span>

<span class="go">Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;</span>
</pre></div>
<p><code>master</code> ブランチには <code>gbp pq export --commit</code> によってコミットが作られていました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git log -1 master
<span class="go">commit 359f8e450d47336bc5c798961472c022efd39f1a</span>
<span class="go">Author: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;</span>
<span class="go">Date:   Fri Jul 14 15:32:49 2017</span>

<span class="go">        Rediff patches</span>

<span class="go">        Added 0003-HTTP-2-add-debug-logging-of-control-frames.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0011-Proxy-add-HTTP-2-support.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0007-HTTP-2-introduce-ngx_http_v2_handle_event.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0013-Cache-add-HTTP-2-support.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0010-Proxy-always-emit-Host-header-first.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0008-HTTP-2-add-HTTP-2-to-upstreams.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0001-Output-chain-propagate-last_buf-flag-to-c-send_chain.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0004-HTTP-2-s-client-peer.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0009-Proxy-add-proxy_ssl_alpn-directive.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0006-HTTP-2-introduce-stream-fake_connection.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0005-HTTP-2-introduce-h2c-conf_ctx.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0002-Upstream-keepalive-preserve-c-data.patch: &lt;REASON&gt;</span>
<span class="go">        Added 0012-Proxy-add-proxy_pass_trailers-directive.patch: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-08-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-13-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-09-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-06-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-03-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-04-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-10-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-12-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-07-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-01-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-05-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-02-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-14-of-14.diff: &lt;REASON&gt;</span>
<span class="go">        Dropped ngx_http_v2_upstream-11-of-14.diff: &lt;REASON&gt;</span>
</pre></div>
<p><code>debian/patches/</code> ディレクトリを確認すると、 <code>&lt;4桁の連番&gt;-&lt;Subject&gt;patch</code> という形式のファイル名で
パッチファイルが作られていました。</p>
<p>8番目のパッチの中身は上記でパッチが当たらなくて修正した部分が反映されたものになっていました。
また11番目のパッチは削除されてそれ以降のパッチが番号を詰められて作られていました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ls -1 debian/patches/
<span class="go">0001-Output-chain-propagate-last_buf-flag-to-c-send_chain.patch</span>
<span class="go">0002-Upstream-keepalive-preserve-c-data.patch</span>
<span class="go">0003-HTTP-2-add-debug-logging-of-control-frames.patch</span>
<span class="go">0004-HTTP-2-s-client-peer.patch</span>
<span class="go">0005-HTTP-2-introduce-h2c-conf_ctx.patch</span>
<span class="go">0006-HTTP-2-introduce-stream-fake_connection.patch</span>
<span class="go">0007-HTTP-2-introduce-ngx_http_v2_handle_event.patch</span>
<span class="go">0008-HTTP-2-add-HTTP-2-to-upstreams.patch</span>
<span class="go">0009-Proxy-add-proxy_ssl_alpn-directive.patch</span>
<span class="go">0010-Proxy-always-emit-Host-header-first.patch</span>
<span class="go">0011-Proxy-add-HTTP-2-support.patch</span>
<span class="go">0012-Proxy-add-proxy_pass_trailers-directive.patch</span>
<span class="go">0013-Cache-add-HTTP-2-support.patch</span>
<span class="go">series</span>
</pre></div>
</div>
<div class="section" id="debian-changelog">
<h2>debian/changelog編集</h2>
<p>後は前回と同様です。</p>
<p>まず、 <code>debian/changelog</code> を編集します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp dch -R
</pre></div>
<p>エディタで表示される内容の先頭のほうは以下のようになっていました。</p>
<div class="highlight"><pre><span></span>nginx (1.13.3-1~xenialubuntu1) xenial; urgency=medium

  * Add ngx_http_v2_upstream patches
  * Rediff patches

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Fri, 14 Jul 2017 16:07:32 +0900

nginx (1.13.3-1~xenial) xenial; urgency=low
</pre></div>
<p>これを以下のように編集しました。</p>
<div class="highlight"><pre><span></span>nginx (1.13.3-1~xenial1ppa1) xenial; urgency=medium

  * Add ngx_http_v2_upstream patches

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Fri, 14 Jul 2017 16:07:32 +0900

nginx (1.13.3-1~xenial) xenial; urgency=low
</pre></div>
<p>gitレポジトリの状態を確認し、 <code>debian/changelog</code> をコミットします。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git status -sb
<span class="gp">#</span><span class="c1"># master</span>
<span class="go"> M debian/changelog</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> git commit -m <span class="s1">&#39;Release 1.13.3-1~xenial1ppa1&#39;</span> debian/changelog
</pre></div>
</div>
<div class="section" id="id6">
<h2>ソースパッケージのビルド</h2>
<p>ソースパッケージのビルドですが、今回はupstreamのソースに対してdfsg対応の修正は加えておらずそのままなので <code>--git-pristine-tar-commit</code> オプションは指定せず以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp buildpackage --git-export-dir<span class="o">=</span>../build-area -S -sa
</pre></div>
<p>gpgのパスフレーズを2回聞かれるので入力します。</p>
</div>
<div class="section" id="id7">
<h2>バイナリパッケージのビルド</h2>
<p>以下のコマンドでバイナリパッケージをビルドします。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> sudo pbuilder build ../build-area/nginx_1.13.3-1~xenial1ppa1.dsc
</pre></div>
</div>
<div class="section" id="id8">
<h2>gitのタグ作成</h2>
<p>前回と同じタグなので <code>-f</code> を指定して付け替えます。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> git tag -f debian/1.13.3-1_xenial1ppa1
<span class="go">Updated tag &#39;debian/1.13.3-1_xenial1ppa1&#39; (was d718489)</span>
</pre></div>
</div>
<div class="section" id="upstream">
<h2>upstreamのソースをバージョンアップしたときのパッチ更新</h2>
<p>今回は試していませんが、 <code>git-buildpackage</code> の Working with patches のページによると
今後upstreamのソースの新しいバージョンを取り込んだときには以下のコマンドでパッチを更新できるようです。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp pq rebase
<span class="gp">$</span> gbp pq <span class="nb">export</span>
</pre></div>
</div>
<div class="section" id="id9">
<h2>おわりに</h2>
<p>以前は <code>git-quiltimport (1)</code> でパース可能なパッチファイルを作る手順がわかってなかったので
挫折しましたが、そこがわかってしまえば <code>quilt</code> コマンドは不慣れで <code>git</code> は慣れている私には
こちらのほうが作業しやすそうに感じました。</p>
<p>パッチの適用順序を入れ替えるのも <code>git rebase</code> でコミットの順序を入れ替えれば良さそうです。
ということで今後はこちらの方式を主に使うようにしてみます。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>