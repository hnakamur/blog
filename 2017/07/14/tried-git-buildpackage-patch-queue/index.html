<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.133.1">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>git-buildpackageのpatch-queue機能を試してみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2024. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>git-buildpackageのpatch-queue機能を試してみた</h1>
  <time datetime=2017-07-14T11:20:00&#43;0900 class="post-date">2017-07-14</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#パッチの準備">パッチの準備</a>
      <ul>
        <li><a href="#hg形式のパッチをgit形式のパッチに変換するスクリプト">hg形式のパッチをgit形式のパッチに変換するスクリプト</a></li>
        <li><a href="#hg形式のパッチを保存">hg形式のパッチを保存</a></li>
        <li><a href="#git形式のパッチに変換">git形式のパッチに変換</a></li>
      </ul>
    </li>
    <li><a href="#パッチのインポート">パッチのインポート</a></li>
    <li><a href="#パッチの適用">パッチの適用</a></li>
    <li><a href="#パッチの再生成">パッチの再生成</a></li>
    <li><a href="#debianchangelog編集">debian/changelog編集</a></li>
    <li><a href="#ソースパッケージのビルド">ソースパッケージのビルド</a></li>
    <li><a href="#バイナリパッケージのビルド">バイナリパッケージのビルド</a></li>
    <li><a href="#gitのタグ作成">gitのタグ作成</a></li>
    <li><a href="#upstreamのソースをバージョンアップしたときのパッチ更新">upstreamのソースをバージョンアップしたときのパッチ更新</a></li>
    <li><a href="#おわりに">おわりに</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="/blog/2017/07/14/build-nginx-deb-with-ngx_http_v2_upstream/">ngx_http_v2_upstreamモジュールを追加したnginxのdebパッケージを作ってみた</a> で <code>quilt</code> を使ったパッチ適用を経験してみて、不慣れなこともありちょっと面倒な気がしました。</p>
<p>そこで、 <code>git-buildpackage</code> の `Working with patches](<a href="http://honk.sigxcpu.org/projects/git-buildpackage/manual-html/gbp.patches.html">http://honk.sigxcpu.org/projects/git-buildpackage/manual-html/gbp.patches.html</a>) を試してみることにしました。</p>
<p>前回作業したgitのレポジトリで以下のコミットに戻してから、以下の手順を試しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">commit a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60
</span></span><span class="line"><span class="cl">Author: Konstantin Pavlov &lt;thresh@nginx.com&gt;
</span></span><span class="line"><span class="cl">Date:   Tue Jul 11 22:06:07 2017
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	Imported Debian patch 1.13.3-1~xenial
</span></span></code></pre></div><h2 id="パッチの準備">パッチの準備</h2>
<p>上記のページを見ると <code>debian/patches/</code> ディレクトリに <code>git-quiltimport (1)</code> でパース可能なパッチファイルをおいておく必要があるとのことです。</p>
<h3 id="hg形式のパッチをgit形式のパッチに変換するスクリプト">hg形式のパッチをgit形式のパッチに変換するスクリプト</h3>
<p>今回は元のパッチが <code>hg (mercurial)</code> の形式なので、これを変換できないかと検索してみると</p>
<p><a href="https://github.com/mozilla/moz-git-tools/blob/master/hg-patch-to-git-patch">moz-git-tools/hg-patch-to-git-patch at master · mozilla/moz-git-tools</a></p>
<p>というPythonスクリプトが見つかったので、ありがたくこれを使わせていただくことにしました。</p>
<p>私が試したバージョンは以下の通りです。</p>
<p><a href="https://github.com/mozilla/moz-git-tools/blob/d9009081a467ace43c0a8f535089a7c66a22c587/hg-patch-to-git-patch">moz-git-tools/hg-patch-to-git-patch at d9009081a467ace43c0a8f535089a7c66a22c587 · mozilla/moz-git-tools</a></p>
<p>これを <code>/usr/local/bin/hg-patch-to-git-patch</code> というファイル名で保存し、実行パーミションをつけておきます。　</p>
<h3 id="hg形式のパッチを保存">hg形式のパッチを保存</h3>
<p><code>~/nginx.org-deb/ngx_http_v2_upstream-hg-patches</code> というディレクトリにhg形式のパッチを保存することにしました。
スパムメール防止用に変換されているメールアドレス内の <code>at</code> と前後のスペースを <code>@</code> に戻してパッチを保存します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ls
</span></span><span class="line"><span class="cl"><span class="go">ngx_http_v2_upstream-01-of-14.diff  ngx_http_v2_upstream-06-of-14.diff  ngx_http_v2_upstream-11-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">ngx_http_v2_upstream-02-of-14.diff  ngx_http_v2_upstream-07-of-14.diff  ngx_http_v2_upstream-12-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">ngx_http_v2_upstream-03-of-14.diff  ngx_http_v2_upstream-08-of-14.diff  ngx_http_v2_upstream-13-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">ngx_http_v2_upstream-04-of-14.diff  ngx_http_v2_upstream-09-of-14.diff  ngx_http_v2_upstream-14-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">ngx_http_v2_upstream-05-of-14.diff  ngx_http_v2_upstream-10-of-14.diff
</span></span></span></code></pre></div><h3 id="git形式のパッチに変換">git形式のパッチに変換</h3>
<p>git形式のパッチを保存するディレクトリ <code>~/nginx.org-deb/ngx_http_v2_upstream-git-patches</code> を作成し、上記のスクリプトで変換します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> mkdir ../ngx_http_v2_upstream-git-patches
</span></span><span class="line"><span class="cl"><span class="gp">$</span> <span class="k">for</span> i in *<span class="p">;</span> <span class="k">do</span> hg-patch-to-git-patch <span class="nv">$i</span> &gt; ../ngx_http_v2_upstream-git-patches/<span class="nv">$i</span> <span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></div><p>変換後のgit形式のパッチの先頭は以下のようになっていました（メールアドレス内の <code>@</code> はスパムメール防止用に <code>at</code> ＋前後の空白に置換しています）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> head ../ngx_http_v2_upstream-git-patches/ngx_http_v2_upstream-01-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">From: Piotr Sikora &lt;piotrsikora at google.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">Date: 1491708381 -0700
</span></span></span><span class="line"><span class="cl"><span class="go">Subject: Output chain: propagate last_buf flag to c-&gt;send_chain().
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">Signed-off-by: Piotr Sikora &lt;piotrsikora at google.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">diff -r a39bc74873fa -r 5f5d70428655 src/core/ngx_output_chain.c
</span></span></span><span class="line"><span class="cl"><span class="go">--- a/src/core/ngx_output_chain.c
</span></span></span><span class="line"><span class="cl"><span class="go">+++ b/src/core/ngx_output_chain.c
</span></span></span><span class="line"><span class="cl"><span class="go">@@ -658,6 +658,7 @@ ngx_chain_writer(void *data, ngx_chain_t
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> head -13 ../ngx_http_v2_upstream-git-patches/ngx_http_v2_upstream-09-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">From: Piotr Sikora &lt;piotrsikora at google.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">Date: 1489621682 -0700
</span></span></span><span class="line"><span class="cl"><span class="go">Subject: Proxy: add &#34;proxy_ssl_alpn&#34; directive.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">ALPN is used here only to indicate which version of the HTTP protocol
</span></span></span><span class="line"><span class="cl"><span class="go">is going to be used and we doesn&#39;t verify that upstream agreed to it.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">Please note that upstream is allowed to reject SSL connection with a
</span></span></span><span class="line"><span class="cl"><span class="go">fatal &#34;no_application_protocol&#34; alert if it doesn&#39;t support it.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">Signed-off-by: Piotr Sikora &lt;piotrsikora at google.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">diff -r 154ca6c5e62a -r 96075d4cd2a6 src/event/ngx_event_openssl.c
</span></span></span></code></pre></div><h2 id="パッチのインポート">パッチのインポート</h2>
<p>パッチをインポートは前回同様 <code>dquilt import</code> で行います。
パッチはスタックとして管理されるので14番のパッチから1番のパッチへと逆順にインポートしています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> <span class="nb">cd</span> ~/.ghq/github.com/hnakamur/nginx-deb
</span></span><span class="line"><span class="cl"><span class="gp">$</span> <span class="k">for</span> i in <span class="o">{</span>14..01<span class="o">}</span><span class="p">;</span> <span class="k">do</span> dquilt import ~/nginx.org-deb/ngx_http_v2_upstream-git-patches/ngx_http_v2_upstream-<span class="nv">$i</span>-of-14.diff<span class="p">;</span> <span class="k">done</span>
</span></span></code></pre></div><p>インポートしたパッチをgitに追加してコミットしておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git status -sb
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="c1"># patch-queue/master</span>
</span></span><span class="line"><span class="cl"><span class="go">?? debian/patches/
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> git add .
</span></span><span class="line"><span class="cl"><span class="gp">$</span> git status -sb
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="c1"># patch-queue/master</span>
</span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-01-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-02-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-03-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-04-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-05-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-06-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-07-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-08-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-09-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-10-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-11-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-12-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-13-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/ngx_http_v2_upstream-14-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">A  debian/patches/series
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> git commit -m <span class="s1">&#39;Add ngx_http_v2_upstream patches&#39;</span>
</span></span></code></pre></div><h2 id="パッチの適用">パッチの適用</h2>
<p>次は <code>gbp pq import</code> コマンドを実行します。8番目のパッチが当たらずエラーになりました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq import
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Trying to apply patches at &#39;a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:error: Failed to apply &#39;debian/patches/ngx_http_v2_upstream-08-of-14.diff&#39;: Error running git apply: error: patch failed: src/http/ngx_http_upstream.c:1709
</span></span></span><span class="line"><span class="cl"><span class="go">error: src/http/ngx_http_upstream.c: patch does not apply
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">gbp:error: Couldn&#39;t apply patches
</span></span></span></code></pre></div><p><code>-v</code> を付けて再度試してみました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq import -v
</span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;rev-parse&#39;, &#39;--show-cdup&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;rev-parse&#39;, &#39;--is-bare-repository&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;symbolic-ref&#39;, &#39;HEAD&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;show-ref&#39;, &#39;refs/heads/master&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;show-ref&#39;, &#39;refs/heads/patch-queue/master&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;log&#39;, &#39;--pretty=format:%H&#39;, &#39;-1&#39;, &#39;--first-parent&#39;, &#39;--&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Trying to apply patches at &#39;a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;branch&#39;, &#39;patch-queue/master&#39;, &#39;a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;symbolic-ref&#39;, &#39;HEAD&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;show-ref&#39;, &#39;refs/heads/master&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;checkout&#39;, &#39;patch-queue/master&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: Applying debian/patches/ngx_http_v2_upstream-01-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">…(略)…
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;apply&#39;, &#39;--index&#39;, &#39;debian/patches/ngx_http_v2_upstream-07-of-14.diff&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;write-tree&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;rev-parse&#39;, &#39;--quiet&#39;, &#39;--verify&#39;, &#39;HEAD&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;commit-tree&#39;, &#39;04ca7796412675740f5b1b89f0ca19ad8dd19756&#39;, &#39;-p&#39;, &#39;43b9919966a4321ec76d9ccdd9921bac449abf8c&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;update-ref&#39;, &#39;-m&#39;, &#39;gbp-pq import debian/patches/ngx_http_v2_upstream-07-of-14.diff&#39;, &#39;HEAD&#39;, &#39;d8e3319aac2d07f18f719df074cf21de90482a16&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: Applying debian/patches/ngx_http_v2_upstream-08-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;apply&#39;, &#39;--index&#39;, &#39;debian/patches/ngx_http_v2_upstream-08-of-14.diff&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:error: Failed to apply &#39;debian/patches/ngx_http_v2_upstream-08-of-14.diff&#39;: Error running git apply: error: patch failed: src/http/ngx_http_upstream.c:1709
</span></span></span><span class="line"><span class="cl"><span class="go">error: src/http/ngx_http_upstream.c: patch does not apply
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">gbp:debug: [&#39;git&#39;, &#39;rev-parse&#39;, &#39;--quiet&#39;, &#39;--verify&#39;, &#39;HEAD&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;reset&#39;, &#39;--quiet&#39;, &#39;--hard&#39;, &#39;d8e3319aac2d07f18f719df074cf21de90482a16&#39;, &#39;--&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;symbolic-ref&#39;, &#39;HEAD&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;show-ref&#39;, &#39;refs/heads/patch-queue/master&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;checkout&#39;, &#39;master&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;symbolic-ref&#39;, &#39;HEAD&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;show-ref&#39;, &#39;refs/heads/master&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:debug: [&#39;git&#39;, &#39;branch&#39;, &#39;-D&#39;, &#39;patch-queue/master&#39;]
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:error: Couldn&#39;t apply patches
</span></span></span></code></pre></div><p><code>man gbp-pq</code> すると <code>apply</code> サブコマンドで1つずつパッチを当てられるようなので、そちらを試してみました。
<code>apply</code> の後に何も指定せずに実行するとパッチ名が無いというエラーになりました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq apply
</span></span><span class="line"><span class="cl"><span class="go">gbp:error: No patch name given.
</span></span></span></code></pre></div><p>ファイル名を指定して実行してみるとうまく動きました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-01-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Switching to &#39;patch-queue/master&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-01-of-14.diff
</span></span></span></code></pre></div><p>gitレポジトリの状態を確認すると <code>patch-queue/master</code> ブランチが作られてそこに切り替わっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git status -sb
</span></span><span class="line"><span class="cl"><span class="go">  master
</span></span></span><span class="line"><span class="cl"><span class="go">* patch-queue/master
</span></span></span><span class="line"><span class="cl"><span class="go">  pristine-tar
</span></span></span><span class="line"><span class="cl"><span class="go">  upstream
</span></span></span></code></pre></div><p>gitのログを確認すると1番目のパッチを取り込んだコミットが作られています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git log
</span></span><span class="line"><span class="cl"><span class="go">commit bdd197591d9f85f9a2f9c95ce9e38d4557947bce
</span></span></span><span class="line"><span class="cl"><span class="go">Author: Piotr Sikora &lt;piotrsikora@google.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">Date:   Sun Apr 9 12:26:21 2017
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	Output chain: propagate last_buf flag to c-&gt;send_chain().
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">commit 2f8475f406a170123a9598b6a0a3a217c66421f3
</span></span></span><span class="line"><span class="cl"><span class="go">Author: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">Date:   Fri Jul 14 14:50:43 2017
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	Add ngx_http_v2_upstream patches
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">commit a2bfcc9998da58bebd5b5fc7e355cf9a8ff95d60
</span></span></span><span class="line"><span class="cl"><span class="go">Author: Konstantin Pavlov &lt;thresh@nginx.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">Date:   Tue Jul 11 22:06:07 2017
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	Imported Debian patch 1.13.3-1~xenial
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">commit 8483de20a8ef51e65ca23e855c8354ad4193cbe5
</span></span></span><span class="line"><span class="cl"><span class="go">Author: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">Date:   Fri Jul 14 00:25:32 2017
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	Imported Upstream version 1.13.3
</span></span></span></code></pre></div><p><code>git diff HEAD^</code> を実行すると1番目のパッチと同じ差分になっていました。</p>
<p>同様にして7番目のパッチまで適用します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-02-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-02-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-03-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-03-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-04-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-04-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-05-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-05-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-06-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-06-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-07-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-07-of-14.diff
</span></span></span></code></pre></div><p>8番目のパッチはうまく当たらずエラーになるのは同じです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-08-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:error: Error running git apply: error: patch failed: src/http/ngx_http_upstream.c:1709
</span></span></span><span class="line"><span class="cl"><span class="go">error: src/http/ngx_http_upstream.c: patch does not apply
</span></span></span></code></pre></div><p><code>git-buildpackage</code> の Working with patches のページにはパッチが当たらない場合の手順は書いてないので、試行錯誤してみることにしました。</p>
<p>まず <code>git am</code> コマンドでパッチを当てて見ると以下のようになりました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git am debian/patches/ngx_http_v2_upstream-08-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">Applying: HTTP/2: add HTTP/2 to upstreams.
</span></span></span><span class="line"><span class="cl"><span class="go">error: patch failed: src/http/ngx_http_upstream.c:1709
</span></span></span><span class="line"><span class="cl"><span class="go">error: src/http/ngx_http_upstream.c: patch does not apply
</span></span></span><span class="line"><span class="cl"><span class="go">Patch failed at 0001 HTTP/2: add HTTP/2 to upstreams.
</span></span></span><span class="line"><span class="cl"><span class="go">The copy of the patch that failed is found in: .git/rebase-apply/patch
</span></span></span><span class="line"><span class="cl"><span class="go">When you have resolved this problem, run &#34;git am --continue&#34;.
</span></span></span><span class="line"><span class="cl"><span class="go">If you prefer to skip this patch, run &#34;git am --skip&#34; instead.
</span></span></span><span class="line"><span class="cl"><span class="go">To restore the original branch and stop patching, run &#34;git am --abort&#34;.
</span></span></span></code></pre></div><p><code>man git-am</code> を見ると <code>--reject</code> オプションがあったので、一旦 <code>git am --abort</code> で中断してからこれを試しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git am --abort
</span></span><span class="line"><span class="cl"><span class="gp">$</span> git am --reject debian/patches/ngx_http_v2_upstream-08-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">Applying: HTTP/2: add HTTP/2 to upstreams.
</span></span></span><span class="line"><span class="cl"><span class="go">Checking patch auto/modules...
</span></span></span><span class="line"><span class="cl"><span class="go">Checking patch src/core/ngx_connection.h...
</span></span></span><span class="line"><span class="cl"><span class="go">Checking patch src/http/ngx_http_upstream.c...
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #2 succeeded at 190 (offset 2 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #3 succeeded at 1523 (offset 7 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #4 succeeded at 1558 (offset 7 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #5 succeeded at 1626 (offset 7 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #6 succeeded at 1649 (offset 7 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">error: while searching for:
</span></span></span><span class="line"><span class="cl"><span class="go">		c-&gt;write-&gt;handler = ngx_http_upstream_handler;
</span></span></span><span class="line"><span class="cl"><span class="go">		c-&gt;read-&gt;handler = ngx_http_upstream_handler;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">		c = r-&gt;connection;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">		ngx_http_upstream_send_request(r, u, 1);
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">error: patch failed: src/http/ngx_http_upstream.c:1709
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #8 succeeded at 1878 (offset 5 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #9 succeeded at 2017 (offset 5 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #10 succeeded at 2219 (offset 5 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #11 succeeded at 2282 (offset 5 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #12 succeeded at 2400 (offset 5 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #13 succeeded at 2436 (offset 5 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #14 succeeded at 2684 (offset 5 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #15 succeeded at 4192 (offset 5 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #16 succeeded at 4373 (offset 5 lines).
</span></span></span><span class="line"><span class="cl"><span class="go">Checking patch src/http/ngx_http_upstream.h...
</span></span></span><span class="line"><span class="cl"><span class="go">Checking patch src/http/v2/ngx_http_v2.c...
</span></span></span><span class="line"><span class="cl"><span class="go">Checking patch src/http/v2/ngx_http_v2.h...
</span></span></span><span class="line"><span class="cl"><span class="go">Checking patch src/http/v2/ngx_http_v2_filter_module.c...
</span></span></span><span class="line"><span class="cl"><span class="go">Checking patch src/http/v2/ngx_http_v2_module.c...
</span></span></span><span class="line"><span class="cl"><span class="go">Checking patch src/http/v2/ngx_http_v2_upstream.c...
</span></span></span><span class="line"><span class="cl"><span class="go">Applied patch auto/modules cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Applied patch src/core/ngx_connection.h cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Applying patch src/http/ngx_http_upstream.c with 1 reject...
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #1 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #2 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #3 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #4 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #5 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #6 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Rejected hunk #7.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #8 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #9 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #10 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #11 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #12 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #13 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #14 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #15 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Hunk #16 applied cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Applied patch src/http/ngx_http_upstream.h cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Applied patch src/http/v2/ngx_http_v2.c cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Applied patch src/http/v2/ngx_http_v2.h cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Applied patch src/http/v2/ngx_http_v2_filter_module.c cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Applied patch src/http/v2/ngx_http_v2_module.c cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Applied patch src/http/v2/ngx_http_v2_upstream.c cleanly.
</span></span></span><span class="line"><span class="cl"><span class="go">Patch failed at 0001 HTTP/2: add HTTP/2 to upstreams.
</span></span></span><span class="line"><span class="cl"><span class="go">The copy of the patch that failed is found in: .git/rebase-apply/patch
</span></span></span><span class="line"><span class="cl"><span class="go">When you have resolved this problem, run &#34;git am --continue&#34;.
</span></span></span><span class="line"><span class="cl"><span class="go">If you prefer to skip this patch, run &#34;git am --skip&#34; instead.
</span></span></span><span class="line"><span class="cl"><span class="go">To restore the original branch and stop patching, run &#34;git am --abort&#34;.
</span></span></span></code></pre></div><p>gitのレポジトリの状態は以下のようになっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git status -sb
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="c1"># patch-queue/master</span>
</span></span><span class="line"><span class="cl"><span class="go"> M auto/modules
</span></span></span><span class="line"><span class="cl"><span class="go"> M src/core/ngx_connection.h
</span></span></span><span class="line"><span class="cl"><span class="go"> M src/http/ngx_http_upstream.c
</span></span></span><span class="line"><span class="cl"><span class="go"> M src/http/ngx_http_upstream.h
</span></span></span><span class="line"><span class="cl"><span class="go"> M src/http/v2/ngx_http_v2.c
</span></span></span><span class="line"><span class="cl"><span class="go"> M src/http/v2/ngx_http_v2.h
</span></span></span><span class="line"><span class="cl"><span class="go"> M src/http/v2/ngx_http_v2_filter_module.c
</span></span></span><span class="line"><span class="cl"><span class="go"> M src/http/v2/ngx_http_v2_module.c
</span></span></span><span class="line"><span class="cl"><span class="go">?? src/http/ngx_http_upstream.c.rej
</span></span></span><span class="line"><span class="cl"><span class="go">?? src/http/v2/ngx_http_v2_upstream.c
</span></span></span></code></pre></div><p><code>src/http/ngx_http_upstream.c.rej</code> を見ながら <code>src/http/ngx_http_upstream.c</code> を編集します。</p>
<p>その後 <code>src/http/ngx_http_upstream.c.rej</code> は消して <code>git add</code> で変更のあったファイルを追加して
<code>git am --continue</code> を実行するとパッチが適用できました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> rm src/http/ngx_http_upstream.c.rej
</span></span><span class="line"><span class="cl"><span class="gp">$</span> git add .
</span></span><span class="line"><span class="cl"><span class="gp">$</span> g am --continue
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">Applying: HTTP/2: add HTTP/2 to upstreams.
</span></span></span></code></pre></div><p>ログで最新2つのコミットを見てみると、前のコミットと同様に <code>Author</code> や <code>Date</code> の内容も正しく設定されているようです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git log -2
</span></span><span class="line"><span class="cl"><span class="go">commit b2ea482abd9c1cfbd9966316370759bc01095df3
</span></span></span><span class="line"><span class="cl"><span class="go">Author: Piotr Sikora &lt;piotrsikora@google.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">Date:   Wed Mar 29 14:59:40 2017
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	HTTP/2: add HTTP/2 to upstreams.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">commit 052e2e79cb13eff69bffcfa2cd4bc2bcfdb54fc1
</span></span></span><span class="line"><span class="cl"><span class="go">Author: Piotr Sikora &lt;piotrsikora@google.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">Date:   Fri Mar 10 12:00:45 2017
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	HTTP/2: introduce ngx_http_v2_handle_event().
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	No functional changes.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;
</span></span></span></code></pre></div><p>9番目と10番目のパッチは <code>gbp pq apply</code> で適用します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-09-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-09-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-10-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-10-of-14.diff
</span></span></span></code></pre></div><p>11番目のパッチは再びエラーになります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-11-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:error: Error running git apply: error: patch failed: src/http/modules/ngx_http_proxy_module.c:1151
</span></span></span><span class="line"><span class="cl"><span class="go">error: src/http/modules/ngx_http_proxy_module.c: patch does not apply
</span></span></span></code></pre></div><p><code>git am --reject</code> で適用を試みます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git am --reject debian/patches/ngx_http_v2_upstream-11-of-14.diff
</span></span></code></pre></div><p>gitレポジトリの状態を確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git status -sb
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="c1"># patch-queue/master</span>
</span></span><span class="line"><span class="cl"><span class="go">?? src/http/modules/ngx_http_proxy_module.c.rej
</span></span></span></code></pre></div><p>前回の記事に書いたように、このパッチと等価な変更が既に適用されているので、このパッチはスキップします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> rm src/http/modules/ngx_http_proxy_module.c.rej
</span></span><span class="line"><span class="cl"><span class="gp">$</span> git am --skip
</span></span></code></pre></div><p>12番目から14番目のパッチは <code>gbp pq apply</code> で適用します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-12-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-12-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-13-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-13-of-14.diff
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> gbp pq apply debian/patches/ngx_http_v2_upstream-14-of-14.diff
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: Applied ngx_http_v2_upstream-14-of-14.diff
</span></span></span></code></pre></div><h2 id="パッチの再生成">パッチの再生成</h2>
<p>上記で作成したコミットの内容からパッチを再生成して <code>debian/patches/</code> ディレクトリのファイルを上書き更新してコミットします
。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq <span class="nb">export</span> --commit
</span></span><span class="line"><span class="cl"><span class="go">gbp:info: On &#39;patch-queue/master&#39;, switching to &#39;master&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Generating patches from git (master..patch-queue/master)
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Added patches 0003-HTTP-2-add-debug-logging-of-control-frames.patch, 0011-Proxy-add-HTTP-2-support.patch, 0007-HTTP-2-introduce-ngx_http_v2_handle_event.patch, 0013-Cache-add-HTTP-2-support.patch, 0010-Proxy-always-emit-Host-header-first.patch, 0008-HTTP-2-add-HTTP-2-to-upstreams.patch, 0001-Output-chain-propagate-last_buf-flag-to-c-send_chain.patch, 0004-HTTP-2-s-client-peer.patch, 0009-Proxy-add-proxy_ssl_alpn-directive.patch, 0006-HTTP-2-introduce-stream-fake_connection.patch, 0005-HTTP-2-introduce-h2c-conf_ctx.patch, 0002-Upstream-keepalive-preserve-c-data.patch, 0012-Proxy-add-proxy_pass_trailers-directive.patch to patch series
</span></span></span><span class="line"><span class="cl"><span class="go">gbp:info: Removed patches ngx_http_v2_upstream-08-of-14.diff, ngx_http_v2_upstream-13-of-14.diff, ngx_http_v2_upstream-09-of-14.diff, ngx_http_v2_upstream-06-of-14.diff, ngx_http_v2_upstream-03-of-14.diff, ngx_http_v2_upstream-04-of-14.diff, ngx_http_v2_upstream-10-of-14.diff, ngx_http_v2_upstream-12-of-14.diff, ngx_http_v2_upstream-07-of-14.diff, ngx_http_v2_upstream-01-of-14.diff, ngx_http_v2_upstream-05-of-14.diff, ngx_http_v2_upstream-02-of-14.diff, ngx_http_v2_upstream-14-of-14.diff, ngx_http_v2_upstream-11-of-14.diff from patch series
</span></span></span></code></pre></div><p>gitレポジトリの状態を確認すると、 <code>master</code> ブランチに切り替わっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git status -sb
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="c1"># master</span>
</span></span></code></pre></div><p>gitのログを確認すると <code>patch-queue/master</code> ブランチはそのままでした。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git log -1 patch-queue/master
</span></span><span class="line"><span class="cl"><span class="go">commit 9e63d82fcbc542cd7fb19bb1facad31998b7d7f8
</span></span></span><span class="line"><span class="cl"><span class="go">Author: Piotr Sikora &lt;piotrsikora@google.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">Date:   Wed Apr 12 08:51:41 2017
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	Cache: add HTTP/2 support.
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">Signed-off-by: Piotr Sikora &lt;piotrsikora@google.com&gt;
</span></span></span></code></pre></div><p><code>master</code> ブランチには <code>gbp pq export --commit</code> によってコミットが作られていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git log -1 master
</span></span><span class="line"><span class="cl"><span class="go">commit 359f8e450d47336bc5c798961472c022efd39f1a
</span></span></span><span class="line"><span class="cl"><span class="go">Author: Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">Date:   Fri Jul 14 15:32:49 2017
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	Rediff patches
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">	Added 0003-HTTP-2-add-debug-logging-of-control-frames.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0011-Proxy-add-HTTP-2-support.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0007-HTTP-2-introduce-ngx_http_v2_handle_event.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0013-Cache-add-HTTP-2-support.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0010-Proxy-always-emit-Host-header-first.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0008-HTTP-2-add-HTTP-2-to-upstreams.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0001-Output-chain-propagate-last_buf-flag-to-c-send_chain.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0004-HTTP-2-s-client-peer.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0009-Proxy-add-proxy_ssl_alpn-directive.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0006-HTTP-2-introduce-stream-fake_connection.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0005-HTTP-2-introduce-h2c-conf_ctx.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0002-Upstream-keepalive-preserve-c-data.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Added 0012-Proxy-add-proxy_pass_trailers-directive.patch: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-08-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-13-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-09-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-06-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-03-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-04-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-10-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-12-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-07-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-01-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-05-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-02-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-14-of-14.diff: &lt;REASON&gt;
</span></span></span><span class="line"><span class="cl"><span class="go">	Dropped ngx_http_v2_upstream-11-of-14.diff: &lt;REASON&gt;
</span></span></span></code></pre></div><p><code>debian/patches/</code> ディレクトリを確認すると、 <code>&lt;4桁の連番&gt;-&lt;Subject&gt;patch</code> という形式のファイル名で
パッチファイルが作られていました。</p>
<p>8番目のパッチの中身は上記でパッチが当たらなくて修正した部分が反映されたものになっていました。
また11番目のパッチは削除されてそれ以降のパッチが番号を詰められて作られていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ls -1 debian/patches/
</span></span><span class="line"><span class="cl"><span class="go">0001-Output-chain-propagate-last_buf-flag-to-c-send_chain.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0002-Upstream-keepalive-preserve-c-data.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0003-HTTP-2-add-debug-logging-of-control-frames.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0004-HTTP-2-s-client-peer.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0005-HTTP-2-introduce-h2c-conf_ctx.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0006-HTTP-2-introduce-stream-fake_connection.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0007-HTTP-2-introduce-ngx_http_v2_handle_event.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0008-HTTP-2-add-HTTP-2-to-upstreams.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0009-Proxy-add-proxy_ssl_alpn-directive.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0010-Proxy-always-emit-Host-header-first.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0011-Proxy-add-HTTP-2-support.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0012-Proxy-add-proxy_pass_trailers-directive.patch
</span></span></span><span class="line"><span class="cl"><span class="go">0013-Cache-add-HTTP-2-support.patch
</span></span></span><span class="line"><span class="cl"><span class="go">series
</span></span></span></code></pre></div><h2 id="debianchangelog編集">debian/changelog編集</h2>
<p>後は前回と同様です。</p>
<p>まず、 <code>debian/changelog</code> を編集します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp dch -R
</span></span></code></pre></div><p>エディタで表示される内容の先頭のほうは以下のようになっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">nginx (1.13.3-1~xenialubuntu1) xenial; urgency=medium
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  * Add ngx_http_v2_upstream patches
</span></span><span class="line"><span class="cl">  * Rediff patches
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Fri, 14 Jul 2017 16:07:32 +0900
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nginx (1.13.3-1~xenial) xenial; urgency=low
</span></span></code></pre></div><p>これを以下のように編集しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">nginx (1.13.3-1~xenial1ppa1) xenial; urgency=medium
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  * Add ngx_http_v2_upstream patches
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Fri, 14 Jul 2017 16:07:32 +0900
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">nginx (1.13.3-1~xenial) xenial; urgency=low
</span></span></code></pre></div><p>gitレポジトリの状態を確認し、 <code>debian/changelog</code> をコミットします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git status -sb
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="c1"># master</span>
</span></span><span class="line"><span class="cl"><span class="go"> M debian/changelog
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git commit -m <span class="s1">&#39;Release 1.13.3-1~xenial1ppa1&#39;</span> debian/changelog
</span></span></code></pre></div><h2 id="ソースパッケージのビルド">ソースパッケージのビルド</h2>
<p>ソースパッケージのビルドですが、今回はupstreamのソースに対してdfsg対応の修正は加えておらずそのままなので <code>--git-pristine-tar-commit</code> オプションは指定せず以下のコマンドを実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp buildpackage --git-export-dir<span class="o">=</span>../build-area -S -sa
</span></span></code></pre></div><p>gpgのパスフレーズを2回聞かれるので入力します。</p>
<h2 id="バイナリパッケージのビルド">バイナリパッケージのビルド</h2>
<p>以下のコマンドでバイナリパッケージをビルドします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> sudo pbuilder build ../build-area/nginx_1.13.3-1~xenial1ppa1.dsc
</span></span></code></pre></div><h2 id="gitのタグ作成">gitのタグ作成</h2>
<p>前回と同じタグなので <code>-f</code> を指定して付け替えます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> git tag -f debian/1.13.3-1_xenial1ppa1
</span></span><span class="line"><span class="cl"><span class="go">Updated tag &#39;debian/1.13.3-1_xenial1ppa1&#39; (was d718489)
</span></span></span></code></pre></div><h2 id="upstreamのソースをバージョンアップしたときのパッチ更新">upstreamのソースをバージョンアップしたときのパッチ更新</h2>
<p>今回は試していませんが、 <code>git-buildpackage</code> の Working with patches のページによると
今後upstreamのソースの新しいバージョンを取り込んだときには以下のコマンドでパッチを更新できるようです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> gbp pq rebase
</span></span><span class="line"><span class="cl"><span class="gp">$</span> gbp pq <span class="nb">export</span>
</span></span></code></pre></div><h2 id="おわりに">おわりに</h2>
<p>以前は <code>git-quiltimport (1)</code> でパース可能なパッチファイルを作る手順がわかってなかったので
挫折しましたが、そこがわかってしまえば <code>quilt</code> コマンドは不慣れで <code>git</code> は慣れている私には
こちらのほうが作業しやすそうに感じました。</p>
<p>パッチの適用順序を入れ替えるのも <code>git rebase</code> でコミットの順序を入れ替えれば良さそうです。
ということで今後はこちらの方式を主に使うようにしてみます。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>
  </body>
</html>
