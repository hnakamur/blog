<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>ngx_http_v2_upstreamモジュールを追加したnginxのdebパッケージを作ってみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/07/14/build-nginx-deb-with-ngx_http_v2_upstream/" rel="bookmark"
           title="Permalink to ngx_http_v2_upstreamモジュールを追加したnginxのdebパッケージを作ってみた">ngx_http_v2_upstreamモジュールを追加したnginxのdebパッケージを作ってみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-07-14T06:07:00+09:00">
                Published: 2017-07-14
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/deb-nginx.html">deb nginx</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="http://asnokaze.hatenablog.com/entry/2017/07/03/083530">Nginxのリバースプロキシでバックエンドとhttp2通信する - ASnoKaze blog</a> で紹介されていたngx_http_v2_upstreamモジュールを組み込んだnginxのdebianパッケージを作ってみたのでメモです。</p>
<p><a class="reference external" href="/blog/2017/07/05/how-to-build-deb-with-git-buildpackage/">git-buildpackageでdebパッケージをビルドしてPPAにアップロードする手順</a> のdquiltでパッチを適用するところでこの記事とは違うパターンが出てきたので、そこを重点的に書いておきます。</p>
<p>なお、なるべくupstreamに近いものを使いたいので、ベースはUbuntuのパッケージではなく <a class="reference external" href="http://nginx.org/">nginx.org</a> のパッケージを使います。</p>
<p><a class="reference external" href="http://nginx.org/en/download.html">nginx: download</a> のページのPre-Built Packagesにはstable versionとmainline versionの2種類がありますが、 <a class="reference external" href="http://bokko.hatenablog.com/entry/2014/05/24/220554">どのバージョンのnginxを使うべきか？ - 考える人、コードを書く人</a> を読んで以来私はmainlineを使っています。</p>
<p>今回使用した nginx のバージョンは 1.13.3 で、作業した環境は Ubuntu 16.04 です。</p>
</div>
<div class="section" id="id2">
<h2>ソースパッケージのダウンロード</h2>
<p><a class="reference external" href="http://nginx.org/en/linux_packages.html#mainline">Pre-Built Packages for Mainline version</a> を参考に以下の内容を <code>/etc/apt/sources.list.d/nginx-org.list</code> というファイルに保存します。</p>
<div class="highlight"><pre><span></span>deb http://nginx.org/packages/mainline/ubuntu/ xenial nginx
deb-src http://nginx.org/packages/mainline/ubuntu/ xenial nginx
</pre></div>
<p>作業ディレクトリを作って nginx.org で配布しているdebのソースパッケージをダウンロードします。</p>
<div class="highlight"><pre><span></span><span class="go">mkdir -p ~/nginx.org-deb/nginx-1.13.3-deb</span>
<span class="go">cd !$</span>
<span class="go">sudo apt update</span>
<span class="go">sudo apt source nginx</span>
</pre></div>
<p>ダウンロードされたファイルは以下の通りです。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/nginx.org-deb/nginx-1.13.3-deb$</span> ls -F
<span class="go">nginx-1.13.3/                        nginx_1.13.3-1~xenial.dsc</span>
<span class="go">nginx_1.13.3-1~xenial.debian.tar.xz  nginx_1.13.3.orig.tar.gz</span>
</pre></div>
</div>
<div class="section" id="dep-3">
<h2>パッチファイルをDEP-3準拠にして保存</h2>
<p><code>~/nginx.org-deb/ngx_http_v2_upstream-patches</code> というディレクトリを作り、そこに以下の14個のパッチを保存しました。</p>
<ul class="simple">
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010209.html">[PATCH 01 of 14] Output chain: propagate last_buf flag to c-&gt;send_chain()</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010210.html">[PATCH 02 of 14] Upstream keepalive: preserve c-&gt;data</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010211.html">[PATCH 03 of 14] HTTP/2: add debug logging of control frames</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010212.html">[PATCH 04 of 14] HTTP/2: s/client/peer/</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010213.html">[PATCH 05 of 14] HTTP/2: introduce h2c-&gt;conf_ctx</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010214.html">[PATCH 06 of 14] HTTP/2: introduce stream-&gt;fake_connection</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010215.html">[PATCH 07 of 14] HTTP/2: introduce ngx_http_v2_handle_event()</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010216.html">[PATCH 08 of 14] HTTP/2: add HTTP/2 to upstreams</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010217.html">[PATCH 09 of 14] Proxy: add &quot;proxy_ssl_alpn&quot; directive</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010218.html">[PATCH 10 of 14] Proxy: always emit &quot;Host&quot; header first</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010219.html">[PATCH 11 of 14] Proxy: split configured header names and values</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010221.html">[PATCH 12 of 14] Proxy: add HTTP/2 support</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010220.html">[PATCH 13 of 14] Proxy: add &quot;proxy_pass_trailers&quot; directive</a></li>
<li><a class="reference external" href="http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010222.html">[PATCH 14 of 14] Cache: add HTTP/2 support</a></li>
</ul>
<p><a class="reference external" href="http://packaging.ubuntu.com/html/patches-to-packages.html">8. Patches to Packages — Ubuntu Packaging Guide</a> でもお勧めされている通り、 パッチは <a class="reference external" href="http://dep.debian.net/">Debian Enhancement Proposals</a> の <a class="reference external" href="http://dep.debian.net/deps/dep3/">DEP-3: Patch Tagging Guidelines</a> に準拠した形式にしておきます。</p>
<p>今回は <code>Subject</code> 、 <code>Author</code> 、 <code>Description</code> 、 <code>Origin</code> ヘッダを付けるようにしました。</p>
<p>例えば <code>[PATCH 09 of 14] Proxy: add &quot;proxy_ssl_alpn&quot; directive</code> は以下のようになっています。</p>
<div class="highlight"><pre><span></span># HG changeset patch
# User Piotr Sikora &lt;piotrsikora at google.com&gt;
# Date 1489621682 25200
#      Wed Mar 15 16:48:02 2017 -0700
# Node ID 96075d4cd2a6e8bd67caf1d7b78f8e87d757c48d
# Parent  154ca6c5e62a1931a616e9f2b99ef2553b7c2c8b
Proxy: add &quot;proxy_ssl_alpn&quot; directive.

ALPN is used here only to indicate which version of the HTTP protocol
is going to be used and we doesn&#39;t verify that upstream agreed to it.

Please note that upstream is allowed to reject SSL connection with a
fatal &quot;no_application_protocol&quot; alert if it doesn&#39;t support it.

Signed-off-by: Piotr Sikora &lt;piotrsikora at google.com&gt;

diff -r 154ca6c5e62a -r 96075d4cd2a6 src/event/ngx_event_openssl.c
…(略)…
</pre></div>
<p>これは以下の内容で <code>~/nginx.org-deb/ngx_http_v2_upstream-patches/</code> ディレクトリに
<code>ngx_http_v2_upstream-09-of-14.diff</code> というファイル名で保存しました。</p>
<div class="highlight"><pre><span></span>Subject: Proxy: add &quot;proxy_ssl_alpn&quot; directive
Description: ALPN is used here only to indicate which version of the HTTP protocol
 is going to be used and we doesn&#39;t verify that upstream agreed to it.
 .
 Please note that upstream is allowed to reject SSL connection with a
 fatal &quot;no_application_protocol&quot; alert if it doesn&#39;t support it.
Author: Piotr Sikora &lt;piotrsikora at google.com&gt;
Origin: http://mailman.nginx.org/pipermail/nginx-devel/2017-June/010217.html

diff -r 154ca6c5e62a -r 96075d4cd2a6 src/event/ngx_event_openssl.c
…(略)…
</pre></div>
<p>変更内容は以下の通りです。</p>
<ul class="simple">
<li>最後の <code>#</code> の行の次の行を <code>Subject</code> にしました。</li>
<li><code>Signed-off-by</code> の値を <code>Author</code> にしました。実際は :code:` at ` を <code>&#64;</code> に置き換えて保存しています。</li>
<li>そしてその間の部分を <code>Description</code> にしました。継続行はスペース1つでインデントし、空行は :code:` .` にします。間の部分がない場合は <code>Description</code> ヘッダを省略します。</li>
<li>最後に上記のパッチのメーリングリストでのアーカイブのURLを <code>Origin</code> にしました。 <code>#</code> のコメントの先頭行にHG (Mercurial)のchangeset patchと書いてあるので、それの公開URLがあればそちらにしたほうが良いと思いますが、不明なのでこれで良しとしました。</li>
</ul>
</div>
<div class="section" id="git">
<h2>ソースパッケージをインポートしてgitレポジトリを作成</h2>
<p>レポジトリのディレクトリは <code>~/.ghq/github.com/hnakamur/nginx-deb</code> にしたいので、その親ディレクトリの <code>~/.ghq/github.com/hnakamur</code> に移動してインポートします。</p>
<div class="highlight"><pre><span></span><span class="go">cd ~/.ghq/github.com/hnakamur</span>
<span class="go">gbp import-dsc --pristine-tar ~/nginx.org-deb/nginx-1.13.3-deb/nginx_1.13.3-1~xenial.dsc</span>
</pre></div>
<p><code>~/.ghq/github.com/hnakamur/nginx</code> ディレクトリが作られるので
<code>~/.ghq/github.com/hnakamur/nginx-deb</code> にリネームしてそこに移動します。</p>
<div class="highlight"><pre><span></span><span class="go">mv nginx nginx-deb</span>
<span class="go">cd !$</span>
</pre></div>
</div>
<div class="section" id="dquilt">
<h2>dquiltでパッチをインポート</h2>
<p><code>quilt</code> の使い方については以下の2つの記事が参考になりました。</p>
<ul class="simple">
<li><a class="reference external" href="https://raphaelhertzog.com/2012/08/08/how-to-use-quilt-to-manage-patches-in-debian-packages/">How to use quilt to manage patches in Debian packages</a></li>
<li><a class="reference external" href="http://www.geocities.jp/xsybr354/debian/devel-notes/quilt.txt">www.geocities.jp/xsybr354/debian/devel-notes/quilt.txt</a></li>
</ul>
<p>「git-buildpackageでdebパッケージをビルドしてPPAにアップロードする手順」の記事で書いたように <code>dquilt</code> というエイリアスを登録していますので、 <code>quilt</code> の代わりに <code>dquilt</code> を使って同様に実行していきます。</p>
<p>以下のコマンドで14個のパッチをインポートします。パッチはスタックとして管理されるので14番のパッチから1番のパッチへと逆順にインポートしています。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> <span class="k">for</span> i in <span class="o">{</span><span class="m">14</span>..01<span class="o">}</span><span class="p">;</span> <span class="k">do</span> dquilt import ~/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-<span class="nv">$i</span>-of-14.diff<span class="p">;</span> <span class="k">done</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-14-of-14.diff (stored as ngx_http_v2_upstream-14-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-13-of-14.diff (stored as ngx_http_v2_upstream-13-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-12-of-14.diff (stored as ngx_http_v2_upstream-12-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-11-of-14.diff (stored as ngx_http_v2_upstream-11-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-10-of-14.diff (stored as ngx_http_v2_upstream-10-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-09-of-14.diff (stored as ngx_http_v2_upstream-09-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-08-of-14.diff (stored as ngx_http_v2_upstream-08-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-07-of-14.diff (stored as ngx_http_v2_upstream-07-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-06-of-14.diff (stored as ngx_http_v2_upstream-06-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-05-of-14.diff (stored as ngx_http_v2_upstream-05-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-04-of-14.diff (stored as ngx_http_v2_upstream-04-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-03-of-14.diff (stored as ngx_http_v2_upstream-03-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-02-of-14.diff (stored as ngx_http_v2_upstream-02-of-14.diff)</span>
<span class="go">Importing patch /home/hnakamur/nginx.org-deb/ngx_http_v2_upstream-patches/ngx_http_v2_upstream-01-of-14.diff (stored as ngx_http_v2_upstream-01-of-14.diff)</span>
</pre></div>
<p><code>debian/patches/</code> ディレクトリを <code>ls</code> で見るとパッチファイルと <code>series</code> ファイルが作られています。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> ls debian/patches/
<span class="go">ngx_http_v2_upstream-01-of-14.diff  ngx_http_v2_upstream-06-of-14.diff  ngx_http_v2_upstream-11-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-02-of-14.diff  ngx_http_v2_upstream-07-of-14.diff  ngx_http_v2_upstream-12-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-03-of-14.diff  ngx_http_v2_upstream-08-of-14.diff  ngx_http_v2_upstream-13-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-04-of-14.diff  ngx_http_v2_upstream-09-of-14.diff  ngx_http_v2_upstream-14-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-05-of-14.diff  ngx_http_v2_upstream-10-of-14.diff  series</span>
</pre></div>
<p><code>dquilt series</code> コマンドを実行して今取り込んだパッチが1番から14番の順に表示されることを確認します。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt series
<span class="go">ngx_http_v2_upstream-01-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-02-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-03-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-04-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-05-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-06-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-07-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-08-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-09-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-10-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-11-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-12-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-13-of-14.diff</span>
<span class="go">ngx_http_v2_upstream-14-of-14.diff</span>
</pre></div>
<p>なお、ここで逆順になってしまっても、少なくともこの時点であれば <code>debian/patches/series</code> を編集して順序を入れ替えれば大丈夫でした。一部のパッチを適用した後は試してないです。</p>
<p><code>dquilt next</code> で次のパッチが1番目のパッチであることを確認して、 <code>dquilt push</code> でパッチを適用します。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt next
<span class="go">ngx_http_v2_upstream-01-of-14.diff</span>
<span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt push
<span class="go">Applying patch ngx_http_v2_upstream-01-of-14.diff</span>
<span class="go">patching file src/core/ngx_output_chain.c</span>

<span class="go">Now at patch ngx_http_v2_upstream-01-of-14.diff</span>
</pre></div>
<p>gitレポジトリの状態を確認します。ここでは省略しますが <code>git diff</code> で差分も見てみました。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> git status -sb
<span class="gp">#</span><span class="c1"># master</span>
<span class="go"> M src/core/ngx_output_chain.c</span>
<span class="go"> ?? .pc/</span>
<span class="go"> ?? debian/patches/</span>
</pre></div>
<p><code>.pc/</code> ディレクトリにはパッチの適用状況が管理されています。前回の記事では適用後は消すようにしていましたが、消すと <code>dquilt applied</code> で適用状態を確認したりできなくなることがわかったので今回は残しておくことにしました。この記事では省略しますが、パッチを1つずつ適用するたびに中を見ていくとパッチごとのディレクトリが作られて状態を管理していることがわかります。</p>
<p>同様にして順次パッチを適用していきます。</p>
<p>8番目のパッチを適用しようとすると一部当たらずエラーになりました。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt next
<span class="go">ngx_http_v2_upstream-08-of-14.diff</span>
<span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt push
<span class="go">Applying patch ngx_http_v2_upstream-08-of-14.diff</span>
<span class="go">patching file auto/modules</span>
<span class="go">patching file src/core/ngx_connection.h</span>
<span class="go">patching file src/http/ngx_http_upstream.c</span>
<span class="go">Hunk #2 succeeded at 190 (offset 2 lines).</span>
<span class="go">Hunk #3 succeeded at 1523 (offset 7 lines).</span>
<span class="go">Hunk #4 succeeded at 1558 (offset 7 lines).</span>
<span class="go">Hunk #5 succeeded at 1626 (offset 7 lines).</span>
<span class="go">Hunk #6 succeeded at 1649 (offset 7 lines).</span>
<span class="go">Hunk #7 FAILED at 1742.</span>
<span class="go">Hunk #8 succeeded at 1878 (offset 15 lines).</span>
<span class="go">Hunk #9 succeeded at 2017 (offset 15 lines).</span>
<span class="go">Hunk #10 succeeded at 2219 (offset 15 lines).</span>
<span class="go">Hunk #11 succeeded at 2282 (offset 15 lines).</span>
<span class="go">Hunk #12 succeeded at 2400 (offset 15 lines).</span>
<span class="go">Hunk #13 succeeded at 2436 (offset 15 lines).</span>
<span class="go">Hunk #14 succeeded at 2684 (offset 15 lines).</span>
<span class="go">Hunk #15 succeeded at 4192 (offset 15 lines).</span>
<span class="go">Hunk #16 succeeded at 4373 (offset 15 lines).</span>
<span class="go">1 out of 16 hunks FAILED -- rejects in file src/http/ngx_http_upstream.c</span>
<span class="go">patching file src/http/ngx_http_upstream.h</span>
<span class="go">patching file src/http/v2/ngx_http_v2.c</span>
<span class="go">patching file src/http/v2/ngx_http_v2.h</span>
<span class="go">patching file src/http/v2/ngx_http_v2_filter_module.c</span>
<span class="go">patching file src/http/v2/ngx_http_v2_module.c</span>
<span class="go">patching file src/http/v2/ngx_http_v2_upstream.c</span>
<span class="go">Patch ngx_http_v2_upstream-08-of-14.diff does not apply (enforce with -f)</span>
</pre></div>
<p>メッセージの最後に書かれているように <code>-f</code> をつけて <code>dquilt push -f</code> を実行して強制的に適用します。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt push -f
<span class="go">Applying patch ngx_http_v2_upstream-08-of-14.diff</span>
<span class="go">patching file auto/modules</span>
<span class="go">patching file src/core/ngx_connection.h</span>
<span class="go">patching file src/http/ngx_http_upstream.c</span>
<span class="go">Hunk #2 succeeded at 190 (offset 2 lines).</span>
<span class="go">Hunk #3 succeeded at 1523 (offset 7 lines).</span>
<span class="go">Hunk #4 succeeded at 1558 (offset 7 lines).</span>
<span class="go">Hunk #5 succeeded at 1626 (offset 7 lines).</span>
<span class="go">Hunk #6 succeeded at 1649 (offset 7 lines).</span>
<span class="go">Hunk #7 FAILED at 1742.</span>
<span class="go">Hunk #8 succeeded at 1878 (offset 15 lines).</span>
<span class="go">Hunk #9 succeeded at 2017 (offset 15 lines).</span>
<span class="go">Hunk #10 succeeded at 2219 (offset 15 lines).</span>
<span class="go">Hunk #11 succeeded at 2282 (offset 15 lines).</span>
<span class="go">Hunk #12 succeeded at 2400 (offset 15 lines).</span>
<span class="go">Hunk #13 succeeded at 2436 (offset 15 lines).</span>
<span class="go">Hunk #14 succeeded at 2684 (offset 15 lines).</span>
<span class="go">Hunk #15 succeeded at 4192 (offset 15 lines).</span>
<span class="go">Hunk #16 succeeded at 4373 (offset 15 lines).</span>
<span class="go">1 out of 16 hunks FAILED -- saving rejects to file src/http/ngx_http_upstream.c.rej</span>
<span class="go">patching file src/http/ngx_http_upstream.h</span>
<span class="go">patching file src/http/v2/ngx_http_v2.c</span>
<span class="go">patching file src/http/v2/ngx_http_v2.h</span>
<span class="go">patching file src/http/v2/ngx_http_v2_filter_module.c</span>
<span class="go">patching file src/http/v2/ngx_http_v2_module.c</span>
<span class="go">patching file src/http/v2/ngx_http_v2_upstream.c</span>
<span class="go">Applied patch ngx_http_v2_upstream-08-of-14.diff (forced; needs refresh)</span>
</pre></div>
<p><code>src/http/ngx_http_upstream.c.rej</code> を確認すると以下のような内容でした。</p>
<div class="highlight"><pre><span></span>--- src/http/ngx_http_upstream.c
+++ src/http/ngx_http_upstream.c
@@ -1742,6 +1775,16 @@ ngx_http_upstream_ssl_handshake(ngx_conn
                 c-&gt;write-&gt;handler = ngx_http_upstream_handler;
                 c-&gt;read-&gt;handler = ngx_http_upstream_handler;

+#if (NGX_HTTP_V2)
+
+        if (u-&gt;http2 &amp;&amp; u-&gt;stream == NULL) {
+            if (ngx_http_upstream_v2_init_connection(r, u, c) != NGX_OK) {
+                return;
+            }
+        }
+
+#endif
+
                 c = r-&gt;connection;

                 ngx_http_upstream_send_request(r, u, 1);
</pre></div>
<p><code>src/http/ngx_http_upstream.c</code> の1742行付近を見た感じ、1769行目の前に入れればよさそうな雰囲気です。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1736
1737
1738
1739
1740
1741
1742
1743
1744
1745
1746
1747
1748
1749
1750
1751
1752
1753
1754
1755
1756
1757
1758
1759
1760
1761
1762
1763
1764
1765
1766
1767
1768
1769
1770
1771
1772
1773
1774
1775
1776
1777
1778
1779
1780
1781
1782</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    static void
    ngx_http_upstream_ssl_handshake(ngx_http_request_t *r, ngx_http_upstream_t *u,
            ngx_connection_t *c)
    {
            long  rc;

            if (c-&gt;ssl-&gt;handshaked) {

                    if (u-&gt;conf-&gt;ssl_verify) {
                            rc = SSL_get_verify_result(c-&gt;ssl-&gt;connection);

                            if (rc != X509_V_OK) {
                                    ngx_log_error(NGX_LOG_ERR, c-&gt;log, 0,
                                                              &quot;upstream SSL certificate verify error: (%l:%s)&quot;,
                                                              rc, X509_verify_cert_error_string(rc));
                                    goto failed;
                            }

                            if (ngx_ssl_check_host(c, &amp;u-&gt;ssl_name) != NGX_OK) {
                                    ngx_log_error(NGX_LOG_ERR, c-&gt;log, 0,
                                                              &quot;upstream SSL certificate does not match \&quot;%V\&quot;&quot;,
                                                              &amp;u-&gt;ssl_name);
                                    goto failed;
                            }
                    }

                    if (u-&gt;conf-&gt;ssl_session_reuse) {
                            u-&gt;peer.save_session(&amp;u-&gt;peer, u-&gt;peer.data);
                    }

                    c-&gt;write-&gt;handler = ngx_http_upstream_handler;
                    c-&gt;read-&gt;handler = ngx_http_upstream_handler;

                    ngx_http_upstream_send_request(r, u, 1);

                    return;
            }

            if (c-&gt;write-&gt;timedout) {
                    ngx_http_upstream_next(r, u, NGX_HTTP_UPSTREAM_FT_TIMEOUT);
                    return;
            }

    failed:

            ngx_http_upstream_next(r, u, NGX_HTTP_UPSTREAM_FT_ERROR);
    }
</pre></div>
</td></tr></table><p>編集後、 <code>dquilt refresh</code> でパッチを更新します。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt refresh
<span class="go">Refreshed patch ngx_http_v2_upstream-08-of-14.diff</span>
</pre></div>
<p>11番目のパッチは全く当たりませんでした。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt push
<span class="go">Applying patch ngx_http_v2_upstream-11-of-14.diff</span>
<span class="go">patching file src/http/modules/ngx_http_proxy_module.c</span>
<span class="go">Hunk #1 FAILED at 1151.</span>
<span class="go">Hunk #2 FAILED at 1265.</span>
<span class="go">Hunk #3 FAILED at 1369.</span>
<span class="go">Hunk #4 FAILED at 3528.</span>
<span class="go">4 out of 4 hunks FAILED -- rejects in file src/http/modules/ngx_http_proxy_module.c</span>
</pre></div>
<p><code>-f</code> を付けて再実行し強制的に適用します。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt push -f
<span class="go">Applying patch ngx_http_v2_upstream-11-of-14.diff</span>
<span class="go">patching file src/http/modules/ngx_http_proxy_module.c</span>
<span class="go">Hunk #1 FAILED at 1151.</span>
<span class="go">Hunk #2 FAILED at 1265.</span>
<span class="go">Hunk #3 FAILED at 1369.</span>
<span class="go">Hunk #4 FAILED at 3528.</span>
<span class="go">4 out of 4 hunks FAILED -- saving rejects to file src/http/modules/ngx_http_proxy_module.c.rej</span>
<span class="go">Applied patch ngx_http_v2_upstream-11-of-14.diff (forced; needs refresh)</span>

<span class="go">        Patch ngx_http_v2_upstream-11-of-14.diff does not apply (enforce with -f)</span>
</pre></div>
<p><code>src/http/modules/ngx_http_proxy_module.c.rej</code> と <code>src/http/modules/ngx_http_proxy_module.c</code> を見比べてみると、多少変更されていますがパッチが当たらなかった内容と等価なものは全て含まれていました。</p>
<p>おそらくコードに変更を加えた上で別途既に取り込まれていたようです。</p>
<p>ということで11番目のパッチは削除します。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt delete -r debian/patches/ngx_http_v2_upstream-11-of-14.d
<span class="go">iff</span>
<span class="go">Removing patch ngx_http_v2_upstream-11-of-14.diff</span>
<span class="go">Now at patch ngx_http_v2_upstream-10-of-14.diff</span>
<span class="go">Removed patch ngx_http_v2_upstream-11-of-14.diff</span>
</pre></div>
<p>12番目のパッチを適用します。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt next
<span class="go">ngx_http_v2_upstream-12-of-14.diff</span>
<span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> dquilt push
<span class="go">Applying patch ngx_http_v2_upstream-12-of-14.diff</span>
<span class="go">patching file src/http/modules/ngx_http_proxy_module.c</span>
<span class="go">patching file src/http/v2/ngx_http_v2.h</span>
<span class="go">patching file src/http/v2/ngx_http_v2_filter_module.c</span>

<span class="go">Now at patch ngx_http_v2_upstream-12-of-14.diff</span>
</pre></div>
<p>あとは同様にして最後の14番目のパッチまで適用しました。</p>
<p>gitレポジトリの状態は以下のようになっていました。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> git status -sb
<span class="gp">#</span><span class="c1"># master</span>
<span class="go"> M auto/modules</span>
<span class="go"> M src/core/ngx_connection.h</span>
<span class="go"> M src/core/ngx_output_chain.c</span>
<span class="go"> M src/event/ngx_event_openssl.c</span>
<span class="go"> M src/event/ngx_event_openssl.h</span>
<span class="go"> M src/http/modules/ngx_http_fastcgi_module.c</span>
<span class="go"> M src/http/modules/ngx_http_memcached_module.c</span>
<span class="go"> M src/http/modules/ngx_http_proxy_module.c</span>
<span class="go"> M src/http/modules/ngx_http_scgi_module.c</span>
<span class="go"> M src/http/modules/ngx_http_ssl_module.c</span>
<span class="go"> M src/http/modules/ngx_http_upstream_keepalive_module.c</span>
<span class="go"> M src/http/modules/ngx_http_uwsgi_module.c</span>
<span class="go"> M src/http/ngx_http.h</span>
<span class="go"> M src/http/ngx_http_cache.h</span>
<span class="go"> M src/http/ngx_http_file_cache.c</span>
<span class="go"> M src/http/ngx_http_upstream.c</span>
<span class="go"> M src/http/ngx_http_upstream.h</span>
<span class="go"> M src/http/v2/ngx_http_v2.c</span>
<span class="go"> M src/http/v2/ngx_http_v2.h</span>
<span class="go"> M src/http/v2/ngx_http_v2_filter_module.c</span>
<span class="go"> M src/http/v2/ngx_http_v2_module.c</span>
<span class="go"> M src/http/v2/ngx_http_v2_table.c</span>
<span class="go">?? .pc/</span>
<span class="go">?? debian/patches/</span>
<span class="go">?? src/http/modules/ngx_http_proxy_module.c.rej</span>
<span class="go">?? src/http/ngx_http_upstream.c.rej</span>
<span class="go">?? src/http/v2/ngx_http_v2_upstream.c</span>
</pre></div>
<p><code>*.rej</code> ファイルは削除してから、コミットします。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> find . -name <span class="s1">&#39;*.rej&#39;</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
<span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s1">&#39;Apply ngx_http_v2_upstream patches&#39;</span>
</pre></div>
</div>
<div class="section" id="debian-changelog">
<h2>debian/changelogの編集</h2>
<p>以下のコマンドを実行して <code>debian/changelog</code> を編集します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gbp dch --release
</pre></div>
<p>エディタが起動されて、ファイルの先頭は以下のようになっていました。</p>
<div class="highlight"><pre><span></span>nginx (1.13.3-1~xenialubuntu1) xenial; urgency=medium

  * Apply ngx_http_v2_upstream patches

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Fri, 14 Jul 2017 09:35:07 +0900

nginx (1.13.3-1~xenial) xenial; urgency=low
</pre></div>
<p>バージョンで <code>xenial</code> と <code>ubuntu1</code> がくっついているのは良くないのと、公式パッケージではなくPPAなので、
バージョンを <code>1.13.3-1~xenial1ppa1</code> を書き換えて保存してエディタを終了しました。</p>
<p>gitレポジトリの状態を確認し、 <code>debian/changelog</code> をコミットします。</p>
<div class="highlight"><pre><span></span><span class="gp">hnakamur@express:~/.ghq/github.com/hnakamur/nginx-deb$</span> git status -sb
<span class="gp">#</span><span class="c1"># master</span>
<span class="go"> M debian/changelog</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="gp">$</span> git commit -m <span class="s1">&#39;Release 1.13.3-1~xenial1ppa1&#39;</span> debian/changelog
</pre></div>
</div>
<div class="section" id="id3">
<h2>ソースパッケージのビルド</h2>
<p>ソースパッケージのビルドですが、今回はupstreamのソースに対してdfsg対応の修正は加えておらずそのままなので <code>--git-pristine-tar-commit</code> オプションは指定せず以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span><span class="go">gbp buildpackage --git-export-dir=../build-area -S -sa</span>
</pre></div>
<p>gpgのパスフレーズを2回聞かれるので入力します。</p>
</div>
<div class="section" id="id4">
<h2>バイナリパッケージのビルド</h2>
<p>以下のコマンドでバイナリパッケージをビルドします。</p>
<div class="highlight"><pre><span></span><span class="go">sudo pbuilder build ../build-area/nginx_1.13.3-1~xenial1ppa1.dsc</span>
</pre></div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>