<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.89.4" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>git-buildpackageでdebパッケージをビルドしてPPAにアップロードする手順 &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>git-buildpackageでdebパッケージをビルドしてPPAにアップロードする手順</h1>
  <time datetime=2017-07-05T21:04:00&#43;0900 class="post-date">2017-07-05</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#まず読む参考文献">まず読む参考文献</a></li>
    <li><a href="#使用するツールの選択">使用するツールの選択</a></li>
    <li><a href="#事前準備">事前準備</a>
      <ul>
        <li><a href="#gpgで秘密鍵作成">gpgで秘密鍵作成</a></li>
        <li><a href="#gpgの設定追加">gpgの設定追加</a></li>
        <li><a href="#必要なパッケージのインストール">必要なパッケージのインストール</a></li>
        <li><a href="#pbuilderで使うchroot環境作成">pbuilderで使うchroot環境作成</a></li>
        <li><a href="#quiltのセットアップ">quiltのセットアップ</a></li>
        <li><a href="#ppaのアカウント作成">PPAのアカウント作成</a></li>
      </ul>
    </li>
    <li><a href="#既存のdebパッケージのソースを取得">既存のdebパッケージのソースを取得</a></li>
    <li><a href="#debパッケージのgitレポジトリを作成">debパッケージのgitレポジトリを作成</a>
      <ul>
        <li><a href="#debパッケージ用にgitレポジトリを分けて管理する理由">debパッケージ用にgitレポジトリを分けて管理する理由</a></li>
        <li><a href="#upstreamのソースをインポートしてdebパッケージのgitレポジトリを作成">upstreamのソースをインポートしてdebパッケージのgitレポジトリを作成</a></li>
      </ul>
    </li>
    <li><a href="#luajitのgitレポジトリをクローンしてバージョン205のソースを準備">luajitのgitレポジトリをクローンしてバージョン2.0.5のソースを準備</a></li>
    <li><a href="#luajitバージョン205のソースをインポート">luajitバージョン2.0.5のソースをインポート</a>
      <ul>
        <li><a href="#debパッケージのdfsg対応">debパッケージのDFSG対応</a></li>
        <li><a href="#dfsgクリーンでないupstreamのソースのインポート">DFSGクリーンでないupstreamのソースのインポート</a></li>
      </ul>
    </li>
    <li><a href="#dquiltでパッチファイルを更新">dquiltでパッチファイルを更新</a>
      <ul>
        <li><a href="#debパッケージでのパッチファイルのファイル構成">debパッケージでのパッチファイルのファイル構成</a></li>
        <li><a href="#dquiltでのパッチの更新">dquiltでのパッチの更新</a></li>
      </ul>
    </li>
    <li><a href="#debianchangelogの更新">debian/changelogの更新</a></li>
    <li><a href="#ソースパッケージのビルド">ソースパッケージのビルド</a></li>
    <li><a href="#バイナリパッケージのビルド">バイナリパッケージのビルド</a></li>
    <li><a href="#ソースパッケージをppaにアップロード">ソースパッケージをPPAにアップロード</a>
      <ul>
        <li><a href="#ppaの作成とアクティベート">PPAの作成とアクティベート</a></li>
        <li><a href="#ソースパッケージのアップロード">ソースパッケージのアップロード</a></li>
        <li><a href="#アップロード受付結果のメール確認">アップロード受付結果のメール確認</a></li>
        <li><a href="#ビルド経過の確認">ビルド経過の確認</a></li>
      </ul>
    </li>
    <li><a href="#注意パッケージを消して同じバージョンで上げ直すことは出来ません">注意：パッケージを消して同じバージョンで上げ直すことは出来ません</a>
      <ul>
        <li><a href="#今回の回避策">今回の回避策</a></li>
      </ul>
    </li>
    <li><a href="#ビルドされたパッケージを他の環境にインストールしてみる">ビルドされたパッケージを他の環境にインストールしてみる</a></li>
    <li><a href="#新しいリリースのタグ作成">新しいリリースのタグ作成</a></li>
    <li><a href="#おわりに">おわりに</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="https://honk.sigxcpu.org/piki/projects/git-buildpackage/">git-buildpackage</a> を使ってカスタムdebパッケージをビルドして <a href="https://launchpad.net/ubuntu/+ppas">Personal Package Archives : Ubuntu</a> (PPA) にアップロードする手順のメモです。</p>
<p>自分で試行錯誤してまとめた手順なので、他のニーズには合わなかったり、改善の余地があるかもしれません。</p>
<p>UbuntuのLTS (Long Time Support)版を使うにあたって、古いdebパッケージをアップデートしてPPAにアップデートするのが主な用途です。</p>
<p>ということで以下では Ubuntu 16.04 (xenial) で提供されている luajit 2.0.4 を2.0.5にアップデートしてPPAにアップロードする例で説明します。</p>
<h2 id="まず読む参考文献">まず読む参考文献</h2>
<p>debパッケージ作成についての文書はたくさんあるのですが、
<a href="https://www.debian.org/doc/devel-manuals#packaging-tutorial">Debian 開発者向けマニュアル</a> が概要を把握するのに役立ちました。</p>
<p>次に <a href="https://www.debian.org/doc/devel-manuals#maint-guide">Debian 新メンテナガイド</a> を見ました。といってもどちらも斜め読みです。</p>
<h2 id="使用するツールの選択">使用するツールの選択</h2>
<p>debパッケージをビルドするツールも多数あるのですが、
<a href="https://www.debian.org/doc/manuals/maint-guide/build.ja.html#git-buildpackage">git-buildpackageコマンドとその仲間</a> でお勧めされていた git-buildpackage_ を使うことにしました。</p>
<p><a href="http://honk.sigxcpu.org/projects/git-buildpackage/manual-html/gbp.html">Building Debian Packages with git-buildpackage</a> を読んで試行錯誤した結果、以下のツールを使う手順にひとまず落ち着きました。</p>
<ul>
<li>git-buildpackage_: gitでdebパッケージのソースを管理してビルドするための支援ツール</li>
<li><a href="http://savannah.nongnu.org/projects/quilt">Quilt</a>: パッチ管理ツール。</li>
<li>pbuilder (personal builder): chrootでクリーンな環境でdebパッケージをビルドするためのツール。</li>
<li>dput: debのソースパッケージをPPAにアップロードするツール</li>
</ul>
<h2 id="事前準備">事前準備</h2>
<h3 id="gpgで秘密鍵作成">gpgで秘密鍵作成</h3>
<p>PPAにdebパッケージをアップロードするにはdebソースパッケージに署名する必要があるので <a href="https://hnakamur.github.io/blog/2017/07/01/generate-secret-key-with-gpg/">gpgで秘密鍵を作成する</a> の手順で秘密鍵を生成しておきます。</p>
<h3 id="gpgの設定追加">gpgの設定追加</h3>
<p><a href="https://askubuntu.com/questions/186329/how-to-automate-the-pass-phrases-when-gpg-signing-dpkg-buildpackage/186359#186359">packaging - How to automate the pass phrases when GPG signing dpkg-buildpackage? - Ask Ubuntu</a>
を参考にして <code>~/.bash_profile</code> に以下のような設定を追加しました。
<code>DEBFULLNAME</code> 、 <code>DEBEMAIL</code> 、 <code>GPGKEY</code> 環境変数の値は、適宜自分のものに書き換えてください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"># http://manpages.ubuntu.com/manpages/precise/en/man1/dch.1.html
export DEBFULLNAME=&#34;Hiroaki Nakamura&#34;
export DEBEMAIL=&#34;hnakamur@gmail.com&#34;

# https://askubuntu.com/questions/186329/how-to-automate-the-pass-phrases-when-gpg-signing-dpkg-buildpackage
export GPGKEY=0x1DFBC664
</code></pre></div><p>Ubuntuでは <code>~/.bash_profile</code> が存在すると <code>~/.bashrc</code> が読まれないようなので、以下のようなコードを
<code>~/.bash_profile</code> に追加しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">if [ -f ~/.bashrc ]; then
    . ~/.bashrc
fi
</code></pre></div><p>ログインし直すか以下のコマンドを実行して、上記の設定を反映します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">exec $SHELL -l
</span></code></pre></div><h3 id="必要なパッケージのインストール">必要なパッケージのインストール</h3>
<p>次に Ubuntu 16.04 xenialで以下のコマンドを実行して必要なツールをインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">sudo apt install git-buildpackage quilt pbuilder debootstrap devscripts dput debhelper
</span></code></pre></div><p>2018-03-20 追記 debhelper も必要だったので上記に追記しました。</p>
<h3 id="pbuilderで使うchroot環境作成">pbuilderで使うchroot環境作成</h3>
<p><a href="https://wiki.ubuntu.com/PbuilderHowto">PbuilderHowto - Ubuntu Wiki</a> と <a href="http://manpages.ubuntu.com/manpages/xenial/en/man8/pbuilder.8.html">Ubuntu Manpage: pbuilder - personal package builder</a> を参考に、以下のコマンドでdebパッケージビルド用のchroot環境のtarballを作成します。</p>
<p><code>--components</code> オプションで <code>main</code> に加えて <code>universe</code> も指定しているのはビルド時に必要となる <code>quilt</code> が <code>main</code> ではなく <code>universe</code> に含まれるからです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">sudo pbuilder create --components &#39;main universe&#39; --debootstrapopts --variant=buildd
</span></code></pre></div><h3 id="quiltのセットアップ">quiltのセットアップ</h3>
<p><a href="https://www.debian.org/doc/manuals/maint-guide/modify.ja.html#quiltrc">quilt のセットアップ</a> の手順に沿ってdebパッケージビルド用にquiltの設定を追加し、 <code>dquilt</code> というエイリアスを登録します。</p>
<p><code>~/.bashrc</code> に以下の2行を追加します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">alias dquilt=&#34;quilt --quiltrc=${HOME}/.quiltrc-dpkg&#34;
complete -F _quilt_completion -o filenames dquilt
</code></pre></div><p>以下の内容で <code>~/.quiltrc-dpkg</code> ファイルを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">d=. ; while [ ! -d $d/debian -a `readlink -e $d` != / ]; do d=$d/..; done
if [ -d $d/debian ] &amp;&amp; [ -z $QUILT_PATCHES ]; then
    # if in Debian packaging tree with unset $QUILT_PATCHES
    QUILT_PATCHES=&#34;debian/patches&#34;
    QUILT_PATCH_OPTS=&#34;--reject-format=unified&#34;
    QUILT_DIFF_ARGS=&#34;-p ab --no-timestamps --no-index --color=auto&#34;
    QUILT_REFRESH_ARGS=&#34;-p ab --no-timestamps --no-index&#34;
    QUILT_COLORS=&#34;diff_hdr=1;32:diff_add=1;34:diff_rem=1;31:diff_hunk=1;33:diff_ctx=35:diff_cctx=33&#34;
    if ! [ -d $d/debian/patches ]; then mkdir $d/debian/patches; fi
fi
</code></pre></div><h3 id="ppaのアカウント作成">PPAのアカウント作成</h3>
<p>その前に、なぜPPAでdebパッケージをビルド・配布することにしたかですが、これは
<a href="http://www.clear-code.com/blog/2014/6/10.html">Launchpadを利用してパッケージを公開するには - ククログ(2014-06-10)</a>
の記事を読んで、私の場合もデメリットよりメリットが大きいと思ったからです。</p>
<p>この記事の「最初にする作業」の「Launchpadへのユーザー登録」から「PPAの登録」までを行ってください。「dputの設定」の設定は不要です。なお、私自身はLaunchPadへのユーザ登録は11年前にしていて今回登録手順は確認しておらず、この記事も3年前なので、今の手順は多少変わっているかもしれません。</p>
<p>うまくいかない場合は
<a href="https://help.launchpad.net/YourAccount/NewAccount">YourAccount/NewAccount - Launchpad Help</a>
や
<a href="https://help.launchpad.net/YourAccount/ImportingYourPGPKey">YourAccount/ImportingYourPGPKey - Launchpad Help</a>
などで手順を確認して登録を行ってください。</p>
<p>PPA (Personal Package Archive) についての公式な説明は
<a href="https://help.launchpad.net/Packaging/PPA">Packaging/PPA - Launchpad Help</a>
にあります。</p>
<h2 id="既存のdebパッケージのソースを取得">既存のdebパッケージのソースを取得</h2>
<p><code>/etc/apt/sources.list</code> に以下のように <code>deb-src</code> の行があるか確認します。私の環境では対応する <code>deb</code> の行の下にばらけて書かれていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">deb-src http://jp.archive.ubuntu.com/ubuntu/ xenial main restricted
deb-src http://jp.archive.ubuntu.com/ubuntu/ xenial-updates main restricted
deb-src http://jp.archive.ubuntu.com/ubuntu/ xenial universe
deb-src http://jp.archive.ubuntu.com/ubuntu/ xenial-updates universe
</code></pre></div><p><code>deb-src</code> の行がない場合は <code>/etc/apt/sources.list</code> に追記するか <code>/etc/apt/sources.list.d/</code> ディレクトリに <code>src.list</code> のように拡張子 <code>.list</code> のファイルを作成して、 <code>sudo apt update</code> コマンドを実行します。</p>
<p>作業用のディレクトリを作成してそこに移動します。以下では <code>~/deb-tutorial/luajit</code> を作業ディレクトリとします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">mkdir -p ~/deb-tutorial/luajit
</span><span class="go">cd !$
</span></code></pre></div><p>以下のコマンドを実行して <code>luajit</code> のdebソースパッケージをダウンロードします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">apt source luajit
</span></code></pre></div><p>以下のような1つのディレクトリと3つのファイルが作成されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ls -F
<span class="go">luajit-2.0.4+dfsg/  luajit_2.0.4+dfsg-1.debian.tar.xz  luajit_2.0.4+dfsg-1.dsc  luajit_2.0.4+dfsg.orig.tar.gz
</span></code></pre></div><h2 id="debパッケージのgitレポジトリを作成">debパッケージのgitレポジトリを作成</h2>
<h3 id="debパッケージ用にgitレポジトリを分けて管理する理由">debパッケージ用にgitレポジトリを分けて管理する理由</h3>
<p>当初はupstreamであるluajitのgitレポジトリにdebパッケージ用のブランチを作って管理しようかと思っていました。</p>
<p>ですが <a href="http://dep.debian.net/">Debian Enhancement Proposals</a> に <a href="http://dep.debian.net/deps/dep14/">DEP-14: Recommended layout for Git packaging repositories</a> という文書があって、なるべくこのgitブランチモデルに合わせたほうが良いかなと思い、 <a href="https://anonscm.debian.org/cgit/">git.debian.org</a> にあるDebianのパッケージのgitレポジトリの実例をいくつか見て合わせることにしました。</p>
<p>それにupstreamのgitコミットログとdebパッケージ用のコミットログが混在するより、debパッケージのgitレポジトリが分かれているほうがdebパッケージのコミットログだけを見やすそうだと思い直しました。</p>
<h3 id="upstreamのソースをインポートしてdebパッケージのgitレポジトリを作成">upstreamのソースをインポートしてdebパッケージのgitレポジトリを作成</h3>
<p><a href="http://honk.sigxcpu.org/projects/git-buildpackage/manual-html/gbp.import.html">Importing Sources</a> の <a href="http://honk.sigxcpu.org/projects/git-buildpackage/manual-html/gbp.import.html#GBP.IMPORT.EXISTING">Importing already existing Debian packages</a> の手順でインポートします。
コマンド名は <code>git-buildpackage</code> の略で <code>gbp</code> となっています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">gbp import-dsc --pristine-tar luajit_2.0.4+dfsg-1.dsc
</span></code></pre></div><p>すると <code>luajit</code> というディレクトリが作成されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ls -F
<span class="go">luajit/  luajit-2.0.4+dfsg/  luajit_2.0.4+dfsg-1.debian.tar.xz  luajit_2.0.4+dfsg-1.dsc  luajit_2.0.4+dfsg.orig.tar.gz
</span></code></pre></div><p><code>luajit</code> という名前のままだと、後で github にdebパッケージのレポジトリを上げるときに upstream の <code>luajit</code> をフォークするときに自分のディレクトリの下で名前が衝突するので <code>luajit-deb</code> に改名してそこに移動します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">mv luajit luajit-deb
</span><span class="go">cd !$
</span></code></pre></div><p><code>master</code> 、 <code>pristine-tar</code> 、 <code>upstream</code> の3つのブランチがあり今は <code>master</code> ブランチにいます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>git branch
<span class="go">* master
</span><span class="go">  pristine-tar
</span><span class="go">  upstream
</span></code></pre></div><p><code>ls -F</code> で見ると luajit のソースに加えてdebパッケージ用の <code>debian/</code> ディレクトリがあることがわかります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ls -F
<span class="go">COPYRIGHT  debian/  dynasm/  etc/  Makefile  README  src/
</span></code></pre></div><h2 id="luajitのgitレポジトリをクローンしてバージョン205のソースを準備">luajitのgitレポジトリをクローンしてバージョン2.0.5のソースを準備</h2>
<p><code>pushd</code> で一旦別のディレクトリに移動して、そちらでluajitのgitレポジトリをクローンし、 <code>v2.0.5</code> のタグに切り替えて <code>~/deb-tutorial/luajit/luajit_2.0.5.orig.tar.gz</code> というtarballを作成し <code>popd</code> で元の作業ディレクトリに戻ります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">pushd ..
</span><span class="go">git clone http://luajit.org/git/luajit-2.0.git
</span><span class="go">cd luajit-2.0
</span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-2.0$ git tag
</span><span class="go">v2.0.0
</span><span class="go">v2.0.0-beta1
</span><span class="go">v2.0.0-beta10
</span><span class="go">v2.0.0-beta11
</span><span class="go">v2.0.0-beta2
</span><span class="go">v2.0.0-beta2-hotfix2
</span><span class="go">v2.0.0-beta3
</span><span class="go">v2.0.0-beta4
</span><span class="go">v2.0.0-beta5
</span><span class="go">v2.0.0-beta6
</span><span class="go">v2.0.0-beta7
</span><span class="go">v2.0.0-beta8
</span><span class="go">v2.0.0-beta8-fixed
</span><span class="go">v2.0.0-beta9
</span><span class="go">v2.0.0-rc1
</span><span class="go">v2.0.0-rc2
</span><span class="go">v2.0.0-rc3
</span><span class="go">v2.0.1
</span><span class="go">v2.0.1-fixed
</span><span class="go">v2.0.2
</span><span class="go">v2.0.3
</span><span class="go">v2.0.4
</span><span class="go">v2.0.5
</span><span class="go">v2.1.0-beta1
</span><span class="go">v2.1.0-beta2
</span><span class="go">v2.1.0-beta3
</span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">git checkout v2.0.5
</span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">git archive --format=tar.gz --prefix=luajit/ -o ../luajit_2.0.5.orig.tar.gz tags/v2.0.5
</span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-2.0$ popd
</span><span class="go">~/deb-tutorial/luajit/luajit-deb
</span></code></pre></div><h2 id="luajitバージョン205のソースをインポート">luajitバージョン2.0.5のソースをインポート</h2>
<h3 id="debパッケージのdfsg対応">debパッケージのDFSG対応</h3>
<p>luajitのdebパッケージのバージョンは <code>2.0.4+dfsg-1</code> のように <code>+dfsg</code> を含んでいます。</p>
<p>DFSGについては <a href="https://www.debian.org/social_contract#guidelines">Debian フリーソフトウェアガイドライン (DFSG)</a> に説明があり、 debパッケージの DFSG 対応については <a href="https://www.debian.org/doc/manuals/maint-guide/first.ja.html#namever">第2章 はじめの一歩</a> に説明があります。</p>
<p>luajitの場合は <code>debian/README.source</code> に具体的な説明があり、 <code>doc/</code> ディレクトリにあるファイルのライセンスが DSFG に合わないので削除してdebパッケージに含めないという対応にしているそうです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ cat debian/README.source
</span><span class="go">The upstream sources contain .css files that do not conform to DFSG, since
</span><span class="go">the following banner prevents their reuse.
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">  /* Copyright (C) 2004-2009 Mike Pall.
</span><span class="go">   *
</span><span class="go">   * You are welcome to use the general ideas of this design for your own
</span><span class="go">   * sites.  But please do not steal the stylesheet, the layout or the
</span><span class="go">   * color scheme.
</span><span class="go">   */
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Moreover the upstream made explicit that .html files (will) be licensed
</span><span class="go">under terms not suitable for Debian:
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">  &gt; If you insist it is unreadable, I can write a simple css to just format
</span><span class="go">  &gt; the page, and make it MIT/X.
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">  The HTML files contain a copyright, too. And I haven&#39;t decided on
</span><span class="go">  a license for them, either. I.e. they are unacceptable for Debian.
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">  Most users search online for the docs, anyway. And the online URL
</span><span class="go">  for the docs is e.g. printed at startup.
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">The sources has been repackaged removing doc/*.
</span></code></pre></div><h3 id="dfsgクリーンでないupstreamのソースのインポート">DFSGクリーンでないupstreamのソースのインポート</h3>
<p><a href="http://honk.sigxcpu.org/projects/git-buildpackage/manual-html/gbp.special.html#GBP.SPECIAL.DFSGFREE">Handling non-DFSG clean upstream sources</a> に沿ってluajitのバージョン2.0.5のソースをインポートしていきます。</p>
<p>まず <code>upstream</code> ブランチから <code>dfsg_clean</code> というブランチを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">git branch dfsg_clean upstream
</span></code></pre></div><p><code>master</code> ブランチに切り替えてから、先程生成した <code>~/deb-tutorial/luajit/luajit_2.0.5.orig.tar.gz</code> をインポートします。
(2018-04-25修正。 <code>gbp import-orig</code> を実行するときは <code>upstream</code> ではなく <code>master</code> ブランチに切り替えておく必要がありました。)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">git checkout master
</span><span class="go">gbp import-orig --no-merge -u 2.0.5 --pristine-tar ~/.ghq/luajit.org/git/luajit_2.0.5.orig.tar.gz
</span></code></pre></div><p>この時点で <code>upstream/2.0.5</code> というタグが追加されています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ git tag
</span><span class="go">debian/2.0.4+dfsg-1
</span><span class="go">upstream/2.0.4+dfsg
</span><span class="go">upstream/2.0.5
</span></code></pre></div><p><code>dfsg_clean</code> ブランチに切り替えて <code>upstream</code> ブランチの内容をマージして取り込みます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">git checkout dfsg_clean
</span><span class="go">git pull . upstream
</span></code></pre></div><p>ディレクトリの内容を確認するとupstreamのソースを取り込んだので <code>doc/</code> ディレクトリが復活しています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ ls -F
</span><span class="go">COPYRIGHT  doc/  dynasm/  etc/  Makefile  README  src/
</span></code></pre></div><p>DFSGクリーンにするため、 <code>doc/</code> ディレクトリを削除してコミットします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">git rm -r doc
</span><span class="go">git commit -m &#34;Make source dfsg clean&#34;
</span></code></pre></div><p>この後 <code>git-buildpackage</code> の <code>gbp</code> コマンドでdebソースパッケージをビルドする際に参照するため <code>upstream/2.0.5+dfsg</code> タグを打っておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">git tag upstream/2.0.5+dfsg
</span></code></pre></div><p><code>upstream</code> ブランチ上ではなく <code>dfsg_clean</code> ブランチ上に <code>upstream/*</code> というタグを打つのは最初混乱したのですが、 <code>gbp</code> コマンドから DFSGクリーンなソースのタグを参照するためにこうする必要があります。（元々DSFGクリーンなパッケージの場合は上記の <code>gbp import-orig</code> を実行した時に作成される <code>upstream/バージョン</code> というタグだけで大丈夫です）。</p>
<p>次に <code>master</code> ブランチに切り替えて <code>dfsg_clean</code> ブランチの内容をマージして取り込みます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">git checkout master
</span><span class="go">git pull . dfsg_clean
</span></code></pre></div><h2 id="dquiltでパッチファイルを更新">dquiltでパッチファイルを更新</h2>
<h3 id="debパッケージでのパッチファイルのファイル構成">debパッケージでのパッチファイルのファイル構成</h3>
<p><code>debian/patches/</code> ディレクトリを見ると以下のように1つのパッチファイルがあります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ ls debian/patches/
</span><span class="go">0001-consider-Hurd-as-a-POSIX-system.patch  series
</span></code></pre></div><p><code>debian/patches/series</code> ファイルにパッチファイル名一覧が書かれています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ cat debian/patches/series
</span><span class="go">0001-consider-Hurd-as-a-POSIX-system.patch
</span></code></pre></div><h3 id="dquiltでのパッチの更新">dquiltでのパッチの更新</h3>
<p><a href="https://www.debian.org/doc/manuals/maint-guide/modify.ja.html#fixupstream">アップストリームのバグを修正する</a> に新規パッチ作成例が書かれていますが、今回は既存のパッチの更新なのでこれとは違います。</p>
<p><code>man quilt</code> やそこで紹介されていた <code>/usr/share/doc/quilt/quilt.pdf</code> を読むべきところですが、 `パッチ管理ツール quilt の使い方](<a href="http://tokyodebian.alioth.debian.org/html/debianmeetingresume200701se7.html.tmp">http://tokyodebian.alioth.debian.org/html/debianmeetingresume200701se7.html.tmp</a>) がわかりやすかったのでお勧めです。</p>
<p>ここでは上記の事前準備に書いたように <code>quilt</code> そのままではなく をカスタマイズしたエイリアス <code>dquilt</code> を利用します。</p>
<p>まず <code>dquilt push</code> でパッチを当ててみるとオフセットがありつつもパッチ当てに成功しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ dquilt push
</span><span class="go">Applying patch 0001-consider-Hurd-as-a-POSIX-system.patch
</span><span class="go">patching file src/Makefile
</span><span class="go">Hunk #1 succeeded at 326 (offset -1 lines).
</span><span class="go">patching file src/lj_arch.h
</span><span class="go">Hunk #1 succeeded at 75 with fuzz 2 (offset 4 lines).
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Now at patch 0001-consider-Hurd-as-a-POSIX-system.patch
</span></code></pre></div><p>gitレポジトリの状態を確認すると以下のようになっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ git status -sb
</span><span class="go"></span><span class="gp">#</span><span class="c1"># master</span>
<span class="go"> M src/Makefile
</span><span class="go"> M src/lj_arch.h
</span><span class="go">?? .pc/
</span></code></pre></div><p>差分は以下の通りです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ git diff -w
</span><span class="go">diff --git a/src/Makefile b/src/Makefile
</span><span class="go">index f7f81a4..0251f43 100644
</span><span class="go">--- a/src/Makefile
</span><span class="go">+++ b/src/Makefile
</span><span class="go">@@ -326,6 +326,9 @@ else
</span><span class="go">   ifeq (GNU/kFreeBSD,$(TARGET_SYS))
</span><span class="go">     TARGET_XLIBS+= -ldl
</span><span class="go">   endif
</span><span class="go">+  ifeq (GNU,$(TARGET_SYS))
</span><span class="go">+    TARGET_XLIBS+= -ldl
</span><span class="go">+  endif
</span><span class="go"> endif
</span><span class="go"> endif
</span><span class="go"> endif
</span><span class="go">diff --git a/src/lj_arch.h b/src/lj_arch.h
</span><span class="go">index e04c4ee..f16db22 100644
</span><span class="go">--- a/src/lj_arch.h
</span><span class="go">+++ b/src/lj_arch.h
</span><span class="go">@@ -75,6 +75,8 @@
</span><span class="go"> #elif defined(__CYGWIN__)
</span><span class="go"> #define LJ_TARGET_CYGWIN       1
</span><span class="go"> #define LUAJIT_OS      LUAJIT_OS_POSIX
</span><span class="go">+#elif defined(__GNU__)
</span><span class="go">+#define LUAJIT_OS      LUAJIT_OS_POSIX
</span><span class="go"> #else
</span><span class="go"> #define LUAJIT_OS      LUAJIT_OS_OTHER
</span><span class="go"> #endif
</span></code></pre></div><p>パッチの内容も問題なさそうなので <code>dquilt refresh</code> でパッチを更新します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ dquilt refresh
</span><span class="go">Refreshed patch 0001-consider-Hurd-as-a-POSIX-system.patch
</span></code></pre></div><p><code>.pc/</code> というディレクトリが出来ていますが不要なので削除し、 <code>src/Makefile</code> と <code>src/lj_arch.h</code> はコミットします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">rm -rf .pc
</span><span class="go">git commit -a -m &#39;Update patch&#39;
</span></code></pre></div><h2 id="debianchangelogの更新">debian/changelogの更新</h2>
<p><a href="http://honk.sigxcpu.org/projects/git-buildpackage/manual-html/gbp.releases.html">Releases and Snapshots</a> を参考に以下のコマンドを実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">gbp dch --release
</span></code></pre></div><p>するとエディタが起動して <code>debian/changelog</code> ファイルを開いた状態になり、ファイルの先頭には <code>gbp</code> コマンドが追加した以下のようなエントリが表示されていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">luajit (2.0.5-1) xenial; urgency=medium

  * Imported Upstream version 2.0.5
  * Make source dfsg clean
  * Update patch

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Thu, 06 Jul 2017 00:55:06 +0900
</code></pre></div><p>これを以下のように編集しました。
バージョン番号は <a href="https://help.launchpad.net/Packaging/PPA/BuildingASourcePackage">Packaging/PPA/BuildingASourcePackage - Launchpad Help</a> の命名規則に沿って <code>2.0.5+dfsg-1ppa1</code> としました。これでこの後ビルドするときに <code>upstream/2.0.5+dfsg</code> タグが参照されるというわけです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text">luajit (2.0.5+dfsg-1ppa1) xenial; urgency=medium

  * New upstream release

 -- Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;  Thu, 06 Jul 2017 00:55:06 +0900

luajit (2.0.4+dfsg-1) unstable; urgency=medium
</code></pre></div><p>gitレポジトリの状態を確認すると <code>debian/changelog</code> が変更された状態になっています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ git status -sb
</span><span class="go"></span><span class="gp">#</span><span class="c1"># master</span>
<span class="go"> M debian/changelog
</span></code></pre></div><p><code>debian/changelog</code> をコミットします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">git commit -m &#39;Release 2.0.5&#39; debian/changelog
</span></code></pre></div><h2 id="ソースパッケージのビルド">ソースパッケージのビルド</h2>
<p>後ほどPPAにアップロードするときはdebのソースパッケージのみをアップロードする必要があります。</p>
<p>まず以下のコマンドを実行してソースパッケージのみをビルドします。
<a href="https://help.launchpad.net/Packaging/PPA/BuildingASourcePackage">Options when building</a>
によると既存のパッケージの別バージョンの場合は <code>-S -sd</code> というオプションを使うと書いてあるのですが、
今回はPPAに luajit を初めて登録するので <code>-S -sa</code> にしました。</p>
<p>このオプションについては <code>man gbp-buildpackage</code> 、 <code>man debuild</code> 、 <code>man dpkg-buildpackage</code>
と辿って
<a href="http://manpages.ubuntu.com/manpages/xenial/en/man1/dpkg-genchanges.1.html">man dpkg-genchanges</a>
に説明がありました。</p>
<p>途中 <code>Enter passphrase:</code> というプロンプトが2回表示されるのでgpgのパスフレーズを入力します。
<code>gpg: gpg-agent is not available in this session</code> というメッセージが
<code>Enter passphrase:</code> と同じ行に続いて表示される場合があって気づきにくいので注意してください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>gbp buildpackage --git-pristine-tar-commit --git-export-dir<span class="o">=</span>../build-area -S -sa
<span class="go">gbp:info: Exporting &#39;HEAD&#39; to &#39;/home/hnakamur/deb-tutorial/luajit/build-area/luajit-tmp&#39;
</span><span class="go">gbp:info: Moving &#39;/home/hnakamur/deb-tutorial/luajit/build-area/luajit-tmp&#39; to &#39;/home/hnakamur/deb-tutorial/luajit/build-area/luajit-2.0.5+dfsg&#39;
</span><span class="go"> dpkg-buildpackage -rfakeroot -d -us -uc -i -I -S -sa
</span><span class="go">dpkg-buildpackage: source package luajit
</span><span class="go">dpkg-buildpackage: source version 2.0.5+dfsg-1ppa1
</span><span class="go">dpkg-buildpackage: source distribution xenial
</span><span class="go">dpkg-buildpackage: source changed by Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
</span><span class="go"> dpkg-source -i -I --before-build luajit-2.0.5+dfsg
</span><span class="go"> fakeroot debian/rules clean
</span><span class="go">dh --with quilt clean
</span><span class="go">   dh_testdir
</span><span class="go">   dh_auto_clean
</span><span class="go">        make -j1 clean
</span><span class="go">make[1]: Entering directory &#39;/home/hnakamur/deb-tutorial/luajit/build-area/luajit-2.0.5+dfsg&#39;
</span><span class="go">make -C src clean
</span><span class="go">make[2]: Entering directory &#39;/home/hnakamur/deb-tutorial/luajit/build-area/luajit-2.0.5+dfsg/src&#39;
</span><span class="go">rm -f luajit libluajit.a libluajit.so host/minilua host/buildvm lj_vm.s lj_bcdef.h lj_ffdef.h lj_libdef.h lj_recdef.h lj_folddef.h host/buildvm_arch.h jit/vmdef.lua *.o host/*.o *.obj *.lib *.exp *.dll *.exe *.manifest *.pdb *.ilk
</span><span class="go">make[2]: Leaving directory &#39;/home/hnakamur/deb-tutorial/luajit/build-area/luajit-2.0.5+dfsg/src&#39;
</span><span class="go">make[1]: Leaving directory &#39;/home/hnakamur/deb-tutorial/luajit/build-area/luajit-2.0.5+dfsg&#39;
</span><span class="go">   dh_quilt_unpatch
</span><span class="go">No patch removed
</span><span class="go">   dh_clean
</span><span class="go"> dpkg-source -i -I -b luajit-2.0.5+dfsg
</span><span class="go">dpkg-source: info: using source format &#39;3.0 (quilt)&#39;
</span><span class="go">dpkg-source: info: building luajit using existing ./luajit_2.0.5+dfsg.orig.tar.gz
</span><span class="go">dpkg-source: info: building luajit in luajit_2.0.5+dfsg-1ppa1.debian.tar.xz
</span><span class="go">dpkg-source: info: building luajit in luajit_2.0.5+dfsg-1ppa1.dsc
</span><span class="go"> dpkg-genchanges -S -sa &gt;../luajit_2.0.5+dfsg-1ppa1_source.changes
</span><span class="go">dpkg-genchanges: including full source code in upload
</span><span class="go"> dpkg-source -i -I --after-build luajit-2.0.5+dfsg
</span><span class="go">dpkg-buildpackage: full upload (original source is included)
</span><span class="go">Now running lintian...
</span><span class="go">W: luajit source: ancient-standards-version 3.9.4 (current is 3.9.7)
</span><span class="go">Finished running lintian.
</span><span class="go">Now signing changes and any dsc files...
</span><span class="go"> signfile luajit_2.0.5+dfsg-1ppa1.dsc Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">You need a passphrase to unlock the secret key for
</span><span class="go">user: &#34;Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;&#34;
</span><span class="go">4096-bit RSA key, ID 1DFBC664, created 2015-11-14
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Enter passphrase: gpg: gpg-agent is not available in this session ←gpgのパスフレーズを入力
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go"> signfile luajit_2.0.5+dfsg-1ppa1_source.changes Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">You need a passphrase to unlock the secret key for
</span><span class="go">user: &#34;Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;&#34;
</span><span class="go">4096-bit RSA key, ID 1DFBC664, created 2015-11-14
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">gpg: gpg-agent is not available in this session
</span><span class="go">Enter passphrase: ←gpgのパスフレーズを入力
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Successfully signed dsc and changes files
</span></code></pre></div><p><code>../build-area/</code> ディレクトリを見るとdebソースパッケージが作成されています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">hnakamur@express:~/deb-tutorial/luajit/luajit-deb$ ls ../build-area/
</span><span class="go">luajit_2.0.5+dfsg-1ppa1.debian.tar.xz  luajit_2.0.5+dfsg-1ppa1_source.changes
</span><span class="go">luajit_2.0.5+dfsg-1ppa1.dsc            luajit_2.0.5+dfsg.orig.tar.gz
</span><span class="go">luajit_2.0.5+dfsg-1ppa1_source.build
</span></code></pre></div><h2 id="バイナリパッケージのビルド">バイナリパッケージのビルド</h2>
<p>上記で作成したソースパッケージの内容に絶対の自信があれば <code>dput</code> コマンドでLaunchPadにアップロードしてバイナリパッケージをビルドしても良いですが、ローカルでバイナリパッケージが正常にビルドできることを確認してからアップロードするほうが良いです。</p>
<p>以下のコマンドでバイナリパッケージをビルドします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">sudo pbuilder build ../build-area/luajit_2.0.5+dfsg-1ppa1.dsc
</span></code></pre></div><p>無事ビルドが完了したら、 <code>/var/cache/pbuilder/result/</code> ディレクトリにバイナリパッケージが生成されています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ls /var/cache/pbuilder/result/*luajit*
<span class="go">/var/cache/pbuilder/result/libluajit-5.1-2_2.0.5+dfsg-1ppa1_amd64.deb
</span><span class="go">/var/cache/pbuilder/result/libluajit-5.1-common_2.0.5+dfsg-1ppa1_all.deb
</span><span class="go">/var/cache/pbuilder/result/libluajit-5.1-dev_2.0.5+dfsg-1ppa1_amd64.deb
</span><span class="go">/var/cache/pbuilder/result/luajit_2.0.5+dfsg-1ppa1_amd64.changes
</span><span class="go">/var/cache/pbuilder/result/luajit_2.0.5+dfsg-1ppa1_amd64.deb
</span><span class="go">/var/cache/pbuilder/result/luajit_2.0.5+dfsg-1ppa1.debian.tar.xz
</span><span class="go">/var/cache/pbuilder/result/luajit_2.0.5+dfsg-1ppa1.dsc
</span><span class="go">/var/cache/pbuilder/result/luajit_2.0.5+dfsg.orig.tar.gz
</span></code></pre></div><p><code>*.deb</code> ファイルを新規に作成したLXDコンテナなどの別環境にコピー、インストールして動作確認します。
動作確認して大丈夫であれば、ソースパッケージをPPAにアップロードします。</p>
<h2 id="ソースパッケージをppaにアップロード">ソースパッケージをPPAにアップロード</h2>
<h3 id="ppaの作成とアクティベート">PPAの作成とアクティベート</h3>
<p>初回はパッケージのアップロード先となるPPAを作成しアクティベートする必要があります。
手順は <a href="https://help.launchpad.net/Packaging/PPA">Activating a PPA</a> に説明があります。
自分のアカウントのプロファイルページにある Create a new PPA というリンクをクリックし、Activate a Personal Package ArchiveというページでURL、Display Nameと必要に応じてDescriptionを入力してActivateボタンを押しアクティベートします。</p>
<p>今回私は <code>ppa:hnakamur/luajit</code> というPPAを作成しました。</p>
<h3 id="ソースパッケージのアップロード">ソースパッケージのアップロード</h3>
<p><a href="https://help.launchpad.net/Packaging/PPA/Uploading">Packaging/PPA/Uploading - Launchpad Help</a> に説明があります。
ソースパッケージの <code>.dsc</code> ファイルを指定して以下のコマンドを実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>dput ppa:hnakamur/luajit ../build-area/luajit_2.0.5+dfsg-1ppa1_source.changes
<span class="go">Checking signature on .changes
</span><span class="go">gpg: Signature made Thu 06 Jul 2017 02:11:13 AM JST using RSA key ID 1DFBC664
</span><span class="go">gpg: Good signature from &#34;Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;&#34;
</span><span class="go">gpg: WARNING: This key is not certified with a trusted signature!
</span><span class="go">gpg:          There is no indication that the signature belongs to the owner.
</span><span class="go">Primary key fingerprint: 3240 E02B 14E1 5B7B 5C53  4B81 153C 7660 1DFB C664
</span><span class="go">Good signature on ../build-area/luajit_2.0.5+dfsg-1ppa1_source.changes.
</span><span class="go">Checking signature on .dsc
</span><span class="go">gpg: Signature made Thu 06 Jul 2017 02:11:05 AM JST using RSA key ID 1DFBC664
</span><span class="go">gpg: Good signature from &#34;Hiroaki Nakamura &lt;hnakamur@gmail.com&gt;&#34;
</span><span class="go">gpg: WARNING: This key is not certified with a trusted signature!
</span><span class="go">gpg:          There is no indication that the signature belongs to the owner.
</span><span class="go">Primary key fingerprint: 3240 E02B 14E1 5B7B 5C53  4B81 153C 7660 1DFB C664
</span><span class="go">Good signature on ../build-area/luajit_2.0.5+dfsg-1ppa1.dsc.
</span><span class="go">Package includes an .orig.tar.gz file although the debian revision suggests
</span><span class="go">that it might not be required. Multiple uploads of the .orig.tar.gz may be
</span><span class="go">rejected by the upload queue management software.
</span><span class="go">Uploading to ppa (via ftp to ppa.launchpad.net):
</span><span class="go">  Uploading luajit_2.0.5+dfsg-1ppa1.dsc: done.
</span><span class="go">  Uploading luajit_2.0.5+dfsg.orig.tar.gz: done.
</span><span class="go">  Uploading luajit_2.0.5+dfsg-1ppa1.debian.tar.xz: done.
</span><span class="go">  Uploading luajit_2.0.5+dfsg-1ppa1_source.changes: done.
</span><span class="go">Successfully uploaded packages.
</span></code></pre></div><p>上記のように <code>Successfully uploaded packages.</code> と表示されたらひとまずはアップロード成功です。</p>
<h3 id="アップロード受付結果のメール確認">アップロード受付結果のメール確認</h3>
<p>アップロードしたあと数分ぐらいするとアップロード受付結果のメールが届きます。</p>
<p>以下は受付拒否のメールの例です。間違ってソースパッケージとバイナリパッケージをアップロードしてしまったときのものです。
<a href="https://help.launchpad.net/Packaging/UploadErrors">Packaging/UploadErrors - Launchpad Help</a> にアップロードに関するエラーについての説明があるのでこちらも参照してください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">From: Launchpad PPA &lt;no_reply@launchpad.net&gt;
</span><span class="go">Subject: [~hnakamur/ubuntu/luajit] luajit_2.0.5+dfsg-1ubuntu1ppa1_amd64.changes (Rejected)
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Rejected:
</span><span class="go">Source/binary (i.e. mixed) uploads are not allowed.
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">luajit (2.0.5+dfsg-1ubuntu1ppa1) xenial; urgency=medium
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">  * New upstream release
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">===
</span><span class="go">If you don&#39;t understand why your files were rejected please send an email
</span><span class="go">to launchpad-users@lists.launchpad.net for help (requires membership).
</span></code></pre></div><p>以下は受付成功のときのメールの例です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">From: Launchpad PPA &lt;no_reply@launchpad.net&gt;
</span><span class="go">Subject: [~hnakamur/ubuntu/luajit/xenial] luajit 2.0.5+dfsg-1ubuntu1ppa1 (Accepted)
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Accepted:
</span><span class="go"> OK: luajit_2.0.5+dfsg.orig.tar.gz
</span><span class="go"> OK: luajit_2.0.5+dfsg-1ubuntu1ppa1.debian.tar.xz
</span><span class="go"> OK: luajit_2.0.5+dfsg-1ubuntu1ppa1.dsc
</span><span class="go">     -&gt; Component: main Section: interpreters
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">luajit (2.0.5+dfsg-1ubuntu1ppa1) xenial; urgency=medium
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">  * New upstream release
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">--
</span><span class="go">https://launchpad.net/~hnakamur/+archive/ubuntu/luajit
</span><span class="go">You are receiving this email because you made this upload.
</span></code></pre></div><h3 id="ビルド経過の確認">ビルド経過の確認</h3>
<p><a href="https://launchpad.net/builders">The Launchpad build farm</a> で各ビルドサーバが今どのパッケージをビルドしているか見られます。ビルドサーバがすいているときはすぐここに表示されます。</p>
<p>また <a href="https://launchpad.net/~hnakamur/+archive/ubuntu/luajit">ppa:hnakamur/luajit</a> のページの右上にある
View package details リンクをクリックし、Packages in “luajit” ページの右上にある View all builds リンクをクリックするとBuilds for luajitというページが開き、ここの検索フォームでPPA内のパッケージの状態を確認できます。</p>
<h2 id="注意パッケージを消して同じバージョンで上げ直すことは出来ません">注意：パッケージを消して同じバージョンで上げ直すことは出来ません</h2>
<p>ここでハマりネタです。</p>
<p>今回実は一度 <code>2.0.5+dfsg-1ubuntu1ppa1</code> というバージョンでパッケージをアップロードしてビルド成功した後、ビルド手順を整理して再度試そうと思い、パッケージの詳細ページからView package detailsリンク、Delete packagesリンクと辿ってバージョン <code>2.0.5+dfsg-1ubuntu1ppa1</code> を削除していました。</p>
<p>元のパッケージのバージョンは <code>2.0.4+dfsg-1</code> とバージョン名に <code>ubuntu1</code> はついていなかったので、再度作り直す際は上記のように <code>2.0.5+dfsg-1ppa1</code> というバージョンにしてみました。</p>
<p>しかしソースパッケージをアップロードした後以下の受付拒否メールが届きました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">From: Launchpad PPA &lt;no_reply@launchpad.net&gt;
</span><span class="go">Subject: [~hnakamur/ubuntu/luajit] luajit_2.0.5+dfsg-1ppa1_source.changes (Rejected)
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Rejected:
</span><span class="go">File luajit_2.0.5+dfsg.orig.tar.gz already exists in luajit, but uploaded version has different contents. See more information about this error in https://help.launchpad.net/Packaging/UploadErrors.
</span><span class="go">Files specified in DSC are broken or missing, skipping package unpack verification.
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">luajit (2.0.5+dfsg-1ppa1) xenial; urgency=medium
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">  * New upstream release
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">===
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">If you don&#39;t understand why your files were rejected please send an email
</span><span class="go">to launchpad-users@lists.launchpad.net for help (requires membership).
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">--
</span><span class="go">https://launchpad.net/~hnakamur/+archive/ubuntu/luajit
</span><span class="go">You are receiving this email because you made this upload.
</span></code></pre></div><p>upstreamのソースをDFSGクリーンにしたtarball <code>luajit_2.0.5+dfsg.orig.tar.gz</code> が一度アップロードしたものと内容が異なっているため拒否されたということです。</p>
<p>調べてみると
<a href="https://help.launchpad.net/Packaging/PPA/Deleting">Packaging/PPA/Deleting - Launchpad Help</a> の最後にファイルが削除された後に同じバージョンのソースを再度アップロードしても拒否されると書かれていました。
ですので、何か間違えた場合もリリースの番号を上げて再度アップロードすることで対応する必要があります。</p>
<h3 id="今回の回避策">今回の回避策</h3>
<p>今回はupstreamのtarballで引っかかっているのでリリース番号ではなくupstreamのバージョンを上げる必要があります。
とはいっても、本当は2.0.5なのに2.0.5.1とかにするわけにも行かないしなーと悩みました。</p>
<p><a href="https://wiki.debian.org/DebianMentorsFaq#What_does_.2BIBw-dfsg.2BIB0_in_the_version_string_mean.3F">What does “dfsg” in the version string mean?</a> を見て、DFSGのために調整されたパッケージのバージョンは <code>&lt;UPSTREAM_VERSION&gt;+dfsg.&lt;REPACK_COUNT&gt;-&lt;DEBIAN_RELEASE&gt;</code> という形式が良いというのを知りました。</p>
<p>そこで今回は <code>2.0.5+dfsg.2-1ppa1</code> というバージョンに変更（手順は省略）して再度アップロードすることで回避しました。</p>
<h2 id="ビルドされたパッケージを他の環境にインストールしてみる">ビルドされたパッケージを他の環境にインストールしてみる</h2>
<p>LXDで新たなコンテナを作るなどしてテストするサーバを用意し、そこで以下のコマンドを実行してインストールしてみます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">sudo apt update
</span><span class="go">sudo apt install software-properties-common
</span><span class="go">sudo add-apt-repository ppa:hnakamur/luajit
</span><span class="go">sudo apt update
</span><span class="go">sudo apt install luajit
</span></code></pre></div><p>以下のコマンドでインストールされたパッケージのバージョンを確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">root@debtmp:~# dpkg-query -W -f &#39;pkg:${package}\tver:${version}\tarch:${architecture}\n&#39; &#39;*luajit*&#39;
</span><span class="go">pkg:libluajit-5.1-common        ver:2.0.5+dfsg.2-1ppa1  arch:all
</span><span class="go">pkg:luajit      ver:2.0.5+dfsg.2-1ppa1  arch:amd64
</span></code></pre></div><p>以下のコマンドで簡易的な動作確認を行います。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">root@debtmp:~# luajit
</span><span class="go">LuaJIT 2.0.5 -- Copyright (C) 2005-2017 Mike Pall. http://luajit.org/
</span><span class="go">JIT: ON CMOV SSE2 SSE3 SSE4.1 fold cse dce fwd dse narrow loop abc sink fuse
</span><span class="go"></span><span class="gp">&gt; </span>print<span class="o">(</span><span class="s1">&#39;Hello luajit!&#39;</span><span class="o">)</span>
<span class="go">Hello luajit!
</span><span class="go"></span><span class="gp">&gt; </span>（Ctrl-Dを入力して抜ける）
</code></pre></div><h2 id="新しいリリースのタグ作成">新しいリリースのタグ作成</h2>
<p>動作確認がOKだったので、新しいリリースのタグを作成しておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">git tag debian/2.0.5+dfsg.2-1ppa1 master
</span></code></pre></div><h2 id="おわりに">おわりに</h2>
<p>以上で Ubuntu 16.04 (xenial) で提供されている luajit 2.0.4 を2.0.5にアップデートしてPPAにアップロードすることができました。パッケージによってはパッチの更新の手順がもっと複雑になったりといろいろ変わってくると思いますが、とりあえずこれで基本パターンは出来たということで。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
