<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.62.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>lua-nginx-moduleのshared dictのコードリーディング &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>lua-nginx-moduleのshared dictのコードリーディング</h1>
  <time datetime=2017-09-27T08:57:00&#43;0900 class="post-date">2017-09-27</time>
  <h2 id="heading">はじめに</h2>
<p><a href="https://github.com/openresty/lua-nginx-module">openresty/lua-nginx-module: Embed the Power of Lua into NGINX HTTP servers</a>
の
<a href="https://github.com/openresty/lua-nginx-module#ngxshareddict">ngx.shared.DICT</a>
を使う際
<a href="https://github.com/openresty/lua-nginx-module#lua_shared_dict">lua_shared_dict</a>
ディレクティブで</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">http {
    lua_shared_dict dogs 10m;
    ...
}
</code></pre></div><p>のように dict のサイズを指定しますが、容量が足りているかを確認するため実際の使用量をモニタリングしたいと思いました。</p>
<p>systemtap を使った方法
<a href="https://github.com/openresty/openresty-systemtap-toolkit/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/ngx-shm">openresty-systemtap-toolkit/ngx-shm at 97fbeb0bef1aa85e758210d58063376de8eaed31 · openresty/openresty-systemtap-toolkit</a>
が提供されているのは気付いたのですが、FreeBSDなどLinux以外では使えません。</p>
<p>ngx.shared.DICT のソースを見ると nginx の slab allocator を使ってメモリ割り当てを行っていました。
そこで slab allocator の統計情報から使用量を計算するメソッドを ngx.shared.DICT に追加するプルリクエスト
<a href="https://github.com/openresty/lua-nginx-module/pull/1149">Add FFI methods for taking stats to ngx.shared.DICT by hnakamur · Pull Request #1149 · openresty/lua-nginx-module</a>
を書いてみました。これはまだマージされていません。</p>
<p>テストケースを用意して実際に試してみながら、lua-nginx-moduleのshared dict関連とnginxのslab allocatorのコードを読んでみたのでメモです。</p>
<p>対象バージョンは lua-nginx-module は現時点での最新コミット、nginx は 1.13.5 にしました。</p>
<p>(注) この記事は書きかけです。長くなって疲れてきたので途中ですが一旦上げます。</p>
<h2 id="lua-shared-dict-">lua_shared_dict ディレクティブ関連のコード</h2>
<p><code>lua_shared_dict</code> ディレクティブを処理する関数は <code>ngx_http_lua_shared_dict</code> です。</p>
<p><a href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_module.c#L74-L95">lua-nginx-module/src/ngx_http_lua_module.c#L74-L95</a></p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">ngx_command_t</span> <span class="n">ngx_http_lua_cmds</span><span class="p">[</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>

    <span class="p">{</span> <span class="n">ngx_string</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">lua_max_running_timers</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span>
      <span class="n">NGX_HTTP_MAIN_CONF</span><span class="o">|</span><span class="n">NGX_CONF_TAKE1</span><span class="p">,</span>
      <span class="n">ngx_conf_set_num_slot</span><span class="p">,</span>
      <span class="n">NGX_HTTP_MAIN_CONF_OFFSET</span><span class="p">,</span>
      <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_http_lua_main_conf_t</span><span class="p">,</span> <span class="n">max_running_timers</span><span class="p">)</span><span class="p">,</span>
      <span class="nb">NULL</span> <span class="p">}</span><span class="p">,</span>

    <span class="p">{</span> <span class="n">ngx_string</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">lua_max_pending_timers</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span>
      <span class="n">NGX_HTTP_MAIN_CONF</span><span class="o">|</span><span class="n">NGX_CONF_TAKE1</span><span class="p">,</span>
      <span class="n">ngx_conf_set_num_slot</span><span class="p">,</span>
      <span class="n">NGX_HTTP_MAIN_CONF_OFFSET</span><span class="p">,</span>
      <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_http_lua_main_conf_t</span><span class="p">,</span> <span class="n">max_pending_timers</span><span class="p">)</span><span class="p">,</span>
      <span class="nb">NULL</span> <span class="p">}</span><span class="p">,</span>

    <span class="p">{</span> <span class="n">ngx_string</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">lua_shared_dict</span><span class="s">&#34;</span><span class="p">)</span><span class="p">,</span>
      <span class="n">NGX_HTTP_MAIN_CONF</span><span class="o">|</span><span class="n">NGX_CONF_TAKE2</span><span class="p">,</span>
      <span class="n">ngx_http_lua_shared_dict</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span>
      <span class="nb">NULL</span> <span class="p">}</span><span class="p">,</span>
</code></pre></div><p><a href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_directive.c#L73-L155">lua-nginx-module/src/ngx_http_lua_directive.c#L73-L155</a></p>
<p>下記の <code>ngx_http_lua_shared_dict</code> 関数の110行目で <code>ngx_parse_size</code> 関数でshared dictのサイズをパーズして 127行目で <code>ngx_http_lua_shared_memory_add</code> 関数で <code>zone</code> の情報を作成しています。</p>
<p>145～150行目で <code>zone</code> の情報をlua-nginx-moduleの shared dict管理情報の配列 <code>lmcf-&gt;shdict_zones</code> に追加しています。</p>
<p>また142行目で <code>zone-&gt;init</code> に <code>ngx_http_lua_shdict_init_zone</code> 関数を設定しています。</p>
<p><code>zone</code> に対応する共有メモリは後続の nginx の初期化処理で確保します。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">char</span> <span class="o">*</span>
<span class="nf">ngx_http_lua_shared_dict</span><span class="p">(</span><span class="n">ngx_conf_t</span> <span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="n">ngx_command_t</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_http_lua_main_conf_t</span>   <span class="o">*</span><span class="n">lmcf</span> <span class="o">=</span> <span class="n">conf</span><span class="p">;</span>

    <span class="n">ngx_str_t</span>                  <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">name</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>             <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>            <span class="o">*</span><span class="o">*</span><span class="n">zp</span><span class="p">;</span>
    <span class="n">ngx_http_lua_shdict_ctx_t</span>  <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
    <span class="n">ssize_t</span>                     <span class="n">size</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shdict_zones</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shdict_zones</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_array_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shdict_zones</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_array_init</span><span class="p">(</span><span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shdict_zones</span><span class="p">,</span> <span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                           <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_shm_zone_t</span> <span class="o">*</span><span class="p">)</span><span class="p">)</span>
            <span class="o">!</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">args</span><span class="o">-</span><span class="o">&gt;</span><span class="n">elts</span><span class="p">;</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_conf_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="sa"></span><span class="s">&#34;</span><span class="s">invalid lua shared dict name </span><span class="se">\&#34;</span><span class="s">%V</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="p">;</span>

    <span class="n">size</span> <span class="o">=</span> <span class="n">ngx_parse_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="p">)</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span><span class="o">=</span> <span class="mi">8191</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_conf_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="sa"></span><span class="s">&#34;</span><span class="s">invalid lua shared dict size </span><span class="se">\&#34;</span><span class="s">%V</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ngx_pcalloc</span><span class="p">(</span><span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_http_lua_shdict_ctx_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">main_conf</span> <span class="o">=</span> <span class="n">lmcf</span><span class="p">;</span>
    <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">new_log</span><span class="p">;</span>

    <span class="n">zone</span> <span class="o">=</span> <span class="n">ngx_http_lua_shared_memory_add</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span> <span class="n">size</span><span class="p">,</span>
                                          <span class="o">&amp;</span><span class="n">ngx_http_lua_module</span><span class="p">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">;</span>

        <span class="n">ngx_conf_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="sa"></span><span class="s">&#34;</span><span class="s">lua_shared_dict </span><span class="se">\&#34;</span><span class="s">%V</span><span class="se">\&#34;</span><span class="s"> is already defined as </span><span class="s">&#34;</span>
                           <span class="sa"></span><span class="s">&#34;</span><span class="se">\&#34;</span><span class="s">%V</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="n">ngx_http_lua_shdict_init_zone</span><span class="p">;</span>
    <span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

    <span class="n">zp</span> <span class="o">=</span> <span class="n">ngx_array_push</span><span class="p">(</span><span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shdict_zones</span><span class="p">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zp</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_CONF_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zone</span><span class="p">;</span>

    <span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">requires_shm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">NGX_CONF_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上記の145行目の <code>lmcf</code> に対応する <code>ngx_http_lua_main_conf_s</code> 構造体の定義は以下のようになっています。</p>
<p><a href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_common.h#L163-L234">lua-nginx-module/src/ngx_http_lua_common.h#L163-L234</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">ngx_http_lua_main_conf_s</span> <span class="p">{</span>
    <span class="n">lua_State</span>           <span class="o">*</span><span class="n">lua</span><span class="p">;</span>

    <span class="n">ngx_str_t</span>            <span class="n">lua_path</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>            <span class="n">lua_cpath</span><span class="p">;</span>

    <span class="n">ngx_cycle_t</span>         <span class="o">*</span><span class="n">cycle</span><span class="p">;</span>
    <span class="n">ngx_pool_t</span>          <span class="o">*</span><span class="n">pool</span><span class="p">;</span>

    <span class="n">ngx_int_t</span>            <span class="n">max_pending_timers</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>            <span class="n">pending_timers</span><span class="p">;</span>

    <span class="n">ngx_int_t</span>            <span class="n">max_running_timers</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>            <span class="n">running_timers</span><span class="p">;</span>

    <span class="n">ngx_connection_t</span>    <span class="o">*</span><span class="n">watcher</span><span class="p">;</span>  <span class="cm">/* for watching the process exit event */</span>

<span class="cp">#</span><span class="cp">if (NGX_PCRE)</span><span class="cp">
</span><span class="cp"></span>    <span class="n">ngx_int_t</span>            <span class="n">regex_cache_entries</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>            <span class="n">regex_cache_max_entries</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>            <span class="n">regex_match_limit</span><span class="p">;</span>

<span class="cp">#</span><span class="cp">if (LUA_HAVE_PCRE_JIT)</span><span class="cp">
</span><span class="cp"></span>    <span class="n">pcre_jit_stack</span>      <span class="o">*</span><span class="n">jit_stack</span><span class="p">;</span>
<span class="cp">#</span><span class="cp">endif</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#</span><span class="cp">endif</span><span class="cp">
</span><span class="cp"></span>
    <span class="n">ngx_array_t</span>         <span class="o">*</span><span class="n">shm_zones</span><span class="p">;</span>  <span class="cm">/* of ngx_shm_zone_t* */</span>

    <span class="n">ngx_array_t</span>         <span class="o">*</span><span class="n">shdict_zones</span><span class="p">;</span> <span class="cm">/* shm zones of &#34;shdict&#34; */</span>

    <span class="n">ngx_array_t</span>         <span class="o">*</span><span class="n">preload_hooks</span><span class="p">;</span> <span class="cm">/* of ngx_http_lua_preload_hook_t */</span>

    <span class="n">ngx_flag_t</span>           <span class="n">postponed_to_rewrite_phase_end</span><span class="p">;</span>
    <span class="n">ngx_flag_t</span>           <span class="n">postponed_to_access_phase_end</span><span class="p">;</span>

    <span class="n">ngx_http_lua_main_conf_handler_pt</span>    <span class="n">init_handler</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>                            <span class="n">init_src</span><span class="p">;</span>

    <span class="n">ngx_http_lua_main_conf_handler_pt</span>    <span class="n">init_worker_handler</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>                            <span class="n">init_worker_src</span><span class="p">;</span>

    <span class="n">ngx_http_lua_balancer_peer_data_t</span>      <span class="o">*</span><span class="n">balancer_peer_data</span><span class="p">;</span>
                    <span class="cm">/* balancer_by_lua does not support yielding and
</span><span class="cm">                     * there cannot be any conflicts among concurrent requests,
</span><span class="cm">                     * thus it is safe to store the peer data in the main conf.
</span><span class="cm">                     */</span>

    <span class="n">ngx_uint_t</span>                      <span class="n">shm_zones_inited</span><span class="p">;</span>

    <span class="n">ngx_http_lua_sema_mm_t</span>         <span class="o">*</span><span class="n">sema_mm</span><span class="p">;</span>

    <span class="n">ngx_uint_t</span>           <span class="n">malloc_trim_cycle</span><span class="p">;</span>  <span class="cm">/* a cycle is defined as the number
</span><span class="cm">                                                of reqeusts */</span>
    <span class="n">ngx_uint_t</span>           <span class="n">malloc_trim_req_count</span><span class="p">;</span>

<span class="cp">#</span><span class="cp">if nginx_version &gt;= 1011011</span><span class="cp">
</span><span class="cp"></span>    <span class="cm">/* the following 2 fields are only used by ngx.req.raw_headers() for now */</span>
    <span class="n">ngx_buf_t</span>          <span class="o">*</span><span class="o">*</span><span class="n">busy_buf_ptrs</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>            <span class="n">busy_buf_ptr_count</span><span class="p">;</span>
<span class="cp">#</span><span class="cp">endif</span><span class="cp">
</span><span class="cp"></span>
    <span class="kt">unsigned</span>             <span class="nl">requires_header_filter</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_body_filter</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_capture_filter</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_rewrite</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_access</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_log</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_shm</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span>             <span class="nl">requires_capture_log</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>次に <code>ngx_http_lua_shared_memory_add</code> 関数の実装を見ていきます。</p>
<p><a href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_api.c#L86-L152">lua-nginx-module/src/ngx_http_lua_api.c#L86-L152</a></p>
<p>115行目の <code>ngx_shared_memory_add</code> 関数で <code>zone</code> を作り、127行目で <code>ctx</code> 用のメモリを割りあてて 136行目で <code>ctx-&gt;zone</code> に <code>zone</code> の内容をコピーして 151行目で関数の戻り値として返しています。</p>
<p>138～143行目で lua-nginx-module で共有メモリのゾーンを管理する配列 <code>lmcf-&gt;shm_zones</code> に要素を追加しています。</p>
<p>また、146行目で <code>zone-&gt;init</code> に <code>ngx_http_lua_shared_memory_init</code> 関数を設定しています。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">ngx_shm_zone_t</span> <span class="o">*</span>
<span class="nf">ngx_http_lua_shared_memory_add</span><span class="p">(</span><span class="n">ngx_conf_t</span> <span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="n">ngx_str_t</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_http_lua_main_conf_t</span>     <span class="o">*</span><span class="n">lmcf</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>              <span class="o">*</span><span class="o">*</span><span class="n">zp</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>               <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
    <span class="n">ngx_http_lua_shm_zone_ctx_t</span>  <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>                     <span class="n">n</span><span class="p">;</span>

    <span class="n">lmcf</span> <span class="o">=</span> <span class="n">ngx_http_conf_get_module_main_conf</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">ngx_http_lua_module</span><span class="p">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm_zones</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm_zones</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_array_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm_zones</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_array_init</span><span class="p">(</span><span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm_zones</span><span class="p">,</span> <span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                           <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_shm_zone_t</span> <span class="o">*</span><span class="p">)</span><span class="p">)</span>
            <span class="o">!</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">zone</span> <span class="o">=</span> <span class="n">ngx_shared_memory_add</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span> <span class="n">size</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_http_lua_shm_zone_ctx_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">zone</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">n</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_http_lua_shm_zone_ctx_t</span><span class="p">)</span><span class="p">;</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">ngx_pcalloc</span><span class="p">(</span><span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">lmcf</span> <span class="o">=</span> <span class="n">lmcf</span><span class="p">;</span>
    <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">new_log</span><span class="p">;</span>
    <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">cycle</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">cycle</span><span class="p">;</span>

    <span class="n">ngx_memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">zone</span><span class="p">,</span> <span class="n">zone</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_shm_zone_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

    <span class="n">zp</span> <span class="o">=</span> <span class="n">ngx_array_push</span><span class="p">(</span><span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm_zones</span><span class="p">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zp</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">zp</span> <span class="o">=</span> <span class="n">zone</span><span class="p">;</span>

    <span class="cm">/* set zone init */</span>
    <span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="n">ngx_http_lua_shared_memory_init</span><span class="p">;</span>
    <span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>

    <span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">requires_shm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">zone</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_cycle.c#L1204-L1274">nginx/src/core/ngx_cycle.c#L1204-L1274</a></p>
<p>下記の <code>ngx_shared_memory_add</code> 関数の1264行目で <code>zone-&gt;data</code> に <code>NULL</code> を設定していますので、上記の関数 <code>ngx_http_lua_shared_memory_add</code> では 120行目の <code>if</code> の条件は <code>false</code> になり、125行目以降が実行されることになります。</p>
<p><code>ngx_shared_memory_add</code> の1258～1271でnginxで共有メモリを管理しているリスト <code>cf-&gt;cycle-&gt;shared_memory</code> に共有メモリの管理情報を追加しています。</p>
<p>実際に共有メモリを割り当てるのは後述の <code>ngx_shm_alloc</code> 関数です。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1204
</span><span class="lnt">1205
</span><span class="lnt">1206
</span><span class="lnt">1207
</span><span class="lnt">1208
</span><span class="lnt">1209
</span><span class="lnt">1210
</span><span class="lnt">1211
</span><span class="lnt">1212
</span><span class="lnt">1213
</span><span class="lnt">1214
</span><span class="lnt">1215
</span><span class="lnt">1216
</span><span class="lnt">1217
</span><span class="lnt">1218
</span><span class="lnt">1219
</span><span class="lnt">1220
</span><span class="lnt">1221
</span><span class="lnt">1222
</span><span class="lnt">1223
</span><span class="lnt">1224
</span><span class="lnt">1225
</span><span class="lnt">1226
</span><span class="lnt">1227
</span><span class="lnt">1228
</span><span class="lnt">1229
</span><span class="lnt">1230
</span><span class="lnt">1231
</span><span class="lnt">1232
</span><span class="lnt">1233
</span><span class="lnt">1234
</span><span class="lnt">1235
</span><span class="lnt">1236
</span><span class="lnt">1237
</span><span class="lnt">1238
</span><span class="lnt">1239
</span><span class="lnt">1240
</span><span class="lnt">1241
</span><span class="lnt">1242
</span><span class="lnt">1243
</span><span class="lnt">1244
</span><span class="lnt">1245
</span><span class="lnt">1246
</span><span class="lnt">1247
</span><span class="lnt">1248
</span><span class="lnt">1249
</span><span class="lnt">1250
</span><span class="lnt">1251
</span><span class="lnt">1252
</span><span class="lnt">1253
</span><span class="lnt">1254
</span><span class="lnt">1255
</span><span class="lnt">1256
</span><span class="lnt">1257
</span><span class="lnt">1258
</span><span class="lnt">1259
</span><span class="lnt">1260
</span><span class="lnt">1261
</span><span class="lnt">1262
</span><span class="lnt">1263
</span><span class="lnt">1264
</span><span class="lnt">1265
</span><span class="lnt">1266
</span><span class="lnt">1267
</span><span class="lnt">1268
</span><span class="lnt">1269
</span><span class="lnt">1270
</span><span class="lnt">1271
</span><span class="lnt">1272
</span><span class="lnt">1273
</span><span class="lnt">1274
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">ngx_shm_zone_t</span> <span class="o">*</span>
<span class="nf">ngx_shared_memory_add</span><span class="p">(</span><span class="n">ngx_conf_t</span> <span class="o">*</span><span class="n">cf</span><span class="p">,</span> <span class="n">ngx_str_t</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_uint_t</span>        <span class="n">i</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>   <span class="o">*</span><span class="n">shm_zone</span><span class="p">;</span>
    <span class="n">ngx_list_part_t</span>  <span class="o">*</span><span class="n">part</span><span class="p">;</span>

    <span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shared_memory</span><span class="p">.</span><span class="n">part</span><span class="p">;</span>
    <span class="n">shm_zone</span> <span class="o">=</span> <span class="n">part</span><span class="o">-</span><span class="o">&gt;</span><span class="n">elts</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* void */</span> <span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">part</span><span class="o">-</span><span class="o">&gt;</span><span class="n">nelts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">shm_zone</span> <span class="o">=</span> <span class="n">part</span><span class="o">-</span><span class="o">&gt;</span><span class="n">elts</span><span class="p">;</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="o">-</span><span class="o">&gt;</span><span class="n">len</span> <span class="o">!</span><span class="o">=</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_strncmp</span><span class="p">(</span><span class="n">name</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">name</span><span class="o">-</span><span class="o">&gt;</span><span class="n">len</span><span class="p">)</span>
            <span class="o">!</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">tag</span> <span class="o">!</span><span class="o">=</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_conf_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="sa"></span><span class="s">&#34;</span><span class="s">the shared memory zone </span><span class="se">\&#34;</span><span class="s">%V</span><span class="se">\&#34;</span><span class="s"> is </span><span class="s">&#34;</span>
                            <span class="sa"></span><span class="s">&#34;</span><span class="s">already declared for a different use</span><span class="s">&#34;</span><span class="p">,</span>
                            <span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">)</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">size</span> <span class="o">!</span><span class="o">=</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_conf_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="sa"></span><span class="s">&#34;</span><span class="s">the size %uz of shared memory zone </span><span class="se">\&#34;</span><span class="s">%V</span><span class="se">\&#34;</span><span class="s"> </span><span class="s">&#34;</span>
                            <span class="sa"></span><span class="s">&#34;</span><span class="s">conflicts with already declared size %uz</span><span class="s">&#34;</span><span class="p">,</span>
                            <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span><span class="p">)</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">shm_zone</span> <span class="o">=</span> <span class="n">ngx_list_push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shared_memory</span><span class="p">)</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">exists</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">;</span>
    <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">noreuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">shm_zone</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ngx_http_lua_shared_memory_init</code> 関数の実装です。</p>
<p><a href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_api.c#L155-L214">lua-nginx-module/src/ngx_http_lua_api.c#L155-L214</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">ngx_int_t</span>
<span class="nf">ngx_http_lua_shared_memory_init</span><span class="p">(</span><span class="n">ngx_shm_zone_t</span> <span class="o">*</span><span class="n">shm_zone</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_http_lua_shm_zone_ctx_t</span> <span class="o">*</span><span class="n">octx</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>              <span class="o">*</span><span class="n">ozone</span><span class="p">;</span>
    <span class="kt">void</span>                        <span class="o">*</span><span class="n">odata</span><span class="p">;</span>

    <span class="n">ngx_int_t</span>                    <span class="n">rc</span><span class="p">;</span>
    <span class="k">volatile</span> <span class="n">ngx_cycle_t</span>        <span class="o">*</span><span class="n">saved_cycle</span><span class="p">;</span>
    <span class="n">ngx_http_lua_main_conf_t</span>    <span class="o">*</span><span class="n">lmcf</span><span class="p">;</span>
    <span class="n">ngx_http_lua_shm_zone_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>              <span class="o">*</span><span class="n">zone</span><span class="p">;</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_http_lua_shm_zone_ctx_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="n">zone</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">zone</span><span class="p">;</span>

    <span class="n">odata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">octx</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ozone</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">octx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">zone</span><span class="p">;</span>
        <span class="n">odata</span> <span class="o">=</span> <span class="n">ozone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span> <span class="o">=</span> <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">;</span>
<span class="cp">#</span><span class="cp">if defined(nginx_version) &amp;&amp; nginx_version &gt;= 1009000</span><span class="cp">
</span><span class="cp"></span>    <span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">noreuse</span> <span class="o">=</span> <span class="n">shm_zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">noreuse</span><span class="p">;</span>
<span class="cp">#</span><span class="cp">endif</span><span class="cp">
</span><span class="cp"></span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">odata</span><span class="p">)</span> <span class="o">!</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">dd</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">get lmcf</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>

    <span class="n">lmcf</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">lmcf</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">dd</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">lmcf-&gt;lua: %p</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">lua</span><span class="p">)</span><span class="p">;</span>

    <span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm_zones_inited</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm_zones_inited</span> <span class="o">=</span><span class="o">=</span> <span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm_zones</span><span class="o">-</span><span class="o">&gt;</span><span class="n">nelts</span>
        <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">init_handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">saved_cycle</span> <span class="o">=</span> <span class="n">ngx_cycle</span><span class="p">;</span>
        <span class="n">ngx_cycle</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">cycle</span><span class="p">;</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">init_handler</span><span class="p">(</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">,</span> <span class="n">lmcf</span><span class="p">,</span> <span class="n">lmcf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">lua</span><span class="p">)</span><span class="p">;</span>

        <span class="n">ngx_cycle</span> <span class="o">=</span> <span class="n">saved_cycle</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* an error happened */</span>
            <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ngx_shm_zone_t</code> 構造体の定義です。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_cycle.h#L25-L35">nginx/src/core/ngx_cycle.h#L25-L35</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ngx_shm_zone_s</span>  <span class="n">ngx_shm_zone_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="nf">ngx_int_t</span> <span class="p">(</span><span class="o">*</span><span class="n">ngx_shm_zone_init_pt</span><span class="p">)</span> <span class="p">(</span><span class="n">ngx_shm_zone_t</span> <span class="o">*</span><span class="n">zone</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ngx_shm_zone_s</span> <span class="p">{</span>
    <span class="kt">void</span>                     <span class="o">*</span><span class="n">data</span><span class="p">;</span>
    <span class="n">ngx_shm_t</span>                 <span class="n">shm</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_init_pt</span>      <span class="n">init</span><span class="p">;</span>
    <span class="kt">void</span>                     <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>                <span class="n">noreuse</span><span class="p">;</span>  <span class="cm">/* unsigned  noreuse:1; */</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ngx_shm_t</code> 構造体の定義です。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/os/unix/ngx_shmem.h#L16-L26">nginx/os/unix/ngx_shmem.h#L16-L26</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">u_char</span>      <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
    <span class="n">size_t</span>       <span class="n">size</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>    <span class="n">name</span><span class="p">;</span>
    <span class="n">ngx_log_t</span>   <span class="o">*</span><span class="n">log</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>   <span class="n">exists</span><span class="p">;</span>   <span class="cm">/* unsigned  exists:1;  */</span>
<span class="p">}</span> <span class="n">ngx_shm_t</span><span class="p">;</span>

<span class="n">ngx_int_t</span> <span class="nf">ngx_shm_alloc</span><span class="p">(</span><span class="n">ngx_shm_t</span> <span class="o">*</span><span class="n">shm</span><span class="p">)</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">ngx_shm_free</span><span class="p">(</span><span class="n">ngx_shm_t</span> <span class="o">*</span><span class="n">shm</span><span class="p">)</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ngx_http_lua_shm_zone_ctx_t</code> 構造体などの定義です。</p>
<p><a href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_shdict.h#L14-L55">lua-nginx-module/src/ngx_http_lua_shdict.h#L14-L55</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">u_char</span>                       <span class="n">color</span><span class="p">;</span>
    <span class="n">uint8_t</span>                      <span class="n">value_type</span><span class="p">;</span>
    <span class="n">u_short</span>                      <span class="n">key_len</span><span class="p">;</span>
    <span class="n">uint32_t</span>                     <span class="n">value_len</span><span class="p">;</span>
    <span class="n">uint64_t</span>                     <span class="n">expires</span><span class="p">;</span>
    <span class="n">ngx_queue_t</span>                  <span class="n">queue</span><span class="p">;</span>
    <span class="n">uint32_t</span>                     <span class="n">user_flags</span><span class="p">;</span>
    <span class="n">u_char</span>                       <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_http_lua_shdict_node_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_queue_t</span>                  <span class="n">queue</span><span class="p">;</span>
    <span class="n">uint32_t</span>                     <span class="n">value_len</span><span class="p">;</span>
    <span class="n">uint8_t</span>                      <span class="n">value_type</span><span class="p">;</span>
    <span class="n">u_char</span>                       <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_http_lua_shdict_list_node_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_rbtree_t</span>                  <span class="n">rbtree</span><span class="p">;</span>
    <span class="n">ngx_rbtree_node_t</span>             <span class="n">sentinel</span><span class="p">;</span>
    <span class="n">ngx_queue_t</span>                   <span class="n">lru_queue</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_http_lua_shdict_shctx_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_http_lua_shdict_shctx_t</span>  <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
    <span class="n">ngx_slab_pool_t</span>              <span class="o">*</span><span class="n">shpool</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>                     <span class="n">name</span><span class="p">;</span>
    <span class="n">ngx_http_lua_main_conf_t</span>     <span class="o">*</span><span class="n">main_conf</span><span class="p">;</span>
    <span class="n">ngx_log_t</span>                    <span class="o">*</span><span class="n">log</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_http_lua_shdict_ctx_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_log_t</span>                   <span class="o">*</span><span class="n">log</span><span class="p">;</span>
    <span class="n">ngx_http_lua_main_conf_t</span>    <span class="o">*</span><span class="n">lmcf</span><span class="p">;</span>
    <span class="n">ngx_cycle_t</span>                 <span class="o">*</span><span class="n">cycle</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>               <span class="n">zone</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_http_lua_shm_zone_ctx_t</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>今回注目するのは <code>ngx_http_lua_shdict_ctx_t</code> 構造体の <code>shpool</code> の <code>ngx_slab_pool_t</code> 構造体です。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.h#L16-L69">nginx/src/core/ngx_slab.h#L16-L69</a></p>
<p><code>ngx_slab_pool_t</code> 構造体の <code>stats</code> フィールド <code>ngx_slab_stat_t</code> 構造体にメモリ割り当ての回数 <code>used</code> とメモリ割り当て合計バイト数 <code>total</code> があり、 <code>total</code> からメモリ使用量を計算できます。 詳細は後ほど見ていきます。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ngx_slab_page_s</span>  <span class="n">ngx_slab_page_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ngx_slab_page_s</span> <span class="p">{</span>
    <span class="n">uintptr_t</span>         <span class="n">slab</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="n">uintptr_t</span>         <span class="n">prev</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_uint_t</span>        <span class="n">total</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">used</span><span class="p">;</span>

    <span class="n">ngx_uint_t</span>        <span class="n">reqs</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">fails</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_slab_stat_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ngx_shmtx_sh_t</span>    <span class="n">lock</span><span class="p">;</span>

    <span class="n">size_t</span>            <span class="n">min_size</span><span class="p">;</span>
    <span class="n">size_t</span>            <span class="n">min_shift</span><span class="p">;</span>

    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">pages</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">last</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>   <span class="n">free</span><span class="p">;</span>

    <span class="n">ngx_slab_stat_t</span>  <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">pfree</span><span class="p">;</span>

    <span class="n">u_char</span>           <span class="o">*</span><span class="n">start</span><span class="p">;</span>
    <span class="n">u_char</span>           <span class="o">*</span><span class="n">end</span><span class="p">;</span>

    <span class="n">ngx_shmtx_t</span>       <span class="n">mutex</span><span class="p">;</span>

    <span class="n">u_char</span>           <span class="o">*</span><span class="n">log_ctx</span><span class="p">;</span>
    <span class="n">u_char</span>            <span class="n">zero</span><span class="p">;</span>

    <span class="kt">unsigned</span>          <span class="nl">log_nomem</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>

    <span class="kt">void</span>             <span class="o">*</span><span class="n">data</span><span class="p">;</span>
    <span class="kt">void</span>             <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_slab_pool_t</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">ngx_slab_sizes_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">ngx_slab_init</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">)</span><span class="p">;</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">ngx_slab_alloc</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">)</span><span class="p">;</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">ngx_slab_alloc_locked</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">)</span><span class="p">;</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">ngx_slab_calloc</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">)</span><span class="p">;</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">ngx_slab_calloc_locked</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">)</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">ngx_slab_free</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">ngx_slab_free_locked</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="ngx-slab-sizes-init-">ngx_slab_sizes_init 関数のコード</h2>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L80-L95">nginx/src/core/ngx_slab.c#L80-L95</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">ngx_uint_t</span>  <span class="n">ngx_slab_max_size</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ngx_uint_t</span>  <span class="n">ngx_slab_exact_size</span><span class="p">;</span>
<span class="k">static</span> <span class="n">ngx_uint_t</span>  <span class="n">ngx_slab_exact_shift</span><span class="p">;</span>

<span class="kt">void</span>
<span class="nf">ngx_slab_sizes_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_uint_t</span>  <span class="n">n</span><span class="p">;</span>

    <span class="n">ngx_slab_max_size</span> <span class="o">=</span> <span class="n">ngx_pagesize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">ngx_slab_exact_size</span> <span class="o">=</span> <span class="n">ngx_pagesize</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ngx_slab_exact_size</span><span class="p">;</span> <span class="n">n</span> <span class="o">&gt;</span><span class="o">&gt;</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ngx_slab_exact_shift</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* void */</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ngx_slab_sizes_init</code> は <code>main</code> 関数の280行目から呼ばれています。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/nginx.c#L264-L298">nginx/nginx.c at release-1.13.5 · nginx/nginx</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">if</span> <span class="p">(</span><span class="n">ngx_os_init</span><span class="p">(</span><span class="n">log</span><span class="p">)</span> <span class="o">!</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
</span><span class="cm"> * ngx_crc32_table_init() requires ngx_cacheline_size set in ngx_os_init()
</span><span class="cm"> */</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ngx_crc32_table_init</span><span class="p">(</span><span class="p">)</span> <span class="o">!</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*
</span><span class="cm"> * ngx_slab_sizes_init() requires ngx_pagesize set in ngx_os_init()
</span><span class="cm"> */</span>

<span class="n">ngx_slab_sizes_init</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ngx_add_inherited_sockets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_cycle</span><span class="p">)</span> <span class="o">!</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">ngx_preinit_modules</span><span class="p">(</span><span class="p">)</span> <span class="o">!</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">cycle</span> <span class="o">=</span> <span class="n">ngx_init_cycle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_cycle</span><span class="p">)</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">cycle</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ngx_test_config</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_log_stderr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">configuration file %s test failed</span><span class="s">&#34;</span><span class="p">,</span>
                       <span class="n">init_cycle</span><span class="p">.</span><span class="n">conf_file</span><span class="p">.</span><span class="n">data</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ngx_slab_sizes_init: 内で参照している </code>ngx_pagesize` は以下の場所で定義されています。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/os/unix/ngx_alloc.c#L12-L14">nginx/ngx_alloc.c at release-1.13.5 · nginx/nginx</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">ngx_uint_t</span>  <span class="n">ngx_pagesize</span><span class="p">;</span>
<span class="n">ngx_uint_t</span>  <span class="n">ngx_pagesize_shift</span><span class="p">;</span>
<span class="n">ngx_uint_t</span>  <span class="n">ngx_cacheline_size</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ngx_pagesize</code> は下記の <code>ngx_os_init</code> 関数内の
50行目で
<a href="http://man7.org/linux/man-pages/man2/getpagesize.2.html">getpagesize(2) - Linux manual page</a>
の値で初期化されています。
また <code>ngx_pagesize_shift</code> は53行目で 12 になります。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/os/unix/ngx_posix_init.c#L50-L53">nginx/src/os/unix/ngx_posix_init.c#L50-L53</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">ngx_pagesize</span> <span class="o">=</span> <span class="n">getpagesize</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="n">ngx_cacheline_size</span> <span class="o">=</span> <span class="n">NGX_CPU_CACHE_LINE</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">ngx_pagesize</span><span class="p">;</span> <span class="n">n</span> <span class="o">&gt;</span><span class="o">&gt;</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ngx_pagesize_shift</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* void */</span> <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="http://man7.org/linux/man-pages/man1/getconf.1p.html">getconf.1p - Linux manual page</a>
と
<a href="http://man7.org/linux/man-pages/man3/sysconf.3.html">sysconf(3) - Linux manual page</a>
を見て Ubuntu 16.04 環境で試したところ <code>getconf PAGESIZE</code> または <code>getconf PAGE_SIZE</code> で取得できました。</p>
<pre><code class="language-console" data-lang="console">$ getconf PAGESIZE
4096
$ getconf PAGE_SIZE
4096
</code></pre><p>詳細は省略しますがデバッグ版のnginxをgdbで動かして
<code>ngx_slab_max_size</code>, <code>ngx_slab_exact_size</code>, <code>ngx_slab_exact_shift</code> の値を確認すると以下のようになっていました。</p>
<pre><code class="language-console" data-lang="console">(gdb) break ngx_slab_sizes_init
Breakpoint 1 at 0x426fdc: file src/core/ngx_slab.c, line 90.
(gdb) run
...
Breakpoint 1, ngx_slab_sizes_init () at src/core/ngx_slab.c:90
90          ngx_slab_max_size = ngx_pagesize / 2;
(gdb) n
91          ngx_slab_exact_size = ngx_pagesize / (8 * sizeof(uintptr_t));
(gdb) n
92          for (n = ngx_slab_exact_size; n &gt;&gt;= 1; ngx_slab_exact_shift++) {
(gdb) n
main (argc=&lt;optimized out&gt;, argv=&lt;optimized out&gt;) at src/core/nginx.c:282
282         if (ngx_add_inherited_sockets(&amp;init_cycle) != NGX_OK) {
(gdb) print ngx_slab_max_size
$1 = 2048
(gdb) print ngx_slab_exact_size
$2 = 64
(gdb) print ngx_slab_exact_shift
$3 = 6
</code></pre><h2 id="ngx-slab-init-">ngx_slab_init 関数のコード</h2>
<p><code>ngx_slab_init</code> 関数は上記に引用した <code>main</code> 関数の290行目から呼ばれる
<code>ngx_init_cycle</code> 関数の482行目を経由して <code>ngx_init_zone_pool</code> 関数から呼ばれます。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_cycle.c#L404-L493">nginx/src/core/ngx_cycle.c#L404-L493</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* create shared memory */</span>

<span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shared_memory</span><span class="p">.</span><span class="n">part</span><span class="p">;</span>
<span class="n">shm_zone</span> <span class="o">=</span> <span class="n">part</span><span class="o">-</span><span class="o">&gt;</span><span class="n">elts</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* void */</span> <span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">part</span><span class="o">-</span><span class="o">&gt;</span><span class="n">nelts</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">;</span>
        <span class="n">shm_zone</span> <span class="o">=</span> <span class="n">part</span><span class="o">-</span><span class="o">&gt;</span><span class="n">elts</span><span class="p">;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="sa"></span><span class="s">&#34;</span><span class="s">zero size shared memory zone </span><span class="se">\&#34;</span><span class="s">%V</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span>
                      <span class="o">&amp;</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">)</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">;</span>

    <span class="n">opart</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">old_cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shared_memory</span><span class="p">.</span><span class="n">part</span><span class="p">;</span>
    <span class="n">oshm_zone</span> <span class="o">=</span> <span class="n">opart</span><span class="o">-</span><span class="o">&gt;</span><span class="n">elts</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* void */</span> <span class="p">;</span> <span class="n">n</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">opart</span><span class="o">-</span><span class="o">&gt;</span><span class="n">nelts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">opart</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">opart</span> <span class="o">=</span> <span class="n">opart</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="n">oshm_zone</span> <span class="o">=</span> <span class="n">opart</span><span class="o">-</span><span class="o">&gt;</span><span class="n">elts</span><span class="p">;</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">len</span> <span class="o">!</span><span class="o">=</span> <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_strncmp</span><span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
            <span class="o">!</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span><span class="o">=</span> <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="p">.</span><span class="n">tag</span>
            <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span><span class="o">=</span> <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span>
            <span class="o">&amp;</span><span class="o">&amp;</span> <span class="o">!</span><span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">noreuse</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">shm_zone</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">oshm_zone</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="p">.</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>#if (NGX_WIN32)
                shm_zone[i].shm.handle = oshm_zone[n].shm.handle;
#endif

                if (shm_zone[i].init(&amp;shm_zone[i], oshm_zone[n].data)
                    != NGX_OK)
                {
                    goto failed;
                }

                goto shm_zone_found;
            }

            ngx_shm_free(&amp;oshm_zone[n].shm);

            break;
        }

        if (ngx_shm_alloc(&amp;shm_zone[i].shm) != NGX_OK) {
            goto failed;
        }

        if (ngx_init_zone_pool(cycle, &amp;shm_zone[i]) != NGX_OK) {
            goto failed;
        }

        if (shm_zone[i].init(&amp;shm_zone[i], NULL) != NGX_OK) {
            goto failed;
        }

    shm_zone_found:

        continue;
    }
</code></pre>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_cycle.c#L868-L930">nginx/src/core/ngx_cycle.c#L868-L930</a></p>
<p>下記の <code>ngx_init_zone_pool</code> 関数の905行目で <code>ngx_slab_pool_t</code> の <code>min_shift</code> が <code>3</code> に初期化されています。</p>
<p>927行目で <code>ngx_slab_init</code> 関数を呼び出しています。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">868
</span><span class="lnt">869
</span><span class="lnt">870
</span><span class="lnt">871
</span><span class="lnt">872
</span><span class="lnt">873
</span><span class="lnt">874
</span><span class="lnt">875
</span><span class="lnt">876
</span><span class="lnt">877
</span><span class="lnt">878
</span><span class="lnt">879
</span><span class="lnt">880
</span><span class="lnt">881
</span><span class="lnt">882
</span><span class="lnt">883
</span><span class="lnt">884
</span><span class="lnt">885
</span><span class="lnt">886
</span><span class="lnt">887
</span><span class="lnt">888
</span><span class="lnt">889
</span><span class="lnt">890
</span><span class="lnt">891
</span><span class="lnt">892
</span><span class="lnt">893
</span><span class="lnt">894
</span><span class="lnt">895
</span><span class="lnt">896
</span><span class="lnt">897
</span><span class="lnt">898
</span><span class="lnt">899
</span><span class="lnt">900
</span><span class="lnt">901
</span><span class="lnt">902
</span><span class="lnt">903
</span><span class="lnt">904
</span><span class="lnt">905
</span><span class="lnt">906
</span><span class="lnt">907
</span><span class="lnt">908
</span><span class="lnt">909
</span><span class="lnt">910
</span><span class="lnt">911
</span><span class="lnt">912
</span><span class="lnt">913
</span><span class="lnt">914
</span><span class="lnt">915
</span><span class="lnt">916
</span><span class="lnt">917
</span><span class="lnt">918
</span><span class="lnt">919
</span><span class="lnt">920
</span><span class="lnt">921
</span><span class="lnt">922
</span><span class="lnt">923
</span><span class="lnt">924
</span><span class="lnt">925
</span><span class="lnt">926
</span><span class="lnt">927
</span><span class="lnt">928
</span><span class="lnt">929
</span><span class="lnt">930
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">ngx_int_t</span>
<span class="nf">ngx_init_zone_pool</span><span class="p">(</span><span class="n">ngx_cycle_t</span> <span class="o">*</span><span class="n">cycle</span><span class="p">,</span> <span class="n">ngx_shm_zone_t</span> <span class="o">*</span><span class="n">zn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span>           <span class="o">*</span><span class="n">file</span><span class="p">;</span>
    <span class="n">ngx_slab_pool_t</span>  <span class="o">*</span><span class="n">sp</span><span class="p">;</span>

    <span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zn</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">zn</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">exists</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">=</span><span class="o">=</span> <span class="n">sp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
        <span class="p">}</span>

<span class="cp">#</span><span class="cp">if (NGX_WIN32)</span><span class="cp">
</span><span class="cp"></span>
        <span class="cm">/* remap at the required address */</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ngx_shm_remap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zn</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">,</span> <span class="n">sp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="o">!</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">zn</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sp</span> <span class="o">=</span><span class="o">=</span> <span class="n">sp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
        <span class="p">}</span>

<span class="cp">#</span><span class="cp">endif</span><span class="cp">
</span><span class="cp"></span>
        <span class="n">ngx_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                      <span class="sa"></span><span class="s">&#34;</span><span class="s">shared zone </span><span class="se">\&#34;</span><span class="s">%V</span><span class="se">\&#34;</span><span class="s"> has no equal addresses: %p vs %p</span><span class="s">&#34;</span><span class="p">,</span>
                      <span class="o">&amp;</span><span class="n">zn</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sp</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">zn</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span> <span class="o">+</span> <span class="n">zn</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
    <span class="n">sp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">min_shift</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">sp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">zn</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>

<span class="cp">#</span><span class="cp">if (NGX_HAVE_ATOMIC_OPS)</span><span class="cp">
</span><span class="cp"></span>
    <span class="n">file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#</span><span class="cp">else</span><span class="cp">
</span><span class="cp"></span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">ngx_pnalloc</span><span class="p">(</span><span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pool</span><span class="p">,</span> <span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">lock_file</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="n">zn</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ngx_sprintf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">%V%V%Z</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">lock_file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zn</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shm</span><span class="p">.</span><span class="n">name</span><span class="p">)</span><span class="p">;</span>

<span class="cp">#</span><span class="cp">endif</span><span class="cp">
</span><span class="cp"></span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ngx_shmtx_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">mutex</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">!</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ngx_slab_init</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L98-L165">nginx/src/core/ngx_slab.c#L98-L165</a></p>
<p>上記で <code>pool-&gt;min_shift</code> は <code>3</code> に設定されていますので、
107行目で <code>pool-&gt;min_size</code> は <code>8</code> になります。</p>
<p>116行目の <code>n</code> は <code>12 - 3</code> で <code>9</code> になります。</p>
<p>118行目以降はまた後で読むので、ここでは一旦スキップします。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">98
</span><span class="lnt">99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span>
<span class="nf">ngx_slab_init</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span>           <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="n">size_t</span>            <span class="n">size</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>         <span class="n">m</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">slots</span><span class="p">,</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">min_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">min_shift</span><span class="p">;</span>

    <span class="n">slots</span> <span class="o">=</span> <span class="n">ngx_slab_slots</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">slots</span><span class="p">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>

    <span class="n">ngx_slab_junk</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span><span class="p">;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">ngx_pagesize_shift</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">min_shift</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* only &#34;next&#34; is used in list head */</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">p</span> <span class="o">+</span><span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_stat_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_memzero</span><span class="p">(</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">+</span><span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">)</span><span class="p">;</span>

    <span class="n">size</span> <span class="o">-</span><span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

    <span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_uint_t</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_page_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_memzero</span><span class="p">(</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

    <span class="n">page</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pages</span><span class="p">;</span>

    <span class="cm">/* only &#34;next&#34; is used in list head */</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">;</span>
    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span><span class="p">,</span>
                                <span class="n">ngx_pagesize</span><span class="p">)</span><span class="p">;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">pages</span> <span class="o">-</span> <span class="p">(</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">ngx_pagesize</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pages</span> <span class="o">-</span><span class="o">=</span> <span class="n">m</span><span class="p">;</span>
        <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pages</span> <span class="o">+</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pfree</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log_nomem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">zero</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">\0</span><span class="sc">&#39;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上記の 109 行目で呼ばれている <code>ngx_slab_slots</code> は以下で定義されたマクロでした。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L44-L45">nginx/src/core/ngx_slab.c#L44-L45</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#</span><span class="cp">define ngx_slab_slots(pool)                                                  \</span><span class="cp">
</span><span class="cp"></span><span class="cp">    (ngx_slab_page_t *) ((u_char *) (pool) + sizeof(ngx_slab_pool_t))</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><p><code>ngx_slab_pool_t</code> 構造体のメモリを割り当てる際に、連続して <code>ngx_slab_page_t</code> 構造体のメモリも割り当ててそこを参照するということですね。</p>
<h2 id="ngxshareddict">ngx.shared.DICTのメソッドのコード</h2>
<p>代表として
<a href="https://github.com/openresty/lua-nginx-module#ngxshareddictadd">ngx.shared.DICT.add</a>
のコードを見ます。</p>
<p><code>add</code> メソッドは <code>ngx_http_lua_shdict_add</code> 関数で実装されています。</p>
<p><a href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_shdict.c#L347-L348">lua-nginx-module/src/ngx_http_lua_shdict.c#L347-L348</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">347
</span><span class="lnt">348
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="n">lua_pushcfunction</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">ngx_http_lua_shdict_add</span><span class="p">)</span><span class="p">;</span>
<span class="n">lua_setfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">add</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_shdict.c#L869-L873">lua-nginx-module/src/ngx_http_lua_shdict.c#L869-L873</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">869
</span><span class="lnt">870
</span><span class="lnt">871
</span><span class="lnt">872
</span><span class="lnt">873
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">int</span>
<span class="nf">ngx_http_lua_shdict_add</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">ngx_http_lua_shdict_set_helper</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">NGX_HTTP_LUA_SHDICT_ADD</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/openresty/lua-nginx-module/blob/97fbeb0bef1aa85e758210d58063376de8eaed31/src/ngx_http_lua_shdict.c#L905-L1246">lua-nginx-module/src/ngx_http_lua_shdict.c#L905-L1246</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">905
</span><span class="lnt">906
</span><span class="lnt">907
</span><span class="lnt">908
</span><span class="lnt">909
</span><span class="lnt">910
</span><span class="lnt">911
</span><span class="lnt">912
</span><span class="lnt">913
</span><span class="lnt">914
</span><span class="lnt">915
</span><span class="lnt">916
</span><span class="lnt">917
</span><span class="lnt">918
</span><span class="lnt">919
</span><span class="lnt">920
</span><span class="lnt">921
</span><span class="lnt">922
</span><span class="lnt">923
</span><span class="lnt">924
</span><span class="lnt">925
</span><span class="lnt">926
</span><span class="lnt">927
</span><span class="lnt">928
</span><span class="lnt">929
</span><span class="lnt">930
</span><span class="lnt">931
</span><span class="lnt">932
</span><span class="lnt">933
</span><span class="lnt">934
</span><span class="lnt">935
</span><span class="lnt">936
</span><span class="lnt">937
</span><span class="lnt">938
</span><span class="lnt">939
</span><span class="lnt">940
</span><span class="lnt">941
</span><span class="lnt">942
</span><span class="lnt">943
</span><span class="lnt">944
</span><span class="lnt">945
</span><span class="lnt">946
</span><span class="lnt">947
</span><span class="lnt">948
</span><span class="lnt">949
</span><span class="lnt">950
</span><span class="lnt">951
</span><span class="lnt">952
</span><span class="lnt">953
</span><span class="lnt">954
</span><span class="lnt">955
</span><span class="lnt">956
</span><span class="lnt">957
</span><span class="lnt">958
</span><span class="lnt">959
</span><span class="lnt">960
</span><span class="lnt">961
</span><span class="lnt">962
</span><span class="lnt">963
</span><span class="lnt">964
</span><span class="lnt">965
</span><span class="lnt">966
</span><span class="lnt">967
</span><span class="lnt">968
</span><span class="lnt">969
</span><span class="lnt">970
</span><span class="lnt">971
</span><span class="lnt">972
</span><span class="lnt">973
</span><span class="lnt">974
</span><span class="lnt">975
</span><span class="lnt">976
</span><span class="lnt">977
</span><span class="lnt">978
</span><span class="lnt">979
</span><span class="lnt">980
</span><span class="lnt">981
</span><span class="lnt">982
</span><span class="lnt">983
</span><span class="lnt">984
</span><span class="lnt">985
</span><span class="lnt">986
</span><span class="lnt">987
</span><span class="lnt">988
</span><span class="lnt">989
</span><span class="lnt">990
</span><span class="lnt">991
</span><span class="lnt">992
</span><span class="lnt">993
</span><span class="lnt">994
</span><span class="lnt">995
</span><span class="lnt">996
</span><span class="lnt">997
</span><span class="lnt">998
</span><span class="lnt">999
</span><span class="lnt">1000
</span><span class="lnt">1001
</span><span class="lnt">1002
</span><span class="lnt">1003
</span><span class="lnt">1004
</span><span class="lnt">1005
</span><span class="lnt">1006
</span><span class="lnt">1007
</span><span class="lnt">1008
</span><span class="lnt">1009
</span><span class="lnt">1010
</span><span class="lnt">1011
</span><span class="lnt">1012
</span><span class="lnt">1013
</span><span class="lnt">1014
</span><span class="lnt">1015
</span><span class="lnt">1016
</span><span class="lnt">1017
</span><span class="lnt">1018
</span><span class="lnt">1019
</span><span class="lnt">1020
</span><span class="lnt">1021
</span><span class="lnt">1022
</span><span class="lnt">1023
</span><span class="lnt">1024
</span><span class="lnt">1025
</span><span class="lnt">1026
</span><span class="lnt">1027
</span><span class="lnt">1028
</span><span class="lnt">1029
</span><span class="lnt">1030
</span><span class="lnt">1031
</span><span class="lnt">1032
</span><span class="lnt">1033
</span><span class="lnt">1034
</span><span class="lnt">1035
</span><span class="lnt">1036
</span><span class="lnt">1037
</span><span class="lnt">1038
</span><span class="lnt">1039
</span><span class="lnt">1040
</span><span class="lnt">1041
</span><span class="lnt">1042
</span><span class="lnt">1043
</span><span class="lnt">1044
</span><span class="lnt">1045
</span><span class="lnt">1046
</span><span class="lnt">1047
</span><span class="lnt">1048
</span><span class="lnt">1049
</span><span class="lnt">1050
</span><span class="lnt">1051
</span><span class="lnt">1052
</span><span class="lnt">1053
</span><span class="lnt">1054
</span><span class="lnt">1055
</span><span class="lnt">1056
</span><span class="lnt">1057
</span><span class="lnt">1058
</span><span class="lnt">1059
</span><span class="lnt">1060
</span><span class="lnt">1061
</span><span class="lnt">1062
</span><span class="lnt">1063
</span><span class="lnt">1064
</span><span class="lnt">1065
</span><span class="lnt">1066
</span><span class="lnt">1067
</span><span class="lnt">1068
</span><span class="lnt">1069
</span><span class="lnt">1070
</span><span class="lnt">1071
</span><span class="lnt">1072
</span><span class="lnt">1073
</span><span class="lnt">1074
</span><span class="lnt">1075
</span><span class="lnt">1076
</span><span class="lnt">1077
</span><span class="lnt">1078
</span><span class="lnt">1079
</span><span class="lnt">1080
</span><span class="lnt">1081
</span><span class="lnt">1082
</span><span class="lnt">1083
</span><span class="lnt">1084
</span><span class="lnt">1085
</span><span class="lnt">1086
</span><span class="lnt">1087
</span><span class="lnt">1088
</span><span class="lnt">1089
</span><span class="lnt">1090
</span><span class="lnt">1091
</span><span class="lnt">1092
</span><span class="lnt">1093
</span><span class="lnt">1094
</span><span class="lnt">1095
</span><span class="lnt">1096
</span><span class="lnt">1097
</span><span class="lnt">1098
</span><span class="lnt">1099
</span><span class="lnt">1100
</span><span class="lnt">1101
</span><span class="lnt">1102
</span><span class="lnt">1103
</span><span class="lnt">1104
</span><span class="lnt">1105
</span><span class="lnt">1106
</span><span class="lnt">1107
</span><span class="lnt">1108
</span><span class="lnt">1109
</span><span class="lnt">1110
</span><span class="lnt">1111
</span><span class="lnt">1112
</span><span class="lnt">1113
</span><span class="lnt">1114
</span><span class="lnt">1115
</span><span class="lnt">1116
</span><span class="lnt">1117
</span><span class="lnt">1118
</span><span class="lnt">1119
</span><span class="lnt">1120
</span><span class="lnt">1121
</span><span class="lnt">1122
</span><span class="lnt">1123
</span><span class="lnt">1124
</span><span class="lnt">1125
</span><span class="lnt">1126
</span><span class="lnt">1127
</span><span class="lnt">1128
</span><span class="lnt">1129
</span><span class="lnt">1130
</span><span class="lnt">1131
</span><span class="lnt">1132
</span><span class="lnt">1133
</span><span class="lnt">1134
</span><span class="lnt">1135
</span><span class="lnt">1136
</span><span class="lnt">1137
</span><span class="lnt">1138
</span><span class="lnt">1139
</span><span class="lnt">1140
</span><span class="lnt">1141
</span><span class="lnt">1142
</span><span class="lnt">1143
</span><span class="lnt">1144
</span><span class="lnt">1145
</span><span class="lnt">1146
</span><span class="lnt">1147
</span><span class="lnt">1148
</span><span class="lnt">1149
</span><span class="lnt">1150
</span><span class="lnt">1151
</span><span class="lnt">1152
</span><span class="lnt">1153
</span><span class="lnt">1154
</span><span class="lnt">1155
</span><span class="lnt">1156
</span><span class="lnt">1157
</span><span class="lnt">1158
</span><span class="lnt">1159
</span><span class="lnt">1160
</span><span class="lnt">1161
</span><span class="lnt">1162
</span><span class="lnt">1163
</span><span class="lnt">1164
</span><span class="lnt">1165
</span><span class="lnt">1166
</span><span class="lnt">1167
</span><span class="lnt">1168
</span><span class="lnt">1169
</span><span class="lnt">1170
</span><span class="lnt">1171
</span><span class="lnt">1172
</span><span class="lnt">1173
</span><span class="lnt">1174
</span><span class="lnt">1175
</span><span class="lnt">1176
</span><span class="lnt">1177
</span><span class="lnt">1178
</span><span class="lnt">1179
</span><span class="lnt">1180
</span><span class="lnt">1181
</span><span class="lnt">1182
</span><span class="lnt">1183
</span><span class="lnt">1184
</span><span class="lnt">1185
</span><span class="lnt">1186
</span><span class="lnt">1187
</span><span class="lnt">1188
</span><span class="lnt">1189
</span><span class="lnt">1190
</span><span class="lnt">1191
</span><span class="lnt">1192
</span><span class="lnt">1193
</span><span class="lnt">1194
</span><span class="lnt">1195
</span><span class="lnt">1196
</span><span class="lnt">1197
</span><span class="lnt">1198
</span><span class="lnt">1199
</span><span class="lnt">1200
</span><span class="lnt">1201
</span><span class="lnt">1202
</span><span class="lnt">1203
</span><span class="lnt">1204
</span><span class="lnt">1205
</span><span class="lnt">1206
</span><span class="lnt">1207
</span><span class="lnt">1208
</span><span class="lnt">1209
</span><span class="lnt">1210
</span><span class="lnt">1211
</span><span class="lnt">1212
</span><span class="lnt">1213
</span><span class="lnt">1214
</span><span class="lnt">1215
</span><span class="lnt">1216
</span><span class="lnt">1217
</span><span class="lnt">1218
</span><span class="lnt">1219
</span><span class="lnt">1220
</span><span class="lnt">1221
</span><span class="lnt">1222
</span><span class="lnt">1223
</span><span class="lnt">1224
</span><span class="lnt">1225
</span><span class="lnt">1226
</span><span class="lnt">1227
</span><span class="lnt">1228
</span><span class="lnt">1229
</span><span class="lnt">1230
</span><span class="lnt">1231
</span><span class="lnt">1232
</span><span class="lnt">1233
</span><span class="lnt">1234
</span><span class="lnt">1235
</span><span class="lnt">1236
</span><span class="lnt">1237
</span><span class="lnt">1238
</span><span class="lnt">1239
</span><span class="lnt">1240
</span><span class="lnt">1241
</span><span class="lnt">1242
</span><span class="lnt">1243
</span><span class="lnt">1244
</span><span class="lnt">1245
</span><span class="lnt">1246
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">int</span>
<span class="nf">ngx_http_lua_shdict_set_helper</span><span class="p">(</span><span class="n">lua_State</span> <span class="o">*</span><span class="n">L</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span>                          <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>                    <span class="n">key</span><span class="p">;</span>
    <span class="n">uint32_t</span>                     <span class="n">hash</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>                    <span class="n">rc</span><span class="p">;</span>
    <span class="n">ngx_http_lua_shdict_ctx_t</span>   <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
    <span class="n">ngx_http_lua_shdict_node_t</span>  <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
    <span class="n">ngx_str_t</span>                    <span class="n">value</span><span class="p">;</span>
    <span class="kt">int</span>                          <span class="n">value_type</span><span class="p">;</span>
    <span class="kt">double</span>                       <span class="n">num</span><span class="p">;</span>
    <span class="n">u_char</span>                       <span class="n">c</span><span class="p">;</span>
    <span class="n">lua_Number</span>                   <span class="n">exptime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">u_char</span>                      <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_rbtree_node_t</span>           <span class="o">*</span><span class="n">node</span><span class="p">;</span>
    <span class="n">ngx_time_t</span>                  <span class="o">*</span><span class="n">tp</span><span class="p">;</span>
    <span class="n">ngx_shm_zone_t</span>              <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
    <span class="kt">int</span>                          <span class="n">forcible</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                         <span class="cm">/* indicates whether to foricibly override other
</span><span class="cm">                          * valid entries */</span>
    <span class="n">int32_t</span>                      <span class="n">user_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ngx_queue_t</span>                 <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">lua_gettop</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!</span><span class="o">=</span> <span class="mi">3</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">n</span> <span class="o">!</span><span class="o">=</span> <span class="mi">4</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">n</span> <span class="o">!</span><span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">expecting 3, 4 or 5 arguments, </span><span class="s">&#34;</span>
                          <span class="sa"></span><span class="s">&#34;</span><span class="s">but only seen %d</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lua_type</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!</span><span class="o">=</span> <span class="n">LUA_TTABLE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">bad </span><span class="se">\&#34;</span><span class="s">zone</span><span class="se">\&#34;</span><span class="s"> argument</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">zone</span> <span class="o">=</span> <span class="n">ngx_http_lua_shdict_get_zone</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">zone</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">bad </span><span class="se">\&#34;</span><span class="s">zone</span><span class="se">\&#34;</span><span class="s"> argument</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ctx</span> <span class="o">=</span> <span class="n">zone</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">lua_isnil</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="p">;</span>
        <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">nil key</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">key</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">luaL_checklstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="p">;</span>
        <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">empty key</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="p">;</span>
        <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">key too long</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">hash</span> <span class="o">=</span> <span class="n">ngx_crc32_short</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="p">;</span>

    <span class="n">value_type</span> <span class="o">=</span> <span class="n">lua_type</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">value_type</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">case</span> <span class="nl">SHDICT_TSTRING</span><span class="p">:</span>
        <span class="n">value</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lua_tolstring</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">SHDICT_TNUMBER</span><span class="p">:</span>
        <span class="n">value</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="p">;</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">lua_tonumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="p">;</span>
        <span class="n">value</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">num</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">SHDICT_TBOOLEAN</span><span class="p">:</span>
        <span class="n">value</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u_char</span><span class="p">)</span><span class="p">;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">lua_toboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">value</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="nl">LUA_TNIL</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NGX_HTTP_LUA_SHDICT_ADD</span><span class="o">|</span><span class="n">NGX_HTTP_LUA_SHDICT_REPLACE</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="p">;</span>
            <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">attempt to add or replace nil values</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ngx_str_null</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">)</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>

    <span class="k">default</span><span class="o">:</span>
        <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="p">;</span>
        <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">bad value type</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span><span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">exptime</span> <span class="o">=</span> <span class="n">luaL_checknumber</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">luaL_error</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">bad </span><span class="se">\&#34;</span><span class="s">exptime</span><span class="se">\&#34;</span><span class="s"> argument</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span><span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">user_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="n">luaL_checkinteger</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ngx_shmtx_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">mutex</span><span class="p">)</span><span class="p">;</span>

<span class="cp">#</span><span class="cp">if 1</span><span class="cp">
</span><span class="cp"></span>    <span class="n">ngx_http_lua_shdict_expire</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>
<span class="cp">#</span><span class="cp">endif</span><span class="cp">
</span><span class="cp"></span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">ngx_http_lua_shdict_lookup</span><span class="p">(</span><span class="n">zone</span><span class="p">,</span> <span class="n">hash</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="p">)</span><span class="p">;</span>

    <span class="n">dd</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">shdict lookup returned %d</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rc</span><span class="p">)</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NGX_HTTP_LUA_SHDICT_REPLACE</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span><span class="o">=</span> <span class="n">NGX_DECLINED</span> <span class="o">|</span><span class="o">|</span> <span class="n">rc</span> <span class="o">=</span><span class="o">=</span> <span class="n">NGX_DONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">mutex</span><span class="p">)</span><span class="p">;</span>

            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="p">;</span>
            <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">not found</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">forcible</span><span class="p">)</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* rc == NGX_OK */</span>

        <span class="k">goto</span> <span class="n">replace</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NGX_HTTP_LUA_SHDICT_ADD</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span><span class="o">=</span> <span class="n">NGX_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">mutex</span><span class="p">)</span><span class="p">;</span>

            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="p">;</span>
            <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">exists</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">forcible</span><span class="p">)</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span><span class="o">=</span> <span class="n">NGX_DONE</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* exists but expired */</span>

            <span class="n">dd</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">go to replace</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
            <span class="k">goto</span> <span class="n">replace</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* rc == NGX_DECLINED */</span>

        <span class="n">dd</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">go to insert</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">insert</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span><span class="o">=</span> <span class="n">NGX_OK</span> <span class="o">|</span><span class="o">|</span> <span class="n">rc</span> <span class="o">=</span><span class="o">=</span> <span class="n">NGX_DONE</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">value_type</span> <span class="o">=</span><span class="o">=</span> <span class="n">LUA_TNIL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">remove</span><span class="p">;</span>
        <span class="p">}</span>

<span class="nl">replace</span><span class="p">:</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">data</span>
            <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span><span class="o">=</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span> <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">value_len</span>
            <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">value_type</span> <span class="o">!</span><span class="o">=</span> <span class="n">SHDICT_TLIST</span><span class="p">)</span>
        <span class="p">{</span>

            <span class="n">ngx_log_debug0</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_HTTP</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="sa"></span><span class="s">&#34;</span><span class="s">lua shared dict set: found old entry and value </span><span class="s">&#34;</span>
                           <span class="sa"></span><span class="s">&#34;</span><span class="s">size matched, reusing it</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>

            <span class="n">ngx_queue_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">queue</span><span class="p">)</span><span class="p">;</span>
            <span class="n">ngx_queue_insert_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">sh</span><span class="o">-</span><span class="o">&gt;</span><span class="n">lru_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">queue</span><span class="p">)</span><span class="p">;</span>

            <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="n">ngx_timeofday</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
                <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span> <span class="n">tp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">sec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">msec</span>
                              <span class="o">+</span> <span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="p">;</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">user_flags</span> <span class="o">=</span> <span class="n">user_flags</span><span class="p">;</span>

            <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">value_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

            <span class="n">dd</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">setting value type to %d</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">value_type</span><span class="p">)</span><span class="p">;</span>

            <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">value_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint8_t</span><span class="p">)</span> <span class="n">value_type</span><span class="p">;</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_copy</span><span class="p">(</span><span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="p">;</span>
            <span class="n">ngx_memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="p">;</span>

            <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">mutex</span><span class="p">)</span><span class="p">;</span>

            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>
            <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="p">;</span>
            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">forcible</span><span class="p">)</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ngx_log_debug0</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_HTTP</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                       <span class="sa"></span><span class="s">&#34;</span><span class="s">lua shared dict set: found old entry but value size </span><span class="s">&#34;</span>
                       <span class="sa"></span><span class="s">&#34;</span><span class="s">NOT matched, removing it first</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>

<span class="nl">remove</span><span class="p">:</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">value_type</span> <span class="o">=</span><span class="o">=</span> <span class="n">SHDICT_TLIST</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">queue</span> <span class="o">=</span> <span class="n">ngx_http_lua_shdict_get_list_head</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">ngx_queue_head</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span><span class="p">;</span>
                 <span class="n">q</span> <span class="o">!</span><span class="o">=</span> <span class="n">ngx_queue_sentinel</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span><span class="p">;</span>
                 <span class="n">q</span> <span class="o">=</span> <span class="n">ngx_queue_next</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">ngx_queue_data</span><span class="p">(</span><span class="n">q</span><span class="p">,</span>
                                              <span class="n">ngx_http_lua_shdict_list_node_t</span><span class="p">,</span>
                                              <span class="n">queue</span><span class="p">)</span><span class="p">;</span>

                <span class="n">ngx_slab_free_locked</span><span class="p">(</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">ngx_queue_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">queue</span><span class="p">)</span><span class="p">;</span>

        <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_rbtree_node_t</span> <span class="o">*</span><span class="p">)</span>
                   <span class="p">(</span><span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sd</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_rbtree_node_t</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

        <span class="n">ngx_rbtree_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">sh</span><span class="o">-</span><span class="o">&gt;</span><span class="n">rbtree</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span><span class="p">;</span>

        <span class="n">ngx_slab_free_locked</span><span class="p">(</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span><span class="p">;</span>

    <span class="p">}</span>

<span class="nl">insert</span><span class="p">:</span>

    <span class="cm">/* rc == NGX_DECLINED or value size unmatch */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">mutex</span><span class="p">)</span><span class="p">;</span>

        <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>
        <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="p">;</span>
        <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ngx_log_debug0</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_HTTP</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                   <span class="sa"></span><span class="s">&#34;</span><span class="s">lua shared dict set: creating a new entry</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_rbtree_node_t</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_http_lua_shdict_node_t</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span>
        <span class="o">+</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

    <span class="n">dd</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">overhead = %d</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_rbtree_node_t</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
       <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">ngx_http_lua_shdict_node_t</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">ngx_slab_alloc_locked</span><span class="p">(</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NGX_HTTP_LUA_SHDICT_SAFE_STORE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">mutex</span><span class="p">)</span><span class="p">;</span>

            <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="p">;</span>
            <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">no memory</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_HTTP</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                       <span class="sa"></span><span class="s">&#34;</span><span class="s">lua shared dict set: overriding non-expired items </span><span class="s">&#34;</span>
                       <span class="sa"></span><span class="s">&#34;</span><span class="s">due to memory shortage for entry </span><span class="se">\&#34;</span><span class="s">%V</span><span class="se">\&#34;</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">)</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ngx_http_lua_shdict_expire</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">=</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">forcible</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="n">node</span> <span class="o">=</span> <span class="n">ngx_slab_alloc_locked</span><span class="p">(</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">goto</span> <span class="n">allocated</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">mutex</span><span class="p">)</span><span class="p">;</span>

        <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="p">;</span>
        <span class="n">lua_pushliteral</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">no memory</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">forcible</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nl">allocated</span><span class="p">:</span>

    <span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_http_lua_shdict_node_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">node</span><span class="o">-</span><span class="o">&gt;</span><span class="n">color</span><span class="p">;</span>

    <span class="n">node</span><span class="o">-</span><span class="o">&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">hash</span><span class="p">;</span>
    <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">tp</span> <span class="o">=</span> <span class="n">ngx_timeofday</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
        <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span> <span class="n">tp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">sec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">tp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">msec</span>
                      <span class="o">+</span> <span class="p">(</span><span class="n">uint64_t</span><span class="p">)</span> <span class="p">(</span><span class="n">exptime</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">user_flags</span> <span class="o">=</span> <span class="n">user_flags</span><span class="p">;</span>

    <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">value_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint32_t</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>

    <span class="n">dd</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">setting value type to %d</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">value_type</span><span class="p">)</span><span class="p">;</span>

    <span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">value_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint8_t</span><span class="p">)</span> <span class="n">value_type</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_copy</span><span class="p">(</span><span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="p">;</span>
    <span class="n">ngx_memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="p">;</span>

    <span class="n">ngx_rbtree_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">sh</span><span class="o">-</span><span class="o">&gt;</span><span class="n">rbtree</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span><span class="p">;</span>

    <span class="n">ngx_queue_insert_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">sh</span><span class="o">-</span><span class="o">&gt;</span><span class="n">lru_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-</span><span class="o">&gt;</span><span class="n">queue</span><span class="p">)</span><span class="p">;</span>

    <span class="n">ngx_shmtx_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-</span><span class="o">&gt;</span><span class="n">shpool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">mutex</span><span class="p">)</span><span class="p">;</span>

    <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>
    <span class="n">lua_pushnil</span><span class="p">(</span><span class="n">L</span><span class="p">)</span><span class="p">;</span>
    <span class="n">lua_pushboolean</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">forcible</span><span class="p">)</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上記の1148行目の <code>insert:</code> ラベルの後の1172行目で <code>ngx_slab_alloc_locked</code> 関数を呼び出しています。</p>
<p>1164行目でメモリ割り当てするバイト数を計算しています。ログ出力を追加して動作確認したところ
<code>offsetof(ngx_rbtree_node_t, color)</code> は32、
<code>offsetof(ngx_http_lua_shdict_node_t, data)</code> は36 でした。</p>
<p><code>ngx_slab_alloc_locked</code> 関数の実装は以下の通りです。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L183-L417">nginx/src/core/ngx_slab.c#L183-L417</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="o">*</span>
<span class="nf">ngx_slab_alloc_locked</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">size_t</span>            <span class="n">s</span><span class="p">;</span>
    <span class="n">uintptr_t</span>         <span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">map</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="o">*</span><span class="n">slots</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">ngx_slab_max_size</span><span class="p">)</span> <span class="p">{</span>

        <span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span> <span class="n">ngx_cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                       <span class="sa"></span><span class="s">&#34;</span><span class="s">slab alloc: %uz</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span><span class="p">;</span>

        <span class="n">page</span> <span class="o">=</span> <span class="n">ngx_slab_alloc_pages</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">ngx_pagesize_shift</span><span class="p">)</span>
                                          <span class="o">+</span> <span class="p">(</span><span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="n">ngx_pagesize</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span><span class="p">;</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">min_size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">s</span> <span class="o">&gt;</span><span class="o">&gt;</span><span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">shift</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* void */</span> <span class="p">}</span>
        <span class="n">slot</span> <span class="o">=</span> <span class="n">shift</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">min_shift</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">min_shift</span><span class="p">;</span>
        <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">reqs</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>

    <span class="n">ngx_log_debug2</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span> <span class="n">ngx_cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                   <span class="sa"></span><span class="s">&#34;</span><span class="s">slab alloc: %uz slot: %ui</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">slot</span><span class="p">)</span><span class="p">;</span>

    <span class="n">slots</span> <span class="o">=</span> <span class="n">ngx_slab_slots</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span><span class="p">;</span>
    <span class="n">page</span> <span class="o">=</span> <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">!</span><span class="o">=</span> <span class="n">page</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="n">ngx_slab_exact_shift</span><span class="p">)</span> <span class="p">{</span>

            <span class="n">bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span><span class="p">;</span>

            <span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">map</span><span class="p">;</span> <span class="n">n</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!</span><span class="o">=</span> <span class="n">NGX_SLAB_BUSY</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span><span class="o">&lt;</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">continue</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="n">bitmap</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">|</span><span class="o">=</span> <span class="n">m</span><span class="p">;</span>

                        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">shift</span><span class="p">;</span>

                        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="n">bitmap</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

                        <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">used</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span><span class="o">=</span> <span class="n">NGX_SLAB_BUSY</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">map</span><span class="p">;</span> <span class="n">n</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">!</span><span class="o">=</span> <span class="n">NGX_SLAB_BUSY</span><span class="p">)</span> <span class="p">{</span>
                                    <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>

                            <span class="n">prev</span> <span class="o">=</span> <span class="n">ngx_slab_page_prev</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="p">;</span>
                            <span class="n">prev</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">;</span>
                            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span><span class="p">;</span>

                            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">NGX_SLAB_SMALL</span><span class="p">;</span>
                        <span class="p">}</span>

                        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">=</span><span class="o">=</span> <span class="n">ngx_slab_exact_shift</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span><span class="o">&lt;</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">|</span><span class="o">=</span> <span class="n">m</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">=</span><span class="o">=</span> <span class="n">NGX_SLAB_BUSY</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">prev</span> <span class="o">=</span> <span class="n">ngx_slab_page_prev</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="p">;</span>
                    <span class="n">prev</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">;</span>
                    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span><span class="p">;</span>

                    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">NGX_SLAB_EXACT</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">shift</span><span class="p">)</span><span class="p">;</span>

                <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">used</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>

                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
            <span class="p">}</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* shift &gt; ngx_slab_exact_shift */</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">shift</span><span class="p">)</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">mask</span> <span class="o">&lt;</span><span class="o">&lt;</span><span class="o">=</span> <span class="n">NGX_SLAB_MAP_SHIFT</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">NGX_SLAB_MAP_SHIFT</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                 <span class="n">m</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
                 <span class="n">m</span> <span class="o">&lt;</span><span class="o">&lt;</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">continue</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">|</span><span class="o">=</span> <span class="n">m</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="p">(</span><span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">&amp;</span> <span class="n">NGX_SLAB_MAP_MASK</span><span class="p">)</span> <span class="o">=</span><span class="o">=</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">prev</span> <span class="o">=</span> <span class="n">ngx_slab_page_prev</span><span class="p">(</span><span class="n">page</span><span class="p">)</span><span class="p">;</span>
                    <span class="n">prev</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">;</span>
                    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span><span class="p">;</span>

                    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">NGX_SLAB_BIG</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">shift</span><span class="p">)</span><span class="p">;</span>

                <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">used</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>

                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">ngx_slab_error</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">NGX_LOG_ALERT</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">ngx_slab_alloc(): page is busy</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="n">ngx_debug_point</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">page</span> <span class="o">=</span> <span class="n">ngx_slab_alloc_pages</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="n">ngx_slab_exact_shift</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">bitmap</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span><span class="p">;</span>

            <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="cm">/* &#34;n&#34; elements for bitmap, plus one requested */</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bitmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NGX_SLAB_BUSY</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="p">(</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">bitmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>

            <span class="n">map</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">map</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">bitmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">shift</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">|</span> <span class="n">NGX_SLAB_SMALL</span><span class="p">;</span>

            <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">total</span> <span class="o">+</span><span class="o">=</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span><span class="p">;</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">shift</span><span class="p">)</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">used</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>

            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">=</span><span class="o">=</span> <span class="n">ngx_slab_exact_shift</span><span class="p">)</span> <span class="p">{</span>

            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">|</span> <span class="n">NGX_SLAB_EXACT</span><span class="p">;</span>

            <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">total</span> <span class="o">+</span><span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span><span class="p">;</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">used</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>

            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* shift &gt; ngx_slab_exact_shift */</span>

            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="p">(</span><span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">NGX_SLAB_MAP_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">shift</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span> <span class="o">|</span> <span class="n">NGX_SLAB_BIG</span><span class="p">;</span>

            <span class="n">slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">total</span> <span class="o">+</span><span class="o">=</span> <span class="n">ngx_pagesize</span> <span class="o">&gt;</span><span class="o">&gt;</span> <span class="n">shift</span><span class="p">;</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_slab_page_addr</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">used</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>

            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span><span class="p">.</span><span class="n">fails</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>

<span class="nl">done</span><span class="p">:</span>

    <span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span> <span class="n">ngx_cycle</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                   <span class="sa"></span><span class="s">&#34;</span><span class="s">slab alloc: %p</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">)</span><span class="p">;</span>

    <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ngx_slab_max_size</code> は上記のように 2048 なのでそれより大きいサイズを割り当てる場合は
191行目の if の条件が true になり、193～205行目で処理されることになります。</p>
<p>2048バイト以下のサイズの場合は 208行目以降で処理されます。
<code>pool-&gt;min_size</code> は8なので、8バイトより大きい場合は209～211行目、8バイト以下なら214～215行目の分岐になります。</p>
<p><code>size</code> が8以下なら <code>slot</code> は 0, <code>shift</code> は3になります。
<code>size</code> が9～16なら <code>slot</code> は 1, <code>shift</code> は4になります。
<code>size</code> が17～32なら <code>slot</code> は 2, <code>shift</code> は5になります。
以下同様に2倍になるごとに <code>slot</code> と <code>shift</code> が増えていき、
最後は <code>size</code> が1025～2048 で <code>slot</code> が 8, <code>shift</code> が11になります。</p>
<p>218行目でスロット毎のメモリ割り当て依頼回数をインクリメントしています。</p>
<p>226～330行目では既存のページを再利用しているようです。249、291、322行目でスロット毎の使用中カウンタ <code>pool-&gt;stats[slot].used</code> をインクリメントしています。</p>
<p>332行目では <code>ngx_slab_alloc_pages</code> 関数を呼んで新たにページを割り当てています。</p>
<p>334～405行目では <code>pool-&gt;stats[slot].used</code> をインクリメントしつつ、スロット毎の使用バイト数 <code>pool-&gt;stats[slot].total</code> も増やしています。</p>
<p>405行目までの処理で正常に割り当てできた場合は 411行目の <code>done</code> ラベルに飛びます。
失敗した場合は409行目でスロット毎の失敗回数 <code>pool-&gt;stats[slot].fails</code> をインクリメントしています。</p>
<p><code>ngx_slab_alloc_pages</code> 関数の実装は以下の通りです。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L678-L731">nginx/src/core/ngx_slab.c#L678-L731</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span><span class="lnt">713
</span><span class="lnt">714
</span><span class="lnt">715
</span><span class="lnt">716
</span><span class="lnt">717
</span><span class="lnt">718
</span><span class="lnt">719
</span><span class="lnt">720
</span><span class="lnt">721
</span><span class="lnt">722
</span><span class="lnt">723
</span><span class="lnt">724
</span><span class="lnt">725
</span><span class="lnt">726
</span><span class="lnt">727
</span><span class="lnt">728
</span><span class="lnt">729
</span><span class="lnt">730
</span><span class="lnt">731
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">ngx_slab_page_t</span> <span class="o">*</span>
<span class="nf">ngx_slab_alloc_pages</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="n">ngx_uint_t</span> <span class="n">pages</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">next</span><span class="p">;</span> <span class="n">page</span> <span class="o">!</span><span class="o">=</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">;</span> <span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">pages</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">&gt;</span> <span class="n">pages</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">page</span><span class="p">[</span><span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span><span class="p">;</span>

                <span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span><span class="p">.</span><span class="n">slab</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">-</span> <span class="n">pages</span><span class="p">;</span>
                <span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span><span class="p">;</span>

                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_page_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span><span class="p">;</span>
                <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span><span class="p">;</span>
                <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">page</span><span class="p">[</span><span class="n">pages</span><span class="p">]</span><span class="p">;</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_page_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span><span class="p">;</span>
                <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">;</span>
                <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">pages</span> <span class="o">|</span> <span class="n">NGX_SLAB_PAGE_START</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">NGX_SLAB_PAGE</span><span class="p">;</span>

            <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pfree</span> <span class="o">-</span><span class="o">=</span> <span class="n">pages</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="o">-</span><span class="n">pages</span> <span class="o">=</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">page</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">pages</span><span class="p">;</span> <span class="n">pages</span><span class="o">-</span><span class="o">-</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">NGX_SLAB_PAGE_BUSY</span><span class="p">;</span>
                <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">NGX_SLAB_PAGE</span><span class="p">;</span>
                <span class="n">p</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">page</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log_nomem</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_slab_error</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">NGX_LOG_CRIT</span><span class="p">,</span>
                       <span class="sa"></span><span class="s">&#34;</span><span class="s">ngx_slab_alloc() failed: no memory</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>ngx_slab_pool_t *</code> 型の <code>pool</code> の <code>pool-&gt;free</code> は <code>ngx_slab_page_t</code> 型になっています。上に書いていますが再度引用します。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.h#L16-L22">nginx/src/core/ngx_slab.h#L16-L22</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ngx_slab_page_s</span>  <span class="n">ngx_slab_page_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ngx_slab_page_s</span> <span class="p">{</span>
    <span class="n">uintptr_t</span>         <span class="n">slab</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="n">uintptr_t</span>         <span class="n">prev</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>next</code> と <code>prev</code> フィールドで双方向リンクトリストになっています。
683行目の <code>for</code> 文を見るとリストの最後の要素では <code>next</code> を自分自身に指すようになっているようです。</p>
<p><code>slab</code> フィールドは <code>uintptr_t</code> 型で685行目ではページ数と比較しています。</p>
<p>704～719行目を見ると複数のページがメモリ上に連続して存在して、ページ割り付けの際に複数ページを使用する場合は、最初のページの <code>slab</code> フィールドにはページ数に <code>NGX_SLAB_PAGE_START</code> のフラグを追加し、継続するページの <code>slab</code> フィールドには <code>NGX_SLAB_PAGE_BUSY</code> を設定しています。</p>
<p><code>NGX_SLAB_PAGE_START</code> や <code>NGX_SLAB_PAGE_BUSY</code> の定数は以下のように定義されています。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/core/ngx_slab.c#L17-L41">nginx/src/core/ngx_slab.c#L17-L41</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#</span><span class="cp">if (NGX_PTR_SIZE == 4)</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#</span><span class="cp">define NGX_SLAB_PAGE_FREE   0</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define NGX_SLAB_PAGE_BUSY   0xffffffff</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define NGX_SLAB_PAGE_START  0x80000000</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#</span><span class="cp">define NGX_SLAB_SHIFT_MASK  0x0000000f</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define NGX_SLAB_MAP_MASK    0xffff0000</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define NGX_SLAB_MAP_SHIFT   16</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#</span><span class="cp">define NGX_SLAB_BUSY        0xffffffff</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#</span><span class="cp">else </span><span class="cm">/* (NGX_PTR_SIZE == 8) */</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#</span><span class="cp">define NGX_SLAB_PAGE_FREE   0</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define NGX_SLAB_PAGE_BUSY   0xffffffffffffffff</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define NGX_SLAB_PAGE_START  0x8000000000000000</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#</span><span class="cp">define NGX_SLAB_SHIFT_MASK  0x000000000000000f</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define NGX_SLAB_MAP_MASK    0xffffffff00000000</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define NGX_SLAB_MAP_SHIFT   32</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#</span><span class="cp">define NGX_SLAB_BUSY        0xffffffffffffffff</span><span class="cp">
</span><span class="cp"></span>
<span class="cp">#</span><span class="cp">endif</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><p><code>ngx_slab_alloc_pages</code> 関数のコードを改めて眺めてみると、この関数内では新たなメモリ割り当ては行っていないことに気づきます。
ということは <code>pool</code> の作成時に <code>pool-&gt;free</code> に割り当てられたメモリを使いまわしているだけということです。</p>
<p>遡って見てみると ngx_cycle.c の478行目で呼び出している <code>ngx_shm_alloc</code> 関数が
<a href="http://man7.org/linux/man-pages/man2/mmap.2.html">mmap(2)</a> システムコールを使ってメモリを割り当てていました。</p>
<p>OSによっては <code>ngx_shmem.c</code> の <code>#if</code> の違う分岐になりますが、Linuxでは上記の <code>mmap(2)</code> のマニュアルに <code>MAP_ANON</code> が deprecated ですが存在したので、Linuxでは下記の実装が使われていると思います。</p>
<p><a href="https://github.com/nginx/nginx/blob/release-1.13.5/src/os/unix/ngx_shmem.c#L12-L28">nginx/src/os/unix/ngx_shmem.c#L12-L28</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#</span><span class="cp">if (NGX_HAVE_MAP_ANON)</span><span class="cp">
</span><span class="cp"></span>
<span class="n">ngx_int_t</span>
<span class="nf">ngx_shm_alloc</span><span class="p">(</span><span class="n">ngx_shm_t</span> <span class="o">*</span><span class="n">shm</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">shm</span><span class="o">-</span><span class="o">&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">shm</span><span class="o">-</span><span class="o">&gt;</span><span class="n">size</span><span class="p">,</span>
                                <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span>
                                <span class="n">MAP_ANON</span><span class="o">|</span><span class="n">MAP_SHARED</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">shm</span><span class="o">-</span><span class="o">&gt;</span><span class="n">addr</span> <span class="o">=</span><span class="o">=</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_log_error</span><span class="p">(</span><span class="n">NGX_LOG_ALERT</span><span class="p">,</span> <span class="n">shm</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log</span><span class="p">,</span> <span class="n">ngx_errno</span><span class="p">,</span>
                      <span class="sa"></span><span class="s">&#34;</span><span class="s">mmap(MAP_ANON|MAP_SHARED, %uz) failed</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">shm</span><span class="o">-</span><span class="o">&gt;</span><span class="n">size</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">NGX_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ここで上で読み飛ばした <code>ngx_slab_init</code> 関数の続きを見ます。</p>
<p>109～111行目で <code>slots</code> と <code>p</code> は <code>*pool</code> の <code>ngx_slab_pool_t</code> 構造体の直後のアドレスに設定されます。</p>
<p>上記の通り <code>n</code> は 9 なので118～123行目で 0～8の9個のスロットを作成しています。</p>
<p>125行目で <code>p</code> は9個のスロットの直後のアドレスを指します。</p>
<p>そこから9個の <code>ngx_slab_stat_t</code> 構造体の領域が確保され、スロット毎の統計情報が保持されます。</p>
<p>130行目で <code>p</code> は統計情報の直後のアドレスを指します。</p>
<p>132行目で <code>size</code> は <code>ngx_slab_pool_t</code> 構造体と <code>ngx_slab_stat_t</code> 構造体の9組分のサイズを差し引かれます。</p>
<p>134行目で <code>pages</code> にページ数の計算結果を設定しています。上記の <code>size</code> を <code>(ngx_pagesize + sizeof(ngx_slab_page_t))</code> で割っていますので、各ページに対して 4096バイトのデータ領域と <code>ngx_slab_page_t</code> 構造体による管理情報が存在することがわかります。</p>
<p>136行目で <code>pool-&gt;pages</code> にページの先頭のアドレスをセットしています。</p>
<p>137行目で <code>pool-&gt;pages</code> から先頭 <code>pages * sizeof(ngx_slab_page_t)</code> バイトをゼロクリアしています。このことから上記の各ページに対応する 4096バイトのデータ領域と <code>ngx_slab_page_t</code> 構造体のうち <code>ngx_slab_page_t</code> 構造体が <code>pool-&gt;pages</code> の先頭にページ数分連続して存在し、その後に 4096 バイトのページがページ数分続くことがわかります。</p>
<p>139行目以降はリンクトリストの要素を設定しています。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">98
</span><span class="lnt">99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span>
<span class="nf">ngx_slab_init</span><span class="p">(</span><span class="n">ngx_slab_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span>           <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="n">size_t</span>            <span class="n">size</span><span class="p">;</span>
    <span class="n">ngx_int_t</span>         <span class="n">m</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>        <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">ngx_slab_page_t</span>  <span class="o">*</span><span class="n">slots</span><span class="p">,</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">min_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">size_t</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">min_shift</span><span class="p">;</span>

    <span class="n">slots</span> <span class="o">=</span> <span class="n">ngx_slab_slots</span><span class="p">(</span><span class="n">pool</span><span class="p">)</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">slots</span><span class="p">;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>

    <span class="n">ngx_slab_junk</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span><span class="p">;</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">ngx_pagesize_shift</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">min_shift</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* only &#34;next&#34; is used in list head */</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
        <span class="n">slots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">p</span> <span class="o">+</span><span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_stat_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_memzero</span><span class="p">(</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">+</span><span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">)</span><span class="p">;</span>

    <span class="n">size</span> <span class="o">-</span><span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_stat_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

    <span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_uint_t</span><span class="p">)</span> <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="n">ngx_pagesize</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pages</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_slab_page_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_memzero</span><span class="p">(</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pages</span><span class="p">,</span> <span class="n">pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

    <span class="n">page</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pages</span><span class="p">;</span>

    <span class="cm">/* only &#34;next&#34; is used in list head */</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">slab</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">;</span>
    <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="p">(</span><span class="n">uintptr_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">free</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">pages</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_slab_page_t</span><span class="p">)</span><span class="p">,</span>
                                <span class="n">ngx_pagesize</span><span class="p">)</span><span class="p">;</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">pages</span> <span class="o">-</span> <span class="p">(</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">end</span> <span class="o">-</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">ngx_pagesize</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pages</span> <span class="o">-</span><span class="o">=</span> <span class="n">m</span><span class="p">;</span>
        <span class="n">page</span><span class="o">-</span><span class="o">&gt;</span><span class="n">slab</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pages</span> <span class="o">+</span> <span class="n">pages</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pfree</span> <span class="o">=</span> <span class="n">pages</span><span class="p">;</span>

    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log_nomem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">log_ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">zero</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-</span><span class="o">&gt;</span><span class="n">zero</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">\0</span><span class="sc">&#39;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
