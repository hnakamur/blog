<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>add-apt-repositoryを使わずにPPAをapt-lineに追加する方法</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/09/02/add-ppa-to-apt-line-without-add-apt-repository/" rel="bookmark"
           title="Permalink to add-apt-repositoryを使わずにPPAをapt-lineに追加する方法">add-apt-repositoryを使わずにPPAをapt-lineに追加する方法</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-09-02T11:47:00+09:00">
                Published: 2017-09-02
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/deb.html">deb</a> <a href="../../../../tag/apt.html">apt</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>PPAのページにはPPAを追加するには <code>add-apt-respository</code> コマンドを使うように書かれています。</p>
<p>例えば gcc-7 などを配布しているPPA
<a class="reference external" href="https://launchpad.net/~ubuntu-toolchain-r/+archive/ubuntu/test">Toolchain test builds : “PPA for Ubuntu Toolchain Uploads (restricted)” team</a>
の Adding this PPA to your system には以下のように書かれています。</p>
<div class="highlight"><pre><span></span><span class="go">sudo add-apt-repository ppa:ubuntu-toolchain-r/test</span>
<span class="go">sudo apt-get update</span>
</pre></div>
<p>ですが、LXDのコンテナの Ubuntu Xenial のイメージなどでは add-apt-repository が入っていないので、 <code>apt install software-properties-common</code> でインストールする必要があります。</p>
<p>わざわざこれだけのために入れるのも面倒ですし、ディスクも消費するので、 add-apt-repository を使わない方法を調べました。</p>
</div>
<div class="section" id="add-apt-repositoryppa">
<h2>add-apt-repositoryを使わないPPAの追加手順</h2>
<p>以下の2ステップで追加します。</p>
<ol class="arabic simple">
<li>PPAの公開鍵の追加</li>
<li>apt-lineの追加</li>
</ol>
<div class="section" id="ppa">
<h3>PPAの公開鍵の追加</h3>
<p>公開鍵のIDを調べて、以下のコマンドでPPAの公開鍵を追加します。以下は公開鍵のIDが BA9EF27F の場合です。</p>
<div class="highlight"><pre><span></span><span class="go">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv BA9EF27F</span>
</pre></div>
<p><code>man apt-key</code> で確認したところ <code>adv</code> サブコマンドは引数を <code>gpg</code> に渡すようになっています。</p>
<p>この方法は <a class="reference external" href="https://superuser.com/questions/620765/sudo-apt-key-adv-keyserver-keyserver-ubuntu-com-recv-7f0ceb10-command-return/621258#621258">linux - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv 7F0CEB10 command returns error - Super User</a> で見つけました。コメントでポート80を明示的に指定する必要があるとありましたが試してみると不要でした。</p>
<p>公開鍵のIDは以下の手順で調べられます。</p>
<ol class="arabic simple">
<li>PPA のページの &quot;Adding this PPA to your system&quot; セクションにある &quot;Technical details about this PPA&quot; というリンクをクリック</li>
<li>展開されて表示された &quot;Signing Key:&quot; の下のリンクをクリック</li>
<li>&quot;Search results for ...&quot; のページで検索結果の keyID の部分をコピー</li>
</ol>
<p>上記の例のPPAだと以下のように表示されて、 keyID は BA9EF27F となります。</p>
<div class="highlight"><pre><span></span>Search results for &#39;0x60c317803a41ba51845e371a1e9377a2ba9ef27f&#39;

Type bits/keyID     Date       User ID
pub  1024R/BA9EF27F 2009-10-22 Launchpad Toolchain builds
         Fingerprint=60C3 1780 3A41 BA51 845E  371A 1E93 77A2 BA9E F27F
</pre></div>
<p>正しく追加できたかは <code>sudo apt-key list</code> で確認できます。</p>
<div class="highlight"><pre><span></span>root@addrepomanual:~# apt-key list
/etc/apt/trusted.gpg
--------------------
pub   1024D/437D05B5 2004-09-12
uid                  Ubuntu Archive Automatic Signing Key &lt;ftpmaster@ubuntu.com&gt;
sub   2048g/79164387 2004-09-12

pub   4096R/C0B21F32 2012-05-11
uid                  Ubuntu Archive Automatic Signing Key (2012) &lt;ftpmaster@ubuntu.com&gt;

pub   4096R/EFE21092 2012-05-11
uid                  Ubuntu CD Image Automatic Signing Key (2012) &lt;cdimage@ubuntu.com&gt;

pub   1024D/FBB75451 2004-12-30
uid                  Ubuntu CD Image Automatic Signing Key &lt;cdimage@ubuntu.com&gt;

pub   1024R/BA9EF27F 2009-10-22
uid                  Launchpad Toolchain builds
</pre></div>
<p>BA9EF27F の鍵が追加されていることがわかります。</p>
<p>ちなみに別環境で <code>add-apt-repository ppa:ubuntu-toolchain-r/test</code> でPPAを追加した場合は <code>apt-key list</code> の結果は以下のようになりました。
PPA用に <code>/etc/apt/trusted.gpg.d/ubuntu-toolchain-r_ubuntu_test.gpg</code> という別のファイルが作られてそちらに鍵がインポートされています。</p>
<div class="highlight"><pre><span></span>root@addrepo:~# sudo apt-key list
/etc/apt/trusted.gpg
--------------------
pub   1024D/437D05B5 2004-09-12
uid                  Ubuntu Archive Automatic Signing Key &lt;ftpmaster@ubuntu.com&gt;
sub   2048g/79164387 2004-09-12

pub   4096R/C0B21F32 2012-05-11
uid                  Ubuntu Archive Automatic Signing Key (2012) &lt;ftpmaster@ubuntu.com&gt;

pub   4096R/EFE21092 2012-05-11
uid                  Ubuntu CD Image Automatic Signing Key (2012) &lt;cdimage@ubuntu.com&gt;

pub   1024D/FBB75451 2004-12-30
uid                  Ubuntu CD Image Automatic Signing Key &lt;cdimage@ubuntu.com&gt;

/etc/apt/trusted.gpg.d/ubuntu-toolchain-r_ubuntu_test.gpg
---------------------------------------------------------
pub   1024R/BA9EF27F 2009-10-22
uid                  Launchpad Toolchain builds
</pre></div>
<p>手動で同じ構成にするのは以下のようにすれば出来ます。</p>
<div class="highlight"><pre><span></span><span class="go">gpg --no-default-keyring --keyring /etc/apt/trusted.gpg.d/ubuntu-toolchain-r_ubuntu_test.gpg --fingerprint</span>
<span class="go">curl -sS &#39;http://keyserver.ubuntu.com:11371/pks/lookup?op=get&amp;search=0x1E9377A2BA9EF27F&#39; \</span>
<span class="go">        | apt-key --keyring /etc/apt/trusted.gpg.d/ubuntu-toolchain-r_ubuntu_test.gpg add -</span>
</pre></div>
<p>gpg でデフォルトと別のkeyringファイルを作る方法は
<a class="reference external" href="https://superuser.com/questions/399938/how-to-create-additional-gpg-keyring/991139#991139">gnupg - How to create additional gpg keyring - Super User</a> で見つけました。</p>
<p>curl に指定しているURLは以下の手順で調べられます。</p>
<ol class="arabic simple">
<li>PPA のページの &quot;Adding this PPA to your system&quot; セクションにある &quot;Technical details about this PPA&quot; というリンクをクリック</li>
<li>展開されて表示された &quot;Signing Key:&quot; の下のリンクをクリック</li>
<li>&quot;Search results for ...&quot; のページで検索結果の keyID のリンクのURLをコピー</li>
</ol>
<p>このリンク先のページは公開鍵を含むHTMLになっていますが、 <code>apt-key add</code> サブコマンドは公開鍵の前後は無視して処理してくれました。</p>
<p>ただし、この手順にはcurlが必要で、LXDのxenialイメージには含まれていないので <code>apt install curl</code> でインストールが必要です。なので手軽に実行するには冒頭の手順のほうが良いです。</p>
<p>ちなみに gpg で keyring を作っておいて
<code>sudo apt-key adv --keyserver keyserver.ubuntu.com --keyring /etc/apt/trusted.gpg.d/ubuntu-toolchain-r_ubuntu_test.gpg --recv BA9EF27F</code> というのも試してみたのですが、 /etc/apt/trusted.gpg のほうにインポートされてしまいました。</p>
</div>
<div class="section" id="apt-line">
<h3>apt-lineの追加</h3>
<p>これは <code>/etc/apt/sources.list</code> に追記するか <code>/etc/apt/sources.list.d/</code> に <code>.list</code> という拡張子を持つファイルを作ればOKです。後者のほうが管理しやすいと思います。</p>
<p>例えば ubuntu-toolchain-r/test の場合は以下のようにします。</p>
<div class="highlight"><pre><span></span><span class="go">echo &#39;deb http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu xenial main&#39; \</span>
<span class="go">         | sudo tee /etc/apt/sources.list.d/ubuntu-toolchain-r-ubuntu-test-xenial.list</span>
</pre></div>
<p>追加する内容は、 PPA のページの &quot;Adding this PPA to your system&quot; セクションにある &quot;Technical details about this PPA&quot; を展開し、 &quot;Display sources.list entries for:&quot; の右のドロップダウンリストでお使いのディストリビューションを選べば表示されます。</p>
<p>今回の例だと以下の内容です。</p>
<div class="highlight"><pre><span></span><span class="go">deb http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu xenial main</span>
<span class="go">deb-src http://ppa.launchpad.net/ubuntu-toolchain-r/test/ubuntu xenial main</span>
</pre></div>
<p>deb-src の行は <code>apt source パッケージ名</code> でdebのソースパッケージをダウンロードするときに必要ですが、それ以外では不要なので上記では省略しています。</p>
<p>あとは <code>apt update</code> すれば <code>apt install パッケージ名</code> で必要なパッケージをインストール可能になります。</p>
</div>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>