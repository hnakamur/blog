<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>ChromeとFirefoxの拡張機能を書くのにasync/awaitを使ってみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/09/18/use-async-await-in-writing-chrome-and-firefox-extensions/" rel="bookmark"
           title="Permalink to ChromeとFirefoxの拡張機能を書くのにasync/awaitを使ってみた">ChromeとFirefoxの拡張機能を書くのにasync/awaitを使ってみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-09-18T12:35:00+09:00">
                Published: 2017-09-18
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/javascript.html">javascript</a> <a href="../../../../tag/async-await.html">async-await</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>私はChromeとFirefox用に以下の拡張機能を書いて使っています。</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/hnakamur/FormatLink-Chrome">FormatLink-Chrome</a></li>
<li><a class="reference external" href="https://github.com/hnakamur/FormatLink-Firefox">FormatLink-Firefox</a></li>
</ul>
<p>今回UIを改変する際についでに async と await を使って書くように変更してみたのでメモです。</p>
</div>
<div class="section" id="async-await-firefox-chrome">
<h2>async/await が使える Firefox と Chrome のバージョン</h2>
<p><a class="reference external" href="https://caniuse.com/#feat=async-functions">Can I use... Support tables for HTML5, CSS3, etc</a>
で &quot;Showing all&quot; をクリックして確認すると Chrome はバージョン 55 、 Firefox はバージョン 52 から async/await をサポートしているとのことです。</p>
</div>
<div class="section" id="promise-api-async-await">
<h2>Promise を返す API を async/await で呼び出す</h2>
<p><a class="reference external" href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Statements/async_function">async function - JavaScript | MDN</a> に分かりやすい説明と例がありました。</p>
</div>
<div class="section" id="firefox-async-await">
<h2>Firefox の拡張機能を書くのにasync/awaitを使う</h2>
<p><a class="reference external" href="https://developer.mozilla.org/ja/Add-ons/WebExtensions/What_are_WebExtensions">WebExtensions とは何か？ - Mozilla | MDN</a> で説明されていますが、以前は Firefox の拡張は XUL などの技術を使っていましたが、今後は WebExtensions のみが利用可能となります。</p>
<p><a class="reference external" href="https://developer.mozilla.org/ja/Add-ons/WebExtensions">WebExtensions - Mozilla | MDN</a>
のページ右の「JavaScript API 群」はほとんどは Promise を返すようになっています。</p>
<p>例えば自分の拡張機能のコンテキストメニューを全て消す API
<a class="reference external" href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/menus/removeAll">menus.removeAll()</a>
の syntax は</p>
<div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">removing</span> <span class="o">=</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">menus</span><span class="p">.</span><span class="nx">removeAll</span><span class="p">()</span>
</pre></div>
<p>のように Promise を返します。</p>
<p>これらの API は上記の方法で async/await で呼び出すことが可能です。</p>
<p>一方で、コンテキストメニューを作成する API
<a class="reference external" href="https://developer.mozilla.org/en-US/Add-ons/WebExtensions/API/menus/create">menus.create() - Mozilla | MDN</a>
の syntax は</p>
<div class="highlight"><pre><span></span><span class="nx">browser</span><span class="p">.</span><span class="nx">menus</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span>
  <span class="nx">createProperties</span><span class="p">,</span> <span class="c1">// object</span>
  <span class="kd">function</span><span class="p">()</span> <span class="p">{...}</span>  <span class="c1">// optional function</span>
<span class="p">)</span>
</pre></div>
<p>のようにコールバック関数をオプショナルで受け取るようになっています。</p>
<p>そこでまず <code>browser.menus.create</code> を Promise でラップした関数を作ります。</p>
<p><a class="reference external" href="https://github.com/hnakamur/FormatLink-Firefox/blob/0e5d21c5ab4d87b758ef2da4f671406bc64a940b/common.js#L50-L61">https://github.com/hnakamur/FormatLink-Firefox/blob/0e5d21c5ab4d87b758ef2da4f671406bc64a940b/common.js#L50-L61</a></p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">creatingContextMenuItem</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">browser</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">err</span> <span class="o">=</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">lastError</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">resolve</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>
<p>あとは同様に async/await で呼び出せば OK です。</p>
<p><a class="reference external" href="https://github.com/hnakamur/FormatLink-Firefox/blob/0e5d21c5ab4d87b758ef2da4f671406bc64a940b/common.js#L63-L83">https://github.com/hnakamur/FormatLink-Firefox/blob/0e5d21c5ab4d87b758ef2da4f671406bc64a940b/common.js#L63-L83</a></p>
<div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">createContextMenus</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">removeAll</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createSubmenus</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">getFormatCount</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)];</span>
      <span class="nx">await</span> <span class="nx">creatingContextMenuItem</span><span class="p">({</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;format-link-format&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;as &quot;</span> <span class="o">+</span> <span class="nx">format</span><span class="p">,</span>
        <span class="nx">contexts</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;selection&quot;</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">]</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">defaultFormat</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;defaultFormat&#39;</span><span class="p">]];</span>
    <span class="nx">await</span> <span class="nx">creatingContextMenuItem</span><span class="p">({</span>
      <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;format-link-format-default&quot;</span><span class="p">,</span>
      <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Format Link as &quot;</span> <span class="o">+</span> <span class="nx">defaultFormat</span><span class="p">,</span>
      <span class="nx">contexts</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;selection&quot;</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">]</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="chrome-async-await">
<h2>Chrome の拡張機能を書くのに async/await を使う</h2>
<p>Chrome の拡張機能用の API
<a class="reference external" href="https://developer.chrome.com/extensions/api_index">JavaScript APIs - Google Chrome</a>
は Promise を返す方式ではなく、コールバック関数を引数にとる方式になっています。</p>
<p>例えばコンテキストメニューを作成するAPI
<a class="reference external" href="https://developer.chrome.com/extensions/contextMenus#method-create">chrome.contextMenus.create</a></p>
<p>のシグネチャは</p>
<div class="highlight"><pre><span></span>integer or string chrome.contextMenus.create(object createProperties, function callback)
</pre></div>
<p>となっています。</p>
<p>ということでまず Promise を返すラッパー関数を書く必要があるのですが、
<a class="reference external" href="https://github.com/KeithHenry/chromeExtensionAsync">KeithHenry/chromeExtensionAsync: Promise wrapper for the Chrome extension API so that it can be used with async/await rather than callbacks</a>
という便利なライブラリがありました。
これを使えば元の API の関数名のまま呼び出せば Promise を返すようになります。</p>
</div>
<div class="section" id="chrome-for-await-promise-all">
<h2>Chrome で for ループ内で await を呼んでハマったが Promise.all で解決</h2>
<p>自作の拡張 Format Link では初期化時と設定ページで設定を保存したときに、コンテキストメニューを一旦全部消して作り直すようにしています。</p>
<p>Firefox 用の拡張では上記の <code>createContextMenus</code> のように <code>for</code> ループ内で <code>await creatingContextMenuItem</code> で正常に作成できていました。</p>
<p>ですが、 Chrome では同様なコードだと、初期化時は問題ないのですが、設定ページで &quot;Create submenus&quot; をオンにして設定を保存したときに 4 つのサブメニューが作られるべきところが最初の 2 つしか作られないという現象が発生しました。</p>
<p>とりあえずの回避策として <code>await</code> を使わずに
<a class="reference external" href="https://github.com/hnakamur/FormatLink-Chrome/blob/4828a677776b81ef3ca66132fea366c60ccd7d4f/common.js#L55-L77">https://github.com/hnakamur/FormatLink-Chrome/blob/4828a677776b81ef3ca66132fea366c60ccd7d4f/common.js#L55-L77</a></p>
<div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">createContextMenus</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">await</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">removeAll</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createSubmenus</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">getFormatCount</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)];</span>
      <span class="c1">// NOTE: Some of menu items weren&#39;t created when I added &#39;await&#39; here.</span>
      <span class="c1">// So I deleted &#39;await&#39; as a workaround.</span>
      <span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;format-link-format&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;as &quot;</span> <span class="o">+</span> <span class="nx">format</span><span class="p">,</span>
        <span class="nx">contexts</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;selection&quot;</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">]</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">defaultFormat</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;defaultFormat&#39;</span><span class="p">]];</span>
    <span class="nx">await</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;format-link-format-default&quot;</span><span class="p">,</span>
      <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Format Link as &quot;</span> <span class="o">+</span> <span class="nx">defaultFormat</span><span class="p">,</span>
      <span class="nx">contexts</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;selection&quot;</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">]</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>としたら、とりあえず期待通りの動きになりました。
が、これだと完了を待てないので、この後さらに処理をつなげたいときには困ります。</p>
<p>その後 <a class="reference external" href="https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Promise/all">Promise.all() - JavaScript | MDN</a> というのを見つけて、以下のように書き換えました。</p>
<p><a class="reference external" href="https://github.com/hnakamur/FormatLink-Chrome/blob/6445fd5f8a2df38c54706f3415f732e6a654140d/common.js#L55-L77">https://github.com/hnakamur/FormatLink-Chrome/blob/6445fd5f8a2df38c54706f3415f732e6a654140d/common.js#L55-L77</a></p>
<div class="highlight"><pre><span></span><span class="nx">async</span> <span class="kd">function</span> <span class="nx">createContextMenus</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">await</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">removeAll</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">createSubmenus</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">promises</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">getFormatCount</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)];</span>
      <span class="nx">promises</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;format-link-format&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;as &quot;</span> <span class="o">+</span> <span class="nx">format</span><span class="p">,</span>
        <span class="nx">contexts</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;selection&quot;</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">]</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="nx">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">promises</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">defaultFormat</span> <span class="o">=</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;title&#39;</span> <span class="o">+</span> <span class="nx">options</span><span class="p">[</span><span class="s1">&#39;defaultFormat&#39;</span><span class="p">]];</span>
    <span class="nx">await</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">contextMenus</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
      <span class="nx">id</span><span class="o">:</span> <span class="s2">&quot;format-link-format-default&quot;</span><span class="p">,</span>
      <span class="nx">title</span><span class="o">:</span> <span class="s2">&quot;Format Link as &quot;</span> <span class="o">+</span> <span class="nx">defaultFormat</span><span class="p">,</span>
      <span class="nx">contexts</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">,</span> <span class="s2">&quot;selection&quot;</span><span class="p">,</span> <span class="s2">&quot;page&quot;</span><span class="p">]</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id3">
<h2>おわりに</h2>
<p>例によって雰囲気で書いてますが、 Firefox でも Chrome でも拡張機能を書くのに async/await が使えることが分かったのでとりあえずよかったです。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>