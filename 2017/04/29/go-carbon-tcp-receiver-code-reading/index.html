<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>go-carbonのTCPレシーバについてコードリーディングしてみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/04/29/go-carbon-tcp-receiver-code-reading/" rel="bookmark"
           title="Permalink to go-carbonのTCPレシーバについてコードリーディングしてみた">go-carbonのTCPレシーバについてコードリーディングしてみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-04-29T11:15:00+09:00">
                Published: 2017-04-29
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/go-go-carbon.html">go go-carbon</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p><a class="reference external" href="https://github.com/lomik/go-carbon">lomik/go-carbon: Golang implementation of Graphite/Carbon server with classic architecture: Agent -&gt; Cache -&gt; Persister</a>
のTCPレシーバについてコードを読んでみたのでメモです。</p>
<p>対象のコミットは
<a class="reference external" href="https://github.com/lomik/go-carbon/tree/42b9832d13240ff044c86768e8d0dc1f356d9458">https://github.com/lomik/go-carbon/tree/42b9832d13240ff044c86768e8d0dc1f356d9458</a>
です。</p>
</div>
<div class="section" id="tcp">
<h2>TCPレシーバの生成</h2>
<p><code>(app *App) Start()</code> というメソッドの中で <code>receiver.New</code> を呼んでTCPレシーバを生成しています。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/carbon/app.go#L271-L281">carbon/app.go#L271-L281</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>271
272
273
274
275
276
277
278
279
280
281</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">TCP</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">receiver</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
        <span class="s">&quot;tcp://&quot;</span><span class="o">+</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">Listen</span><span class="p">,</span>
        <span class="nx">receiver</span><span class="p">.</span><span class="nx">OutFunc</span><span class="p">(</span><span class="nx">core</span><span class="p">.</span><span class="nx">Add</span><span class="p">),</span>
        <span class="nx">receiver</span><span class="p">.</span><span class="nx">BufferSize</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">BufferSize</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>receiver.New</code> 内では <code>TCP</code> というstructのインスタンスを生成して <code>Listen</code> メソッドを呼び出しています。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/receiver/receiver.go#L110-L127">receiver/receiver.go#L110-L127</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">r</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">TCP</span><span class="p">{</span>
    <span class="nx">out</span><span class="p">:</span>    <span class="nx">blackhole</span><span class="p">,</span>
    <span class="nx">name</span><span class="p">:</span>   <span class="nx">u</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span>
    <span class="nx">logger</span><span class="p">:</span> <span class="nx">zapwriter</span><span class="p">.</span><span class="nx">Logger</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Scheme</span> <span class="o">==</span> <span class="s">&quot;pickle&quot;</span> <span class="p">{</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">isPickle</span> <span class="p">=</span> <span class="kc">true</span>
    <span class="nx">r</span><span class="p">.</span><span class="nx">maxPickleMessageSize</span> <span class="p">=</span> <span class="mi">67108864</span> <span class="c1">// 64Mb</span>
<span class="p">}</span>

<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">optApply</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
    <span class="nx">optApply</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>TCP</code> の <code>Listen</code> メソッド内では <code>Accept</code> したらgoroutineを作って code:<cite>HandleConnection</cite> フィールドに設定されたハンドラで処理しています。</p>
<p>また、197行目あたりを見ると <code>rcv.buffer</code> が設定されているときは <code>rcv.out</code> に書き込まれたポイントデータをバッファリングしてから元の出力先のチャンネルに送るように変更しています。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/receiver/tcp.go#L192-L237">receiver/tcp.go#L192-L237</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">handler</span> <span class="o">:=</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">HandleConnection</span>
<span class="k">if</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">isPickle</span> <span class="p">{</span>
    <span class="nx">handler</span> <span class="p">=</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">handlePickle</span>
<span class="p">}</span>

<span class="k">if</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">originalOut</span> <span class="o">:=</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">out</span>

    <span class="nx">rcv</span><span class="p">.</span><span class="nx">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="k">select</span> <span class="p">{</span>
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">exit</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">case</span> <span class="nx">p</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">buffer</span><span class="p">:</span>
                <span class="nx">originalOut</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">rcv</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rcv</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">&lt;-</span> <span class="nx">p</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">rcv</span><span class="p">.</span><span class="nx">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nx">tcpListener</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="k">for</span> <span class="p">{</span>

        <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tcpListener</span><span class="p">.</span><span class="nx">Accept</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span> <span class="s">&quot;use of closed network connection&quot;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">break</span>
            <span class="p">}</span>
            <span class="nx">rcv</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Warn</span><span class="p">(</span><span class="s">&quot;failed to accept connection&quot;</span><span class="p">,</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">continue</span>
        <span class="p">}</span>

        <span class="nx">rcv</span><span class="p">.</span><span class="nx">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">handler</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">}</span>

<span class="p">})</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="id2">
<h2>リクエスト処理</h2>
<p><code>TCP</code> の <code>HandleConnection</code> の実装は以下のようになっています。
リクエストの内容を1行ずつ <code>points.ParseText</code> 関数によりパーズして、その結果を <code>rcv.out</code> に書き出しています。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/receiver/tcp.go#L49-L99">receiver/tcp.go#L49-L99</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rcv</span> <span class="o">*</span><span class="nx">TCP</span><span class="p">)</span> <span class="nx">HandleConnection</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">active</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">active</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
    <span class="nx">reader</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">NewReader</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>

    <span class="nx">finished</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">finished</span><span class="p">)</span>

    <span class="nx">rcv</span><span class="p">.</span><span class="nx">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">finished</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">exit</span><span class="p">:</span>
            <span class="nx">conn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">conn</span><span class="p">.</span><span class="nx">SetReadDeadline</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">))</span>

        <span class="nx">line</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">ReadBytes</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
                    <span class="nx">rcv</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Warn</span><span class="p">(</span><span class="s">&quot;unfinished line&quot;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;line&quot;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">line</span><span class="p">)))</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">errors</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nx">rcv</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;read error&quot;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
            <span class="p">}</span>
            <span class="k">break</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// skip empty lines</span>
            <span class="k">if</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">ParseText</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">line</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">errors</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nx">zapwriter</span><span class="p">.</span><span class="nx">Logger</span><span class="p">(</span><span class="s">&quot;parser&quot;</span><span class="p">).</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;parse failed&quot;</span><span class="p">,</span>
                    <span class="nx">zap</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
                    <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;protocol&quot;</span><span class="p">,</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
                    <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;peer&quot;</span><span class="p">,</span> <span class="nx">conn</span><span class="p">.</span><span class="nx">RemoteAddr</span><span class="p">().</span><span class="nx">String</span><span class="p">()),</span>
                <span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">metricsReceived</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="nx">rcv</span><span class="p">.</span><span class="nx">out</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>points.ParseText</code> 関数の定義です。 <code>*Points</code> を返しています。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/points/points.go#L125-L161">points/points.go#L125-L161</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">ParseText</span><span class="p">(</span><span class="nx">line</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Points</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">row</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Trim</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&quot;\n \t\r&quot;</span><span class="p">),</span> <span class="s">&quot; &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">row</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;bad message: %#v&quot;</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// 0x2e == &quot;.&quot;. Or use split? @TODO: benchmark</span>
    <span class="c1">// if strings.Contains(row[0], &quot;..&quot;) || row[0][0] == 0x2e || row[0][len(row)-1] == 0x2e {</span>
    <span class="c1">//      return nil, fmt.Errorf(&quot;bad message: %#v&quot;, line)</span>
    <span class="c1">// }</span>

    <span class="nx">value</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseFloat</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">math</span><span class="p">.</span><span class="nx">IsNaN</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;bad message: %#v&quot;</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">tsf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nx">ParseFloat</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">math</span><span class="p">.</span><span class="nx">IsNaN</span><span class="p">(</span><span class="nx">tsf</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;bad message: %#v&quot;</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// 315522000 == &quot;1980-01-01 00:00:00&quot;</span>
    <span class="c1">// if tsf &lt; 315532800 {</span>
    <span class="c1">//      return nil, fmt.Errorf(&quot;bad message: %#v&quot;, line)</span>
    <span class="c1">// }</span>

    <span class="c1">// 4102444800 = &quot;2100-01-01 00:00:00&quot;</span>
    <span class="c1">// Hello people from the future</span>
    <span class="c1">// if tsf &gt; 4102444800 {</span>
    <span class="c1">//      return nil, fmt.Errorf(&quot;bad message: %#v&quot;, line)</span>
    <span class="c1">// }</span>

    <span class="k">return</span> <span class="nx">OnePoint</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">value</span><span class="p">,</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">tsf</span><span class="p">)),</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>Points</code> の定義です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/points/points.go#L15-L25">points/points.go#L15-L25</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>15
16
17
18
19
20
21
22
23
24
25</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Point value/time pair</span>
<span class="kd">type</span> <span class="nx">Point</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Value</span>     <span class="kt">float64</span>
    <span class="nx">Timestamp</span> <span class="kt">int64</span>
<span class="p">}</span>

<span class="c1">// Points from carbon clients</span>
<span class="kd">type</span> <span class="nx">Points</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Metric</span> <span class="kt">string</span>
    <span class="nx">Data</span>   <span class="p">[]</span><span class="nx">Point</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="rcv-out">
<h2>rcv.outに出力した後の処理</h2>
<p>次は <code>rcv.out</code> に出力されたデータがどう処理されるかを見ていきます。</p>
<p>冒頭に書いた <code>(app *App) Start()</code> というメソッドの中で <code>receiver.New</code> を呼んでTCPレシーバを生成している際に274行目で <code>receiver.OutFunc</code> に <code>core.Add</code> を指定して呼んでいます。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/carbon/app.go#L271-L281">carbon/app.go#L271-L281</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>271
272
273
274
275
276
277
278
279
280
281</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">TCP</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">receiver</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
        <span class="s">&quot;tcp://&quot;</span><span class="o">+</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">Listen</span><span class="p">,</span>
        <span class="nx">receiver</span><span class="p">.</span><span class="nx">OutFunc</span><span class="p">(</span><span class="nx">core</span><span class="p">.</span><span class="nx">Add</span><span class="p">),</span>
        <span class="nx">receiver</span><span class="p">.</span><span class="nx">BufferSize</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">BufferSize</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>receiver.OutFunc</code> の定義は以下の通りで、Functional Option Patternで実装されています。
Functional Option Patternについては <a class="reference external" href="http://qiita.com/weloan/items/56f1c7792088b5ede136">Go言語のFunctional Option Pattern - Qiita</a> やその記事の最後の原典を参照してください。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/receiver/receiver.go#L48-L59">receiver/receiver.go#L48-L59</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>48
49
50
51
52
53
54
55
56
57
58
59</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// OutFunc creates option for New contructor</span>
<span class="kd">func</span> <span class="nx">OutFunc</span><span class="p">(</span><span class="nx">out</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">))</span> <span class="nx">Option</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="nx">Receiver</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.(</span><span class="o">*</span><span class="nx">TCP</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="nx">out</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.(</span><span class="o">*</span><span class="nx">UDP</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">t</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="nx">out</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>ということで <code>rcv.out</code> には <code>core.Add</code> が設定されることがわかりました。
<code>core</code> は <code>(app *App) Start()</code> というメソッド内で以下のコードで生成されるローカル変数です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/carbon/app.go#L245-L247">carbon/app.go#L245-L247</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>245
246
247</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nx">core</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>
<span class="nx">core</span><span class="p">.</span><span class="nx">SetMaxSize</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">MaxSize</span><span class="p">)</span>
<span class="nx">core</span><span class="p">.</span><span class="nx">SetWriteStrategy</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">WriteStrategy</span><span class="p">)</span>
</pre></div>
</td></tr></table><p><code>cache.New</code> の実装は以下のようになっています。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/cache.go#L62-L79">cache/cache.go#L62-L79</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Creates a new cache instance</span>
<span class="kd">func</span> <span class="nx">New</span><span class="p">()</span> <span class="o">*</span><span class="nx">Cache</span> <span class="p">{</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Cache</span><span class="p">{</span>
        <span class="nx">data</span><span class="p">:</span>          <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">Shard</span><span class="p">,</span> <span class="nx">shardCount</span><span class="p">),</span>
        <span class="nx">writeStrategy</span><span class="p">:</span> <span class="nx">Noop</span><span class="p">,</span>
        <span class="nx">maxSize</span><span class="p">:</span>       <span class="mi">1000000</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">shardCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Shard</span><span class="p">{</span>
            <span class="nx">items</span><span class="p">:</span>        <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">),</span>
            <span class="nx">notConfirmed</span><span class="p">:</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">c</span><span class="p">.</span><span class="nx">writeoutQueue</span> <span class="p">=</span> <span class="nx">NewWriteoutQueue</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">c</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>Cache</code> の構造体とそれに関連する定義は以下の通りです。
1024個の <code>Shard</code> に分けてポイントデータを保持しています。
<code>Shard</code> では <code>items</code> というmapと <code>notConfirmed</code> というsliceでポイントデータを保持しています。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/cache.go#L18-L60">cache/cache.go#L18-L60</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">WriteStrategy</span> <span class="kt">int</span>

<span class="kd">const</span> <span class="p">(</span>
    <span class="nx">MaximumLength</span> <span class="nx">WriteStrategy</span> <span class="p">=</span> <span class="kc">iota</span>
    <span class="nx">TimestampOrder</span>
    <span class="nx">Noop</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">shardCount</span> <span class="p">=</span> <span class="mi">1024</span>

<span class="c1">// A &quot;thread&quot; safe map of type string:Anything.</span>
<span class="c1">// To avoid lock bottlenecks this map is dived to several (shardCount) map shards.</span>
<span class="kd">type</span> <span class="nx">Cache</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

    <span class="nx">queueLastBuild</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>

    <span class="nx">data</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Shard</span>

    <span class="nx">maxSize</span>       <span class="kt">int32</span>
    <span class="nx">writeStrategy</span> <span class="nx">WriteStrategy</span>

    <span class="nx">writeoutQueue</span> <span class="o">*</span><span class="nx">WriteoutQueue</span>

    <span class="nx">xlog</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">Value</span> <span class="c1">// io.Writer</span>

    <span class="nx">stat</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">size</span>              <span class="kt">int32</span>  <span class="c1">// changing via atomic</span>
        <span class="nx">queueBuildCnt</span>     <span class="kt">uint32</span> <span class="c1">// number of times writeout queue was built</span>
        <span class="nx">queueBuildTimeMs</span>  <span class="kt">uint32</span> <span class="c1">// time spent building writeout queue in milliseconds</span>
        <span class="nx">queueWriteoutTime</span> <span class="kt">uint32</span> <span class="c1">// in milliseconds</span>
        <span class="nx">overflowCnt</span>       <span class="kt">uint32</span> <span class="c1">// drop packages if cache full</span>
        <span class="nx">queryCnt</span>          <span class="kt">uint32</span> <span class="c1">// number of queries</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// A &quot;thread&quot; safe string to anything map.</span>
<span class="kd">type</span> <span class="nx">Shard</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>     <span class="c1">// Read Write mutex, guards access to internal map.</span>
    <span class="nx">items</span>            <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span>
    <span class="nx">notConfirmed</span>     <span class="p">[]</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span> <span class="c1">// linear search for value/slot</span>
    <span class="nx">notConfirmedUsed</span> <span class="kt">int</span>              <span class="c1">// search value in notConfirmed[:notConfirmedUsed]</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="cacheadd">
<h2>CacheのAddメソッド</h2>
<p><code>Cache</code> の <code>Add</code> メソッドは以下のようになっています。</p>
<p><code>maxSize</code> フィールドに値が設定されている場合 <code>Cache</code> の <code>Size</code> メソッドの結果がそれを超える場合は <code>stat.OverflowCnt</code> の統計情報にデータ数を加えて異常終了しています。</p>
<p>サイズ上限を超えない場合は、入力データのメトリクス名に対応するシャードを取得し、シャード内の <code>items</code> のmapにメトリクス名のキーがある場合はmapの値のsliceにポイントデータを追加します。キーがない場合はそのキーに新たにポイントデータを設定します。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/cache.go#L232-L259">cache/cache.go#L232-L259</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Sets the given value under the specified key.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nx">Add</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">xlog</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">xlog</span><span class="p">.</span><span class="nx">Load</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">xlog</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">WriteTo</span><span class="p">(</span><span class="nx">xlog</span><span class="p">.(</span><span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="c1">// Get map shard.</span>
    <span class="nx">count</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Data</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">maxSize</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Size</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">maxSize</span> <span class="p">{</span>
        <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">overflowCnt</span><span class="p">,</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">count</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="p">}</span>

    <span class="nx">shard</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GetShard</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span>

    <span class="nx">shard</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">Metric</span><span class="p">];</span> <span class="nx">exists</span> <span class="p">{</span>
        <span class="nx">values</span><span class="p">.</span><span class="nx">Data</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Data</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Data</span><span class="o">...</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">Metric</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span>
    <span class="p">}</span>
    <span class="nx">shard</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

    <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">count</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="cachepersister">
<h2>Cacheの内容をディスクに書き出すpersister</h2>
<p>次は上で <code>Cache</code> に格納したポイントデータをディスクに書き出す処理を見ていきます。</p>
<p><code>(app *App) Start()</code> というメソッドの中で <code>app.startPersister()</code> を呼んでpersisterを開始しています。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/carbon/app.go#L245-L253">carbon/app.go#L245-L253</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>245
246
247
248
249
250
251
252
253</pre></div></td><td class="code"><div class="highlight"><pre><span></span>    <span class="nx">core</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span>
    <span class="nx">core</span><span class="p">.</span><span class="nx">SetMaxSize</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">MaxSize</span><span class="p">)</span>
    <span class="nx">core</span><span class="p">.</span><span class="nx">SetWriteStrategy</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">WriteStrategy</span><span class="p">)</span>

    <span class="nx">app</span><span class="p">.</span><span class="nx">Cache</span> <span class="p">=</span> <span class="nx">core</span>

    <span class="cm">/* WHISPER start */</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">startPersister</span><span class="p">()</span>
    <span class="cm">/* WHISPER end */</span>
</pre></div>
</td></tr></table><p><code>App</code> の <code>startPersister</code> メソッドの定義です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/carbon/app.go#L211-L228">carbon/app.go#L211-L228</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">App</span><span class="p">)</span> <span class="nx">startPersister</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="o">:=</span> <span class="nx">persister</span><span class="p">.</span><span class="nx">NewWhisper</span><span class="p">(</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">DataDir</span><span class="p">,</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">Schemas</span><span class="p">,</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">Aggregation</span><span class="p">,</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">WriteoutQueue</span><span class="p">().</span><span class="nx">GetNotConfirmed</span><span class="p">,</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">Confirm</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">SetMaxUpdatesPerSecond</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">MaxUpdatesPerSecond</span><span class="p">)</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">SetSparse</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">Sparse</span><span class="p">)</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">SetWorkers</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">Workers</span><span class="p">)</span>

        <span class="nx">p</span><span class="p">.</span><span class="nx">Start</span><span class="p">()</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">Persister</span> <span class="p">=</span> <span class="nx">p</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>persister.NewWhisper</code> の関数定義です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/persister/whisper.go#L48-L67">persister/whisper.go#L48-L67</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// NewWhisper create instance of Whisper</span>
<span class="kd">func</span> <span class="nx">NewWhisper</span><span class="p">(</span>
    <span class="nx">rootPath</span> <span class="kt">string</span><span class="p">,</span>
    <span class="nx">schemas</span> <span class="nx">WhisperSchemas</span><span class="p">,</span>
    <span class="nx">aggregation</span> <span class="o">*</span><span class="nx">WhisperAggregation</span><span class="p">,</span>
    <span class="nx">recv</span> <span class="kd">func</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span>
    <span class="nx">confirm</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">))</span> <span class="o">*</span><span class="nx">Whisper</span> <span class="p">{</span>

    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Whisper</span><span class="p">{</span>
        <span class="nx">recv</span><span class="p">:</span>                <span class="nx">recv</span><span class="p">,</span>
        <span class="nx">confirm</span><span class="p">:</span>             <span class="nx">confirm</span><span class="p">,</span>
        <span class="nx">schemas</span><span class="p">:</span>             <span class="nx">schemas</span><span class="p">,</span>
        <span class="nx">aggregation</span><span class="p">:</span>         <span class="nx">aggregation</span><span class="p">,</span>
        <span class="nx">workersCount</span><span class="p">:</span>        <span class="mi">1</span><span class="p">,</span>
        <span class="nx">rootPath</span><span class="p">:</span>            <span class="nx">rootPath</span><span class="p">,</span>
        <span class="nx">maxUpdatesPerSecond</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">logger</span><span class="p">:</span>              <span class="nx">zapwriter</span><span class="p">.</span><span class="nx">Logger</span><span class="p">(</span><span class="s">&quot;persister&quot;</span><span class="p">),</span>
        <span class="nx">createLogger</span><span class="p">:</span>        <span class="nx">zapwriter</span><span class="p">.</span><span class="nx">Logger</span><span class="p">(</span><span class="s">&quot;whisper:new&quot;</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>Whisper</code> 構造体の定義です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/persister/whisper.go#L19-L46">persister/whisper.go#L19-L46</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">const</span> <span class="nx">storeMutexCount</span> <span class="p">=</span> <span class="mi">32768</span>

<span class="kd">type</span> <span class="nx">StoreFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Whisper</span><span class="p">,</span> <span class="nx">values</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">)</span>

<span class="c1">// Whisper write data to *.wsp files</span>
<span class="kd">type</span> <span class="nx">Whisper</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">helper</span><span class="p">.</span><span class="nx">Stoppable</span>
    <span class="nx">updateOperations</span>    <span class="kt">uint32</span>
    <span class="nx">committedPoints</span>     <span class="kt">uint32</span>
    <span class="nx">recv</span>                <span class="kd">func</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span>
    <span class="nx">confirm</span>             <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">)</span>
    <span class="nx">schemas</span>             <span class="nx">WhisperSchemas</span>
    <span class="nx">aggregation</span>         <span class="o">*</span><span class="nx">WhisperAggregation</span>
    <span class="nx">workersCount</span>        <span class="kt">int</span>
    <span class="nx">rootPath</span>            <span class="kt">string</span>
    <span class="nx">created</span>             <span class="kt">uint32</span> <span class="c1">// counter</span>
    <span class="nx">sparse</span>              <span class="kt">bool</span>
    <span class="nx">maxUpdatesPerSecond</span> <span class="kt">int</span>
    <span class="nx">throttleTicker</span>      <span class="o">*</span><span class="nx">ThrottleTicker</span>
    <span class="nx">storeMutex</span>          <span class="p">[</span><span class="nx">storeMutexCount</span><span class="p">]</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
    <span class="nx">mockStore</span>           <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="nx">StoreFunc</span><span class="p">,</span> <span class="kd">func</span><span class="p">())</span>
    <span class="nx">logger</span>              <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
    <span class="nx">createLogger</span>        <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
    <span class="c1">// blockThrottleNs        uint64 // sum ns counter</span>
    <span class="c1">// blockQueueGetNs        uint64 // sum ns counter</span>
    <span class="c1">// blockAvoidConcurrentNs uint64 // sum ns counter</span>
    <span class="c1">// blockUpdateManyNs      uint64 // sum ns counter</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>次は <code>NewWhisper</code> の呼び出しで <code>recv</code> パラメータに渡していた
<code>app.Cache.WriteoutQueue().GetNotConfirmed</code> を見て行きます。</p>
<p>まず <code>Cache</code> の <code>WriteOutQueue</code> メソッドは単に <code>writeoutQueue</code> フィールドの値を返すだけです。
このフィールドには上に引用した <code>cache/cache.go</code> の77行目で <code>NewWriteoutQueue</code> 関数の戻り値を設定しています。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/cache.go#L301-L303">cache/cache.go#L301-L303</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>301
302
303</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nx">WriteoutQueue</span><span class="p">()</span> <span class="o">*</span><span class="nx">WriteoutQueue</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">writeoutQueue</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>NewWriteoutQueue</code> 関数の定義です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/writeout_queue.go#L24-L31">cache/writeout_queue.go#L24-L31</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">NewWriteoutQueue</span><span class="p">(</span><span class="nx">cache</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="o">*</span><span class="nx">WriteoutQueue</span> <span class="p">{</span>
    <span class="nx">q</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">WriteoutQueue</span><span class="p">{</span>
        <span class="nx">cache</span><span class="p">:</span> <span class="nx">cache</span><span class="p">,</span>
        <span class="nx">queue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="nx">q</span><span class="p">.</span><span class="nx">rebuild</span> <span class="p">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">makeRebuildCallback</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">{})</span>
    <span class="k">return</span> <span class="nx">q</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>WriteoutQueue</code> 構造体の定義です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/writeout_queue.go#L13-L22">cache/writeout_queue.go#L13-L22</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">type</span> <span class="nx">WriteoutQueue</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
    <span class="nx">cache</span> <span class="o">*</span><span class="nx">Cache</span>

    <span class="c1">// Writeout queue. Usage:</span>
    <span class="c1">// q := &lt;- queue</span>
    <span class="c1">// p := cache.Pop(q.Metric)</span>
    <span class="nx">queue</span>   <span class="kd">chan</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span>
    <span class="nx">rebuild</span> <span class="kd">func</span><span class="p">(</span><span class="nx">abort</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="kd">chan</span> <span class="kt">bool</span> <span class="c1">// return chan waiting for complete</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>WriteoutQueue</code> の <code>makeRebuildCallback</code> メソッドの実装です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/writeout_queue.go#L33-L68">cache/writeout_queue.go#L33-L68</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">WriteoutQueue</span><span class="p">)</span> <span class="nx">makeRebuildCallback</span><span class="p">(</span><span class="nx">nextRebuildTime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="kd">func</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="kd">chan</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nextRebuildOnce</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
    <span class="nx">nextRebuildComplete</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>

    <span class="nx">nextRebuild</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">abort</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="kd">chan</span> <span class="kt">bool</span> <span class="p">{</span>
        <span class="c1">// next rebuild</span>
        <span class="nx">nextRebuildOnce</span><span class="p">.</span><span class="nx">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">now</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
            <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">zapwriter</span><span class="p">.</span><span class="nx">Logger</span><span class="p">(</span><span class="s">&quot;cache&quot;</span><span class="p">)</span>

            <span class="nx">logger</span><span class="p">.</span><span class="nx">Debug</span><span class="p">(</span><span class="s">&quot;WriteoutQueue.nextRebuildOnce.Do&quot;</span><span class="p">,</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;now&quot;</span><span class="p">,</span> <span class="nx">now</span><span class="p">.</span><span class="nx">String</span><span class="p">()),</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;next&quot;</span><span class="p">,</span> <span class="nx">nextRebuildTime</span><span class="p">.</span><span class="nx">String</span><span class="p">()),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nx">now</span><span class="p">.</span><span class="nx">Before</span><span class="p">(</span><span class="nx">nextRebuildTime</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">sleepTime</span> <span class="o">:=</span> <span class="nx">nextRebuildTime</span><span class="p">.</span><span class="nx">Sub</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">Debug</span><span class="p">(</span><span class="s">&quot;WriteoutQueue sleep before rebuild&quot;</span><span class="p">,</span>
                    <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;sleepTime&quot;</span><span class="p">,</span> <span class="nx">sleepTime</span><span class="p">.</span><span class="nx">String</span><span class="p">()),</span>
                <span class="p">)</span>

                <span class="k">select</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="nx">sleepTime</span><span class="p">):</span>
                    <span class="c1">// pass</span>
                <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">abort</span><span class="p">:</span>
                    <span class="c1">// pass</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="nx">q</span><span class="p">.</span><span class="nx">update</span><span class="p">()</span>
            <span class="nb">close</span><span class="p">(</span><span class="nx">nextRebuildComplete</span><span class="p">)</span>
        <span class="p">})</span>

        <span class="k">return</span> <span class="nx">nextRebuildComplete</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">nextRebuild</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>WriteoutQueue</code> の <code>GetNotConfirmed</code> とそこから呼ばれる <code>get</code> の実装です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/writeout_queue.go#L79-L118">cache/writeout_queue.go#L79-L118</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">WriteoutQueue</span><span class="p">)</span> <span class="nx">get</span><span class="p">(</span><span class="nx">abort</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">pop</span> <span class="kd">func</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span> <span class="nx">exists</span> <span class="kt">bool</span><span class="p">))</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span> <span class="p">{</span>
<span class="nx">QueueLoop</span><span class="p">:</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
        <span class="nx">queue</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">queue</span>
        <span class="nx">rebuild</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">rebuild</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>

    <span class="nx">FetchLoop</span><span class="p">:</span>
        <span class="k">for</span> <span class="p">{</span>
            <span class="k">select</span> <span class="p">{</span>
            <span class="k">case</span> <span class="nx">qp</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">queue</span><span class="p">:</span>
                <span class="c1">// pop from cache</span>
                <span class="k">if</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">pop</span><span class="p">(</span><span class="nx">qp</span><span class="p">.</span><span class="nx">Metric</span><span class="p">);</span> <span class="nx">exists</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">p</span>
                <span class="p">}</span>
                <span class="k">continue</span> <span class="nx">FetchLoop</span>
            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">abort</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">nil</span>
            <span class="k">default</span><span class="p">:</span>
                <span class="c1">// queue is empty, create new</span>
                <span class="k">select</span> <span class="p">{</span>
                <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">rebuild</span><span class="p">(</span><span class="nx">abort</span><span class="p">):</span>
                    <span class="c1">// wait for rebuild</span>
                    <span class="k">continue</span> <span class="nx">QueueLoop</span>
                <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">abort</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">nil</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">WriteoutQueue</span><span class="p">)</span> <span class="nx">Get</span><span class="p">(</span><span class="nx">abort</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">q</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">abort</span><span class="p">,</span> <span class="nx">q</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">Pop</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">WriteoutQueue</span><span class="p">)</span> <span class="nx">GetNotConfirmed</span><span class="p">(</span><span class="nx">abort</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">q</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">abort</span><span class="p">,</span> <span class="nx">q</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">PopNotConfirmed</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>Cache</code> の <code>Pop</code> メソッドと <code>PopNotConfirmed</code> メソッドの実装です。
<code>PopNotConfirmed</code> メソッドはシャードの <code>items</code> からポイントデータを取り出し、削除して <code>notConfirmedUsed</code> に追加しています。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/cache.go#L261-L299">cache/writeout_queue.go#L261-L299</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// Removes an element from the map and returns it</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nx">Pop</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span> <span class="nx">exists</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Try to get shard.</span>
    <span class="nx">shard</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GetShard</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">shard</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">exists</span> <span class="p">=</span> <span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nb">delete</span><span class="p">(</span><span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
    <span class="nx">shard</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">exists</span> <span class="p">{</span>
        <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="o">-</span><span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Data</span><span class="p">)))</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">exists</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nx">PopNotConfirmed</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span> <span class="nx">exists</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Try to get shard.</span>
    <span class="nx">shard</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">GetShard</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="nx">shard</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
    <span class="nx">p</span><span class="p">,</span> <span class="nx">exists</span> <span class="p">=</span> <span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
    <span class="nb">delete</span><span class="p">(</span><span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">exists</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmedUsed</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmed</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmed</span><span class="p">[</span><span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmedUsed</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmed</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmed</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmedUsed</span><span class="o">++</span>
    <span class="p">}</span>
    <span class="nx">shard</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">exists</span> <span class="p">{</span>
        <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="o">-</span><span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Data</span><span class="p">)))</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">exists</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="whisperstart">
<h2>WhisperのStartメソッド</h2>
<p>次は上の <code>carbon/app.go</code> の224行目で呼び出している <code>Whisper</code> の <code>Start</code> メソッドを見て行きます。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/persister/whisper.go#L265-L278">persister/whisper.go#L265-L278</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>265
266
267
268
269
270
271
272
273
274
275
276
277
278</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Whisper</span><span class="p">)</span> <span class="nx">Start</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nx">StartFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>

        <span class="nx">p</span><span class="p">.</span><span class="nx">throttleTicker</span> <span class="p">=</span> <span class="nx">NewThrottleTicker</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">maxUpdatesPerSecond</span><span class="p">)</span>

        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">workersCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">p</span><span class="p">.</span><span class="nx">worker</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">recv</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">confirm</span><span class="p">,</span> <span class="nx">exit</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p><code>Whisper</code> の <code>worker</code> メソッドの実装です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/persister/whisper.go#L199-L232">persister/whisper.go#L199-L232</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Whisper</span><span class="p">)</span> <span class="nx">worker</span><span class="p">(</span><span class="nx">recv</span> <span class="kd">func</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span> <span class="nx">confirm</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">),</span> <span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">storeFunc</span> <span class="o">:=</span> <span class="nx">store</span>
    <span class="kd">var</span> <span class="nx">doneCb</span> <span class="kd">func</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">mockStore</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">storeFunc</span><span class="p">,</span> <span class="nx">doneCb</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">mockStore</span><span class="p">()</span>
    <span class="p">}</span>

<span class="nx">LOOP</span><span class="p">:</span>
    <span class="k">for</span> <span class="p">{</span>
        <span class="c1">// start := time.Now()</span>
        <span class="k">select</span> <span class="p">{</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">p</span><span class="p">.</span><span class="nx">throttleTicker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
            <span class="c1">// atomic.AddUint64(&amp;p.blockThrottleNs, uint64(time.Since(start).Nanoseconds()))</span>
            <span class="c1">// pass</span>
        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">exit</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="c1">// start = time.Now()</span>
        <span class="nx">points</span> <span class="o">:=</span> <span class="nx">recv</span><span class="p">(</span><span class="nx">exit</span><span class="p">)</span>
        <span class="c1">// atomic.AddUint64(&amp;p.blockQueueGetNs, uint64(time.Since(start).Nanoseconds()))</span>
        <span class="k">if</span> <span class="nx">points</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="c1">// exit closed</span>
            <span class="k">break</span> <span class="nx">LOOP</span>
        <span class="p">}</span>
        <span class="nx">storeFunc</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">points</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">doneCb</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">doneCb</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">confirm</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">confirm</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>上記の <code>persister/whisper.go</code> の200行目で参照している <code>store</code> 関数の実装です。</p>
<p><a class="reference external" href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/persister/whisper.go#L107-L197">persister/whisper.go#L107-L197</a></p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">store</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Whisper</span><span class="p">,</span> <span class="nx">values</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// avoid concurrent store same metric</span>
    <span class="c1">// @TODO: may be flock?</span>
    <span class="c1">// start := time.Now()</span>
    <span class="nx">mutexIndex</span> <span class="o">:=</span> <span class="nx">fnv32</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span> <span class="o">%</span> <span class="nx">storeMutexCount</span>
    <span class="nx">p</span><span class="p">.</span><span class="nx">storeMutex</span><span class="p">[</span><span class="nx">mutexIndex</span><span class="p">].</span><span class="nx">Lock</span><span class="p">()</span>
    <span class="c1">// atomic.AddUint64(&amp;p.blockAvoidConcurrentNs, uint64(time.Since(start).Nanoseconds()))</span>
    <span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">storeMutex</span><span class="p">[</span><span class="nx">mutexIndex</span><span class="p">].</span><span class="nx">Unlock</span><span class="p">()</span>

    <span class="nx">path</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Join</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">rootPath</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Replace</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;.wsp&quot;</span><span class="p">)</span>

    <span class="nx">w</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">whisper</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="c1">// create new whisper if file not exists</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nx">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;failed to open whisper file&quot;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;path&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="nx">schema</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">schemas</span><span class="p">.</span><span class="nx">Match</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;no storage schema defined for metric&quot;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;metric&quot;</span><span class="p">,</span> <span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="nx">aggr</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">aggr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;no storage aggregation defined for metric&quot;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;metric&quot;</span><span class="p">,</span> <span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">MkdirAll</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nx">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">ModeDir</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">ModePerm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;mkdir failed&quot;</span><span class="p">,</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;dir&quot;</span><span class="p">,</span> <span class="nx">filepath</span><span class="p">.</span><span class="nx">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">)),</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;path&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="nx">w</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">whisper</span><span class="p">.</span><span class="nx">CreateWithOptions</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">Retentions</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">aggregationMethod</span><span class="p">,</span> <span class="nb">float32</span><span class="p">(</span><span class="nx">aggr</span><span class="p">.</span><span class="nx">xFilesFactor</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">whisper</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
            <span class="nx">Sparse</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">sparse</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;create new whisper file failed&quot;</span><span class="p">,</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;path&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;retention&quot;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">RetentionStr</span><span class="p">),</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;schema&quot;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">Name</span><span class="p">),</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;aggregation&quot;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">Float64</span><span class="p">(</span><span class="s">&quot;xFilesFactor&quot;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">xFilesFactor</span><span class="p">),</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">aggregationMethodStr</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>

        <span class="nx">p</span><span class="p">.</span><span class="nx">createLogger</span><span class="p">.</span><span class="nx">Debug</span><span class="p">(</span><span class="s">&quot;created&quot;</span><span class="p">,</span>
            <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;path&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span>
            <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;retention&quot;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">RetentionStr</span><span class="p">),</span>
            <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;schema&quot;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">Name</span><span class="p">),</span>
            <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;aggregation&quot;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
            <span class="nx">zap</span><span class="p">.</span><span class="nx">Float64</span><span class="p">(</span><span class="s">&quot;xFilesFactor&quot;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">xFilesFactor</span><span class="p">),</span>
            <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">aggregationMethodStr</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">created</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">points</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">whisper</span><span class="p">.</span><span class="nx">TimeSeriesPoint</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Data</span><span class="p">))</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">r</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">values</span><span class="p">.</span><span class="nx">Data</span> <span class="p">{</span>
        <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">whisper</span><span class="p">.</span><span class="nx">TimeSeriesPoint</span><span class="p">{</span><span class="nx">Time</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Timestamp</span><span class="p">),</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Value</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">committedPoints</span><span class="p">,</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Data</span><span class="p">)))</span>
    <span class="nx">atomic</span><span class="p">.</span><span class="nx">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">updateOperations</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">defer</span> <span class="nx">w</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">r</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">r</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;UpdateMany panic recovered&quot;</span><span class="p">,</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;path&quot;</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span>
                <span class="nx">zap</span><span class="p">.</span><span class="nx">String</span><span class="p">(</span><span class="s">&quot;traceback&quot;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">r</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}()</span>

    <span class="c1">// start = time.Now()</span>
    <span class="nx">w</span><span class="p">.</span><span class="nx">UpdateMany</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
    <span class="c1">// atomic.AddUint64(&amp;p.blockUpdateManyNs, uint64(time.Since(start).Nanoseconds()))</span>
<span class="p">}</span>
</pre></div>
</td></tr></table><p>ここからは <code>whisper.Open</code> や <code>whisper.CreateWithOptions</code> や <code>Whisper</code> の <code>UpdateMany</code> メソッドを見ていくことになります。
これは
<a class="reference external" href="https://github.com/lomik/go-whisper">lomik/go-whisper: A Go port of Graphite's Whisper timeseries database</a>
と別レポジトリになるのと、記事が長くなってきたので別記事にすることにします。</p>
<p><a class="reference external" href="/blog/2017/04/29/go-whisper-code-reading/">go-whisperをコードリーディングしてみた</a> に続きます。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>