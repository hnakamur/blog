<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.96.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>go-carbonのTCPレシーバについてコードリーディングしてみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2022. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>go-carbonのTCPレシーバについてコードリーディングしてみた</h1>
  <time datetime=2017-04-29T11:15:00&#43;0900 class="post-date">2017-04-29</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#tcpレシーバの生成">TCPレシーバの生成</a></li>
    <li><a href="#リクエスト処理">リクエスト処理</a></li>
    <li><a href="#rcvoutに出力した後の処理">rcv.outに出力した後の処理</a></li>
    <li><a href="#cacheのaddメソッド">CacheのAddメソッド</a></li>
    <li><a href="#cacheの内容をディスクに書き出すpersister">Cacheの内容をディスクに書き出すpersister</a></li>
    <li><a href="#whisperのstartメソッド">WhisperのStartメソッド</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="https://github.com/lomik/go-carbon">lomik/go-carbon: Golang implementation of Graphite/Carbon server with classic architecture: Agent -&gt; Cache -&gt; Persister</a>
のTCPレシーバについてコードを読んでみたのでメモです。</p>
<p>対象のコミットは
<a href="https://github.com/lomik/go-carbon/tree/42b9832d13240ff044c86768e8d0dc1f356d9458">https://github.com/lomik/go-carbon/tree/42b9832d13240ff044c86768e8d0dc1f356d9458</a>
です。</p>
<h2 id="tcpレシーバの生成">TCPレシーバの生成</h2>
<p><code>(app *App) Start()</code> というメソッドの中で <code>receiver.New</code> を呼んでTCPレシーバを生成しています。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/carbon/app.go#L271-L281">carbon/app.go#L271-L281</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="nx">TCP</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">receiver</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;tcp://&#34;</span><span class="o">+</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">Listen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">receiver</span><span class="p">.</span><span class="nf">OutFunc</span><span class="p">(</span><span class="nx">core</span><span class="p">.</span><span class="nx">Add</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">receiver</span><span class="p">.</span><span class="nf">BufferSize</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">BufferSize</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>receiver.New</code> 内では <code>TCP</code> というstructのインスタンスを生成して <code>Listen</code> メソッドを呼び出しています。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/receiver/receiver.go#L110-L127">receiver/receiver.go#L110-L127</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">r</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">TCP</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">out</span><span class="p">:</span>    <span class="nx">blackhole</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="p">:</span>   <span class="nx">u</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">logger</span><span class="p">:</span> <span class="nx">zapwriter</span><span class="p">.</span><span class="nf">Logger</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">u</span><span class="p">.</span><span class="nx">Scheme</span> <span class="o">==</span> <span class="s">&#34;pickle&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nx">isPickle</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="nx">r</span><span class="p">.</span><span class="nx">maxPickleMessageSize</span> <span class="p">=</span> <span class="mi">67108864</span> <span class="c1">// 64Mb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">optApply</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">opts</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">optApply</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>TCP</code> の <code>Listen</code> メソッド内では <code>Accept</code> したらgoroutineを作って code:<code>HandleConnection</code> フィールドに設定されたハンドラで処理しています。</p>
<p>また、197行目あたりを見ると <code>rcv.buffer</code> が設定されているときは <code>rcv.out</code> に書き込まれたポイントデータをバッファリングしてから元の出力先のチャンネルに送るように変更しています。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/receiver/tcp.go#L192-L237">receiver/tcp.go#L192-L237</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">handler</span> <span class="o">:=</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">HandleConnection</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">isPickle</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">handler</span> <span class="p">=</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">handlePickle</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">originalOut</span> <span class="o">:=</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">rcv</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">exit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nx">p</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">buffer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nf">originalOut</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">rcv</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">rcv</span><span class="p">.</span><span class="nx">buffer</span> <span class="o">&lt;-</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">rcv</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">tcpListener</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">conn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">tcpListener</span><span class="p">.</span><span class="nf">Accept</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(),</span> <span class="s">&#34;use of closed network connection&#34;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rcv</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;failed to accept connection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">rcv</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">handler</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="リクエスト処理">リクエスト処理</h2>
<p><code>TCP</code> の <code>HandleConnection</code> の実装は以下のようになっています。
リクエストの内容を1行ずつ <code>points.ParseText</code> 関数によりパーズして、その結果を <code>rcv.out</code> に書き出しています。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/receiver/tcp.go#L49-L99">receiver/tcp.go#L49-L99</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rcv</span> <span class="o">*</span><span class="nx">TCP</span><span class="p">)</span> <span class="nf">HandleConnection</span><span class="p">(</span><span class="nx">conn</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">active</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">active</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">reader</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">finished</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nb">close</span><span class="p">(</span><span class="nx">finished</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">rcv</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">finished</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">exit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">conn</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">conn</span><span class="p">.</span><span class="nf">SetReadDeadline</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">line</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">reader</span><span class="p">.</span><span class="nf">ReadBytes</span><span class="p">(</span><span class="sc">&#39;\n&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">rcv</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;unfinished line&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;line&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">line</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">errors</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">rcv</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;read error&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span> <span class="c1">// skip empty lines
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">points</span><span class="p">.</span><span class="nf">ParseText</span><span class="p">(</span><span class="nb">string</span><span class="p">(</span><span class="nx">line</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">errors</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zapwriter</span><span class="p">.</span><span class="nf">Logger</span><span class="p">(</span><span class="s">&#34;parser&#34;</span><span class="p">).</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;parse failed&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;protocol&#34;</span><span class="p">,</span> <span class="nx">rcv</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;peer&#34;</span><span class="p">,</span> <span class="nx">conn</span><span class="p">.</span><span class="nf">RemoteAddr</span><span class="p">().</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rcv</span><span class="p">.</span><span class="nx">metricsReceived</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">rcv</span><span class="p">.</span><span class="nf">out</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>points.ParseText</code> 関数の定義です。 <code>*Points</code> を返しています。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/points/points.go#L125-L161">points/points.go#L125-L161</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ParseText</span><span class="p">(</span><span class="nx">line</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Points</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">row</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Trim</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span> <span class="s">&#34;\n \t\r&#34;</span><span class="p">),</span> <span class="s">&#34; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">row</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;bad message: %#v&#34;</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 0x2e == &#34;.&#34;. Or use split? @TODO: benchmark
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// if strings.Contains(row[0], &#34;..&#34;) || row[0][0] == 0x2e || row[0][len(row)-1] == 0x2e {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	return nil, fmt.Errorf(&#34;bad message: %#v&#34;, line)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">value</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseFloat</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">math</span><span class="p">.</span><span class="nf">IsNaN</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;bad message: %#v&#34;</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">tsf</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">strconv</span><span class="p">.</span><span class="nf">ParseFloat</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">math</span><span class="p">.</span><span class="nf">IsNaN</span><span class="p">(</span><span class="nx">tsf</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;bad message: %#v&#34;</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 315522000 == &#34;1980-01-01 00:00:00&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// if tsf &lt; 315532800 {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	return nil, fmt.Errorf(&#34;bad message: %#v&#34;, line)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 4102444800 = &#34;2100-01-01 00:00:00&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Hello people from the future
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// if tsf &gt; 4102444800 {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 	return nil, fmt.Errorf(&#34;bad message: %#v&#34;, line)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">OnePoint</span><span class="p">(</span><span class="nx">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">value</span><span class="p">,</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">tsf</span><span class="p">)),</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Points</code> の定義です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/points/points.go#L15-L25">points/points.go#L15-L25</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Point value/time pair
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Point</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Value</span>     <span class="kt">float64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Timestamp</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Points from carbon clients
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Points</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Metric</span> <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Data</span>   <span class="p">[]</span><span class="nx">Point</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="rcvoutに出力した後の処理">rcv.outに出力した後の処理</h2>
<p>次は <code>rcv.out</code> に出力されたデータがどう処理されるかを見ていきます。</p>
<p>冒頭に書いた <code>(app *App) Start()</code> というメソッドの中で <code>receiver.New</code> を呼んでTCPレシーバを生成している際に274行目で <code>receiver.OutFunc</code> に <code>core.Add</code> を指定して呼んでいます。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/carbon/app.go#L271-L281">carbon/app.go#L271-L281</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">if</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">app</span><span class="p">.</span><span class="nx">TCP</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">receiver</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;tcp://&#34;</span><span class="o">+</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">Listen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">receiver</span><span class="p">.</span><span class="nf">OutFunc</span><span class="p">(</span><span class="nx">core</span><span class="p">.</span><span class="nx">Add</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">receiver</span><span class="p">.</span><span class="nf">BufferSize</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Tcp</span><span class="p">.</span><span class="nx">BufferSize</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>receiver.OutFunc</code> の定義は以下の通りで、Functional Option Patternで実装されています。
Functional Option Patternについては <a href="http://qiita.com/weloan/items/56f1c7792088b5ede136">Go言語のFunctional Option Pattern - Qiita</a> やその記事の最後の原典を参照してください。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/receiver/receiver.go#L48-L59">receiver/receiver.go#L48-L59</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// OutFunc creates option for New contructor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">OutFunc</span><span class="p">(</span><span class="nx">out</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">))</span> <span class="nx">Option</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kd">func</span><span class="p">(</span><span class="nx">r</span> <span class="nx">Receiver</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.(</span><span class="o">*</span><span class="nx">TCP</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">t</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="nx">out</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.(</span><span class="o">*</span><span class="nx">UDP</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">t</span><span class="p">.</span><span class="nx">out</span> <span class="p">=</span> <span class="nx">out</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ということで <code>rcv.out</code> には <code>core.Add</code> が設定されることがわかりました。
<code>core</code> は <code>(app *App) Start()</code> というメソッド内で以下のコードで生成されるローカル変数です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/carbon/app.go#L245-L247">carbon/app.go#L245-L247</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">core</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">core</span><span class="p">.</span><span class="nf">SetMaxSize</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">MaxSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">core</span><span class="p">.</span><span class="nf">SetWriteStrategy</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">WriteStrategy</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>cache.New</code> の実装は以下のようになっています。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/cache.go#L62-L79">cache/cache.go#L62-L79</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Creates a new cache instance
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">New</span><span class="p">()</span> <span class="o">*</span><span class="nx">Cache</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Cache</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">data</span><span class="p">:</span>          <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">Shard</span><span class="p">,</span> <span class="nx">shardCount</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">writeStrategy</span><span class="p">:</span> <span class="nx">Noop</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">maxSize</span><span class="p">:</span>       <span class="mi">1000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">shardCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">Shard</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">items</span><span class="p">:</span>        <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">notConfirmed</span><span class="p">:</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">writeoutQueue</span> <span class="p">=</span> <span class="nf">NewWriteoutQueue</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Cache</code> の構造体とそれに関連する定義は以下の通りです。
1024個の <code>Shard</code> に分けてポイントデータを保持しています。
<code>Shard</code> では <code>items</code> というmapと <code>notConfirmed</code> というsliceでポイントデータを保持しています。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/cache.go#L18-L60">cache/cache.go#L18-L60</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">WriteStrategy</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">MaximumLength</span> <span class="nx">WriteStrategy</span> <span class="p">=</span> <span class="kc">iota</span>
</span></span><span class="line"><span class="cl">    <span class="nx">TimestampOrder</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Noop</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">shardCount</span> <span class="p">=</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// A &#34;thread&#34; safe map of type string:Anything.
</span></span></span><span class="line"><span class="cl"><span class="c1">// To avoid lock bottlenecks this map is dived to several (shardCount) map shards.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Cache</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">queueLastBuild</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">data</span> <span class="p">[]</span><span class="o">*</span><span class="nx">Shard</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">maxSize</span>       <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writeStrategy</span> <span class="nx">WriteStrategy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">writeoutQueue</span> <span class="o">*</span><span class="nx">WriteoutQueue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">xlog</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">Value</span> <span class="c1">// io.Writer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">stat</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">size</span>              <span class="kt">int32</span>  <span class="c1">// changing via atomic
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">queueBuildCnt</span>     <span class="kt">uint32</span> <span class="c1">// number of times writeout queue was built
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">queueBuildTimeMs</span>  <span class="kt">uint32</span> <span class="c1">// time spent building writeout queue in milliseconds
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">queueWriteoutTime</span> <span class="kt">uint32</span> <span class="c1">// in milliseconds
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">overflowCnt</span>       <span class="kt">uint32</span> <span class="c1">// drop packages if cache full
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">queryCnt</span>          <span class="kt">uint32</span> <span class="c1">// number of queries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// A &#34;thread&#34; safe string to anything map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Shard</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>     <span class="c1">// Read Write mutex, guards access to internal map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">items</span>            <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span>
</span></span><span class="line"><span class="cl">    <span class="nx">notConfirmed</span>     <span class="p">[]</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span> <span class="c1">// linear search for value/slot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">notConfirmedUsed</span> <span class="kt">int</span>              <span class="c1">// search value in notConfirmed[:notConfirmedUsed]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="cacheのaddメソッド">CacheのAddメソッド</h2>
<p><code>Cache</code> の <code>Add</code> メソッドは以下のようになっています。</p>
<p><code>maxSize</code> フィールドに値が設定されている場合 <code>Cache</code> の <code>Size</code> メソッドの結果がそれを超える場合は <code>stat.OverflowCnt</code> の統計情報にデータ数を加えて異常終了しています。</p>
<p>サイズ上限を超えない場合は、入力データのメトリクス名に対応するシャードを取得し、シャード内の <code>items</code> のmapにメトリクス名のキーがある場合はmapの値のsliceにポイントデータを追加します。キーがない場合はそのキーに新たにポイントデータを設定します。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/cache.go#L232-L259">cache/cache.go#L232-L259</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Sets the given value under the specified key.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nf">Add</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">xlog</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">xlog</span><span class="p">.</span><span class="nf">Load</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">xlog</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nf">WriteTo</span><span class="p">(</span><span class="nx">xlog</span><span class="p">.(</span><span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Get map shard.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">count</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">c</span><span class="p">.</span><span class="nx">maxSize</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Size</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nx">maxSize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">overflowCnt</span><span class="p">,</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">count</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">shard</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetShard</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">shard</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">Metric</span><span class="p">];</span> <span class="nx">exists</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">values</span><span class="p">.</span><span class="nx">Data</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Data</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">Data</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">Metric</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">shard</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nb">int32</span><span class="p">(</span><span class="nx">count</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="cacheの内容をディスクに書き出すpersister">Cacheの内容をディスクに書き出すpersister</h2>
<p>次は上で <code>Cache</code> に格納したポイントデータをディスクに書き出す処理を見ていきます。</p>
<p><code>(app *App) Start()</code> というメソッドの中で <code>app.startPersister()</code> を呼んでpersisterを開始しています。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/carbon/app.go#L245-L253">carbon/app.go#L245-L253</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">core</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">core</span><span class="p">.</span><span class="nf">SetMaxSize</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">MaxSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">core</span><span class="p">.</span><span class="nf">SetWriteStrategy</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">WriteStrategy</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nx">Cache</span> <span class="p">=</span> <span class="nx">core</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* WHISPER start */</span>
</span></span><span class="line"><span class="cl"><span class="nx">app</span><span class="p">.</span><span class="nf">startPersister</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* WHISPER end */</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>App</code> の <code>startPersister</code> メソッドの定義です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/carbon/app.go#L211-L228">carbon/app.go#L211-L228</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">app</span> <span class="o">*</span><span class="nx">App</span><span class="p">)</span> <span class="nf">startPersister</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span> <span class="o">:=</span> <span class="nx">persister</span><span class="p">.</span><span class="nf">NewWhisper</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">DataDir</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">Schemas</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">Aggregation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">app</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nf">WriteoutQueue</span><span class="p">().</span><span class="nx">GetNotConfirmed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">app</span><span class="p">.</span><span class="nx">Cache</span><span class="p">.</span><span class="nx">Confirm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nf">SetMaxUpdatesPerSecond</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">MaxUpdatesPerSecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nf">SetSparse</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">Sparse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nf">SetWorkers</span><span class="p">(</span><span class="nx">app</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">Whisper</span><span class="p">.</span><span class="nx">Workers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nf">Start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">app</span><span class="p">.</span><span class="nx">Persister</span> <span class="p">=</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>persister.NewWhisper</code> の関数定義です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/persister/whisper.go#L48-L67">persister/whisper.go#L48-L67</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// NewWhisper create instance of Whisper
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">NewWhisper</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rootPath</span> <span class="kt">string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">schemas</span> <span class="nx">WhisperSchemas</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">aggregation</span> <span class="o">*</span><span class="nx">WhisperAggregation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">recv</span> <span class="kd">func</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">confirm</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">))</span> <span class="o">*</span><span class="nx">Whisper</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Whisper</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">recv</span><span class="p">:</span>                <span class="nx">recv</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">confirm</span><span class="p">:</span>             <span class="nx">confirm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">schemas</span><span class="p">:</span>             <span class="nx">schemas</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">aggregation</span><span class="p">:</span>         <span class="nx">aggregation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">workersCount</span><span class="p">:</span>        <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">rootPath</span><span class="p">:</span>            <span class="nx">rootPath</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">maxUpdatesPerSecond</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">logger</span><span class="p">:</span>              <span class="nx">zapwriter</span><span class="p">.</span><span class="nf">Logger</span><span class="p">(</span><span class="s">&#34;persister&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">createLogger</span><span class="p">:</span>        <span class="nx">zapwriter</span><span class="p">.</span><span class="nf">Logger</span><span class="p">(</span><span class="s">&#34;whisper:new&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Whisper</code> 構造体の定義です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/persister/whisper.go#L19-L46">persister/whisper.go#L19-L46</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="nx">storeMutexCount</span> <span class="p">=</span> <span class="mi">32768</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">StoreFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Whisper</span><span class="p">,</span> <span class="nx">values</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Whisper write data to *.wsp files
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">Whisper</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">helper</span><span class="p">.</span><span class="nx">Stoppable</span>
</span></span><span class="line"><span class="cl">    <span class="nx">updateOperations</span>    <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">committedPoints</span>     <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">recv</span>                <span class="kd">func</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span>
</span></span><span class="line"><span class="cl">    <span class="nx">confirm</span>             <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">schemas</span>             <span class="nx">WhisperSchemas</span>
</span></span><span class="line"><span class="cl">    <span class="nx">aggregation</span>         <span class="o">*</span><span class="nx">WhisperAggregation</span>
</span></span><span class="line"><span class="cl">    <span class="nx">workersCount</span>        <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rootPath</span>            <span class="kt">string</span>
</span></span><span class="line"><span class="cl">    <span class="nx">created</span>             <span class="kt">uint32</span> <span class="c1">// counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sparse</span>              <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxUpdatesPerSecond</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">throttleTicker</span>      <span class="o">*</span><span class="nx">ThrottleTicker</span>
</span></span><span class="line"><span class="cl">    <span class="nx">storeMutex</span>          <span class="p">[</span><span class="nx">storeMutexCount</span><span class="p">]</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mockStore</span>           <span class="kd">func</span><span class="p">()</span> <span class="p">(</span><span class="nx">StoreFunc</span><span class="p">,</span> <span class="kd">func</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">logger</span>              <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
</span></span><span class="line"><span class="cl">    <span class="nx">createLogger</span>        <span class="o">*</span><span class="nx">zap</span><span class="p">.</span><span class="nx">Logger</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// blockThrottleNs        uint64 // sum ns counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// blockQueueGetNs        uint64 // sum ns counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// blockAvoidConcurrentNs uint64 // sum ns counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// blockUpdateManyNs      uint64 // sum ns counter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>次は <code>NewWhisper</code> の呼び出しで <code>recv</code> パラメータに渡していた
<code>app.Cache.WriteoutQueue().GetNotConfirmed</code> を見て行きます。</p>
<p>まず <code>Cache</code> の <code>WriteOutQueue</code> メソッドは単に <code>writeoutQueue</code> フィールドの値を返すだけです。
このフィールドには上に引用した <code>cache/cache.go</code> の77行目で <code>NewWriteoutQueue</code> 関数の戻り値を設定しています。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/cache.go#L301-L303">cache/cache.go#L301-L303</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nf">WriteoutQueue</span><span class="p">()</span> <span class="o">*</span><span class="nx">WriteoutQueue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">writeoutQueue</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>NewWriteoutQueue</code> 関数の定義です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/writeout_queue.go#L24-L31">cache/writeout_queue.go#L24-L31</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">NewWriteoutQueue</span><span class="p">(</span><span class="nx">cache</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="o">*</span><span class="nx">WriteoutQueue</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">WriteoutQueue</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cache</span><span class="p">:</span> <span class="nx">cache</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">queue</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">q</span><span class="p">.</span><span class="nx">rebuild</span> <span class="p">=</span> <span class="nx">q</span><span class="p">.</span><span class="nf">makeRebuildCallback</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">{})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">q</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>WriteoutQueue</code> 構造体の定義です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/writeout_queue.go#L13-L22">cache/writeout_queue.go#L13-L22</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">WriteoutQueue</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
</span></span><span class="line"><span class="cl">    <span class="nx">cache</span> <span class="o">*</span><span class="nx">Cache</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Writeout queue. Usage:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// q := &lt;- queue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// p := cache.Pop(q.Metric)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">queue</span>   <span class="kd">chan</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span>
</span></span><span class="line"><span class="cl">    <span class="nx">rebuild</span> <span class="kd">func</span><span class="p">(</span><span class="nx">abort</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="kd">chan</span> <span class="kt">bool</span> <span class="c1">// return chan waiting for complete
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>WriteoutQueue</code> の <code>makeRebuildCallback</code> メソッドの実装です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/writeout_queue.go#L33-L68">cache/writeout_queue.go#L33-L68</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">WriteoutQueue</span><span class="p">)</span> <span class="nf">makeRebuildCallback</span><span class="p">(</span><span class="nx">nextRebuildTime</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">)</span> <span class="kd">func</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="kd">chan</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">nextRebuildOnce</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nextRebuildComplete</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">nextRebuild</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">abort</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="kd">chan</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// next rebuild
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">nextRebuildOnce</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">now</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nx">logger</span> <span class="o">:=</span> <span class="nx">zapwriter</span><span class="p">.</span><span class="nf">Logger</span><span class="p">(</span><span class="s">&#34;cache&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">logger</span><span class="p">.</span><span class="nf">Debug</span><span class="p">(</span><span class="s">&#34;WriteoutQueue.nextRebuildOnce.Do&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;now&#34;</span><span class="p">,</span> <span class="nx">now</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;next&#34;</span><span class="p">,</span> <span class="nx">nextRebuildTime</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">now</span><span class="p">.</span><span class="nf">Before</span><span class="p">(</span><span class="nx">nextRebuildTime</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">sleepTime</span> <span class="o">:=</span> <span class="nx">nextRebuildTime</span><span class="p">.</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">now</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="nx">logger</span><span class="p">.</span><span class="nf">Debug</span><span class="p">(</span><span class="s">&#34;WriteoutQueue sleep before rebuild&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;sleepTime&#34;</span><span class="p">,</span> <span class="nx">sleepTime</span><span class="p">.</span><span class="nf">String</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">sleepTime</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// pass
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">abort</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// pass
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">q</span><span class="p">.</span><span class="nf">update</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="nb">close</span><span class="p">(</span><span class="nx">nextRebuildComplete</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">nextRebuildComplete</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">nextRebuild</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>WriteoutQueue</code> の <code>GetNotConfirmed</code> とそこから呼ばれる <code>get</code> の実装です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/writeout_queue.go#L79-L118">cache/writeout_queue.go#L79-L118</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">WriteoutQueue</span><span class="p">)</span> <span class="nf">get</span><span class="p">(</span><span class="nx">abort</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">pop</span> <span class="kd">func</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span> <span class="nx">exists</span> <span class="kt">bool</span><span class="p">))</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nx">QueueLoop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">q</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">queue</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">queue</span>
</span></span><span class="line"><span class="cl">        <span class="nx">rebuild</span> <span class="o">:=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">rebuild</span>
</span></span><span class="line"><span class="cl">        <span class="nx">q</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">FetchLoop</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="nx">qp</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">queue</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// pop from cache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">if</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">exists</span> <span class="o">:=</span> <span class="nf">pop</span><span class="p">(</span><span class="nx">qp</span><span class="p">.</span><span class="nx">Metric</span><span class="p">);</span> <span class="nx">exists</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span> <span class="nx">FetchLoop</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">abort</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">            <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="c1">// queue is empty, create new
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="o">&lt;-</span><span class="nf">rebuild</span><span class="p">(</span><span class="nx">abort</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="c1">// wait for rebuild
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                    <span class="k">continue</span> <span class="nx">QueueLoop</span>
</span></span><span class="line"><span class="cl">                <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">abort</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">WriteoutQueue</span><span class="p">)</span> <span class="nf">Get</span><span class="p">(</span><span class="nx">abort</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">q</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">abort</span><span class="p">,</span> <span class="nx">q</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">Pop</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">q</span> <span class="o">*</span><span class="nx">WriteoutQueue</span><span class="p">)</span> <span class="nf">GetNotConfirmed</span><span class="p">(</span><span class="nx">abort</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">q</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">abort</span><span class="p">,</span> <span class="nx">q</span><span class="p">.</span><span class="nx">cache</span><span class="p">.</span><span class="nx">PopNotConfirmed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Cache</code> の <code>Pop</code> メソッドと <code>PopNotConfirmed</code> メソッドの実装です。
<code>PopNotConfirmed</code> メソッドはシャードの <code>items</code> からポイントデータを取り出し、削除して <code>notConfirmedUsed</code> に追加しています。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/cache/cache.go#L261-L299">cache/writeout_queue.go#L261-L299</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Removes an element from the map and returns it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nf">Pop</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span> <span class="nx">exists</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Try to get shard.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">shard</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetShard</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">shard</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">p</span><span class="p">,</span> <span class="nx">exists</span> <span class="p">=</span> <span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">delete</span><span class="p">(</span><span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">shard</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">exists</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="o">-</span><span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Data</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">exists</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nf">PopNotConfirmed</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span> <span class="nx">exists</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Try to get shard.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">shard</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">GetShard</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">shard</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">p</span><span class="p">,</span> <span class="nx">exists</span> <span class="p">=</span> <span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">delete</span><span class="p">(</span><span class="nx">shard</span><span class="p">.</span><span class="nx">items</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">exists</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmedUsed</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmed</span><span class="p">[</span><span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmedUsed</span><span class="p">]</span> <span class="p">=</span> <span class="nx">p</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmed</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmed</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">shard</span><span class="p">.</span><span class="nx">notConfirmedUsed</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">shard</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">exists</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddInt32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">c</span><span class="p">.</span><span class="nx">stat</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="o">-</span><span class="nb">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">Data</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">exists</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="whisperのstartメソッド">WhisperのStartメソッド</h2>
<p>次は上の <code>carbon/app.go</code> の224行目で呼び出している <code>Whisper</code> の <code>Start</code> メソッドを見て行きます。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/persister/whisper.go#L265-L278">persister/whisper.go#L265-L278</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Whisper</span><span class="p">)</span> <span class="nf">Start</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nf">StartFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nx">throttleTicker</span> <span class="p">=</span> <span class="nf">NewThrottleTicker</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">maxUpdatesPerSecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">workersCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">p</span><span class="p">.</span><span class="nf">Go</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">p</span><span class="p">.</span><span class="nf">worker</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">recv</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">confirm</span><span class="p">,</span> <span class="nx">exit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Whisper</code> の <code>worker</code> メソッドの実装です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/persister/whisper.go#L199-L232">persister/whisper.go#L199-L232</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Whisper</span><span class="p">)</span> <span class="nf">worker</span><span class="p">(</span><span class="nx">recv</span> <span class="kd">func</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">,</span> <span class="nx">confirm</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">),</span> <span class="nx">exit</span> <span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">storeFunc</span> <span class="o">:=</span> <span class="nx">store</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">doneCb</span> <span class="kd">func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">mockStore</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">storeFunc</span><span class="p">,</span> <span class="nx">doneCb</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">mockStore</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">LOOP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// start := time.Now()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">p</span><span class="p">.</span><span class="nx">throttleTicker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// atomic.AddUint64(&amp;p.blockThrottleNs, uint64(time.Since(start).Nanoseconds()))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// pass
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">exit</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// start = time.Now()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">points</span> <span class="o">:=</span> <span class="nf">recv</span><span class="p">(</span><span class="nx">exit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// atomic.AddUint64(&amp;p.blockQueueGetNs, uint64(time.Since(start).Nanoseconds()))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">points</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// exit closed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">break</span> <span class="nx">LOOP</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">storeFunc</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">points</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">doneCb</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">doneCb</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">confirm</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">confirm</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上記の <code>persister/whisper.go</code> の200行目で参照している <code>store</code> 関数の実装です。</p>
<p><a href="https://github.com/lomik/go-carbon/blob/42b9832d13240ff044c86768e8d0dc1f356d9458/persister/whisper.go#L107-L197">persister/whisper.go#L107-L197</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">store</span><span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Whisper</span><span class="p">,</span> <span class="nx">values</span> <span class="o">*</span><span class="nx">points</span><span class="p">.</span><span class="nx">Points</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// avoid concurrent store same metric
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// @TODO: may be flock?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// start := time.Now()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mutexIndex</span> <span class="o">:=</span> <span class="nf">fnv32</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span> <span class="o">%</span> <span class="nx">storeMutexCount</span>
</span></span><span class="line"><span class="cl">    <span class="nx">p</span><span class="p">.</span><span class="nx">storeMutex</span><span class="p">[</span><span class="nx">mutexIndex</span><span class="p">].</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// atomic.AddUint64(&amp;p.blockAvoidConcurrentNs, uint64(time.Since(start).Nanoseconds()))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">defer</span> <span class="nx">p</span><span class="p">.</span><span class="nx">storeMutex</span><span class="p">[</span><span class="nx">mutexIndex</span><span class="p">].</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">path</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">rootPath</span><span class="p">,</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">,</span> <span class="s">&#34;.&#34;</span><span class="p">,</span> <span class="s">&#34;/&#34;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s">&#34;.wsp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">w</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">whisper</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// create new whisper if file not exists
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;failed to open whisper file&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">schema</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">schemas</span><span class="p">.</span><span class="nf">Match</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;no storage schema defined for metric&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;metric&#34;</span><span class="p">,</span> <span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">aggr</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">aggregation</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">aggr</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;no storage aggregation defined for metric&#34;</span><span class="p">,</span> <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;metric&#34;</span><span class="p">,</span> <span class="nx">values</span><span class="p">.</span><span class="nx">Metric</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">),</span> <span class="nx">os</span><span class="p">.</span><span class="nx">ModeDir</span><span class="p">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">ModePerm</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;mkdir failed&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;dir&#34;</span><span class="p">,</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">path</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">w</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">whisper</span><span class="p">.</span><span class="nf">CreateWithOptions</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">Retentions</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">aggregationMethod</span><span class="p">,</span> <span class="nb">float32</span><span class="p">(</span><span class="nx">aggr</span><span class="p">.</span><span class="nx">xFilesFactor</span><span class="p">),</span> <span class="o">&amp;</span><span class="nx">whisper</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Sparse</span><span class="p">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">sparse</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;create new whisper file failed&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;retention&#34;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">RetentionStr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;schema&#34;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">Name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;aggregation&#34;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="s">&#34;xFilesFactor&#34;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">xFilesFactor</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;method&#34;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">aggregationMethodStr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">p</span><span class="p">.</span><span class="nx">createLogger</span><span class="p">.</span><span class="nf">Debug</span><span class="p">(</span><span class="s">&#34;created&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;retention&#34;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">RetentionStr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;schema&#34;</span><span class="p">,</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">Name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;aggregation&#34;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">zap</span><span class="p">.</span><span class="nf">Float64</span><span class="p">(</span><span class="s">&#34;xFilesFactor&#34;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">xFilesFactor</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;method&#34;</span><span class="p">,</span> <span class="nx">aggr</span><span class="p">.</span><span class="nx">aggregationMethodStr</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">created</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">points</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">whisper</span><span class="p">.</span><span class="nx">TimeSeriesPoint</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">r</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">values</span><span class="p">.</span><span class="nx">Data</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">whisper</span><span class="p">.</span><span class="nx">TimeSeriesPoint</span><span class="p">{</span><span class="nx">Time</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Timestamp</span><span class="p">),</span> <span class="nx">Value</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Value</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">committedPoints</span><span class="p">,</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">Data</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">AddUint32</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">updateOperations</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">r</span> <span class="o">:=</span> <span class="nb">recover</span><span class="p">();</span> <span class="nx">r</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">p</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;UpdateMany panic recovered&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;path&#34;</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="nx">zap</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;traceback&#34;</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprint</span><span class="p">(</span><span class="nx">r</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// start = time.Now()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">w</span><span class="p">.</span><span class="nf">UpdateMany</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// atomic.AddUint64(&amp;p.blockUpdateManyNs, uint64(time.Since(start).Nanoseconds()))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ここからは <code>whisper.Open</code> や <code>whisper.CreateWithOptions</code> や <code>Whisper</code> の <code>UpdateMany</code> メソッドを見ていくことになります。
これは
<a href="https://github.com/lomik/go-whisper">lomik/go-whisper: A Go port of Graphite&rsquo;s Whisper timeseries database</a>
と別レポジトリになるのと、記事が長くなってきたので別記事にすることにします。</p>
<p><a href="/blog/2017/04/29/go-whisper-code-reading/">go-whisperをコードリーディングしてみた</a> に続きます。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
