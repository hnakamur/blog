<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>KubernetesのSecrets機能を試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/01/01/tried-kubernetes-secrets/" rel="bookmark"
           title="Permalink to KubernetesのSecrets機能を試してみた">KubernetesのSecrets機能を試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-01-01T16:31:00+09:00">
                Published: 2017-01-01
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/kubernetes.html">kubernetes</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p><a href="http://kubernetes.io/docs/tutorials/stateful-application/run-stateful-application/">Running a Single-Instance Stateful Application - Kubernetes</a> ではMySQLのrootユーザのパスワードを設定のyamlファイルに直接書いていましたが、 安全に管理するためには<a href="http://kubernetes.io/docs/user-guide/secrets/">Secrets - Kubernetes</a> を使うべきとのことなので試してみました。</p>
<h2>パスワードをsecretとして作成</h2>
<p><a href="http://kubernetes.io/docs/user-guide/secrets/">Secrets - Kubernetes</a> ではユーザ名とパスワードを作っていますが、ここではrootユーザのパスワードだけにしてみました。</p>
<p>以下のような内容でmysql-secrets.ymlというファイルを作成します。</p>
<div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Secret</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">secret</span>
<span class="n">type</span><span class="o">:</span> <span class="n">Opaque</span>
<span class="n">data</span><span class="o">:</span>
  <span class="n">rootPassword</span><span class="o">:</span> <span class="n">MWYyZDFlMmU2N2Rm</span>
</pre></div>


<p>data.rootPasswordの値は指定したいパスワードをbase64エンコードした値を書いています。</p>
<div class="highlight"><pre><span></span>$ <span class="nb">echo</span> -n <span class="s2">&quot;1f2d1e2e67df&quot;</span> <span class="p">|</span> base64
MWYyZDFlMmU2N2Rm
</pre></div>


<p>以下のコマンドでsecretを作成します。</p>
<div class="highlight"><pre><span></span>$ k create -f mysql-secrets.yml
secret <span class="s2">&quot;mysql-secret&quot;</span> created
</pre></div>


<h2>作成したsecretを確認</h2>
<div class="highlight"><pre><span></span>$ kubectl get secrets mysql-secret -o yaml
apiVersion: v1
data:
  rootPassword: MWYyZDFlMmU2N2Rm
kind: Secret
metadata:
  creationTimestamp: <span class="m">2017</span>-01-01T07:56:48Z
  name: mysql-secret
  namespace: default
  resourceVersion: <span class="s2">&quot;70478&quot;</span>
  selfLink: /api/v1/namespaces/default/secrets/mysql-secret
  uid: d8fe8b5f-cff7-11e6-8be9-aece81f30d69
type: Opaque
</pre></div>


<h2>secretをPodから利用する</h2>
<p><a href="/blog/2017/01/01/tried-mysql-and-nfs-on-kubernetes/">Kuberntesでデータ領域をNFSマウントしてMySQLを動かしてみた · hnakamur's blog at github</a>のmysql-deploy.ymlを以下のように変更しました。</p>
<div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">strategy</span><span class="o">:</span>
    <span class="n">type</span><span class="o">:</span> <span class="n">Recreate</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">mysql</span>
        <span class="n">ver</span><span class="o">:</span> <span class="s2">&quot;5.6&quot;</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">mysql</span><span class="o">:</span><span class="mf">5.6</span>
        <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span>
        <span class="n">env</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">MYSQL_ROOT_PASSWORD</span>
          <span class="n">valueFrom</span><span class="o">:</span>
            <span class="n">secretKeyRef</span><span class="o">:</span>
              <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">secret</span>
              <span class="n">key</span><span class="o">:</span> <span class="n">rootPassword</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">3306</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span>
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">persistent</span><span class="o">-</span><span class="n">storage</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/var/lib/</span><span class="n">mysql</span>
      <span class="n">volumes</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">persistent</span><span class="o">-</span><span class="n">storage</span>
          <span class="n">persistentVolumeClaim</span><span class="o">:</span>
            <span class="n">claimName</span><span class="o">:</span> <span class="n">mysql</span><span class="o">-</span><span class="n">pvc</span>
</pre></div>


<p>serviceとdeployを一旦削除し、mac上のデータディレクトリも一旦消してから、イカのコマンドで作り直しました。</p>
<div class="highlight"><pre><span></span>$ kubectl create -f mysql-deploy.yml
deployment <span class="s2">&quot;mysql&quot;</span> created
$ kubectl create -f mysql-svc.yml
service <span class="s2">&quot;mysql&quot;</span> created
</pre></div>


<h2>作成したPodの詳細情報を確認</h2>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">kubectl</span> <span class="n">describe</span> <span class="n">po</span> <span class="o">-</span><span class="n">l</span> <span class="n">app</span><span class="o">=</span><span class="n">mysql</span>
<span class="n">Name</span><span class="p">:</span>           <span class="n">mysql</span><span class="o">-</span><span class="mi">1289358488</span><span class="o">-</span><span class="mi">80</span><span class="n">g5n</span>
<span class="n">Namespace</span><span class="p">:</span>      <span class="k">default</span>
<span class="n">Node</span><span class="p">:</span>           <span class="n">minikube</span><span class="o">/</span><span class="mf">192.168</span><span class="p">.</span><span class="mf">99.100</span>
<span class="n">Start</span> <span class="n">Time</span><span class="p">:</span>     <span class="n">Sun</span><span class="p">,</span> <span class="mi">01</span> <span class="n">Jan</span> <span class="mi">2017</span> <span class="mi">17</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">51</span> <span class="o">+</span><span class="mi">0900</span>
<span class="n">Labels</span><span class="p">:</span>         <span class="n">app</span><span class="o">=</span><span class="n">mysql</span>
                <span class="n">pod</span><span class="o">-</span><span class="n">template</span><span class="o">-</span><span class="n">hash</span><span class="o">=</span><span class="mi">1289358488</span>
                <span class="n">ver</span><span class="o">=</span><span class="mf">5.6</span>
<span class="n">Status</span><span class="p">:</span>         <span class="n">Running</span>
<span class="n">IP</span><span class="p">:</span>             <span class="mf">172.17</span><span class="p">.</span><span class="mf">0.5</span>
<span class="n">Controllers</span><span class="p">:</span>    <span class="n">ReplicaSet</span><span class="o">/</span><span class="n">mysql</span><span class="o">-</span><span class="mi">1289358488</span>
<span class="n">Containers</span><span class="p">:</span>
  <span class="n">mysql</span><span class="p">:</span>
    <span class="n">Container</span> <span class="n">ID</span><span class="p">:</span>       <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="mi">928</span><span class="n">c7f98bdc8241830ec564d3fb31656647bc2c1e020b257bb1364de1d4e9435</span>
    <span class="n">Image</span><span class="p">:</span>              <span class="n">mysql</span><span class="p">:</span><span class="mf">5.6</span>
    <span class="n">Image</span> <span class="n">ID</span><span class="p">:</span>           <span class="n">docker</span><span class="p">:</span><span class="o">//</span><span class="n">sha256</span><span class="p">:</span><span class="n">e1406e1f7c42c7e664e138c2cedfcd4c09eef6d4859df1f93fd54d87ed3ba1a1</span>
    <span class="n">Port</span><span class="p">:</span>               <span class="mi">3306</span><span class="o">/</span><span class="n">TCP</span>
    <span class="n">State</span><span class="p">:</span>              <span class="n">Running</span>
      <span class="n">Started</span><span class="p">:</span>          <span class="n">Sun</span><span class="p">,</span> <span class="mi">01</span> <span class="n">Jan</span> <span class="mi">2017</span> <span class="mi">17</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">52</span> <span class="o">+</span><span class="mi">0900</span>
    <span class="n">Ready</span><span class="p">:</span>              <span class="k">True</span>
    <span class="n">Restart</span> <span class="n">Count</span><span class="p">:</span>      <span class="mi">0</span>
    <span class="n">Volume</span> <span class="n">Mounts</span><span class="p">:</span>
      <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="k">lib</span><span class="o">/</span><span class="n">mysql</span> <span class="n">from</span> <span class="n">mysql</span><span class="o">-</span><span class="n">persistent</span><span class="o">-</span><span class="n">storage</span> <span class="p">(</span><span class="n">rw</span><span class="p">)</span>
      <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">secrets</span><span class="o">/</span><span class="n">kubernetes</span><span class="p">.</span><span class="n">io</span><span class="o">/</span><span class="n">serviceaccount</span> <span class="n">from</span> <span class="k">default</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">qqsb7</span> <span class="p">(</span><span class="n">ro</span><span class="p">)</span>
    <span class="n">Environment</span> <span class="n">Variables</span><span class="p">:</span>
      <span class="n">MYSQL_ROOT_PASSWORD</span><span class="p">:</span>      <span class="o">&lt;</span><span class="k">set</span> <span class="k">to</span> <span class="n">the</span> <span class="n">key</span> <span class="c">&#39;rootPassword&#39; in secret &#39;mysql-secret&#39;&gt;</span>
<span class="n">Conditions</span><span class="p">:</span>
  <span class="n">Type</span>          <span class="n">Status</span>
  <span class="n">Initialized</span>   <span class="k">True</span>
  <span class="n">Ready</span>         <span class="k">True</span>
  <span class="n">PodScheduled</span>  <span class="k">True</span>
<span class="n">Volumes</span><span class="p">:</span>
  <span class="n">mysql</span><span class="o">-</span><span class="n">persistent</span><span class="o">-</span><span class="n">storage</span><span class="p">:</span>
    <span class="n">Type</span><span class="p">:</span>       <span class="n">PersistentVolumeClaim</span> <span class="p">(</span><span class="n">a</span> <span class="n">reference</span> <span class="k">to</span> <span class="n">a</span> <span class="n">PersistentVolumeClaim</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">same</span> <span class="n">namespace</span><span class="p">)</span>
    <span class="n">ClaimName</span><span class="p">:</span>  <span class="n">mysql</span><span class="o">-</span><span class="n">pvc</span>
    <span class="k">ReadOnly</span><span class="p">:</span>   <span class="k">false</span>
  <span class="k">default</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">qqsb7</span><span class="p">:</span>
    <span class="n">Type</span><span class="p">:</span>       <span class="n">Secret</span> <span class="p">(</span><span class="n">a</span> <span class="n">volume</span> <span class="n">populated</span> <span class="n">by</span> <span class="n">a</span> <span class="n">Secret</span><span class="p">)</span>
    <span class="n">SecretName</span><span class="p">:</span> <span class="k">default</span><span class="o">-</span><span class="n">token</span><span class="o">-</span><span class="n">qqsb7</span>
<span class="n">QoS</span> <span class="n">Class</span><span class="p">:</span>      <span class="n">BestEffort</span>
<span class="n">Tolerations</span><span class="p">:</span>    <span class="o">&lt;</span><span class="n">none</span><span class="o">&gt;</span>
<span class="n">Events</span><span class="p">:</span>
  <span class="n">FirstSeen</span>     <span class="n">LastSeen</span>        <span class="n">Count</span>   <span class="n">From</span>                    <span class="n">SubObjectPath</span>           <span class="n">Type</span>            <span class="n">Reason</span>          <span class="n">Message</span>
  <span class="o">---------</span>     <span class="o">--------</span>        <span class="o">-----</span>   <span class="o">----</span>                    <span class="o">-------------</span>           <span class="o">--------</span>        <span class="o">------</span>          <span class="o">-------</span>
  <span class="mi">1</span><span class="n">m</span>            <span class="mi">1</span><span class="n">m</span>              <span class="mi">1</span>       <span class="p">{</span><span class="k">default</span><span class="o">-</span><span class="n">scheduler</span> <span class="p">}</span>                            <span class="n">Normal</span>          <span class="n">Scheduled</span>       <span class="n">Successfully</span> <span class="ow">as</span>
<span class="n">signed</span> <span class="n">mysql</span><span class="o">-</span><span class="mi">1289358488</span><span class="o">-</span><span class="mi">80</span><span class="n">g5n</span> <span class="k">to</span> <span class="n">minikube</span>
  <span class="mi">1</span><span class="n">m</span>            <span class="mi">1</span><span class="n">m</span>              <span class="mi">1</span>       <span class="p">{</span><span class="n">kubelet</span> <span class="n">minikube</span><span class="p">}</span>      <span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">{</span><span class="n">mysql</span><span class="p">}</span>  <span class="n">Normal</span>          <span class="n">Pulled</span>          <span class="n">Container</span> <span class="n">image</span>
 <span class="s">&quot;mysql:5.6&quot;</span> <span class="n">already</span> <span class="n">present</span> <span class="k">on</span> <span class="n">machine</span>
  <span class="mi">1</span><span class="n">m</span>            <span class="mi">1</span><span class="n">m</span>              <span class="mi">1</span>       <span class="p">{</span><span class="n">kubelet</span> <span class="n">minikube</span><span class="p">}</span>      <span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">{</span><span class="n">mysql</span><span class="p">}</span>  <span class="n">Normal</span>          <span class="n">Created</span>         <span class="n">Created</span> <span class="n">contain</span>
<span class="n">er</span> <span class="k">with</span> <span class="n">docker</span> <span class="n">id</span> <span class="mi">928</span><span class="n">c7f98bdc8</span><span class="err">;</span> <span class="n">Security</span><span class="p">:</span><span class="o">[</span><span class="n">seccomp</span><span class="o">=</span><span class="n">unconfined</span><span class="o">]</span>
  <span class="mi">1</span><span class="n">m</span>            <span class="mi">1</span><span class="n">m</span>              <span class="mi">1</span>       <span class="p">{</span><span class="n">kubelet</span> <span class="n">minikube</span><span class="p">}</span>      <span class="n">spec</span><span class="p">.</span><span class="n">containers</span><span class="p">{</span><span class="n">mysql</span><span class="p">}</span>  <span class="n">Normal</span>          <span class="n">Started</span>         <span class="n">Started</span> <span class="n">contain</span>
<span class="n">er</span> <span class="k">with</span> <span class="n">docker</span> <span class="n">id</span> <span class="mi">928</span><span class="n">c7f98bdc8</span>
</pre></div>


<p>MYSQL_ROOT_PASSWORDの説明が <code>&lt;set to the key 'rootPassword' in secret 'mysql-secret'&gt;</code> となっていて問題なく使えているようです。</p>
<h3>mysqlクライアントで接続</h3>
<p>mysqlのクライアントで指定したパスワードで接続できることが確認できました。</p>
<div class="highlight"><pre><span></span>$ <span class="nv">kubectl</span> <span class="nv">run</span> <span class="o">-</span><span class="nv">it</span> <span class="o">--</span><span class="nv">rm</span> <span class="o">--</span><span class="nv">image</span><span class="o">=</span><span class="nv">mysql</span>:<span class="mi">5</span>.<span class="mi">6</span> <span class="nv">mysql</span><span class="o">-</span><span class="nv">client</span> <span class="o">--</span> <span class="nv">mysql</span> <span class="o">-</span><span class="nv">h</span> <span class="mi">172</span>.<span class="mi">17</span>.<span class="mi">0</span>.<span class="mi">5</span> <span class="o">-</span><span class="nv">p1f2d1e2e67df</span>
<span class="nv">Waiting</span> <span class="k">for</span> <span class="nv">pod</span> <span class="nv">default</span><span class="o">/</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">client</span><span class="o">-</span><span class="mi">992258208</span><span class="o">-</span><span class="nv">c9wm3</span> <span class="nv">to</span> <span class="nv">be</span> <span class="nv">running</span>, <span class="nv">status</span> <span class="nv">is</span> <span class="nv">Pending</span>, <span class="nv">pod</span> <span class="nv">ready</span>: <span class="nv">false</span>
<span class="k">If</span> <span class="nv">you</span> <span class="nv">don</span><span class="s1">&#39;</span><span class="s">t see a command prompt, try pressing enter.</span>

<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">create</span> <span class="nv">database</span> <span class="nv">db1</span><span class="c1">;</span>
<span class="nv">Query</span> <span class="nv">OK</span>, <span class="mi">1</span> <span class="nv">row</span> <span class="nv">affected</span> <span class="ss">(</span><span class="mi">0</span>.<span class="mi">01</span> <span class="nv">sec</span><span class="ss">)</span>

<span class="nv">mysql</span><span class="o">&gt;</span> <span class="k">exit</span>
<span class="nv">Bye</span>
<span class="nv">Session</span> <span class="nv">ended</span>, <span class="nv">resume</span> <span class="nv">using</span> <span class="s1">&#39;</span><span class="s">kubectl attach mysql-client-992258208-c9wm3 -c mysql-client -i -t</span><span class="s1">&#39;</span> <span class="nv">command</span> <span class="nv">when</span> <span class="nv">the</span> <span class="nv">pod</span> <span class="nv">is</span> <span class="nv">running</span>
<span class="nv">deployment</span> <span class="s2">&quot;</span><span class="s">mysql-client</span><span class="s2">&quot;</span> <span class="nv">deleted</span>
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>