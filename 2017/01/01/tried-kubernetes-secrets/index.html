<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.108.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>KubernetesのSecrets機能を試してみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2022. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>KubernetesのSecrets機能を試してみた</h1>
  <time datetime=2017-01-01T16:31:08&#43;0900 class="post-date">2017-01-01</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#パスワードをsecretとして作成">パスワードをsecretとして作成</a></li>
    <li><a href="#作成したsecretを確認">作成したsecretを確認</a></li>
    <li><a href="#secretをpodから利用する">secretをPodから利用する</a></li>
    <li><a href="#作成したpodの詳細情報を確認">作成したPodの詳細情報を確認</a>
      <ul>
        <li><a href="#mysqlクライアントで接続">mysqlクライアントで接続</a></li>
      </ul>
    </li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="http://kubernetes.io/docs/tutorials/stateful-application/run-stateful-application/">Running a Single-Instance Stateful Application - Kubernetes</a> ではMySQLのrootユーザのパスワードを設定のyamlファイルに直接書いていましたが、 安全に管理するためには<a href="http://kubernetes.io/docs/user-guide/secrets/">Secrets - Kubernetes</a> を使うべきとのことなので試してみました。</p>
<h2 id="パスワードをsecretとして作成">パスワードをsecretとして作成</h2>
<p><a href="http://kubernetes.io/docs/user-guide/secrets/">Secrets - Kubernetes</a> ではユーザ名とパスワードを作っていますが、ここではrootユーザのパスワードだけにしてみました。</p>
<p>以下のような内容でmysql-secrets.ymlというファイルを作成します。</p>
<pre tabindex="0"><code>apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
type: Opaque
data:
  rootPassword: MWYyZDFlMmU2N2Rm
</code></pre><p>data.rootPasswordの値は指定したいパスワードをbase64エンコードした値を書いています。</p>
<pre tabindex="0"><code>$ echo -n &#34;1f2d1e2e67df&#34; | base64
MWYyZDFlMmU2N2Rm
</code></pre><p>以下のコマンドでsecretを作成します。</p>
<pre tabindex="0"><code>$ k create -f mysql-secrets.yml
secret &#34;mysql-secret&#34; created
</code></pre><h2 id="作成したsecretを確認">作成したsecretを確認</h2>
<pre tabindex="0"><code>$ kubectl get secrets mysql-secret -o yaml
apiVersion: v1
data:
  rootPassword: MWYyZDFlMmU2N2Rm
kind: Secret
metadata:
  creationTimestamp: 2017-01-01T07:56:48Z
  name: mysql-secret
  namespace: default
  resourceVersion: &#34;70478&#34;
  selfLink: /api/v1/namespaces/default/secrets/mysql-secret
  uid: d8fe8b5f-cff7-11e6-8be9-aece81f30d69
type: Opaque
</code></pre><h2 id="secretをpodから利用する">secretをPodから利用する</h2>
<p><a href="/blog/2017/01/01/tried-mysql-and-nfs-on-kubernetes/">Kuberntesでデータ領域をNFSマウントしてMySQLを動かしてみた · hnakamur&rsquo;s blog at github</a>のmysql-deploy.ymlを以下のように変更しました。</p>
<pre tabindex="0"><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: mysql
spec:
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
        ver: &#34;5.6&#34;
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret
              key: rootPassword
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
        - name: mysql-persistent-storage
          persistentVolumeClaim:
            claimName: mysql-pvc
</code></pre><p>serviceとdeployを一旦削除し、mac上のデータディレクトリも一旦消してから、イカのコマンドで作り直しました。</p>
<pre tabindex="0"><code>$ kubectl create -f mysql-deploy.yml
deployment &#34;mysql&#34; created
$ kubectl create -f mysql-svc.yml
service &#34;mysql&#34; created
</code></pre><h2 id="作成したpodの詳細情報を確認">作成したPodの詳細情報を確認</h2>
<pre tabindex="0"><code>$ kubectl describe po -l app=mysql
Name:           mysql-1289358488-80g5n
Namespace:      default
Node:           minikube/192.168.99.100
Start Time:     Sun, 01 Jan 2017 17:07:51 +0900
Labels:         app=mysql
                pod-template-hash=1289358488
                ver=5.6
Status:         Running
IP:             172.17.0.5
Controllers:    ReplicaSet/mysql-1289358488
Containers:
  mysql:
    Container ID:       docker://928c7f98bdc8241830ec564d3fb31656647bc2c1e020b257bb1364de1d4e9435
    Image:              mysql:5.6
    Image ID:           docker://sha256:e1406e1f7c42c7e664e138c2cedfcd4c09eef6d4859df1f93fd54d87ed3ba1a1
    Port:               3306/TCP
    State:              Running
      Started:          Sun, 01 Jan 2017 17:07:52 +0900
    Ready:              True
    Restart Count:      0
    Volume Mounts:
      /var/lib/mysql from mysql-persistent-storage (rw)
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-qqsb7 (ro)
    Environment Variables:
      MYSQL_ROOT_PASSWORD:      &lt;set to the key &#39;rootPassword&#39; in secret &#39;mysql-secret&#39;&gt;
Conditions:
  Type          Status
  Initialized   True
  Ready         True
  PodScheduled  True
Volumes:
  mysql-persistent-storage:
    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
    ClaimName:  mysql-pvc
    ReadOnly:   false
  default-token-qqsb7:
    Type:       Secret (a volume populated by a Secret)
    SecretName: default-token-qqsb7
QoS Class:      BestEffort
Tolerations:    &lt;none&gt;
Events:
  FirstSeen     LastSeen        Count   From                    SubObjectPath           Type            Reason          Message
  ---------     --------        -----   ----                    -------------           --------        ------          -------
  1m            1m              1       {default-scheduler }                            Normal          Scheduled       Successfully as
signed mysql-1289358488-80g5n to minikube
  1m            1m              1       {kubelet minikube}      spec.containers{mysql}  Normal          Pulled          Container image
 &#34;mysql:5.6&#34; already present on machine
  1m            1m              1       {kubelet minikube}      spec.containers{mysql}  Normal          Created         Created contain
er with docker id 928c7f98bdc8; Security:[seccomp=unconfined]
  1m            1m              1       {kubelet minikube}      spec.containers{mysql}  Normal          Started         Started contain
er with docker id 928c7f98bdc8
</code></pre><p>MYSQL_ROOT_PASSWORDの説明が <code>&lt;set to the key 'rootPassword' in secret 'mysql-secret'&gt;</code> となっていて問題なく使えているようです。</p>
<h3 id="mysqlクライアントで接続">mysqlクライアントで接続</h3>
<p>mysqlのクライアントで指定したパスワードで接続できることが確認できました。</p>
<pre tabindex="0"><code>$ kubectl run -it --rm --image=mysql:5.6 mysql-client -- mysql -h 172.17.0.5 -p1f2d1e2e67df
Waiting for pod default/mysql-client-992258208-c9wm3 to be running, status is Pending, pod ready: false
If you don&#39;t see a command prompt, try pressing enter.

mysql&gt; create database db1;
Query OK, 1 row affected (0.01 sec)

mysql&gt; exit
Bye
Session ended, resume using &#39;kubectl attach mysql-client-992258208-c9wm3 -c mysql-client -i -t&#39; command when the pod is running
deployment &#34;mysql-client&#34; deleted
</code></pre>
</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
