<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Kuberntesでデータ領域をNFSマウントしてMySQLを動かしてみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/01/01/tried-mysql-and-nfs-on-kubernetes/" rel="bookmark"
           title="Permalink to Kuberntesでデータ領域をNFSマウントしてMySQLを動かしてみた">Kuberntesでデータ領域をNFSマウントしてMySQLを動かしてみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-01-01T12:38:00+09:00">
                Published: 2017-01-01
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/kubernetes.html">kubernetes</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p><a href="/blog/2017/01/01/use-nfs-persistent-volume-on-minikube-virtualbox/">minikubeとVirtualBoxでNFSのpersistent volumeを試してみた · hnakamur's blog at github</a>の結果を踏まえて、 <a href="http://kubernetes.io/docs/tutorials/stateful-application/run-stateful-application/">Running a Single-Instance Stateful Application - Kubernetes</a> のチュートリアルを試してみたのでメモです。</p>
<h2>設定ファイル</h2>
<div class="highlight"><pre><span></span>$ cat persistent-volume-nfs.yml
kind: PersistentVolume
apiVersion: v1
metadata:
  name: pv-nfs
  labels:
    type: nfs
spec:
  capacity:
    storage: 30Gi
  accessModes:
    - ReadWriteMany
  persistentVolumeReclaimPolicy: Retain
  nfs:
    <span class="c1"># TODO: modify path and server appropriately</span>
    path: /Users/hnakamur/kube-data/mysql
    server: <span class="m">192</span>.168.99.1
</pre></div>


<div class="highlight"><pre><span></span>$ cat mysql-pvc.yml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: mysql-pvc
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 15Gi
</pre></div>


<div class="highlight"><pre><span></span>$ cat mysql-deploy.yml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: mysql
spec:
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        env:
          <span class="c1"># Use secret in real usage</span>
        - name: MYSQL_ROOT_PASSWORD
          value: password
        ports:
        - containerPort: <span class="m">3306</span>
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
</pre></div>


<div class="highlight"><pre><span></span>$ cat mysql-svc.yml
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  ports:
    - port: <span class="m">3306</span>
  selector:
    app: mysql
  clusterIP: None
</pre></div>


<p>ハマった点としては、persistent volumeとpersistent volume claimのaccessModesは合わせないとうまく行きませんでした。具体的には <code>kubectl describe pvc mysql-pvc</code> で確認したときにStatusがPendingになっていました。</p>
<p><a href="http://kubernetes.io/docs/user-guide/persistent-volumes/#access-modes">Access Modes</a>にアクセスモードについての説明があります。</p>
<h2>サービスの作成と公開</h2>
<div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="k">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">persistent</span><span class="o">-</span><span class="n">volume</span><span class="o">-</span><span class="n">nfs</span><span class="p">.</span><span class="n">yml</span>
<span class="n">kubectl</span> <span class="k">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">mysql</span><span class="o">-</span><span class="n">pvc</span><span class="p">.</span><span class="n">yml</span>
<span class="n">kubectl</span> <span class="k">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">mysql</span><span class="o">-</span><span class="n">deploy</span><span class="p">.</span><span class="n">yml</span>
<span class="n">kubectl</span> <span class="k">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">mysql</span><span class="o">-</span><span class="n">svc</span><span class="p">.</span><span class="n">yml</span>
</pre></div>


<h2>MySQLに接続してみる</h2>
<p>まずMySQLコンテナのIPアドレスを調べます。</p>
<div class="highlight"><pre><span></span>$ kubectl get pods -o wide -l <span class="nv">app</span><span class="o">=</span>mysql
NAME                     READY     STATUS    RESTARTS   AGE       IP           NODE
mysql-4160924354-c5x2l   <span class="m">1</span>/1       Running   <span class="m">0</span>          3m        <span class="m">172</span>.17.0.5   minikube
</pre></div>


<p>mysqlクライアントのイメージを使ってmysqlに接続します。
<code>If you don't see a command prompt, try pressing enter.</code> とある通り、そのままではプロンプトが表示されなかったのでエンターキーを押すと表示されました。</p>
<p>試しにデータベースをテーブルを作成してみます。その後 Control-D を押してmysqlクライアントを抜けます。</p>
<div class="highlight"><pre><span></span>$ <span class="nv">kubectl</span> <span class="nv">run</span> <span class="o">-</span><span class="nv">it</span> <span class="o">--</span><span class="nv">rm</span> <span class="o">--</span><span class="nv">image</span><span class="o">=</span><span class="nv">mysql</span>:<span class="mi">5</span>.<span class="mi">6</span> <span class="nv">mysql</span><span class="o">-</span><span class="nv">client</span> <span class="o">--</span> <span class="nv">mysql</span> <span class="o">-</span><span class="nv">h</span> <span class="mi">172</span>.<span class="mi">17</span>.<span class="mi">0</span>.<span class="mi">5</span> <span class="o">-</span><span class="nv">ppassword</span>
<span class="nv">Waiting</span> <span class="k">for</span> <span class="nv">pod</span> <span class="nv">default</span><span class="o">/</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">client</span><span class="o">-</span><span class="mi">1703061864</span><span class="o">-</span><span class="nv">g1p4s</span> <span class="nv">to</span> <span class="nv">be</span> <span class="nv">running</span>, <span class="nv">status</span> <span class="nv">is</span> <span class="nv">Pending</span>, <span class="nv">pod</span> <span class="nv">ready</span>: <span class="nv">false</span>
<span class="k">If</span> <span class="nv">you</span> <span class="nv">don</span><span class="s1">&#39;</span><span class="s">t see a command prompt, try pressing enter.</span>

<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">create</span> <span class="nv">database</span> <span class="nv">test1</span><span class="c1">;</span>
<span class="nv">Query</span> <span class="nv">OK</span>, <span class="mi">1</span> <span class="nv">row</span> <span class="nv">affected</span> <span class="ss">(</span><span class="mi">0</span>.<span class="mi">00</span> <span class="nv">sec</span><span class="ss">)</span>

<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">use</span> <span class="nv">test1</span><span class="c1">;</span>
<span class="nv">Database</span> <span class="nv">changed</span>
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">create</span> <span class="nv">table</span> <span class="nv">table1</span> <span class="ss">(</span><span class="nv">id</span> <span class="nv">integer</span><span class="ss">)</span><span class="c1">;</span>
<span class="nv">Query</span> <span class="nv">OK</span>, <span class="mi">0</span> <span class="nv">rows</span> <span class="nv">affected</span> <span class="ss">(</span><span class="mi">0</span>.<span class="mi">02</span> <span class="nv">sec</span><span class="ss">)</span>

<span class="nv">mysql</span><span class="o">&gt;</span> <span class="o">^</span><span class="nv">DBye</span>
<span class="nv">Session</span> <span class="nv">ended</span>, <span class="nv">resume</span> <span class="nv">using</span> <span class="s1">&#39;</span><span class="s">kubectl attach mysql-client-1703061864-g1p4s -c mysql-client -i -t</span><span class="s1">&#39;</span> <span class="nv">command</span> <span class="nv">when</span> <span class="nv">the</span> <span class="nv">pod</span> <span class="nv">is</span> <span class="nv">running</span>
<span class="nv">deployment</span> <span class="s2">&quot;</span><span class="s">mysql-client</span><span class="s2">&quot;</span> <span class="nv">deleted</span>
</pre></div>


<h2>MySQLサーバのPodを更新してみる</h2>
<p>mysql-deploy.yml を書き変えて <code>kubectl apply</code> で更新してみます。</p>
<p>最初MYSQL_ROOT_PASSWORDの値を変えてみようかと思って試したのですが、よく考えるとこれはデータベース作成時に設定されてNFSでマウントしたデータ領域はそのまま残るので、この値を変えても更新できませんでした。</p>
<p>そこで、ラベルに <code>ver=5.6</code> というのを追加してみました。
最初5.6はダブルクォートで囲まずにyamlファイルに書いてみたのですが、エラーになったのでダブルクォートで囲んでいます。</p>
<div class="highlight"><pre><span></span>$ cat mysql-deploy.yml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: mysql
spec:
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
        ver: <span class="s2">&quot;5.6&quot;</span>
    spec:
      containers:
      - image: mysql:5.6
        name: mysql
        env:
          <span class="c1"># Use secret in real usage</span>
        - name: MYSQL_ROOT_PASSWORD
          value: password
        ports:
        - containerPort: <span class="m">3306</span>
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
</pre></div>


<p>以下のコマンドで反映しました。</p>
<div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">mysql</span><span class="o">-</span><span class="n">deploy</span><span class="p">.</span><span class="n">yml</span>
</pre></div>


<p>再度mysqlに接続して、先ほど作成したデータベースとテーブルがあるかを確認します。</p>
<p>まずMySQLコンテナのIPアドレスを調べます。
spec.strategyがRecreateなので、コンテナが作り直されてIPアドレスも先程とは変わっています。</p>
<div class="highlight"><pre><span></span>$ kubectl get pods -o wide -l <span class="nv">app</span><span class="o">=</span>mysql
NAME                     READY     STATUS    RESTARTS   AGE       IP           NODE
mysql-1726459224-c5gps   <span class="m">1</span>/1       Running   <span class="m">0</span>          10s       <span class="m">172</span>.17.0.6   minikube
</pre></div>


<p><code>kubectl describe po -l app=mysql</code> を実行してStateのStartedやEventsの時刻を見るとコンテナが作り直されたことがわかります。</p>
<p>mysqlに接続して、データベースとテーブルを確認します。</p>
<div class="highlight"><pre><span></span>$ <span class="nv">kubectl</span> <span class="nv">run</span> <span class="o">-</span><span class="nv">it</span> <span class="o">--</span><span class="nv">rm</span> <span class="o">--</span><span class="nv">image</span><span class="o">=</span><span class="nv">mysql</span>:<span class="mi">5</span>.<span class="mi">6</span> <span class="nv">mysql</span><span class="o">-</span><span class="nv">client</span> <span class="o">--</span> <span class="nv">mysql</span> <span class="o">-</span><span class="nv">h</span> <span class="mi">172</span>.<span class="mi">17</span>.<span class="mi">0</span>.<span class="mi">6</span> <span class="o">-</span><span class="nv">pmypassword</span>
<span class="nv">Waiting</span> <span class="k">for</span> <span class="nv">pod</span> <span class="nv">default</span><span class="o">/</span><span class="nv">mysql</span><span class="o">-</span><span class="nv">client</span><span class="o">-</span><span class="mi">1775806825</span><span class="o">-</span><span class="nv">vxjgf</span> <span class="nv">to</span> <span class="nv">be</span> <span class="nv">running</span>, <span class="nv">status</span> <span class="nv">is</span> <span class="nv">Pending</span>, <span class="nv">pod</span> <span class="nv">ready</span>: <span class="nv">false</span>
<span class="k">If</span> <span class="nv">you</span> <span class="nv">don</span><span class="s1">&#39;</span><span class="s">t see a command prompt, try pressing enter.</span>

<span class="nv">mysql</span><span class="o">&gt;</span> <span class="k">show</span> <span class="nv">databases</span><span class="c1">;</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="nv">Database</span>           <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="o">|</span> <span class="nv">information_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="nv">mysql</span>              <span class="o">|</span>
<span class="o">|</span> <span class="nv">performance_schema</span> <span class="o">|</span>
<span class="o">|</span> <span class="nv">test1</span>              <span class="o">|</span>
<span class="o">+--------------------+</span>
<span class="mi">4</span> <span class="nv">rows</span> <span class="nv">in</span> <span class="nv">set</span> <span class="ss">(</span><span class="mi">0</span>.<span class="mi">01</span> <span class="nv">sec</span><span class="ss">)</span>

<span class="nv">mysql</span><span class="o">&gt;</span> <span class="nv">use</span> <span class="nv">test1</span><span class="c1">;</span>
<span class="nv">Reading</span> <span class="nv">table</span> <span class="nv">information</span> <span class="k">for</span> <span class="nv">completion</span> <span class="nv">of</span> <span class="nv">table</span> <span class="nv">and</span> <span class="nv">column</span> <span class="nv">names</span>
<span class="nv">You</span> <span class="nv">can</span> <span class="nv">turn</span> <span class="nv">off</span> <span class="nv">this</span> <span class="nv">feature</span> <span class="nv">to</span> <span class="nv">get</span> <span class="nv">a</span> <span class="nv">quicker</span> <span class="nv">startup</span> <span class="nv">with</span> <span class="o">-</span><span class="nv">A</span>

<span class="nv">Database</span> <span class="nv">changed</span>
<span class="nv">mysql</span><span class="o">&gt;</span> <span class="k">show</span> <span class="nv">tables</span><span class="c1">;</span>
<span class="o">+-----------------+</span>
<span class="o">|</span> <span class="nv">Tables_in_test1</span> <span class="o">|</span>
<span class="o">+-----------------+</span>
<span class="o">|</span> <span class="nv">table1</span>          <span class="o">|</span>
<span class="o">+-----------------+</span>
<span class="mi">1</span> <span class="nv">row</span> <span class="nv">in</span> <span class="nv">set</span> <span class="ss">(</span><span class="mi">0</span>.<span class="mi">00</span> <span class="nv">sec</span><span class="ss">)</span>

<span class="nv">mysql</span><span class="o">&gt;</span> <span class="k">exit</span>
<span class="nv">Bye</span>
<span class="nv">Session</span> <span class="nv">ended</span>, <span class="nv">resume</span> <span class="nv">using</span> <span class="s1">&#39;</span><span class="s">kubectl attach mysql-client-1775806825-vxjgf -c mysql-client -i -t</span><span class="s1">&#39;</span> <span class="nv">command</span> <span class="nv">when</span> <span class="nv">the</span> <span class="nv">pod</span> <span class="nv">is</span> <span class="nv">running</span>
<span class="nv">deployment</span> <span class="s2">&quot;</span><span class="s">mysql-client</span><span class="s2">&quot;</span> <span class="nv">deleted</span>
</pre></div>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>