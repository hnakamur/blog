<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>さくらのクラウドでPackerとTerraformを使ってContainer Linuxの環境構築をしてみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2017/01/02/use-container-linux-on-sakura-cloud-using-packer-and-terraform/" rel="bookmark"
           title="Permalink to さくらのクラウドでPackerとTerraformを使ってContainer Linuxの環境構築をしてみた">さくらのクラウドでPackerとTerraformを使ってContainer Linuxの環境構築をしてみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-01-02T15:34:00+09:00">
                Published: 2017-01-02
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/kubernetes.html">kubernetes</a> <a href="../../../../tag/container-linux.html">container-linux</a> <a href="../../../../tag/sakura-cloud.html">sakura-cloud</a> <a href="../../../../tag/terraform.html">terraform</a> <a href="../../../../tag/packer.html">packer</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p>さくらのクラウドでPackerとTerraformを使って<a href="https://coreos.com/os/docs/latest/">CoreOS Container Linux</a>の環境構築をしてみたのでメモです。</p>
<p><a href="http://cloud-news.sakura.ad.jp/public_archive_iso/">パブリックアーカイブ・ISOイメージ</a>にCoreOSはあるのですが、現状では残念ながらバージョンが 367.1.0 (stable) とかなり古い状態です。</p>
<p>そこで https://stable.release.core-os.net/amd64-usr/ 以下にある安定版公式ISOイメージの現時点の最新版である 1185.5.0 を使ってPackerでさくらのクラウド上にマイアーカイブを作成し、それを元にサーバで使用するディスクとサーバを作成します。</p>
<p>さくらのクラウドには<a href="http://cloud-news.sakura.ad.jp/startup-script/">スタートアップスクリプト</a>という機能がありサーバの起動時に設定を行うことができるのですが、これが使えるのはCentOS、Debian、Ubuntuに限定されるようでCoreOSでは使えませんでした。</p>
<p>これだと構成はほぼ同じで静的IPアドレスだけが異なる複数のサーバを作りたい場合も、サーバ1台毎にPackerでマイアーカイブを作ってそこからサーバを作る必要があり、実用には厳しいなと思って一度は断念していました。</p>
<p>ルータを使わない構成であれば、まずはDHCPで起動してアドレスをもらってからプロビジョニング時に静的IPアドレスに切り替えるという手はあります。ですがルータを使う場合はDHCPサーバがいないのでこの手は使えません。</p>
<p>そんな時、<a href="https://github.com/sacloud/packer-builder-sakuracloud">さくらのクラウド用Packerプラグイン</a>、<a href="https://github.com/yamamoto-febc/terraform-provider-sakuracloud">Terraform for さくらのクラウド</a>、<a href="https://github.com/yamamoto-febc/sacloud-upload-image">Upload ISO image to SAKURA CLOUD</a>などの便利なツールを作ってくださっている山本さんのツイートでContainer Linuxの<a href="https://coreos.com/os/docs/latest/config-drive.html">Customize with Config-Drive</a>という機能を知りました。便利なツールに加えて有用な情報、いつもありがとうございます！</p>
<p>この記事はこの機能と上記の3つのツールを使ってContainer Linuxの環境構築をしてみたメモです。</p>
<h2>参考資料</h2>
<h3>Packer for さくらのクラウド</h3>
<p><a href="https://github.com/sacloud/packer-builder-sakuracloud">さくらのクラウド用Packerプラグイン</a>の作者の山本さんによる詳しくてわかりやすい記事が
<a href="http://knowledge.sakura.ad.jp/knowledge/6790/">さくらのクラウド上でマシンイメージを自動構築 〜「Packer for さくらのクラウド」 - さくらのナレッジ</a> にありますので、ぜひご参照ください。</p>
<h3>Terraform for さくらのクラウド</h3>
<p><a href="https://github.com/yamamoto-febc/terraform-provider-sakuracloud">Terraform for さくらのクラウド</a>については作者の山本さんによる詳しくてわかりやすい連載記事がありますので、是非そちらをご参照ください。</p>
<ul>
<li><a href="http://qiita.com/yamamoto-febc/items/ae92cd258cf040957487">Terraform for さくらのクラウド スタートガイド(第1回) - Qiita</a></li>
<li><a href="http://qiita.com/yamamoto-febc/items/2480b11c9e6a8b64f78d">Terraform for さくらのクラウド スタートガイド(第2回) - Qiita</a></li>
<li><a href="http://qiita.com/yamamoto-febc/items/fe954e2d4a92b864cfef">Terraform for さくらのクラウド スタートガイド(第3回) - Qiita</a></li>
<li><a href="http://qiita.com/yamamoto-febc/items/a9795cb909bd9b69f729">Terraform for さくらのクラウド スタートガイド(第4回) - Qiita</a></li>
<li><a href="http://qiita.com/yamamoto-febc/items/4b774404e041fa05688a">Terraform for さくらのクラウド スタートガイド(第5回) - Qiita</a></li>
</ul>
<h2>Container LinuxのISOイメージ作成</h2>
<h3>Packerとさくらのクラウド用Packerプラグインの事前準備</h3>
<p><a href="https://www.packer.io/">Packer by HashiCorp</a>と<a href="https://github.com/sacloud/packer-builder-sakuracloud">さくらのクラウド用Packerプラグイン</a>をインストールしていない場合はそれぞれのドキュメントに従ってインストールしてください。</p>
<p>また<a href="https://github.com/yamamoto-febc/terraform-provider-sakuracloud/blob/master/docs/installation.md#%E3%81%95%E3%81%8F%E3%82%89%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%A6%E3%83%89api%E3%82%AD%E3%83%BC%E3%81%AE%E5%8F%96%E5%BE%97">APIキーの取得</a>と<a href="https://github.com/sacloud/packer-builder-sakuracloud#apiキーの設定">APIキーの設定</a>も行っておいてください。</p>
<h3>PackerでさくらのクラウドにContainer Linuxのマイアーカイブを作成</h3>
<p>以下の内容を <code>containerlinux.json</code> というファイルに保存します。
「ここにパスワードを設定」にはContainer Linuxで予め用意されている <code>core</code> ユーザに設定するパスワードを設定します。
「ここにパスワードのハッシュを設定」には <a href="https://github.com/coreos/coreos-cloudinit/blob/master/Documentation/cloud-config.md#generating-a-password-hash">Generating a password hash</a> の手順で生成したパスワードのハッシュを設定します。</p>
<p><code>sakuracloud_zone</code> は<a href="http://developer.sakura.ad.jp/cloud/api/1.1/">さくらのクラウド API v1.1 ドキュメント</a>の一般注記事項のAPI URLに書いてあるゾーンのうち、自分が利用したいゾーンを指定します。以下の例では <code>is1b</code> (石狩第2ゾーン)としています。</p>
<div class="highlight"><pre><span></span>{
  <span class="s2">&quot;</span><span class="s">variables</span><span class="s2">&quot;</span>: {
    <span class="s2">&quot;</span><span class="s">sakuracloud_zone</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">is1b</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">archive_name</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">CoreOS 1185.5.0</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">iso_url</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">https://stable.release.core-os.net/amd64-usr/1185.5.0/coreos_production_iso_image.iso</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">iso_checksum</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">1c8e7948bdc54980df87a9a2b08fa744104f977950002f1605b60bf44d2021b9</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">iso_checksum_type</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">sha256</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">install_disk_device</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">/dev/vda</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">tmp_password</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">ここにパスワードを設定</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">tmp_password_hash</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">ここにパスワードのハッシュを設定</span><span class="s2">&quot;</span>
  },
  <span class="s2">&quot;</span><span class="s">builders</span><span class="s2">&quot;</span>: [{
    <span class="s2">&quot;</span><span class="s">type</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">sakuracloud</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">zone</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">{{user `sakuracloud_zone`}}</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">os_type</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">iso</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">iso_url</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">{{user `iso_url`}}</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">iso_checksum</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">{{user `iso_checksum`}}</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">iso_checksum_type</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">{{user `iso_checksum_type`}}</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">us_keyboard</span><span class="s2">&quot;</span>: <span class="nv">true</span>,
    <span class="s2">&quot;</span><span class="s">boot_wait</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">20s</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">boot_command</span><span class="s2">&quot;</span>: [
      <span class="s2">&quot;</span><span class="s">cat &lt;&lt;&#39;EOF&#39; &gt; /tmp/cloud-config.yml&lt;enter&gt;</span><span class="s2">&quot;</span>,
      <span class="s2">&quot;</span><span class="s">#cloud-config&lt;enter&gt;</span><span class="s2">&quot;</span>,
      <span class="s2">&quot;</span><span class="s">users:&lt;enter&gt;</span><span class="s2">&quot;</span>,
      <span class="s2">&quot;</span><span class="s">  - name: core&lt;enter&gt;</span><span class="s2">&quot;</span>,
      <span class="s2">&quot;</span><span class="s">    passwd: {{user `tmp_password_hash`}}&lt;enter&gt;</span><span class="s2">&quot;</span>,
      <span class="s2">&quot;</span><span class="s">EOF&lt;enter&gt;&lt;wait&gt;</span><span class="s2">&quot;</span>,
      <span class="s2">&quot;</span><span class="s">sudo coreos-install -c /tmp/cloud-config.yml -d {{user `install_disk_device`}}&lt;enter&gt;&lt;wait&gt;</span><span class="s2">&quot;</span>,
      <span class="s2">&quot;</span><span class="s">&lt;wait10&gt;&lt;wait10&gt;&lt;wait10&gt;&lt;wait10&gt;&lt;wait10&gt;&lt;wait10&gt;</span><span class="s2">&quot;</span>,
      <span class="s2">&quot;</span><span class="s">&lt;wait10&gt;&lt;wait10&gt;&lt;wait10&gt;</span><span class="s2">&quot;</span>,
      <span class="s2">&quot;</span><span class="s">reboot&lt;enter&gt;&lt;wait&gt;</span><span class="s2">&quot;</span>
    ],
    <span class="s2">&quot;</span><span class="s">user_name</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">core</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">password</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">{{user `tmp_password`}}</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">archive_name</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">{{user `archive_name`}}</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">archive_tags</span><span class="s2">&quot;</span>: [<span class="s2">&quot;</span><span class="s">@size-extendable</span><span class="s2">&quot;</span>, <span class="s2">&quot;</span><span class="s">current-stable</span><span class="s2">&quot;</span>, <span class="s2">&quot;</span><span class="s">arch-64bit</span><span class="s2">&quot;</span>, <span class="s2">&quot;</span><span class="s">distro-containerlinux</span><span class="s2">&quot;</span>]
  }],
  <span class="s2">&quot;</span><span class="s">provisioners</span><span class="s2">&quot;</span>: [{
    <span class="s2">&quot;</span><span class="s">type</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">shell</span><span class="s2">&quot;</span>,
    <span class="s2">&quot;</span><span class="s">inline</span><span class="s2">&quot;</span>: [
      <span class="s2">&quot;</span><span class="s">sudo passwd -d core</span><span class="s2">&quot;</span>
    ],
    <span class="s2">&quot;</span><span class="s">pause_before</span><span class="s2">&quot;</span>: <span class="s2">&quot;</span><span class="s">20s</span><span class="s2">&quot;</span>
  }]
}
</pre></div>


<p>以下のコマンドを実行すると、一時的にサーバを作ってISOイメージからインストールし、その後シャットダウンしてマイアーカイブを作るという一連の処理を行ってくれます。</p>
<div class="highlight"><pre><span></span><span class="n">packer</span> <span class="n">build</span> <span class="n">containerlinux</span><span class="p">.</span><span class="n">json</span>
</pre></div>


<h2>Terraform for さくらのクラウドでまずルータだけ作成</h2>
<h3>Terraform for さくらのクラウドの事前準備</h3>
<p><a href="https://www.terraform.io/">Terraform</a>と<a href="https://github.com/yamamoto-febc/terraform-provider-sakuracloud">Terraform for さくらのクラウド</a>をインストールしていない場合は、それぞれのドキュメントに従ってインストールしてください。</p>
<p>またAPIキーと利用したいゾーンの設定も必要です。</p>
<p>APIキーの設定は<a href="https://github.com/sacloud/packer-builder-sakuracloud">さくらのクラウド用Packerプラグイン</a>で行ったものと同じなので、ゾーンの設定を追加で行う必要があります。</p>
<div class="highlight"><pre><span></span><span class="err">$</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="n">SAKURACLOUD_ACCESS_TOKEN</span><span class="o">=[</span><span class="n">APIトークン</span><span class="o">]</span><span class="w"></span>
<span class="err">$</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="n">SAKURACLOUD_ACCESS_TOKEN_SECRET</span><span class="o">=[</span><span class="n">APIシークレット</span><span class="o">]</span><span class="w"></span>
<span class="err">$</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="n">SAKURACLOUD_ZONE</span><span class="o">=</span><span class="n">is1b</span><span class="w"></span>
</pre></div>


<h3>Terraform for さくらのクラウドでルータを作成</h3>
<p>Terraformを使うなら本来は1つのtfファイルでルータとサーバを一気に作成したいところなのですが、サーバ1台毎の設定ファイルを含むISOイメージを作る部分をTerraform外のスクリプトで作成する都合上、2ステップに分ける必要があります。</p>
<p>まずは以下の内容を <code>server.tf</code> というファイルに保存します。</p>
<div class="highlight"><pre><span></span>resource &quot;sakuracloud_internet&quot; &quot;router01&quot; {
    name = &quot;router01&quot;
    description = &quot;by Terraform&quot;
    tags = [&quot;Terraform&quot;]
    nw_mask_len = 28
    band_width = 100
}

output &quot;router01_ipaddress&quot; {
    value = &quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">nw_address</span><span class="cp">}</span>&quot;
}

output &quot;router01_gateway&quot; {
    value = &quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">nw_gateway</span><span class="cp">}</span>&quot;
}

output &quot;router01_min_ipaddress&quot; {
    value = &quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">nw_min_ipaddress</span><span class="cp">}</span>&quot;
}

output &quot;router01_max_ipaddress&quot; {
    value = &quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">nw_max_ipaddress</span><span class="cp">}</span>&quot;
}

output &quot;router01_ipaddresses&quot; {
    value = [&quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">nw_ipaddresses</span><span class="cp">}</span>&quot;]
}
</pre></div>


<p><code>nw_mask_len</code> は<a href="https://github.com/yamamoto-febc/terraform-provider-sakuracloud/blob/master/docs/configuration/resources/internet.md">Terraform for さくらのクラウドのルーター</a>のドキュメントのパラメーターの項を参考に、必要なIPアドレスの数に応じて <code>/28</code>, <code>/27</code>, <code>/26</code> から選択してください。設定する値は <code>/</code> 無しの数値です。</p>
<p>なお、<a href="http://cloud-news.sakura.ad.jp/2015/03/31/ipaddr24-25/">「ルータ＋スイッチ」 一部の追加IPアドレス個数でのお申込み方法変更のお知らせ | さくらのクラウドニュース</a> を見ると <code>/25</code>, <code>/24</code> も利用可能ですが営業に問い合わせが必要なため、APIからは利用不可となっています。</p>
<p><code>name</code> や <code>description</code> はお好みで変更してください。</p>
<p>ルーターに付与されるIPアドレスの範囲はルーター作成後に確定し<a href="https://github.com/yamamoto-febc/terraform-provider-sakuracloud/blob/master/docs/configuration/resources/internet.md">Terraform for さくらのクラウドのルーター</a>のドキュメントの属性 <code>nw_address</code> などに設定されます。</p>
<p>上記の <code>server.tf</code> ではTerraformの<a href="https://www.terraform.io/docs/configuration/outputs.html">Configuring Outputs</a>の機能を使ってこれらの属性を出力するようにしています。</p>
<p>Terraformの使い方自体は通常通りです。</p>
<div class="highlight"><pre><span></span><span class="n">terraform</span> <span class="n">plan</span>
</pre></div>


<p>でプランを確認し、</p>
<div class="highlight"><pre><span></span><span class="n">terraform</span> <span class="n">apply</span>
</pre></div>


<p>で適用します。</p>
<p>すると以下のように出力が出ます。以下ではIPアドレスを伏せています。</p>
<div class="highlight"><pre><span></span><span class="n">Outputs</span><span class="o">:</span>

<span class="n">router01_gateway</span> <span class="o">=</span> <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">145</span>
<span class="n">router01_ipaddress</span> <span class="o">=</span> <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">144</span>
<span class="n">router01_ipaddresses</span> <span class="o">=</span> <span class="o">[</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">148</span><span class="o">,</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">149</span><span class="o">,</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">150</span><span class="o">,</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">151</span><span class="o">,</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">152</span><span class="o">,</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">153</span><span class="o">,</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">154</span><span class="o">,</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">155</span><span class="o">,</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">156</span><span class="o">,</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">157</span><span class="o">,</span>
    <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">158</span>
<span class="o">]</span>
<span class="n">router01_max_ipaddress</span> <span class="o">=</span> <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">158</span>
<span class="n">router01_min_ipaddress</span> <span class="o">=</span> <span class="n">xxx</span><span class="o">.</span><span class="na">yyy</span><span class="o">.</span><span class="na">zzz</span><span class="o">.</span><span class="mi">148</span>
</pre></div>


<h2>作成したいサーバ1台毎にContainer LinuxのConfig DriveのISOイメージを作成</h2>
<p><a href="https://coreos.com/os/docs/latest/config-drive.html">Customize with Config-Drive</a>の手順に従ってConfig DriveのISOイメージを作成し、<a href="https://github.com/yamamoto-febc/sacloud-upload-image">Upload ISO image to SAKURA CLOUD</a>を使ってさくらのクラウドにアップロードします。</p>
<h3>事前準備</h3>
<p>私はCentOSで作業したので、ISOイメージの作成に使う <code>mkisofs</code> を以下のコマンドでインストールしました。</p>
<div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">yum</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">mkisofs</span>
</pre></div>


<p>macOSをお使いの場合は <code>mkisofs</code> は不要ですが、次項の <code>mkupload.sh</code> で <code>mkisofs</code> を呼び出しているところを<a href="https://coreos.com/os/docs/latest/config-drive.html">Customize with Config-Drive</a>を参考に書き変えてください。</p>
<p><a href="https://github.com/yamamoto-febc/sacloud-upload-image">Upload ISO image to SAKURA CLOUD</a>をインストールしていない場合はインストールしてください。</p>
<p>APIキーの取得とAPIキー及びゾーンの環境変数設定は上記のTerraform for さくらのクラウドのときと同じなので既に行っていれば不要です。</p>
<h3>サーバを作成するリージョンの推奨ネームサーバのIPアドレスを調べる</h3>
<p>この記事を書いた当初はネームサーバの調べ方がわからなくて、GoogleのDNS 8.8.8.8 を指定していましたが、サーバを作成した後さくらのクラウドのコントロールパネルでサーバの詳細情報のNICタブを選択すると「このリージョンの推奨ネームサーバ: 133.242.0.3, 133.242.0.4」のように表示されていることに気づきました。</p>
<p>リージョン毎のネームサーバ一覧はさくらのクラウドのドキュメントでは見つけられなかったのですが、<a href="http://developer.sakura.ad.jp/cloud/api/1.1/facility/">設備関連API - さくらのクラウド API v1.1 ドキュメント</a>のリージョン一覧を取得のレスポンスにリージョン毎のネームサーバのIPアドレスが含まれていました。</p>
<p>実際に試した結果は以下の通りです。</p>
<div class="highlight"><pre><span></span>$ curl -su <span class="nv">$SAKURACLOUD_ACCESS_TOKEN</span>:<span class="nv">$SAKURACLOUD_ACCESS_TOKEN_SECRET</span> <span class="se">\</span>
  https://secure.sakura.ad.jp/cloud/zone/<span class="nv">$SAKURACLOUD_ZONE</span>/api/cloud/1.1/region <span class="se">\</span>
  <span class="p">|</span> jq .
<span class="o">{</span>
  <span class="s2">&quot;From&quot;</span>: <span class="m">0</span>,
  <span class="s2">&quot;Count&quot;</span>: <span class="m">3</span>,
  <span class="s2">&quot;Total&quot;</span>: <span class="m">3</span>,
  <span class="s2">&quot;Regions&quot;</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">&quot;Index&quot;</span>: <span class="m">0</span>,
      <span class="s2">&quot;ID&quot;</span>: <span class="m">210</span>,
      <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;東京&quot;</span>,
      <span class="s2">&quot;Description&quot;</span>: <span class="s2">&quot;東京&quot;</span>,
      <span class="s2">&quot;NameServers&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;210.188.224.10&quot;</span>,
        <span class="s2">&quot;210.188.224.11&quot;</span>
      <span class="o">]</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;Index&quot;</span>: <span class="m">1</span>,
      <span class="s2">&quot;ID&quot;</span>: <span class="m">290</span>,
      <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;Sandbox&quot;</span>,
      <span class="s2">&quot;Description&quot;</span>: <span class="s2">&quot;Sandbox&quot;</span>,
      <span class="s2">&quot;NameServers&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;133.242.0.3&quot;</span>,
        <span class="s2">&quot;133.242.0.4&quot;</span>
      <span class="o">]</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">&quot;Index&quot;</span>: <span class="m">2</span>,
      <span class="s2">&quot;ID&quot;</span>: <span class="m">310</span>,
      <span class="s2">&quot;Name&quot;</span>: <span class="s2">&quot;石狩&quot;</span>,
      <span class="s2">&quot;Description&quot;</span>: <span class="s2">&quot;石狩&quot;</span>,
      <span class="s2">&quot;NameServers&quot;</span>: <span class="o">[</span>
        <span class="s2">&quot;133.242.0.3&quot;</span>,
        <span class="s2">&quot;133.242.0.4&quot;</span>
      <span class="o">]</span>
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">&quot;is_ok&quot;</span>: <span class="nb">true</span>
<span class="o">}</span>
</pre></div>


<h3>Config DriveのISOイメージを作成・アップロード</h3>
<p>以下のシェルスクリプトを <code>mkupload.sh</code> という名前で保存し、 <code>chmod +x mkupload.sh</code> で実行パーミションを付けます。</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>
<span class="nb">set</span> -eu
<span class="nv">basedir</span><span class="o">=</span>/tmp/configdrive.<span class="nv">$$</span>
<span class="nv">server</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$SERVER</span><span class="s2">&quot;</span>
<span class="nv">ssh_pub_key</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$SSH_PUB_KEY</span><span class="s2">&quot;</span>
<span class="nv">dns1</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DNS1</span><span class="s2">&quot;</span>
<span class="nv">dns2</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$DNS2</span><span class="s2">&quot;</span>
<span class="nv">address</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$ADDRESS</span><span class="s2">&quot;</span>
<span class="nv">gateway</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$GATEWAY</span><span class="s2">&quot;</span>
<span class="nv">priv_address</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$PRIV_ADDRESS</span><span class="s2">&quot;</span>

mkdir -p <span class="s2">&quot;</span><span class="nv">$basedir</span><span class="s2">/openstack/latest&quot;</span>

cat <span class="s">&lt;&lt;EOF &gt; &quot;$basedir/openstack/latest/user_data&quot;</span>
<span class="s">#cloud-config</span>

<span class="s">users:</span>
<span class="s">  - name: &quot;core&quot;</span>
<span class="s">    ssh-authorized-keys:</span>
<span class="s">      - &quot;${ssh_pub_key}&quot;</span>
<span class="s">coreos:</span>
<span class="s">  units:</span>
<span class="s">    - name: 00-eth0.network</span>
<span class="s">      runtime: true</span>
<span class="s">      content: |</span>
<span class="s">        [Match]</span>
<span class="s">        Name=eth0</span>

<span class="s">        [Network]</span>
<span class="s">        DNS=${dns1}</span>
<span class="s">        DNS=${dns2}</span>
<span class="s">        Address=${address}</span>
<span class="s">        Gateway=${gateway}</span>
<span class="s">    - name: 01-eth1.network</span>
<span class="s">      runtime: true</span>
<span class="s">      content: |</span>
<span class="s">        [Match]</span>
<span class="s">        Name=eth1</span>

<span class="s">        [Network]</span>
<span class="s">        Address=${priv_address}</span>
<span class="s">EOF</span>

<span class="nv">config_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">server</span><span class="si">}</span><span class="s2">-config&quot;</span>
mkisofs -R -V config-2 -o <span class="s2">&quot;</span><span class="si">${</span><span class="nv">config_name</span><span class="si">}</span><span class="s2">.iso&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">basedir</span><span class="si">}</span><span class="s2">&quot;</span>
sacloud-upload-image -f <span class="s2">&quot;</span><span class="si">${</span><span class="nv">config_name</span><span class="si">}</span><span class="s2">.iso&quot;</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">config_name</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</td></tr></table>

<p><a href="https://coreos.com/os/docs/latest/config-drive.html">Customize with Config-Drive</a>では <code>DNS=</code> の行は1つだけですが、<a href="https://www.freedesktop.org/software/systemd/man/systemd.network.html#DNS=">systemd.network</a>のドキュメントによると複数指定可能なので2つ指定するようにしました。</p>
<p>以下のように実行します。公開鍵のパスはとIPアドレスは適宜変更してください。</p>
<div class="highlight"><pre><span></span><span class="n">SERVER</span><span class="o">=</span><span class="n">server01</span> <span class="err">\</span>
<span class="n">SSH_PUB_KEY</span><span class="o">=</span><span class="ss">&quot;`cat ~/.ssh/id_rsa.pub`&quot;</span> <span class="err">\</span>
<span class="n">DNS1</span><span class="o">=</span><span class="mi">133</span><span class="p">.</span><span class="mi">242</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span> <span class="err">\</span>
<span class="n">DNS2</span><span class="o">=</span><span class="mi">133</span><span class="p">.</span><span class="mi">242</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span> <span class="err">\</span>
<span class="n">ADDRESS</span><span class="o">=</span><span class="n">xxx</span><span class="p">.</span><span class="n">yyy</span><span class="p">.</span><span class="n">zzz</span><span class="p">.</span><span class="mi">148</span><span class="o">/</span><span class="mi">28</span> <span class="err">\</span>
<span class="n">GATEWAY</span><span class="o">=</span><span class="n">xxx</span><span class="p">.</span><span class="n">yyy</span><span class="p">.</span><span class="n">zzz</span><span class="p">.</span><span class="mi">145</span> <span class="err">\</span>
<span class="n">PRIV_ADDRESS</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">101</span><span class="o">/</span><span class="mi">24</span> <span class="err">\</span>
<span class="p">.</span><span class="o">/</span><span class="n">mkuploadconfig</span><span class="p">.</span><span class="n">sh</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">SERVER</span><span class="o">=</span><span class="n">server02</span> <span class="err">\</span>
<span class="n">SSH_PUB_KEY</span><span class="o">=</span><span class="ss">&quot;`cat ~/.ssh/id_rsa.pub`&quot;</span> <span class="err">\</span>
<span class="n">DNS1</span><span class="o">=</span><span class="mi">133</span><span class="p">.</span><span class="mi">242</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">3</span> <span class="err">\</span>
<span class="n">DNS2</span><span class="o">=</span><span class="mi">133</span><span class="p">.</span><span class="mi">242</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">4</span> <span class="err">\</span>
<span class="n">ADDRESS</span><span class="o">=</span><span class="n">xxx</span><span class="p">.</span><span class="n">yyy</span><span class="p">.</span><span class="n">zzz</span><span class="p">.</span><span class="mi">149</span><span class="o">/</span><span class="mi">28</span> <span class="err">\</span>
<span class="n">GATEWAY</span><span class="o">=</span><span class="n">xxx</span><span class="p">.</span><span class="n">yyy</span><span class="p">.</span><span class="n">zzz</span><span class="p">.</span><span class="mi">145</span> <span class="err">\</span>
<span class="n">PRIV_ADDRESS</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">102</span><span class="o">/</span><span class="mi">24</span> <span class="err">\</span>
<span class="p">.</span><span class="o">/</span><span class="n">mkuploadconfig</span><span class="p">.</span><span class="n">sh</span>
</pre></div>


<p><code>ADDRESS</code> の値は上記で出力された <code>router01_ipaddresses</code> の値を上から順番に使い、ネットワークマスク付きで指定しています。</p>
<p>作成されるISOイメージの名前は <code>${SERVER}-config</code> となります。上記の例だと <code>server01-config</code> と <code>server02-config</code> です。</p>
<h2>Terraform for さくらのクラウドでルータに繋がったサーバを作成</h2>
<p>上記で作成していた <code>server.tf</code> にローカルネットワーク用のスイッチ、サーバ、ディスクのリソースを追記します。</p>
<div class="highlight"><pre><span></span>resource &quot;sakuracloud_internet&quot; &quot;router01&quot; {
    name = &quot;router01&quot;
    description = &quot;by Terraform&quot;
    tags = [&quot;Terraform&quot;]
    nw_mask_len = 28
    band_width = 100
}

resource &quot;sakuracloud_switch&quot; &quot;switch01&quot; {
    name = &quot;switch01&quot;
    description = &quot;by Terraform&quot;
    tags = [&quot;Terraform&quot;]
}

resource &quot;sakuracloud_server&quot; &quot;server01&quot; {
    name = &quot;server01&quot;
    disks = [&quot;<span class="cp">${</span><span class="n">sakuracloud_disk</span><span class="o">.</span><span class="n">disk01</span><span class="o">.</span><span class="n">id</span><span class="cp">}</span>&quot;]
    cdrom_id = &quot;<span class="cp">${</span><span class="n">data</span><span class="o">.</span><span class="n">sakuracloud_cdrom</span><span class="o">.</span><span class="n">server01_config</span><span class="o">.</span><span class="n">id</span><span class="cp">}</span>&quot;
    tags = [&quot;@virtio-net-pci&quot;, &quot;Terraform&quot;]
    description = &quot;by Terraform&quot;
    core = &quot;1&quot;
    memory = &quot;1&quot;
    base_interface = &quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">switch_id</span><span class="cp">}</span>&quot;
    additional_interfaces = [&quot;<span class="cp">${</span><span class="n">sakuracloud_switch</span><span class="o">.</span><span class="n">switch01</span><span class="o">.</span><span class="n">id</span><span class="cp">}</span>&quot;]
}
resource &quot;sakuracloud_disk&quot; &quot;disk01&quot; {
    name = &quot;disk01&quot;
    source_archive_id = &quot;<span class="cp">${</span><span class="n">data</span><span class="o">.</span><span class="n">sakuracloud_archive</span><span class="o">.</span><span class="n">containerlinux</span><span class="o">.</span><span class="n">id</span><span class="cp">}</span>&quot;
    size = &quot;40&quot;
    description = &quot;by Terraform&quot;
}
data &quot;sakuracloud_cdrom&quot; &quot;server01_config&quot; {
    filter = {
        name   = &quot;Name&quot;
        values = [&quot;server01-config&quot;]
    }
}

resource &quot;sakuracloud_server&quot; &quot;server02&quot; {
    name = &quot;server02&quot;
    disks = [&quot;<span class="cp">${</span><span class="n">sakuracloud_disk</span><span class="o">.</span><span class="n">disk02</span><span class="o">.</span><span class="n">id</span><span class="cp">}</span>&quot;]
    cdrom_id = &quot;<span class="cp">${</span><span class="n">data</span><span class="o">.</span><span class="n">sakuracloud_cdrom</span><span class="o">.</span><span class="n">server02_config</span><span class="o">.</span><span class="n">id</span><span class="cp">}</span>&quot;
    tags = [&quot;@virtio-net-pci&quot;, &quot;Terraform&quot;]
    description = &quot;by Terraform&quot;
    core = &quot;1&quot;
    memory = &quot;1&quot;
    base_interface = &quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">switch_id</span><span class="cp">}</span>&quot;
    additional_interfaces = [&quot;<span class="cp">${</span><span class="n">sakuracloud_switch</span><span class="o">.</span><span class="n">switch01</span><span class="o">.</span><span class="n">id</span><span class="cp">}</span>&quot;]
}
resource &quot;sakuracloud_disk&quot; &quot;disk02&quot; {
    name = &quot;disk02&quot;
    source_archive_id = &quot;<span class="cp">${</span><span class="n">data</span><span class="o">.</span><span class="n">sakuracloud_archive</span><span class="o">.</span><span class="n">containerlinux</span><span class="o">.</span><span class="n">id</span><span class="cp">}</span>&quot;
    size = &quot;40&quot;
    description = &quot;by Terraform&quot;
}
data &quot;sakuracloud_cdrom&quot; &quot;server02_config&quot; {
    filter = {
        name   = &quot;Name&quot;
        values = [&quot;server02-config&quot;]
    }
}

data &quot;sakuracloud_archive&quot; &quot;containerlinux&quot; {
    filter = {
        name   = &quot;Tags&quot;
        values = [&quot;current-stable&quot;, &quot;arch-64bit&quot;, &quot;distro-containerlinux&quot;]
    }
}

output &quot;router01_ipaddress&quot; {
    value = &quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">nw_address</span><span class="cp">}</span>&quot;
}

output &quot;router01_gateway&quot; {
    value = &quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">nw_gateway</span><span class="cp">}</span>&quot;
}

output &quot;router01_min_ipaddress&quot; {
    value = &quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">nw_min_ipaddress</span><span class="cp">}</span>&quot;
}

output &quot;router01_max_ipaddress&quot; {
    value = &quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">nw_max_ipaddress</span><span class="cp">}</span>&quot;
}

output &quot;router01_ipaddresses&quot; {
    value = [&quot;<span class="cp">${</span><span class="n">sakuracloud_internet</span><span class="o">.</span><span class="n">router01</span><span class="o">.</span><span class="n">nw_ipaddresses</span><span class="cp">}</span>&quot;]
}
</pre></div>


<p>serverの <code>core</code>, <code>memory</code> やdiskの <code>size</code> などはお好みで変更してください。
設定可能な値の一覧は<a href="http://cloud.sakura.ad.jp/specification/server-disk/">サーバー/ディスク機能の仕様・料金| さくらのクラウド</a>を参照してください。</p>
<p>あとは通常通りTerraformを実行するだけです。</p>
<div class="highlight"><pre><span></span><span class="n">terraform</span> <span class="n">plan</span>
</pre></div>


<p>でプランを確認し、</p>
<div class="highlight"><pre><span></span><span class="n">terraform</span> <span class="n">apply</span>
</pre></div>


<p>で適用します。</p>
<p>これでルーターに繋がったContainer Linuxのサーバを静的IPアドレス設定で作成できました！</p>
<h2>気になった点</h2>
<h3>作成したサーバをコンパネでみるとIPアドレスが表示されていない</h3>
<p>コンパネのサーバ詳細の「NIC」タブのルータ＋スイッチの行の「IPv4アドレス」がハイフンになっていました。またコンパネの「マップ」で見てもIPアドレスが表示されていませんでした。</p>
<p>まあこれはディスクの修正機能を使っていないので仕方ない気もします。
が、<a href="http://cloud-news.sakura.ad.jp/2014/09/19/map-ipaddr-modifying/">マップ画面に表示されるIPアドレス編集機能を追加しました | さくらのクラウドニュース</a>の手順で設定すれば大丈夫でした。</p>
<p>実現可能かどうかまだよくわかっていないのですが<a href="https://github.com/yamamoto-febc/terraform-provider-sakuracloud">Terraform for さくらのクラウド</a>でのサーバ作成時にこのIPアドレスを設定できると理想的だなあと思います。</p>
<h3>Container LinuxのConfig DriveをTerraformで作成できたらさらに理想的</h3>
<p>現状だとこの記事で書いたように一旦ルーターだけ作って、IPアドレスを調べてから、サーバを作るという手順を踏む必要があります。このため、Terraformの設定ファイルを書き変えて2回適用する必要があります。</p>
<p>もしContainer LinuxのConfig DriveをTerraformで作成できたら、Terraformの設定ファイルを最初からサーバ込みで記述して1回の適用でルータとサーバを一気に作成できることになるので、こうなれば最高だなーと思います。が、どういう仕様にするかと実装を推測してみるとこれはかなり難しそうな気がします。</p>
<h3>Packerで作ったマイアーカイブでcoreユーザのパスワードを消せていない</h3>
<p>Container Linuxはcoreユーザでssh鍵認証でログインすることが前提となっていて、パスワードは元々設定されていません。が、Packerでは <code>boot_command</code> でセットアップした後パスワード認証でssh (Windowsの場合はwinrm)で接続してprovisionerを動かすようになっています。</p>
<p>そこで上記の <code>containerlinux.json</code> では <code>boot_command</code> 内でcoreユーザにパスワードを設定し、ssh接続した後にshell provisionerで <code>sudo passwd -d core</code> というコマンドを実行してパスワードを消そうとしています。</p>
<p>Packerの実行結果は以下のようになり、 <code>passwd: password expiry information changed.</code> の出力でパスワード削除がうまく行っているように見えます。</p>
<div class="highlight"><pre><span></span>$ <span class="nv">packer</span> <span class="nv">build</span> <span class="nv">containerlinux</span>.<span class="nv">json</span>
<span class="nv">sakuracloud</span> <span class="nv">output</span> <span class="nv">will</span> <span class="nv">be</span> <span class="nv">in</span> <span class="nv">this</span> <span class="nv">color</span>.

<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Downloading</span> <span class="nv">or</span> <span class="nv">copying</span> <span class="nv">ISO</span>
    <span class="nv">sakuracloud</span>: <span class="nv">Downloading</span> <span class="nv">or</span> <span class="nv">copying</span>: <span class="nv">https</span>:<span class="o">//</span><span class="nv">stable</span>.<span class="nv">release</span>.<span class="nv">core</span><span class="o">-</span><span class="nv">os</span>.<span class="nv">net</span><span class="o">/</span><span class="nv">amd64</span><span class="o">-</span><span class="nv">usr</span><span class="o">/</span><span class="mi">1185</span>.<span class="mi">5</span>.<span class="mi">0</span><span class="o">/</span><span class="nv">coreos_production_iso_image</span>.<span class="nv">iso</span>
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Creating</span> <span class="nv">temporary</span> <span class="nv">SSH</span> <span class="nv">key</span> <span class="k">for</span> <span class="nv">instance</span>...
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Creating</span> <span class="nv">server</span>...
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Waiting</span> <span class="mi">20</span><span class="nv">s</span> <span class="k">for</span> <span class="nv">boot</span>...
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Waiting</span> <span class="k">for</span> <span class="nv">server</span> <span class="nv">to</span> <span class="nv">become</span> <span class="nv">active</span>...
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Connecting</span> <span class="nv">to</span> <span class="nv">VM</span> <span class="nv">via</span> <span class="nv">VNC</span>
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Typing</span> <span class="nv">the</span> <span class="nv">boot</span> <span class="nv">command</span> <span class="nv">over</span> <span class="nv">VNC</span>...
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Waiting</span> <span class="k">for</span> <span class="nv">SSH</span> <span class="nv">to</span> <span class="nv">become</span> <span class="nv">available</span>...
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Connected</span> <span class="nv">to</span> <span class="nv">SSH</span><span class="o">!</span>
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Pausing</span> <span class="mi">20</span><span class="nv">s</span> <span class="nv">before</span> <span class="nv">the</span> <span class="k">next</span> <span class="nv">provisioner</span>...
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Provisioning</span> <span class="nv">with</span> <span class="nv">shell</span> <span class="nv">script</span>: <span class="o">/</span><span class="nv">tmp</span><span class="o">/</span><span class="nv">packer</span><span class="o">-</span><span class="nv">shell837255893</span>
    <span class="nv">sakuracloud</span>: <span class="nv">passwd</span>: <span class="nv">password</span> <span class="nv">expiry</span> <span class="nv">information</span> <span class="nv">changed</span>.
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Gracefully</span> <span class="nv">shutting</span> <span class="nv">down</span> <span class="nv">server</span>...
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Creating</span> <span class="nv">archive</span>: <span class="nv">CoreOS</span> <span class="mi">1185</span>.<span class="mi">5</span>.<span class="mi">0</span>
<span class="o">==&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">Destroying</span> <span class="nv">server</span>...
<span class="nv">Build</span> <span class="s1">&#39;</span><span class="s">sakuracloud</span><span class="s1">&#39;</span> <span class="nv">finished</span>.

<span class="o">==&gt;</span> <span class="nv">Builds</span> <span class="nv">finished</span>. <span class="nv">The</span> <span class="nv">artifacts</span> <span class="nv">of</span> <span class="nv">successful</span> <span class="nv">builds</span> <span class="nv">are</span>:
<span class="o">--&gt;</span> <span class="nv">sakuracloud</span>: <span class="nv">A</span> <span class="nv">archive</span> <span class="nv">was</span> <span class="nv">created</span>: <span class="s1">&#39;</span><span class="s">CoreOS 1185.5.0</span><span class="s1">&#39;</span> <span class="ss">(</span><span class="nv">ID</span>: <span class="mi">112900007545</span><span class="ss">)</span> <span class="nv">in</span> <span class="nv">zone</span> <span class="s1">&#39;</span><span class="s">is1b</span><span class="s1">&#39;</span>
</pre></div>


<p>が、実際に作成したアーカイブをコピーしてディスクとサーバを作成して、sshを試してみるとパスワードでログインできてしまいます。sshでログインした後 <code>sudo passwd -d core</code> でパスワードを消すとその後はパスワード認証は失敗し鍵認証だけ成功するようになります。</p>
<p><code>sudo passwd -d core</code> と実行したときにはPackerで実行したときと同じ <code>sakuracloud: passwd: password expiry information changed.</code> というメッセージが表示されていました。何が原因かわかりませんが、現状は今書いたとおりです。</p>
<p>ということでパスワード認証をしたく無い場合は、サーバ起動後に <code>sudo passwd -d core</code> してください。</p>
<h2>おわりに</h2>
<p>ということで少々不便な点はありますが、さくらのクラウドでContainer Linuxの最新版を使うことが出来ました！</p>
<h3>サーバ1台毎にConfig DriveのISOイメージを作成することの利点</h3>
<p>サーバ1台毎にConfig DriveのISOイメージを作成するのは面倒な気もしますが、実際に使ってみるとそれを上回る利点がありました。</p>
<ul>
<li>利点1: サーバ1台毎にマイアーカイブを作るよりは早くて手軽<ul>
<li>Packerで <code>boot_command</code> と provisioners でプロビジョニングした後サーバを停止してディスクのアーカイブを作成するのですが、この最後の工程が結構時間がかかる時があります。早いときは5分もかからないのですが、混んでいる時は遅くなるらしく1時間弱待たされることもありました。</li>
<li>一方、Config DriveのISOイメージのアップロードはいつも数十秒程度でサクッと終わりました。</li>
<li>この記事の方式だと利用したいディストリビューションのバージョン1つに対してマイアーカイブを作成するのは1回で済むので、時間が節約できます。</li>
</ul>
</li>
<li>利点2: 一度ルーターを作ってIPアドレスが確定した後はConfig DriveのISOイメージは割と使いまわせる<ul>
<li>こちらは普通の使い方ではあまり関係ないかもしれませんが、今回Packerでマイアーカイブを作るときに <code>boot_command</code> や provisioners の設定を変えて何度も試行錯誤して作り直しました。その度にサーバと付随するディスクも作り直したのですが、Config DriveのISOイメージはそのまま残しておいて使いまわすことが出来ました。</li>
<li>このようにベースのアーカイブを何度も変えてサーバを作り直すような試行錯誤をするケースではサーバ1台毎の設定を別出しにしておけるConfig DriveのISOイメージはなかなか便利だなと思いました。</li>
</ul>
</li>
</ul>
<h2>編集履歴</h2>
<h3>2017-01-02 21:16頃</h3>
<p>ISOイメージは<a href="https://github.com/yamamoto-febc/terraform-provider-sakuracloud/blob/master/docs/configuration/resources/data_resource.md">データソース</a>の機能ですでに参照可能とのご指摘を山本さんから頂きました。
すみません、私のドキュメントの読み込み不足でした。
検証してみたら無事使えました！元記事に打ち消し線いれて追記しようかと思ったのですが、わかりにくくなるので直接書き換えました。</p>
<p>変更内容が気になる方は<a href="https://github.com/hnakamur/blog/commit/20170102_2116">gitの差分</a>を参照してください。</p>
<h3>2017-01-02 21:40頃</h3>
<p>「気になった点」に「Packerで作ったマイアーカイブでcoreユーザのパスワードを消せていない」を追記しました。</p>
<h3>2017-01-02 22:30頃</h3>
<p>さくらのクラウドのリージョンごとの推奨ネームサーバを使うように改良しました。
変更内容は<a href="https://github.com/hnakamur/blog/commit/20170102_2230">gitの差分</a>を参照してください。</p>
<h3>2017-01-02 22:50頃</h3>
<p>「おわりに」に「サーバ1台毎にConfig DriveのISOイメージを作成することの利点」を追記しました。</p>
<h3>2017-01-03 11:10頃</h3>
<p>ルーターとは別にスイッチを追加してローカルネットワークも作成するようにしました。
また、
変更内容は<a href="https://github.com/hnakamur/blog/commit/20170103_1110">gitの差分</a>を参照してください。</p>
<h3>2017-01-03 11:15頃</h3>
<p>「参考資料」を追加しました。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>