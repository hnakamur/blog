<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>LXDを試してみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2014/12/01/lxd-the-linux-container-daemon/" rel="bookmark"
           title="Permalink to LXDを試してみた">LXDを試してみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2014-12-01T00:00:00+09:00">
                Published: 2014-12-01
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/lxc.html">lxc</a> <a href="../../../../tag/lxd.html">lxd</a> </p>
</footer><!-- /.post-info -->      <h2>はじめに</h2>
<p>LXDに関するページをいくつか紹介します。</p>
<ul>
<li><a href="https://lists.linuxcontainers.org/pipermail/lxc-users/2014-November/007978.html">[lxc-users] LXD an "hypervisor" for containers (based on liblxc)</a><ul>
<li>LXCメーリングリストに投稿されたLXDのアナウンスメール</li>
</ul>
</li>
<li><a href="http://www.ubuntu.com/cloud/tools/lxd">LXDのホームページ</a></li>
<li><a href="https://github.com/lxc/lxd">lxc/lxd githubレポジトリ</a></li>
<li><a href="https://insights.ubuntu.com/2014/11/04/lxd-the-linux-container-daemon/">Dustin KirklandさんによるLXDの紹介 (2分7秒)</a><ul>
<li>LXDの発音は<a href="https://www.youtube.com/watch?v=U-lXf85Mhno&amp;t=1m18s">1分18秒あたり</a></li>
</ul>
</li>
<li><a href="http://www.zdnet.com/ubuntu-lxd-not-a-docker-replacement-a-docker-enhancement-7000035463/">Ubuntu LXD: Not a Docker replacement, a Docker enhancement | ZDNet</a><ul>
<li>「LXDはdockerを置き換えるものではなく強化するもの」というタイトルの解説記事</li>
</ul>
</li>
</ul>
<p>目指しているのは以下の様なものらしいです。</p>
<ul>
<li>デフォルトでセキュア<ul>
<li>コンテナを非rootユーザで稼働できる</li>
<li>コンテナを隔離して安全に動かせる</li>
</ul>
</li>
<li>コンテナでは単一プロセスを動かすだけではなく完全なOS環境を動かす</li>
<li>リモートのイメージ管理サービスと連携してライブマイグレーションを可能にする</li>
<li>OpenStackとも連携</li>
</ul>
<h2>セットアップ</h2>
<p>Ubuntu 14.04で試しました。
バイナリパッケージをインストールする手順とソースからビルドする手順を書いておきますが、実際に試したのは後者です。正確には最初前者を試したのですが、その後何してよいかドキュメントが見当たらないので後者を試した感じです。</p>
<h3>バイナリパッケージをインストールする手順</h3>
<p><a href="http://www.ubuntu.com/cloud/tools/lxd">The next hypervisor: LXD is fast, secure container management for Linux | Cloud | Ubuntu</a>の"Getting started with LXD"に書いてあります。</p>
<p>add-apt-repositoryを使うため事前にsoftware-properties-commonパッケージをインストールしておく必要があります。</p>
<div class="highlight"><pre><span></span>sudo aptitude install software-properties-common
</pre></div>


<p>その後以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span>sudo add-apt-repository cloud-archive:juno
sudo apt-get update
sudo apt-get install nova-compute-flex
</pre></div>


<h3>ソースからビルドする手順</h3>
<p><a href="https://github.com/lxc/lxd#installing-the-dependencies">lxc/lxd</a>の手順に従います。</p>
<p>以下のコマンドで依存ライブラリをインストールします。</p>
<div class="highlight"><pre><span></span>sudo apt-get install lxc lxc-dev mercurial git pkg-config
</pre></div>


<p>Goをインストールします。</p>
<div class="highlight"><pre><span></span>sudo apt-get install software-properties-common
sudo add-apt-repository ppa:ubuntu-lxc/lxd-daily
sudo apt-get update
sudo apt-get install golang
</pre></div>


<p>GOPATHのディレクトリを作成して、GOPATH環境変数を設定します。
以下はbashを使っている想定で ~/.bashrc に追加してシェルを再起動する例です。</p>
<div class="highlight"><pre><span></span>mkdir -p ~/go
echo &#39;export GOPATH=$HOME/go&#39; &gt;&gt; ~/.bashrc
exec $SHELL -l
</pre></div>


<p>go getしてソースディレクトリに移動してビルドします。</p>
<div class="highlight"><pre><span></span>go get github.com/lxc/lxd
cd $GOPATH/src/github.com/lxc/lxd
go get -v -d ./...
make
</pre></div>


<p>./lxc/lxcと./lxd/lxdという2つの実行ファイルが作られます。</p>
<div class="highlight"><pre><span></span>vagrant@ubuntu-1404:~/go/src/github.com/lxc/lxd$ file ./lxc/lxc ./lxd/lxd
./lxc/lxc: ELF 64-bit LSB  executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.24, BuildID[sha1]=a317752267685a543f724c02c2fb827e03564236, not stripped
./lxd/lxd: ELF 64-bit LSB  executable, x86-64, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.24, BuildID[sha1]=8f4ff9b64ecda66a2269c18fd5c440620d548da3, not stripped
</pre></div>


<p>lxdはlxdのデーモンです。lxcはlxdに通信するクライアントプログラムです。<a href="http://gopkg.in/lxc/go-lxc.v2">go-lxc.v2 - gopkg.in/lxc/go-lxc.v2</a>というLXCのGoバインディングライブラリを使用しています。</p>
<h2>セットアップ</h2>
<p>ビルド後以下の環境整備が必要です。</p>
<div class="highlight"><pre><span></span>sudo mkdir -p /var/lib/lxd
sudo chown $USER:$USER /var/lib/lxd
echo &quot;$USER:1000000:65536&quot; | sudo tee -a /etc/subuid /etc/subgid
</pre></div>


<h2>使い方</h2>
<h3>lxdの起動</h3>
<div class="highlight"><pre><span></span>./lxd/lxd &amp;
</pre></div>


<h3>lxcのコンテナ作成</h3>
<div class="highlight"><pre><span></span>./lxc/lxc create iamge:ubuntu foo
</pre></div>


<p>READMEでは <code>image:ubuntu</code> をつけていませんが、これだと以下の様なエラーになりました。</p>
<div class="highlight"><pre><span></span>$ ./lxc/lxc create baz
error: Only the default ubuntu image is supported. Try <span class="sb">`</span>lxc create images:ubuntu foo<span class="sb">`</span>.
</pre></div>


<h3>lxcのコンテナ起動</h3>
<div class="highlight"><pre><span></span>./lxc/lxc start foo
</pre></div>


<h3>lxcのコンテナ一覧表示</h3>
<div class="highlight"><pre><span></span>$ ./lxc/lxc
foo
</pre></div>


<p>なお、通常のlxcとはコンテナの管理が別になっているのか(要確認)、 <code>lxc-ls</code> しても fooは表示されませんでした。</p>
<h3>lxcのコンテナ停止</h3>
<div class="highlight"><pre><span></span>./lxc/lxc stop foo
</pre></div>


<h3>lxcのコンテナ停止</h3>
<div class="highlight"><pre><span></span>./lxc/lxc delete foo
</pre></div>


<h3>lxc shellが未実装！</h3>
<p>コンテナでコマンドを実行してみたいところなのですが、 <code>lxc shell</code> というサブコマンドは未実装だそうです。</p>
<div class="highlight"><pre><span></span>$ ./lxc/lxc <span class="nb">help</span>
Usage: lxc <span class="o">[</span>subcommand<span class="o">]</span> <span class="o">[</span>options<span class="o">]</span>
Available commands:
  config     - Manage configuration.
  create     - lxc create images:ubuntu &lt;name&gt;
  delete     - lxc delete &lt;resource&gt;
  finger     - Fingers the lxd instance to check <span class="k">if</span> it is up and working.
  freeze     - Changes a containers state to freeze.
  <span class="nb">help</span>       - Presents details on how to use lxd.
  list       - Lists the available resources.
  remote     - Manage remote lxc servers.
  restart    - Changes a containers state to restart.
  shell      - Start a shell or specified <span class="nb">command</span> <span class="o">(</span>NOT IMPLEMENTED<span class="o">)</span> in a container.
  start      - Changes a containers state to start.
  stop       - Changes a containers state to stop.
  unfreeze   - Changes a containers state to unfreeze.
  version    - Prints the version number of lxd.
</pre></div>


<p>ソースを見ても <a href="https://github.com/lxc/lxd/blob/a315c07c632188f7d37fa8dbbe3f1b7d87ab34de/lxc/shell.go#L38-L42">lxd/shell.go at a315c07c632188f7d37fa8dbbe3f1b7d87ab34de · lxc/lxd</a> のあたりにTODOと書かれています。</p>
<p>ただ、<a href="https://github.com/lxc/go-lxc">lxc/go-lxc</a>のソースを見ると、コンテナ内でコマンドを実行するための関数はあるのですが、</p>
<p>https://github.com/lxc/go-lxc/blob/bc0a9447e0be56f8e35d0affe83a92e638308e2f/container.go#L422-L423</p>
<div class="highlight"><pre><span></span>// Execute executes the given command in a temporary container.
func (c *Container) Execute(args ...string) ([]byte, error) {
</pre></div>


<p>コマンド実行後に標準出力の結果を戻り値で受け取るようになっています。</p>
<p>シェルを起動してインタラクティブに入出力するには、標準入力、標準出力、標準エラー出力をストリームのようにリアルタイムにやりとりするような関数が必要だと思います。</p>
<h2>おわりに</h2>
<p>早く <code>lxc shell</code> が実装されて欲しいですね！</p>
<p>2015-04-23 追記</p>
<p><a href="/blog/2015/04/23/try-lxd-0.7-with-vagrant/">LXD 0.7ではlxc execでシェルの対話操作もできるようになっていました</a>に書きましたが、 <code>lxc exec コンテナ名 /bin/bash</code> でシェルの対話操作もできるようになっていました。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>