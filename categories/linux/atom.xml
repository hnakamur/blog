<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Linux | hnakamur's blog at github]]></title>
  <link href="http://hnakamur.github.com/blog/categories/linux/atom.xml" rel="self"/>
  <link href="http://hnakamur.github.com/blog/"/>
  <updated>2012-06-21T20:10:50+09:00</updated>
  <id>http://hnakamur.github.com/blog/</id>
  <author>
    <name><![CDATA[Hiroaki Nakamura]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[mod_xsendfileでダウンロード後にサーバ上のファイル自動削除]]></title>
    <link href="http://hnakamur.github.com/blog/2012/03/03/delete-on-close-using-mod-xsendfile/"/>
    <updated>2012-03-03T20:26:00+09:00</updated>
    <id>http://hnakamur.github.com/blog/2012/03/03/delete-on-close-using-mod-xsendfile</id>
    <content type="html"><![CDATA[<p><a href="https://tn123.org/mod_xsendfile/">mod_xsendfile</a>のホームページ上でリリースされているバージョン0.12には含まれていませんが、<a href="https://github.com/nmaier/mod_xsendfile/commit/f6b853ce0e555b61f83f928d9f927349346018b4">Githubのレポジトリのソース</a>ではX-Sendfile-Temporaryという拡張ヘッダに対応しています。</p>

<p>Scientific Linux 6.1で実験しました。</p>

<h2>mod_xsendfileのインストール</h2>

<p>以下の手順でインストールします。
<code>bash
yum install -y httpd-devel
git clone https://github.com/nmaier/mod_xsendfile.git
cd mod_xsendfile
apxs -cia mod_xsendfile.c
</code></p>

<p>実験スクリプト用にApacheの設定ファイルを作成します。
``` text /etc/httpd/conf.d/xsendfile_test.conf
<Directory /var/www/html/xsendfile></p>

<pre><code>XSendFilePath /var/www/html/xsendfile/data AllowFileDelete
&lt;Files out.php&gt;
  XSendFile on
&lt;/Files&gt;
</code></pre>

<p></Directory>
```</p>

<p>Apache再起動。
<code>bash
/etc/init.d/httpd graceful
</code></p>

<h2>実験</h2>

<p>実験スクリプト用のフォルダを作ります。
<code>bash
mkdir /var/www/html/xsendfile/data/
chown -R apache:apache /var/www/html/xsendfile
</code></p>

<p>実験用のPHPスクリプトを作成します。
<code>php /var/www/html/xsendfile/out.php
&lt;?php
$path = '/var/www/html/xsendfile/data/file1.txt';
$fname = basename($path);
header("X-Sendfile-Temporary: $path");
header("Content-Type: application/octet-stream");
header("Content-Disposition: attachment; filename=\"$fname\"");
</code></p>

<p>実験用のダウンロードファイルを作成します。
<code>text /var/www/html/xsendfile/data/file1.txt
Hello, X-Sendfile-Temporary!
</code></p>

<p>これで、ブラウザで http://your_host_here/xsendfile/out.php を開くとダウンロード後にサーバ上のファイルが削除されました。</p>

<h2>今回のはまりポイント</h2>

<p>``` text /etc/httpd/conf.d/xsendfile_test.conf
<Directory /var/www/html/xsendfile></p>

<pre><code>XSendFilePath /var/www/html/xsendfile/data
&lt;Files out.php&gt;
  XSendFile on
&lt;/Files&gt;
</code></pre>

<p></Directory>
<code>
のようにAllowFileDeleteを忘れていたら、out.phpを開いた時に404 Not Foundエラーになり、Apacheのエラーログには以下のようなエラーが出ていました。
</code> text /var/log/httpd/error_log
[Sat Mar 03 15:57:07 2012] [error] [client 192.168.11.3] (14)Bad address: xsendfile: cannot open file: (null)
```
AllowFileDeleteをつければOKでした。</p>
]]></content>
  </entry>
  
</feed>
