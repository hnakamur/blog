<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Xhyve on hnakamur&#39;s blog at github</title>
    <link>/blog/tags/xhyve/</link>
    <description>Recent content in Xhyve on hnakamur&#39;s blog at github</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-JP</language>
    <lastBuildDate>Sun, 12 Jul 2015 06:34:46 +0900</lastBuildDate>
    <atom:link href="/blog/tags/xhyve/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>xhyveでFreeBSDを動かしてみた</title>
      <link>/blog/2015/07/12/running_freebsd_on_xhyve/</link>
      <pubDate>Sun, 12 Jul 2015 06:34:46 +0900</pubDate>
      
      <guid>/blog/2015/07/12/running_freebsd_on_xhyve/</guid>
      <description>

&lt;p&gt;下記の記事を参考に動かしただけですが、後々使うときに手順を忘れているはずなのでメモ。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.holidayworking.org/entry/2015/06/27/xhyve_%E3%81%A7_FreeBSD_%E3%82%92%E5%8B%95%E3%81%8B%E3%81%97%E3%81%A6%E3%81%BF%E3%81%9F&#34;&gt;xhyve で FreeBSD を動かしてみた - blog.holidayworking.org&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.holidayworking.org/entry/2015/07/05/FreeBSD_on_xhyve_%E3%81%A7%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%82%92%E3%83%9E%E3%82%A6%E3%83%B3%E3%83%88%E3%81%99%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%9F&#34;&gt;FreeBSD on xhyve でディスクをマウントすることができた - blog.holidayworking.org&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;なお、FreeBSD対応のプルリクエストは既に本家のmasterにマージ済みです。
また、今回使ったスクリプトは &lt;a href=&#34;https://github.com/hnakamur/xhyve/tree/add_scripts_for_freebsd&#34;&gt;hnakamur/xhyveのadd_scripts_for_freebsdブランチ&lt;/a&gt; に上げています。&lt;/p&gt;

&lt;h2 id=&#34;freebsdのvmイメージダウンロードと解凍:c6b057c495414fd6191dc79669cf401e&#34;&gt;FreeBSDのVMイメージダウンロードと解凍&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;./download_freebsd_image.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;FreeBSD-10.1-RELEASE-amd64.raw.xzを取得、解凍します。解凍後のファイルサイズは約21GBです。&lt;/p&gt;

&lt;h2 id=&#34;freebsdのvm起動:c6b057c495414fd6191dc79669cf401e&#34;&gt;FreeBSDのVM起動&lt;/h2&gt;

&lt;p&gt;ネットワークを使うためには &lt;code&gt;./xhyverun-freebsd.sh&lt;/code&gt; の &lt;code&gt;NET=&amp;quot;-s 2:0,virtio-net&amp;quot;&lt;/code&gt; の行を有効にする必要がありました。これを有効にすると起動には &lt;code&gt;sudo&lt;/code&gt; が必要でしたので、VM起動は以下のように実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo ./xhyverun-freebsd.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;起動したら、IDはroot、パスワード無しでログインできます。&lt;/p&gt;

&lt;h2 id=&#34;ネットワークの設定:c6b057c495414fd6191dc79669cf401e&#34;&gt;ネットワークの設定&lt;/h2&gt;

&lt;p&gt;初回起動時は手動でDHCPクライアントを実行してIPアドレスを取得します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;dhclient vtnet0
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;完了後 &lt;code&gt;ifconfig&lt;/code&gt; で確認すると 192.168.64.10 というIPアドレスが取得できていました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;root@:~ # ifconfig
vtnet0: flags=8943&amp;lt;UP,BROADCAST,RUNNING,PROMISC,SIMPLEX,MULTICAST&amp;gt; metric 0 mtu 1500
        options=80028&amp;lt;VLAN_MTU,JUMBO_MTU,LINKSTATE&amp;gt;
        ether 6a:c9:2c:45:cf:32
        inet 192.168.64.10 netmask 0xffffff00 broadcast 192.168.64.255
        nd6 options=29&amp;lt;PERFORMNUD,IFDISABLED,AUTO_LINKLOCAL&amp;gt;
        media: Ethernet 10Gbase-T &amp;lt;full-duplex&amp;gt;
        status: active
lo0: flags=8049&amp;lt;UP,LOOPBACK,RUNNING,MULTICAST&amp;gt; metric 0 mtu 16384
        options=600003&amp;lt;RXCSUM,TXCSUM,RXCSUM_IPV6,TXCSUM_IPV6&amp;gt;
        inet6 ::1 prefixlen 128
        inet6 fe80::1%lo0 prefixlen 64 scopeid 0x2
        inet 127.0.0.1 netmask 0xff000000
        nd6 options=21&amp;lt;PERFORMNUD,AUTO_LINKLOCAL&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;次回以降の起動時に自動的にDHCPクライアントを実行するために、以下のコマンドを実行します。 &lt;code&gt;/etc/rc.conf&lt;/code&gt; は存在していないので &lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt; ではなく &lt;code&gt;&amp;gt;&lt;/code&gt; でも良いですが、良い習慣付けとして &lt;code&gt;&amp;gt;&amp;gt;&lt;/code&gt; にしておきます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;echo ifconfig_vtnet0=&amp;quot;DHCP&amp;quot; &amp;gt;&amp;gt; /etc/rc.conf
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;freebsdのvm停止:c6b057c495414fd6191dc79669cf401e&#34;&gt;FreeBSDのVM停止&lt;/h2&gt;

&lt;p&gt;VM内で以下のコマンドを実行するとVMをシャットダウンしてホストOSであるOSXのシェルプロンプトに戻ります。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;shutdown -p now
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>xhyveを試してみました</title>
      <link>/blog/2015/06/11/tried_xhyve/</link>
      <pubDate>Thu, 11 Jun 2015 00:45:38 +0900</pubDate>
      
      <guid>/blog/2015/06/11/tried_xhyve/</guid>
      <description>

&lt;p&gt;&lt;a href=&#34;http://www.pagetable.com/?p=831&#34;&gt;xhyve – Lightweight Virtualization on OS X Based on bhyve | pagetable.com&lt;/a&gt;に沿って試してみました。&lt;/p&gt;

&lt;h2 id=&#34;確認した環境:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;確認した環境&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;MacBook Pro (Retina, Mid 2012)&lt;/li&gt;
&lt;li&gt;OS X Yosemite 10.10.3&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;ソースからビルド:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;ソースからビルド&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;cd お好みの作業ディレクトリ
git clone https://github.com/mist64/xhyve
cd xhyve
make
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;tiny-core-linuxを起動:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;Tiny Core Linuxを起動&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;./xhyverun.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;起動メッセージが流れた後、画面がクリアされて以下のように表示されたら起動完了です。ここまで3〜4秒です。速い！&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(�-
 //\   Core is distributed with ABSOLUTELY NO WARRANTY.
 v_/_           www.tinycorelinux.com

tc@box:~$ Switched to clocksource tsc
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;プロンプトにかぶってメッセージが出ていますが、enterを押せばプロンプトが出ます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tc@box:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;シャットダウンするには以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo halt
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ubuntu-server-14-04-2のディスクイメージ作成:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;Ubuntu Server 14.04.2のディスクイメージ作成&lt;/h2&gt;

&lt;p&gt;Ubuntu ServerのISOイメージをダウンロードして、ディスクイメージを作成するための準備を行います。元記事によると、OS Xがハイブリッドファイルシステムを認識しないので、Linux kernelとinitrdを取り出しているそうです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir ubuntu
cd ubuntu
curl -O ftp://ftp.kddilabs.jp/Linux/packages/ubuntu/releases-cd/14.04.2/ubuntu-14.04.2-server-amd64.iso
dd if=/dev/zero bs=2k count=1 of=/tmp/tmp.iso
dd if=ubuntu-14.04.2-server-amd64.iso bs=2k skip=1 &amp;gt;&amp;gt; /tmp/tmp.iso
hdiutil attach /tmp/tmp.iso
cp /Volumes/Ubuntu-Server\ 14/install/vmlinuz .
cp /Volumes/Ubuntu-Server\ 14/install/initrd.gz .
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以下のコマンドでディスクイメージを作成します。ここでは &lt;code&gt;bs=1g count=8&lt;/code&gt; でディスクサイズを8GBとしていますが、お好みで調整してください。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;dd if=/dev/zero of=hdd.img bs=1g count=8
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;xhyve/ubuntuディレクトリではなくxhyveディレクトリにディスクイメージ作成用のスクリプトを作ります。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd ..
cat &amp;lt;&amp;lt;&#39;EOF&#39; &amp;gt; xhyverun_ubuntu_install.sh
#!/bin/sh

KERNEL=&amp;quot;ubuntu/vmlinuz&amp;quot;
INITRD=&amp;quot;ubuntu/initrd.gz&amp;quot;
CMDLINE=&amp;quot;earlyprintk=serial console=ttyS0 acpi=off&amp;quot;

MEM=&amp;quot;-m 1G&amp;quot;
#SMP=&amp;quot;-c 2&amp;quot;
NET=&amp;quot;-s 2:0,virtio-net&amp;quot;
IMG_CD=&amp;quot;-s 3,ahci-cd,ubuntu/ubuntu-14.04.2-server-amd64.iso&amp;quot;
IMG_HDD=&amp;quot;-s 4,virtio-blk,ubuntu/hdd.img&amp;quot;
PCI_DEV=&amp;quot;-s 0:0,hostbridge -s 31,lpc&amp;quot;
LPC_DEV=&amp;quot;-l com1,stdio&amp;quot;

build/xhyve $MEM $SMP $PCI_DEV $LPC_DEV $NET $IMG_CD $IMG_HDD -f kexec,$KERNEL,$INITRD,&amp;quot;$CMDLINE&amp;quot;
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;スクリプトに実行パーミションをつけてsudo付きで実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;chmod +x xhyverun_ubuntu_install.sh
sudo ./xhyverun_ubuntu_install.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;テキストインストーラが起動しますので、以下のように選択してインストールしました。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Select a language: English&lt;/li&gt;
&lt;li&gt;Select your location: other -&amp;gt; Asia -&amp;gt; Japan&lt;/li&gt;
&lt;li&gt;Configure locales: United Status - en_US.UTF-8&lt;/li&gt;
&lt;li&gt;Hostname: お好みの名前&lt;/li&gt;
&lt;li&gt;Set up users and passwords: お好みのIDとパスワードで作成&lt;/li&gt;
&lt;li&gt;time zone: Asia/Tokyo&lt;/li&gt;
&lt;li&gt;Partition disks: Guided - use entire disk&lt;/li&gt;
&lt;li&gt;HTTP proxy: 無し&lt;/li&gt;
&lt;li&gt;manage upgrades: No automatic updates&lt;/li&gt;
&lt;li&gt;Software selection:

&lt;ul&gt;
&lt;li&gt;Basic Ubuntu Server&lt;/li&gt;
&lt;li&gt;OpenSSH server&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Install GRUB to the master boot record: Yes&lt;/li&gt;
&lt;li&gt;Is the system clock set to UTC: No&lt;/li&gt;
&lt;li&gt;Installation complete: Go Back -&amp;gt; Execute a shell&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Installation completeのところでContinueではなくGo Backでメニューに戻りExecute a shellを選んで進み、シェルが起動したら以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd /target
sbin/ifconfig
tar c boot | nc -l -p 1234
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記のコマンド実行のうちsbin/ifconfigで表示されたIPアドレスをメモしておきます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/target # sbin/ifconfig
eth0      Link encap:Ethernet  HWaddr e6:0d:f2:6b:cf:32
          inet addr:192.168.64.3  Bcast:192.168.64.255  Mask:255.255.255.0
          inet6 addr: fe80::e40d:f2ff:fe6b:cf32/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:25405 errors:0 dropped:0 overruns:0 frame:85
          TX packets:13601 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:38179647 (38.1 MB)  TX bytes:931189 (931.1 KB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Mac側では以下のコマンドを実行します。IPアドレスはifconfigで表示されたものに置き換えて実行してください。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd ubuntu
nc 192.168.64.3 1234 | tar x
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;VMのシェルのプロンプトで以下のように入力してシェルを終了します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;exit
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;メニューに戻ったら &lt;code&gt;Finish the installation&lt;/code&gt; を選びます。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Is the system clock set to UTC?: No&lt;/li&gt;
&lt;li&gt;Installation complete: Continue&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;ubuntu-server-14-04-2の起動:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;Ubuntu Server 14.04.2の起動&lt;/h2&gt;

&lt;p&gt;Macでxhyve/ubuntuではなくxhyveのディレクトリで起動用のスクリプトを作成します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;&#39;EOF&#39; &amp;gt; ./xhyverun_ubuntu.sh
#!/bin/sh

KERNEL=&amp;quot;ubuntu/boot/vmlinuz-3.16.0-30-generic&amp;quot;
INITRD=&amp;quot;ubuntu/boot/initrd.img-3.16.0-30-generic&amp;quot;
CMDLINE=&amp;quot;earlyprintk=serial console=ttyS0 acpi=off root=/dev/vda1 ro&amp;quot;

MEM=&amp;quot;-m 1G&amp;quot;
#SMP=&amp;quot;-c 2&amp;quot;
NET=&amp;quot;-s 2:0,virtio-net&amp;quot;
IMG_HDD=&amp;quot;-s 4,virtio-blk,ubuntu/hdd.img&amp;quot;
PCI_DEV=&amp;quot;-s 0:0,hostbridge -s 31,lpc&amp;quot;
LPC_DEV=&amp;quot;-l com1,stdio&amp;quot;

build/xhyve $MEM $SMP $PCI_DEV $LPC_DEV $NET $IMG_CD $IMG_HDD -f kexec,$KERNEL,$INITRD,&amp;quot;$CMDLINE&amp;quot;
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;スクリプトに実行パーミションをつけてsudo付きで実行してUbuntuを起動します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;chmod +x ./xhyverun_ubuntu.sh
sudo ./xhyverun_ubuntu.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;起動してログインプロンプトが出たらインストール時に作成したユーザでログインします。IPアドレスはDHCPで取得する設定にしたのですが、確認してみると、ディスクイメージ作成時とは違う値になっていました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ ip a s eth0
2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 62:ca:c1:25:cf:32 brd ff:ff:ff:ff:ff:ff
    inet 192.168.64.4/24 brd 192.168.64.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::60ca:c1ff:fe25:cf32/64 scope link
       valid_lft forever preferred_lft forever
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Macからsshでログインも出来ました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh ubuntu@192.168.64.4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;sshでログインすると初回だけ表示が24行に限定され、リターンを押しても24行の範囲でスクロールされるようになってしまいました。Mac側ではiTermで65行にしていました。と、この説明を書くためにiTermのウィンドウで高さを変えて行数を変えて戻してとやっていたら、次のsshログインからはiTermの行数で表示されるようになりました。&lt;/p&gt;

&lt;p&gt;Ubuntuを停止するにはVM内で以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo shutdown -h now
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ubuntuの起動に必要なファイル:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;Ubuntuの起動に必要なファイル&lt;/h2&gt;

&lt;p&gt;ubuntuフォルダにはビルドに使用したファイルも含まれていますが、起動スクリプトで参照されているファイル以外のファイルを別ディレクトリに移動して起動してみたら起動出来ました。ということで、起動には以下の4つのファイルだけあればOKです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;./xhyverun_ubuntu.sh
ubuntu/boot/initrd.img-3.16.0-30-generic
ubuntu/boot/vmlinuz-3.16.0-30-generic
ubuntu/hdd.img
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;まとめ:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;まとめ&lt;/h1&gt;

&lt;p&gt;xhyveをソースからビルドして、Tiny Core LinuxとUbuntu Server 14.04.2を動かしてみました。&lt;a href=&#34;https://github.com/mist64/xhyve#todo&#34;&gt;TODO&lt;/a&gt;によると、まだいろいろ対応予定の項目があるようです。今後が楽しみです！&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>