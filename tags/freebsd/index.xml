<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Freebsd on hnakamur&#39;s blog at github</title>
    <link>/blog/tags/freebsd/</link>
    <description>Recent content in Freebsd on hnakamur&#39;s blog at github</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-JP</language>
    <lastBuildDate>Sat, 16 May 2015 11:39:29 +0900</lastBuildDate>
    <atom:link href="/blog/tags/freebsd/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>さくらのVPSにFreeBSD 10.1をクリーンインストールした時のメモ</title>
      <link>/blog/2015/05/16/install_freebsd10.1_on_sakura_vps/</link>
      <pubDate>Sat, 16 May 2015 11:39:29 +0900</pubDate>
      
      <guid>/blog/2015/05/16/install_freebsd10.1_on_sakura_vps/</guid>
      <description>

&lt;h2 id=&#34;はじめに:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;はじめに&lt;/h2&gt;

&lt;p&gt;さくらのVPSにFreeBSD 10.1をクリーンインストールしてみましたので、手順をメモしておきます。作業した環境は MacBook Pro (USキーボード) です。
インストール後以下の設定を行います。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ファイルシステムはZFSを選択&lt;/li&gt;
&lt;li&gt;sshの鍵認証の設定&lt;/li&gt;
&lt;li&gt;sudoのインストールと設定&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;なお、インストールには下記のページを参考にしました。ありがとうございます！&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.emaita.jp/2015/03/06/freebsd10_1.html&#34;&gt;FreeBSD 10.1 導入 — emaita 備忘録&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.livedoor.jp/saba_nano/archives/28363307.html&#34;&gt;[FreeBSD] さくらのVPSに FreeBSD 9.1 amd64 をインストールする方法 (1) : saba nano - へっぽこ管理者のサーバ管理日誌（LV.2）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;インストール準備:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;インストール準備&lt;/h2&gt;

&lt;h3 id=&#34;isoイメージをミラーから取得してvpsにsftpでアップロード:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ISOイメージをミラーから取得してVPSにsftpでアップロード&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;http://www.jp.freebsd.org/mirror.html&#34;&gt;FreeBSD-related Sites in Japan&lt;/a&gt;を見てftp3.jp.FreeBSD.org (ftp.sakura.ad.jp)からダウンロードすることにしました。&lt;/p&gt;

&lt;p&gt;ブラウザで
&lt;a href=&#34;ftp://ftp3.jp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.1/&#34;&gt;ftp://ftp3.jp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.1/&lt;/a&gt;
を開き
&lt;a href=&#34;ftp://ftp3.jp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.1/FreeBSD-10.1-RELEASE-amd64-bootonly.iso&#34;&gt;ftp://ftp3.jp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.1/FreeBSD-10.1-RELEASE-amd64-bootonly.iso&lt;/a&gt;
をダウンロードします。&lt;/p&gt;

&lt;p&gt;これを&lt;a href=&#34;https://help.sakura.ad.jp/app/answers/detail/a_id/2405&#34;&gt;ISOイメージインストール｜さくらインターネット公式サポートサイト&lt;/a&gt;の手順を参考にアップロードします。&lt;/p&gt;

&lt;p&gt;OS Xにはsftpコマンドが標準で入っているのでそれを使います。接続情報は、さくらのVPSのコントロールパネルで確認します。
ここでは、ユーザ名をvpsXXXXXXXXXXXX, ホスト名をvps-isoY.sakura.ad.jpとして説明します。&lt;/p&gt;

&lt;p&gt;isoファイルのあるディレクトリでsftpを実行し、以下の手順で上記のisoファイルをアップロードします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sftp vpsXXXXXXXXXXXX@vps-isoY.sakura.ad.jp
vpsXXXXXXXXXXXX@vps-isoY.sakura.ad.jp&#39;s password: (パスワードを入力)
sftp&amp;gt; cd iso
sftp&amp;gt; put FreeBSD-10.1-RELEASE-amd64-bootonly.iso
sftp&amp;gt; quit
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;アップロードが完了したらsftpコマンドは終了します。さくらのVPSのコントロールパネルの「ISOイメージインストール」のポップアップの「ISOイメージ情報」に今アップロードしたisoファイルが表示されたことを確認し、「マウント設定」の「設定内容を確認する」ボタンを押し、「インストールを実行する」ボタンを押します。&lt;/p&gt;

&lt;h2 id=&#34;インストール:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;インストール&lt;/h2&gt;

&lt;p&gt;「VNCコンソール(HTML5版)を起動」ボタンを押してコンソールで作業します。&lt;/p&gt;

&lt;h3 id=&#34;キーマップの確認:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;キーマップの確認&lt;/h3&gt;

&lt;p&gt;HTML5版のVNCコンソールは、どうも日本語キーボードを想定しているようで、USキーボードだと以下のように一部の記号の配置が異なっています。
なお、キーマップはデフォルト(US配列)を選択しています。&lt;/p&gt;

&lt;p&gt;押したキーを左、入力された文字を右に示します。&lt;/p&gt;

&lt;table border=&#34;1&#34;&gt;
&lt;tr&gt;&lt;th style=&#34;padding:4px&#34;&gt;押したキー&lt;/th&gt;&lt;th style=&#34;padding:4px&#34;&gt;入力された文字&lt;/th&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;`&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;[&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;~ (Shift+`)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;+&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;@ (Shift+2)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;{&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;^ (Shift+6)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;+&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;&amp; (Shift+7)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;^&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;* (Shift+8)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;&#34;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;( (Shift+9)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;*&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;) (Shift+0)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;(&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;_ (Shift+-)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;何も入力されない&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;=&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;-&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;+ (Shift+=)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;:&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;[&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;]&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;{ (Shift+[)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;}&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;]&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;\&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;} (Shift+})&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;|&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;\&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;何も入力されない&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;| (Shift+\)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;何も入力されない&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;: (Shift+;)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;&#34;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;&#39;&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;7&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;&#34; (Shift+&#39;)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;@&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;

&lt;h3 id=&#34;ホスト名設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ホスト名設定&lt;/h3&gt;

&lt;p&gt;&amp;ldquo;Please choose a hostname for this machine.&amp;ldquo;の画面ではVPSのコンソールの標準ホスト名を入力します。&lt;/p&gt;

&lt;h3 id=&#34;インストールするコンポーネントの選択:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;インストールするコンポーネントの選択&lt;/h3&gt;

&lt;p&gt;初期選択状態は以下のようになっていました。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;[ ] doc: Additional documentation&lt;/li&gt;
&lt;li&gt;[*] games: Games (fortune, etc.)&lt;/li&gt;
&lt;li&gt;[*] lib32: 32-bit compatiblity libraries&lt;/li&gt;
&lt;li&gt;[*] ports: Ports tree&lt;/li&gt;
&lt;li&gt;[ ] src: System source code&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;gamesとlib32を外して、docとsrcを追加しました。&lt;/p&gt;

&lt;h3 id=&#34;ネットワーク設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ネットワーク設定&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;「Network Configuration」では「vtnet0」を選び「OK」を押します。&lt;/li&gt;
&lt;li&gt;&amp;ldquo;Would you like to configure IPv4 for this interface&amp;rdquo; → [Yes]を押す&lt;/li&gt;
&lt;li&gt;&amp;ldquo;Would you like to use DHCP to configure this interface?&amp;rdquo; → [No]を押す&lt;/li&gt;
&lt;li&gt;「Static Netowrk Interface Configuration」の画面でIP Address, Subnet Mask, Default Routerを入力します。VPSのコントロールパネルのIPv4のアドレス、ネットマスク、ゲートウェイの値をそれぞれ入力します。&lt;/li&gt;
&lt;li&gt;&amp;ldquo;Would you like to configure IPv6 for this interface?&amp;rdquo; → NoYes]を押す&lt;/li&gt;
&lt;li&gt;「Resolver Configuration」の画面でSearch, IPv4 DNS #1, IPv4 DNS #2を入力します。順にVPSコントロールパネルの標準ホスト名のドメイン部分(私の場合はvs.sakura.ne.jp)、IPv4のプライマリDNS、セカンダリDNSを入力します。&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;ボツ-ipv6を有効にすると失敗しました:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;(ボツ) IPv6を有効にすると失敗しました&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&amp;ldquo;Would you like to configure IPv6 for this interface?&amp;rdquo; → [Yes]を押す&lt;/li&gt;
&lt;li&gt;&amp;ldquo;Would you like to try stateless address autoconfiguration (SLAAC)?&amp;rdquo; → [No]を押す&lt;/li&gt;
&lt;li&gt;「Static IPv6 Network Interface Configuration」の画面でIPv6 AddressとDefault RouterにVPSのコントロールパネルのIPv6のアドレスとゲートウェイを入力します。上記のキーマップの確認に書いたように:を入力するにはUSキーボードではShift+=を押してください。&lt;/li&gt;
&lt;li&gt;「Resolver Configuration」の画面でSearch, IPv6 DNS #1, IPv6 DNS #2, IPv4 DNS #1, IPv4 DNS #2を入力します。順にVPSコントロールパネルの標準ホスト名のドメイン部分(私の場合はvs.sakura.ne.jp)、IPv6のDNS、空欄、IPv4のプライマリDNS、セカンダリDNSを入力します。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ダウンロードは無事に進んだようなのですが、その後以下のエラーが出ました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Abort
Distribution extract failed

An installation step has been aborted. Would you
like to restart the installation or exit
the installer?
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;ミラーサイト選択:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ミラーサイト選択&lt;/h3&gt;

&lt;p&gt;「Mirror Selection」の画面では「&lt;a href=&#34;ftp://ftp3.jp.freebsd.org&#34;&gt;ftp://ftp3.jp.freebsd.org&lt;/a&gt; Japan #3」を選択します。&lt;/p&gt;

&lt;h3 id=&#34;パーティション作成:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;パーティション作成&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Auto (UFS): Guided Disk Setup&lt;/li&gt;
&lt;li&gt;Manual: Manual Disk Setup (experts)&lt;/li&gt;
&lt;li&gt;Shell: Open a shell and partition by hand&lt;/li&gt;
&lt;li&gt;Auto (ZFS): Guided Root-on-ZFS&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;今回は「Auto (ZFS)」にしました。
「ZFS Configuration」ではそのまま「&amp;gt;&amp;gt;&amp;gt; Install     Proceed with Installation」を選びます。&lt;/p&gt;

&lt;h3 id=&#34;zfsの仮想デバイスタイプ:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ZFSの仮想デバイスタイプ&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;stripe: Stripe - No Redundancy&lt;/li&gt;
&lt;li&gt;mirror: Mirror - n-Way Mirroring&lt;/li&gt;
&lt;li&gt;raidz1: RAID-Z1 - Single Redundant RAID&lt;/li&gt;
&lt;li&gt;raidz2: RAID-Z2 - Single Redundant RAID&lt;/li&gt;
&lt;li&gt;raidz3: RAID-Z3 - Single Redundant RAID&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;「stripe」を選びました。&lt;/p&gt;

&lt;h3 id=&#34;ブロックデバイス選択:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ブロックデバイス選択&lt;/h3&gt;

&lt;p&gt;「vtbd0 VirtIO Block Device」をスペースキーを押して選択します。&lt;/p&gt;

&lt;p&gt;&amp;ldquo;Last Chance! Are you sure you want to destroy the current contents of the following disks: vtbd0&amp;rdquo; では[YES]を選びます。&lt;/p&gt;

&lt;h3 id=&#34;rootユーザのパスワード設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;rootユーザのパスワード設定&lt;/h3&gt;

&lt;p&gt;以下のようにrootユーザのパスワードを設定します。なぜかreturnキーが効かないようなのでCtrl-Jで代用しました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Please select a password for the system management account (root):
Changing local password for root
New Password: (パスワードを入力してCtrl-Jを押す)
Retype New Password: (パスワードを入力してCtrl-Jを押す)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;表示も変で、Ctrl-Jを押した時に行が次の行に進みますが、行頭には戻らず続きのカラムから表示されていました。&lt;/p&gt;

&lt;h3 id=&#34;タイムゾーン設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;タイムゾーン設定&lt;/h3&gt;

&lt;p&gt;&amp;ldquo;Is this machine&amp;rsquo;s CMOS clock set to UTC?  If it is set to local time, or you don&amp;rsquo;t know, please choose NO here!&amp;rdquo; ではハードウェアの設定はわからないので「No」を選びます。&lt;/p&gt;

&lt;p&gt;「Select a region」では「5 Asia」を選び、「Select a country or region」では「18 Japan」を選びます。
&amp;ldquo;Does the abbreviation `JST&amp;rsquo; look reasonable?&amp;ldquo;に「Yes」を選びます。&lt;/p&gt;

&lt;h3 id=&#34;自動起動するサービス選択:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;自動起動するサービス選択&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;Choose the services you would like to be started at boot:
  [ ] local_unbound  Local caching validating resolver
  [*] sshd           Secure shell daemon
  [ ] moused         PS/2 mouse pointer on console
  [ ] ntpd           Synchronize system and network time
  [ ] powerd         Adjust CPU frequency dynamically if supported
  [*] dumpev         Enable kernel crash dumps to /var/crash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ntpdを追加選択します。&lt;/p&gt;

&lt;h3 id=&#34;ユーザ追加:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ユーザ追加&lt;/h3&gt;

&lt;p&gt;sshでログインする管理用のユーザとして「admin」という名前のユーザを追加することにします。あとでsudoersに追加するのでadminユーザのセカンダリグループにwheelを追加します。&lt;/p&gt;

&lt;p&gt;&amp;ldquo;Would you like to add users to the installed systems now?&amp;ldquo;に「Yes」を選びます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Add Users
Username: admin
Full name: admin
Uid (Leave empty for default): (Ctrl-Jを押す)
Login group [admin]: (Ctrl-Jを押す)
Login group is admin. Invite admin into other groups? []: (wheelと入力してCtrl-Jを押す)
Login class [default]: (Ctrl-Jを押す)
Shell (ch csh tcsh nologin) [sh]: (Ctrl-Jを押す)
Home directory [/home/admin]: (Ctrl-Jを押す)
Home directory permissions (Leave empty for default): (Ctrl-Jを押す)
Use password-based authentication? [yes]: (Ctrl-Jを押す)
Use an empty password? (yes/no) [no]: (Ctrl-Jを押す)
Use a random password? (yes/no) [no]: (Ctrl-Jを押す)
Enter password: (パスワードを入力してCtrl-Jを押す)
Enter password again: (パスワードを入力してCtrl-Jを押す)
Lock out the accout after creation? [no]: (Ctrl-Jを押す)
OK? (yes/no): (yesと入力してCtrl-Jを押す)
adduser: INFO Successfully added (admin) to the user database.
Add another user? (yes/no): (noと入力してCtrl-Jを押す)
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;インストールの終了:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;インストールの終了&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;Setup of you FreeBSD system is nearly complete.  You can now
modify your configuration choices. After this screen, you will
have an opportunity to make more complex changes using a shell.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記の画面では「Exit」を選択して「OK」を押します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;The installation is now finished.
Before exiting the installer, yould
you like to open a shell in the new
system to make any final manual
modifications?
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記の画面では「No」を選択します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Installation of FreeBSD
complete! Would you like
to reboot into the
installed system now?
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記の画面では「Reboot」を押しても、またインストーラの画面が起動してしまいます。
そこで、さくらのVPSのコンソールで「OSインストール」→「ISOイメージインストール」を選び、「ISOイメージアップロード情報」の「アカウントの削除」ボタンを押します。
「アカウントを削除してよろしいですか？アップロードしたファイルも削除されます。」と表示されたら「削除する」ボタンを押します。&lt;/p&gt;

&lt;p&gt;その後「ISOイメージインストール」のポップアップで「キャンセル」を押してVPSのコンソールに戻りツールバーの「強制停止」ボタンを押して停止した後「起動」ボタンを押して起動します。&lt;/p&gt;

&lt;h2 id=&#34;インストール後の設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;インストール後の設定&lt;/h2&gt;

&lt;h3 id=&#34;adminユーザの公開鍵の設置:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;adminユーザの公開鍵の設置&lt;/h3&gt;

&lt;p&gt;ここでは、OS X側で秘密鍵・公開鍵を作成済みとし、秘密鍵は ~/.ssh/id_rsa、公開鍵は ~/.ssh/id_rsa.pub とします。&lt;/p&gt;

&lt;p&gt;OSX上で以下の操作を行い、公開鍵をサーバに転送します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;scp ~/.ssh/id_rsa.pub admin@サーバのIPアドレス:
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;adminユーザのパスワードを聞かれるので入力します。&lt;/p&gt;

&lt;p&gt;その後sshでサーバにログインします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh admin@サーバのIPアドレス
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;パスワードを入力すると以下のようなメッセージが表示されます。アドレスのXXX.XXX.XXX.XXXとRSA鍵のフィンガープリントはここでは伏せていますが実際は異なる値になります。「yes」と入力してログインしてください。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;The authenticity of host &#39;XXX.XXX.XXX.XXX (XXX.XXX.XXX.XXX)&#39; can&#39;t be established.
RSA key fingerprint is yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy.
Are you sure you want to continue connecting (yes/no)?
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;パスワードを入力してサーバにログインしたらサーバ上で以下のコマンドを実行し、カギ認証でログインできるようにします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir ~/.ssh
chmod 700 ~/.ssh
mv id_rsa.pub ~/.ssh/authorized_keys
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;今度はOS X側で ~/.ssh/configというファイルが無い場合は新規作成した上で、以下の内容を追加します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Host 接続に使用するお好みのホスト名エイリアス
  Hostname サーバのIPアドレス
  User admin
  PasswordAuthentication no
  IdentityFile ~/.ssh/id_rsa
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;IdentityFileの行は ~/.ssh/id_rsa はデフォルト値なので、この場合はこの行自体不要です。別のファイル名にしていた場合は設定が必要です。&lt;/p&gt;

&lt;p&gt;この設定を加えた状態で、OS Xから以下のようにコマンドを実行しパスワードを聞かれずにログインできれば成功です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh ホスト名エイリアス
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;sshパスワード認証の無効化:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;sshパスワード認証の無効化&lt;/h3&gt;

&lt;p&gt;鍵認証でssh接続できるようになったら、悪意を持った第三者の攻撃でパスワードを当ててログインされてしまうのを防ぐため、パスワードでのログインを無効にします。&lt;/p&gt;

&lt;p&gt;サーバ上で以下の手順を実行します。まず以下のコマンドを実行してrootユーザになります。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;su -
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;rootユーザのパスワードを聞かれますので入力します(1行が長いのでブラウザでコピペする際は右の方までスクロールしてください)。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sed -i .orig -e &#39;s/^#\(PasswordAuthentication no\)/\1/;s/^#\(UsePAM\) yes/\1 no/;s/^#\(X11Forwarding\) yes/\1 no/&#39; /etc/ssh/sshd_config
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;less /etc/ssh/sshd_config
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で設定内容を確認します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;…(略)…
PasswordAuthentication no
…(略)…
UsePAM no
…(略)…
X11Forwarding no
…(略)…
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;となっていればOKですのでqを押してlessを終了します。&lt;/p&gt;

&lt;p&gt;以下のコマンドを実行してsshdを再起動します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/etc/rc.d/sshd restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;次に実際にパスワード認証が無効化されたことを確認します。&lt;/p&gt;

&lt;p&gt;一旦このrootユーザの接続は残しておいて、OS X上で別のターミナルを開き、~/.ssh/configを以下のように編集します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Host 接続に使用するお好みのホスト名エイリアス
  Hostname サーバのIPアドレス
  User admin
  PasswordAuthentication yes
  PubkeyAuthentication no
  #PasswordAuthentication no
  #IdentityFile ~/.ssh/id_rsa
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;この状態で&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh ホスト名エイリアス
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のようにコマンドを実行した時にパスワードを聞かれることなく以下のように表示されれば、パスワード認証は正しく無効化できています。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Permission denied (publickey,keyboard-interactive).
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記の確認ができたらOS Xの~/.ssh/configは元の内容に戻しておいてください。&lt;/p&gt;

&lt;h3 id=&#34;セキュリティパッチの適用:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;セキュリティパッチの適用&lt;/h3&gt;

&lt;p&gt;先ほどのrootで接続していたターミナルに戻ってセキュリティパッチを適用します。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.freebsd.org/doc/ja_JP.eucJP/books/handbook/updating-upgrading-freebsdupdate.html&#34;&gt;18.2. FreeBSD Update&lt;/a&gt;の「セキュリティパッチの適用」の項を参考にします。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=198030&#34;&gt;Bug 198030 – /usr/src/crypto/openssl/util/mkbuildinf.pl: No such file or directory on freebsd-update install&lt;/a&gt;のバグを回避するため
&lt;a href=&#34;https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=198030#c7&#34;&gt;Comment 7&lt;/a&gt;の手順を実行してから、パッチを適用します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# freebsd-update fetch
# mkdir -p /usr/src/crypto/openssl/util
# freebsd-update install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;freebsd-update patch&lt;/code&gt; を実行すると、アップデートを取得後moreコマンドが起動して更新されたファイル一覧を確認できます。スペースキーを押してページを進め、確認したらqを押して終了します。&lt;/p&gt;

&lt;h3 id=&#34;sudoのインストールと設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;sudoのインストールと設定&lt;/h3&gt;

&lt;p&gt;rootユーザで以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;pkg install -y sudo
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;すると以下のようにpkgコマンド自体をインストールするか聞かれますので、yと入力します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;The package management tool is not yet installed on your system.
Do you want to fetch and install it now? [y/N]:
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;pkgとsudoのインストールが終わったら、以下のコマンドを実行してsudoの設定を変更します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;visudo
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ここではwheelグループにsudoを許可します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# %wheel ALL=(ALL) ALL
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;の行を&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;%wheel ALL=(ALL) ALL
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のように変更して:wqで保存して終了します。&lt;/p&gt;

&lt;p&gt;sudoの設定を確認するため、rootのターミナルは一旦置いておいて、OS Xからsshでadminユーザでログインし、以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo -i
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以下のようにメッセージが表示されますので、adminユーザのパスワードを入力します。
rootユーザのプロンプトが出れば成功です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo -i

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

Password:
root@ホスト名からドメインを除いたもの:~ #
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;確認できたら、このターミナルでCtrl-Dを押してadminユーザに戻り、さらにCtrl-Dを押してログアウトします。
先程残しておいたrootユーザのターミナルも同様にしてログアウトします。&lt;/p&gt;

&lt;h2 id=&#34;おわりに:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;おわりに&lt;/h2&gt;

&lt;p&gt;いくつかハマりどころがありましたが、さくらのVPSにFreeBSD 10.1をクリーンインストールできました。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>