<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Ddns on hnakamur&#39;s blog at github</title>
    <link>/blog/tags/ddns/</link>
    <description>Recent content in Ddns on hnakamur&#39;s blog at github</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-JP</language>
    <lastBuildDate>Mon, 02 May 2016 09:39:31 +0900</lastBuildDate>
    <atom:link href="/blog/tags/ddns/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Ubuntu 16.04でNo-IPのダイナミックDNSサービスを使ってみた</title>
      <link>/blog/2016/05/02/use-no-ip-dynamic-dns-on-ubuntu-16.04/</link>
      <pubDate>Mon, 02 May 2016 09:39:31 +0900</pubDate>
      
      <guid>/blog/2016/05/02/use-no-ip-dynamic-dns-on-ubuntu-16.04/</guid>
      <description>

&lt;h2 id=&#34;背景:135c9c6bc59340025271c600f28573f2&#34;&gt;背景&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;/blog/blog/2016/05/01/install_ubuntu_xenial_with_pxe_boot/&#34;&gt;MacをPXEサーバにしてExpress5800/S70タイプRBにUbuntu16.04をインストールしてみた · hnakamur&amp;rsquo;s blog at github&lt;/a&gt;で自宅サーバを起動したのですが、固定グローバルIPアドレスは持っていないので、ダイナミックDNS (DDNS) サービスを使うことにしました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://viral-community.com/other-it/ddns-praise-service-2065/&#34;&gt;DDNSの無料サービスでオススメな３つの「ieServer」「mydns」「No-IP」の特徴と利用手順をまとめてみた&lt;/a&gt;を参考に「No-IP」を使ってみました。&lt;/p&gt;

&lt;h2 id=&#34;アカウント登録:135c9c6bc59340025271c600f28573f2&#34;&gt;アカウント登録&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://www.noip.com/&#34;&gt;https://www.noip.com/&lt;/a&gt; でメールアドレス、ユーザ名、パスワードを入力してサインアップし、確認のHTMLメールが届いたら[Activate Account]ボタンをクリックすればOKです。&lt;/p&gt;

&lt;h2 id=&#34;ホストの登録:135c9c6bc59340025271c600f28573f2&#34;&gt;ホストの登録&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://www.noip.com/&#34;&gt;https://www.noip.com/&lt;/a&gt; の右上の[Sign In]を押し、ユーザ名かメールアドレスとパスワードを入力してサインインします。サインイン後は &lt;a href=&#34;https://my.noip.com/&#34;&gt;https://my.noip.com/&lt;/a&gt; に遷移します。&lt;/p&gt;

&lt;p&gt;ホストの登録は新サイトの画面左の[Dashboard]を選んで、画面中央の[Quick Add]で[Hostname]を希望のホスト名を入力、[Doman]で使いたいドメインを選択して[Add Hostname]ボタンを押せばOKです。&lt;/p&gt;

&lt;p&gt;あるいは画面左の[Dynamic DNS]の[Hostnames]メニューを選び、[Add Hostname]ボタンを押す方法でもOKです。この場合は[Add Hostname]というタイトルのポップアップが開きます。&lt;/p&gt;

&lt;p&gt;[Hostname]に希望のホスト名を入力し、[Domain]は使いたいドメインを選びます。
[Record Type]はAのままでOKで、[IPv4 Address]にも自動で現在のグローバルIPアドレスが入力されているのでそのままでOKです。[Add Hostname]ボタンを押すと追加完了です。&lt;/p&gt;

&lt;p&gt;なお、試していませんが、[Record Type]の[More Records]ボタンを押すと、以下の4つのラジオボタンが表示されました。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;DNS Host (A)&lt;/li&gt;
&lt;li&gt;DNS Alias (CNAME)&lt;/li&gt;
&lt;li&gt;Web Redirect&lt;/li&gt;
&lt;li&gt;AAAA (IPv6)&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;また、その下には &amp;ldquo;Manage your Round Robin, TXT, SRV and DKIM records.&amp;rdquo; という文が書かれており、 &amp;ldquo;Manage&amp;rdquo; の部分がリンクになっていました。これを押すと &lt;a href=&#34;https://www.noip.com/members/dns/&#34;&gt;https://www.noip.com/members/dns/&lt;/a&gt; のManage Hostsページに遷移しました。 no-ip は管理画面をリニューアル中で、こちらは旧画面のようです。 &lt;a href=&#34;https://my.noip.com/#!/&#34;&gt;https://my.noip.com/#!/&lt;/a&gt; の画面上部にある [Use Old Site] というリンクでも旧サイトのManage Hostsページが開きました。&lt;/p&gt;

&lt;p&gt;新サイトの[Dynamic DNS]の[Hostnames]メニューで画面右に &amp;ldquo;Free Hostnames expire every 30 days. Enhanced Hostnames never expire. Upgrade to Enhanced&amp;rdquo; と書いてあるのですが、 &lt;a href=&#34;http://www.noip.com/support/faq/frequently-asked-questions/why-did-my-free-hostname-expire-or-get-deleted/&#34;&gt;Why did my free hostname expire or get deleted? | Support | No-IP&lt;/a&gt; の説明によれば無料サービスでも30日毎に更新していれば消えないようです。&lt;/p&gt;

&lt;h2 id=&#34;ipアドレス自動更新用のクライアントnoip2をセットアップ:135c9c6bc59340025271c600f28573f2&#34;&gt;IPアドレス自動更新用のクライアントnoip2をセットアップ&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://www.noip.com/&#34;&gt;http://www.noip.com/&lt;/a&gt; の画面上部の [Download] リンクをクリックすると、アクセスしているブラウザからOSを自動判定して、そのOS用のクライアントのダウンロードページが開きます。私の場合は Dynamic DNS Update Client (DUC) for Mac のページが開きました。&lt;/p&gt;

&lt;p&gt;下の方にスクロールして [Other Downloads] の [Linux] をクリックして &lt;a href=&#34;https://www.noip.com/download?page=linux&#34;&gt;Dynamic DNS Update Client (DUC) for Linux - No-IP&lt;/a&gt; を開きます。&lt;/p&gt;

&lt;p&gt;Installation のセクションに &amp;ldquo;UBUNTU USERS: You may install this with the apt-get command, see this guide&amp;rdquo; という文があり guide のリンクをクリックすると &lt;a href=&#34;http://www.noip.com/support/knowledgebase/installing-the-linux-dynamic-update-client-on-ubuntu/&#34;&gt;How to Install the Linux Dynamic Update Client on Ubuntu&lt;/a&gt; に遷移しました。このページの手順に従ってセットアップすればOKでした。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo -s
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でパスワードを入力してrootになって以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd /usr/local/src
wget http://www.no-ip.com/client/linux/noip-duc-linux.tar.gz
tar xf noip-duc-linux.tar.gz
cd noip-2.1.9-1/
make install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;noip-2.1.9-1 のディレクトリ内を見るとソースファイルは noip2.c の1つでした。中を見てみるとライセンスはGPLv2 or laterです。ざっと見た感じでは不正な通信はしてなさそうでした。&lt;/p&gt;

&lt;p&gt;インストール後以下のコマンドを実行して設定ファイルを作成します。以下のコマンドは全てrootで実行しています。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/usr/local/bin/noip2 -C
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;プロンプトが表示されたらNo-IPのユーザ名、パスワードと登録したホスト名を入力します。すると /usr/local/etc/no-ip2.conf に設定ファイルが作られます。viで中を見てみると一部テキスト、一部バイナリのファイルでした。&lt;/p&gt;

&lt;p&gt;あとは &lt;code&gt;/usr/local/bin/noip2&lt;/code&gt; でデーモンが起動するのですが、systemdのサービスとして登録したいので、unitファイルを作りました。&lt;/p&gt;

&lt;p&gt;ソースのディレクトリにdebian, gentoo, redhat用のinit.d用のスクリプトとmac用の自動起動スクリプトがありました。 &lt;code&gt;redhat.noip.sh&lt;/code&gt; を見ると、起動は &lt;code&gt;/usr/local/bin/noip2&lt;/code&gt; で、終了は &lt;code&gt;killproc noip2 -TERM&lt;/code&gt; で行っていました。&lt;/p&gt;

&lt;p&gt;Ubuntuで試したら &lt;code&gt;killproc&lt;/code&gt; は無かったので &lt;code&gt;killall&lt;/code&gt; で代用しました。&lt;/p&gt;

&lt;p&gt;以下のコマンドでunitファイルを作成します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;&#39;EOF&#39; &amp;gt; /etc/systemd/system/noip2.service
[Unit]
Description=No-IP.com DDNS client
After=network.target auditd.service

[Service]
ExecStart=/usr/local/bin/noip2
ExecStop=/usr/bin/killall -TERM /usr/local/bin/noip2
Restart=on-failure
Type=forking

[Install]
WantedBy=multi-user.target
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;作成したファイルをsystemdに読み込ませます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;systemctl daemon-reload
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以下のコマンドでサービスの起動とOS起動時の自動起動設定を行います。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;systemctl start noip2
systemctl enable noip2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ちなみに、 &lt;code&gt;mac.osx.startup&lt;/code&gt; では &lt;code&gt;noip2 -S&lt;/code&gt; の出力からpidを取得して &lt;code&gt;noip -K $pid&lt;/code&gt; で停止していました。こんな感じです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;    for i in `noip2 -S 2&amp;gt;&amp;amp;1 | grep Process | awk &#39;{print $2}&#39; | tr -d &#39;,&#39;`
      do
        noip2 -K $i
      done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;journalctlでログを見てみると以下のようなログが出ていました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo journalctl | grep noip2
 5月 02 10:54:07 express noip2[1082]: v2.1.9 daemon started with NAT enabled
 5月 02 10:54:07 express noip2[1082]: xxxx.ddns.net was already set to xx.xx.xx.xx.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;実際はxxxx.ddns.net はNo-IPで登録したホスト名と選択したドメインでxx.xx.xx.xxは自宅サーバのグローバルIPアドレスが出力されていましたが、セキュリティ上伏せています。&lt;/p&gt;

&lt;h2 id=&#34;ポートフォワーディング設定:135c9c6bc59340025271c600f28573f2&#34;&gt;ポートフォワーディング設定&lt;/h2&gt;

&lt;h3 id=&#34;ubuntuサーバを固定ipに設定:135c9c6bc59340025271c600f28573f2&#34;&gt;Ubuntuサーバを固定IPに設定&lt;/h3&gt;

&lt;p&gt;変更前の &lt;code&gt;/etc/network/interfaces&lt;/code&gt; は以下のようになっていました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto enp0s25
iface enp0s25 inet dhcp
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;enp0s25&lt;/code&gt; の設定を &lt;a href=&#34;https://help.ubuntu.com/lts/serverguide/network-configuration.html#static-ip-addressing&#34;&gt;Static IP Address Assignment&lt;/a&gt; を参考に固定IPにしました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto enp0s25
iface enp0s25 inet static
    address 192.168.0.201
    netmask 255.255.255.0
    gateway 192.168.0.1
    dns-nameservers 192.168.0.1
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;systemctl restart networking
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で反映しました。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;ip a&lt;/code&gt; で確認すると、変更前にDHCPで発行されたIPアドレス &lt;code&gt;192.168.0.9&lt;/code&gt; と上記で設定した固定アドレス &lt;code&gt;192.168.0.201&lt;/code&gt; の両方が表示されました。&lt;/p&gt;

&lt;p&gt;sshで作業していたのですが、以下のコマンドで消そうとしたらハマりました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;root@express:/etc/network# ip a del 192.168.0.9 dev enp0s25
Warning: Executing wildcard deletion to stay compatible with old scripts.
         Explicitly specify the prefix length (192.168.0.9/32) to avoid this warning.
         This special behaviour is likely to disappear in further releases,
         fix your scripts!
packet_write_wait: Connection to 192.168.0.9: Broken pipe
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;コンソールからログインして &lt;code&gt;ip a&lt;/code&gt; で確認すると &lt;code&gt;enp0s25&lt;/code&gt; の &lt;code&gt;inet&lt;/code&gt; の行は両方共消えていました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo systemctl restart networking
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でネットワークを再起動して &lt;code&gt;ip a&lt;/code&gt; を実行すると &lt;code&gt;inet&lt;/code&gt; の行は固定IPの1行になりました。&lt;/p&gt;

&lt;p&gt;上で表示されたWarningによると、正しくは以下のようにするべきだったようです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ip a del 192.168.0.9/32 dev enp0s25
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;airmacユーティリティでポートフォワーディング設定:135c9c6bc59340025271c600f28573f2&#34;&gt;AirMacユーティリティでポートフォワーディング設定&lt;/h3&gt;

&lt;p&gt;Finderで「アプリケーション/ユーティリティ/AirMac ユーティリティ」を起動し、
Time Capsuleをクリックして開くポップアップの「編集」ボタンを押します。&lt;/p&gt;

&lt;p&gt;「ネットワーク」タブで「ルーターモード」を「DHCPとNAX」にしておきます。
先程固定IPを &lt;code&gt;192.168.0.201&lt;/code&gt; にしたのは「DHCPの範囲」が &lt;code&gt;192.168.0.2〜192.168.0.200&lt;/code&gt; なので範囲外の値を選んだからです。なお、この範囲は「ネットワークオプション…」ボタンを押して変更可能です。&lt;/p&gt;

&lt;p&gt;ポート設定の下の「+」ボタンを押すとポップアップが開くのでポートフォワーディングの設定を追加します。
ファイアウォール・エントリー・タイプは「IPv4ポートマッピング」固定で、ドロップダウンが disabled の状態になっていました。&lt;/p&gt;

&lt;p&gt;プライベートIPアドレスは上記で設定したExpress5800の固定IPを入力します。&lt;/p&gt;

&lt;p&gt;パブリックUDPポート、パブリックTCPポート、プライベートUDPポート、プライベートTCPポートにはフォワーデング元と先のポートを転送したい内容に応じて設定します。今回はTCPでsshのポートを指定しました。
なお、この記事では書いてないですが、パスワードアタック攻撃を回避するため事前にsshdは鍵認証のみ許可しパスワード認証は許可しない設定に変更しています。&lt;/p&gt;

&lt;p&gt;ちなみに&lt;a href=&#34;https://support.apple.com/kb/TA24799?locale=ja_JP&amp;amp;viewlocale=ja_JP&#34;&gt;ポートの範囲を指定して転送できるように AirMac Extreme (802.11n) ベースステーションを設定する&lt;/a&gt;によるとポートの入力欄は空白を開けずに &lt;code&gt;XXX-YYY&lt;/code&gt; のように書けば範囲も指定できるそうです。&lt;/p&gt;

&lt;p&gt;設定を追加したら「保存」ボタンを押してポップアップを閉じ、「アップデート」ボタンで反映します。&lt;/p&gt;

&lt;h2 id=&#34;おわりに:135c9c6bc59340025271c600f28573f2&#34;&gt;おわりに&lt;/h2&gt;

&lt;p&gt;これでインターネットから自宅サーバにsshでログイン出来るようになって便利になりました。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>