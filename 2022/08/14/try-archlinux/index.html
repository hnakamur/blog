<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.101.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Arch Linux を試してみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2022. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Arch Linux を試してみた</h1>
  <time datetime=2022-08-14T02:03:26&#43;0900 class="post-date">2022-08-14</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#インストールメディアは-rufs-で-usb-メモリに作成">インストールメディアは rufs で USB メモリに作成</a></li>
    <li><a href="#usb-メモリからブートして-ssd-にインストール">USB メモリからブートして SSD にインストール</a>
      <ul>
        <li><a href="#ntp-を有効にします">NTP を有効にします</a></li>
        <li><a href="#パーティション作成">パーティション作成</a></li>
        <li><a href="#パッケージをインストール">パッケージをインストール</a></li>
        <li><a href="#chroot-してさらにセットアップを実行">chroot してさらにセットアップを実行</a></li>
        <li><a href="#ネットワーク設定">ネットワーク設定</a></li>
        <li><a href="#chroot-を抜けて再起動">chroot を抜けて再起動</a></li>
      </ul>
    </li>
    <li><a href="#インストールしたディスクから起動後さらにセットアップを進める">インストールしたディスクから起動後、さらにセットアップを進める</a>
      <ul>
        <li><a href="#ネットワークの動作確認と設定">ネットワークの動作確認と設定</a></li>
        <li><a href="#一般ユーザの作成と-sudo-の設定">一般ユーザの作成と sudo の設定</a></li>
        <li><a href="#tmux-をインストール">tmux をインストール</a></li>
        <li><a href="#sshd-のインストールと起動">sshd のインストールと起動</a></li>
        <li><a href="#keepassxc-cli-も試してみた">keepassxc-cli も試してみた</a></li>
        <li><a href="#yay-のインストール">yay のインストール</a></li>
        <li><a href="#linux-カーネル-519-を入れてみる">Linux カーネル 5.19 を入れてみる</a></li>
      </ul>
    </li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p>Ubuntu を入れていた 2台の ThinkCentre のうち1台に mainline のカーネルを入れてみたら、再起動後 zfs のモジュールが読み込めくてハマったので、この機会に前から気になってた Arch Linux を試してみました。</p>
<p><a href="https://ja.wikipedia.org/wiki/Arch_Linux">Arch Linux - Wikipedia</a> を見たら GUI インストーラーでお手軽そうと思っていた Antergos はプロジェクト終了とのことでした。</p>
<p>検索すると <a href="http://neko-mac.blogspot.com/2021/05/arch-linux.html">Arch Linux をおしゃれに最速インストール - おしゃれな気分でプログラミング</a> という良い記事が見つかったのでこちらを参考にインストールしました。</p>
<h2 id="インストールメディアは-rufs-で-usb-メモリに作成">インストールメディアは rufs で USB メモリに作成</h2>
<p>Linux で dd も試したのですが、うまく起動しませんでした。</p>
<p>rufs では Syslinux をダウンロードしてインストールするか聞かれたのでそうしました(<a href="https://pc-freedom.net/software/how-to-use-rufus/">RufusでLinuxのインストールメディアを作る。 | PC-FREEDOM</a> の「Syslinuxとは」の項参照)。</p>
<h2 id="usb-メモリからブートして-ssd-にインストール">USB メモリからブートして SSD にインストール</h2>
<p>今回のインストールの構成は以下の通りです。</p>
<ul>
<li>US キーボード</li>
<li>有線 LAN</li>
<li>DHCP</li>
<li>デュアルブート無し</li>
</ul>
<p>USB メモリからブートしたライブシステムで DHCP が動いてインターネットに接続できる状態でした。</p>
<h3 id="ntp-を有効にします">NTP を有効にします</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">timedatectl set-ntp <span class="nb">true</span>
</span></span></code></pre></div><h3 id="パーティション作成">パーティション作成</h3>
<p>インストール先のディスク名を以下のコマンドで確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">lsblk
</span></span></code></pre></div><p>インストール先のディスクのパーティションを作成します。cgdisk か fdisk コマンドを使うとありましたが、 cgdisk は使ったことが無かったのでこちらを使ってみました。 TUI で操作できて簡単で良かったです。</p>
<p>スワップパーティションのサイズは <a href="https://itsfoss.com/swap-size/">How Much Swap Should You Use in Linux? - It&rsquo;s FOSS</a> と <a href="https://help.ubuntu.com/community/SwapFaq">SwapFaq - Community Help Wiki</a> の RAM が 1GB より大きい場合は最低で RAM のサイズの平方根というお勧めに従いました。</p>
<p>具体的には RAM が 64 GB なのでスワップは 8GB にしました。</p>
<table>
<thead>
<tr>
<th>パーティション</th>
<th>サイズ</th>
<th>パーティションタイプ</th>
</tr>
</thead>
<tbody>
<tr>
<td>/dev/nvme0n1p1</td>
<td>512M</td>
<td>EFI</td>
</tr>
<tr>
<td>/dev/nvme0n1p2</td>
<td>EFIとスワップを引いた残り</td>
<td>Linux filesystem</td>
</tr>
<tr>
<td>/dev/nvme0n1p3</td>
<td>8GB</td>
<td>Linux swap</td>
</tr>
</tbody>
</table>
<p>フォーマットする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkfs.fat -F32 /dev/nvme0n1p1
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkfs.ext4 /dev/nvme0n1p2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkswap /dev/nvme0n1p3
</span></span></code></pre></div><h3 id="パッケージをインストール">パッケージをインストール</h3>
<p>ルートパーティションをマウント。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mount /dev/nvme0n1p2 /mnt
</span></span></code></pre></div><p><code>/mnt/boot</code> を作成して EFI パーティションをマウント。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir /mnt/boot
</span></span><span class="line"><span class="cl">mount /dev/nvme0n1p1 /mnt/boot
</span></span></code></pre></div><p>swapを有効にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkswap /dev/nvme0n1p3
</span></span></code></pre></div><p>パッケージをインストール。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacstrap /mnt base linux linux-firmware man-db vim
</span></span></code></pre></div><h3 id="chroot-してさらにセットアップを実行">chroot してさらにセットアップを実行</h3>
<p>fstab 設定。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
</span></span></code></pre></div><p>chroot を実行。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">arch-chroot /mnt
</span></span></code></pre></div><p>タイムゾーン設定。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
</span></span></code></pre></div><p>システムの時刻をBIOSの時刻にコピー。タイムゾーンはUTCになる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">hwclock --systohc
</span></span></code></pre></div><p><code>vim /etc/locale.gen</code> で <code>en_US.UTF-8 UTF-8</code> と <code>ja_JP.UTF-8 UTF-8</code> の行をアンコメントして以下のコマンドでロケールを生成。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">locale-gen
</span></span></code></pre></div><p><code>/etc/locale.conf</code> を以下のように編集。</p>
<pre tabindex="0"><code>LANG=en_US.UTF-8
</code></pre><p>コンソールのキーボード設定でCapsLockとCtrl入れ替え。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -p /usr/local/share/kbd/keymaps
</span></span><span class="line"><span class="cl">gzip -cd /usr/share/kbd/keymaps/i386/qwerty/us.map.gz &gt; /usr/local/share/kbd/keymaps/my_custom_us.map
</span></span></code></pre></div><p><code>vim /usr/local/share/kbd/keymaps/my_custom_us.map</code> で編集して、以下のように入れ替え。</p>
<pre tabindex="0"><code>…(略）…
keycode  29 = Caps_Lock
…(略）…
keycode  58 = Control
…(略）…
</code></pre><p>以下のコマンドで読み込んで有効にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">loadkeys /usr/local/share/kbd/keymaps/my_custom_us.map
</span></span></code></pre></div><p>キーを押してみて期待通りになっていたら、 <code>/etc/vconsole.conf</code> を以下のように編集。</p>
<pre tabindex="0"><code>KEYMAP=/usr/local/share/kbd/keymaps/my_custom_us.map
</code></pre><p><code>/etc/hostname</code> を編集してお好みのホスト名を設定。ここでは thinkcentre とします。</p>
<p><code>/etc/hosts</code> を以下のように編集。</p>
<pre tabindex="0"><code>127.0.0.1    localhost
::1          localhost
127.0.1.1    thinkcentre.localdomain thinkcentre
</code></pre><p><code>passwd</code> を実行して root ユーザのパスワードを設定。</p>
<p>ブートローダに GRUB を使う設定。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -S grub efibootmgr dosfstools os-prober mtools
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">grub-install --target<span class="o">=</span>x86_64-efi --efi-directory<span class="o">=</span>/boot --bootloader-id<span class="o">=</span>GRUB_UEFI
</span></span></code></pre></div><p>初回と今後のgrubの設定変更時に以下のコマンドを実行。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p>マイクロプロセッサ用コードをインストール。CPUに応じて <code>intel-ucode</code> か <code>amd-ucode</code> を入れます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -S amd-ucode
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><h3 id="ネットワーク設定">ネットワーク設定</h3>
<p>参考にした記事はノートPCで無線LANなので NetworkManager を使っていますが、私は有線LANなので <code>systemd-networkd</code> にしました。</p>
<p><a href="https://wiki.archlinux.jp/index.php/%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E8%A8%AD%E5%AE%9A">ネットワーク設定 - ArchWiki</a> の表を見ると Archiso の base に含まれていて DHCP クライアントも内蔵しているとのこと。</p>
<p>DNS はとりあえず <a href="https://wiki.archlinux.jp/index.php/Systemd-resolved">systemd-resolved - ArchWiki</a> を使うことにしました。「systemd-resolved はデフォルトでインストールされる systemd パッケージの一部です。」とあるのでそのままで使えます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">systemctl <span class="nb">enable</span> --now systemd-networkd
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> --now systemd-resolved
</span></span></code></pre></div><h3 id="chroot-を抜けて再起動">chroot を抜けて再起動</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">exit</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">reboot
</span></span></code></pre></div><h2 id="インストールしたディスクから起動後さらにセットアップを進める">インストールしたディスクから起動後、さらにセットアップを進める</h2>
<h3 id="ネットワークの動作確認と設定">ネットワークの動作確認と設定</h3>
<p>インストールしたディスクから起動後、root でログインします。</p>
<p><code>ping 8.8.8.8</code> インターネットに接続できることを確認。
<code>ping google.com</code> で名前解決が出来ることを確認。</p>
<p>後に gpg でリモートのキーサーバからキーをインストールするときに <code>gpg: keyserver receive failed: Server indicated a failure</code> というエラーになったのですが <code>/etc/resolv.conf</code> が空だったのが原因でした (<a href="https://unix.stackexchange.com/a/630182/135274">https://unix.stackexchange.com/a/630182/135274</a> に書かれていました)。</p>
<p><a href="https://wiki.archlinux.jp/index.php/Systemd-resolved">systemd-resolved - ArchWiki</a> にも書かれているように以下のコマンドで解消しました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
</span></span></code></pre></div><h3 id="一般ユーザの作成と-sudo-の設定">一般ユーザの作成と sudo の設定</h3>
<p>ユーザ名はここでは hnakamur とします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">useradd -m -G wheel hnakamur
</span></span></code></pre></div><p>パスワードを設定。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">passwd hnakamur
</span></span></code></pre></div><p>sudo パッケージをインストール。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">pacman -S sudo
</span></span></code></pre></div><p>visudo を起動。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">EDITOR</span><span class="o">=</span>vim visudo
</span></span></code></pre></div><p>コメントアウトされている以下の行をアンコメントして有効にして保存して終了。</p>
<pre tabindex="0"><code>%wheel ALL=(ALL) ALL
</code></pre><p>root ユーザをログアウトして、作成したユーザでログインします。</p>
<h3 id="tmux-をインストール">tmux をインストール</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo pacman -S tmux
</span></span></code></pre></div><p><code>https://github.com/hnakamur/dotfiles</code> の <code>.tmux.conf</code> をホームディレクトリにコピーしてキーバインドを変更。</p>
<h3 id="sshd-のインストールと起動">sshd のインストールと起動</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo pacman -S openssh
</span></span></code></pre></div><p><code>sudo vim /etc/ssh/sshd_config</code> で以下のように編集。</p>
<pre tabindex="0"><code>#PasswordAuthentication yes
PasswordAuthentication no # この行を追加
</code></pre><pre tabindex="0"><code>#UsePAM yes
UsePAM no # この行を追加
</code></pre><p>X11Forwarding はデフォルト値で no となっていたので変更無し。</p>
<pre tabindex="0"><code>#X11Forwarding no
</code></pre><p>sshd を起動し、自動起動を有効にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo systemctl <span class="nb">enable</span> --now sshd
</span></span></code></pre></div><h3 id="keepassxc-cli-も試してみた">keepassxc-cli も試してみた</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo pacman -S keepassxc
</span></span></code></pre></div><p>で <code>keepassxc-cli</code> という CLI もインストールされるので、初めて使ってみました。</p>
<p>keepassxc のデータベースファイルの入った USB 接続のハードディスクを接続してファイルをコピーしました。</p>
<p><code>sudo dmesg</code> でデバイスファイル名を確認し、 <code>/dev/sda</code> だったので以下のようにしました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo mount /dev/sda /mnt
</span></span><span class="line"><span class="cl">cp /mnt/path/to/my_database.db ~/
</span></span><span class="line"><span class="cl">sudo umount /mnt
</span></span></code></pre></div><p><a href="https://man.archlinux.org/man/keepassxc-cli.1.en">keepassxc-cli(1) — Arch manual pages</a> を参考に attachment-export サブコマンドを使って添付ファイルとして含めていた ssh の公開鍵を <code>~/.ssh/authorized_keys</code> ファイルに保存します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mkdir -m <span class="m">700</span> ~/.ssh
</span></span><span class="line"><span class="cl">keepassxc-cli attachment-export my_database.db <span class="s2">&#34;DB内のエントリ名&#34;</span> 添付ファイル名 保存先ファイル名
</span></span></code></pre></div><p>DB内のエントリ名は search サブコマンドで調べられます。</p>
<p>open サブコマンドを使ってDBファイルを開いてインタラクティブにコマンドを実行することもできます。 <code>DBファイルのベース名&gt;</code> のようなプリンプトでサブコマンドをDBファイル名無しで実行します。使い終わったら close サブコマンドでDBを閉じます。</p>
<p>インタラクティブにコマンドを実行する際、空白を含んだエントリ名を指定する際はシングルクォートで囲むと応答なしでプロンプトに戻って何も起きませんでした。ダブルクォートで囲むと正常に動作しました。</p>
<p>clip サブコマンドは xclip コマンドを試したが失敗したという主旨の出力が出ました。 <code>sudo pacman -S xclip</code> でインストールしましたが、 X11 をインストールしていないコンソールでは使えないらしくうまく動きませんでした。</p>
<p>代わりに show コマンドを <code>-s -a password</code> オプションを指定して実行することで指定したエントリのパスワードがクリアテキストで表示されたのでこれを tmux でコピー＆ペーストして利用しました。この方法は人に見られてしまう環境だとまずいですが、私の自宅では問題ありません。</p>
<h3 id="yay-のインストール">yay のインストール</h3>
<p><a href="https://github.com/Jguer/yay">Jguer/yay: Yet another Yogurt - An AUR Helper written in Go</a> をインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo pacman -S --needed git base-devel
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">git clone https://aur.archlinux.org/yay.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> yay
</span></span><span class="line"><span class="cl">makepkg -si
</span></span></code></pre></div><h3 id="linux-カーネル-519-を入れてみる">Linux カーネル 5.19 を入れてみる</h3>
<p>標準のカーネルのバージョンを <code>uname -r</code> で確認すると <code>5.18.16-arch1-1</code> でした。</p>
<p><a href="https://wiki.archlinux.jp/index.php/%E3%82%AB%E3%83%BC%E3%83%8D%E3%83%AB">カーネル - ArchWiki</a> を見て <a href="https://aur.archlinux.org/packages/linux-mainline">AUR (en) - linux-mainline</a> パッケージを入れてみました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">yay -S linux-mainline
</span></span></code></pre></div><p>いくつかプロンプトが出て質問されるので適宜答えます。</p>
<p>途中で gpg のキーをリモートから取得してインストールするところで、前述の <code>gpg: keyserver receive failed: Server indicated a failure</code> のエラーが出ましたが、上記の手順で解消しました。</p>
<p>ビルド済みのカーネルをダウンロードしてインストールされるのではなく、ローカルでビルドされていました。</p>
<p>ビルドがいつまでも終わらないので Ctrl-C で一旦中止しました。
<a href="https://wiki.archlinux.jp/index.php/Makepkg">makepkg - ArchWiki</a> を見て <code>MAKEFLAGS=-j8</code> をつけて以下のコマンドを実行してみました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">MAKEFLAGS</span><span class="o">=</span>-j8 yay -S linux-mainline
</span></span></code></pre></div><p>すると ABAF11C65A2970B130ABE3C479BE3E4300411886 の gpg 鍵のインポートで今度は <code>gpg: keyserver receive failed: No data</code> というエラーになりました。</p>
<p><code>gpg --recv 0xABAF11C65A2970B130ABE3C479BE3E4300411886</code> でも同じエラーになりました。</p>
<p><a href="https://bbs.archlinux.org/viewtopic.php?id=249943">[SOLVED] Cannot import Torvalds&rsquo;s GPG key / Newbie Corner / Arch Linux Forums</a> を見て以下のコマンドを実行すると <code>No data</code> ではなく <code>no user ID</code> になりました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gpg --keyserver keys.openpgp.org --recv 0xABAF11C65A2970B130ABE3C479BE3E4300411886
</span></span></code></pre></div><p>以下のような出力が出ていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ gpg --keyserver keys.openpgp.org --recv 0xABAF11C65A2970B130ABE3C479BE3E4300411886
</span></span><span class="line"><span class="cl">gpg: data source: http://keys.openpgp.org:11371
</span></span><span class="line"><span class="cl">gpg: armor header: ABAF 11C6 5A29 70B1 30AB  E3C4 79BE 3E43 <span class="m">0041</span> <span class="m">1886</span>
</span></span><span class="line"><span class="cl">gpg: pub  rsa2048/79BE3E4300411886 2011-09-20
</span></span><span class="line"><span class="cl">gpg: key 79BE3E4300411886: no user ID
</span></span><span class="line"><span class="cl">gpg: Total number processed: <span class="m">1</span>
</span></span></code></pre></div><p><a href="https://wiki.archlinux.jp/index.php/GnuPG">auto-key-retrieve</a> を参考に <code>~/.gnupg/dirmngr.conf</code> を以下の内容で作成してみました。</p>
<pre tabindex="0"><code>keyserver hkps://keys.openpgp.org
</code></pre><p><code>ps auxwwf | grep dirmngr</code> で <code>/usr/bin/dirmngr --supervisord</code> の PID を調べて <code>kill -HUP そのPID</code> で設定ファイルを再読み込みさせて、再度試しました。が、以下のように <code>problem importing keys</code> というエラーになりました。</p>
<pre tabindex="0"><code>:: PGP keys need importing:
 -&gt; ABAF11C65A2970B130ABE3C479BE3E4300411886, required by: linux-mainline
==&gt; Import? [Y/n] y # y と入力
:: Importing keys with gpg...
gpg: key 79BE3E4300411886: no user ID
gpg: Total number processed: 1
 -&gt; problem importing keys
</code></pre><p><a href="https://askubuntu.com/questions/1007287/gpg2-locate-keys-wont-work-immediately-returns/1027703#1027703">kernel - gpg2 locate keys wont work (immediately returns) - Ask Ubuntu</a> を参考に以下のコマンドを実行するとインポートできました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gpg2 --auto-key-locate cert,pka,dane,wkd,keyserver --locate-keys torvalds@kernel.org
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ gpg2 --auto-key-locate cert,pka,dane,wkd,keyserver --locate-keys torvalds@kernel.org
</span></span><span class="line"><span class="cl">gpg: error retrieving <span class="s1">&#39;torvalds@kernel.org&#39;</span> via DNS CERT: No name
</span></span><span class="line"><span class="cl">gpg: error retrieving <span class="s1">&#39;torvalds@kernel.org&#39;</span> via PKA: No name
</span></span><span class="line"><span class="cl">gpg: error retrieving <span class="s1">&#39;torvalds@kernel.org&#39;</span> via DANE: No name
</span></span><span class="line"><span class="cl">gpg: key 79BE3E4300411886: public key <span class="s2">&#34;Linus Torvalds &lt;torvalds@kernel.org&gt;&#34;</span> imported
</span></span><span class="line"><span class="cl">gpg: Total number processed: <span class="m">1</span>
</span></span><span class="line"><span class="cl">gpg:               imported: <span class="m">1</span>
</span></span><span class="line"><span class="cl">pub   rsa2048 2011-09-20 <span class="o">[</span>SC<span class="o">]</span>
</span></span><span class="line"><span class="cl">      ABAF11C65A2970B130ABE3C479BE3E4300411886
</span></span><span class="line"><span class="cl">uid:          <span class="o">[</span> unknown <span class="o">]</span> Linus Torvalds &lt;torvalds@kernel.org&gt;
</span></span><span class="line"><span class="cl">sub   rsa2048 2011-09-20 <span class="o">[</span>E<span class="o">]</span>
</span></span></code></pre></div><p>これで <code>gpg --list-keys</code> で鍵が一覧に出てきました。
再度 <code>MAKEFLAGS=-j8 yay -S linux-mainline</code> を実行すると今度は gpg 鍵のインポートのプロンプトは出ずに先に進みました。</p>
<p>その後時間がかかるので目を離していたら最後に sudo のプロンプトが出てタイムアウトになっていました。</p>
<pre tabindex="0"><code>==&gt; Finished making: linux-mainline 5.19-1 (Sun 14 Aug 2022 06:24:16 AM JST)
==&gt; Cleaning up...
[sudo] password for hnakamur:
sudo: timed out reading password
sudo: a password is required
 -&gt; exit status 1
</code></pre><p>再度 <code>MAKEFLAGS=-j8 yay -S linux-mainline</code> を実行して <code>Packages to cleanBuild?</code> に [N]one の N で答えたら、途中で以下のようなメッセージが出力されてビルドはスキップされて進みました。</p>
<pre tabindex="0"><code>==&gt; Sources are ready.
 -&gt; linux-mainline-5.19-1 already made -- skipping build
[sudo] password for hnakmaur: ここでパスワードを入力
loading packages...
resolving dependencies...
looking for conflicing packages...

Packages (1) linux-mainline-5.19-1

Total Installed Size:  177.07 MiB

:: Proceed with installation? [Y/n] ここでEnterキーを押す

(1/1) checking keys in keyring                                                                                                                   [########################################################################################] 100%
(1/1) checking package integrity                                                                                                                 [########################################################################################] 100%
(1/1) loading package files                                                                                                                      [########################################################################################] 100%
(1/1) checking for file conflicts                                                                                                                [########################################################################################] 100%
(1/1) checking available disk space                                                                                                              [########################################################################################] 100%
:: Processing package changes...
(1/1) installing linux-mainline                                                                                                                  [########################################################################################] 100%
Optional dependencies for linux-mainline
    wireless-regdb: to set the correct wireless channels of your country
    linux-firmware: firmware images needed for some devices [installed]
:: Running post-transaction hooks...
(1/3) Arming ConditionNeedsUpdate...
(2/3) Updating module dependencies...
(3/3) Updating linux initcpios...
==&gt; Building image from preset: /etc/mkinitcpio.d/linux-mainline.preset: &#39;default&#39;
  -&gt; -k /boot/vmlinuz-linux-mainline -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-mainline.img
==&gt; Starting build: 5.19.0-1-mainline
  -&gt; Running build hook: [base]
  -&gt; Running build hook: [udev]
  -&gt; Running build hook: [autodetect]
  -&gt; Running build hook: [modconf]
  -&gt; Running build hook: [block]
==&gt; WARNING: Possibly missing firmware for module: xhci_pci
  -&gt; Running build hook: [filesystems]
  -&gt; Running build hook: [keyboard]
  -&gt; Running build hook: [fsck]
==&gt; Generating module dependencies
==&gt; Creating zstd-compressed initcpio image: /boot/initramfs-linux-mainline.img
==&gt; Image generation successful
==&gt; Building image from preset: /etc/mkinitcpio.d/linux-mainline.preset: &#39;fallback&#39;
  -&gt; -k /boot/vmlinuz-linux-mainline -c /etc/mkinitcpio.conf -g /boot/initramfs-linux-mainline-fallback.img -S autodetect
==&gt; Starting build: 5.19.0-1-mainline
  -&gt; Running build hook: [base]
  -&gt; Running build hook: [udev]
  -&gt; Running build hook: [modconf]
  -&gt; Running build hook: [block]
==&gt; WARNING: Possibly missing firmware for module: wd719x
==&gt; WARNING: Possibly missing firmware for module: bfa
==&gt; WARNING: Possibly missing firmware for module: qla1280
==&gt; WARNING: Possibly missing firmware for module: qed
==&gt; WARNING: Possibly missing firmware for module: qla2xxx
==&gt; WARNING: Possibly missing firmware for module: aic94xx
==&gt; WARNING: Possibly missing firmware for module: xhci_pci
  -&gt; Running build hook: [filesystems]
  -&gt; Running build hook: [keyboard]
  -&gt; Running build hook: [fsck]
==&gt; Generating module dependencies
==&gt; Creating zstd-compressed initcpio image: /boot/initramfs-linux-mainline-fallback.img
==&gt; Image generation successful
</code></pre><p>WARNING がいくつか出ているのが気になりますが、イメージの生成は試行したと最後に出ていました。</p>
<p>ここで grub の設定のバックアップを取ってから更新を実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sudo cp /boot/grub/grub.cfg<span class="o">{</span>,.bak<span class="o">}</span>
</span></span><span class="line"><span class="cl">sudo grub-mkconfig -o /boot/grub/grub.cfg
</span></span></code></pre></div><p><code>diff -u /boot/grub/grub.cfg{.bak,}</code> で差分を見て linux-mainline のメニューが追加されていることを確認しました。</p>
<p><code>sudo reboot</code> で再起動してみると起動できて <code>Arch Linux 5.19.0-1-mainline (tty1)</code> と表示されていました。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
