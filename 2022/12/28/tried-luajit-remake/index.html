<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.111.2">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>luajit-remakeã‚’è©¦ã—ã¦ã¿ãŸ &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2023. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>luajit-remakeã‚’è©¦ã—ã¦ã¿ãŸ</h1>
  <time datetime=2022-12-28T18:20:31&#43;0900 class="post-date">2022-12-28</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#ã¯ã˜ã‚ã«">ã¯ã˜ã‚ã«</a></li>
    <li><a href="#ãƒ“ãƒ«ãƒ‰">ãƒ“ãƒ«ãƒ‰</a></li>
    <li><a href="#ä»˜å±ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿè¡Œ">ä»˜å±ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿè¡Œ</a></li>
    <li><a href="#ãŸã‚‰ã„å›ã—é–¢æ•°ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’è©¦ã—ã¦ã¿ãŸ">ãŸã‚‰ã„å›ã—é–¢æ•°ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’è©¦ã—ã¦ã¿ãŸ</a></li>
  </ul>
</nav>
  <h2 id="ã¯ã˜ã‚ã«">ã¯ã˜ã‚ã«</h2>
<p><a href="/blog/2022/12/28/tried-tarai-benchmark-with-luajit/">LuaJITã§ãŸã‚‰ã„å›ã—é–¢æ•°ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’è©¦ã—ã¦ã¿ãŸ Â· hnakamur&rsquo;s blog</a>ã®ã¤ã„ã§ã«<a href="https://github.com/luajit-remake/luajit-remake">luajit-remake/luajit-remake: An ongoing attempt to re-engineer LuaJIT from scratch</a>ã‚‚è©¦ã—ã¦ã¿ãŸã®ã§ãƒ¡ãƒ¢ã§ã™ã€‚</p>
<h2 id="ãƒ“ãƒ«ãƒ‰">ãƒ“ãƒ«ãƒ‰</h2>
<p>Dockerã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã¨ã„ã†å‰æã§ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«<code>luajitr</code>ã¨ã„ã†å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</p>
<pre tabindex="0"><code>git clone https://github.com/luajit-remake/luajit-remake
cd luajit-remake
./ljr-build make release
</code></pre><p>ãƒ“ãƒ«ãƒ‰ã«ä½¿ç”¨ã™ã‚‹LLVMãªã©ã®ãƒ„ãƒ¼ãƒ«ãƒã‚§ã‚¤ãƒ³ã¯
<a href="https://hub.docker.com/r/haoranxu510/ljr-build">haoranxu510/ljr-build - Docker Image | Docker Hub</a>ã®v0.0.3ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’pullã—ã¦ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã—ãŸã€‚</p>
<p>ã“ã‚Œã‚’æ‰‹å…ƒã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã¯ã€ä¸Šè¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã°OKã§ã—ãŸã€‚</p>
<pre tabindex="0"><code>cd dockerfile
docker build -t ljr-build:v0.0.3 .
</code></pre><p>ãŸã ã€ljr-buildã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®v0.0.3ãŒgitã®ã©ã®ã‚³ãƒŸãƒƒãƒˆã«å¯¾å¿œã—ã¦ã„ã‚‹ã‹ãŒåˆ†ã‹ã‚‰ãªã‹ã£ãŸã®ã§ã€æ­£ã—ãã¯æ‰‹å…ƒã§ljr-buildã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹éš›ã¯v0.0.3ã¨ä»˜ã‘ãšã«ãƒ“ãƒ«ãƒ‰ã—ã¦<code>./ljr-build</code>ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã»ã†ã‚’ã‚³ãƒ”ãƒšæ”¹å¤‰ã—ã¦v0.0.3ã§ã¯ãªãæ‰‹å…ƒã®ãƒ“ãƒ«ãƒ‰ã‚’ä½¿ã†ã‚ˆã†ã«æ”¹å¤‰ã—ãŸã»ã†ãŒè‰¯ã•ãã†ã§ã™ã€‚</p>
<p>ãƒ„ãƒ¼ãƒ«ãƒã‚§ã‚¤ãƒ³ã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã«ã¯<a href="https://github.com/luajit-remake/luajit-remake/blob/master/dockerfile/build_docker_image.sh">dockerfile/build_docker_image.sh</a>ã¨ã„ã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ã£ã¦ã„ã¾ã™ãŒã€CMakeã‚’ã‚½ãƒ¼ã‚¹ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€ç‹¬è‡ªãƒ‘ãƒƒãƒã‚’å½“ã¦ãŸLLVM 12ã§LLVM 15.0.3ã‚’ãƒ“ãƒ«ãƒ‰ã—ãŸã‚Šã—ã¦ã„ã¾ã™ã€‚ã¾ãŸ<a href="https://github.com/rui314/mold/">rui314/mold: mold: A Modern Linker ğŸ¦ </a>ã‚‚ä½¿ã‚ã‚Œã¦ã„ã¾ã—ãŸã€‚</p>
<h2 id="ä»˜å±ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿè¡Œ">ä»˜å±ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿè¡Œ</h2>
<p>ã“ã“ã§ã¯<a href="https://hub.docker.com/r/haoranxu510/ljr-build">haoranxu510/ljr-build - Docker Image | Docker Hub</a>ã®v0.0.3ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ„ãƒ¼ãƒ«ãƒã‚§ã‚¤ãƒ³ã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚³ãƒŸãƒƒãƒˆã®ã‚½ãƒ¼ã‚¹ã§ãƒ“ãƒ«ãƒ‰ã—ãŸluajitrã§è©¦ã—ã¾ã—ãŸã€‚</p>
<pre tabindex="0"><code>$ git log -1
commit f2701c3dfdfb4e14ec0875804704177720582bd8 (HEAD -&gt; master, origin/master, origin/HEAD)
Author:     Haoran Xu &lt;haoranxu510@gmail.com&gt;
AuthorDate: Thu Dec 1 21:52:55 2022
Commit:     Haoran Xu &lt;haoranxu510@gmail.com&gt;
CommitDate: Thu Dec 1 21:52:55 2022

    more refactoring in preparation for baseline jit
</code></pre><p><code>./run_bench.sh</code>ã¨å®Ÿè¡Œã™ã‚‹ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã•ã‚Œã¤ã¤<code>benchmark.log</code>ã¨ã„ã†ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚</p>
<p><code>run_bench.sh</code>ã§ã¯ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’luaã§ä½œã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã®ã§ã™ãŒãã“ã‚’luajitã«æ›¸ãæ›ãˆãŸç‰ˆã¨ã€luajitrã§ã¯ãªãluajitã‚’ä½¿ã†ã‚ˆã†ã«ã—ãŸ<code>run_bench_luajit.sh</code>ã‚’ä½œã£ã¦ã€luajitrã¨luajitã§ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’å®Ÿè¡Œã—ã¦è¦‹ã¾ã—ãŸã€‚</p>
<p>çµæœã¯<a href="https://github.com/hnakamur/luajit-remake/tree/compare-benchmark-with-luajit">hnakamur/luajit-remake at compare-benchmark-with-luajit</a>ã®<a href="https://github.com/hnakamur/luajit-remake/blob/compare-benchmark-with-luajit/benchmark-luajitr.log">benchmark-luajitr.log</a>ã¨<a href="https://github.com/hnakamur/luajit-remake/blob/compare-benchmark-with-luajit/benchmark-luajit.log">benchmark-luajit.log</a>ã«ç½®ã„ã¦ã„ã¾ã™ã€‚ã»ã¨ã‚“ã©ã®ãƒ†ã‚¹ãƒˆã§ã¯luajitã®ã»ã†ãŒé€Ÿã„ã§ã™ãŒã€ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆã¯luajitrã®ã»ã†ãŒé€Ÿã‹ã£ãŸã§ã™ã€‚</p>
<h2 id="ãŸã‚‰ã„å›ã—é–¢æ•°ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’è©¦ã—ã¦ã¿ãŸ">ãŸã‚‰ã„å›ã—é–¢æ•°ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’è©¦ã—ã¦ã¿ãŸ</h2>
<p>LuaJITã®FFIã‚„<code>os.time</code>ã¯luajitrã§ã¯æœªå®Ÿè£…ã§ã—ãŸã€‚</p>
<pre tabindex="0"><code>$ ~/ghq/github.com/luajit-remake/luajit-remake/luajitr tarai-ffi-time.lua
Uncaught error: Library function &#39;require&#39; is not implemented yet!
$ ~/ghq/github.com/luajit-remake/luajit-remake/luajitr tarai-os-time.lua
Uncaught error: Library function &#39;os.time&#39; is not implemented yet!
</code></pre><p>ã¨ã„ã†ã“ã¨ã§<code>/usr/bin/time</code>ã§å‡¦ç†æ™‚é–“ã¨ãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ã‚’èª¿ã¹ã¦LuaJITã¨æ¯”ã¹ã¾ã—ãŸã€‚<a href="/blog/2022/12/28/tried-tarai-benchmark-with-luajit/">LuaJITã§ãŸã‚‰ã„å›ã—é–¢æ•°ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚’è©¦ã—ã¦ã¿ãŸ Â· hnakamur&rsquo;s blog</a>ã®<code>clock_gettime</code>ã‚’ä½¿ã†æ–¹å¼ã¨ã¯ç•°ãªã‚Šã€<code>luajit</code>ã¨<code>luajitr</code>ã®èµ·å‹•æ™‚é–“ã‚‚å«ã¾ã‚Œã‚‹ã®ã§ã€ãã¡ã‚‰ã®è¨˜äº‹ã¨ã¯åˆ¥ã®æ¯”è¼ƒã«ãªã‚Šã¾ã™ã€‚</p>
<pre tabindex="0"><code>$ set -x; for i in {1..3}; do /usr/bin/time -f &#39;%e %M&#39; ~/ghq/github.com/luajit-remake/luajit-remake/luajitr tarai-no-time.lua ; /usr/bin/time -f &#39;%e %M&#39; luajit tarai-no-time.lua; done; set +x
+ for i in {1..3}
+ /usr/bin/time -f &#39;%e %M&#39; /home/hnakamur/ghq/github.com/luajit-remake/luajit-remake/luajitr tarai-no-time.lua
ans=14
5.51 3140
+ /usr/bin/time -f &#39;%e %M&#39; luajit tarai-no-time.lua
ans=14
2.12 2164
+ for i in {1..3}
+ /usr/bin/time -f &#39;%e %M&#39; /home/hnakamur/ghq/github.com/luajit-remake/luajit-remake/luajitr tarai-no-time.lua
ans=14
5.50 3256
+ /usr/bin/time -f &#39;%e %M&#39; luajit tarai-no-time.lua
ans=14
1.91 2092
+ for i in {1..3}
+ /usr/bin/time -f &#39;%e %M&#39; /home/hnakamur/ghq/github.com/luajit-remake/luajit-remake/luajitr tarai-no-time.lua
ans=14
5.50 3132
+ /usr/bin/time -f &#39;%e %M&#39; luajit tarai-no-time.lua
ans=14
2.23 2104
+ set +x
</code></pre><p>ã“ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã«é–¢ã—ã¦ã¯ã€ç¾çŠ¶ã§ã¯OpenRestyã®ãƒ•ã‚©ãƒ¼ã‚¯ç‰ˆLuaJITã®ã»ã†ãŒé€Ÿãã¦ãƒ¡ãƒ¢ãƒªæ¶ˆè²»é‡ã‚‚å°‘ãªã„ã‚ˆã†ã§ã™ã€‚</p>
<p>ãŸã ã€<a href="https://sillycross.github.io/2022/11/22/2022-11-22/">Building the fastest Lua interpreter.. automatically!</a>ã®è¨˜äº‹ã‚’èª­ã‚€ã¨tail-call approachã¯è‰¯ã•ãã†ãªæ„Ÿã˜ãªã®ã§å°†æ¥ã«æœŸå¾…ã—ãŸã„ã¨ã“ã‚ã§ã™ã€‚</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
