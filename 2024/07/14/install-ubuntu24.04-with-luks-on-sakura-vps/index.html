<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.122.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>さくらのVPSでUbuntu 24.04をLUKSでディスク暗号化ありでインストール &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2024. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>さくらのVPSでUbuntu 24.04をLUKSでディスク暗号化ありでインストール</h1>
  <time datetime=2024-07-14T11:25:52&#43;0900 class="post-date">2024-07-14</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#インストール手順">インストール手順</a>
      <ul>
        <li><a href="#インストール用のisoから起動">インストール用のISOから起動</a></li>
        <li><a href="#インストーラでの操作">インストーラでの操作</a></li>
        <li><a href="#インストールタイプ選択まで">インストールタイプ選択まで</a></li>
        <li><a href="#ネットワーク設定">ネットワーク設定</a></li>
        <li><a href="#シェルを起動してパーティションテーブルとディスクの中身をクリア">シェルを起動してパーティションテーブルとディスクの中身をクリア</a></li>
        <li><a href="#ストレージ設定">ストレージ設定</a></li>
      </ul>
    </li>
    <li><a href="#起動時にluksのパスフレーズを入力">起動時にLUKSのパスフレーズを入力</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p>さくらのVPSでUbuntu 24.04をLUKSでディスク暗号化ありでインストールしたときのメモです。
もっと良いやり方があるかもしれませんが、とりあえずこれでできたという手順を書いています。</p>
<h2 id="インストール手順">インストール手順</h2>
<h3 id="インストール用のisoから起動">インストール用のISOから起動</h3>
<ol>
<li>コントロールパネルで対象のサーバーの行の「操作」列の「…」/「サーバー詳細へ移動」メニューを選ぶ</li>
<li>「OS再インストール」ボタンを押す</li>
<li>OSインストール方法は「ISOイメージ」を選ぶ</li>
<li>インストールするOSは「Ubuntu 24.04 amd64」を選ぶ</li>
<li>ネットワークは「接続先を初期化」のまま</li>
<li>「内容確認」ボタンを押し、確認ダイアログが表示されたら「OS再インストール」ボタンを押す</li>
<li>画面右下に「OSインストール」というウィンドウが表示されたら「VNCコンソールを起動」ボタンを押す</li>
</ol>
<h3 id="インストーラでの操作">インストーラでの操作</h3>
<p>ポイントとなる箇所だけ書きます。</p>
<h3 id="インストールタイプ選択まで">インストールタイプ選択まで</h3>
<ol>
<li>言語は「English」を選ぶ</li>
<li>キーボードのレイアウトは適宜選ぶ</li>
<li>インストールのタイプは「Ubuntu Server (minimized)」を選ぶ</li>
</ol>
<h3 id="ネットワーク設定">ネットワーク設定</h3>
<ol>
<li>ネットワーク設定のens3は「Edit IPv4」で「Manual」を選択し、コントロールパネルのネットワークタブを参照して各項目を入力する（以下はアドレスを192.2.0.200として説明）
<ul>
<li>コントロールパネルのネットマスクが255.255.254.0の場合は/23なのでSubnetは「192.2.0.0/23」と入力（別のLinuxマシンで<code>ipcalc 192.2.0.200 255.255.254.0</code>と入力するとNetworkにこの結果が出力されます）</li>
<li>Addressにはコントロールパネルのアドレスの値を入力（この例では192.2.0.200）</li>
<li>Gatewayにはコントロールパネルのゲートウェイの値を入力</li>
<li>Name ServerにはコントロールパネルのプライマリDNSとセカンダリDNSの値を半角カンマで区切って入力</li>
<li>Search Domainsは空のままで良い</li>
</ul>
</li>
<li>ネットワーク設定のens4とens5は「Edit IPv4」の「Disabled」を選ぶ</li>
</ol>
<h3 id="シェルを起動してパーティションテーブルとディスクの中身をクリア">シェルを起動してパーティションテーブルとディスクの中身をクリア</h3>
<p>一度ディスクを使用していた場合は、LUKS暗号化ありでインストールする際にエラーになってしまいました。</p>
<p><a href="https://gitlab.com/cryptsetup/cryptsetup/-/wikis/FrequentlyAskedQuestions">FrequentlyAskedQuestions · Wiki · cryptsetup / cryptsetup · GitLab</a>を参考に、ストレージの設定に入る前にパーティションテーブルとディスクの中身をクリアすると大丈夫でした。</p>
<p>ここではインストール先のSSDのデバイス名が<code>/dev/vda</code>として説明します。</p>
<p>まず、右上の「Help」の「Enter shell」を選んでシェルを起動します。</p>
<ol>
<li><code>wipefs -a /dev/vda</code>を実行して、パーティションテーブルを削除します。</li>
<li><code>parted /dev/vda print</code>を実行して、パーティションテーブルが消えたことを確認します。</li>
<li><code>dd if=/dev/zero of=/dev/vda bs=4M status=progress</code>を実行してディスク全体をゼロクリアします。
上記のようにcountを指定しないと、書き込み続けた後No space left on deviceのようなメッセージが出て
終了します。100GBで10分程度かかりました。</li>
<li><code>exit</code>と入力してインストーラに戻ります。</li>
</ol>
<h3 id="ストレージ設定">ストレージ設定</h3>
<ol>
<li>「Use Entire Disk」の「Set up this disk as an LVM group」の「Encrypt the LVM group with LUKS」を有効にしてパスフレーズを設定します。</li>
<li>その後「Custom storage layout」を有効にして「Done」を押して、ガイドで作られたパーティション構成を変更します。
<ul>
<li>LVMの論理ボリュームを一旦消します</li>
<li>LVMの論理ボリュームで2GBのスワップ領域を作ります</li>
<li>LVMの論理ボリュームで残りをbtrfsで作り「/」にマウントします</li>
</ul>
</li>
</ol>
<h2 id="起動時にluksのパスフレーズを入力">起動時にLUKSのパスフレーズを入力</h2>
<p>OSの起動時にVNCコンソールを起動します。以下のプロンプトが出たら、インストール時に設定したパスフレーズを入力します。</p>
<pre tabindex="0"><code>Please unlock disk dm_crypt-1:
</code></pre><p>実際にはほかのメッセージに続いて以下のように表示され、ちょっとわかりにくいので気を付けてください。</p>
<pre tabindex="0"><code>begin: mounting root file system ... Begin: Running /script/local-top ...  Please unlock disk dm_crypt-1:
</code></pre>
</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>
  </body>
</html>
