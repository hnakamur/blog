<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Vagrant 1.1.5とSaharaを試した</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2013/04/03/how-to-setup-vagrant-1-dot-1-5-and-sahara/" rel="bookmark"
           title="Permalink to Vagrant 1.1.5とSaharaを試した">Vagrant 1.1.5とSaharaを試した</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2013-04-03T00:00:00+09:00">
                Published: 2013-04-03
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/chef.html">chef</a> <a href="../../../../tag/vagrant.html">vagrant</a> <a href="../../../../tag/sahara.html">sahara</a> </p>
</footer><!-- /.post-info -->      <h2>Vagrantと1.0.xと1.1.xについて</h2>
<p>バージョン1.1.xの位置づけについては以下の記事を参照。
<a href="http://www.hashicorp.com/blog/vagrant-1-1-and-vmware.html">Vagrant 1.1, VMware Fusion - HashiCorp</a>
変更履歴は <a href="https://github.com/mitchellh/vagrant/blob/master/CHANGELOG.md">vagrant/CHANGELOG.md at master · mitchellh/vagrant · GitHub</a>。</p>
<p>gem installで入れられるのは1.0.x系のみ。現在は1.0.7。
<a href="http://rubygems.org/search?utf8=%E2%9C%93&amp;query=vagrant">search | RubyGems.org | your community gem host</a></p>
<h2>Vagrant 1.1.5のインストール</h2>
<p><a href="http://www.vagrantup.com/">Vagrant</a>
→ <a href="http://downloads.vagrantup.com/">Vagrant - Downloads</a>
→ <a href="http://downloads.vagrantup.com/tags/v1.1.5">Vagrant - Downloads v1.1.5</a>
と進み、Vagrant.dmgをダウンロードしてインストール</p>
<h2>PATH設定</h2>
<p>vagrantコマンドにPATHを通します。</p>
<div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="s1">&#39;EOF&#39;</span> <span class="o">&gt;&gt;</span> <span class="o">~/</span><span class="p">.</span><span class="n">bash_profile</span>
<span class="n">export</span> <span class="n">PATH</span><span class="o">=/</span><span class="n">Applications</span><span class="o">/</span><span class="n">Vagrant</span><span class="o">/</span><span class="n">bin</span><span class="p">:</span><span class="err">$</span><span class="n">PATH</span>
<span class="n">EOF</span>
<span class="p">.</span> <span class="o">~/</span><span class="p">.</span><span class="n">bash_profile</span>
</pre></div>


<p>ruby 1.9.3p327が同梱されています。</p>
<div class="highlight"><pre><span></span>$ /Applications/Vagrant/embedded/bin/ruby --version
ruby <span class="m">1</span>.9.3p327 <span class="o">(</span><span class="m">2012</span>-11-10 revision <span class="m">37606</span><span class="o">)</span> <span class="o">[</span>universal.x86_64-darwin12.2.1<span class="o">]</span>
</pre></div>


<h3>Vagrant 1.1.x用のSaharaをインストール</h3>
<p><a href="http://www.ryuzee.com/contents/blog/6555">Vagrantの必須プラグインSaharaをVagrant 1.1に対応させました | Ryuzee.com</a>の手順でインストール。</p>
<div class="highlight"><pre><span></span><span class="nv">mkdir</span> <span class="o">-</span><span class="nv">p</span> <span class="o">~/</span><span class="nv">src</span><span class="o">/</span><span class="nv">chef</span>
<span class="nv">cd</span> <span class="o">~/</span><span class="nv">src</span><span class="o">/</span><span class="nv">chef</span>
<span class="nv">git</span> <span class="nv">clone</span> <span class="nv">https</span>:<span class="o">//</span><span class="nv">github</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">ryuzee</span><span class="o">/</span><span class="nv">sahara</span>.<span class="nv">git</span>
<span class="nv">cd</span> <span class="nv">sahara</span>
<span class="nv">export</span> <span class="nv">PATH</span><span class="o">=/</span><span class="nv">Applications</span><span class="o">/</span><span class="nv">Vagrant</span><span class="o">/</span><span class="nv">embedded</span><span class="o">/</span><span class="nv">bin</span>:$<span class="nv">PATH</span>
<span class="nv">sudo</span> <span class="nv">gem</span> <span class="nv">install</span> <span class="nv">bundler</span>
<span class="nv">bundle</span> <span class="nv">install</span>
<span class="nv">bundle</span> <span class="k">exec</span> <span class="nv">rake</span> <span class="nv">build</span>
<span class="nv">vagrant</span> <span class="nv">plugin</span> <span class="nv">install</span> <span class="nv">pkg</span><span class="o">/</span><span class="nv">sahara</span><span class="o">-</span><span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">14</span>.<span class="nv">gem</span>
</pre></div>


<p>~/.vagrant.d/gems/gems/sahara-0.0.14/にインストールされた。</p>
<h3>複数VM環境でのテスト</h3>
<p>Vagrantfile </p>
<div class="highlight"><pre><span></span><span class="o">-*-</span> <span class="ss">mode</span><span class="p">:</span> <span class="n">ruby</span> <span class="o">-*-</span>
<span class="c1">## vi: set ft=ruby :</span>

<span class="no">Vagrant</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">private_key_path</span> <span class="o">=</span> <span class="s2">&quot;../vagrant.id_rsa&quot;</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:web1</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
    <span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos6.4&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;web1&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:hostonly</span><span class="p">,</span> <span class="s2">&quot;192.168.33.24&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">customize</span> <span class="o">[</span><span class="s2">&quot;modifyvm&quot;</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span>
      <span class="s2">&quot;--name&quot;</span><span class="p">,</span> <span class="s2">&quot;web1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;--natdnshostresolver1&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span>
      <span class="s2">&quot;--cpus&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;--memory&quot;</span><span class="p">,</span> <span class="mi">512</span>
    <span class="o">]</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:db1</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
    <span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos6.4&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">host_name</span> <span class="o">=</span> <span class="s2">&quot;db1&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:hostonly</span><span class="p">,</span> <span class="s2">&quot;192.168.33.25&quot;</span>
    <span class="n">c</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">customize</span> <span class="o">[</span><span class="s2">&quot;modifyvm&quot;</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span>
      <span class="s2">&quot;--name&quot;</span><span class="p">,</span> <span class="s2">&quot;db1&quot;</span><span class="p">,</span>
      <span class="s2">&quot;--natdnshostresolver1&quot;</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">,</span>
      <span class="s2">&quot;--cpus&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
      <span class="s2">&quot;--memory&quot;</span><span class="p">,</span> <span class="mi">512</span>
    <span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>


<p>なお、centos6.4のVMはrubyやchef-soloはインストールしていない状態になっています。</p>
<p>sandboxモードをオンにしてVM起動。</p>
<div class="highlight"><pre><span></span><span class="n">vagrant</span> <span class="n">sandbox</span> <span class="k">on</span>
<span class="n">vagrant</span> <span class="n">up</span>
</pre></div>


<p>ホスト側からchefセットアップ実行。</p>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">knife</span> <span class="n">solo</span> <span class="k">prepare</span> <span class="n">web1</span>
<span class="p">.</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">knife</span> <span class="n">solo</span> <span class="k">prepare</span> <span class="n">db1</span>
</pre></div>


<p>web1, db1にログインして/usr/bin/chef-soloが作成されたことを確認。</p>
<p>ロールバックを実行。</p>
<div class="highlight"><pre><span></span><span class="n">vagrant</span> <span class="n">sandbox</span> <span class="k">rollback</span>
</pre></div>


<p>web1, db1にログインして/usr/bin/chef-soloが無いことを確認。</p>
<p>ホスト側から再度chefセットアップ実行。</p>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">knife</span> <span class="n">solo</span> <span class="k">prepare</span> <span class="n">web1</span>
<span class="p">.</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">knife</span> <span class="n">solo</span> <span class="k">prepare</span> <span class="n">db1</span>
</pre></div>


<p>コミット実行。</p>
<div class="highlight"><pre><span></span><span class="n">vagrant</span> <span class="n">sandbox</span> <span class="k">commit</span>
</pre></div>


<p>ホスト側からchefクックブック実行。</p>
<div class="highlight"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">knife</span> <span class="n">solo</span> <span class="n">cook</span> <span class="n">web1</span>
<span class="p">.</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">knife</span> <span class="n">solo</span> <span class="n">cook</span> <span class="n">db1</span>
</pre></div>


<p>web1, db1にログインして/usr/bin/chef-soloがあること、/etc/chefが作成されたことをを確認。</p>
<p>ロールバック実行。</p>
<div class="highlight"><pre><span></span><span class="n">vagrant</span> <span class="n">sandbox</span> <span class="k">rollback</span>
</pre></div>


<p>web1, db1にログインして/usr/bin/chef-soloがあること、/etc/chefが無いことをを確認。</p>
<p>テスト環境</p>
<ul>
<li>OS: OS X 10.8.3</li>
<li>VirtualBox: 4.2.10</li>
<li>Vagrant: 1.1.5</li>
<li>sahara: https://github.com/ryuzee/sahara.git commit d22795aa417ec1cb67eb92810afb52300edd3c44</li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>