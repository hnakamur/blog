<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-JP" lang="ja-JP">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.61.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Goでdeferの処理中のエラーを返す書き方を工夫してみた &middot; hnakamur&#39;s blog at github</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog at github</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Goでdeferの処理中のエラーを返す書き方を工夫してみた</h1>
  <time datetime=2015-04-27T02:06:02&#43;0900 class="post-date">2015-04-27</time>
  <p>go-nutsのメーリングリストの記事
<a href="https://groups.google.com/d/msg/golang-nuts/qTTBENO_Em0/Y4MCVZZ3c5sJ">https://groups.google.com/d/msg/golang-nuts/qTTBENO_Em0/Y4MCVZZ3c5sJ</a>
によるとdeferで呼ばれた関数の戻り値は捨てられるそうです。
<a href="https://groups.google.com/d/msg/golang-nuts/qTTBENO_Em0/UlI77BM2PUkJ">https://groups.google.com/d/msg/golang-nuts/qTTBENO_Em0/UlI77BM2PUkJ</a>
で戻り値の変数に代入するという方法が紹介されていました。</p>
<p>これを参考に、deferでの後処理でエラーが起きた時はそのエラーを返す、ただし複数のエラーが起きた時は最初のエラーを返したいというときの書き方を考えてみました。</p>
<p>最初に書いたのは、上の記事で紹介されていたように無名関数を即時呼び出しする方式です。
<a href="https://github.com/hnakamur/cgoroonga/blob/70aafdeb2eb754505efe60afa1ae6d995831a063/examples/add_record/main.go">https://github.com/hnakamur/cgoroonga/blob/70aafdeb2eb754505efe60afa1ae6d995831a063/examples/add_record/main.go</a></p>
<pre><code>func run() (err error) {
	err = grn.Init()
	if err != nil {
		return
	}
	defer func() {
		err2 := grn.Fin()
		if err2 != nil &amp;&amp; err == nil {
			err = err2
		}
	}()

	ctx, err := grn.CtxOpen(0)
	if err != nil {
		return
	}
	defer func() {
		err2 := ctx.Close()
		if err2 != nil &amp;&amp; err == nil {
			err = err2
		}
	}()

	var db *grn.Obj
	db, err = ctx.DBOpenOrCreate(&quot;hello.db&quot;, nil)
	if err != nil {
		return
	}
	defer func() {
		err2 := ctx.ObjClose(db)
		if err2 != nil &amp;&amp; err == nil {
			err = err2
		}
	}()

	keyType := ctx.At(grn.DB_SHORT_TEXT)
	table, err := ctx.TableOpenOrCreate(&quot;table1&quot;, &quot;&quot;,
		grn.OBJ_TABLE_HASH_KEY|grn.OBJ_PERSISTENT, keyType, nil)
	if err != nil {
		return
	}
	fmt.Printf(&quot;table=%x\n&quot;, table)
	defer func() {
		err2 := ctx.ObjClose(table)
		if err2 != nil &amp;&amp; err == nil {
			err = err2
		}
	}()
…(略)…
</code></pre><p>これでやりたいことは実現できているのですが、deferのところの行数が多すぎて読みにくいコードになっています。</p>
<p>そこでこの部分を関数として定義するようにしてみました。</p>
<p><a href="https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/add_record/main.go">https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/add_record/main.go</a></p>
<pre><code>func run() (err error) {
	err = grn.Init()
	if err != nil {
		return
	}
	defer grn.FinDefer(&amp;err)

	ctx, err := grn.CtxOpen(0)
	if err != nil {
		return
	}
	defer ctx.CloseDefer(&amp;err)

	var db *grn.Obj
	db, err = ctx.DBOpenOrCreate(&quot;hello.db&quot;, nil)
	if err != nil {
		return
	}
	defer ctx.ObjCloseDefer(&amp;err, db)

	keyType := ctx.At(grn.DB_SHORT_TEXT)
	table, err := ctx.TableOpenOrCreate(&quot;table1&quot;, &quot;&quot;,
		grn.OBJ_TABLE_HASH_KEY|grn.OBJ_PERSISTENT, keyType, nil)
	if err != nil {
		return
	}
	fmt.Printf(&quot;table=%x\n&quot;, table)
	defer ctx.ObjCloseDefer(&amp;err, table)
…(略)…
</code></pre><p>関数定義は例えば <code>FinDefer</code> なら
<a href="https://github.com/hnakamur/cgoroonga/blob/master/init.go#L25-L30">https://github.com/hnakamur/cgoroonga/blob/master/init.go#L25-L30</a></p>
<pre><code>func FinDefer(err *error) {
	err2 := Fin()
	if err2 != nil &amp;&amp; *err == nil {
		*err = err2
	}
}
</code></pre><p>のようになります。他の関数も同様です。</p>
<p>書き換えた <code>run()</code> のほうが読みやすくていい感じです。</p>

</div>


    </main>

    
  </body>
</html>
