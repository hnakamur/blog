<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-JP" lang="ja-JP">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.61.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>iptablesのコードリーディング &middot; hnakamur&#39;s blog at github</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog at github</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>iptablesのコードリーディング</h1>
  <time datetime=2017-02-26T11:40:00&#43;0900 class="post-date">2017-02-26</time>
  <h2 id="heading">はじめに</h2>
<p><a href="/blog/2017/02/24/iptables-restore-code-reading/">iptables-restoreのコードリーディング</a> の続きです。</p>
<p>サーバ上の <code>iptables</code> の現状の設定が、自分が意図した設定と一致しているか確認したいというニーズがあります。
シェルスクリプトで <code>iptables</code> コマンドを順次実行する方式は大変すぎるので、 <code>iptables-restore</code> に自分の設定ファイルを渡して設定を反映させ、現在の状態は <code>iptables-save</code> で出力して、設定ファイルとこの出力を比較したらどうかと考えました。</p>
<p>しかし、この方式でもいくつか気をつける必要があります (これで全部ではないかもしれません)。</p>
<ul>
<li><code>iptables-restore</code> への入力ファイルに書いていないテーブル (<code>*</code> テーブル名 の行から <code>COMMIT</code> の行まで)も <code>iptables-save</code> では出力される。</li>
<li><code>iptables-restore</code> への入力ファイルで複数のテーブルを指定した場合、 <code>iptables-save</code> では特定の順序で出力される。</li>
<li><code>iptables-restore</code> への入力ファイルにコメント行(<code>#</code> で始まる行)を含めていても、 <code>iptables-save</code> では出力されない。</li>
<li><code>iptables-save</code> ではテーブルの前後に <code># Generated by iptables-save v1.4.21 on Sun Feb 26 03:40:03 2017</code> と <code># Completed on Sun Feb 26 03:40:03 2017</code> のようなコメント行が出力される。</li>
<li>チェーン (<code>:</code> で始まる行) のカウンタ (<code>[整数:整数]</code>) の値は <code>iptables-restore</code> への入力ファイルと <code>iptables-save</code> の出力ではほとんどのケースは一致しない。 <code>iptables-restore</code> 実行時から <code>iptables-save</code> 実行時までにそのチェーンでパケットを処理していなければ一致するが、設定直後に確認するケースを除いてたいていは一致しないことになる。</li>
<li>既に追加したルールセットの途中に <code>-I</code> でルールを追加すると、 <code>iptables-save</code> ではソートされた <code>-A</code> のリストとして出力される。</li>
<li>1つのコマンド内で複数の引数の順序は任意に指定可能だが、 <code>iptables-save</code> では特定の順番で出力される。</li>
<li><code>--destination-port</code> と <code>-dport</code> のように同一のオプションに2通りの書き方（シノニム）が用意されているものがある。</li>
<li><code>--tcp-flags</code> の値に <code>ALL</code> を指定すると、 <code>iptables-save</code> では <code>FIN,SYN,RST,PSH,ACK,URG</code> に展開される。</li>
<li><code>--tcp-flags</code> の値に複数の値を指定した場合、 <code>iptables-save</code> では特定の順番で出力される。</li>
<li><code>--syn</code> を指定すると、 <code>iptables-save</code> では <code>--tcp-flags FIN,SYN,RST,ACK SYN</code> に展開される。</li>
<li><code>--src</code> や <code>--destination</code> に <code>0.0.0.0/0</code> を指定した場合、 <code>iptables-save</code> では出力が省略される。</li>
</ul>
<p>以下に例を示します。</p>
<pre><code class="language-console" data-lang="console">[root@centos7 iptables-experiment]# cat iptables.conf
*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
# this comment will not be printed with iptables-save
-A INPUT -p tcp -m tcp --tcp-flags ALL NONE -j DROP
-A INPUT -p tcp -m tcp ! --syn -m state --state NEW -j DROP
-A INPUT -p tcp -m tcp --tcp-flags ALL ALL -j DROP
-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -p tcp -m tcp --destination 0.0.0.0/0 --dport 443 -j ACCEPT
-I INPUT 7 -p tcp -m tcp --src 0.0.0.0/0 --destination-port 80 -j ACCEPT
-I INPUT 7 -p tcp -m tcp --src 192.168.0.0/24 --destination-port 22 -j ACCEPT
COMMIT
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
[root@centos7 iptables-experiment]# iptables-restore &lt; iptables.conf
</code></pre><p>.. code-block:: console
:linenos: table</p>
<pre><code>[root@centos7 iptables-experiment]# iptables-save
# Generated by iptables-save v1.4.21 on Sun Feb 26 03:40:03 2017
*mangle
:PREROUTING ACCEPT [2:668]
:INPUT ACCEPT [2:668]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [2:656]
:POSTROUTING ACCEPT [2:656]
COMMIT
# Completed on Sun Feb 26 03:40:03 2017
# Generated by iptables-save v1.4.21 on Sun Feb 26 03:40:03 2017
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
COMMIT
# Completed on Sun Feb 26 03:40:03 2017
# Generated by iptables-save v1.4.21 on Sun Feb 26 03:40:03 2017
*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP
-A INPUT -p tcp -m tcp ! --tcp-flags FIN,SYN,RST,ACK SYN -m state --state NEW -j DROP
-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,PSH,ACK,URG -j DROP
-A INPUT -i lo -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -s 192.168.0.0/24 -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
COMMIT
# Completed on Sun Feb 26 03:40:03 2017
</code></pre>
<h2 id="synonym">synonymで検索した結果</h2>
<p>なお、 IPv6 関連は省略しています。</p>
<p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n29">extensions/libxt_tcp.c#L29-#L38</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">tcp_opts</span><span class="p">[</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">source-port</span><span class="s">&#34;</span><span class="p">,</span>      <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">1</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">sport</span><span class="s">&#34;</span><span class="p">,</span>            <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">1</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span> <span class="cm">/* synonym */</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">destination-port</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">2</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">dport</span><span class="s">&#34;</span><span class="p">,</span>            <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">2</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span> <span class="cm">/* synonym */</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">syn</span><span class="s">&#34;</span><span class="p">,</span>              <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">3</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">tcp-flags</span><span class="s">&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">4</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">tcp-option</span><span class="s">&#34;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>  <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">5</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="n">XT_GETOPT_TABLEEND</span><span class="p">,</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n76">iptables/iptables.c#L76-#L114</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">struct</span> <span class="n">option</span> <span class="n">original_opts</span><span class="p">[</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">append</span><span class="s">&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">A</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">delete</span><span class="s">&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">D</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">check</span><span class="s">&#34;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">C</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">insert</span><span class="s">&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">I</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">replace</span><span class="s">&#34;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">R</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">list</span><span class="s">&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">L</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">list-rules</span><span class="s">&#34;</span><span class="p">,</span>    <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">S</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">flush</span><span class="s">&#34;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">F</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">zero</span><span class="s">&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">Z</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">new-chain</span><span class="s">&#34;</span><span class="p">,</span>     <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">N</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">delete-chain</span><span class="s">&#34;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">X</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">rename-chain</span><span class="s">&#34;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">E</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">policy</span><span class="s">&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">P</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">source</span><span class="s">&#34;</span><span class="p">,</span>        <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">s</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">destination</span><span class="s">&#34;</span><span class="p">,</span>   <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">d</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">src</span><span class="s">&#34;</span><span class="p">,</span>           <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">s</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span> <span class="cm">/* synonym */</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">dst</span><span class="s">&#34;</span><span class="p">,</span>           <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">d</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span> <span class="cm">/* synonym */</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">protocol</span><span class="s">&#34;</span><span class="p">,</span>      <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">p</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">in-interface</span><span class="s">&#34;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">i</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">jump</span><span class="s">&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">j</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">table</span><span class="s">&#34;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">t</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">match</span><span class="s">&#34;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">m</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">numeric</span><span class="s">&#34;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">n</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">out-interface</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">o</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">verbose</span><span class="s">&#34;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">v</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">wait</span><span class="s">&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">w</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">exact</span><span class="s">&#34;</span><span class="p">,</span>         <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">fragments</span><span class="s">&#34;</span><span class="p">,</span>     <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">f</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">version</span><span class="s">&#34;</span><span class="p">,</span>       <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">V</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">help</span><span class="s">&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">h</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">line-numbers</span><span class="s">&#34;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">0</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">modprobe</span><span class="s">&#34;</span><span class="p">,</span>      <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">M</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">set-counters</span><span class="s">&#34;</span><span class="p">,</span>  <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">c</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">goto</span><span class="s">&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">g</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">ipv4</span><span class="s">&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">4</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">ipv6</span><span class="s">&#34;</span><span class="p">,</span>          <span class="p">.</span><span class="n">has_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">6</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
	<span class="p">{</span><span class="nb">NULL</span><span class="p">}</span><span class="p">,</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>tcp_opts</code> の参照箇所
^^^^^^^^^^^^^^^^^^^^^^^</p>
<p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n365">extensions/libxt_tcp.c#L365-#L383</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">struct</span> <span class="n">xtables_match</span> <span class="n">tcp_match</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">family</span>		<span class="o">=</span> <span class="n">NFPROTO_UNSPEC</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">tcp</span><span class="s">&#34;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">version</span>	<span class="o">=</span> <span class="n">XTABLES_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="n">XT_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_tcp</span><span class="p">)</span><span class="p">)</span><span class="p">,</span>
	<span class="p">.</span><span class="n">userspacesize</span>	<span class="o">=</span> <span class="n">XT_ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xt_tcp</span><span class="p">)</span><span class="p">)</span><span class="p">,</span>
	<span class="p">.</span><span class="n">help</span>		<span class="o">=</span> <span class="n">tcp_help</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>		<span class="o">=</span> <span class="n">tcp_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">parse</span>		<span class="o">=</span> <span class="n">tcp_parse</span><span class="p">,</span>
	<span class="p">.</span><span class="n">print</span>		<span class="o">=</span> <span class="n">tcp_print</span><span class="p">,</span>
	<span class="p">.</span><span class="n">save</span>		<span class="o">=</span> <span class="n">tcp_save</span><span class="p">,</span>
	<span class="p">.</span><span class="n">extra_opts</span>	<span class="o">=</span> <span class="n">tcp_opts</span><span class="p">,</span>
<span class="p">}</span><span class="p">;</span>

<span class="kt">void</span>
<span class="nf">_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xtables_register_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcp_match</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libxtables/xtables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n821">libxtables/xtables.c#L821-#L861</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">821
</span><span class="lnt">822
</span><span class="lnt">823
</span><span class="lnt">824
</span><span class="lnt">825
</span><span class="lnt">826
</span><span class="lnt">827
</span><span class="lnt">828
</span><span class="lnt">829
</span><span class="lnt">830
</span><span class="lnt">831
</span><span class="lnt">832
</span><span class="lnt">833
</span><span class="lnt">834
</span><span class="lnt">835
</span><span class="lnt">836
</span><span class="lnt">837
</span><span class="lnt">838
</span><span class="lnt">839
</span><span class="lnt">840
</span><span class="lnt">841
</span><span class="lnt">842
</span><span class="lnt">843
</span><span class="lnt">844
</span><span class="lnt">845
</span><span class="lnt">846
</span><span class="lnt">847
</span><span class="lnt">848
</span><span class="lnt">849
</span><span class="lnt">850
</span><span class="lnt">851
</span><span class="lnt">852
</span><span class="lnt">853
</span><span class="lnt">854
</span><span class="lnt">855
</span><span class="lnt">856
</span><span class="lnt">857
</span><span class="lnt">858
</span><span class="lnt">859
</span><span class="lnt">860
</span><span class="lnt">861
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">xtables_register_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">xtables_match</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">version</span> <span class="o">=</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">%s: match %s&lt;%u&gt; is missing a version</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
		        <span class="n">xt_params</span><span class="o">-</span><span class="o">&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">revision</span><span class="p">)</span><span class="p">;</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">XTABLES_VERSION</span><span class="p">)</span> <span class="o">!</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">%s: match </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> has version </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s">, </span><span class="s">&#34;</span>
		        <span class="sa"></span><span class="s">&#34;</span><span class="s">but </span><span class="se">\&#34;</span><span class="s">%s</span><span class="se">\&#34;</span><span class="s"> is required.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
			<span class="n">xt_params</span><span class="o">-</span><span class="o">&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">XTABLES_VERSION</span><span class="p">)</span><span class="p">;</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">XT_EXTENSION_MAXNAMELEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">%s: match `%s&#39; has invalid name</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
			<span class="n">xt_params</span><span class="o">-</span><span class="o">&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">)</span><span class="p">;</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">family</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">NPROTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
			<span class="sa"></span><span class="s">&#34;</span><span class="s">%s: BUG: match %s has invalid protocol family</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
			<span class="n">xt_params</span><span class="o">-</span><span class="o">&gt;</span><span class="n">program_name</span><span class="p">,</span> <span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">)</span><span class="p">;</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">x6_options</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">xtables_option_metavalidate</span><span class="p">(</span><span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">x6_options</span><span class="p">)</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">extra_opts</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">xtables_check_options</span><span class="p">(</span><span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">extra_opts</span><span class="p">)</span><span class="p">;</span>

	<span class="cm">/* ignore not interested match */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">family</span> <span class="o">!</span><span class="o">=</span> <span class="n">afinfo</span><span class="o">-</span><span class="o">&gt;</span><span class="n">family</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">family</span> <span class="o">!</span><span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* place on linked list of matches pending full registration */</span>
	<span class="n">me</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">xtables_pending_matches</span><span class="p">;</span>
	<span class="n">xtables_pending_matches</span> <span class="o">=</span> <span class="n">me</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/libxtables/xtables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n810">libxtables/xtables.c#L810-#L819</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">810
</span><span class="lnt">811
</span><span class="lnt">812
</span><span class="lnt">813
</span><span class="lnt">814
</span><span class="lnt">815
</span><span class="lnt">816
</span><span class="lnt">817
</span><span class="lnt">818
</span><span class="lnt">819
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">xtables_check_options</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">option</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="p">;</span> <span class="n">opt</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="o">+</span><span class="o">+</span><span class="n">opt</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opt</span><span class="o">-</span><span class="o">&gt;</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">|</span><span class="o">|</span> <span class="n">opt</span><span class="o">-</span><span class="o">&gt;</span><span class="n">val</span> <span class="o">&gt;</span><span class="o">=</span> <span class="n">XT_OPTION_OFFSET_SCALE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">%s: Extension %s uses invalid </span><span class="s">&#34;</span>
			        <span class="sa"></span><span class="s">&#34;</span><span class="s">option value %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">xt_params</span><span class="o">-</span><span class="o">&gt;</span><span class="n">program_name</span><span class="p">,</span>
			        <span class="n">name</span><span class="p">,</span> <span class="n">opt</span><span class="o">-</span><span class="o">&gt;</span><span class="n">val</span><span class="p">)</span><span class="p">;</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="p">;</span>
		<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>original_opts</code> の参照箇所
^^^^^^^^^^^^^^^^^^^^^^^^^^^^</p>
<p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n118">iptables/iptables.c#L118-#L123</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">xtables_globals</span> <span class="n">iptables_globals</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">option_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">program_version</span> <span class="o">=</span> <span class="n">IPTABLES_VERSION</span><span class="p">,</span>
	<span class="p">.</span><span class="n">orig_opts</span> <span class="o">=</span> <span class="n">original_opts</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit_err</span> <span class="o">=</span> <span class="n">iptables_exit_error</span><span class="p">,</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>iptables_globals.orig_opts</code> の参照箇所のうちの1つ。</p>
<p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n1300">iptables/iptables.c#L1300-#L1306</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1300
</span><span class="lnt">1301
</span><span class="lnt">1302
</span><span class="lnt">1303
</span><span class="lnt">1304
</span><span class="lnt">1305
</span><span class="lnt">1306
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* Merge options for non-cloned matches */</span>
<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="o">&gt;</span><span class="n">x6_options</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="n">opts</span> <span class="o">=</span> <span class="n">xtables_options_xfrm</span><span class="p">(</span><span class="n">iptables_globals</span><span class="p">.</span><span class="n">orig_opts</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span>
				    <span class="n">m</span><span class="o">-</span><span class="o">&gt;</span><span class="n">x6_options</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-</span><span class="o">&gt;</span><span class="n">option_offset</span><span class="p">)</span><span class="p">;</span>
<span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="o">&gt;</span><span class="n">extra_opts</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="n">opts</span> <span class="o">=</span> <span class="n">xtables_merge_options</span><span class="p">(</span><span class="n">iptables_globals</span><span class="p">.</span><span class="n">orig_opts</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span>
				     <span class="n">m</span><span class="o">-</span><span class="o">&gt;</span><span class="n">extra_opts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="o">-</span><span class="o">&gt;</span><span class="n">option_offset</span><span class="p">)</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n171">iptables/iptables.c#L171</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">171
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#</span><span class="cp">define opts iptables_globals.opts</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="equivalent">equivalentで検索した結果</h2>
<p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n12">extensions/libxt_tcp.c#L12-#L27</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">void</span> <span class="nf">tcp_help</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printf</span><span class="p">(</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s">tcp match options:</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s">[!] --tcp-flags mask comp	match when TCP flags &amp; mask == comp</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s">				(Flags: SYN ACK FIN RST URG PSH ALL NONE)</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s">[!] --syn			match when only SYN flag set</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s">				(equivalent to --tcp-flags SYN,RST,ACK,FIN SYN)</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s">[!] --source-port port[:port]</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s"> --sport ...</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s">				match source port(s)</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s">[!] --destination-port port[:port]</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s"> --dport ...</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s">				match destination port(s)</span><span class="se">\n</span><span class="s">&#34;</span>
<span class="sa"></span><span class="s">&#34;</span><span class="s">[!] --tcp-option number        match if TCP option set</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="heading-1">コマンドとオプションの有効な組み合わせ</h2>
<p><a href="https://git.netfilter.org/iptables/tree/iptables/iptables.c?id=482c6d3731e2681cb4baae835c294840300197e6#n125">iptables/iptables.c#L125-#L169</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/* Table of legal combinations of commands and options.  If any of the
</span><span class="cm"> * given commands make an option legal, that option is legal (applies to
</span><span class="cm"> * CMD_LIST and CMD_ZERO only).
</span><span class="cm"> * Key:
</span><span class="cm"> *  +  compulsory
</span><span class="cm"> *  x  illegal
</span><span class="cm"> *     optional
</span><span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">commands_v_options</span><span class="p">[</span><span class="n">NUMBER_OF_CMD</span><span class="p">]</span><span class="p">[</span><span class="n">NUMBER_OF_OPT</span><span class="p">]</span> <span class="o">=</span>
<span class="cm">/* Well, it&#39;s better than &#34;Re: Linux vs FreeBSD&#34; */</span>
<span class="p">{</span>
	<span class="cm">/*     -n  -s  -d  -p  -j  -v  -x  -i  -o --line -c -f */</span>
<span class="cm">/*INSERT*/</span>    <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*DELETE*/</span>    <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*DELETE_NUM*/</span><span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*REPLACE*/</span>   <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*APPEND*/</span>    <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*LIST*/</span>      <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*FLUSH*/</span>     <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*ZERO*/</span>      <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*NEW_CHAIN*/</span> <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*DEL_CHAIN*/</span> <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*SET_POLICY*/</span><span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*RENAME*/</span>    <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*LIST_RULES*/</span><span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*ZERO_NUM*/</span>  <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="cm">/*CHECK*/</span>     <span class="p">{</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc">x</span><span class="sc">&#39;</span><span class="p">,</span><span class="sa"></span><span class="sc">&#39;</span><span class="sc"> </span><span class="sc">&#39;</span><span class="p">}</span><span class="p">,</span>
<span class="p">}</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">inverse_for_options</span><span class="p">[</span><span class="n">NUMBER_OF_OPT</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
<span class="cm">/* -n */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -s */</span> <span class="n">IPT_INV_SRCIP</span><span class="p">,</span>
<span class="cm">/* -d */</span> <span class="n">IPT_INV_DSTIP</span><span class="p">,</span>
<span class="cm">/* -p */</span> <span class="n">XT_INV_PROTO</span><span class="p">,</span>
<span class="cm">/* -j */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -v */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -x */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -i */</span> <span class="n">IPT_INV_VIA_IN</span><span class="p">,</span>
<span class="cm">/* -o */</span> <span class="n">IPT_INV_VIA_OUT</span><span class="p">,</span>
<span class="cm">/*--line*/</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -c */</span> <span class="mi">0</span><span class="p">,</span>
<span class="cm">/* -f */</span> <span class="n">IPT_INV_FRAG</span><span class="p">,</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="tcp-flags-"><code>tcp-flags</code> の値定義</h2>
<p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n63">extensions/libxt_tcp.c#L63-#L77</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">tcp_flag_names</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_flag_names</span> <span class="n">tcp_flag_names</span><span class="p">[</span><span class="p">]</span>
<span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">FIN</span><span class="s">&#34;</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">}</span><span class="p">,</span>
    <span class="p">{</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">SYN</span><span class="s">&#34;</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">}</span><span class="p">,</span>
    <span class="p">{</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">RST</span><span class="s">&#34;</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">}</span><span class="p">,</span>
    <span class="p">{</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">PSH</span><span class="s">&#34;</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">}</span><span class="p">,</span>
    <span class="p">{</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">ACK</span><span class="s">&#34;</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">}</span><span class="p">,</span>
    <span class="p">{</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">URG</span><span class="s">&#34;</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">}</span><span class="p">,</span>
    <span class="p">{</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">ALL</span><span class="s">&#34;</span><span class="p">,</span> <span class="mh">0x3F</span> <span class="p">}</span><span class="p">,</span>
    <span class="p">{</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">NONE</span><span class="s">&#34;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span><span class="p">,</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>strcasecmp</code> で大文字小文字無視で比較していました。
<a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n79">extensions/libxt_tcp.c#L79-#L102</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">parse_tcp_flag</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">,</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span> <span class="n">ptr</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">strtok</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">,</span><span class="s">&#34;</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tcp_flag_names</span><span class="p">)</span><span class="p">;</span> <span class="o">+</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">tcp_flag_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span> <span class="o">=</span><span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">|</span><span class="o">=</span> <span class="n">tcp_flag_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">.</span><span class="n">flag</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span><span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tcp_flag_names</span><span class="p">)</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="sa"></span><span class="s">&#34;</span><span class="s">Unknown TCP flag `%s&#39;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">)</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">free</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="--dports-"><code>--dports</code> などの値定義</h2>
<p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n135">extensions/libxt_tcp.c#L135-#L138</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#</span><span class="cp">define TCP_SRC_PORTS 0x01</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define TCP_DST_PORTS 0x02</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define TCP_FLAGS 0x04</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define TCP_OPTION	0x08</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><p><a href="https://git.netfilter.org/iptables/tree/extensions/libxt_tcp.c?id=482c6d3731e2681cb4baae835c294840300197e6#n140">extensions/libxt_tcp.c#L140-#L204</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="kt">int</span>
<span class="nf">tcp_parse</span><span class="p">(</span><span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="o">*</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">invert</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
          <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xt_entry_match</span> <span class="o">*</span><span class="o">*</span><span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xt_tcp</span> <span class="o">*</span><span class="n">tcpinfo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xt_tcp</span> <span class="o">*</span><span class="p">)</span><span class="p">(</span><span class="o">*</span><span class="n">match</span><span class="p">)</span><span class="o">-</span><span class="o">&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">1</span><span class="sc">&#39;</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_SRC_PORTS</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="sa"></span><span class="s">&#34;</span><span class="s">Only one `--source-port&#39; allowed</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
		<span class="n">parse_tcp_ports</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">tcpinfo</span><span class="o">-</span><span class="o">&gt;</span><span class="n">spts</span><span class="p">)</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
			<span class="n">tcpinfo</span><span class="o">-</span><span class="o">&gt;</span><span class="n">invflags</span> <span class="o">|</span><span class="o">=</span> <span class="n">XT_TCP_INV_SRCPT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|</span><span class="o">=</span> <span class="n">TCP_SRC_PORTS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">2</span><span class="sc">&#39;</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_DST_PORTS</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="sa"></span><span class="s">&#34;</span><span class="s">Only one `--destination-port&#39; allowed</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
		<span class="n">parse_tcp_ports</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="n">tcpinfo</span><span class="o">-</span><span class="o">&gt;</span><span class="n">dpts</span><span class="p">)</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
			<span class="n">tcpinfo</span><span class="o">-</span><span class="o">&gt;</span><span class="n">invflags</span> <span class="o">|</span><span class="o">=</span> <span class="n">XT_TCP_INV_DSTPT</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|</span><span class="o">=</span> <span class="n">TCP_DST_PORTS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">3</span><span class="sc">&#39;</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_FLAGS</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="sa"></span><span class="s">&#34;</span><span class="s">Only one of `--syn&#39; or `--tcp-flags&#39; </span><span class="s">&#34;</span>
				   <span class="sa"></span><span class="s">&#34;</span><span class="s"> allowed</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
		<span class="n">parse_tcp_flags</span><span class="p">(</span><span class="n">tcpinfo</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">SYN,RST,ACK,FIN</span><span class="s">&#34;</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">SYN</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">invert</span><span class="p">)</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|</span><span class="o">=</span> <span class="n">TCP_FLAGS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">4</span><span class="sc">&#39;</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_FLAGS</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="sa"></span><span class="s">&#34;</span><span class="s">Only one of `--syn&#39; or `--tcp-flags&#39; </span><span class="s">&#34;</span>
				   <span class="sa"></span><span class="s">&#34;</span><span class="s"> allowed</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">]</span>
		    <span class="o">|</span><span class="o">|</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span><span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">-</span><span class="sc">&#39;</span> <span class="o">|</span><span class="o">|</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">]</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span><span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">!</span><span class="sc">&#39;</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="sa"></span><span class="s">&#34;</span><span class="s">--tcp-flags requires two args.</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>

		<span class="n">parse_tcp_flags</span><span class="p">(</span><span class="n">tcpinfo</span><span class="p">,</span> <span class="n">optarg</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">optind</span><span class="p">]</span><span class="p">,</span>
				<span class="n">invert</span><span class="p">)</span><span class="p">;</span>
		<span class="n">optind</span><span class="o">+</span><span class="o">+</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|</span><span class="o">=</span> <span class="n">TCP_FLAGS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">5</span><span class="sc">&#39;</span><span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">TCP_OPTION</span><span class="p">)</span>
			<span class="n">xtables_error</span><span class="p">(</span><span class="n">PARAMETER_PROBLEM</span><span class="p">,</span>
				   <span class="sa"></span><span class="s">&#34;</span><span class="s">Only one `--tcp-option&#39; allowed</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
		<span class="n">parse_tcp_option</span><span class="p">(</span><span class="n">optarg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcpinfo</span><span class="o">-</span><span class="o">&gt;</span><span class="n">option</span><span class="p">)</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span>
			<span class="n">tcpinfo</span><span class="o">-</span><span class="o">&gt;</span><span class="n">invflags</span> <span class="o">|</span><span class="o">=</span> <span class="n">XT_TCP_INV_OPTION</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|</span><span class="o">=</span> <span class="n">TCP_OPTION</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div>
</div>


    </main>

    
  </body>
</html>
