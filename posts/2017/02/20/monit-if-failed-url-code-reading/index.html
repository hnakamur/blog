<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-JP" lang="ja-JP">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.61.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>monitのif failed urlのコードリーディング &middot; hnakamur&#39;s blog at github</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog at github</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>monitのif failed urlのコードリーディング</h1>
  <time datetime=2017-02-20T11:14:00&#43;0900 class="post-date">2017-02-20</time>
  <h2 id="heading">はじめに</h2>
<p>以下のページで紹介されているような <code>if failed url ...</code> の挙動をコードリーディングしてみたメモです。</p>
<ul>
<li><a href="https://fak3r.com/2010/04/10/howto-use-monit-to-monitor-sites-and-alert-users/">HOWTO use monit to monitor sites and alert users · fak3r</a></li>
<li><a href="http://d.hatena.ne.jp/akishin999/20121030/1351555542">Monit でお手軽に外部のサーバを監視する - akishin999の日記</a></li>
</ul>
<pre><code class="language-console" data-lang="console">check host fak3r.com with address fak3r.com
if failed url http://fak3r.com
timeout 10 seconds for 1 cycles then alert
then alert
</code></pre><p>コードリーディングの対象のmonitのバージョンは5.11.0です。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/?at=release-5-11-0">monit 5.11.0のソースコード</a></p>
<h2 id="if-failed-url">if failed urlの設定ファイルの文法</h2>
<p><a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-1009:1029">src/p.y#L1009-L1029</a></p>
<p><code>connection</code> の文法定義。</p>
<pre><code class="language-yacc" data-lang="yacc">connection      : IF FAILED host port type protocol urloption nettimeout retry rate1
                  THEN action1 recovery {
                    portset.timeout = $&lt;number&gt;8;
                    portset.retry = $&lt;number&gt;9;
                    /* This is a workaround to support content match without having to create
                     an URL object. 'urloption' creates the Request_T object we need minus the
                     URL object, but with enough information to perform content test. 
                     TODO: Parser is in need of refactoring */
                    portset.url_request = urlrequest;
                    addeventaction(&amp;(portset).action, $&lt;number&gt;12, $&lt;number&gt;13);
                    addport(&amp;portset);
                  }
                | IF FAILED URL URLOBJECT urloption nettimeout retry rate1
                  THEN action1 recovery {
                    prepare_urlrequest($&lt;url&gt;4);
                    portset.timeout = $&lt;number&gt;6;
                    portset.retry = $&lt;number&gt;7;
                    addeventaction(&amp;(portset).action, $&lt;number&gt;10, $&lt;number&gt;11);
                    addport(&amp;portset);
                  }
                ;
</code></pre><p><code>nettimeout</code> の文法定義。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-1421:1427">src/p.y#L1421-L1427</a></p>
<pre><code class="language-yacc" data-lang="yacc">nettimeout      : /* EMPTY */ {
                   $&lt;number&gt;$ = NET_TIMEOUT; // timeout is in milliseconds
                  }
                | TIMEOUT NUMBER SECOND {
                   $&lt;number&gt;$ = $2 * 1000; // net timeout is in milliseconds internally
                  }
                ;
</code></pre><p><code>NET_TIMEOUT</code> の定義。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/net.h?at=release-5-11-0&amp;fileviewer=file-view-default#net.h-40:44">src/net.h#L40-L44</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/**
</span><span class="cm"> * Standard milliseconds to wait for a socket connection or for socket read
</span><span class="cm"> * i/o before aborting
</span><span class="cm"> */</span>
<span class="cp">#</span><span class="cp">define NET_TIMEOUT 5000</span><span class="cp">
</span></code></pre></td></tr></table>
</div>
</div><p>ということで <code>if failed url ...</code> のデフォルトのタイムアウトは 5秒。</p>
<p><code>retry</code> の文法定義。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-1429:1435">src/p.y#L1429-L1435</a></p>
<pre><code class="language-yacc" data-lang="yacc">retry           : /* EMPTY */ {
                   $&lt;number&gt;$ = 1;
                  }
                | RETRY NUMBER {
                   $&lt;number&gt;$ = $2;
                  }
                ;
</code></pre><p>デフォルトのリトライ回数は1。</p>
<p><code>rate1</code> の文法定義。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-1765:1780">src/p.y#L1765-L1780</a></p>
<pre><code class="language-yacc" data-lang="yacc">rate1           : /* EMPTY */
                | NUMBER CYCLE {
                    rate1.count  = $&lt;number&gt;1;
                    rate1.cycles = $&lt;number&gt;1;
                    if (rate1.cycles &lt; 1 || rate1.cycles &gt; BITMAP_MAX)
                      yyerror2(&quot;The number of cycles must be between 1 and %d&quot;, BITMAP_MAX);
                  }
                | NUMBER NUMBER CYCLE {
                    rate1.count  = $&lt;number&gt;1;
                    rate1.cycles = $&lt;number&gt;2;
                    if (rate1.cycles &lt; 1 || rate1.cycles &gt; BITMAP_MAX)
                      yyerror2(&quot;The number of cycles must be between 1 and %d&quot;, BITMAP_MAX);
                    if (rate1.count &lt; 1 || rate1.count &gt; rate1.cycles)
                      yyerror2(&quot;The number of events must be bigger then 0 and less than poll cycles&quot;);
                  }
                ;
</code></pre><p><code>rate1</code> の変数定義
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-186">src/p.y#L186</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">186
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="k">struct</span> <span class="n">myrate</span> <span class="n">rate1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>myrate</code> 構造体の定義。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-132:135">src/p.y#L132-L135</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">myrate</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="n">count</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">cycles</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>addeventaction</code> 関数の実装。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-3116:3147">src/p.y#L3116-L3147</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">3116
</span><span class="lnt">3117
</span><span class="lnt">3118
</span><span class="lnt">3119
</span><span class="lnt">3120
</span><span class="lnt">3121
</span><span class="lnt">3122
</span><span class="lnt">3123
</span><span class="lnt">3124
</span><span class="lnt">3125
</span><span class="lnt">3126
</span><span class="lnt">3127
</span><span class="lnt">3128
</span><span class="lnt">3129
</span><span class="lnt">3130
</span><span class="lnt">3131
</span><span class="lnt">3132
</span><span class="lnt">3133
</span><span class="lnt">3134
</span><span class="lnt">3135
</span><span class="lnt">3136
</span><span class="lnt">3137
</span><span class="lnt">3138
</span><span class="lnt">3139
</span><span class="lnt">3140
</span><span class="lnt">3141
</span><span class="lnt">3142
</span><span class="lnt">3143
</span><span class="lnt">3144
</span><span class="lnt">3145
</span><span class="lnt">3146
</span><span class="lnt">3147
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * Set EventAction object
</span><span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">addeventaction</span><span class="p">(</span><span class="n">EventAction_T</span> <span class="o">*</span><span class="n">_ea</span><span class="p">,</span> <span class="kt">int</span> <span class="n">failed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">succeeded</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">EventAction_T</span> <span class="n">ea</span><span class="p">;</span>

  <span class="n">ASSERT</span><span class="p">(</span><span class="n">_ea</span><span class="p">)</span><span class="p">;</span>

  <span class="n">NEW</span><span class="p">(</span><span class="n">ea</span><span class="p">)</span><span class="p">;</span>
  <span class="n">NEW</span><span class="p">(</span><span class="n">ea</span><span class="o">-</span><span class="o">&gt;</span><span class="n">failed</span><span class="p">)</span><span class="p">;</span>
  <span class="n">NEW</span><span class="p">(</span><span class="n">ea</span><span class="o">-</span><span class="o">&gt;</span><span class="n">succeeded</span><span class="p">)</span><span class="p">;</span>

  <span class="n">ea</span><span class="o">-</span><span class="o">&gt;</span><span class="n">failed</span><span class="o">-</span><span class="o">&gt;</span><span class="n">id</span>     <span class="o">=</span> <span class="n">failed</span><span class="p">;</span>
  <span class="n">ea</span><span class="o">-</span><span class="o">&gt;</span><span class="n">failed</span><span class="o">-</span><span class="o">&gt;</span><span class="n">count</span>  <span class="o">=</span> <span class="n">rate1</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
  <span class="n">ea</span><span class="o">-</span><span class="o">&gt;</span><span class="n">failed</span><span class="o">-</span><span class="o">&gt;</span><span class="n">cycles</span> <span class="o">=</span> <span class="n">rate1</span><span class="p">.</span><span class="n">cycles</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">failed</span> <span class="o">=</span><span class="o">=</span> <span class="n">ACTION_EXEC</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">command1</span><span class="p">)</span><span class="p">;</span>
    <span class="n">ea</span><span class="o">-</span><span class="o">&gt;</span><span class="n">failed</span><span class="o">-</span><span class="o">&gt;</span><span class="n">exec</span> <span class="o">=</span> <span class="n">command1</span><span class="p">;</span>
    <span class="n">command1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">ea</span><span class="o">-</span><span class="o">&gt;</span><span class="n">succeeded</span><span class="o">-</span><span class="o">&gt;</span><span class="n">id</span>     <span class="o">=</span> <span class="n">succeeded</span><span class="p">;</span>
  <span class="n">ea</span><span class="o">-</span><span class="o">&gt;</span><span class="n">succeeded</span><span class="o">-</span><span class="o">&gt;</span><span class="n">count</span>  <span class="o">=</span> <span class="n">rate2</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
  <span class="n">ea</span><span class="o">-</span><span class="o">&gt;</span><span class="n">succeeded</span><span class="o">-</span><span class="o">&gt;</span><span class="n">cycles</span> <span class="o">=</span> <span class="n">rate2</span><span class="p">.</span><span class="n">cycles</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">succeeded</span> <span class="o">=</span><span class="o">=</span> <span class="n">ACTION_EXEC</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">command2</span><span class="p">)</span><span class="p">;</span>
    <span class="n">ea</span><span class="o">-</span><span class="o">&gt;</span><span class="n">succeeded</span><span class="o">-</span><span class="o">&gt;</span><span class="n">exec</span> <span class="o">=</span> <span class="n">command2</span><span class="p">;</span>
    <span class="n">command2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="o">*</span><span class="n">_ea</span> <span class="o">=</span> <span class="n">ea</span><span class="p">;</span>
  <span class="n">reset_rateset</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>addport</code> 関数の実装。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/p.y?at=release-5-11-0&amp;fileviewer=file-view-default#p.y-2543:2602">src/p.y#L2543-L2602</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">2543
</span><span class="lnt">2544
</span><span class="lnt">2545
</span><span class="lnt">2546
</span><span class="lnt">2547
</span><span class="lnt">2548
</span><span class="lnt">2549
</span><span class="lnt">2550
</span><span class="lnt">2551
</span><span class="lnt">2552
</span><span class="lnt">2553
</span><span class="lnt">2554
</span><span class="lnt">2555
</span><span class="lnt">2556
</span><span class="lnt">2557
</span><span class="lnt">2558
</span><span class="lnt">2559
</span><span class="lnt">2560
</span><span class="lnt">2561
</span><span class="lnt">2562
</span><span class="lnt">2563
</span><span class="lnt">2564
</span><span class="lnt">2565
</span><span class="lnt">2566
</span><span class="lnt">2567
</span><span class="lnt">2568
</span><span class="lnt">2569
</span><span class="lnt">2570
</span><span class="lnt">2571
</span><span class="lnt">2572
</span><span class="lnt">2573
</span><span class="lnt">2574
</span><span class="lnt">2575
</span><span class="lnt">2576
</span><span class="lnt">2577
</span><span class="lnt">2578
</span><span class="lnt">2579
</span><span class="lnt">2580
</span><span class="lnt">2581
</span><span class="lnt">2582
</span><span class="lnt">2583
</span><span class="lnt">2584
</span><span class="lnt">2585
</span><span class="lnt">2586
</span><span class="lnt">2587
</span><span class="lnt">2588
</span><span class="lnt">2589
</span><span class="lnt">2590
</span><span class="lnt">2591
</span><span class="lnt">2592
</span><span class="lnt">2593
</span><span class="lnt">2594
</span><span class="lnt">2595
</span><span class="lnt">2596
</span><span class="lnt">2597
</span><span class="lnt">2598
</span><span class="lnt">2599
</span><span class="lnt">2600
</span><span class="lnt">2601
</span><span class="lnt">2602
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/*
</span><span class="cm"> * Add the given portset to the current service&#39;s portlist
</span><span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">addport</span><span class="p">(</span><span class="n">Port_T</span> <span class="n">port</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Port_T</span> <span class="n">p</span><span class="p">;</span>

  <span class="n">ASSERT</span><span class="p">(</span><span class="n">port</span><span class="p">)</span><span class="p">;</span>

  <span class="n">NEW</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">port</span>               <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">port</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">type</span>               <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">type</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">socket</span>             <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">socket</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">family</span>             <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">family</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">action</span>             <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">action</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">timeout</span>            <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">timeout</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">retry</span>              <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">retry</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request</span>            <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">generic</span>            <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">generic</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">protocol</span>           <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">protocol</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pathname</span>           <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">pathname</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">hostname</span>           <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">hostname</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">url_request</span>        <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">url_request</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_checksum</span>   <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_checksum</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_hostheader</span> <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_hostheader</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">http_headers</span>       <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">http_headers</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">version</span>            <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">version</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">operator</span>           <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">operator</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">status</span>             <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">status</span><span class="p">;</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">ApacheStatus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">ApacheStatus</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">apache_status</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_checksum</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cleanup_hash_string</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_checksum</span><span class="p">)</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_checksum</span><span class="p">)</span> <span class="o">=</span><span class="o">=</span> <span class="mi">32</span><span class="p">)</span>
      <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_hashtype</span> <span class="o">=</span> <span class="n">HASH_MD5</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_checksum</span><span class="p">)</span> <span class="o">=</span><span class="o">=</span> <span class="mi">40</span><span class="p">)</span>
      <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_hashtype</span> <span class="o">=</span> <span class="n">HASH_SHA1</span><span class="p">;</span>
    <span class="k">else</span>
      <span class="n">yyerror2</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">invalid checksum [%s]</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_checksum</span><span class="p">)</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span>
    <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_hashtype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">use_ssl</span> <span class="o">=</span><span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_ssl</span><span class="p">(</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">yyerror</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">ssl check cannot be activated. SSL is not supported</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">certmd5</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">certmd5</span> <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">certmd5</span><span class="p">;</span>
        <span class="n">cleanup_hash_string</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">certmd5</span><span class="p">)</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
      <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">SSL</span><span class="p">.</span><span class="n">version</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">maxforward</span> <span class="o">=</span> <span class="n">port</span><span class="o">-</span><span class="o">&gt;</span><span class="n">maxforward</span><span class="p">;</span>
  <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">current</span><span class="o">-</span><span class="o">&gt;</span><span class="n">portlist</span><span class="p">;</span>
  <span class="n">current</span><span class="o">-</span><span class="o">&gt;</span><span class="n">portlist</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

  <span class="n">reset_portset</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Port_T</code> の型定義。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/monit.h?at=release-5-11-0&amp;fileviewer=file-view-default#monit.h-457:510">src/monit.h#L457-L510</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/** Defines a port object */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">myport</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">;</span>                                     <span class="cm">/**&lt; Hostname to check */</span>
        <span class="n">List_T</span> <span class="n">http_headers</span><span class="p">;</span> <span class="cm">/**&lt; Optional list of HTTP headers to send with request */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>                              <span class="cm">/**&lt; Specific protocol request */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">request_checksum</span><span class="p">;</span>     <span class="cm">/**&lt; The optional checksum for a req. document */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">request_hostheader</span><span class="p">;</span>            <span class="cm">/**&lt; The optional Host: header to use. Deprecated */</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">;</span>                   <span class="cm">/**&lt; Pathname, in case of an UNIX socket */</span>
        <span class="n">Generic_T</span> <span class="n">generic</span><span class="p">;</span>                                <span class="cm">/**&lt; Generic test handle */</span>
        <span class="k">volatile</span> <span class="kt">int</span> <span class="n">socket</span><span class="p">;</span>                       <span class="cm">/**&lt; Socket used for connection */</span>
        <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>                   <span class="cm">/**&lt; Socket type used for connection (UDP/TCP) */</span>
        <span class="kt">int</span> <span class="n">family</span><span class="p">;</span>             <span class="cm">/**&lt; Socket family used for connection (INET/UNIX) */</span>
        <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>                                                  <span class="cm">/**&lt; Portnumber */</span>
        <span class="kt">int</span> <span class="n">request_hashtype</span><span class="p">;</span>   <span class="cm">/**&lt; The optional type of hash for a req. document */</span>
        <span class="kt">int</span> <span class="n">maxforward</span><span class="p">;</span>            <span class="cm">/**&lt; Optional max forward for protocol checking */</span>
        <span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span> <span class="cm">/**&lt; The timeout in millseconds to wait for connect or read i/o */</span>
        <span class="kt">int</span> <span class="n">retry</span><span class="p">;</span>       <span class="cm">/**&lt; Number of connection retry before reporting an error */</span>
        <span class="kt">int</span> <span class="n">is_available</span><span class="p">;</span>                <span class="cm">/**&lt; TRUE if the server/port is available */</span>
        <span class="kt">int</span> <span class="n">version</span><span class="p">;</span>                                         <span class="cm">/**&lt; Protocol version */</span>
        <span class="n">Operator_Type</span> <span class="n">operator</span><span class="p">;</span>                           <span class="cm">/**&lt; Comparison operator */</span>
        <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>                                           <span class="cm">/**&lt; Protocol status */</span>
        <span class="kt">double</span> <span class="n">response</span><span class="p">;</span>                      <span class="cm">/**&lt; Socket connection response time */</span>
        <span class="n">EventAction_T</span> <span class="n">action</span><span class="p">;</span>  <span class="cm">/**&lt; Description of the action upon event occurence */</span>
        <span class="cm">/** Apache-status specific parameters */</span>
        <span class="k">struct</span> <span class="n">apache_status</span> <span class="p">{</span>
                <span class="kt">short</span> <span class="n">loglimit</span><span class="p">;</span>                  <span class="cm">/**&lt; Max percentage of logging processes */</span>
                <span class="kt">short</span> <span class="n">loglimitOP</span><span class="p">;</span>                                  <span class="cm">/**&lt; loglimit operator */</span>
                <span class="kt">short</span> <span class="n">closelimit</span><span class="p">;</span>             <span class="cm">/**&lt; Max percentage of closinging processes */</span>
                <span class="kt">short</span> <span class="n">closelimitOP</span><span class="p">;</span>                              <span class="cm">/**&lt; closelimit operator */</span>
                <span class="kt">short</span> <span class="n">dnslimit</span><span class="p">;</span>         <span class="cm">/**&lt; Max percentage of processes doing DNS lookup */</span>
                <span class="kt">short</span> <span class="n">dnslimitOP</span><span class="p">;</span>                                  <span class="cm">/**&lt; dnslimit operator */</span>
                <span class="kt">short</span> <span class="n">keepalivelimit</span><span class="p">;</span>          <span class="cm">/**&lt; Max percentage of keepalive processes */</span>
                <span class="kt">short</span> <span class="n">keepalivelimitOP</span><span class="p">;</span>                      <span class="cm">/**&lt; keepalivelimit operator */</span>
                <span class="kt">short</span> <span class="n">replylimit</span><span class="p">;</span>               <span class="cm">/**&lt; Max percentage of replying processes */</span>
                <span class="kt">short</span> <span class="n">replylimitOP</span><span class="p">;</span>                              <span class="cm">/**&lt; replylimit operator */</span>
                <span class="kt">short</span> <span class="n">requestlimit</span><span class="p">;</span>     <span class="cm">/**&lt; Max percentage of processes reading requests */</span>
                <span class="kt">short</span> <span class="n">requestlimitOP</span><span class="p">;</span>                          <span class="cm">/**&lt; requestlimit operator */</span>
                <span class="kt">short</span> <span class="n">startlimit</span><span class="p">;</span>            <span class="cm">/**&lt; Max percentage of processes starting up */</span>
                <span class="kt">short</span> <span class="n">startlimitOP</span><span class="p">;</span>                              <span class="cm">/**&lt; startlimit operator */</span>
                <span class="kt">short</span> <span class="n">waitlimit</span><span class="p">;</span>  <span class="cm">/**&lt; Min percentage of processes waiting for connection */</span>
                <span class="kt">short</span> <span class="n">waitlimitOP</span><span class="p">;</span>                                <span class="cm">/**&lt; waitlimit operator */</span>
                <span class="kt">short</span> <span class="n">gracefullimit</span><span class="p">;</span><span class="cm">/**&lt; Max percentage of processes gracefully finishing */</span>
                <span class="kt">short</span> <span class="n">gracefullimitOP</span><span class="p">;</span>                        <span class="cm">/**&lt; gracefullimit operator */</span>
                <span class="kt">short</span> <span class="n">cleanuplimit</span><span class="p">;</span>      <span class="cm">/**&lt; Max percentage of processes in idle cleanup */</span>
                <span class="kt">short</span> <span class="n">cleanuplimitOP</span><span class="p">;</span>                          <span class="cm">/**&lt; cleanuplimit operator */</span>
        <span class="p">}</span> <span class="n">ApacheStatus</span><span class="p">;</span>

        <span class="n">Ssl_T</span> <span class="n">SSL</span><span class="p">;</span>                                             <span class="cm">/**&lt; SSL definition */</span>
        <span class="n">Protocol_T</span> <span class="n">protocol</span><span class="p">;</span>     <span class="cm">/**&lt; Protocol object for testing a port&#39;s service */</span>
        <span class="n">Request_T</span> <span class="n">url_request</span><span class="p">;</span>             <span class="cm">/**&lt; Optional url client request object */</span>

        <span class="cm">/** For internal use */</span>
        <span class="k">struct</span> <span class="n">myport</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>                               <span class="cm">/**&lt; next port in chain */</span>
<span class="p">}</span> <span class="o">*</span><span class="n">Port_T</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="check-process-">check_process 関数の実装</h2>
<p><code>check_process</code> 関数の実装。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/validate.c?at=release-5-11-0&amp;fileviewer=file-view-default#validate.c-989:1037">src/validate.c#L989-L1037</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">989
</span><span class="lnt">990
</span><span class="lnt">991
</span><span class="lnt">992
</span><span class="lnt">993
</span><span class="lnt">994
</span><span class="lnt">995
</span><span class="lnt">996
</span><span class="lnt">997
</span><span class="lnt">998
</span><span class="lnt">999
</span><span class="lnt">1000
</span><span class="lnt">1001
</span><span class="lnt">1002
</span><span class="lnt">1003
</span><span class="lnt">1004
</span><span class="lnt">1005
</span><span class="lnt">1006
</span><span class="lnt">1007
</span><span class="lnt">1008
</span><span class="lnt">1009
</span><span class="lnt">1010
</span><span class="lnt">1011
</span><span class="lnt">1012
</span><span class="lnt">1013
</span><span class="lnt">1014
</span><span class="lnt">1015
</span><span class="lnt">1016
</span><span class="lnt">1017
</span><span class="lnt">1018
</span><span class="lnt">1019
</span><span class="lnt">1020
</span><span class="lnt">1021
</span><span class="lnt">1022
</span><span class="lnt">1023
</span><span class="lnt">1024
</span><span class="lnt">1025
</span><span class="lnt">1026
</span><span class="lnt">1027
</span><span class="lnt">1028
</span><span class="lnt">1029
</span><span class="lnt">1030
</span><span class="lnt">1031
</span><span class="lnt">1032
</span><span class="lnt">1033
</span><span class="lnt">1034
</span><span class="lnt">1035
</span><span class="lnt">1036
</span><span class="lnt">1037
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/**
</span><span class="cm"> * Validate a given process service s. Events are posted according to
</span><span class="cm"> * its configuration. In case of a fatal event FALSE is returned.
</span><span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">check_process</span><span class="p">(</span><span class="n">Service_T</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pid_t</span>  <span class="n">pid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">Port_T</span> <span class="n">pp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">Resource_T</span> <span class="n">pr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">ASSERT</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
        <span class="cm">/* Test for running process */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="n">Util_isProcessRunning</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">)</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Nonexist</span><span class="p">,</span> <span class="n">STATE_FAILED</span><span class="p">,</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">action_NONEXIST</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">process is not running</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Nonexist</span><span class="p">,</span> <span class="n">STATE_SUCCEEDED</span><span class="p">,</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">action_NONEXIST</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">process is running with pid %d</span><span class="s">&#34;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pid</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* Reset the exec and timeout errors if active ... the process is running (most probably after manual intervention) */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_EVENT_SET</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">error</span><span class="p">,</span> <span class="n">Event_Exec</span><span class="p">)</span><span class="p">)</span>
                <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Exec</span><span class="p">,</span> <span class="n">STATE_SUCCEEDED</span><span class="p">,</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">action_EXEC</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">process is running after previous exec error (slow starting or manually recovered?)</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IS_EVENT_SET</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">error</span><span class="p">,</span> <span class="n">Event_Timeout</span><span class="p">)</span><span class="p">)</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">ActionRate_T</span> <span class="n">ar</span> <span class="o">=</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">actionratelist</span><span class="p">;</span> <span class="n">ar</span><span class="p">;</span> <span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">)</span>
                        <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Timeout</span><span class="p">,</span> <span class="n">STATE_SUCCEEDED</span><span class="p">,</span> <span class="n">ar</span><span class="o">-</span><span class="o">&gt;</span><span class="n">action</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">process is running after previous restart timeout (manually recovered?)</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Run</span><span class="p">.</span><span class="n">doprocess</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">update_process_data</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ptree</span><span class="p">,</span> <span class="n">ptreesize</span><span class="p">,</span> <span class="n">pid</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">check_process_state</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
                        <span class="n">check_process_pid</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
                        <span class="n">check_process_ppid</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">uid</span><span class="p">)</span>
                                <span class="n">check_uid</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">euid</span><span class="p">)</span>
                                <span class="n">check_euid</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">gid</span><span class="p">)</span>
                                <span class="n">check_gid</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">uptimelist</span><span class="p">)</span>
                                <span class="n">check_uptime</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
                        <span class="k">for</span> <span class="p">(</span><span class="n">pr</span> <span class="o">=</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">resourcelist</span><span class="p">;</span> <span class="n">pr</span><span class="p">;</span> <span class="n">pr</span> <span class="o">=</span> <span class="n">pr</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">)</span>
                                <span class="n">check_process_resources</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pr</span><span class="p">)</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span>
                        <span class="n">LogError</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">&#39;%s&#39; failed to get service data</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* Test each host:port and protocol in the service&#39;s portlist */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">portlist</span><span class="p">)</span>
                <span class="cm">/* skip further tests during startup timeout */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">start</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">inf</span><span class="o">-</span><span class="o">&gt;</span><span class="n">priv</span><span class="p">.</span><span class="n">process</span><span class="p">.</span><span class="n">uptime</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">start</span><span class="o">-</span><span class="o">&gt;</span><span class="n">timeout</span><span class="p">)</span> <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">pp</span> <span class="o">=</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">portlist</span><span class="p">;</span> <span class="n">pp</span><span class="p">;</span> <span class="n">pp</span> <span class="o">=</span> <span class="n">pp</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">)</span>
                        <span class="n">check_connection</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">pp</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>check_connection</code> 関数の実装。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/validate.c?at=release-5-11-0&amp;fileviewer=file-view-default#validate.c-138:206">src/validate.c#L138-L206</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/**
</span><span class="cm"> * Test the connection and protocol
</span><span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_connection</span><span class="p">(</span><span class="n">Service_T</span> <span class="n">s</span><span class="p">,</span> <span class="n">Port_T</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Socket_T</span> <span class="n">socket</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">int</span> <span class="n">retry_count</span> <span class="o">=</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">retry</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="kt">int</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">STRLEN</span><span class="p">]</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">report</span><span class="p">[</span><span class="n">STRLEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="p">}</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">timeval</span> <span class="n">t1</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">timeval</span> <span class="n">t2</span><span class="p">;</span>
        
        <span class="n">ASSERT</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">p</span><span class="p">)</span><span class="p">;</span>
<span class="nl">retry</span><span class="p">:</span>
        <span class="cm">/* Get time of connection attempt beginning */</span>
        <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span><span class="p">;</span>
        
        <span class="cm">/* Open a socket to the destination INET[hostname:port] or UNIX[pathname] */</span>
        <span class="n">socket</span> <span class="o">=</span> <span class="n">socket_create</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">STRLEN</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">failed, cannot open a connection to %s</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">&#39;%s&#39; succeeded connecting to %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">protocol</span><span class="o">-</span><span class="o">&gt;</span><span class="n">check</span> <span class="o">=</span><span class="o">=</span> <span class="n">check_default</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">socket_is_udp</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// Only test &#34;connected&#34; UDP sockets without protocol, TCP connect is verified on create
</span><span class="c1"></span>                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">socket_is_ready</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">snprintf</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">STRLEN</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">connection failed, %s is not ready for i|o -- %s</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="p">)</span><span class="p">,</span> <span class="n">STRERROR</span><span class="p">)</span><span class="p">;</span>
                                <span class="n">rv</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                                <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="cm">/* Run the protocol verification routine through the socket */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">protocol</span><span class="o">-</span><span class="o">&gt;</span><span class="n">check</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">report</span><span class="p">,</span> <span class="n">STRLEN</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">failed protocol test [%s] at %s -- %s</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">protocol</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="p">)</span><span class="p">,</span> <span class="n">socket_getError</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">DEBUG</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">&#39;%s&#39; succeeded testing protocol [%s] at %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">protocol</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="cm">/* Get time of connection attempt finish */</span>
        <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span><span class="p">;</span>
        
        <span class="cm">/* Get the response time */</span>
        <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="p">(</span><span class="n">t2</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">t1</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="p">(</span><span class="n">t2</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">t1</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">)</span><span class="o">/</span><span class="mi">1000000</span><span class="p">;</span>
        
<span class="nl">error</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">)</span>
                <span class="n">socket_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="p">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">retry_count</span><span class="o">-</span><span class="o">-</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">DEBUG</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">&#39;%s&#39; %s (attempt %d/%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">s</span><span class="o">-</span><span class="o">&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">retry</span> <span class="o">-</span> <span class="n">retry_count</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">retry</span><span class="p">)</span><span class="p">;</span>
                        <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">response</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">is_available</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">;</span>
                <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Connection</span><span class="p">,</span> <span class="n">STATE_FAILED</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">action</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">%s</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">report</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">is_available</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">Event_post</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Event_Connection</span><span class="p">,</span> <span class="n">STATE_SUCCEEDED</span><span class="p">,</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">action</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">connection succeeded to %s</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">Util_portDescription</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="p">}</span>
        
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>上記の194行目で <code>retry_count-- &gt; 1</code> という条件を満たすと <code>retry</code> ラベルに飛んでソケット通信を再度行います。
<code>retry_count--</code> と後置演算子を使っているので、まず今の値で比較した後に <code>retry_count</code> を <code>1</code> 減らします。</p>
<p><code>retry_count</code> は143行目で <code>volatile int retry_count = p-&gt;retry;</code> のように初期化されています。
もし <code>p-&gt;retry</code> が <code>1</code> だった場合は1度ソケット通信を行った後の <code>retry_count-- &gt; 1</code> が <code>1 &gt; 1</code> で <code>false</code> になるので、再度ソケット通信は行われずに200行目で <code>STATE_FAILED</code> で <code>Event_post</code> が呼ばれることになります。</p>
<p><code>retry</code> という名前から、まず1度通信してみて失敗したら追加で <code>retry</code> 回分の通信を試みるのかと想像していたのですが、上記のコードだと全体の通信回数が <code>retry</code> 回になるということですね。</p>
<p>195行目の <code>DEBUG</code> を見ても <code>(attempt %d/%d)</code> の値に対応する部分が <code>p-&gt;retry - retry_count</code> と <code>p-&gt;retry</code> となっていて、分母の全体の試行回数が <code>p-&gt;retry</code> ですのでこの理解で間違いなさそうです。</p>
<p>上記の200行と203行で呼んでいる <code>Event_post</code> 関数やイベントループの処理も気になりますが、この記事が長くなりすぎるので別記事にします。</p>
<p><code>Protocol_T</code> の型定義。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/monit.h?at=release-5-11-0&amp;fileviewer=file-view-default#monit.h-438:442">src/monit.h#L438-L442</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/** Defines a protocol object with protocol functions */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">Protocol_T</span> <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>                                       <span class="cm">/**&lt; Protocol name */</span>
        <span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">check</span><span class="p">)</span><span class="p">(</span><span class="n">Socket_T</span><span class="p">)</span><span class="p">;</span>                 <span class="cm">/**&lt; Protocol verification function */</span>
<span class="p">}</span> <span class="o">*</span><span class="n">Protocol_T</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Protocol_T</code> 型の配列の値定義。monitで扱うプロトコル一覧。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/protocols/protocol.c?at=release-5-11-0&amp;fileviewer=file-view-default#protocol.c-41:83">src/protocols/protocol.c#L41-L83</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">static</span> <span class="n">Protocol_T</span> <span class="n">protocols</span><span class="p">[</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">DEFAULT</span><span class="s">&#34;</span><span class="p">,</span>         <span class="n">check_default</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">HTTP</span><span class="s">&#34;</span><span class="p">,</span>            <span class="n">check_http</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">FTP</span><span class="s">&#34;</span><span class="p">,</span>             <span class="n">check_ftp</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">SMTP</span><span class="s">&#34;</span><span class="p">,</span>            <span class="n">check_smtp</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">POP</span><span class="s">&#34;</span><span class="p">,</span>             <span class="n">check_pop</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">IMAP</span><span class="s">&#34;</span><span class="p">,</span>            <span class="n">check_imap</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">NNTP</span><span class="s">&#34;</span><span class="p">,</span>            <span class="n">check_nntp</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">SSH</span><span class="s">&#34;</span><span class="p">,</span>             <span class="n">check_ssh</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">DWP</span><span class="s">&#34;</span><span class="p">,</span>             <span class="n">check_dwp</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">LDAP2</span><span class="s">&#34;</span><span class="p">,</span>           <span class="n">check_ldap2</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">LDAP3</span><span class="s">&#34;</span><span class="p">,</span>           <span class="n">check_ldap3</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">RDATE</span><span class="s">&#34;</span><span class="p">,</span>           <span class="n">check_rdate</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">RSYNC</span><span class="s">&#34;</span><span class="p">,</span>           <span class="n">check_rsync</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">generic</span><span class="s">&#34;</span><span class="p">,</span>         <span class="n">check_generic</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">APACHESTATUS</span><span class="s">&#34;</span><span class="p">,</span>    <span class="n">check_apache_status</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">NTP3</span><span class="s">&#34;</span><span class="p">,</span>            <span class="n">check_ntp3</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">MYSQL</span><span class="s">&#34;</span><span class="p">,</span>           <span class="n">check_mysql</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">DNS</span><span class="s">&#34;</span><span class="p">,</span>             <span class="n">check_dns</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">POSTFIX-POLICY</span><span class="s">&#34;</span><span class="p">,</span>  <span class="n">check_postfix_policy</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">TNS</span><span class="s">&#34;</span><span class="p">,</span>             <span class="n">check_tns</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">PGSQL</span><span class="s">&#34;</span><span class="p">,</span>           <span class="n">check_pgsql</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">CLAMAV</span><span class="s">&#34;</span><span class="p">,</span>          <span class="n">check_clamav</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">SIP</span><span class="s">&#34;</span><span class="p">,</span>             <span class="n">check_sip</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">LMTP</span><span class="s">&#34;</span><span class="p">,</span>            <span class="n">check_lmtp</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">GPS</span><span class="s">&#34;</span><span class="p">,</span>             <span class="n">check_gps</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">RADIUS</span><span class="s">&#34;</span><span class="p">,</span>          <span class="n">check_radius</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">MEMCACHE</span><span class="s">&#34;</span><span class="p">,</span>        <span class="n">check_memcache</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">WEBSOCKET</span><span class="s">&#34;</span><span class="p">,</span>       <span class="n">check_websocket</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">REDIS</span><span class="s">&#34;</span><span class="p">,</span>           <span class="n">check_redis</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">MONGODB</span><span class="s">&#34;</span><span class="p">,</span>         <span class="n">check_mongodb</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="p">(</span><span class="k">struct</span> <span class="n">Protocol_T</span><span class="p">)</span><span class="p">{</span><span class="sa"></span><span class="s">&#34;</span><span class="s">SIEVE</span><span class="s">&#34;</span><span class="p">,</span>           <span class="n">check_sieve</span><span class="p">}</span>
<span class="p">}</span><span class="p">;</span>

<span class="cm">/* ------------------------------------------------------------------ Public */</span>

<span class="n">Protocol_T</span> <span class="nf">Protocol_get</span><span class="p">(</span><span class="n">Protocol_Type</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;</span><span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">protocols</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">protocols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">)</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">protocols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">protocols</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="check-http-">check_http 関数の実装</h2>
<p><code>check_http</code> 関数の実装。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/protocols/http.c?at=release-5-11-0&amp;fileviewer=file-view-default#http.c-276:321">src/protocols/http.c#L276-L321</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">check_http</span><span class="p">(</span><span class="n">Socket_T</span> <span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Port_T</span> <span class="n">P</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">host</span><span class="p">[</span><span class="n">STRLEN</span><span class="p">]</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">auth</span><span class="p">[</span><span class="n">STRLEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="p">}</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostheader</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="n">ASSERT</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="p">;</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">socket_get_Port</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span><span class="p">;</span>

        <span class="n">ASSERT</span><span class="p">(</span><span class="n">P</span><span class="p">)</span><span class="p">;</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request</span> <span class="o">?</span> <span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="nl">request</span> <span class="p">:</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">/</span><span class="s">&#34;</span><span class="p">;</span>

        <span class="n">hostheader</span> <span class="o">=</span> <span class="n">_findHostHeaderIn</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">http_headers</span><span class="p">)</span><span class="p">;</span>
        <span class="n">hostheader</span> <span class="o">=</span> <span class="n">hostheader</span> <span class="o">?</span> <span class="nl">hostheader</span> <span class="p">:</span> <span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_hostheader</span>
                                <span class="o">?</span> <span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="nl">request_hostheader</span> <span class="p">:</span> <span class="n">Util_getHTTPHostHeader</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">STRLEN</span><span class="p">)</span><span class="p">;</span> <span class="c1">// Otherwise use deprecated request_hostheader or default host
</span><span class="c1"></span>        <span class="n">StringBuffer_T</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">StringBuffer_create</span><span class="p">(</span><span class="mi">168</span><span class="p">)</span><span class="p">;</span>
        <span class="n">StringBuffer_append</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span>
                            <span class="sa"></span><span class="s">&#34;</span><span class="s">GET %s HTTP/1.1</span><span class="se">\r</span><span class="se">\n</span><span class="s">&#34;</span>
                            <span class="sa"></span><span class="s">&#34;</span><span class="s">Host: %s</span><span class="se">\r</span><span class="se">\n</span><span class="s">&#34;</span>
                            <span class="sa"></span><span class="s">&#34;</span><span class="s">Accept: */*</span><span class="se">\r</span><span class="se">\n</span><span class="s">&#34;</span>
                            <span class="sa"></span><span class="s">&#34;</span><span class="s">User-Agent: Monit/%s</span><span class="se">\r</span><span class="se">\n</span><span class="s">&#34;</span>
                            <span class="sa"></span><span class="s">&#34;</span><span class="s">%s</span><span class="s">&#34;</span><span class="p">,</span>
                            <span class="n">request</span><span class="p">,</span> <span class="n">hostheader</span><span class="p">,</span> <span class="n">VERSION</span><span class="p">,</span>
                            <span class="n">get_auth_header</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="n">STRLEN</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="c1">// Add headers if we have them
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">http_headers</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">list_t</span> <span class="n">p</span> <span class="o">=</span> <span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">http_headers</span><span class="o">-</span><span class="o">&gt;</span><span class="n">head</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kt">char</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="n">p</span><span class="o">-</span><span class="o">&gt;</span><span class="n">e</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">Str_startsWith</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">Host</span><span class="s">&#34;</span><span class="p">)</span><span class="p">)</span> <span class="c1">// Already set contrived above
</span><span class="c1"></span>                                <span class="k">continue</span><span class="p">;</span>
                        <span class="n">StringBuffer_append</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">%s</span><span class="se">\r</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span><span class="p">;</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">StringBuffer_append</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="se">\r</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">send_status</span> <span class="o">=</span> <span class="n">socket_write</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">StringBuffer_toString</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="p">,</span> <span class="n">StringBuffer_length</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
        <span class="n">StringBuffer_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb</span><span class="p">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">send_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">HTTP: error sending data -- %s</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">STRERROR</span><span class="p">)</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">check_request</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>Socket_T</code> の型定義。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/socket.c?at=release-5-11-0&amp;fileviewer=file-view-default#socket.c-85:103">src/socket.c#L85-L103</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cp">#</span><span class="cp">define TYPE_LOCAL   0</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">define TYPE_ACCEPT  1</span><span class="cp">
</span><span class="cp"></span><span class="c1">// One TCP frame data size
</span><span class="c1"></span><span class="cp">#</span><span class="cp">define RBUFFER_SIZE 1500</span><span class="cp">
</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">Socket_T</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">socket</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
        <span class="n">Port_T</span> <span class="n">Port</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span> <span class="c1">// milliseconds
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">connection_type</span><span class="p">;</span>
        <span class="n">ssl_connection</span> <span class="o">*</span><span class="n">ssl</span><span class="p">;</span>
        <span class="n">ssl_server_connection</span> <span class="o">*</span><span class="n">sslserver</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">RBUFFER_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>check_request</code> 関数の実装。
<a href="https://bitbucket.org/tildeslash/monit/src/97641b51c99226fbf8862797c8f5ec16ac68a18b/src/protocols/http.c?at=release-5-11-0&amp;fileviewer=file-view-default#http.c-199:242">src/protocols/http.c#L199-L242</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="cm">/**
</span><span class="cm"> * Check that the server returns a valid HTTP response as well as checksum
</span><span class="cm"> * or content regex if required
</span><span class="cm"> * @param s A socket
</span><span class="cm"> * @return TRUE if the response is valid otherwise FALSE
</span><span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_request</span><span class="p">(</span><span class="n">Socket_T</span> <span class="n">socket</span><span class="p">,</span> <span class="n">Port_T</span> <span class="n">P</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">content_length</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">LINE_SIZE</span><span class="p">]</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">socket_readln</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">LINE_SIZE</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">HTTP: Error receiving data -- %s</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">STRERROR</span><span class="p">)</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Str_chomp</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">%*s %d</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">HTTP error: Cannot parse HTTP status in response: %s</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">Util_evalQExpression</span><span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">operator</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">status</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">HTTP error: Server returned status %d</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* Get Content-Length header value */</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">socket_readln</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">LINE_SIZE</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span><span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">\r</span><span class="sc">&#39;</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span><span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">\n</span><span class="sc">&#39;</span><span class="p">)</span> <span class="o">|</span><span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span><span class="o">=</span> <span class="sa"></span><span class="sc">&#39;</span><span class="sc">\n</span><span class="sc">&#39;</span><span class="p">)</span><span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="n">Str_chomp</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">Str_startsWith</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">Content-Length</span><span class="s">&#34;</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">%*s%*[: ]%d</span><span class="s">&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">content_length</span><span class="p">)</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">HTTP error: Parsing Content-Length response header &#39;%s&#39;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span><span class="p">;</span>
                                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">content_length</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                                <span class="n">socket_setError</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">HTTP error: Illegal Content-Length response header &#39;%s&#39;</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span><span class="p">;</span>
                                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
                        <span class="p">}</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">url_request</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">url_request</span><span class="o">-</span><span class="o">&gt;</span><span class="n">regex</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="o">!</span> <span class="n">do_regex</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">url_request</span><span class="p">)</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_checksum</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">check_request_checksum</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">content_length</span><span class="p">,</span> <span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_checksum</span><span class="p">,</span> <span class="n">P</span><span class="o">-</span><span class="o">&gt;</span><span class="n">request_hashtype</span><span class="p">)</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="/blog/2017/02/20/monit-event-loop-code-reading/">monitのイベントループのコードリーディング</a> に続きます。</p>

</div>


    </main>

    
  </body>
</html>
