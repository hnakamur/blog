<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>Ubuntu 16.04でNo-IPのダイナミックDNSサービスを使ってみた</title>
        <link rel="stylesheet" href="../../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../../blog/2016/05/02/use-no-ip-dynamic-dns-on-ubuntu-16.04/" rel="bookmark"
           title="Permalink to Ubuntu 16.04でNo-IPのダイナミックDNSサービスを使ってみた">Ubuntu 16.04でNo-IPのダイナミックDNSサービスを使ってみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-05-02T09:39:00+09:00">
                Published: 2016-05-02
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../../tag/ddns.html">ddns</a> <a href="../../../../../tag/ubuntu.html">ubuntu</a> </p>
</footer><!-- /.post-info -->      <h2>背景</h2>
<p><a href="/blog/2016/05/01/install_ubuntu_xenial_with_pxe_boot/">MacをPXEサーバにしてExpress5800/S70タイプRBにUbuntu16.04をインストールしてみた · hnakamur's blog at github</a>で自宅サーバを起動したのですが、固定グローバルIPアドレスは持っていないので、ダイナミックDNS (DDNS) サービスを使うことにしました。</p>
<p><a href="http://viral-community.com/other-it/ddns-praise-service-2065/">DDNSの無料サービスでオススメな３つの「ieServer」「mydns」「No-IP」の特徴と利用手順をまとめてみた</a>を参考に「No-IP」を使ってみました。</p>
<h2>アカウント登録</h2>
<p>https://www.noip.com/ でメールアドレス、ユーザ名、パスワードを入力してサインアップし、確認のHTMLメールが届いたら[Activate Account]ボタンをクリックすればOKです。</p>
<h2>ホストの登録</h2>
<p>https://www.noip.com/ の右上の[Sign In]を押し、ユーザ名かメールアドレスとパスワードを入力してサインインします。サインイン後は https://my.noip.com/ に遷移します。</p>
<p>ホストの登録は新サイトの画面左の[Dashboard]を選んで、画面中央の[Quick Add]で[Hostname]を希望のホスト名を入力、[Doman]で使いたいドメインを選択して[Add Hostname]ボタンを押せばOKです。</p>
<p>あるいは画面左の[Dynamic DNS]の[Hostnames]メニューを選び、[Add Hostname]ボタンを押す方法でもOKです。この場合は[Add Hostname]というタイトルのポップアップが開きます。</p>
<p>[Hostname]に希望のホスト名を入力し、[Domain]は使いたいドメインを選びます。
[Record Type]はAのままでOKで、[IPv4 Address]にも自動で現在のグローバルIPアドレスが入力されているのでそのままでOKです。[Add Hostname]ボタンを押すと追加完了です。</p>
<p>なお、試していませんが、[Record Type]の[More Records]ボタンを押すと、以下の4つのラジオボタンが表示されました。</p>
<ul>
<li>DNS Host (A)</li>
<li>DNS Alias (CNAME)</li>
<li>Web Redirect</li>
<li>AAAA (IPv6)</li>
</ul>
<p>また、その下には "Manage your Round Robin, TXT, SRV and DKIM records." という文が書かれており、 "Manage" の部分がリンクになっていました。これを押すと https://www.noip.com/members/dns/ のManage Hostsページに遷移しました。 no-ip は管理画面をリニューアル中で、こちらは旧画面のようです。 https://my.noip.com/#!/ の画面上部にある [Use Old Site] というリンクでも旧サイトのManage Hostsページが開きました。</p>
<p>新サイトの[Dynamic DNS]の[Hostnames]メニューで画面右に "Free Hostnames expire every 30 days. Enhanced Hostnames never expire. Upgrade to Enhanced" と書いてあるのですが、 <a href="http://www.noip.com/support/faq/frequently-asked-questions/why-did-my-free-hostname-expire-or-get-deleted/">Why did my free hostname expire or get deleted? | Support | No-IP</a> の説明によれば無料サービスでも30日毎に更新していれば消えないようです。</p>
<h2>IPアドレス自動更新用のクライアントnoip2をセットアップ</h2>
<p>http://www.noip.com/ の画面上部の [Download] リンクをクリックすると、アクセスしているブラウザからOSを自動判定して、そのOS用のクライアントのダウンロードページが開きます。私の場合は Dynamic DNS Update Client (DUC) for Mac のページが開きました。</p>
<p>下の方にスクロールして [Other Downloads] の [Linux] をクリックして <a href="https://www.noip.com/download?page=linux">Dynamic DNS Update Client (DUC) for Linux - No-IP</a> を開きます。</p>
<p>Installation のセクションに "UBUNTU USERS: You may install this with the apt-get command, see this guide" という文があり guide のリンクをクリックすると <a href="http://www.noip.com/support/knowledgebase/installing-the-linux-dynamic-update-client-on-ubuntu/">How to Install the Linux Dynamic Update Client on Ubuntu</a> に遷移しました。このページの手順に従ってセットアップすればOKでした。</p>
<div class="highlight"><pre><span></span>sudo -s
</pre></div>


<p>でパスワードを入力してrootになって以下のコマンドを実行します。</p>
<div class="highlight"><pre><span></span>cd /usr/local/src
wget http://www.no-ip.com/client/linux/noip-duc-linux.tar.gz
tar xf noip-duc-linux.tar.gz
cd noip-2.1.9-1/
make install
</pre></div>


<p>noip-2.1.9-1 のディレクトリ内を見るとソースファイルは noip2.c の1つでした。中を見てみるとライセンスはGPLv2 or laterです。ざっと見た感じでは不正な通信はしてなさそうでした。</p>
<p>インストール後以下のコマンドを実行して設定ファイルを作成します。以下のコマンドは全てrootで実行しています。</p>
<div class="highlight"><pre><span></span>/usr/local/bin/noip2 -C
</pre></div>


<p>プロンプトが表示されたらNo-IPのユーザ名、パスワードと登録したホスト名を入力します。すると /usr/local/etc/no-ip2.conf に設定ファイルが作られます。viで中を見てみると一部テキスト、一部バイナリのファイルでした。</p>
<p>あとは <code>/usr/local/bin/noip2</code> でデーモンが起動するのですが、systemdのサービスとして登録したいので、unitファイルを作りました。</p>
<p>ソースのディレクトリにdebian, gentoo, redhat用のinit.d用のスクリプトとmac用の自動起動スクリプトがありました。 <code>redhat.noip.sh</code> を見ると、起動は <code>/usr/local/bin/noip2</code> で、終了は <code>killproc noip2 -TERM</code> で行っていました。</p>
<p>Ubuntuで試したら <code>killproc</code> は無かったので <code>killall</code> で代用しました。</p>
<p>以下のコマンドでunitファイルを作成します。</p>
<div class="highlight"><pre><span></span>cat &lt;&lt;&#39;EOF&#39; &gt; /etc/systemd/system/noip2.service
[Unit]
Description=No-IP.com DDNS client
After=network.target auditd.service

[Service]
ExecStart=/usr/local/bin/noip2
ExecStop=/usr/bin/killall -TERM /usr/local/bin/noip2
Restart=on-failure
Type=forking

[Install]
WantedBy=multi-user.target
EOF
</pre></div>


<p>作成したファイルをsystemdに読み込ませます。</p>
<div class="highlight"><pre><span></span>systemctl daemon-reload
</pre></div>


<p>以下のコマンドでサービスの起動とOS起動時の自動起動設定を行います。</p>
<div class="highlight"><pre><span></span>systemctl start noip2
systemctl enable noip2
</pre></div>


<p>ちなみに、 <code>mac.osx.startup</code> では <code>noip2 -S</code> の出力からpidを取得して <code>noip -K $pid</code> で停止していました。こんな感じです。</p>
<div class="highlight"><pre><span></span>    for i in `noip2 -S 2&gt;&amp;1 | grep Process | awk &#39;{print $2}&#39; | tr -d &#39;,&#39;`
      do
        noip2 -K $i
      done
</pre></div>


<p>journalctlでログを見てみると以下のようなログが出ていました。</p>
<div class="highlight"><pre><span></span>$ sudo journalctl <span class="p">|</span> grep noip2
 5月 <span class="m">02</span> <span class="m">10</span>:54:07 express noip2<span class="o">[</span><span class="m">1082</span><span class="o">]</span>: v2.1.9 daemon started with NAT enabled
 5月 <span class="m">02</span> <span class="m">10</span>:54:07 express noip2<span class="o">[</span><span class="m">1082</span><span class="o">]</span>: xxxx.ddns.net was already <span class="nb">set</span> to xx.xx.xx.xx.
</pre></div>


<p>実際はxxxx.ddns.net はNo-IPで登録したホスト名と選択したドメインでxx.xx.xx.xxは自宅サーバのグローバルIPアドレスが出力されていましたが、セキュリティ上伏せています。</p>
<h2>ポートフォワーディング設定</h2>
<h3>Ubuntuサーバを固定IPに設定</h3>
<p>変更前の <code>/etc/network/interfaces</code> は以下のようになっていました。</p>
<div class="highlight"><pre><span></span># This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto enp0s25
iface enp0s25 inet dhcp
</pre></div>


<p><code>enp0s25</code> の設定を <a href="https://help.ubuntu.com/lts/serverguide/network-configuration.html#static-ip-addressing">Static IP Address Assignment</a> を参考に固定IPにしました。</p>
<div class="highlight"><pre><span></span># This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto enp0s25
iface enp0s25 inet static
    address 192.168.0.201
    netmask 255.255.255.0
    gateway 192.168.0.1
    dns-nameservers 192.168.0.1
</pre></div>


<div class="highlight"><pre><span></span>systemctl restart networking
</pre></div>


<p>で反映しました。</p>
<p><code>ip a</code> で確認すると、変更前にDHCPで発行されたIPアドレス <code>192.168.0.9</code> と上記で設定した固定アドレス <code>192.168.0.201</code> の両方が表示されました。</p>
<p>sshで作業していたのですが、以下のコマンドで消そうとしたらハマりました。</p>
<div class="highlight"><pre><span></span>root@express:/etc/network# ip a del 192.168.0.9 dev enp0s25
Warning: Executing wildcard deletion to stay compatible with old scripts.
         Explicitly specify the prefix length (192.168.0.9/32) to avoid this warning.
         This special behaviour is likely to disappear in further releases,
         fix your scripts!
packet_write_wait: Connection to 192.168.0.9: Broken pipe
</pre></div>


<p>コンソールからログインして <code>ip a</code> で確認すると <code>enp0s25</code> の <code>inet</code> の行は両方共消えていました。</p>
<div class="highlight"><pre><span></span>sudo systemctl restart networking
</pre></div>


<p>でネットワークを再起動して <code>ip a</code> を実行すると <code>inet</code> の行は固定IPの1行になりました。</p>
<p>上で表示されたWarningによると、正しくは以下のようにするべきだったようです。</p>
<div class="highlight"><pre><span></span>ip a del 192.168.0.9/32 dev enp0s25
</pre></div>


<h3>AirMacユーティリティでポートフォワーディング設定</h3>
<p>Finderで「アプリケーション/ユーティリティ/AirMac ユーティリティ」を起動し、
Time Capsuleをクリックして開くポップアップの「編集」ボタンを押します。</p>
<p>「ネットワーク」タブで「ルーターモード」を「DHCPとNAX」にしておきます。
先程固定IPを <code>192.168.0.201</code> にしたのは「DHCPの範囲」が <code>192.168.0.2〜192.168.0.200</code> なので範囲外の値を選んだからです。なお、この範囲は「ネットワークオプション…」ボタンを押して変更可能です。</p>
<p>ポート設定の下の「+」ボタンを押すとポップアップが開くのでポートフォワーディングの設定を追加します。
ファイアウォール・エントリー・タイプは「IPv4ポートマッピング」固定で、ドロップダウンが disabled の状態になっていました。</p>
<p>プライベートIPアドレスは上記で設定したExpress5800の固定IPを入力します。</p>
<p>パブリックUDPポート、パブリックTCPポート、プライベートUDPポート、プライベートTCPポートにはフォワーデング元と先のポートを転送したい内容に応じて設定します。今回はTCPでsshのポートを指定しました。
なお、この記事では書いてないですが、パスワードアタック攻撃を回避するため事前にsshdは鍵認証のみ許可しパスワード認証は許可しない設定に変更しています。</p>
<p>ちなみに<a href="https://support.apple.com/kb/TA24799?locale=ja_JP&amp;viewlocale=ja_JP">ポートの範囲を指定して転送できるように AirMac Extreme (802.11n) ベースステーションを設定する</a>によるとポートの入力欄は空白を開けずに <code>XXX-YYY</code> のように書けば範囲も指定できるそうです。</p>
<p>設定を追加したら「保存」ボタンを押してポップアップを閉じ、「アップデート」ボタンで反映します。</p>
<h2>おわりに</h2>
<p>これでインターネットから自宅サーバにsshでログイン出来るようになって便利になりました。</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>