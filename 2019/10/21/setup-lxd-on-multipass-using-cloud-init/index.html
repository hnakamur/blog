<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.74.3" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>multipassのVM作成時にcloud-initでLXDをセットアップ &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>multipassのVM作成時にcloud-initでLXDをセットアップ</h1>
  <time datetime=2019-10-21T06:05:00&#43;0900 class="post-date">2019-10-21</time>
  <nav id="TableOfContents"></nav>
  <h1 id="はじめに">はじめに</h1>
<p><a href="https://github.com/CanonicalLtd/multipass">multipass</a> ではVMの作成時に <code>multipass launch</code> の <code>--cloud-init</code> オプションで <a href="https://github.com/cloud-init/cloud-init">cloud-init</a> を使って初期化を行えます。</p>
<p>LXD をセットアップする手順を試行錯誤したのでメモです。</p>
<h1 id="参考資料">参考資料</h1>
<ul>
<li><a href="https://cloudinit.readthedocs.io/en/latest/topics/modules.html">cloud-init の Modules のドキュメント</a></li>
<li><a href="https://github.com/cloud-init/cloud-init/blob/ubuntu/19.2-36-g059d049c-0ubuntu2_18.04.1/cloudinit/config/cc_lxd.py">Ubuntu 18.04 LTS の cloud-init の cc_lxd.py のソース</a></li>
</ul>
<h1 id="cloud-initの設定ファイル例その1">cloud-initの設定ファイル例その1</h1>
<ul>
<li>まず apt の設定でURLを日本のミラーサイトにします。</li>
<li>zfs でループバックのストレージを 80GB で作成します。</li>
<li>LXD のストレージバックエンドを zfs にします。</li>
<li>LXDのブリッジをデフォルト設定で新規作成します。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">#cloud-config</span><span class="w">
</span><span class="w"></span><span class="k">locale</span><span class="p">:</span><span class="w"> </span>en_US.utf8<span class="w">
</span><span class="w"></span><span class="k">timezone</span><span class="p">:</span><span class="w"> </span>Asia/Tokyo<span class="w">
</span><span class="w"></span><span class="k">package_upgrade</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="k">package_reboot_if_required</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="k">apt</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">primary</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">arches</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- amd64<span class="w">
</span><span class="w">        </span>- default<span class="w">
</span><span class="w">      </span><span class="k">uri</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://jp.archive.ubuntu.com/ubuntu/&#34;</span><span class="w">
</span><span class="w"></span><span class="k">lxd</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">init</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">storage_backend</span><span class="p">:</span><span class="w"> </span>zfs<span class="w">
</span><span class="w">    </span><span class="k">storage_create_loop</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">  </span><span class="k">bridge</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">mode</span><span class="p">:</span><span class="w"> </span>new<span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>lxdbr0<span class="w">
</span></code></pre></div><p>上記のファイルを <code>lxd-cloud-config.yml</code> などお好みの名前で保存し、以下のコマンドを実行してVMを作成・起動します。ディスクサイズは上記の zfs のプールサイズ80GBにシステム領域で20GBを使う想定で合計100GBとしています。</p>
<pre><code class="language-cosole" data-lang="cosole">multipass launch -n primary -c 2 -m 4G -d 100G --cloud-init lxd-cloud-config.yml
</code></pre><h1 id="cloud-initの設定ファイル例その2">cloud-initの設定ファイル例その2</h1>
<p>その1の例に加えて以下の設定を追加しています。</p>
<ul>
<li>LXDのブリッジのIPv4アドレスをランダムではなく明示的に指定。</li>
<li>IPv6アドレスは無効。</li>
<li>ドメインを指定。</li>
<li>cloud-init の <code>runcmd</code> モジュールを使って、LXD のコンテナをIPアドレスを指定して作成。</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c">#cloud-config</span><span class="w">
</span><span class="w"></span><span class="k">locale</span><span class="p">:</span><span class="w"> </span>en_US.utf8<span class="w">
</span><span class="w"></span><span class="k">timezone</span><span class="p">:</span><span class="w"> </span>Asia/Tokyo<span class="w">
</span><span class="w"></span><span class="k">package_upgrade</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="k">package_reboot_if_required</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w"></span><span class="k">apt</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">primary</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">arches</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- amd64<span class="w">
</span><span class="w">        </span>- default<span class="w">
</span><span class="w">      </span><span class="k">uri</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;http://jp.archive.ubuntu.com/ubuntu/&#34;</span><span class="w">
</span><span class="w"></span><span class="k">lxd</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="k">init</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">storage_backend</span><span class="p">:</span><span class="w"> </span>zfs<span class="w">
</span><span class="w">    </span><span class="k">storage_create_loop</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">  </span><span class="k">bridge</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">mode</span><span class="p">:</span><span class="w"> </span>new<span class="w">
</span><span class="w">    </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>lxdbr0<span class="w">
</span><span class="w"> </span><span class="k">ipv4_address</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.255.1</span><span class="w">
</span><span class="w"> </span><span class="k">ipv4_netmask</span><span class="p">:</span><span class="w"> </span><span class="m">24</span><span class="w">
</span><span class="w"> </span><span class="k">ipv4_nat</span><span class="p">:</span><span class="w"> </span><span class="cp">!!str</span><span class="w"> </span><span class="s2">&#34;true&#34;</span><span class="w">
</span><span class="w"> </span><span class="k">ipv6_address</span><span class="p">:</span><span class="w"> </span>none<span class="w">
</span><span class="w"> </span><span class="k">domain</span><span class="p">:</span><span class="w"> </span>my-lxd.test<span class="w">
</span><span class="w"></span><span class="k">runcmd</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="s1">&#39;sudo -u multipass lxc init ubuntu:18.04 u1&#39;</span><span class="w">
</span><span class="w">  </span>- <span class="s1">&#39;sudo -u multipass lxc network attach lxdbr0 u1 eth0 eth0&#39;</span><span class="w">
</span><span class="w">  </span>- <span class="s1">&#39;sudo -u multipass lxc config device set u1 eth0 ipv4.address 192.168.255.2&#39;</span><span class="w">
</span><span class="w">  </span>- <span class="s1">&#39;sudo -u multipass lxc start u1&#39;</span><span class="w">
</span></code></pre></div><p>ハマりポイントのメモ。</p>
<p><code>ipv4_nat</code> のデフォルト値は <code>&quot;true&quot;</code> なので省略しても良いです。
ただ、書く場合は文字列の <code>&quot;true&quot;</code> が必要で単に <code>&quot;true&quot;</code> だとうまく行かず上記のように <code>!!str</code> を付けるとうまく行きました。
YAMLパーサが対応しているバージョンの違いっぽいですが、詳しく調べていません。</p>
<p><code>runcmd</code> のドキュメントを見るとコマンドは <code>[sudo, -u, multipass, lxc, init, ubuntu:18.04, u1]</code> のように文字列ではなく配列形式でも書けるようなのですが、どうもうまく行かなかったので文字列形式にしています。</p>
<p>cloud-init に以下の設定も追加してホスト名のFQDNを設定しようと試みたが</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">preserve_hostname</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w"></span><span class="k">hostname</span><span class="p">:</span><span class="w"> </span>hoge.my-lxd.test<span class="w">
</span></code></pre></div><p>以下のエラーが発生した。VMのホスト名は変更しないほうが良さそう。</p>
<pre><code class="language-console" data-lang="console">timed out waiting for initialization to complete
mount failed: The following errors occurred:
error mounting &quot;setup&quot;: ssh connection failed: 'Failed to resolve hostname primary.mshome.net (そのようなホストは不明です。 )'
</code></pre><p>multipassの cloud-init での初期化のタイムアウトは5分間。</p>
<p><a href="https://github.com/CanonicalLtd/multipass/blob/v0.8.0/src/daemon/daemon.cpp#L77">https://github.com/CanonicalLtd/multipass/blob/v0.8.0/src/daemon/daemon.cpp#L77</a></p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="k">constexpr</span> <span class="k">auto</span> <span class="n">cloud_init_timeout</span> <span class="o">=</span> <span class="mi">5</span><span class="n">min</span><span class="p">;</span>
</code></pre></div><p>上記の例ではruncmdでLXDのコンテナ作成までやろうとしていますが、実はこのときは <code>package_upgrade: true</code> はまだ入れてませんでした。パッケージノアップデートとLXDのセットアップまでにして、コンテナの作成はcloud-init終わって起動してからにするほうが無難。</p>
<h1 id="おわりに">おわりに</h1>
<p>これで Windows と macOS でも手軽に LXD の環境がセットアップ出来て良い感じです。</p>

</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
