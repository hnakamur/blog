<!DOCTYPE html>
<html lang="ja">
<head>
        <meta charset="utf-8" />
        <title>CoreDNSをWindowsのサービスとして登録するためのラッパをGoで書いてみた</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">hnakamur's blog at github </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/blog.html">blog</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2019/10/30/coredns-wrapper-for-runnning-as-windows-service/" rel="bookmark"
           title="Permalink to CoreDNSをWindowsのサービスとして登録するためのラッパをGoで書いてみた">CoreDNSをWindowsのサービスとして登録するためのラッパをGoで書いてみた</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2019-10-30T15:25:00+09:00">
                Published: 2019-10-30
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://hnakamur.github.io">Hiroaki Nakamura</a>
        </address>
<p>In <a href="../../../../category/blog.html">blog</a>.</p>
<p>tags: <a href="../../../../tag/dns.html">dns</a> <a href="../../../../tag/go.html">go</a> <a href="../../../../tag/windows.html">windows</a> </p>
</footer><!-- /.post-info -->      <div class="section" id="id1">
<h2>はじめに</h2>
<p>Windows の Hyper-V の Linux 上でサーバサイドの開発をしていると Windows 上のウェブブラウザや Windows Subsystem for Linux の curl からアクセスする際に好みの FQDN でアクセスできるようにしたいというニーズがあります。</p>
<p>Windows は <code>C:\Windows\System32\drivers\etc\hosts</code> 、 Windows Subsystm for Linux は <code>/etc/hosts</code> を編集してエントリを追加して対応していたのですが 2 箇所変更するのが面倒です。</p>
<p>そんなときふと、手元でDNSサーバを動かせば良いのではと思いました。そうすれば、変更が1か所で済むしCNAMEやTXTレコードも扱えるという利点もあります。</p>
<p>そこで <a class="reference external" href="https://coredns.io/">CoreDNS</a> を試してみたら、手軽に使えて良さそうでした。</p>
<p>常用するとなると Windows の起動時に自動で CoreDNS も起動したいところです。スタートアップアプリとして実行するのでも良さそうですが、サービスとして実行できると便利かと思い、調べてみるとGoの良さそうなライブラリ <a class="reference external" href="https://github.com/kardianos/service">kardianos/service: Run go programs as a service on major platforms.</a> を見つけたので、サービス登録用のラッパ <a class="reference external" href="https://github.com/hnakamur/corednsservice">hnakamur/corednsservice</a> を書いてみました。</p>
<p>以下に設定手順とラッパの実装についてメモしておきます。</p>
</div>
<div class="section" id="id2">
<h2>環境構築手順</h2>
<div class="section" id="coredns">
<h3>CoreDNS のインストールと設定</h3>
<p><a class="reference external" href="https://coredns.io/">CoreDNS</a> の Download から Windows 用の実行ファイルを含んだ tarball （例: coredns_1.6.4_windows_amd64.tgz） をダウンロードします。</p>
<p>CoreDNS 用のディレクトリを作成してそこに展開します。以下は <code>C:\CoreDNS</code> として説明します。</p>
<p>以下は Windows Subsystem for Linux での実行例を示します（なお真面目には tarball を保存して sha256 ファイルとチェックしたほうが良いです）。</p>
<div class="highlight"><pre><span></span><span class="go">mkdir /mnt/c/CoreDNS</span>
<span class="go">cd /mnt/c/CoreDNS</span>
<span class="go">curl -LO https://github.com/coredns/coredns/releases/download/v1.6.4/coredns_1.6.4_windows_amd64.tgz | tar zxf -</span>
</pre></div>
<p>設定は <a class="reference external" href="https://coredns.io/manual/toc/">CoreDNS: DNS and Service Discovery</a> を参考に適宜行います。</p>
<p>例として以下のファイルを作ってみました。
<code>example.org</code> のドメインはファイルでDNSレコードを設定してそれ以外は Google Public DNSにフォワードする設定です。</p>
<p><code>C:\CoreDNS\Corefile</code></p>
<div class="highlight"><pre><span></span>example.org {
    file C:\CoreDNS\db.example.org
    log
}

. {
    forward . 8.8.8.8 8.8.4.4
    log
}
</pre></div>
<p><code>C:\CoreDNS\db.example.org</code></p>
<div class="highlight"><pre><span></span>$ORIGIN example.org.
@       3600 IN SOA sns.dns.icann.org. noc.dns.icann.org. (
                                2019103001 ; serial
                                7200       ; refresh (2 hours)
                                3600       ; retry (1 hour)
                                1209600    ; expire (2 weeks)
                                3600       ; minimum (1 hour)
                                )

sv01    IN A 192.0.2.11
sv02    IN A 192.0.2.12
</pre></div>
<p>ローカルで使うだけなら上記のようにNSレコードは省略しても動きました。</p>
</div>
<div class="section" id="corednsservice">
<h3>corednsserviceのインストールと設定</h3>
<p><a class="reference external" href="https://github.com/hnakamur/corednsservice">hnakamur/corednsservice</a> の releases から <code>corednsservice.exe</code> をダウンロードして <code>C:\CoreDNS</code> に保存します。</p>
<p>Windows Subsystem for Linux での実行例を示します。</p>
<div class="highlight"><pre><span></span><span class="go">curl -LO https://github.com/hnakamur/corednsservice/releases/download/v0.1.0/corednsservice.exe -C /mnt/c/CoreDNS</span>
</pre></div>
<p>設定ファイルは <code>corednsservice.exe</code> と同じディレクトリに <code>corednsservice.yml</code> というファイル名で配置する必要があります。</p>
<p>以下に例を示します。</p>
<div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CoreDNS</span>
<span class="nt">display_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CoreDNS service</span>
<span class="nt">description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">CoreDNS service for local development.</span>
<span class="nt">exec</span><span class="p">:</span> <span class="s">&quot;C:\\CoreDNS\\coredns.exe&quot;</span>
<span class="nt">args</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;-conf&quot;</span><span class="p p-Indicator">,</span> <span class="s">&quot;Corefile&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">dir</span><span class="p">:</span> <span class="s">&quot;C:\\CoreDNS&quot;</span>
<span class="nt">stdout</span><span class="p">:</span>
  <span class="nt">filename</span><span class="p">:</span> <span class="s">&quot;C:\\CoreDNS\\coredns.log&quot;</span>
  <span class="nt">maxsize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
  <span class="nt">maxbackups</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">50</span>
  <span class="nt">maxage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
  <span class="nt">compress</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
<p>サービスの登録は管理者権限のコマンドプロンプトを開いて以下のように実行します。
タスクマネージャを開いて[サービス]タブに CoreDNS というサービスが登録されたことを確認します。</p>
<div class="highlight"><pre><span></span>cd \CoreDNS
corednsservice -service install
</pre></div>
<p>サービス起動はコマンドプロンプトで以下のように実行します。あるいはタスクマネージャの[サービス]タブで CoreDNS を選んでポップアップメニューの開始でも良いです。</p>
<p>起動成功するとタスクマネージャの[サービス]タブの CoreDNS が実行中になり、[詳細]タブでは <code>coredns.exe</code> と <code>corednsservice.exe</code> が実行中になります。</p>
<div class="highlight"><pre><span></span>corednsservice -service start
</pre></div>
<p>ちなみにサービス停止は以下のようにします。</p>
<div class="highlight"><pre><span></span>corednsservice -service stop
</pre></div>
<p>サービスの登録解除は以下のようにします。</p>
<div class="highlight"><pre><span></span>corednsservice -service uninstall
</pre></div>
<p>CoreDNS のサービスを動かした状態で Windows Subsystem for Linux の端末から動作確認した例を示します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> dig @localhost sv01.example.org

<span class="go">; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.9-Ubuntu &lt;&lt;&gt;&gt; @localhost sv01.example.org</span>
<span class="go">; (1 server found)</span>
<span class="go">;; global options: +cmd</span>
<span class="go">;; Got answer:</span>
<span class="go">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 9988</span>
<span class="go">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span>
<span class="go">;; WARNING: recursion requested but not available</span>

<span class="go">;; OPT PSEUDOSECTION:</span>
<span class="go">; EDNS: version: 0, flags:; udp: 4096</span>
<span class="go">; COOKIE: 9f20a2550c810519 (echoed)</span>
<span class="go">;; QUESTION SECTION:</span>
<span class="go">;sv01.example.org.              IN      A</span>

<span class="go">;; ANSWER SECTION:</span>
<span class="go">sv01.example.org.       3600    IN      A       192.0.2.11</span>

<span class="go">;; Query time: 0 msec</span>
<span class="go">;; SERVER: 127.0.0.1#53(127.0.0.1)</span>
<span class="go">;; WHEN: Wed Oct 30 12:25:14 JST 2019</span>
<span class="go">;; MSG SIZE  rcvd: 89</span>
</pre></div>
<p>また <code>dig &#64;localhost example.net</code> など <code>example.org</code> 以外のドメインの名前解決も試してフォワーディングが動いていることを確認します。</p>
</div>
<div class="section" id="windowsdns">
<h3>WindowsでローカルのDNSを使う設定</h3>
<p>コントロールパネルの[ネットワークとインターネット]→[イーサネット]と進んで、[アダプターのオプションを変更する]リンクをクリックします。</p>
<p>[Wi-Fi]と[イーサネット]についてそれぞれ以下の設定を行います。</p>
<ul class="simple">
<li>プロパティの[インターネット プロトコル バージョン 4 (TCP/IP)]で優先DNSサーバを <code>127.0.0.1</code> 、代替DNSサーバを空に変更。もし元々固定で設定していた場合は元の構成に戻すときのために変更前の値をどこかにメモしておきます。</li>
<li>プロパティの[インターネット プロトコル バージョン 4 (TCP/IP)]で優先DNSサーバを <code>::1</code> 、 代替DNSサーバを空に変更。</li>
</ul>
<p>設定したらコマンドプロンプトを開いて動作確認します。</p>
<div class="highlight"><pre><span></span>C:\&gt;nslookup sv01.example.org
サーバー:  UnKnown
Address:  ::1

名前:    sv01.example.org
Address:  192.0.2.11
</pre></div>
</div>
<div class="section" id="windows-subsystem-for-linuxdns">
<h3>Windows Subsystem for LinuxでローカルのDNSを使う設定</h3>
<p><a class="reference external" href="https://github.com/microsoft/WSL/issues/3268">DNS not working in fresh Ubuntu 18.04 that installed from Windows Store · Issue #3268 · microsoft/WSL</a> というイシューの <a class="reference external" href="https://github.com/microsoft/WSL/issues/3268#issuecomment-543190053">コメント</a> で知った <a class="reference external" href="https://gist.github.com/coltenkrauter/608cfe02319ce60facd76373249b8ca6">Fix DNS resolution in WSL2</a> の手順で設定します。 WSL2 と書かれていますが WSL1 でもこの手順で行けました。</p>
<p>Windows Subsystem for Linux の端末で変更前の <code>/etc/resolve.conf</code> を確認してみると上記のリンク先に書かれているように <code>../run/resolvconf/resolv.conf</code> へのシンボリックリンクになっていました。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> ls -l /etc/resolv.conf
<span class="go">lrwxrwxrwx 1 root root 29 May 25  2018 /etc/resolv.conf -&gt; ../run/resolvconf/resolv.conf</span>
</pre></div>
<p>Windows Subsystem for Linux の端末で以下のように実行して設定を変更します。</p>
<div class="highlight"><pre><span></span><span class="go">mv /etc/resolv.conf{,.bak}</span>
<span class="go">echo &#39;nameserver 127.0.0.1&#39; | sudo tee /etc/resolv.conf</span>
</pre></div>
<p>これで今度は <code>&#64;localhost</code> なしで <code>dig sv01.example.org</code> などとして動作確認します。</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> dig sv01.example.org

<span class="go">; &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.9-Ubuntu &lt;&lt;&gt;&gt; sv01.example.org</span>
<span class="go">;; global options: +cmd</span>
<span class="go">;; Got answer:</span>
<span class="go">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 38075</span>
<span class="go">;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</span>
<span class="go">;; WARNING: recursion requested but not available</span>

<span class="go">;; OPT PSEUDOSECTION:</span>
<span class="go">; EDNS: version: 0, flags:; udp: 4096</span>
<span class="go">; COOKIE: 797c9c0a9107764c (echoed)</span>
<span class="go">;; QUESTION SECTION:</span>
<span class="go">;sv01.example.org.              IN      A</span>

<span class="go">;; ANSWER SECTION:</span>
<span class="go">sv01.example.org.       3600    IN      A       192.0.2.11</span>

<span class="go">;; Query time: 0 msec</span>
<span class="go">;; SERVER: 127.0.0.1#53(127.0.0.1)</span>
<span class="go">;; WHEN: Wed Oct 30 12:51:03 JST 2019</span>
<span class="go">;; MSG SIZE  rcvd: 89</span>
</pre></div>
<p>ここまで確認出来たら後は実際の利用ケースに応じて、設定ファイルを書き換えて CoreDNS のサービスを再起動すればOKです。</p>
</div>
</div>
<div class="section" id="id4">
<h2>開発メモ</h2>
<p><a class="reference external" href="https://github.com/hnakamur/corednsservice">hnakamur/corednsservice</a> は
<a class="reference external" href="https://github.com/kardianos/service">kardianos/service</a> の
<a class="reference external" href="https://github.com/kardianos/service/blob/4df36c9fc1c6ac86231851ad6fa5627e184c94e5/example/runner/runner.go">example/runner/runner.go</a> をベースにしています。</p>
<p>変更点は以下の通りです。</p>
<ul class="simple">
<li>設定ファイルをJSONからYAMLに変更。</li>
<li><dl class="first docutils">
<dt>ログをファイルに保存するようにした。</dt>
<dd><ul class="first last">
<li><code>gopkg.in/natefinch/lumberjack.v2</code> パッケージを使ってローテートするようにしています。といいつつ実際にログがローテートされるかの確認はまだです。</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>ログの各行にタイムスタンプを追加。</dt>
<dd><ul class="first last">
<li>CoreDNS の <a class="reference external" href="https://coredns.io/plugins/log/">log</a> プラグインはドキュメントを見るとログに日時を出力できるとあるのですが設定項目が見当たりません。調べてみると <a class="reference external" href="https://github.com/coredns/coredns/pull/3218">pkg/log: remove timestamp by miekg · Pull Request #3218 · coredns/coredns</a> で出力しないように変更されていました。ということで自前で出力するようにしました。</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="vethernet-default-switch">
<h2>脱線: vEthernet (Default Switch) のアドレス</h2>
<p>はじめにに入れるには長すぎるので別項目にしました。</p>
<p>Multipass で作成した VM は vEthernet (Default Switch) のネットワークインターフェースを使うのですが、Windowsの再起動の都度IPアドレスが変わってしまいます。</p>
<p><a class="reference external" href="https://github.com/CanonicalLtd/multipass/issues/1153">[feature request] Support for NAT network on Hyper-V virtual switch · Issue #1153 · CanonicalLtd/multipass</a> にNAT対応の要望を上げてみたところ、 <code>インスタンス名.mshome.net</code> で名前解決できると教わりました。例えば <code>primary</code> という VM なら <code>primary.mshome.net</code> です。</p>
<p>調べてみると <code>C:\Windows\System32\drivers\etc\hosts.ics</code> というファイルにVMに対応したエントリが作られていました。</p>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Internet_Connection_Sharing">Internet Connection Sharing</a> （インターネット接続共有）というWinodwsの機能らしいです。</p>
<p>ですが、これだと Windows 上のブラウザでは名前解決できるのですが、 Windows Subsystem for Linux の curl や ssh からは参照できないのと、 <code>mshome.net</code> 以外のドメインを使いたいというニーズも満たせないなあと思いました。</p>
<p>で、DNSサーバをローカルに立てて CNAME で <code>primary.mshome.net</code> に向ければ良いかもと思ったのが発端です。</p>
<p>ただ、やっぱり Multipass で扱えなくても NAT にして Hyper-V で直接VMを使う方式のほうが良いかなあと考え中です。</p>
<p>いずれにせよローカルでDNSが動いていると開発には便利なのでCoreDNS使ってみようと思います。</p>
</div>

    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is a custom version based on <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-53263855-1', 'auto');
    ga('send', 'pageview');
    </script>
</body>
</html>