<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.84.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>仮想マシンマネージャmultipassをWindowsとmacOSで試してみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>仮想マシンマネージャmultipassをWindowsとmacOSで試してみた</h1>
  <time datetime=2019-10-17T06:00:00&#43;0900 class="post-date">2019-10-17</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#仮想マシンの作成起動">仮想マシンの作成・起動</a></li>
    <li><a href="#仮想マシンのシェル実行">仮想マシンのシェル実行</a></li>
    <li><a href="#ホストのディレクトリのマウント">ホストのディレクトリのマウント</a></li>
    <li><a href="#仮想マシンの一覧表示">仮想マシンの一覧表示</a></li>
    <li><a href="#仮想マシンの情報表示">仮想マシンの情報表示</a></li>
    <li><a href="#アンマウント">アンマウント</a></li>
    <li><a href="#仮想マシン停止">仮想マシン停止</a></li>
    <li><a href="#仮想マシン起動">仮想マシン起動</a></li>
    <li><a href="#仮想マシン削除">仮想マシン削除</a></li>
    <li><a href="#ヘルプ表示">ヘルプ表示</a></li>
  </ul>

  <ul>
    <li><a href="#cとqt5で書かれている">C++とQt5で書かれている</a></li>
    <li><a href="#windowsでvirtualboxドライバで試したときのメモ">WindowsでVirtualBoxドライバで試したときのメモ</a></li>
    <li><a href="#windowsでhyper-vドライバで試したときのメモ">WindowsでHyper-Vドライバで試したときのメモ</a></li>
    <li><a href="#macos-mojaveで試したときのメモ">macOS Mojaveで試したときのメモ</a></li>
    <li><a href="#仮想マシン内のrootsshauthorized_keys">仮想マシン内の/root/.ssh/authorized_keys</a></li>
  </ul>
</nav>
  <h1 id="はじめに">はじめに</h1>
<p>multipass は私は Linux で <a href="https://snapcraft.io/first-snap#">Snapcraft - Snaps are universal Linux packages</a> のチュートリアルで snap パッケージを作ってみた時にインストールされたのが初めての出会いでしたが、その時はなんかまた新しい仮想マシンのツールが増えたのかぐらいに思っていました。</p>
<p>そこに <a href="https://gihyo.jp/admin/serial/01/ubuntu-recipe/0590">第590回　Windows/macOS/Linuxで使える仮想マシン管理ツール『multipass』：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社</a> の記事を見かけて、Linux以外に Windows と macOS でも使えることを知りました。</p>
<p>私は仕事で Linux のサーバサイドの開発環境を Windows と macOS 上に構築するのに <a href="https://www.virtualbox.org/">VirtualBox</a> と <a href="https://www.vagrantup.com/">Vagrant</a> で Ubuntu 仮想マシンを作ってそこで <a href="https://linuxcontainers.org/ja/lxd/introduction/">Linux Containers - LXD</a> を使って複数のコンテナを作るようにしています。</p>
<p>しかし <a href="https://news.mynavi.jp/article/20190515-823235/">Windows 10 WSL 2の詳細が明らかに、VMware/VirtualBoxとの併用不可 | マイナビニュース</a> にあるように、 WSL2 が Hyper-V のサブセットを使っていて VirtualBox と共存できないという問題があるので、どうしようか悩んでいました。私は Windows Insiders は使って無いので通常版の Windows で WSL2 がリリースされるのを待っている段階ですがリリースされたらぜひ使いたいのですが、一方で Windows と macOS で構築手順が分かれると構築用のスクリプトのメンテナンスが面倒なので出来れば統一しておきたいという思いもあるからです。</p>
<p><a href="https://github.com/microsoft/WSL/issues/4174">Is it Possible to Run WSL2 and Oracle VirtualBox? · Issue #4174 · microsoft/WSL</a> のコメントからリンクされている <a href="https://forums.virtualbox.org/viewtopic.php?f=6&amp;t=90853&amp;start=60#p445491">virtualbox.org • View topic - VirtualBox 6.0 and Hyper-V</a> によると VirtualBox 6.0 から Hyper-V 環境でも動かすためのサポートが入ったのですが highly pre-alpha という状態で、私も ThinkPad X260 の Windows 10 Pro で試してみたのですがうまく動きませんでした（詳細は失念）。</p>
<p><a href="https://github.com/CanonicalLtd/multipass">CanonicalLtd/multipass: Multipass orchestrates virtual Ubuntu instances</a> を見るとLinuxではKVM、WindowsではHyper-V、macOSではHyperKitを使い、WindowsとmacOSではVirtualBoxも使えるとあり、これで上記の問題が解決できるのでは、ということで喜んで試してみました。</p>
<p>macOS 用には <a href="https://qiita.com/satokaz/items/ab974af5632d1389add2">macOS で multipass やってみようぜ - Qiita</a> という良いまとめ記事があったのでこちらを参考にしつつ試して調べた内容をメモしておきます。</p>
<h1 id="windows版とmacos版のインストール">Windows版とmacOS版のインストール</h1>
<p><a href="https://github.com/CanonicalLtd/multipass/releases">Releases · CanonicalLtd/multipass</a> にWindows版とmacOS版のインストーラがあるのでダウンロードしてインストールします。今回試したのはバージョン0.8.0です。</p>
<h1 id="まずwindowsでvirtualboxのドライバで試す">まずWindowsでVirtualBoxのドライバで試す</h1>
<p>職場のThinkPadではVirtualBoxを利用中ですぐにHyper-Vを有効には出来ない状態なので、まずはVirtualBoxドライバで試してみました。</p>
<p>現在選択されているドライバは管理者コマンドプロンプトで以下のコマンドで確認できます（一般ユーザのコマンドプロンプトでは権限不足でした）。</p>
<pre><code class="language-console" data-lang="console">C:\&gt;multipass get local.driver
hyperv
</code></pre><p>上記のようにHyper-V無効の環境でも初期状態ではhypervになっています。そこで以下のコマンドを実行しvirtualboxドライバを使うように切り替えます。</p>
<pre><code class="language-console" data-lang="console">multipass set local.driver virtualbox
</code></pre><p><a href="https://gihyo.jp/admin/serial/01/ubuntu-recipe/0590">第590回　Windows/macOS/Linuxで使える仮想マシン管理ツール『multipass』：Ubuntu Weekly Recipe｜gihyo.jp … 技術評論社</a> の記事にも書かれていますがドライバの切り替えは気軽に行えるものではなく、インストール直後に設定してそれでずっと使うという感じのようです。</p>
<p>ここからは一般ユーザのコマンドプロンプトで実行可能でした（ただし管理者権限はついたユーザで試していて、管理者権限なしのユーザでも可能かは不明です）。</p>
<p>あと、別の環境で Hyper-V を有効にした Windows 10 Pro と macOS Mojave でも試しました。</p>
<h1 id="仮想マシンの基本操作">仮想マシンの基本操作</h1>
<p>以下の操作は <code>multipass</code> を <code>multipass.exe</code> とすれば `wsltty](<a href="https://github.com/mintty/wsltty">https://github.com/mintty/wsltty</a>) でも可能でした（ただし後述のようにホストのディレクトリのマウントの初回実行はコマンドプロンプトで行う必要があるようでした）。</p>
<h2 id="仮想マシンの作成起動">仮想マシンの作成・起動</h2>
<p>以下のようにして仮想マシンを作成・起動します（オプションの説明は <code>multipass launch -h</code> を参照してください）。</p>
<pre><code class="language-console" data-lang="console">multipass launch -n primary -c 2 -m 4G -d 100G
</code></pre><p><code>-n</code> オプションを省略すると <code>petit-shrew</code> のようなランダムな名前が自動で設定されました。仮想マシンのシェルを実行する <code>multipass shell</code> コマンドなどがデフォルトでは <code>primary</code> という仮想マシンを対象とするので、仮想マシンを1つだけ作るのであれば上記のように <code>primary</code> という名前で作成するのが良いです。</p>
<h2 id="仮想マシンのシェル実行">仮想マシンのシェル実行</h2>
<p><code>primary</code> の仮想マシンの場合は以下のように実行すると、インタラクティブなシェルが起動します。</p>
<pre><code class="language-console" data-lang="console">multipass shell
</code></pre><p>それ以外の場合は <code>multipass shell petit-shrew</code> のように仮想マシン名を引数に指定して起動します（<code>-n</code> オプションではないので注意。詳細は <code>multipass shell -h</code> を参照してください）。</p>
<p>上記のコマンドを実行すると <code>multipass</code> ユーザでログインした状態になります。シェルを終了するのは <code>exit</code> コマンドを実行するか Ctrl-D を押します。</p>
<h2 id="ホストのディレクトリのマウント">ホストのディレクトリのマウント</h2>
<p>仮想マシンのホストであるWindowsのディレクトリを仮想マシンにマウントするのは以下のようにします。ディレクトリ名は適宜変更してください。マウント先のディレクトリは自動的に作成されました。</p>
<pre><code class="language-console" data-lang="console">multipass mount C:/Users/hnakamur/foo primary:foo
</code></pre><p>マウント先は <code>primary</code> のようにマウント先ディレクトリ名を省略して仮想マシン名だけでも可能です。が、 <code>/home/multipass/C:/Users/hnakamur/foo</code> のようなディレクトリにマウントされ、しかも <code>/home/multipass/C:</code> ディレクトリの所有者が <code>root</code> になってしまいました。</p>
<p>上記のようにマウント先を <code>primary:foo</code> のように仮想マシン名とディレクトリの指定にすると <code>/home/multipass/foo</code> にマウントされ、所有者も <code>multipass</code> ユーザになります。こちらのほうがお勧めです。</p>
<p>マウントの初回実行時は <code>Enabling support for mounting</code> というメッセージと <code>\|/-</code> の文字がくるくる回るインジケータがしばらく表示されました。初回実行を wsltty から行ったときはこれがいつまでも続いたので待ちきれず端末のウィンドウを閉じました。初回だけコマンドプロンプトから実行しておけば、あとはwslttyからでも問題ないようです。</p>
<h2 id="仮想マシンの一覧表示">仮想マシンの一覧表示</h2>
<p>実行例を以下に示します。</p>
<pre><code class="language-console" data-lang="console">C:\&gt;multipass list
Name                    State             IPv4             Image
primary                 Running           192.168.133.102  Ubuntu 18.04 LTS
</code></pre><h2 id="仮想マシンの情報表示">仮想マシンの情報表示</h2>
<p>実行例を以下に示します。マウント状態も確認できます。</p>
<pre><code class="language-console" data-lang="console">C:\&gt;multipass info --all
Name:           primary
State:          Running
IPv4:           192.168.133.102
Release:        Ubuntu 18.04.3 LTS
Image hash:     6204b6bff4ce (Ubuntu 18.04 LTS)
Load:           0.22 0.08 0.02
Disk usage:     1.7G out of 96.7G
Memory usage:   3.0G out of 3.9G
Mounts:         C:/Users/hnakamur/foo =&gt; foo
                    UID map: -2:default
                    GID map: -2:default
</code></pre><h2 id="アンマウント">アンマウント</h2>
<p>以下のようにマウント先の仮想マシンとディレクトリを指定してアンマウントします。</p>
<pre><code class="language-console" data-lang="console">multipass umount primary:foo
</code></pre><h2 id="仮想マシン停止">仮想マシン停止</h2>
<pre><code class="language-console" data-lang="console">multipass stop VM名
</code></pre><h2 id="仮想マシン起動">仮想マシン起動</h2>
<pre><code class="language-console" data-lang="console">multipass start VM名
</code></pre><h2 id="仮想マシン削除">仮想マシン削除</h2>
<p><code>-p</code> のpurgeオプションを付けて削除します。 <code>-p</code> なしだとファイルが残ったままになるらしいです。</p>
<pre><code class="language-console" data-lang="console">multipass delete -p VM名
</code></pre><h2 id="ヘルプ表示">ヘルプ表示</h2>
<p>他にもサブコマンドがあります。 <code>-h</code> オプションでヘルプを見るのが手っ取り早いです。</p>
<pre><code class="language-console" data-lang="console">C:\&gt;multipass -h
Usage: multipass [options] &lt;command&gt;
Create, control and connect to Ubuntu instances.

This is a command line utility for multipass, a
service that manages Ubuntu instances.

Options:
  -?, -h, --help  Display this help
  -v, --verbose   Increase logging verbosity, repeat up to three times for more
                  detail

Available commands:
  delete    Delete instances
  exec      Run a command on an instance
  find      Display available images to create instances from
  get       Get a configuration option
  help      Display help about a command
  info      Display information about instances
  launch    Create and start an Ubuntu instance
  list      List all available instances
  mount     Mount a local directory in the instance
  purge     Purge all deleted instances permanently
  recover   Recover deleted instances
  restart   Restart instances
  set       Set a configuration option
  shell     Open a shell on a running instance
  start     Start instances
  stop      Stop running instances
  suspend   Suspend running instances
  transfer  Transfer files between the host and instances
  umount    Unmount a directory from an instance
  version   Show version details
</code></pre><h1 id="調査メモ">調査メモ</h1>
<p>以下こまごまとしたメモ。</p>
<h2 id="cとqt5で書かれている">C++とQt5で書かれている</h2>
<p><a href="https://github.com/CanonicalLtd/multipass">CanonicalLtd/multipass: Multipass orchestrates virtual Ubuntu instances</a> を見るとソースはC++とQt5で書かれています。 <a href="https://github.com/CanonicalLtd/multipass/blob/v0.8.0/COPYING.GPL.txt">COPYING.GPL.txt</a> を見るとライセンスは GPLv3 です。</p>
<h2 id="windowsでvirtualboxドライバで試したときのメモ">WindowsでVirtualBoxドライバで試したときのメモ</h2>
<ul>
<li>ネットワークインタフェース名は <code>enp0s3</code> になった。</li>
<li>IPアドレスは 10.0.2.15/24。なのでVirtualBoxのNATのネットワークアダプタが使われている模様。</li>
<li><code>multipass info --all</code> の出力で IPv4 のアドレスは N/A と表示。</li>
<li>VirtualBoxマネージャにはVMは表示されない。</li>
<li>仮想マシンのイメージファイルは <code>C:\Windows\System32\config\systemprofile\VirtualBox VMs\Multipass</code> 以下に仮想マシン名のディレクトリが作られてそこに置かれている。ファイル名は仮想マシン名 + .vbox。</li>
<li><code>%USERPROFILE%\AppData\Roaming\multipass\client-certificate</code> というディレクトリに <code>multipass_cert.pem</code> と <code>multipass_cert_key.pem</code> という鍵と証明書がある。</li>
</ul>
<h2 id="windowsでhyper-vドライバで試したときのメモ">WindowsでHyper-Vドライバで試したときのメモ</h2>
<ul>
<li>ネットワークインタフェース名は <code>eth0</code> になった。</li>
<li>IPアドレスはランダムに割り当てられる（例： 192.168.133.102）。 <code>multipass info</code> コマンドのIPv4の欄でも確認可能。</li>
<li>仮想マシンのイメージファイルは <code>C:\Windows\System32\config\systemprofile\AppData\Roaming\multipassd\vault\instances</code> 以下に仮想マシン名のディレクトリが作られてそこに置かれている。拡張子は <code>.vhdx</code> と <code>.avhdx</code> 。 また <code>cloud-init-config.iso</code> というファイルもあった。</li>
<li><code>%USERPROFILE%\AppData\Roaming\multipass\client-certificate</code> というディレクトリに <code>multipass_cert.pem</code> と <code>multipass_cert_key.pem</code> という鍵と証明書がある（これはVirtualBoxドライバの場合と同じ）。</li>
</ul>
<h2 id="macos-mojaveで試したときのメモ">macOS Mojaveで試したときのメモ</h2>
<ul>
<li>ネットワークインタフェース名は <code>enp0s2</code> になった。</li>
<li>IPアドレスはランダムに割り当てられる（例： 192.168.64.2）。 <code>multipass info</code> コマンドのIPv4の欄でも確認可能。</li>
<li>仮想マシンのイメージファイルは <code>/var/root/Library/Application Support/multipassd/vault/instances/</code> 以下に仮想マシン名のディレクトリが作られてそこに置かれている。また <code>cloud-init-config.iso</code> というファイルもあった。</li>
<li><code>~/Library/Application Support/multipass/client-certificates</code> ディレクトリに <code>multipass_cert.pem</code> と <code>multipass_cert_key.pem</code> という鍵と証明書がある。</li>
</ul>
<h2 id="仮想マシン内のrootsshauthorized_keys">仮想マシン内の/root/.ssh/authorized_keys</h2>
<p>私は面倒くさがりなのでホストからrootユーザでsshできるように <code>~multipass/.ssh/authorized_keys</code> を <code>/root/.ssh</code> にコピーしようとしたら既にファイルがあることに気づきました。内容を確認すると以下のようになっていました。</p>
<pre><code class="language-console" data-lang="console">multipass@primary:~$ sudo cat /root/.ssh/authorized_keys
no-port-forwarding,no-agent-forwarding,no-X11-forwarding,command=&quot;echo 'Please login as the user \&quot;multipass\&quot; rather than the user \&quot;root\&quot;.';echo;sleep 10&quot; ssh-rsa AAAAB...(snip)...Ybx multipass@localhost
</code></pre><p><code>root</code> ユーザでログインせずに <code>multipass</code> ユーザでログインせよとのことです。ここまでして啓蒙してくれているのでおとなしく従おうかなという気になりました。</p>
<h1 id="おわりに">おわりに</h1>
<p>とりあえず試してみた感じでは良さそうです。VM起動時に <code>--clout-init</code> オプションで <a href="https://github.com/cloud-init/cloud-init/">cloud-init</a> を使った初期設定も行えるのでこちらも試していきたいところです。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
