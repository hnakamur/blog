<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.122.0">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>LXDでUbuntuコンテナにロケールとタイムゾーンを設定するプロファイル &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2024. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>LXDでUbuntuコンテナにロケールとタイムゾーンを設定するプロファイル</h1>
  <time datetime=2019-08-15T12:45:00&#43;0900 class="post-date">2019-08-15</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#タイムゾーンの確認">タイムゾーンの確認</a></li>
    <li><a href="#ロケールの確認">ロケールの確認</a></li>
  </ul>
</nav>
  <h1 id="はじめに">はじめに</h1>
<p><a href="https://blog.simos.info/how-to-preconfigure-lxd-containers-with-cloud-init/">How to preconfigure LXD containers with cloud-init – Mi blog lah!</a> に cloud-init を使って Ubuntu コンテナの初期化時にロケールとタイムゾーンを設定する方法が紹介されていたのでメモしておきます。</p>
<h1 id="ubuntu-用のプロファイル作成">Ubuntu 用のプロファイル作成</h1>
<p><a href="/blog/2019/08/15/lxd-container-templates/">LXDでコンテナの初期化に使われるテンプレート</a> に書いたように CentOS 7 コンテナは cloud-init 非対応ですので、 Ubuntu 用のプロファイルを作成して、そこにロケールとタイムゾーンの設定を入れることにします。</p>
<p><code>default</code> プロファイルは</p>
<p>まず以下のコマンドで Ubuntu 用のプロファイルを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">lxc profile create ubuntu
</span></span></span></code></pre></div><p>次に今作成したプロファイルを編集します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">lxc profile edit ubuntu
</span></span></span></code></pre></div><p><code>config:</code> と <code>description:</code> の部分を以下のように書き換えます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">environment.LANG</span><span class="p">:</span><span class="w"> </span><span class="l">en_US.UTF-8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">user.user-data</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    #cloud-config
</span></span></span><span class="line"><span class="cl"><span class="sd">    locale: ja_JP.UTF-8
</span></span></span><span class="line"><span class="cl"><span class="sd">    timezone: Asia/Tokyo</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">Additional settings for Ubuntu</span><span class="w">
</span></span></span></code></pre></div><h1 id="ubuntu-コンテナの作成と起動">Ubuntu コンテナの作成と起動</h1>
<p><code>default</code> プロファイルと上記で作成した <code>ubuntu</code> プロファイルを使用して
<code>c1</code> という Ubuntu 18.04 LTS のコンテナを作成・起動するには以下のようにします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">lxc launch -p default -p ubuntu ubuntu:18.04 c1
</span></span></span></code></pre></div><h2 id="タイムゾーンの確認">タイムゾーンの確認</h2>
<p>私の環境だと cloud-init が完了するまで 10 秒程度かかるため、 起動直後に <code>/etc/timezone</code> の中身を確認し、 <code>date</code> コマンドを実行すると UTC になっています。
10 秒ほどしてから再度実行するとタイムゾーンとロケールが指定通りになっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> lxc <span class="nb">exec</span> c1 -- sh -c <span class="s1">&#39;cat /etc/timezone; date&#39;</span>
</span></span><span class="line"><span class="cl"><span class="go">Etc/UTC
</span></span></span><span class="line"><span class="cl"><span class="go">Thu Aug 15 03:00:12 UTC 2019
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> lxc <span class="nb">exec</span> c1 -- sh -c <span class="s1">&#39;cat /etc/timezone; date&#39;</span>
</span></span><span class="line"><span class="cl"><span class="go">Asia/Tokyo
</span></span></span><span class="line"><span class="cl"><span class="go">Thu Aug 15 12:00:21 JST 2019
</span></span></span></code></pre></div><p>cloud-init の初期化が完了すると <code>/run/cloud-init/result.json</code> というファイルが作られるので、以下のようにすれば完了を待つことができます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> lxc launch -p default -p ubuntu ubuntu:18.04 c2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="go">  &amp;&amp; lxc exec c2 -- sh -c &#39;while ! [ -f /run/cloud-init/result.json ]; do sleep 1; done&#39; \
</span></span></span><span class="line"><span class="cl"><span class="go">  &amp;&amp; lxc exec c2 -- sh -c &#39;cat /etc/timezone; date&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">Creating c2
</span></span></span><span class="line"><span class="cl"><span class="go">Starting c2
</span></span></span><span class="line"><span class="cl"><span class="go">Asia/Tokyo
</span></span></span><span class="line"><span class="cl"><span class="go">Thu Aug 15 12:06:42 JST 2019
</span></span></span></code></pre></div><p>シェルスクリプトで自動化するときにこの手が使えます。</p>
<p>とは言っても、 Ubuntu コンテナの場合は cloud-init の <a href="https://cloudinit.readthedocs.io/en/latest/topics/modules.html">Modules</a> でパッケージのインストールやコマンドの実行を行うことができます。</p>
<p>パッケージのインストールやコマンド実行は <a href="https://blog.simos.info/how-to-preconfigure-lxd-containers-with-cloud-init/">How to preconfigure LXD containers with cloud-init – Mi blog lah!</a> にあるように profile の config に以下のように設定すればできるそうです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">user.user-data</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">    #cloud-config
</span></span></span><span class="line"><span class="cl"><span class="sd">    package_upgrade: true
</span></span></span><span class="line"><span class="cl"><span class="sd">    packages:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - build-essential
</span></span></span><span class="line"><span class="cl"><span class="sd">    locale: es_ES.UTF-8
</span></span></span><span class="line"><span class="cl"><span class="sd">    timezone: Europe/Madrid
</span></span></span><span class="line"><span class="cl"><span class="sd">    runcmd:
</span></span></span><span class="line"><span class="cl"><span class="sd">      - [touch, /tmp/simos_was_here]</span><span class="w">    
</span></span></span></code></pre></div><p>これらの処理を cloud-init で行ってそれの完了を待つには、上記の通り <code>/run/cloud-init/result.json</code> というファイルが作られるのを待てば OK です。</p>
<h2 id="ロケールの確認">ロケールの確認</h2>
<p>システムのロケールは指定通り <code>ja_JP.UTF-8</code> になっています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> lxc <span class="nb">exec</span> c2 -- localectl
</span></span><span class="line"><span class="cl"><span class="go">   System Locale: LANG=ja_JP.UTF-8
</span></span></span><span class="line"><span class="cl"><span class="go">       VC Keymap: n/a
</span></span></span><span class="line"><span class="cl"><span class="go">      X11 Layout: us
</span></span></span><span class="line"><span class="cl"><span class="go">       X11 Model: pc105
</span></span></span></code></pre></div><p><code>LANG</code> 環境変数は指定通り <code>en_US.UTF-8</code> になっているので <code>ls -l</code> の日付は英語で出力されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> lxc <span class="nb">exec</span> c2 -- sh -c <span class="s1">&#39;echo $LANG&#39;</span>
</span></span><span class="line"><span class="cl"><span class="go">en_US.UTF-8
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">$</span> lxc <span class="nb">exec</span> c2 -- ls -ld /
</span></span><span class="line"><span class="cl"><span class="go">drwxr-xr-x 22 root root 4096 Aug 14 01:34 /
</span></span></span></code></pre></div><p><code>LANG</code> 環境変数を <code>ja_JP.UTF-8</code> にすれば日本語で出力されます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> lxc <span class="nb">exec</span> c2 -- sh -c <span class="s1">&#39;LANG=ja_JP.UTF-8 ls -ld /&#39;</span>
</span></span><span class="line"><span class="cl"><span class="go">drwxr-xr-x 22 root root 4096  8月 14 01:34 /
</span></span></span></code></pre></div><h1 id="default-プロファイルを書き換えるのもありかも">default プロファイルを書き換えるのもありかも</h1>
<p>私が作るのはほぼ Ubuntu コンテナで、たまに CentOS 7 という感じなので <code>default</code> プロファイルを書き換えるのもありかもと思いました。</p>
<p><code>lxc profile show default</code> で <code>default</code> プロファイルの内容を確認すると以下のようになっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">config</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">environment.LANG</span><span class="p">:</span><span class="w"> </span><span class="l">en_US.utf8</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l">Default LXD profile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">devices</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">eth0</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nictype</span><span class="p">:</span><span class="w"> </span><span class="l">bridged</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">parent</span><span class="p">:</span><span class="w"> </span><span class="l">lxdbr0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">nic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">root</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">pool</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">disk</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">used_by</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">/1.0/containers/c2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- <span class="l">…(略)…</span><span class="w">
</span></span></span></code></pre></div><p>これをコピーして <code>centos</code> 用のプロファイルを作ります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> lxc profile copy default centos
</span></span></code></pre></div><p>で <code>lxc profile edit default</code> を実行して上記のように Ubuntu 用の設定を追加します。</p>
<p>すると Ubuntu のコンテナの作成・起動は以下のコマンドになり</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> lxc launch ubuntu:18.04 ubuntu1
</span></span></code></pre></div><p>CentOS 7 のコンテナの作成・起動は以下のコマンドになります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> lxc launch -p centos images:centos/7 cent1
</span></span></code></pre></div><p>プロファイルの <code>devices:</code> の設定が <code>default</code> と <code>centos</code> のプロファイルの2箇所に重複することになるので、変更の際は両方変える必要があるのが欠点です。</p>
<p>が、普段のコンテナ作成・起動はこちらのほうが楽で良さそうです。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>
  </body>
</html>
