<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.87.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>VictoriaMetricsにgraphite形式でデータ投入のコードリーディング &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>VictoriaMetricsにgraphite形式でデータ投入のコードリーディング</h1>
  <time datetime=2019-12-23T22:55:00&#43;0900 class="post-date">2019-12-23</time>
  <nav id="TableOfContents"></nav>
  <p><a href="https://github.com/VictoriaMetrics/VictoriaMetrics">VictoriaMetrics/VictoriaMetrics: VictoriaMetrics - fast, cost-effective and scalable time series database, long-term remote storage for Prometheus</a> の v1.31.2 のコードリーディングのメモ。</p>
<p>graphite 形式で投入したデータがどう格納されるかを調べたい。</p>
<p><code>app/vminsert/graphite</code> パッケージの <code>serveTCP</code> 関数から <code>insertHandler</code> 関数を呼び出している。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vminsert/graphite/server.go#L101">app/vminsert/graphite/server.go#L101</a></p>
<p>その先を辿ると <code>pushCtx</code> 構造体の <code>InsertRows</code> メソッド内で <code>app/vminsert/common/InsertCtx</code> 構造体の <code>WriteDataPoint</code> メソッドを呼び出している。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vminsert/graphite/request_handler.go#L54">app/vminsert/graphite/request_handler.go#L54</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">pushCtx</span><span class="p">)</span> <span class="nf">InsertRows</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">rows</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">Rows</span><span class="p">.</span><span class="nx">Rows</span>
  <span class="nx">ic</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Common</span>
  <span class="nx">ic</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">rows</span><span class="p">))</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rows</span> <span class="p">{</span>
    <span class="nx">r</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">rows</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
    <span class="nx">ic</span><span class="p">.</span><span class="nx">Labels</span> <span class="p">=</span> <span class="nx">ic</span><span class="p">.</span><span class="nx">Labels</span><span class="p">[:</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">ic</span><span class="p">.</span><span class="nf">AddLabel</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Metric</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Tags</span> <span class="p">{</span>
      <span class="nx">tag</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">r</span><span class="p">.</span><span class="nx">Tags</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
      <span class="nx">ic</span><span class="p">.</span><span class="nf">AddLabel</span><span class="p">(</span><span class="nx">tag</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nx">tag</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">ic</span><span class="p">.</span><span class="nf">WriteDataPoint</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">ic</span><span class="p">.</span><span class="nx">Labels</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Timestamp</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">rowsInserted</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">rows</span><span class="p">))</span>
  <span class="nx">rowsPerInsert</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">rows</span><span class="p">)))</span>
  <span class="k">return</span> <span class="nx">ic</span><span class="p">.</span><span class="nf">FlushBufs</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div><p><code>WriteDataPoint</code> メソッドの実装。</p>
<p><a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vminsert/common/insert_ctx.go#L50-L65">app/vminsert/common/insert_ctx.go#L50-L65</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// WriteDataPoint writes (timestamp, value) with the given prefix and labels into ctx buffer.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">InsertCtx</span><span class="p">)</span> <span class="nf">WriteDataPoint</span><span class="p">(</span><span class="nx">prefix</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">labels</span> <span class="p">[]</span><span class="nx">prompb</span><span class="p">.</span><span class="nx">Label</span><span class="p">,</span> <span class="nx">timestamp</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">float64</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">metricNameRaw</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">marshalMetricNameRaw</span><span class="p">(</span><span class="nx">prefix</span><span class="p">,</span> <span class="nx">labels</span><span class="p">)</span>
  <span class="nx">ctx</span><span class="p">.</span><span class="nf">addRow</span><span class="p">(</span><span class="nx">metricNameRaw</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// WriteDataPointExt writes (timestamp, value) with the given metricNameRaw and labels into ctx buffer.
</span><span class="c1">//
</span><span class="c1">// It returns metricNameRaw for the given labels if len(metricNameRaw) == 0.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">InsertCtx</span><span class="p">)</span> <span class="nf">WriteDataPointExt</span><span class="p">(</span><span class="nx">metricNameRaw</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">labels</span> <span class="p">[]</span><span class="nx">prompb</span><span class="p">.</span><span class="nx">Label</span><span class="p">,</span> <span class="nx">timestamp</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">float64</span><span class="p">)</span> <span class="p">[]</span><span class="kt">byte</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">metricNameRaw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">metricNameRaw</span> <span class="p">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nf">marshalMetricNameRaw</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">labels</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">ctx</span><span class="p">.</span><span class="nf">addRow</span><span class="p">(</span><span class="nx">metricNameRaw</span><span class="p">,</span> <span class="nx">timestamp</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">metricNameRaw</span>
<span class="p">}</span>
</code></pre></div><p>ちなみに prometheus からデータ投入したときは <code>WriteDataPointExt</code> のほうが呼ばれる。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vminsert/prometheus/request_handler.go#L46">app/vminsert/prometheus/request_handler.go#L46</a></p>
<p><code>WriteDataPoint</code> メソッドから呼ばれる <code>addRow</code> メソッドの実装。 <code>ctx.mrs</code> に <code>storage.MetricRow</code> を追加している。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vminsert/common/insert_ctx.go#L67-L79">app/vminsert/common/insert_ctx.go#L67-L79</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">InsertCtx</span><span class="p">)</span> <span class="nf">addRow</span><span class="p">(</span><span class="nx">metricNameRaw</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">timestamp</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">value</span> <span class="kt">float64</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">mrs</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">mrs</span>
  <span class="k">if</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">mrs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">mrs</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">mrs</span> <span class="p">=</span> <span class="nx">mrs</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="nx">mrs</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">mrs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">mrs</span><span class="p">,</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">MetricRow</span><span class="p">{})</span>
  <span class="p">}</span>
  <span class="nx">mr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">mrs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nx">mrs</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="nx">ctx</span><span class="p">.</span><span class="nx">mrs</span> <span class="p">=</span> <span class="nx">mrs</span>
  <span class="nx">mr</span><span class="p">.</span><span class="nx">MetricNameRaw</span> <span class="p">=</span> <span class="nx">metricNameRaw</span>
  <span class="nx">mr</span><span class="p">.</span><span class="nx">Timestamp</span> <span class="p">=</span> <span class="nx">timestamp</span>
  <span class="nx">mr</span><span class="p">.</span><span class="nx">Value</span> <span class="p">=</span> <span class="nx">value</span>
<span class="p">}</span>
</code></pre></div><p><code>ctx.mrs</code> は <code>FlushBufs</code> メソッド内で <code>vmstorage.AddRows</code> メソッドを呼ぶ際の引数として渡されている。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vminsert/common/insert_ctx.go#L121-L130">app/vminsert/common/insert_ctx.go#L121-L130</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// FlushBufs flushes buffered rows to the underlying storage.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ctx</span> <span class="o">*</span><span class="nx">InsertCtx</span><span class="p">)</span> <span class="nf">FlushBufs</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">vmstorage</span><span class="p">.</span><span class="nf">AddRows</span><span class="p">(</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">mrs</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">httpserver</span><span class="p">.</span><span class="nx">ErrorWithStatusCode</span><span class="p">{</span>
      <span class="nx">Err</span><span class="p">:</span>        <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot store metrics: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">),</span>
      <span class="nx">StatusCode</span><span class="p">:</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusServiceUnavailable</span><span class="p">,</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p><code>app/vmstorage</code> パッケージの <code>AddRows</code> 関数。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmstorage/main.go#L80-L86">app/vmstorage/main.go#L80-L86</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// AddRows adds mrs to the storage.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">AddRows</span><span class="p">(</span><span class="nx">mrs</span> <span class="p">[]</span><span class="nx">storage</span><span class="p">.</span><span class="nx">MetricRow</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="nx">WG</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">Storage</span><span class="p">.</span><span class="nf">AddRows</span><span class="p">(</span><span class="nx">mrs</span><span class="p">,</span> <span class="nb">uint8</span><span class="p">(</span><span class="o">*</span><span class="nx">precisionBits</span><span class="p">))</span>
  <span class="nx">WG</span><span class="p">.</span><span class="nf">Done</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">err</span>
<span class="p">}</span>
</code></pre></div><p><code>Storage</code> はこの少し上に定義されているグローバル変数。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmstorage/main.go#L69-L73">app/vmstorage/main.go#L69-L73</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Storage is a storage.
</span><span class="c1">//
</span><span class="c1">// Every storage call must be wrapped into WG.Add(1) ... WG.Done()
</span><span class="c1">// for proper graceful shutdown when Stop is called.
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">Storage</span> <span class="o">*</span><span class="nx">storage</span><span class="p">.</span><span class="nx">Storage</span>
</code></pre></div><p><code>lib/storage</code> パッケージの <code>Storage</code> の <code>AddRows</code> メソッドでは <code>add</code> メソッドを呼んでいる。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/storage.go#L782">lib/storage/storage.go#L782</a></p>
<p><code>add</code> メソッドのシグネチャ。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/storage.go#L793">lib/storage/storage.go#L793</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Storage</span><span class="p">)</span> <span class="nf">add</span><span class="p">(</span><span class="nx">rows</span> <span class="p">[]</span><span class="nx">rawRow</span><span class="p">,</span> <span class="nx">mrs</span> <span class="p">[]</span><span class="nx">MetricRow</span><span class="p">,</span> <span class="nx">precisionBits</span> <span class="kt">uint8</span><span class="p">)</span> <span class="p">([]</span><span class="nx">rawRow</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p>ざっと眺めた感じ <code>mrs</code> の内容を変換して <code>rows</code> に追加した後 <code>s.ts.Add</code> メソッドを呼び出しているのがメイン。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/storage.go#L890">lib/storage/storage.go#L890</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go">  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">tb</span><span class="p">.</span><span class="nf">AddRows</span><span class="p">(</span><span class="nx">rows</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</code></pre></div><p><code>lib/storage</code> パッケージの <code>table</code> の <code>AddRows</code> メソッド。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/table.go#L244-L353">lib/storage/table.go#L244-L353</a></p>
<p><code>lib/storage</code> パッケージの <code>partition</code> の <code>AddRows</code> メソッド。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/partition.go#L380-L401">lib/storage/partition.go#L380-L401</a></p>
<p><code>lib/storage</code> パッケージの <code>rawRowsShards</code> の <code>addRows</code> メソッド。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/partition.go#L415-L425">lib/storage/partition.go#L415-L425</a></p>
<p><code>lib/storage</code> パッケージの <code>rawRowsShard</code> の <code>addRows</code> メソッド。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/partition.go#L448-L479">lib/storage/partition.go#L448-L479</a>
引数の <code>rows</code> を <code>rrs.rows</code> に追加したりしながらローカル変数の <code>rrss</code> を構築して <code>pt.addRowsPart</code> と <code>putRawRows</code> を呼ぶのがメイン。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">rrs</span> <span class="o">*</span><span class="nx">rawRowsShard</span><span class="p">)</span> <span class="nf">addRows</span><span class="p">(</span><span class="nx">pt</span> <span class="o">*</span><span class="nx">partition</span><span class="p">,</span> <span class="nx">rows</span> <span class="p">[]</span><span class="nx">rawRow</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">rrss</span> <span class="p">[]</span><span class="o">*</span><span class="nx">rawRows</span>

  <span class="nx">rrs</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
  <span class="k">if</span> <span class="nb">cap</span><span class="p">(</span><span class="nx">rrs</span><span class="p">.</span><span class="nx">rows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">rrs</span><span class="p">.</span><span class="nx">rows</span> <span class="p">=</span> <span class="nf">getRawRowsMaxSize</span><span class="p">().</span><span class="nx">rows</span>
  <span class="p">}</span>
  <span class="nx">maxRowsCount</span> <span class="o">:=</span> <span class="nf">getMaxRawRowsPerPartition</span><span class="p">()</span>
  <span class="k">for</span> <span class="p">{</span>
    <span class="nx">capacity</span> <span class="o">:=</span> <span class="nx">maxRowsCount</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rrs</span><span class="p">.</span><span class="nx">rows</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">capacity</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Fast path - rows fit capacity.
</span><span class="c1"></span>      <span class="nx">rrs</span><span class="p">.</span><span class="nx">rows</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">rrs</span><span class="p">.</span><span class="nx">rows</span><span class="p">,</span> <span class="nx">rows</span><span class="o">...</span><span class="p">)</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="c1">// Slow path - rows don&#39;t fit capacity.
</span><span class="c1"></span>    <span class="c1">// Fill rawRows to capacity and convert it to a part.
</span><span class="c1"></span>    <span class="nx">rrs</span><span class="p">.</span><span class="nx">rows</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">rrs</span><span class="p">.</span><span class="nx">rows</span><span class="p">,</span> <span class="nx">rows</span><span class="p">[:</span><span class="nx">capacity</span><span class="p">]</span><span class="o">...</span><span class="p">)</span>
    <span class="nx">rows</span> <span class="p">=</span> <span class="nx">rows</span><span class="p">[</span><span class="nx">capacity</span><span class="p">:]</span>
    <span class="nx">rr</span> <span class="o">:=</span> <span class="nf">getRawRowsMaxSize</span><span class="p">()</span>
    <span class="nx">rrs</span><span class="p">.</span><span class="nx">rows</span><span class="p">,</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">rows</span> <span class="p">=</span> <span class="nx">rr</span><span class="p">.</span><span class="nx">rows</span><span class="p">,</span> <span class="nx">rrs</span><span class="p">.</span><span class="nx">rows</span>
    <span class="nx">rrss</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">rrss</span><span class="p">,</span> <span class="nx">rr</span><span class="p">)</span>
    <span class="nx">rrs</span><span class="p">.</span><span class="nx">lastFlushTime</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="nx">rrs</span><span class="p">.</span><span class="nx">lock</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>

  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">rr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rrss</span> <span class="p">{</span>
    <span class="nx">pt</span><span class="p">.</span><span class="nf">addRowsPart</span><span class="p">(</span><span class="nx">rr</span><span class="p">.</span><span class="nx">rows</span><span class="p">)</span>
    <span class="nf">putRawRows</span><span class="p">(</span><span class="nx">rr</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p><code>lib/storage</code> パッケージの <code>partition</code> の <code>addRowsPart</code> メソッド。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/partition.go#L524-L575">lib/storage/partition.go#L524-L575</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">pt</span> <span class="o">*</span><span class="nx">partition</span><span class="p">)</span> <span class="nf">addRowsPart</span><span class="p">(</span><span class="nx">rows</span> <span class="p">[]</span><span class="nx">rawRow</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p>引数の <code>rows</code> を加工・ラップして <code>pt.smallParts</code> に追加。長さの limit を超えたら <code>pt.mergeSmallParts</code> を呼び出し。</p>
<p><code>lib/storage</code> パッケージの <code>partition</code> の <code>mergeSmallParts</code> メソッド。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/partition.go#L980-L1010">lib/storage/partition.go#L980-L1010</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">pt</span> <span class="o">*</span><span class="nx">partition</span><span class="p">)</span> <span class="nf">mergeSmallParts</span><span class="p">(</span><span class="nx">isFinal</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</code></pre></div><p><code>pt.mergeParts</code> の呼び出しがメイン。</p>
<p><code>lib/storage</code> パッケージの <code>partition</code> の <code>mergeParts</code> メソッド。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/partition.go#L1014-L1174">lib/storage/partition.go#L1014-L1174</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">pt</span> <span class="o">*</span><span class="nx">partition</span><span class="p">)</span> <span class="nf">mergeParts</span><span class="p">(</span><span class="nx">pws</span> <span class="p">[]</span><span class="o">*</span><span class="nx">partWrapper</span><span class="p">,</span> <span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
</code></pre></div><p><code>mergeBlockStreams</code> 関数を呼び出している。</p>
<p><code>lib/storage</code> パッケージの <code>mergeBlockStreams</code> 関数。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/merge.go#L12-L34">lib/storage/merge.go#L12-L34</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">mergeBlockStreams</span><span class="p">(</span><span class="nx">ph</span> <span class="o">*</span><span class="nx">partHeader</span><span class="p">,</span> <span class="nx">bsw</span> <span class="o">*</span><span class="nx">blockStreamWriter</span><span class="p">,</span> <span class="nx">bsrs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">blockStreamReader</span><span class="p">,</span> <span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{},</span> <span class="nx">rowsMerged</span> <span class="o">*</span><span class="kt">uint64</span><span class="p">,</span>
  <span class="nx">deletedMetricIDs</span> <span class="o">*</span><span class="nx">uint64set</span><span class="p">.</span><span class="nx">Set</span><span class="p">,</span> <span class="nx">rowsDeleted</span> <span class="o">*</span><span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</code></pre></div><p><code>mergeBlockStreamsInternal</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/merge.go#L44-L137">lib/storage/merge.go#L44-L137</a>
気になるのは <code>pendingBlock.CopyFrom</code> と <code>mergeBlocks</code> と <code>bsw.WriteExternalBlock</code>。</p>
<p><code>CopyFrom</code> メソッド
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/block.go#L50-L60">lib/storage/block.go#L50-L60</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// CopyFrom copies src to b.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Block</span><span class="p">)</span> <span class="nf">CopyFrom</span><span class="p">(</span><span class="nx">src</span> <span class="o">*</span><span class="nx">Block</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>mergeBlocks</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/merge.go#L139-L180">lib/storage/merge.go#L139-L180</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// mergeBlocks merges ib1 and ib2 to ob.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">mergeBlocks</span><span class="p">(</span><span class="nx">ob</span><span class="p">,</span> <span class="nx">ib1</span><span class="p">,</span> <span class="nx">ib2</span> <span class="o">*</span><span class="nx">Block</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>WriteExternalBlock</code> メソッド
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/block_stream_writer.go#L172-L190">lib/storage/block_stream_writer.go#L172-L190</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// WriteExternalBlock writes b to bsw and updates ph and rowsMerged.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">bsw</span> <span class="o">*</span><span class="nx">blockStreamWriter</span><span class="p">)</span> <span class="nf">WriteExternalBlock</span><span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">Block</span><span class="p">,</span> <span class="nx">ph</span> <span class="o">*</span><span class="nx">partHeader</span><span class="p">,</span> <span class="nx">rowsMerged</span> <span class="o">*</span><span class="kt">uint64</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>Block</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/block.go#L18-L36">lib/storage/block.go#L18-L36</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Block represents a block of time series values for a single TSID.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Block</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">bh</span> <span class="nx">blockHeader</span>

  <span class="c1">// nextIdx is the next row index for timestamps and values.
</span><span class="c1"></span>  <span class="nx">nextIdx</span> <span class="kt">int</span>

  <span class="nx">timestamps</span> <span class="p">[]</span><span class="kt">int64</span>
  <span class="nx">values</span>     <span class="p">[]</span><span class="kt">int64</span>

  <span class="c1">// Marshaled representation of block header.
</span><span class="c1"></span>  <span class="nx">headerData</span> <span class="p">[]</span><span class="kt">byte</span>

  <span class="c1">// Marshaled representation of timestamps.
</span><span class="c1"></span>  <span class="nx">timestampsData</span> <span class="p">[]</span><span class="kt">byte</span>

  <span class="c1">// Marshaled representation of values.
</span><span class="c1"></span>  <span class="nx">valuesData</span> <span class="p">[]</span><span class="kt">byte</span>
<span class="p">}</span>
</code></pre></div><p><code>BlockHeader</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/block_header.go#L11-L80">lib/storage/block_header.go#L11-L80</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="c1">// blockHeader is a header for a time series block.
</span><span class="c1">//
</span><span class="c1">// Each block contains rows for a single time series. Rows are sorted
</span><span class="c1">// by timestamp.
</span><span class="c1">//
</span><span class="c1">// A single time series may span multiple blocks.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">blockHeader</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// TSID is the TSID for the block.
</span><span class="c1"></span>  <span class="c1">// Multiple blocks may have the same TSID.
</span><span class="c1"></span>  <span class="nx">TSID</span> <span class="nx">TSID</span>

  <span class="c1">// MinTimestamp is the minimum timestamp in the block.
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// This is the first timestamp, since rows are sorted by timestamps.
</span><span class="c1"></span>  <span class="nx">MinTimestamp</span> <span class="kt">int64</span>

  <span class="c1">// MaxTimestamp is the maximum timestamp in the block.
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// This is the last timestamp, since rows are sorted by timestamps.
</span><span class="c1"></span>  <span class="nx">MaxTimestamp</span> <span class="kt">int64</span>

  <span class="c1">// FirstValue is the first value in the block.
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// It is stored here for better compression level, since usually
</span><span class="c1"></span>  <span class="c1">// the first value significantly differs from subsequent values
</span><span class="c1"></span>  <span class="c1">// which may be delta-encoded.
</span><span class="c1"></span>  <span class="nx">FirstValue</span> <span class="kt">int64</span>

  <span class="c1">// TimestampsBlockOffset is the offset in bytes for a block
</span><span class="c1"></span>  <span class="c1">// with timestamps in timestamps file.
</span><span class="c1"></span>  <span class="nx">TimestampsBlockOffset</span> <span class="kt">uint64</span>

  <span class="c1">// ValuesBlockOffset is the offset in bytes for a block with values
</span><span class="c1"></span>  <span class="c1">// in values file.
</span><span class="c1"></span>  <span class="nx">ValuesBlockOffset</span> <span class="kt">uint64</span>

  <span class="c1">// TimestampsBlocksSize is the size in bytes for a block with timestamps.
</span><span class="c1"></span>  <span class="nx">TimestampsBlockSize</span> <span class="kt">uint32</span>

  <span class="c1">// ValuesBlockSize is the size in bytes for a block with values.
</span><span class="c1"></span>  <span class="nx">ValuesBlockSize</span> <span class="kt">uint32</span>

  <span class="c1">// RowsCount is the number of rows in the block.
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// The block must contain at least one row.
</span><span class="c1"></span>  <span class="nx">RowsCount</span> <span class="kt">uint32</span>

  <span class="c1">// Scale is the 10^Scale multiplier for values in the block.
</span><span class="c1"></span>  <span class="nx">Scale</span> <span class="kt">int16</span>

  <span class="c1">// TimestampsMarshalType is the marshal type used for marshaling
</span><span class="c1"></span>  <span class="c1">// a block with timestamps.
</span><span class="c1"></span>  <span class="nx">TimestampsMarshalType</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">MarshalType</span>

  <span class="c1">// ValuesMarshalType is the marshal type used for marshaling
</span><span class="c1"></span>  <span class="c1">// a block with values.
</span><span class="c1"></span>  <span class="nx">ValuesMarshalType</span> <span class="nx">encoding</span><span class="p">.</span><span class="nx">MarshalType</span>

  <span class="c1">// PrecisionBits is the number of significant bits when using
</span><span class="c1"></span>  <span class="c1">// MarshalTypeNearestDelta2 encoding.
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// Possible values are in the range [1...64], where
</span><span class="c1"></span>  <span class="c1">//     1 means max 50% error,
</span><span class="c1"></span>  <span class="c1">//     2 means max 25% error,
</span><span class="c1"></span>  <span class="c1">//     n means max 100/(2^n)% error,
</span><span class="c1"></span>  <span class="c1">//    64 means exact values.
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// Lower PrecisionBits give better block compression and speed.
</span><span class="c1"></span>  <span class="nx">PrecisionBits</span> <span class="kt">uint8</span>
<span class="p">}</span>
</code></pre></div><p>今回はここまで。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
