<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.84.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>VictoriaMetricsのクエリのコードリーディング &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>VictoriaMetricsのクエリのコードリーディング</h1>
  <time datetime=2019-12-24T08:25:00&#43;0900 class="post-date">2019-12-24</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#メイン">メイン</a></li>
    <li><a href="#ラベルバリューのクエリ">ラベルバリューのクエリ</a>
      <ul>
        <li><a href="#関連する型">関連する型</a></li>
      </ul>
    </li>
    <li><a href="#レンジクエリ">レンジクエリ</a></li>
  </ul>
</nav>
  <p><a href="https://github.com/VictoriaMetrics/VictoriaMetrics">VictoriaMetrics/VictoriaMetrics: VictoriaMetrics - fast, cost-effective and scalable time series database, long-term remote storage for Prometheus</a> の v1.31.2 のコードリーディングのメモ。</p>
<p>今回は Prometheus QL 互換のクエリ回りを見る。</p>
<h2 id="メイン">メイン</h2>
<p>メインのリクエストハンドラ。
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/victoria-metrics/main.go#L52-L63">app/victoria-metrics/main.go#L52-L63</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">requestHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nx">vminsert</span><span class="p">.</span><span class="nf">RequestHandler</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">vmselect</span><span class="p">.</span><span class="nf">RequestHandler</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">vmstorage</span><span class="p">.</span><span class="nf">RequestHandler</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span>
<span class="p">}</span>
</code></pre></div><p><code>vmselect.RequestHandler</code>
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/main.go#L57-L199">app/vmselect/main.go#L57-L199</a></p>
<h2 id="ラベルバリューのクエリ">ラベルバリューのクエリ</h2>
<p>Prometheus のドキュメント: <a href="https://prometheus.io/docs/prometheus/latest/querying/api/#querying-label-values">Querying label values</a></p>
<p>grafana で VictoriaMetrics を Prometheus のデータソースとして登録してグラフを見た時は <code>/api/v1/label/__name__/values</code> というパスで呼ばれて</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;status&#34;</span><span class="p">:</span><span class="s2">&#34;success&#34;</span><span class="p">,</span><span class="nt">&#34;data&#34;</span><span class="p">:[</span><span class="s2">&#34;foo.bar.baz&#34;</span><span class="p">]}</span>
</code></pre></div><p>といったレスポンスが返っていました。</p>
<p>VictoriaMetrics の実装: <a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/main.go#L83-L97">app/vmselect/main.go#L83-L97</a></p>
<p><code>app/vmselect/prometheus</code> パッケージの <code>LabelValuesHandler</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/prometheus/prometheus.go#L234-L279">app/vmselect/prometheus/prometheus.go#L234-L279</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// LabelValuesHandler processes /api/v1/label/&lt;labelName&gt;/values request.
</span><span class="c1">//
</span><span class="c1">// See https://prometheus.io/docs/prometheus/latest/querying/api/#querying-label-values
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">LabelValuesHandler</span><span class="p">(</span><span class="nx">labelName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</code></pre></div><p><code>app/vmselect/netstorage</code> パッケージの <code>GetLabelValues</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/netstorage/netstorage.go#L398-L415">app/vmselect/netstorage/netstorage.go#L398-L415</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// GetLabelValues returns label values for the given labelName
</span><span class="c1">// until the given deadline.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">GetLabelValues</span><span class="p">(</span><span class="nx">labelName</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">deadline</span> <span class="nx">Deadline</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>app/vmstorage</code> パッケージの <code>SearchTagValues</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmstorage/main.go#L106-L112">app/vmstorage/main.go#L106-L112</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// SearchTagValues searches for tag values for the given tagKey
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">SearchTagValues</span><span class="p">(</span><span class="nx">tagKey</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">maxTagValues</span> <span class="kt">int</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> 
</code></pre></div><p><code>lib/storage</code> パッケージの <code>Storage</code> の <code>SearchTagValues</code> メソッド
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/storage.go#L644-L647">lib/storage/storage.go#L644-L647</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// SearchTagValues searches for tag values for the given tagKey
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Storage</span><span class="p">)</span> <span class="nf">SearchTagValues</span><span class="p">(</span><span class="nx">tagKey</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">maxTagValues</span> <span class="kt">int</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>Storage</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/storage.go#L30-L78">lib/storage/storage.go#L30-L78</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Storage represents TSDB storage.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Storage</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="err">…</span><span class="p">(</span><span class="nx">略</span><span class="p">)</span><span class="err">…</span>
  <span class="nx">path</span>            <span class="kt">string</span>
  <span class="nx">cachePath</span>       <span class="kt">string</span>
  <span class="nx">retentionMonths</span> <span class="kt">int</span>

  <span class="c1">// lock file for exclusive access to the storage on the given path.
</span><span class="c1"></span>  <span class="nx">flockF</span> <span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span>

  <span class="nx">idbCurr</span> <span class="nx">atomic</span><span class="p">.</span><span class="nx">Value</span>

  <span class="nx">tb</span> <span class="o">*</span><span class="nx">table</span>
<span class="err">…</span><span class="p">(</span><span class="nx">略</span><span class="p">)</span><span class="err">…</span>
<span class="p">}</span>
</code></pre></div><p><code>table</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/table.go#L16-L33">lib/storage/table.go#L16-L33</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// table represents a single table with time series data.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">table</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">path</span>                <span class="kt">string</span>
  <span class="nx">smallPartitionsPath</span> <span class="kt">string</span>
  <span class="nx">bigPartitionsPath</span>   <span class="kt">string</span>

  <span class="nx">getDeletedMetricIDs</span> <span class="kd">func</span><span class="p">()</span> <span class="o">*</span><span class="nx">uint64set</span><span class="p">.</span><span class="nx">Set</span>

  <span class="nx">ptws</span>     <span class="p">[]</span><span class="o">*</span><span class="nx">partitionWrapper</span>
  <span class="nx">ptwsLock</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>

  <span class="nx">flockF</span> <span class="o">*</span><span class="nx">os</span><span class="p">.</span><span class="nx">File</span>

  <span class="nx">stop</span> <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>

  <span class="nx">retentionMilliseconds</span> <span class="kt">int64</span>
  <span class="nx">retentionWatcherWG</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="p">}</span>
</code></pre></div><p><code>partitionWrapper</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/table.go#L35-L46">lib/storage/table.go#L35-L46</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// partitionWrapper provides refcounting mechanism for the partition.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">partitionWrapper</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// Atomic counters must be at the top of struct for proper 8-byte alignment on 32-bit archs.
</span><span class="c1"></span>  <span class="c1">// See https://github.com/VictoriaMetrics/VictoriaMetrics/issues/212
</span><span class="c1"></span>
  <span class="nx">refCount</span> <span class="kt">uint64</span>

  <span class="c1">// The partition must be dropped if mustDrop &gt; 0
</span><span class="c1"></span>  <span class="nx">mustDrop</span> <span class="kt">uint64</span>

  <span class="nx">pt</span> <span class="o">*</span><span class="nx">partition</span>
<span class="p">}</span>
</code></pre></div><p><code>partition</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/partition.go#L97-L150">lib/storage/partition.go#L97-L150</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// partition represents a partition.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">partition</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="err">…</span><span class="p">(</span><span class="nx">略</span><span class="p">)</span><span class="err">…</span>
  <span class="nx">mergeIdx</span> <span class="kt">uint64</span>

  <span class="nx">smallPartsPath</span> <span class="kt">string</span>
  <span class="nx">bigPartsPath</span>   <span class="kt">string</span>

  <span class="c1">// The callack that returns deleted metric ids which must be skipped during merge.
</span><span class="c1"></span>  <span class="nx">getDeletedMetricIDs</span> <span class="kd">func</span><span class="p">()</span> <span class="o">*</span><span class="nx">uint64set</span><span class="p">.</span><span class="nx">Set</span>

  <span class="c1">// Name is the name of the partition in the form YYYY_MM.
</span><span class="c1"></span>  <span class="nx">name</span> <span class="kt">string</span>

  <span class="c1">// The time range for the partition. Usually this is a whole month.
</span><span class="c1"></span>  <span class="nx">tr</span> <span class="nx">TimeRange</span>
<span class="err">…</span><span class="p">(</span><span class="nx">略</span><span class="p">)</span><span class="err">…</span>
  <span class="c1">// Contains all the inmemoryPart plus file-based parts
</span><span class="c1"></span>  <span class="c1">// with small number of items (up to maxRowsCountPerSmallPart).
</span><span class="c1"></span>  <span class="nx">smallParts</span> <span class="p">[]</span><span class="o">*</span><span class="nx">partWrapper</span>

  <span class="c1">// Contains file-based parts with big number of items.
</span><span class="c1"></span>  <span class="nx">bigParts</span> <span class="p">[]</span><span class="o">*</span><span class="nx">partWrapper</span>

  <span class="c1">// rawRows contains recently added rows that haven&#39;t been converted into parts yet.
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// rawRows aren&#39;t used in search for performance reasons.
</span><span class="c1"></span>  <span class="nx">rawRows</span> <span class="nx">rawRowsShards</span>
<span class="err">…</span><span class="p">(</span><span class="nx">略</span><span class="p">)</span><span class="err">…</span>
<span class="p">}</span>
</code></pre></div><p><code>partWrapper</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/partition.go#L152-L168">lib/storage/partition.go#L152-L168</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// partWrapper is a wrapper for the part.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">partWrapper</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// Put atomic counters to the top of struct, so they are aligned to 8 bytes on 32-bit arch.
</span><span class="c1"></span>  <span class="c1">// See https://github.com/VictoriaMetrics/VictoriaMetrics/issues/212
</span><span class="c1"></span>
  <span class="c1">// The number of references to the part.
</span><span class="c1"></span>  <span class="nx">refCount</span> <span class="kt">uint64</span>

  <span class="c1">// The part itself.
</span><span class="c1"></span>  <span class="nx">p</span> <span class="o">*</span><span class="nx">part</span>

  <span class="c1">// non-nil if the part is inmemoryPart.
</span><span class="c1"></span>  <span class="nx">mp</span> <span class="o">*</span><span class="nx">inmemoryPart</span>

  <span class="c1">// Whether the part is in merge now.
</span><span class="c1"></span>  <span class="nx">isInMerge</span> <span class="kt">bool</span>
<span class="p">}</span>
</code></pre></div><p><code>part</code> と <code>partInternals</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/part.go#L31-L57">lib/storage/part.go#L31-L57</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">
<span class="kd">type</span> <span class="nx">partInternals</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">ph</span> <span class="nx">partHeader</span>

  <span class="c1">// Filesystem path to the part.
</span><span class="c1"></span>  <span class="c1">//
</span><span class="c1"></span>  <span class="c1">// Empty for in-memory part.
</span><span class="c1"></span>  <span class="nx">path</span> <span class="kt">string</span>

  <span class="c1">// Total size in bytes of part data.
</span><span class="c1"></span>  <span class="nx">size</span> <span class="kt">uint64</span>

  <span class="nx">timestampsFile</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">ReadAtCloser</span>
  <span class="nx">valuesFile</span>     <span class="nx">fs</span><span class="p">.</span><span class="nx">ReadAtCloser</span>
  <span class="nx">indexFile</span>      <span class="nx">fs</span><span class="p">.</span><span class="nx">ReadAtCloser</span>

  <span class="nx">metaindex</span> <span class="p">[]</span><span class="nx">metaindexRow</span>
<span class="p">}</span>

<span class="c1">// part represents a searchable part containing time series data.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">part</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">partInternals</span>

  <span class="c1">// Align ibCache to 8 bytes in order to align internal counters on 32-bit architectures.
</span><span class="c1"></span>  <span class="c1">// See https://github.com/VictoriaMetrics/VictoriaMetrics/issues/212
</span><span class="c1"></span>  <span class="nx">_</span>       <span class="p">[(</span><span class="mi">8</span> <span class="o">-</span> <span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">partInternals</span><span class="p">{})</span> <span class="o">%</span> <span class="mi">8</span><span class="p">))</span> <span class="o">%</span> <span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
  <span class="nx">ibCache</span> <span class="nx">indexBlockCache</span>
<span class="p">}</span>
</code></pre></div><p><code>partHeader</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/part_header.go#L11-L24">lib/storage/part_header.go#L11-L24</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// partHeader represents part header.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">partHeader</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// RowsCount is the total number of rows in the part.
</span><span class="c1"></span>  <span class="nx">RowsCount</span> <span class="kt">uint64</span>

  <span class="c1">// BlocksCount is the total number of blocks in the part.
</span><span class="c1"></span>  <span class="nx">BlocksCount</span> <span class="kt">uint64</span>

  <span class="c1">// MinTimestamp is the minimum timestamp in the part.
</span><span class="c1"></span>  <span class="nx">MinTimestamp</span> <span class="kt">int64</span>

  <span class="c1">// MaxTimestamp is the maximum timestamp in the part.
</span><span class="c1"></span>  <span class="nx">MaxTimestamp</span> <span class="kt">int64</span>
<span class="p">}</span>
</code></pre></div><p><code>lib/storage</code> パッケージの <code>indexDB</code> の <code>SearchTagValues</code> メソッド
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/index_db.go#L784-L811">lib/storage/index_db.go#L784-L811</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// SearchTagValues returns all the tag values for the given tagKey
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span><span class="nx">indexDB</span><span class="p">)</span> <span class="nf">SearchTagValues</span><span class="p">(</span><span class="nx">tagKey</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">maxTagValues</span> <span class="kt">int</span><span class="p">)</span> <span class="p">([]</span><span class="kt">string</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>lib/storage</code> パッケージの <code>indexSearch</code> の <code>searchTagValues</code> メソッド
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/index_db.go#L813-L857">lib/storage/index_db.go#L813-L857</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">is</span> <span class="o">*</span><span class="nx">indexSearch</span><span class="p">)</span> <span class="nf">searchTagValues</span><span class="p">(</span><span class="nx">tvs</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">struct</span><span class="p">{},</span> <span class="nx">tagKey</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">maxTagValues</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</code></pre></div><p><code>tagKey</code> の箇所にシークしてタグを最大 <code>maxTagValues</code> 個まで <code>tvs</code> のキーに入れる。</p>
<p><code>lib/mergeset</code> パッケージの <code>TableSearch</code> の <code>Seek</code> メソッド
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/mergeset/table_search.go#L83-L117">lib/mergeset/table_search.go#L83-L117</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Seek seeks for the first item greater or equal to k in the ts.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ts</span> <span class="o">*</span><span class="nx">TableSearch</span><span class="p">)</span> <span class="nf">Seek</span><span class="p">(</span><span class="nx">k</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>lib/mergeset</code> パッケージの <code>partSearch</code> の <code>Seek</code> メソッド
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/mergeset/part_search.go#L89-L182">lib/mergeset/part_search.go#L89-L182</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Seek seeks for the first item greater or equal to k in ps.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ps</span> <span class="o">*</span><span class="nx">partSearch</span><span class="p">)</span> <span class="nf">Seek</span><span class="p">(</span><span class="nx">k</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><h3 id="関連する型">関連する型</h3>
<p><code>lib/mergeset</code> パッケージの <code>partSearch</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/mergeset/part_search.go#L13-L49">lib/mergeset/part_search.go#L13-L49</a></p>
<p><code>lib/mergeset</code> パッケージの <code>partInternals</code> と <code>part</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/mergeset/part.go#L47-L69">lib/mergeset/part.go#L47-L69</a></p>
<p><code>lib/mergeset</code> パッケージの <code>metaindexRow</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/mergeset/metaindex_row.go#L12-L26">lib/mergeset/metaindex_row.go#L12-L26</a></p>
<p><code>lib/storage</code> パッケージの <code>indexBlock</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/part.go#L158-L160">lib/storage/part.go#L158-L160</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">indexBlock</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">bhs</span> <span class="p">[]</span><span class="nx">blockHeader</span>
<span class="p">}</span>
</code></pre></div><p><code>lib/mergeset</code> パッケージの <code>blockHeader</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/mergeset/block_header.go#L11-L35">lib/mergeset/block_header.go#L11-L35</a></p>
<p><code>lib/mergeset</code> パッケージの <code>inmemoryBlock</code> 構造体と <code>byteSliceSorter</code> 型
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/mergeset/encoding.go#L15-L29">lib/mergeset/encoding.go#L15-L29</a></p>
<h2 id="レンジクエリ">レンジクエリ</h2>
<p>Prometheus のドキュメント: <a href="https://prometheus.io/docs/prometheus/latest/querying/api/#range-queries">Range queries</a></p>
<p>grafana で VictoriaMetrics を Prometheus のデータソースとして登録してグラフを見た時は <code>/api/v1/query_range?query=foo.bar.baz&amp;start=1577150160&amp;end=1577153760&amp;step=15</code> というパスで呼ばれて</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span><span class="nt">&#34;JSON&#34;</span><span class="p">:{</span><span class="nt">&#34;status&#34;</span><span class="p">:</span><span class="s2">&#34;success&#34;</span><span class="p">,</span><span class="nt">&#34;data&#34;</span><span class="p">:{</span><span class="nt">&#34;resultType&#34;</span><span class="p">:</span><span class="s2">&#34;matrix&#34;</span><span class="p">,</span><span class="nt">&#34;result&#34;</span><span class="p">:[{</span><span class="nt">&#34;metric&#34;</span><span class="p">:{</span><span class="nt">&#34;__name__&#34;</span><span class="p">:</span><span class="s2">&#34;foo.bar.baz&#34;</span><span class="p">,</span><span class="nt">&#34;tag1&#34;</span><span class="p">:</span><span class="s2">&#34;value1&#34;</span><span class="p">,</span><span class="nt">&#34;tag2&#34;</span><span class="p">:</span><span class="s2">&#34;value2&#34;</span><span class="p">},</span><span class="nt">&#34;values&#34;</span><span class="p">:[[</span><span class="mi">1577059950</span><span class="p">,</span><span class="s2">&#34;123&#34;</span><span class="p">],[</span><span class="mi">1577059965</span><span class="p">,</span><span class="s2">&#34;123&#34;</span><span class="p">],</span><span class="err">…(略)…</span><span class="p">,[</span><span class="mi">1577060700</span><span class="p">,</span><span class="s2">&#34;130&#34;</span><span class="p">],[</span><span class="mi">1577060715</span><span class="p">,</span><span class="s2">&#34;130&#34;</span><span class="p">],</span><span class="err">…(略)…</span><span class="p">,[</span><span class="mi">1577061540</span><span class="p">,</span><span class="s2">&#34;130&#34;</span><span class="p">]]}]}}</span>
</code></pre></div><p>といったレスポンスが返っていました。</p>
<p>VictoriaMetrics の実装: <a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/main.go#L109-L117">app/vmselect/main.go#L109-L117</a></p>
<p><code>app/vmselect/prometheus</code> パッケージの <code>QueryRangeHandler</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/prometheus/prometheus.go#L647-L675">app/vmselect/prometheus/prometheus.go#L647-L675</a></p>
<p><code>app/vmselect/prometheus</code> パッケージの <code>queryRangeHandler</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/prometheus/prometheus.go#L677-L723">app/vmselect/prometheus/prometheus.go#L677-L723</a></p>
<p><code>app/vmselect/promql</code> パッケージの <code>Exec</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/promql/exec.go#L32-L86">app/vmselect/promql/exec.go#L32-L86</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Exec executes q for the given ec.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Exec</span><span class="p">(</span><span class="nx">ec</span> <span class="o">*</span><span class="nx">EvalConfig</span><span class="p">,</span> <span class="nx">q</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">isFirstPointOnly</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">([]</span><span class="nx">netstorage</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>app/vmselect/promql</code> パッケージの <code>evalExpr</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/promql/eval.go#L147-L271">app/vmselect/promql/eval.go#L147-L271</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">evalExpr</span><span class="p">(</span><span class="nx">ec</span> <span class="o">*</span><span class="nx">EvalConfig</span><span class="p">,</span> <span class="nx">e</span> <span class="nx">expr</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">timeseries</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>app/vmselect/promql</code> パッケージの <code>evalRollupFunc</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/promql/eval.go#L397-L436">app/vmselect/promql/eval.go#L397-L436</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">evalRollupFunc</span><span class="p">(</span><span class="nx">ec</span> <span class="o">*</span><span class="nx">EvalConfig</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">rf</span> <span class="nx">rollupFunc</span><span class="p">,</span> <span class="nx">re</span> <span class="o">*</span><span class="nx">rollupExpr</span><span class="p">,</span> <span class="nx">iafc</span> <span class="o">*</span><span class="nx">incrementalAggrFuncContext</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">timeseries</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>app/vmselect/promql</code> パッケージの <code>evalRollupFuncWithMetricExpr</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/promql/eval.go#L547-L636">app/vmselect/promql/eval.go#L547-L636</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">evalRollupFuncWithMetricExpr</span><span class="p">(</span><span class="nx">ec</span> <span class="o">*</span><span class="nx">EvalConfig</span><span class="p">,</span> <span class="nx">name</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">rf</span> <span class="nx">rollupFunc</span><span class="p">,</span> <span class="nx">me</span> <span class="o">*</span><span class="nx">metricExpr</span><span class="p">,</span> <span class="nx">iafc</span> <span class="o">*</span><span class="nx">incrementalAggrFuncContext</span><span class="p">,</span> <span class="nx">windowStr</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">timeseries</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>app/vmselect/netstorage</code> パッケージの <code>ProcessSearchQuery</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/netstorage/netstorage.go#L468-L539">app/vmselect/netstorage/netstorage.go#L468-L539</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ProcessSearchQuery performs sq on storage nodes until the given deadline.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">ProcessSearchQuery</span><span class="p">(</span><span class="nx">sq</span> <span class="o">*</span><span class="nx">storage</span><span class="p">.</span><span class="nx">SearchQuery</span><span class="p">,</span> <span class="nx">fetchData</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">deadline</span> <span class="nx">Deadline</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Results</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>app/vmselect/netstorage</code> パッケージの <code>Result</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/netstorage/netstorage.go#L50-L59">app/vmselect/netstorage/netstorage.go#L50-L59</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Results holds results returned from ProcessSearchQuery.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Results</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">tr</span>        <span class="nx">storage</span><span class="p">.</span><span class="nx">TimeRange</span>
  <span class="nx">fetchData</span> <span class="kt">bool</span>
  <span class="nx">deadline</span>  <span class="nx">Deadline</span>

  <span class="nx">tbf</span> <span class="o">*</span><span class="nx">tmpBlocksFile</span>

  <span class="nx">packedTimeseries</span> <span class="p">[]</span><span class="nx">packedTimeseries</span>
<span class="p">}</span>
</code></pre></div><p><code>packedTimeseries</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/netstorage/netstorage.go#L157-L160">app/vmselect/netstorage/netstorage.go#L157-L160</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">packedTimeseries</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">metricName</span> <span class="kt">string</span>
  <span class="nx">addrs</span>      <span class="p">[]</span><span class="nx">tmpBlockAddr</span>
<span class="p">}</span>
</code></pre></div><p><code>tmpBlockAddr</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/netstorage/tmp_blocks_file.go#L74-L77">app/vmselect/netstorage/tmp_blocks_file.go#L74-L77</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">tmpBlockAddr</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="nx">offset</span> <span class="kt">uint64</span>
  <span class="nx">size</span>   <span class="kt">int</span>
<span class="p">}</span>
</code></pre></div><p><code>lib/storage</code> パッケージの <code>Search</code> の <code>Init</code> メソッド
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/search.go#L103-L127">lib/storage/search.go#L103-L127</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Init initializes s from the given storage, tfss and tr.
</span><span class="c1">//
</span><span class="c1">// MustClose must be called when the search is done.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Search</span><span class="p">)</span> <span class="nf">Init</span><span class="p">(</span><span class="nx">storage</span> <span class="o">*</span><span class="nx">Storage</span><span class="p">,</span> <span class="nx">tfss</span> <span class="p">[]</span><span class="o">*</span><span class="nx">TagFilters</span><span class="p">,</span> <span class="nx">tr</span> <span class="nx">TimeRange</span><span class="p">,</span> <span class="nx">fetchData</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">maxMetrics</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p><code>Search</code> 構造体
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/search.go#L79-L91">lib/storage/search.go#L79-L91</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Search is a search for time series.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Search</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// MetricBlock is updated with each Search.NextMetricBlock call.
</span><span class="c1"></span>  <span class="nx">MetricBlock</span> <span class="nx">MetricBlock</span>

  <span class="nx">storage</span> <span class="o">*</span><span class="nx">Storage</span>

  <span class="nx">ts</span> <span class="nx">tableSearch</span>

  <span class="nx">err</span> <span class="kt">error</span>

  <span class="nx">needClosing</span> <span class="kt">bool</span>
<span class="p">}</span>
</code></pre></div><p><code>evalRollupWithIncrementalAggregate</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/promql/eval.go#L650-L671">app/vmselect/promql/eval.go#L650-L671</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">evalRollupWithIncrementalAggregate</span><span class="p">(</span><span class="nx">iafc</span> <span class="o">*</span><span class="nx">incrementalAggrFuncContext</span><span class="p">,</span> <span class="nx">rss</span> <span class="o">*</span><span class="nx">netstorage</span><span class="p">.</span><span class="nx">Results</span><span class="p">,</span> <span class="nx">rcs</span> <span class="p">[]</span><span class="o">*</span><span class="nx">rollupConfig</span><span class="p">,</span>
  <span class="nx">preFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">values</span> <span class="p">[]</span><span class="kt">float64</span><span class="p">,</span> <span class="nx">timestamps</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">),</span> <span class="nx">sharedTimestamps</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span> <span class="nx">removeMetricGroup</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">([]</span><span class="o">*</span><span class="nx">timeseries</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">err</span> <span class="o">:=</span> <span class="nx">rss</span><span class="p">.</span><span class="nf">RunParallel</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">rs</span> <span class="o">*</span><span class="nx">netstorage</span><span class="p">.</span><span class="nx">Result</span><span class="p">,</span> <span class="nx">workerID</span> <span class="kt">uint</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">preFunc</span><span class="p">(</span><span class="nx">rs</span><span class="p">.</span><span class="nx">Values</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">Timestamps</span><span class="p">)</span>
    <span class="nx">ts</span> <span class="o">:=</span> <span class="nf">getTimeseries</span><span class="p">()</span>
    <span class="k">defer</span> <span class="nf">putTimeseries</span><span class="p">(</span><span class="nx">ts</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">rc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rcs</span> <span class="p">{</span>
      <span class="nx">ts</span><span class="p">.</span><span class="nf">Reset</span><span class="p">()</span>
      <span class="nf">doRollupForTimeseries</span><span class="p">(</span><span class="nx">rc</span><span class="p">,</span> <span class="nx">ts</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">rs</span><span class="p">.</span><span class="nx">MetricName</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">Values</span><span class="p">,</span> <span class="nx">rs</span><span class="p">.</span><span class="nx">Timestamps</span><span class="p">,</span> <span class="nx">sharedTimestamps</span><span class="p">,</span> <span class="nx">removeMetricGroup</span><span class="p">)</span>
      <span class="nx">iafc</span><span class="p">.</span><span class="nf">updateTimeseries</span><span class="p">(</span><span class="nx">ts</span><span class="p">,</span> <span class="nx">workerID</span><span class="p">)</span>

      <span class="c1">// ts.Timestamps points to sharedTimestamps. Zero it, so it can be re-used.
</span><span class="c1"></span>      <span class="nx">ts</span><span class="p">.</span><span class="nx">Timestamps</span> <span class="p">=</span> <span class="kc">nil</span>
      <span class="nx">ts</span><span class="p">.</span><span class="nx">denyReuse</span> <span class="p">=</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
  <span class="p">}</span>
  <span class="nx">tss</span> <span class="o">:=</span> <span class="nx">iafc</span><span class="p">.</span><span class="nf">finalizeTimeseries</span><span class="p">()</span>
  <span class="k">return</span> <span class="nx">tss</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p><code>doRollupForTimeseries</code> 関数
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/promql/eval.go#L693-L705">app/vmselect/promql/eval.go#L693-L705</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">doRollupForTimeseries</span><span class="p">(</span><span class="nx">rc</span> <span class="o">*</span><span class="nx">rollupConfig</span><span class="p">,</span> <span class="nx">tsDst</span> <span class="o">*</span><span class="nx">timeseries</span><span class="p">,</span> <span class="nx">mnSrc</span> <span class="o">*</span><span class="nx">storage</span><span class="p">.</span><span class="nx">MetricName</span><span class="p">,</span> <span class="nx">valuesSrc</span> <span class="p">[]</span><span class="kt">float64</span><span class="p">,</span> <span class="nx">timestampsSrc</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span>
  <span class="nx">sharedTimestamps</span> <span class="p">[]</span><span class="kt">int64</span><span class="p">,</span> <span class="nx">removeMetricGroup</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">tsDst</span><span class="p">.</span><span class="nx">MetricName</span><span class="p">.</span><span class="nf">CopyFrom</span><span class="p">(</span><span class="nx">mnSrc</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rc</span><span class="p">.</span><span class="nx">TagValue</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
    <span class="nx">tsDst</span><span class="p">.</span><span class="nx">MetricName</span><span class="p">.</span><span class="nf">AddTag</span><span class="p">(</span><span class="s">&#34;rollup&#34;</span><span class="p">,</span> <span class="nx">rc</span><span class="p">.</span><span class="nx">TagValue</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="nx">removeMetricGroup</span> <span class="p">{</span>
    <span class="nx">tsDst</span><span class="p">.</span><span class="nx">MetricName</span><span class="p">.</span><span class="nf">ResetMetricGroup</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="nx">tsDst</span><span class="p">.</span><span class="nx">Values</span> <span class="p">=</span> <span class="nx">rc</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="nx">tsDst</span><span class="p">.</span><span class="nx">Values</span><span class="p">[:</span><span class="mi">0</span><span class="p">],</span> <span class="nx">valuesSrc</span><span class="p">,</span> <span class="nx">timestampsSrc</span><span class="p">)</span>
  <span class="nx">tsDst</span><span class="p">.</span><span class="nx">Timestamps</span> <span class="p">=</span> <span class="nx">sharedTimestamps</span>
  <span class="nx">tsDst</span><span class="p">.</span><span class="nx">denyReuse</span> <span class="p">=</span> <span class="kc">true</span>
<span class="p">}</span>
</code></pre></div><p><code>rollupConfig</code> 構造体と <code>rollupFunc</code> 型
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/app/vmselect/promql/rollup.go#L133-L159">app/vmselect/promql/rollup.go#L133-L159</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// rollupFunc must return rollup value for the given rfa.
</span><span class="c1">//
</span><span class="c1">// prevValue may be nan, values and timestamps may be empty.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">rollupFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">rfa</span> <span class="o">*</span><span class="nx">rollupFuncArg</span><span class="p">)</span> <span class="kt">float64</span>

<span class="kd">type</span> <span class="nx">rollupConfig</span> <span class="kd">struct</span> <span class="p">{</span>
  <span class="c1">// This tag value must be added to &#34;rollup&#34; tag if non-empty.
</span><span class="c1"></span>  <span class="nx">TagValue</span> <span class="kt">string</span>

  <span class="nx">Func</span>   <span class="nx">rollupFunc</span>
  <span class="nx">Start</span>  <span class="kt">int64</span>
  <span class="nx">End</span>    <span class="kt">int64</span>
  <span class="nx">Step</span>   <span class="kt">int64</span>
  <span class="nx">Window</span> <span class="kt">int64</span>

  <span class="c1">// Whether window may be adjusted to 2 x interval between data points.
</span><span class="c1"></span>  <span class="c1">// This is needed for functions which have dt in the denominator
</span><span class="c1"></span>  <span class="c1">// such as rate, deriv, etc.
</span><span class="c1"></span>  <span class="c1">// Without the adjustement their value would jump in unexpected directions
</span><span class="c1"></span>  <span class="c1">// when using window smaller than 2 x scrape_interval.
</span><span class="c1"></span>  <span class="nx">MayAdjustWindow</span> <span class="kt">bool</span>

  <span class="nx">Timestamps</span> <span class="p">[]</span><span class="kt">int64</span>

  <span class="c1">// LoookbackDelta is the analog to `-query.lookback-delta` from Prometheus world.
</span><span class="c1"></span>  <span class="nx">LookbackDelta</span> <span class="kt">int64</span>
<span class="p">}</span>
</code></pre></div><p><code>lib/storage</code> パッケージの <code>tableSearch</code> の <code>Init</code> メソッド
<a href="https://github.com/VictoriaMetrics/VictoriaMetrics/blob/v1.31.2/lib/storage/table_search.go#L55-L120">lib/storage/table_search.go#L55-L120</a></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Init initializes the ts.
</span><span class="c1">//
</span><span class="c1">// tsids must be sorted.
</span><span class="c1">// tsids cannot be modified after the Init call, since it is owned by ts.
</span><span class="c1">//
</span><span class="c1">// MustClose must be called then the tableSearch is done.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ts</span> <span class="o">*</span><span class="nx">tableSearch</span><span class="p">)</span> <span class="nf">Init</span><span class="p">(</span><span class="nx">tb</span> <span class="o">*</span><span class="nx">table</span><span class="p">,</span> <span class="nx">tsids</span> <span class="p">[]</span><span class="nx">TSID</span><span class="p">,</span> <span class="nx">tr</span> <span class="nx">TimeRange</span><span class="p">,</span> <span class="nx">fetchData</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</code></pre></div><p>今回はこのへんで。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
