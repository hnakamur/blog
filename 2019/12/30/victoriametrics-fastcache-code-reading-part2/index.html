<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.101.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>VictoriaMetrics/fastcacheのコードリーディングその2 &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2022. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>VictoriaMetrics/fastcacheのコードリーディングその2</h1>
  <time datetime=2019-12-30T05:11:55&#43;0900 class="post-date">2019-12-30</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#コードリーディング">コードリーディング</a>
      <ul>
        <li><a href="#savetofile-関数">SaveToFile 関数</a></li>
        <li><a href="#savetofileconcurrent-関数">SaveToFileConcurrent 関数</a></li>
        <li><a href="#loadfromfile-関数">LoadFromFile 関数</a></li>
        <li><a href="#loadfromfileornew-関数">LoadFromFileOrNew 関数</a></li>
        <li><a href="#cache-の-save-メソッド">Cache の save メソッド</a></li>
        <li><a href="#load-関数">load 関数</a></li>
        <li><a href="#savemetadata-関数">saveMetadata 関数</a></li>
        <li><a href="#loadmetadata-関数">loadMetadata 関数</a></li>
        <li><a href="#savebuckets-関数">saveBuckets 関数</a></li>
        <li><a href="#loadbuckets-関数">loadBuckets 関数</a></li>
        <li><a href="#bucket-の-save-メソッド">bucket の Save メソッド</a></li>
        <li><a href="#bucket-の-load-メソッド">bucket の Load メソッド</a></li>
        <li><a href="#writeuint64-関数">writeUint64 関数</a></li>
        <li><a href="#readuint64">readUint64</a></li>
      </ul>
    </li>
    <li><a href="#まとめ">まとめ</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p><a href="/blog/2019/12/30/victoriametrics-fastcache-code-reading-part1/">VictoriMetrics/fastcacheのコードリーディングその1</a> の後、新しいコミットが入っていたので今回の対象は <a href="https://github.com/VictoriaMetrics/fastcache/commit/2dd94801554bb525434adca19ae035c391934f18">2dd9480</a> です。</p>
<p>今回はファイルへの書き出しとファイルからの読み込みが対象です。ファイルは <a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go">file.go</a> です。</p>
<h2 id="コードリーディング">コードリーディング</h2>
<h3 id="savetofile-関数">SaveToFile 関数</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L16-L26">file.go#L16-L26</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// SaveToFile atomically saves cache data to the given filePath using a single
</span></span></span><span class="line"><span class="cl"><span class="c1">// CPU core.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// SaveToFile may be called concurrently with other operations on the cache.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The saved data may be loaded with LoadFromFile*.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// See also SaveToFileConcurrent for faster saving to file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nf">SaveToFile</span><span class="p">(</span><span class="nx">filePath</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nf">SaveToFileConcurrent</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>SaveToFileConcurrent</code> メソッドを並列度1で呼ぶラッパメソッドです。</p>
<h3 id="savetofileconcurrent-関数">SaveToFileConcurrent 関数</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L28-L77">file.go#L28-L77</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// SaveToFileConcurrent saves cache data to the given filePath using concurrency
</span></span></span><span class="line"><span class="cl"><span class="c1">// CPU cores.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// SaveToFileConcurrent may be called concurrently with other operations
</span></span></span><span class="line"><span class="cl"><span class="c1">// on the cache.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The saved data may be loaded with LoadFromFile*.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// See also SaveToFile.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nf">SaveToFileConcurrent</span><span class="p">(</span><span class="nx">filePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">concurrency</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Create dir if it doesn&#39;t exist.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">dir</span> <span class="o">:=</span> <span class="nx">filepath</span><span class="p">.</span><span class="nf">Dir</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Stat</span><span class="p">(</span><span class="nx">dir</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">os</span><span class="p">.</span><span class="nf">IsNotExist</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot stat %q: %s&#34;</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">MkdirAll</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot create dir %q: %s&#34;</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Save cache data into a temporary directory.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">tmpDir</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ioutil</span><span class="p">.</span><span class="nf">TempDir</span><span class="p">(</span><span class="nx">dir</span><span class="p">,</span> <span class="s">&#34;fastcache.tmp.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot create temporary dir inside %q: %s&#34;</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">tmpDir</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_</span> <span class="p">=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="nx">tmpDir</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">gomaxprocs</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">GOMAXPROCS</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">concurrency</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">concurrency</span> <span class="p">&gt;</span> <span class="nx">gomaxprocs</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">concurrency</span> <span class="p">=</span> <span class="nx">gomaxprocs</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="nx">tmpDir</span><span class="p">,</span> <span class="nx">concurrency</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot save cache data to temporary dir %q: %s&#34;</span><span class="p">,</span> <span class="nx">tmpDir</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Remove old filePath contents, since os.Rename may return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// error if filePath dir exists.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">RemoveAll</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot remove old contents at %q: %s&#34;</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Rename</span><span class="p">(</span><span class="nx">tmpDir</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot move temporary dir %q to %q: %s&#34;</span><span class="p">,</span> <span class="nx">tmpDir</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">tmpDir</span> <span class="p">=</span> <span class="s">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>引数の <code>concurrency</code> で指定した数のCPUコアで並列実行して <code>Cache</code> をファイルに書き出します。</li>
<li>指定の <code>filePath</code> のパスのディレクトリ部分に対応するディレクトリが無い場合は作ります。</li>
<li>上記のディレクトリの下に中間ディレクトリ <code>tmpDir</code> を作ります。</li>
<li><a href="https://golang.org/pkg/runtime/#GOMAXPROCS">runtime.GOMAXPROCS</a> を引数 -1 で呼ぶことで同時実行可能な CPU の最大数の現在の設定値を取得して <code>gomaxprocs</code> 変数に設定します。</li>
<li><code>concurency</code> が 0 以下かこの値より大きい場合は <code>gomaxprocs</code> の値にします。</li>
<li><code>Cache</code> の <code>save</code> メソッドを上記で調整した <code>concurrency</code> で呼び出します。</li>
<li><code>filePath</code> で指定したパスに古いコンテンツがある場合はまず削除します。</li>
<li><code>tmpDir</code> を <code>filePath</code> にリネームします。</li>
</ul>
<h3 id="loadfromfile-関数">LoadFromFile 関数</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L79-L84">file.go#L79-L84</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// LoadFromFile loads cache data from the given filePath.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// See SaveToFile* for saving cache data to file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">LoadFromFile</span><span class="p">(</span><span class="nx">filePath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Cache</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">load</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>load</code> 関数を <code>maxBytes</code> を 0 で呼び出します。</p>
<h3 id="loadfromfileornew-関数">LoadFromFileOrNew 関数</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L86-L96">file.go#L86-L96</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// LoadFromFileOrNew tries loading cache data from the given filePath.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The function falls back to creating new cache with the given maxBytes
</span></span></span><span class="line"><span class="cl"><span class="c1">// capacity if error occurs during loading the cache from file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">LoadFromFileOrNew</span><span class="p">(</span><span class="nx">filePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">maxBytes</span> <span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="nx">Cache</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">c</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">load</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">maxBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nf">New</span><span class="p">(</span><span class="nx">maxBytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>load</code> でファイルから読み込んで成功したらそれを返し、失敗したら <code>New</code> を呼んで新規作成します。</p>
<h3 id="cache-の-save-メソッド">Cache の save メソッド</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L98-L126">file.go#L98-L126</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">)</span> <span class="nf">save</span><span class="p">(</span><span class="nx">dir</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">workersCount</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">saveMetadata</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">dir</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Save buckets by workersCount concurrent workers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">workCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">workersCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">results</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">workersCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">workerNum</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">results</span> <span class="o">&lt;-</span> <span class="nf">saveBuckets</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">buckets</span><span class="p">[:],</span> <span class="nx">workCh</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">workerNum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Feed workers with work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">buckets</span><span class="p">[:]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">workCh</span> <span class="o">&lt;-</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nb">close</span><span class="p">(</span><span class="nx">workCh</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Read results.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">workersCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">results</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">result</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">err</span> <span class="p">=</span> <span class="nx">result</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>まず <code>saveMetadata</code> 関数を呼んでメタデータを <code>dir</code> 引数で指定されたディレクトリに保存します。</li>
<li><code>workersCount</code> 引数の数だけ goroutine を作ります。 <code>workersCount</code> のバッファを持つ <code>chan int</code> 型の <code>workCh</code> と <code>chan error</code> 型の <code>results</code> も作ります。</li>
<li><a href="https://blog.golang.org/pipelines">Go Concurrency Patterns: Pipelines and cancellation - The Go Blog</a> の <a href="https://blog.golang.org/pipelines#TOC_4.">Fan-out, fan-in</a> と似たようなパターンですがここでは <a href="https://golang.org/pkg/sync/#WaitGroup">sync.WaitGroup</a> を使わず <code>results</code> で <code>workersCount</code> 個の結果を待つようにしています。</li>
<li>各 goroutine は <code>saveBuckets</code> 関数を呼び出します。</li>
<li><code>workCh</code> には <code>c.buckets</code> の要素数分のインデクスを送って、これを各 goroutine が受け取って処理を実行します。</li>
<li><code>result != nil &amp;&amp; err != nil</code> は <code>result != nil &amp;&amp; err == nil</code> の間違いだと思います。 <code>results</code> から <code>nil</code> 以外の値が返ってきたときは最初のエラーを保管しておくという意図のはずです。 <code>result != nil &amp;&amp; err != nil</code> だと <code>err</code> が初期値の <code>nil</code> のままで <code>result</code> は <code>nil</code> 以外でも捨てられることになってしまいます。
<ul>
<li>2020-01-01追記: これを修正するプルリクエスト <a href="https://github.com/VictoriaMetrics/fastcache/pull/28">Fix taking the first error from workers in save by hnakamur · Pull Request #28 · VictoriaMetrics/fastcache</a> を送っていたのが無事マージされました。</li>
</ul>
</li>
</ul>
<h3 id="load-関数">load 関数</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L128-L177">file.go#L128-L177</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">load</span><span class="p">(</span><span class="nx">filePath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">maxBytes</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Cache</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">maxBucketChunks</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">loadMetadata</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">maxBytes</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">maxBucketBytes</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">((</span><span class="nx">maxBytes</span> <span class="o">+</span> <span class="nx">bucketsCount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nx">bucketsCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">expectedBucketChunks</span> <span class="o">:=</span> <span class="p">(</span><span class="nx">maxBucketBytes</span> <span class="o">+</span> <span class="nx">chunkSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nx">chunkSize</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">maxBucketChunks</span> <span class="o">!=</span> <span class="nx">expectedBucketChunks</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cache file %s contains maxBytes=%d; want %d&#34;</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">maxBytes</span><span class="p">,</span> <span class="nx">expectedBucketChunks</span><span class="o">*</span><span class="nx">chunkSize</span><span class="o">*</span><span class="nx">bucketsCount</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Read bucket files from filePath dir.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">d</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot open %q: %s&#34;</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">fis</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Readdir</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot read files from %q: %s&#34;</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">results</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">workersCount</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">c</span> <span class="nx">Cache</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">fi</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">fis</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fn</span> <span class="o">:=</span> <span class="nx">fi</span><span class="p">.</span><span class="nf">Name</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">fi</span><span class="p">.</span><span class="nf">IsDir</span><span class="p">()</span> <span class="o">||</span> <span class="p">!</span><span class="nx">dataFileRegexp</span><span class="p">.</span><span class="nf">MatchString</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">workersCount</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">dataPath</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">results</span> <span class="o">&lt;-</span> <span class="nf">loadBuckets</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">buckets</span><span class="p">[:],</span> <span class="nx">dataPath</span><span class="p">,</span> <span class="nx">maxBucketChunks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}(</span><span class="nx">filePath</span> <span class="o">+</span> <span class="s">&#34;/&#34;</span> <span class="o">+</span> <span class="nx">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">err</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">workersCount</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">result</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">results</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">result</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">err</span> <span class="p">=</span> <span class="nx">result</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">c</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>まず <code>loadMetadata</code> 関数でメタデータを読み込みます。戻り値としてバケットのチャンク数を受け取り <code>maxBucketChunks</code> 変数にセットします。</li>
<li><code>maxBytes</code> 引数に0より大きな指定された場合は、その値から期待されるバケットのチャンク数 <code>expectedBucketChunks</code> を計算します。まず <code>maxBytes</code> を <code>bucketsCount</code> (=512) で割って切り上げた数を <code>maxBucketBytes</code> （1バケットあたりの最大バイト数）に設定します。次に <code>maxBucketBytes</code> を <code>chunkSize</code> (=64KiB) で割って切り上げた数を <code>expectedBucketChunks</code> にセットし <code>maxBucketChunks</code> と比較し一致しない場合はエラーを返します。</li>
<li><code>filePath</code> のディレクトリを開いて <code>Readdir</code> メソッドでディレクトリエントリ一覧を読み取ります。</li>
<li>この後 goroutine からの結果を受け取る <code>chan error</code> 型のチャンネル <code>results</code> を作成します。</li>
<li><code>dataFileRegexp</code> の正規表現にマッチする名前のディレクトリを処理対象とし、それぞれに goroutine を作成します。goroutine 内では <code>loadBuckets</code> 関数を呼んで結果を <code>results</code> に返します。 <code>workersCount</code> は 0 から goroutine 作成毎にインクリメントし、最終的に作成した goroutine の数になります。 各 goroutine は読み込んだ結果を <code>Cache</code> の各バケットにセットします。</li>
<li>goroutine の呼び出し側では作成した goroutine の数を <code>workersCount</code> としその数だけ <code>results</code> から結果を受け取ります。 <code>results</code> からは受け取った <code>nil</code> でない最初のエラーを保管しておき、エラーがあった場合はエラーを返し、エラーが無かった場合は <code>Cache</code> のポインタを返します。</li>
</ul>
<p><code>dataFileRegexp</code> 変数は <a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L214">file.go#L214</a> で定義されています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">dataFileRegexp</span> <span class="p">=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nf">MustCompile</span><span class="p">(</span><span class="s">`^data\.\d+\.bin$`</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="savemetadata-関数">saveMetadata 関数</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L179-L193">file.go#L179-L193</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">saveMetadata</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Cache</span><span class="p">,</span> <span class="nx">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">metadataPath</span> <span class="o">:=</span> <span class="nx">dir</span> <span class="o">+</span> <span class="s">&#34;/metadata.bin&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">metadataFile</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">metadataPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot create %q: %s&#34;</span><span class="p">,</span> <span class="nx">metadataPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">metadataFile</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">maxBucketChunks</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nb">cap</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">buckets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">chunks</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">writeUint64</span><span class="p">(</span><span class="nx">metadataFile</span><span class="p">,</span> <span class="nx">maxBucketChunks</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot write maxBucketChunks=%d to %q: %s&#34;</span><span class="p">,</span> <span class="nx">maxBucketChunks</span><span class="p">,</span> <span class="nx">metadataPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>引数 <code>dir</code> の下に <code>metadata.bin</code> というファイルを作成しバケットのチャンク数を <code>uint64</code> 型で書き出します。バケットのチャンク数はどのバケットも同じなので最初のバケットのチャンク数を使っています。</li>
</ul>
<h3 id="loadmetadata-関数">loadMetadata 関数</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L195-L212">file.go#L195-L212</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">loadMetadata</span><span class="p">(</span><span class="nx">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">uint64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">metadataPath</span> <span class="o">:=</span> <span class="nx">dir</span> <span class="o">+</span> <span class="s">&#34;/metadata.bin&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">metadataFile</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">metadataPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot open %q: %s&#34;</span><span class="p">,</span> <span class="nx">metadataPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">metadataFile</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">maxBucketChunks</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">readUint64</span><span class="p">(</span><span class="nx">metadataFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot read maxBucketChunks from %q: %s&#34;</span><span class="p">,</span> <span class="nx">metadataPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">maxBucketChunks</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid maxBucketChunks=0 read from %q&#34;</span><span class="p">,</span> <span class="nx">metadataPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">maxBucketChunks</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>引数 <code>dir</code> の下に <code>metadata.bin</code> というファイル <code>uint64</code> 型の値を読み取ります。読み取り時にエラーが起きた時と読み取った結果が0の場合はエラーとします。</li>
</ul>
<h3 id="savebuckets-関数">saveBuckets 関数</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L216-L238">file.go#L216-L238</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">saveBuckets</span><span class="p">(</span><span class="nx">buckets</span> <span class="p">[]</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">workCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">dir</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">workerNum</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">dataPath</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s/data.%d.bin&#34;</span><span class="p">,</span> <span class="nx">dir</span><span class="p">,</span> <span class="nx">workerNum</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">dataFile</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="nx">dataPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot create %q: %s&#34;</span><span class="p">,</span> <span class="nx">dataPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">dataFile</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">zw</span> <span class="o">:=</span> <span class="nx">snappy</span><span class="p">.</span><span class="nf">NewBufferedWriter</span><span class="p">(</span><span class="nx">dataFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">bucketNum</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">workCh</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">writeUint64</span><span class="p">(</span><span class="nx">zw</span><span class="p">,</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">bucketNum</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot write bucketNum=%d to %q: %s&#34;</span><span class="p">,</span> <span class="nx">bucketNum</span><span class="p">,</span> <span class="nx">dataPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">buckets</span><span class="p">[</span><span class="nx">bucketNum</span><span class="p">].</span><span class="nf">Save</span><span class="p">(</span><span class="nx">zw</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot save bucket[%d] to %q: %s&#34;</span><span class="p">,</span> <span class="nx">bucketNum</span><span class="p">,</span> <span class="nx">dataPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">zw</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot close snappy.Writer for %q: %s&#34;</span><span class="p">,</span> <span class="nx">dataPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li><code>dir</code> 配下に <code>data.%d.bin</code> (<code>%d</code> にはワーカーの連番IDを設定 )というファイルを作成します。ファイルには snappy 形式で圧縮した内容を書き込むようにしています。</li>
<li><code>workCh</code> からバケットのインデクスを受け取ったら、それを <code>uint64</code> 形式で書き出し、その後バケットの <code>Save</code> メソッドを呼び出して書き込みます。</li>
</ul>
<h3 id="loadbuckets-関数">loadBuckets 関数</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L240-L262">file.go#L240-L262</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">loadBuckets</span><span class="p">(</span><span class="nx">buckets</span> <span class="p">[]</span><span class="nx">bucket</span><span class="p">,</span> <span class="nx">dataPath</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">maxChunks</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">dataFile</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="nx">dataPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot open %q: %s&#34;</span><span class="p">,</span> <span class="nx">dataPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="p">=</span> <span class="nx">dataFile</span><span class="p">.</span><span class="nf">Close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="p">}()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">zr</span> <span class="o">:=</span> <span class="nx">snappy</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">dataFile</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bucketNum</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">readUint64</span><span class="p">(</span><span class="nx">zr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="nx">io</span><span class="p">.</span><span class="nx">EOF</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Reached the end of file.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">bucketNum</span> <span class="o">&gt;=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">buckets</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unexpected bucketNum read from %q: %d; must be smaller than %d&#34;</span><span class="p">,</span> <span class="nx">dataPath</span><span class="p">,</span> <span class="nx">bucketNum</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">buckets</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">buckets</span><span class="p">[</span><span class="nx">bucketNum</span><span class="p">].</span><span class="nf">Load</span><span class="p">(</span><span class="nx">zr</span><span class="p">,</span> <span class="nx">maxChunks</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot load bucket[%d] from %q: %s&#34;</span><span class="p">,</span> <span class="nx">bucketNum</span><span class="p">,</span> <span class="nx">dataPath</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li><code>dataPath</code> 引数のパスを開いて snappy 形式で読み出します。</li>
<li>最初に <code>uint64</code> 形式でバケットのインデクスを読み取ります。</li>
<li>バケットのインデクスがバケットの数以上の場合はエラーを返します。</li>
<li>上記のインデクスのバケットにファイルから読み込んだバケットの内容を設定します。</li>
</ul>
<h3 id="bucket-の-save-メソッド">bucket の Save メソッド</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L264-L315">file.go#L264-L315</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">bucket</span><span class="p">)</span> <span class="nf">Save</span><span class="p">(</span><span class="nx">w</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">b</span><span class="p">.</span><span class="nf">Clean</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">b</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">RLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="k">defer</span> <span class="nx">b</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">RUnlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Store b.idx, b.gen and b.m to w.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="nx">bIdx</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">idx</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bGen</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">gen</span>
</span></span><span class="line"><span class="cl">  <span class="nx">chunksLen</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">chunk</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">b</span><span class="p">.</span><span class="nx">chunks</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">chunk</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chunksLen</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">kvs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">m</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">u64Buf</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">b</span><span class="p">.</span><span class="nx">m</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">PutUint64</span><span class="p">(</span><span class="nx">u64Buf</span><span class="p">[:],</span> <span class="nx">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kvs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">kvs</span><span class="p">,</span> <span class="nx">u64Buf</span><span class="p">[:]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">PutUint64</span><span class="p">(</span><span class="nx">u64Buf</span><span class="p">[:],</span> <span class="nx">v</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kvs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">kvs</span><span class="p">,</span> <span class="nx">u64Buf</span><span class="p">[:]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">writeUint64</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">bIdx</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot write b.idx: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">writeUint64</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">bGen</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot write b.gen: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">writeUint64</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nb">uint64</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">kvs</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot write len(b.m): %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">kvs</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot write b.m: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Store b.chunks to w.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">writeUint64</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">chunksLen</span><span class="p">));</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot write len(b.chunks): %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">chunkIdx</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">chunkIdx</span> <span class="p">&lt;</span> <span class="nx">chunksLen</span><span class="p">;</span> <span class="nx">chunkIdx</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chunk</span> <span class="o">:=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">chunks</span><span class="p">[</span><span class="nx">chunkIdx</span><span class="p">][:</span><span class="nx">chunkSize</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">chunk</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot write b.chunks[%d]: %s&#34;</span><span class="p">,</span> <span class="nx">chunkIdx</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li><code>b.idx</code>, <code>b.gen</code> と <code>b.m</code> を書き出します。 <code>b.idx</code>, <code>b.gen</code> は <code>uint64</code> 形式で書きます。 <code>b.m</code> は各エントリのキーとバリューを <code>uint64</code> 形式でバイト列にしたものを <code>kvs</code> 変数に設定します。まずエントリ数を <code>uint64</code> 形式で書いてその後に <code>kvs</code> のバイト列を書き出します。</li>
<li>その後 <code>b.chunks</code> の内容を書き出します。コードの手前の方で <code>b.chunks</code> のうち最初の <code>nil</code> でない部分の個数を <code>chunksLen</code> に設定しています。まず <code>chunksLen</code> を <code>uint64</code> 形式で書き出し、その後 <code>b.chunks</code> の各チャンクのバイト列の 64KiB 分のデータを書き出します。</li>
</ul>
<h3 id="bucket-の-load-メソッド">bucket の Load メソッド</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L317-L393">file.go#L317-L393</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">bucket</span><span class="p">)</span> <span class="nf">Load</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">,</span> <span class="nx">maxChunks</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">maxChunks</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;the number of chunks per bucket cannot be zero&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bIdx</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">readUint64</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot read b.idx: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bGen</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">readUint64</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot read b.gen: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">kvsLen</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">readUint64</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot read len(b.m): %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">kvsLen</span> <span class="o">*=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">  <span class="nx">kvs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">kvsLen</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadFull</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">kvs</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot read b.m: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">m</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">uint64</span><span class="p">]</span><span class="kt">uint64</span><span class="p">,</span> <span class="nx">kvsLen</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nb">len</span><span class="p">(</span><span class="nx">kvs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">k</span> <span class="o">:=</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">Uint64</span><span class="p">(</span><span class="nx">kvs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kvs</span> <span class="p">=</span> <span class="nx">kvs</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="nx">v</span> <span class="o">:=</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">Uint64</span><span class="p">(</span><span class="nx">kvs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">kvs</span> <span class="p">=</span> <span class="nx">kvs</span><span class="p">[</span><span class="mi">8</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">maxBytes</span> <span class="o">:=</span> <span class="nx">maxChunks</span> <span class="o">*</span> <span class="nx">chunkSize</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">maxBytes</span> <span class="o">&gt;=</span> <span class="nx">maxBucketSize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;too big maxBytes=%d; should be smaller than %d&#34;</span><span class="p">,</span> <span class="nx">maxBytes</span><span class="p">,</span> <span class="nx">maxBucketSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">chunks</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([][]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">maxChunks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">chunksLen</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">readUint64</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot read len(b.chunks): %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">chunksLen</span> <span class="p">&gt;</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">maxChunks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;chunksLen=%d cannot exceed maxChunks=%d&#34;</span><span class="p">,</span> <span class="nx">chunksLen</span><span class="p">,</span> <span class="nx">maxChunks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">currChunkIdx</span> <span class="o">:=</span> <span class="nx">bIdx</span> <span class="o">/</span> <span class="nx">chunkSize</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">currChunkIdx</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">currChunkIdx</span> <span class="o">&gt;=</span> <span class="nx">chunksLen</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;too big bIdx=%d; should be smaller than %d&#34;</span><span class="p">,</span> <span class="nx">bIdx</span><span class="p">,</span> <span class="nx">chunksLen</span><span class="o">*</span><span class="nx">chunkSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">chunkIdx</span> <span class="o">:=</span> <span class="nb">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">chunkIdx</span> <span class="p">&lt;</span> <span class="nx">chunksLen</span><span class="p">;</span> <span class="nx">chunkIdx</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chunk</span> <span class="o">:=</span> <span class="nf">getChunk</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chunks</span><span class="p">[</span><span class="nx">chunkIdx</span><span class="p">]</span> <span class="p">=</span> <span class="nx">chunk</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadFull</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">chunk</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Free up allocated chunks before returning the error.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">chunk</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">chunks</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">chunk</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nf">putChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;cannot read b.chunks[%d]: %s&#34;</span><span class="p">,</span> <span class="nx">chunkIdx</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Adjust len for the chunk pointed by currChunkIdx.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="nx">chunksLen</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chunkLen</span> <span class="o">:=</span> <span class="nx">bIdx</span> <span class="o">%</span> <span class="nx">chunkSize</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chunks</span><span class="p">[</span><span class="nx">currChunkIdx</span><span class="p">]</span> <span class="p">=</span> <span class="nx">chunks</span><span class="p">[</span><span class="nx">currChunkIdx</span><span class="p">][:</span><span class="nx">chunkLen</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">b</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">chunk</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">b</span><span class="p">.</span><span class="nx">chunks</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">putChunk</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">b</span><span class="p">.</span><span class="nx">chunks</span> <span class="p">=</span> <span class="nx">chunks</span>
</span></span><span class="line"><span class="cl">  <span class="nx">b</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="nx">m</span>
</span></span><span class="line"><span class="cl">  <span class="nx">b</span><span class="p">.</span><span class="nx">idx</span> <span class="p">=</span> <span class="nx">bIdx</span>
</span></span><span class="line"><span class="cl">  <span class="nx">b</span><span class="p">.</span><span class="nx">gen</span> <span class="p">=</span> <span class="nx">bGen</span>
</span></span><span class="line"><span class="cl">  <span class="nx">b</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li><code>Save</code> メソッドで書いた形式に沿って読み込んでいきます。読み取る際に <code>maxChunks</code> 引数の値から算出した値とファイルから読みこんで得られた値を比較して（詳細は上記のコードを参照）おかしい場合はエラーを返します。</li>
<li>現在の書き込み対象のチャンクのインデクスを <code>bIdx / chunkSize</code> で算出し <code>currChunkIdx</code> 変数にセットしています。そのチャンク内の書き込み位置を <code>bIdx % chunkSize</code> で算出して、チャンクの <code>cap</code> はそのままにして <code>len</code> をその値に調節しています。</li>
<li><code>b.chunks</code> でループして <code>putChunk</code> 関数を呼んでいる箇所は初回は <code>b.chunks</code> が <code>nil</code> なので何もしません。一旦構築後に <code>Load</code> を呼んだ場合は古いチャンクを解放する必要があるのでループで回して <code>putChunk</code> を呼んでいます。</li>
</ul>
<h3 id="writeuint64-関数">writeUint64 関数</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L395-L400">file.go#L395-L400</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">writeUint64</span><span class="p">(</span><span class="nx">w</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">u</span> <span class="kt">uint64</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">u64Buf</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">  <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">PutUint64</span><span class="p">(</span><span class="nx">u64Buf</span><span class="p">[:],</span> <span class="nx">u</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="nx">u64Buf</span><span class="p">[:])</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>LittleEndian の uint64 形式で値を書き出します。</li>
</ul>
<h3 id="readuint64">readUint64</h3>
<p><a href="https://github.com/VictoriaMetrics/fastcache/blob/2dd94801554bb525434adca19ae035c391934f18/file.go#L402-L409">file.go#L402-L409</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">readUint64</span><span class="p">(</span><span class="nx">r</span> <span class="nx">io</span><span class="p">.</span><span class="nx">Reader</span><span class="p">)</span> <span class="p">(</span><span class="kt">uint64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">u64Buf</span> <span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">io</span><span class="p">.</span><span class="nf">ReadFull</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">u64Buf</span><span class="p">[:]);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">u</span> <span class="o">:=</span> <span class="nx">binary</span><span class="p">.</span><span class="nx">LittleEndian</span><span class="p">.</span><span class="nf">Uint64</span><span class="p">(</span><span class="nx">u64Buf</span><span class="p">[:])</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">u</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>LittleEndian の uint64 形式で値を読み取ります。</li>
</ul>
<h2 id="まとめ">まとめ</h2>
<p><a href="/blog/2019/12/30/victoriametrics-fastcache-code-reading-part1/">VictoriMetrics/fastcacheのコードリーディングその1</a> と合わせて主な処理は読み終わりました。</p>
<ul>
<li>fastcache は作成時に指定した最大バイト数の領域をリングバッファ形式で書いていくという仕組みになっています。運用中にメモリ使用量が増えるという心配がない一方、指定のバイト数を超えると古いエントリが上書きされていきます。</li>
<li>Google App Engine と Windows 以外では mmap を使ってGoのGCの管理外でメモリ割り当てをすることでGCのオーバーヘッドを回避しています。</li>
<li>キーの最大長は 64KiB です。</li>
<li>値のサイズが 64KiB を超える場合は 64KiB より少し小さい単位で分割して同じハッシュ空間に別のキー (subkey) で保管します。</li>
<li>キーも subkey も衝突したら古いエントリを黙って上書きします。</li>
</ul>
<p>ハッシュ衝突の際に黙って上書きという割り切り仕様が高速化に寄与しているんだろうなと思いますが、実際に自分が使うことを考えると不安が残ります。</p>
<p>全般としては mmap で割り当てたメモリ領域を使ってデータ構造を構築する見本として非常に勉強になりました。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KMMXGG2Z56', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
