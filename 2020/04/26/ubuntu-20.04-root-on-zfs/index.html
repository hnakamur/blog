<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.140.1">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>ルートパーティションをZFSにしてUbuntu 20.04 LTSをインストールしてみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=G-KMMXGG2Z56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KMMXGG2Z56');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2025. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>ルートパーティションをZFSにしてUbuntu 20.04 LTSをインストールしてみた</h1>
  <time datetime=2020-04-26T15:13:33&#43;0900 class="post-date">2020-04-26</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#デスクトップインストーラーをダウンロードして-usb-メモリに書き出す">デスクトップインストーラーをダウンロードして USB メモリに書き出す</a></li>
    <li><a href="#step-1--インストール環境の整備">Step. 1:  インストール環境の整備</a>
      <ul>
        <li><a href="#デスクトップインストーラーを起動しsshの環境整備">デスクトップインストーラーを起動しsshの環境整備</a></li>
        <li><a href="#別のマシンから対象のサーバーに-ssh-してインストール作業を続行">別のマシンから対象のサーバーに ssh してインストール作業を続行</a></li>
      </ul>
    </li>
    <li><a href="#step-2-ディスクのフォーマット">Step. 2: ディスクのフォーマット</a></li>
    <li><a href="#step-3-システムのインストール">Step. 3: システムのインストール</a></li>
    <li><a href="#step-4-システム設定">Step. 4: システム設定</a></li>
    <li><a href="#step-5-grub-のインストール">Step. 5: GRUB のインストール</a></li>
    <li><a href="#step-6-初回のブート">Step. 6: 初回のブート</a></li>
    <li><a href="#step-7-スワップを設定します">Step. 7: スワップを設定します。</a></li>
    <li><a href="#step-8-フルのソフトウェアインストール">Step. 8: フルのソフトウェアインストール</a></li>
    <li><a href="#step-9-最終クリーンアップ">Step. 9: 最終クリーンアップ</a></li>
    <li><a href="#上記手順外で気になること">上記手順外で気になること</a>
      <ul>
        <li><a href="#zfs-mount-generator">zfs-mount-generator</a></li>
        <li><a href="#シャットダウン時に一部アンマウント失敗のエラーが出る">シャットダウン時に一部アンマウント失敗のエラーが出る</a></li>
      </ul>
    </li>
    <li><a href="#おわりに">おわりに</a></li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p>実はルートパーティションをZFSにするのは以前から試してみたいと思っていました。</p>
<p><a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=Trying-Ubuntu-20.04-ZFS-Snaps">Trying Out Ubuntu 20.04 With ZFS + Zsys Automated APT Snapshots - Phoronix</a>
をみて Ubuntu 20.04 LTS のデスクトップインストーラーで advanced features に追加されたというのを知りました。
ただし、 ZFS をルートファイルシステムにするのは引き続き experimental です。</p>
<p>ということで、今回普段使って無い物理サーバーでルートパーティションをZFSにしてUbuntu 20.04 LTSをインストールするのを試してみました。</p>
<p>ただし、上記のデスクトップインストーラーのメニューからではなく
<a href="https://github.com/openzfs/zfs/wiki/Ubuntu-18.04-Root-on-ZFS">Ubuntu 18.04 Root on ZFS · openzfs/zfs Wiki</a> を参考に試行錯誤しました。</p>
<p>またインストーラーはデスクトップ用を使いますが、セットアップしたのは GUI 無しのサーバーです（ただし Wiki の手順を見るとデスクトップ版も同様にできそう）。</p>
<p>一部変更したので手順をメモしておきます。</p>
<p>試行錯誤の途中、上記のWiki以外にいろんなページを参照しましたが、主なのは以下の2つです。</p>
<ul>
<li><a href="https://blog.ls-al.com/category/zfs/">Ubuntu server 20.04 zfs root and OCI – Riaan&rsquo;s SysAdmin Blog</a></li>
<li><a href="https://www.reddit.com/r/zfs/comments/8lf9d1/zfsonlinux_new_feature_systemd_mount_integration/">zfsonlinux new feature: systemd mount integration : zfs</a></li>
</ul>
<p>また、使用するサーバーの起動方法がレガシー BIOS か UEFI かによって一部手順が異なります。私はレガシー BIOS のサーバーしか試してないので、ここではそちらの手順を書きます（ UEFI の場合は適宜 Wiki のほうを参照してください）。</p>
<h2 id="デスクトップインストーラーをダウンロードして-usb-メモリに書き出す">デスクトップインストーラーをダウンロードして USB メモリに書き出す</h2>
<p><a href="https://ubuntu.com/download/desktop">Download Ubuntu Desktop | Download | Ubuntu</a>
から <code>ubuntu-20.04-desktop-amd64.iso</code> をダウンロードします。</p>
<p>サイズは約 2.6 GB なので、これ以上の容量を持つ USB メモリを用意します。</p>
<p>次に <a href="https://www.balena.io/etcher/">balenaEtcher - Flash OS images to SD cards &amp; USB drives</a> をダウンロードして上記の iso ファイルを USB メモリに書き出します。</p>
<h2 id="step-1--インストール環境の整備">Step. 1:  インストール環境の整備</h2>
<p>この Step の番号は Wiki に合わせています。</p>
<h3 id="デスクトップインストーラーを起動しsshの環境整備">デスクトップインストーラーを起動しsshの環境整備</h3>
<p>サーバーに USB メモリを挿して、 BIOS のメニューで起動順序で USB メモリの優先度を上げて USB メモリから起動します。</p>
<p>GUI インストーラーが立ち上がって Welcome という画面が表示されたら、 TAB キーを押して Try Ubuntu ボタンにフォーカスを移動して（ボタンにオレンジの枠がつきます） Enter キーを押します（画面のスクリーンショットは <a href="https://linuxconfig.org/how-to-install-ubuntu-20-04-focal-fossa-desktop">How to install Ubuntu 20.04 Focal Fossa Desktop - LinuxConfig.org</a> 参照）。</p>
<p>私は DHCP でネットワークが自動で設定されましたが、そうでない場合は手動で設定します。</p>
<p>ここからはターミナルで作業します。</p>
<p>Ctrl + Alt + T キーを押してターミナルを開き、以下のコマンドを実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo apt-add-repository universe
</span></span></span><span class="line"><span class="cl"><span class="go">sudo apt update
</span></span></span></code></pre></div><p>アップグレード可能なパッケージがある旨表示されるかもしれませんが、 Live CD 環境は一時的なものなのでここでは更新せずに次に進みます。</p>
<p>passwd コマンドを実行して ubuntu ユーザーのパスワードを設定します。プロンプトが表示されますので設定したいパスワードを入力します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">passwd
</span></span></span></code></pre></div><p>openssh-server をインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo apt install --yes openssh-server
</span></span></span></code></pre></div><p>以下のコマンドを実行して IP アドレスを確認しておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ip a s
</span></span></span></code></pre></div><h3 id="別のマシンから対象のサーバーに-ssh-してインストール作業を続行">別のマシンから対象のサーバーに ssh してインストール作業を続行</h3>
<p>以下の手順でコマンドをコピペして実行したいので、以下は別のマシンから対象のサーバーに ssh して作業します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ssh ubuntu@対象のサーバーのIPアドレス
</span></span></span></code></pre></div><p>以下のコマンドを実行し、上記で設定したパスワードを入力して root ユーザーになります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo -i
</span></span></span></code></pre></div><p>以下のコマンドを実行して Live CD の環境に ZFS をインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt install --yes debootstrap gdisk zfs-initramfs
</span></span></span></code></pre></div><h2 id="step-2-ディスクのフォーマット">Step. 2: ディスクのフォーマット</h2>
<p>以下のコマンドを実行して、インストール先のディスクエイリアスを確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ls -l /dev/disk/by-id/
</span></span></span></code></pre></div><p>仮想マシンにインストールするなどで上記で対象のディスクが出ない場合は Wiki を参照してください。</p>
<p>以下の作業のため、ディスク名を <code>DISK</code> という変数に設定しておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">DISK=/dev/disk/by-id/インストール先のディスクエイリアス
</span></span></span></code></pre></div><p>私の場合は
<code>DISK=/dev/disk/by-id/ata-INTEL_SSDSA2M160G2GC_CVPO999999SN160AGN</code>
のような感じでした（999…のところは伏せてます）。</p>
<p>ディスクのパーティションテーブルを一旦全削除します。当然データは失われますので注意。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sgdisk --zap-all $DISK
</span></span></span></code></pre></div><p>次にパーティションを作成していきます。</p>
<p>レガシーBIOSの場合は以下を実行します（ UEFI の場合は Wiki 参照）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sgdisk -a1 -n1:24K:+1000K -t1:EF02 $DISK
</span></span></span></code></pre></div><p>ブート (/boot) パーティションを作成します（ <code>-t</code> の後のパーティション番号は詰めて 2 にしても良いのですが、 Wiki の手順と合わせて UEFI 用の 2 を欠番とし、 3 としています）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sgdisk     -n3:0:+1G      -t3:BF01 $DISK
</span></span></span></code></pre></div><p>ルート (/) パーティションを作成します。
今回は暗号化しない方式を選択しました（もし暗号化する場合は Wiki に書かれている LUKS より <a href="https://wiki.archlinux.jp/index.php/ZFS#.E3.83.8D.E3.82.A4.E3.83.86.E3.82.A3.E3.83.96.E6.9A.97.E5.8F.B7.E5.8C.96">ZFSのネイティブ暗号化</a> を使うほうが良さそうです）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sgdisk     -n4:0:0        -t4:BF01 $DISK
</span></span></span></code></pre></div><p>なお、 <code>-t</code> オプションのコロンの後の値は <code>sgdisk -L</code> で一覧が確認できます。
上記で使っているものを抜粋します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">bf01 Solaris /usr &amp; Mac ZFS
</span></span><span class="line"><span class="cl">ef02 BIOS boot partition
</span></span></code></pre></div><p>EF02 は良いとして BF01 については下記の 83XX のほうが良さそうに思うのですが、よくわからないので今回は Wiki に従っておきました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">8200 Linux swap                          8300 Linux filesystem
</span></span><span class="line"><span class="cl">8301 Linux reserved                      8302 Linux /home
</span></span><span class="line"><span class="cl">8303 Linux x86 root (/)                  8304 Linux x86-64 root (/)
</span></span><span class="line"><span class="cl">8305 Linux ARM64 root (/)                8306 Linux /srv
</span></span><span class="line"><span class="cl">8307 Linux ARM32 root (/)                8308 Linux dm-crypt
</span></span><span class="line"><span class="cl">8309 Linux LUKS                          830a Linux IA-64 root (/)
</span></span><span class="line"><span class="cl">830b Linux x86 root verity               830c Linux x86-64 root verity
</span></span><span class="line"><span class="cl">830d Linux ARM32 root verity             830e Linux ARM64 root verity
</span></span><span class="line"><span class="cl">830f Linux IA-64 root verity             8310 Linux /var
</span></span><span class="line"><span class="cl">8311 Linux /var/tmp
</span></span></code></pre></div><p>（省略可）作成したパーティション一覧は <code>sgdisk -p ディスク名</code> で確認できます。以下に実行例を示します（一部情報を伏せてます）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> sgdisk -p <span class="nv">$DISK</span>
</span></span><span class="line"><span class="cl"><span class="go">Disk /dev/disk/by-id/ata-INTEL_SSDSA2M160G2GC_CVPO999999SN160AGN: 312581808 sectors, 149.0 GiB
</span></span></span><span class="line"><span class="cl"><span class="go">Sector size (logical/physical): 512/512 bytes
</span></span></span><span class="line"><span class="cl"><span class="go">Disk identifier (GUID): xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
</span></span></span><span class="line"><span class="cl"><span class="go">Partition table holds up to 128 entries
</span></span></span><span class="line"><span class="cl"><span class="go">Main partition table begins at sector 2 and ends at sector 33
</span></span></span><span class="line"><span class="cl"><span class="go">First usable sector is 34, last usable sector is 312581774
</span></span></span><span class="line"><span class="cl"><span class="go">Partitions will be aligned on 16-sector boundaries
</span></span></span><span class="line"><span class="cl"><span class="go">Total free space is 14 sectors (7.0 KiB)
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">Number  Start (sector)    End (sector)  Size       Code  Name
</span></span></span><span class="line"><span class="cl"><span class="go">   1              48            2047   1000.0 KiB  EF02
</span></span></span><span class="line"><span class="cl"><span class="go">   3            2048         2099199   1024.0 MiB  BF01
</span></span></span><span class="line"><span class="cl"><span class="go">   4         2099200       312581774   148.0 GiB   BF01
</span></span></span></code></pre></div><p>ブート (/boot) パーティション用の ZFS プール <code>bpool</code> を作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">zpool create -o ashift=12 -d \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@async_destroy=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@bookmarks=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@embedded_data=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@empty_bpobj=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@enabled_txg=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@extensible_dataset=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@filesystem_limits=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@hole_birth=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@large_blocks=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@lz4_compress=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@spacemap_histogram=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o feature@userobj_accounting=enabled \
</span></span></span><span class="line"><span class="cl"><span class="go">    -O acltype=posixacl -O canmount=off -O compression=lz4 -O devices=off \
</span></span></span><span class="line"><span class="cl"><span class="go">    -O normalization=formD -O relatime=on -O xattr=sa \
</span></span></span><span class="line"><span class="cl"><span class="go">    -O mountpoint=/ -R /mnt bpool ${DISK}-part3
</span></span></span></code></pre></div><p>試行錯誤して 2 回目以降のときは <code>zfs list</code> では空なのに上記の <code>zfs create</code> では以下のエラーが出ました。この場合はメッセージにあるように bpool の前あたりに <code>-f</code> を付ければ OK でした。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">invalid vdev specification
</span></span><span class="line"><span class="cl">use &#39;-f&#39; to override the following errors:
</span></span><span class="line"><span class="cl">/dev/disk/by-id/ata-INTEL_SSDSA2M160G2GC_CVPO999999SN160AGN-part3 is part of exported pool &#39;bpool&#39;
</span></span></code></pre></div><p><code>normalization=formD</code> は Unicode の normalization の NFD に相当します。
昔 Subversion で Windows は NFC, Mac OS X は NFD と違うせいで全角カナの濁点が分かれない、分かれるで苦労したので NFC にしようかと思いましたが、 formD でも Windows と mac から繋いで問題ないと聞いたので formD にしておきました。</p>
<p>他のオプションの説明は Wiki を参照してください。</p>
<p>ルート (/) パーティション用の ZFS プール <code>rpool</code> を作成します（こちらも 2 回目以降は <code>-f</code> を付けてください）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">zpool create -o ashift=12 \
</span></span></span><span class="line"><span class="cl"><span class="go">    -O acltype=posixacl -O canmount=off -O compression=lz4 \
</span></span></span><span class="line"><span class="cl"><span class="go">    -O dnodesize=auto -O normalization=formD -O relatime=on -O xattr=sa \
</span></span></span><span class="line"><span class="cl"><span class="go">    -O mountpoint=/ -R /mnt rpool ${DISK}-part4
</span></span></span></code></pre></div><p>オプションの説明は Wiki を参照してください。</p>
<p>（省略可）作成したプール一覧を確認しておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> zpool list
</span></span><span class="line"><span class="cl"><span class="go">NAME    SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
</span></span></span><span class="line"><span class="cl"><span class="go">bpool   960M   420K   960M        -         -     0%     0%  1.00x    ONLINE  /mnt
</span></span></span><span class="line"><span class="cl"><span class="go">rpool   148G   432K   148G        -         -     0%     0%  1.00x    ONLINE  /mnt
</span></span></span></code></pre></div><h2 id="step-3-システムのインストール">Step. 3: システムのインストール</h2>
<p><code>rpool/ROOT</code> と <code>bpool/BOOT</code> のデータセットを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">zfs create -o canmount=off -o mountpoint=none rpool/ROOT
</span></span></span><span class="line"><span class="cl"><span class="go">zfs create -o canmount=off -o mountpoint=none bpool/BOOT
</span></span></span></code></pre></div><p>ルート (/) とブート (/boot) ファイルシステム用のデータセットを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">zfs create -o canmount=noauto -o mountpoint=/ rpool/ROOT/ubuntu
</span></span></span><span class="line"><span class="cl"><span class="go">zfs mount rpool/ROOT/ubuntu
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">zfs create -o canmount=noauto -o mountpoint=/boot bpool/BOOT/ubuntu
</span></span></span><span class="line"><span class="cl"><span class="go">zfs mount bpool/BOOT/ubuntu
</span></span></span></code></pre></div><p>データセットを作成します。ここは各自のシステムの利用方法に応じて Wiki を参照しつつ調整してください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">zfs create                                 rpool/home
</span></span></span><span class="line"><span class="cl"><span class="go">zfs create -o mountpoint=/root             rpool/home/root
</span></span></span><span class="line"><span class="cl"><span class="go">zfs create -o canmount=off                 rpool/var
</span></span></span><span class="line"><span class="cl"><span class="go">zfs create -o canmount=off                 rpool/var/lib
</span></span></span><span class="line"><span class="cl"><span class="go">zfs create                                 rpool/var/log
</span></span></span><span class="line"><span class="cl"><span class="go">zfs create                                 rpool/var/spool
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">zfs create -o canmount=off                 rpool/usr
</span></span></span><span class="line"><span class="cl"><span class="go">zfs create                                 rpool/usr/local
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">zfs create                                 rpool/var/snap
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">zfs create -o com.sun:auto-snapshot=false  rpool/var/lib/docker
</span></span></span></code></pre></div><p><code>/var/cache</code> と <code>/var/tmp</code> を ZFS のスナップ対象から除外する場合に実行するコマンドも書かれていましたが、良く分からないのでとりあえず止めておきました。</p>
<p><code>/tmp</code> については後述の tmpfs を使う設定のほうがお勧めとのことなのでデータセットは作成しません。</p>
<p>以下のように <code>debootstrap</code> を実行して最小限のシステムをインストールします。
Wiki で第 1 引数は bionic でしたが、ここでは focal にします。
第 2 引数は、今はインストール先のディスクを <code>/mnt</code> にマウントした状態ですので、それを指定しています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">debootstrap focal /mnt
</span></span></span></code></pre></div><p>インターネットからパッケージをダウンロード、インストールするのでしばらく時間がかかります。</p>
<p>終わったら以下のコマンドを実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">zfs set devices=off rpool
</span></span></span></code></pre></div><h2 id="step-4-システム設定">Step. 4: システム設定</h2>
<p>設定したいお好みのホスト名を一旦 <code>HOSTNAME</code> 変数に設定します。以下は例です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">HOSTNAME=beagle
</span></span></span></code></pre></div><p>以下のコマンドで <code>/mnt/etc/hostname</code> にホスト名を保存します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">echo ${HOSTNAME} &gt; /mnt/etc/hostname
</span></span></span></code></pre></div><p>（省略可） 変更前の <code>/mnt/etc/hosts</code> を確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:~# cat /mnt/etc/hosts
</span></span></span><span class="line"><span class="cl"><span class="go">127.0.0.1       localhost
</span></span></span><span class="line"><span class="cl"><span class="go">::1             localhost ip6-localhost ip6-loopback
</span></span></span><span class="line"><span class="cl"><span class="go">ff02::1         ip6-allnodes
</span></span></span><span class="line"><span class="cl"><span class="go">ff02::2         ip6-allrouters
</span></span></span></code></pre></div><p>以下のコマンドで <code>/mnt/etc/hosts</code> にエントリを追加します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sed -i -e &#34;/^127.0.0.1/a\
</span></span></span><span class="line"><span class="cl"><span class="go">127.0.1.1       ${HOSTNAME}
</span></span></span><span class="line"><span class="cl"><span class="go">&#34; /mnt/etc/hosts
</span></span></span></code></pre></div><p>（省略可） 変更後の <code>/mnt/etc/hosts</code> を確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:~# cat /mnt/etc/hosts
</span></span></span><span class="line"><span class="cl"><span class="go">127.0.0.1       localhost
</span></span></span><span class="line"><span class="cl"><span class="go">127.0.1.1       beagle
</span></span></span><span class="line"><span class="cl"><span class="go">::1             localhost ip6-localhost ip6-loopback
</span></span></span><span class="line"><span class="cl"><span class="go">ff02::1         ip6-allnodes
</span></span></span><span class="line"><span class="cl"><span class="go">ff02::2         ip6-allrouters
</span></span></span></code></pre></div><p>netplan のネットワーク設定ファイル <code>/mnt/etc/netplan/01-netcfg.yaml</code> を作成します。以下は作成するコマンドの例です（IPv6 アドレスの一部は伏せてます）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cat &gt; /mnt/etc/netplan/01-netcfg.yaml &lt;&lt;&#39;EOF&#39;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> This file describes the network interfaces available on your system
</span></span><span class="line"><span class="cl"><span class="gp">#</span> For more information, see netplan<span class="o">(</span>5<span class="o">)</span>.
</span></span><span class="line"><span class="cl"><span class="go">network:
</span></span></span><span class="line"><span class="cl"><span class="go">  version: 2
</span></span></span><span class="line"><span class="cl"><span class="go">  renderer: networkd
</span></span></span><span class="line"><span class="cl"><span class="go">  ethernets:
</span></span></span><span class="line"><span class="cl"><span class="go">    enp3s0:
</span></span></span><span class="line"><span class="cl"><span class="go">      dhcp4: no
</span></span></span><span class="line"><span class="cl"><span class="go">      addresses: [192.168.2.5/24, &#34;xxxx:xxx:xxx:xxxx::5/60&#34;]
</span></span></span><span class="line"><span class="cl"><span class="go">      gateway4: 192.168.2.1
</span></span></span><span class="line"><span class="cl"><span class="go">      nameservers:
</span></span></span><span class="line"><span class="cl"><span class="go">        addresses: [192.168.1.1]
</span></span></span><span class="line"><span class="cl"><span class="go">      dhcp6: yes
</span></span></span><span class="line"><span class="cl"><span class="go">EOF
</span></span></span></code></pre></div><p>（省略可）変更前の <code>/mnt/etc/apt/sources.list</code> を確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:~# cat /mnt/etc/apt/sources.list
</span></span></span><span class="line"><span class="cl"><span class="go">deb http://archive.ubuntu.com/ubuntu focal main
</span></span></span></code></pre></div><p><code>/mnt/etc/apt/sources.list</code> を変更します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cat &gt; /mnt/etc/apt/sources.list &lt;&lt;&#39;EOF&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">deb http://jp.archive.ubuntu.com/ubuntu focal main universe
</span></span></span><span class="line"><span class="cl"><span class="go">deb-src http://jp.archive.ubuntu.com/ubuntu focal main universe
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">deb http://security.ubuntu.com/ubuntu focal-security main universe
</span></span></span><span class="line"><span class="cl"><span class="go">deb-src http://security.ubuntu.com/ubuntu focal-security main universe
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">deb http://jp.archive.ubuntu.com/ubuntu focal-updates main universe
</span></span></span><span class="line"><span class="cl"><span class="go">deb-src http://jp.archive.ubuntu.com/ubuntu focal-updates main universe
</span></span></span><span class="line"><span class="cl"><span class="go">EOF
</span></span></span></code></pre></div><p>Live CD 環境の仮想ファイルシステムをバインドマウントして、上記でセットアップした環境に chroot します（ <code>--bind</code> ではなく <code>--rbind</code> を使っていることに注意）。</p>
<pre tabindex="0"><code>mount --rbind /dev  /mnt/dev
mount --rbind /proc /mnt/proc
mount --rbind /sys  /mnt/sys
chroot /mnt /usr/bin/env DISK=$DISK bash --login
</code></pre><p>（省略可）Wiki ではここで
<code>ln -s /proc/self/mounts /etc/mtab</code>
を実行せよとありますが、以下のように既に同等のシンボリックリンクがありエラーになるのでスキップします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:/# ls -l /etc/mtab
</span></span></span><span class="line"><span class="cl"><span class="go">lrwxrwxrwx 1 root root 19 Apr 25 09:07 /etc/mtab -&gt; ../proc/self/mounts
</span></span></span></code></pre></div><p>以下のコマンドを実行して chroot 環境内の apt のインデクスを更新します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt update
</span></span></span></code></pre></div><p>この後のロケールとタイムゾーンの設定は <a href="https://blog.ls-al.com/category/zfs/">Ubuntu server 20.04 zfs root and OCI – Riaan&rsquo;s SysAdmin Blog</a> を参考にしつつ、変更した手順としています。</p>
<p>ロケールは <code>en_US.UTF-8</code> と <code>ja_JP.UTF-8</code> を作成し、デフォルトは <code>en_US.UTF-8</code> にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">locale-gen --purge en_US.UTF-8 ja_JP.UTF-8
</span></span></span><span class="line"><span class="cl"><span class="go">update-locale LANG=en_US.UTF-8 LANGUAGE=en_US
</span></span></span><span class="line"><span class="cl"><span class="go">dpkg-reconfigure --frontend noninteractive locales
</span></span></span></code></pre></div><p>タイムゾーンは <code>Asia/Tokyo</code> にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ln -sf /usr/share/zoneinfo/Asia/Tokyo /etc/localtime
</span></span></span><span class="line"><span class="cl"><span class="go">dpkg-reconfigure -f noninteractive tzdata
</span></span></span></code></pre></div><p>以下のように出力されれば OK です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Current default time zone: &#39;Asia/Tokyo&#39;
</span></span><span class="line"><span class="cl">Local time is now:      Sat Apr 25 20:25:44 JST 2020.
</span></span><span class="line"><span class="cl">Universal Time is now:  Sat Apr 25 11:25:44 UTC 2020.
</span></span></code></pre></div><p>Linux のカーネルイメージと ZFS を chroot 環境にインストールします（ HWE カーネルを使いたい場合は linux-image-generic の代わりに linux-image-generic-hwe-20.04 を指定します）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt install --yes --no-install-recommends linux-image-generic zfs-initramfs
</span></span></span></code></pre></div><p>上記のコマンド実行の出力の最後に以下のようなメッセージが出ました。
<code>update-initramfs</code> が <code>/boot/initrd.img-5.4.0-26-generic</code> を生成したというのが重要です。この後 grub のインストール時に必要になるためです。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">update-initramfs: Generating /boot/initrd.img-5.4.0-26-generic
</span></span><span class="line"><span class="cl">W: Possible missing firmware /lib/firmware/ast_dp501_fw.bin for module ast
</span></span></code></pre></div><p>試行錯誤中は作られないケースがあったのですが、その場合は
<code>update-initramfs -u -k all</code> か <code>update-initramfs -u -k $(uname -r)</code> を実行して作成します。</p>
<p>また <code>/lib/firmware/ast_dp501_fw.bin</code> というファームウェアがみつらかないという警告が出ていますが、これは無視して進みました。</p>
<p>GRUB をレガシー BIOS 用にインストールします。</p>
<p>Wiki の手順では <code>apt install --yes grub-pc</code> ですが、CUI のダイアログが開いてインストール先を選択する必要があり、今後自動化したいときに困るので、代わりにググって見つけた以下のコマンドを実行します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">DEBIAN_FRONTEND=noninteractive apt-get -y -o Dpkg::Options::=&#34;--force-confdef&#34; -o Dpkg::Options::=&#34;--force-confold&#34; install grub-pc
</span></span></span></code></pre></div><p>これだとインストール先を選べないのですが、 後述の手順で <code>/etc/default/grub</code> を変更した後 <code>grub-install $DISK</code> でインストールするので問題ありません。</p>
<p>root ユーザーのパスワードを設定します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">passwd
</span></span></span></code></pre></div><p>bpool を確実にインポートするためのサービスのユニットファイルを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cat &gt; /etc/systemd/system/zfs-import-bpool.service &lt;&lt;&#39;EOF&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">[Unit]
</span></span></span><span class="line"><span class="cl"><span class="go">DefaultDependencies=no
</span></span></span><span class="line"><span class="cl"><span class="go">Before=zfs-import-scan.service
</span></span></span><span class="line"><span class="cl"><span class="go">Before=zfs-import-cache.service
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[Service]
</span></span></span><span class="line"><span class="cl"><span class="go">Type=oneshot
</span></span></span><span class="line"><span class="cl"><span class="go">RemainAfterExit=yes
</span></span></span><span class="line"><span class="cl"><span class="go">ExecStart=/sbin/zpool import -N -o cachefile=none bpool
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[Install]
</span></span></span><span class="line"><span class="cl"><span class="go">WantedBy=zfs-import.target
</span></span></span><span class="line"><span class="cl"><span class="go">EOF
</span></span></span></code></pre></div><p>上で追加したサービスの自動起動を有効にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">systemctl enable zfs-import-bpool.service
</span></span></span></code></pre></div><p>実行すると以下のようにシンボリックリンクが作成されたというメッセージが出ました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:/# systemctl enable zfs-import-bpool.service
</span></span></span><span class="line"><span class="cl"><span class="go">Created symlink /etc/systemd/system/zfs-import.target.wants/zfs-import-bpool.service → /etc/systemd/system/zfs-import-bpool.service.
</span></span></span></code></pre></div><p>以下のコマンドで次回起動時に tmpfs を /tmp にマウントするようにします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">cp /usr/share/systemd/tmp.mount /etc/systemd/system/
</span></span></span><span class="line"><span class="cl"><span class="go">systemctl enable tmp.mount
</span></span></span></code></pre></div><p>lpadmin と sambashare のグループ作成はスキップしました。</p>
<h2 id="step-5-grub-のインストール">Step. 5: GRUB のインストール</h2>
<p><code>grub-probe /boot</code> で ZFS のブートファイルシステムが認識されていることを確認します。
以下のように zfs と出力されれば OK です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> grub-probe /boot
</span></span><span class="line"><span class="cl"><span class="go">zfs
</span></span></span></code></pre></div><p>（省略可）<code>cat /etc/default/grub</code> で変更前のファイルの内容を確認します。
私の環境では以下のようになっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:/# cat /etc/default/grub
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> If you change this file, run <span class="s1">&#39;update-grub&#39;</span> afterwards to update
</span></span><span class="line"><span class="cl"><span class="gp">#</span> /boot/grub/grub.cfg.
</span></span><span class="line"><span class="cl"><span class="gp">#</span> For full documentation of the options in this file, see:
</span></span><span class="line"><span class="cl"><span class="gp">#</span>   info -f grub -n <span class="s1">&#39;Simple configuration&#39;</span>
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">GRUB_DEFAULT=0
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_TIMEOUT_STYLE=hidden
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_TIMEOUT=0
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_DISTRIBUTOR=`lsb_release -i -s 2&gt; /dev/null || echo Debian`
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_CMDLINE_LINUX_DEFAULT=&#34;quiet splash&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_CMDLINE_LINUX=&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> Uncomment to <span class="nb">enable</span> BadRAM filtering, modify to suit your needs
</span></span><span class="line"><span class="cl"><span class="gp">#</span> This works with Linux <span class="o">(</span>no patch required<span class="o">)</span> and with any kernel that obtains
</span></span><span class="line"><span class="cl"><span class="gp">#</span> the memory map information from GRUB <span class="o">(</span>GNU Mach, kernel of FreeBSD ...<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_BADRAM</span><span class="o">=</span><span class="s2">&#34;0x01234567,0xfefefefe,0x89abcdef,0xefefefef&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> Uncomment to disable graphical terminal <span class="o">(</span>grub-pc only<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_TERMINAL</span><span class="o">=</span>console
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> The resolution used on graphical terminal
</span></span><span class="line"><span class="cl"><span class="gp">#</span> note that you can use only modes which your graphic card supports via VBE
</span></span><span class="line"><span class="cl"><span class="gp">#</span> you can see them in real GRUB with the <span class="nb">command</span> <span class="sb">`</span>vbeinfo<span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_GFXMODE</span><span class="o">=</span>640x480
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> Uncomment <span class="k">if</span> you don<span class="err">&#39;</span>t want GRUB to pass <span class="s2">&#34;root=UUID=xxx&#34;</span> parameter to Linux
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_DISABLE_LINUX_UUID</span><span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> Uncomment to disable generation of recovery mode menu entries
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_DISABLE_RECOVERY</span><span class="o">=</span><span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> Uncomment to get a beep at grub start
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_INIT_TUNE</span><span class="o">=</span><span class="s2">&#34;480 440 1&#34;</span>
</span></span></code></pre></div><p>以下のコマンドで <code>/etc/default/grub</code> を更新します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sed -i -e &#39;/^GRUB_TIMEOUT=/{s/=.*/=5/;a\
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_RECORDFAIL_TIMEOUT=5
</span></span></span><span class="line"><span class="cl"><span class="go">}
</span></span></span><span class="line"><span class="cl"><span class="go">/^GRUB_CMDLINE_LINUX_DEFAULT=/s/quiet splash//
</span></span></span><span class="line"><span class="cl"><span class="go">s|^GRUB_CMDLINE_LINUX=.*|GRUB_CMDLINE_LINUX=&#34;root=ZFS=rpool/ROOT/ubuntu&#34;|
</span></span></span><span class="line"><span class="cl"><span class="go">/^#GRUB_TERMINAL=console/s/#//
</span></span></span><span class="line"><span class="cl"><span class="go">&#39; /etc/default/grub
</span></span></span></code></pre></div><p>変更後の <code>/etc/default/grub</code> を確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:/# cat /etc/default/grub
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> If you change this file, run <span class="s1">&#39;update-grub&#39;</span> afterwards to update
</span></span><span class="line"><span class="cl"><span class="gp">#</span> /boot/grub/grub.cfg.
</span></span><span class="line"><span class="cl"><span class="gp">#</span> For full documentation of the options in this file, see:
</span></span><span class="line"><span class="cl"><span class="gp">#</span>   info -f grub -n <span class="s1">&#39;Simple configuration&#39;</span>
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">GRUB_DEFAULT=0
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_TIMEOUT_STYLE=hidden
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_TIMEOUT=5
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_RECORDFAIL_TIMEOUT=5
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_DISTRIBUTOR=`lsb_release -i -s 2&gt; /dev/null || echo Debian`
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_CMDLINE_LINUX_DEFAULT=&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">GRUB_CMDLINE_LINUX=&#34;root=ZFS=rpool/ROOT/ubuntu&#34;
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> Uncomment to <span class="nb">enable</span> BadRAM filtering, modify to suit your needs
</span></span><span class="line"><span class="cl"><span class="gp">#</span> This works with Linux <span class="o">(</span>no patch required<span class="o">)</span> and with any kernel that obtains
</span></span><span class="line"><span class="cl"><span class="gp">#</span> the memory map information from GRUB <span class="o">(</span>GNU Mach, kernel of FreeBSD ...<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_BADRAM</span><span class="o">=</span><span class="s2">&#34;0x01234567,0xfefefefe,0x89abcdef,0xefefefef&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> Uncomment to disable graphical terminal <span class="o">(</span>grub-pc only<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="go">GRUB_TERMINAL=console
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> The resolution used on graphical terminal
</span></span><span class="line"><span class="cl"><span class="gp">#</span> note that you can use only modes which your graphic card supports via VBE
</span></span><span class="line"><span class="cl"><span class="gp">#</span> you can see them in real GRUB with the <span class="nb">command</span> <span class="sb">`</span>vbeinfo<span class="err">&#39;</span>
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_GFXMODE</span><span class="o">=</span>640x480
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> Uncomment <span class="k">if</span> you don<span class="err">&#39;</span>t want GRUB to pass <span class="s2">&#34;root=UUID=xxx&#34;</span> parameter to Linux
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_DISABLE_LINUX_UUID</span><span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> Uncomment to disable generation of recovery mode menu entries
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_DISABLE_RECOVERY</span><span class="o">=</span><span class="s2">&#34;true&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="gp">#</span> Uncomment to get a beep at grub start
</span></span><span class="line"><span class="cl"><span class="gp">#</span><span class="nv">GRUB_INIT_TUNE</span><span class="o">=</span><span class="s2">&#34;480 440 1&#34;</span>
</span></span></code></pre></div><p>grub の設定変更を反映します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">update-grub
</span></span></span></code></pre></div><p>実行例を示します。 <code>Found linux image</code> と <code>Found initrd image</code> の行が出ていれば大丈夫です。
<code>/dev/sda1</code> でエラーが出ていますがこれは USB メモリなので大丈夫です。
osprober でも絵エラーが出ていますが Wiki に問題ないと書いてあるのでこれも OK です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:/# update-grub
</span></span></span><span class="line"><span class="cl"><span class="go">Sourcing file `/etc/default/grub&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">Sourcing file `/etc/default/grub.d/init-select.cfg&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">Generating grub configuration file ...
</span></span></span><span class="line"><span class="cl"><span class="go">Found linux image: vmlinuz-5.4.0-26-generic in rpool/ROOT/ubuntu
</span></span></span><span class="line"><span class="cl"><span class="go">Found initrd image: initrd.img-5.4.0-26-generic in rpool/ROOT/ubuntu
</span></span></span><span class="line"><span class="cl"><span class="go">grub-probe: error: cannot find a GRUB drive for /dev/sda1.  Check your device.map.
</span></span></span><span class="line"><span class="cl"><span class="go">device-mapper: reload ioctl on osprober-linux-sdb4  failed: Device or resource busy
</span></span></span><span class="line"><span class="cl"><span class="go">Command failed.
</span></span></span><span class="line"><span class="cl"><span class="go">done
</span></span></span></code></pre></div><p>レガシー BIOS 用に GRUB をインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">grub-install $DISK
</span></span></span></code></pre></div><p>実行例を示します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:/# grub-install $DISK
</span></span></span><span class="line"><span class="cl"><span class="go">Installing for i386-pc platform.
</span></span></span><span class="line"><span class="cl"><span class="go">Installation finished. No error reported.
</span></span></span></code></pre></div><p>ZFS のモジュールがインストールされていることを確認。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ls /boot/grub/*/zfs.mod
</span></span></span></code></pre></div><p>私の環境では以下のようになりました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@ubuntu:/# ls /boot/grub/*/zfs.mod
</span></span></span><span class="line"><span class="cl"><span class="go">/boot/grub/i386-pc/zfs.mod
</span></span></span></code></pre></div><p>Wiki では <code>5.8 Fix filesystem mount ordering</code> でブート (/boot) パーティション用の ZFS のプール bpool をマウントするための手順があるのですが、これは実行しなくても動いたのでスキップします。</p>
<h2 id="step-6-初回のブート">Step. 6: 初回のブート</h2>
<p>初回インストールのスナップショットを作成しておきます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">zfs snapshot bpool/BOOT/ubuntu@install
</span></span></span><span class="line"><span class="cl"><span class="go">zfs snapshot rpool/ROOT/ubuntu@install
</span></span></span></code></pre></div><p>chroot 環境から抜けて Live CD 環境に戻ります。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">exit
</span></span></span></code></pre></div><p>Live CD 環境でマウント中のファイルシステムを全てアンマウントします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mount | grep -v zfs | tac | awk &#39;/\/mnt/ {print $3}&#39; | xargs -i{} umount -lf {}
</span></span></span><span class="line"><span class="cl"><span class="go">zpool export -a
</span></span></span></code></pre></div><p>リブートします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">systemctl reboot
</span></span></span></code></pre></div><p>上記の起動時にコンソールに以下のエラーが出るパターンがあった。
<code>update-initramfs -u -k all</code> も <code>update-initramfs -u -k $(uname -r)</code> も行わず、fstabの追加を一切しなかった回。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">[FAILED] Failed to start GRUB failed boot detection.
</span></span></span><span class="line"><span class="cl"><span class="go">See &#39;systemctl status grub-initrd-fallback.service&#39; for details.
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> systemctl status grub-initrd-fallback.service
</span></span><span class="line"><span class="cl"><span class="go">● grub-initrd-fallback.service - GRUB failed boot detection
</span></span></span><span class="line"><span class="cl"><span class="go">     Loaded: loaded (/lib/systemd/system/grub-initrd-fallback.service; enabled; vendor preset: enabled)
</span></span></span><span class="line"><span class="cl"><span class="go">     Active: failed (Result: exit-code) since Mon 2020-04-27 13:05:00 JST; 35min ago
</span></span></span><span class="line"><span class="cl"><span class="go">   Main PID: 1018 (code=exited, status=1/FAILURE)
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">Apr 27 13:05:00 beagle systemd[1]: Starting GRUB failed boot detection...
</span></span></span><span class="line"><span class="cl"><span class="go">Apr 27 13:05:00 beagle grub-editenv[1018]: /usr/bin/grub-editenv: error: cannot open `/boot/grub/grubenv.new&#39;: No such file or directory.
</span></span></span><span class="line"><span class="cl"><span class="go">Apr 27 13:05:00 beagle systemd[1]: grub-initrd-fallback.service: Main process exited, code=exited, status=1/FAILURE
</span></span></span><span class="line"><span class="cl"><span class="go">Apr 27 13:05:00 beagle systemd[1]: grub-initrd-fallback.service: Failed with result &#39;exit-code&#39;.
</span></span></span><span class="line"><span class="cl"><span class="go">Apr 27 13:05:00 beagle systemd[1]: Failed to start GRUB failed boot detection.
</span></span></span></code></pre></div><p>次回は <code>/boot/grub/grubenv.new</code> というファイルが作られているか確認すること。</p>
<p><code>/usr/lib/systemd/system/grub-initrd-fallback.service</code> の内容。</p>
<pre tabindex="0"><code>[Unit]
Description=GRUB failed boot detection
After=local-fs.target

[Service]
Type=oneshot
ExecStart=/usr/bin/grub-editenv /boot/grub/grubenv unset initrdfail
ExecStart=/usr/bin/grub-editenv /boot/grub/grubenv unset prev_entry
TimeoutSec=0

[Install]
WantedBy=multi-user.target rescue.target emergency.target
</code></pre><p>起動したらサーバーのコンソールで root ユーザーで上記で設定したパスワードを入力してログインします。</p>
<p>ログインしたら、自分用のユーザーを作成します。まずユーザー名を一旦変数にセットします。以下は例です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">YOURUSERNAME=hnakamur
</span></span></span></code></pre></div><p>ユーザーを作成します（私は <code>adduser</code> より <code>useradd</code> のほうがプロンプト出たりしないので好きです）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">useradd -m -s /bin/bash $YOURUSERNAME
</span></span></span></code></pre></div><p>作成したユーザーのパスワードを設定します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">passwd $YOURUSERNAME
</span></span></span></code></pre></div><p>作成したユーザーを adm と sudo グループに所属させます（Wikiではほかのグループも追加していましたが自分が使うものに限定しました）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">usermod -a -G adm,sudo $YOURUSERNAME
</span></span></span></code></pre></div><p>OpenSSH サーバーをインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt install --yes openssh-server
</span></span></span></code></pre></div><p>ここでサーバーとは別の作業用マシンで <code>~/.ssh/config</code> にこのサーバーのエントリを追加します。以下は例です。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">Host beagle
</span></span></span><span class="line"><span class="cl"><span class="go">  Hostname 192.168.2.5
</span></span></span></code></pre></div><p>作業マシンからこのあと何度かサーバーに接続するので、ホスト名を変数に設定しておきます。以下は例ですので適宜変更してください。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">SERVER=beagle
</span></span></span></code></pre></div><p>次に以下のコマンドを実行して ssh の公開鍵を転送します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ssh-copy-id $SERVER
</span></span></span></code></pre></div><p>この状態で以下のコマンドを実行しパスワード無しで鍵認証でログイン出来ることを確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ssh $SERVER
</span></span></span></code></pre></div><p>この端末は抜けずに維持しておきます（この後 ssh サーバーの設定変更を失敗したときも作業継続できるように保険として。この手順はコンソールにアクセスできる前提なのでそこまで気にしなくても良いですが）。</p>
<p>ssh サーバーの設定を変更し、パスワード入力を無効にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo sed -i -e &#39;/^#PasswordAuthentication yes/a\
</span></span></span><span class="line"><span class="cl"><span class="go">PasswordAuthentication no
</span></span></span><span class="line"><span class="cl"><span class="go">/^UsePAM yes/{s/^/#/;a\
</span></span></span><span class="line"><span class="cl"><span class="go">UsePAM no
</span></span></span><span class="line"><span class="cl"><span class="go">}
</span></span></span><span class="line"><span class="cl"><span class="go">/^X11Forwarding yes/{s/^/#/;a\
</span></span></span><span class="line"><span class="cl"><span class="go">X11Forwarding no
</span></span></span><span class="line"><span class="cl"><span class="go">}
</span></span></span><span class="line"><span class="cl"><span class="go">&#39; /etc/ssh/sshd_config
</span></span></span></code></pre></div><p>上記の設定変更を反映します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">systemctl reload sshd
</span></span></span></code></pre></div><p>別の作業マシンから鍵認証で ssh 出来ることを確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ssh $SERVER
</span></span></span></code></pre></div><p>こちらはログアウトして、次は以下のようにパスワード認証を優先にしてログインできないことを確認します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> ssh -o <span class="nv">PreferredAuthentications</span><span class="o">=</span>password <span class="nv">$SERVER</span>
</span></span><span class="line"><span class="cl"><span class="go">hnakamur@192.168.2.5: Permission denied (publickey).
</span></span></span></code></pre></div><p>最初に ssh で接続していた端末に戻って root ユーザーに切り替えます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo -i
</span></span></span></code></pre></div><p>&ldquo;6.8 Mirror GRUB&rdquo; は私は単一のディスクにしかインストールしていないのでスキップしました。</p>
<h2 id="step-7-スワップを設定します">Step. 7: スワップを設定します。</h2>
<p><a href="https://twitter.com/hnakamur2/status/1228885297917620226">物理メモリが十分にあってもスワップは重要</a> ですので、スワップは必ず設定します。</p>
<p>容量は適宜変更してください。ここではサーバーの RAM と同じ 16GB にしてみました。</p>
<p>まずスワップ用のデータセットを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">zfs create -V 16G -b $(getconf PAGESIZE) -o compression=zle \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o logbias=throughput -o sync=always \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o primarycache=metadata -o secondarycache=none \
</span></span></span><span class="line"><span class="cl"><span class="go">    -o com.sun:auto-snapshot=false rpool/swap
</span></span></span></code></pre></div><p>次にスワップの設定を行います。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">mkswap -f /dev/zvol/rpool/swap
</span></span></span><span class="line"><span class="cl"><span class="go">echo /dev/zvol/rpool/swap none swap discard 0 0 &gt;&gt; /etc/fstab
</span></span></span><span class="line"><span class="cl"><span class="go">echo RESUME=none &gt; /etc/initramfs-tools/conf.d/resume
</span></span></span></code></pre></div><p>以下のコマンドでスワップを有効にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">swapon -av
</span></span></span></code></pre></div><p><code>swapon --show</code> コマンドで有効になったことを確認します。以下は実行例です。</p>
<pre tabindex="0"><code>$ swapon --show
NAME     TYPE      SIZE USED PRIO
/dev/zd0 partition  16G   0B   -2
</code></pre><h2 id="step-8-フルのソフトウェアインストール">Step. 8: フルのソフトウェアインストール</h2>
<p>ミニマムインストールをアップグレードします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt dist-upgrade --yes
</span></span></span></code></pre></div><p>今回はコマンドライン環境のみをインストールするので以下を実行します（ GUI 環境をインストールする場合は Wiki 参照）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt install --yes ubuntu-standard
</span></span></span></code></pre></div><p>（省略可）ログの圧縮を無効化します。 ZFS で圧縮する設定にしたので、ログのローテートのほうでは圧縮しないことにする場合は以下のコマンドを実行して無効にします。</p>
<p>が、後で他のサーバーに転送したりする場合は無効にしないほうが良いかもしれません。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">for file in /etc/logrotate.d/* ; do
</span></span></span><span class="line"><span class="cl"><span class="go">    if grep -Eq &#34;(^|[^#y])compress&#34; &#34;$file&#34; ; then
</span></span></span><span class="line"><span class="cl"><span class="go">        sed -i -r &#34;s/(^|[^#y])(compress)/\1#\2/&#34; &#34;$file&#34;
</span></span></span><span class="line"><span class="cl"><span class="go">    fi
</span></span></span><span class="line"><span class="cl"><span class="go">done
</span></span></span></code></pre></div><p>リブートします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">systemctl reboot
</span></span></span></code></pre></div><h2 id="step-9-最終クリーンアップ">Step. 9: 最終クリーンアップ</h2>
<p>再起動が正常に出来ることを確認し、上記で作成した自分用のユーザーでログインできることを確認します。</p>
<p>（省略可）上記で作成したスナップショットを削除します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo zfs destroy bpool/BOOT/ubuntu@install
</span></span></span><span class="line"><span class="cl"><span class="go">sudo zfs destroy rpool/ROOT/ubuntu@install
</span></span></span></code></pre></div><p>（省略可）上記で設定した root ユーザーのパスワードを削除します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">sudo usermod -p &#39;*&#39; root
</span></span></span></code></pre></div><p>root ユーザーのパスワードを削除した場合は root 権限で作業するときは自分のユーザーから sudo つきでコマンドを実行するか、 <code>sudo -i</code> で root ユーザーに切り替えます。</p>
<h2 id="上記手順外で気になること">上記手順外で気になること</h2>
<h3 id="zfs-mount-generator">zfs-mount-generator</h3>
<p>Wiki の手順では後の &ldquo;5.8 Fix filesystem mount ordering&rdquo; でブート (/boot) パーティション用の ZFS のプール bpool をマウントするための作業が入るのですが、これは ZFS の systemd mount generator が出来るまではという但し書きがあります。</p>
<p><a href="https://www.reddit.com/r/zfs/comments/8lf9d1/zfsonlinux_new_feature_systemd_mount_integration/">zfsonlinux new feature: systemd mount integration : zfs</a>
で紹介されているように zfs-mount-generator というのが今はあるので、これも一度試してみました。</p>
<p>zfs-import-bpool.service も含めて上記の手順を実行した後に zfs-mount-generator をセットアップし、その後 zfs-import-bpool.service を削除するという手順はうまく行きました。</p>
<p>しかし、一からの環境構築で zfs-import-bpool.service の手順をスキップして代わりにzfs-mount-generator をセットアップするのを試行錯誤したのですが、リブート後に <code>zpool list</code> や <code>zfs list</code> で rpool のみ見えて bpool が見えないようになってしまいました。</p>
<p>zfs-import-bpool.service を作るのであれば zfs-mount-generator はなくても上記の手順で問題なく動いているようなので、 zfs-mount-generator はとりあえず使わないことにします。</p>
<p>手順の一部をメモしておきます。</p>
<p>zfs-mount-generator の一次情報としては <a href="https://manpages.ubuntu.com/manpages/focal/en/man8/zfs-mount-generator.8.html">zfs-mount-generator (8)</a> を参照してください。</p>
<p>ただ、 chroot 環境で zfs のセットアップを行っている関係で手順を変更する必要がありました。</p>
<p><code>/etc/zfs/zfs-list.cache</code> ディレクトリを作成し、その下に 2 つのプール名 bpool, rpool に対応した空のファイルを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> mkdir /etc/zfs/zfs-list.cache
</span></span><span class="line"><span class="cl"><span class="gp">#</span> touch /etc/zfs/zfs-list.cache/<span class="o">{</span>b,r<span class="o">}</span>pool
</span></span></code></pre></div><p>次で利用する <code>/usr/lib/zfs-linux/zed.d/history_event-zfs-list-cacher.sh</code> が含まれる zfs-zed パッケージをインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">apt install --yes zfs-zed
</span></span></span></code></pre></div><p>次に manpage に書かれたようにシンボリックリンクを作成します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">ln -s /usr/lib/zfs-linux/zed.d/history_event-zfs-list-cacher.sh /etc/zfs/zed.d/
</span></span></span></code></pre></div><p>zfs-zed サービスの自動起動を有効にし、再起動します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">systemctl enable zfs-zed.service
</span></span></span><span class="line"><span class="cl"><span class="go">systemctl restart zfs-zed.service
</span></span></span></code></pre></div><p>manpage によると <code>/etc/zfs/zfs-list.cache/</code> 以下のファイルを更新するのに以下のコマンドを使うとのことなので、手動で実行してみます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> zfs list -H -o name,mountpoint,canmount,atime,relatime,devices,exec,readonly,setuid,nbmand,encroot,keylocation
</span></span><span class="line"><span class="cl"><span class="go">rpool   /       off     on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/ROOT      none    off     on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/ROOT/ubuntu       /       noauto  on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/home      /home   on      on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/home/hnakamur     /home/hnakamur  on      on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/home/root /root   on      on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/swap      -       -       -       -       -       -       off     -       -       -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/usr       /usr    off     on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/usr/local /usr/local      on      on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var       /var    off     on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var/lib   /var/lib        off     on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var/lib/docker    /var/lib/docker on      on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var/log   legacy  on      on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var/snap  /var/snap       on      on      on      off     on      off     on      off     -       none
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var/spool legacy  on      on      on      off     on      off     on      off     -       none
</span></span></span></code></pre></div><p>manpage によると 1 つのプールにつき、どれか 1 つのデータセットについて <code>canmount</code> を同じ値で良いので設定すれば <code>/etc/zfs/zfs-list.cache/</code> 以下のファイルを更新されるとのことです。</p>
<p>上記だと項目が多すぎてわかりにくいので name と canmount のみの一覧を出してみます。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> zfs list -H -o name,canmount
</span></span><span class="line"><span class="cl"><span class="go">bpool   off
</span></span></span><span class="line"><span class="cl"><span class="go">bpool/BOOT      off
</span></span></span><span class="line"><span class="cl"><span class="go">bpool/BOOT/ubuntu       noauto
</span></span></span><span class="line"><span class="cl"><span class="go">rpool   off
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/ROOT      off
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/ROOT/ubuntu       noauto
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/home      on
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/home/hnakamur     on
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/home/root on
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/swap      -
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/usr       off
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/usr/local on
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var       off
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var/lib   off
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var/lib/docker    on
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var/log   on
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var/snap  on
</span></span></span><span class="line"><span class="cl"><span class="go">rpool/var/spool on
</span></span></span></code></pre></div><p>以下のように bpool と rpool 内のそれぞれ 1 つのデータセットの canmount の値を同じ値で設定してみました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">zfs set canmount=off bpool/BOOT
</span></span></span><span class="line"><span class="cl"><span class="go">zfs set canmount=on rpool/home
</span></span></span></code></pre></div><p><code>ls -l /etc/zfs/zfs-list.cache/</code> を実行すると bpool と rpool のファイルが空でなくなっていました。</p>
<h3 id="シャットダウン時に一部アンマウント失敗のエラーが出る">シャットダウン時に一部アンマウント失敗のエラーが出る</h3>
<p>全てではないのですが一部のデータセットはシャットダウン時にアンマウント失敗のエラーがコンソールに出ています。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">[FAILED] Failed unmounting /home.
</span></span><span class="line"><span class="cl">[FAILED] Failed unmounting /root.
</span></span><span class="line"><span class="cl">[FAILED] Failed unmounting Temporary Directory (/tmp).
</span></span></code></pre></div><p>ところで、ブート時とシャットダウン時の <code>[  OK  ]</code> や <code>[FAILED]</code> のログは後からファイルやコマンドで見れないのでしょうか。 <code>[    0.000000]</code> のような起動開始からの秒数が入った行は <code>dmesg</code> で見れるのですが、 <code>[  OK  ]</code> や <code>[FAILED]</code> のログは含まれていないようです。</p>
<p>仕方ないのでスマホで動画撮影して PC にコピーしてました。上記はそれを見ながら書き起こしたものです。</p>
<p><a href="https://github.com/systemd/systemd/issues/867#issuecomment-421655744">https://github.com/systemd/systemd/issues/867#issuecomment-421655744</a>
などで <code>LazyUnmount=yes</code> を使えば良いというコメントがありました。</p>
<p>zfs-mount-generator を導入したときは以下のようなファイルが生成されていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">#</span> ls -l /run/systemd/generator/
</span></span><span class="line"><span class="cl"><span class="go">total 28
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 233 Apr 26 14:24 dev-zvol-rpool-swap.swap
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 358 Apr 26 14:24 home-hnakamur.mount
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 340 Apr 26 14:24 home.mount
</span></span></span><span class="line"><span class="cl"><span class="go">drwxr-xr-x 2 root root 180 Apr 26 14:24 local-fs.target.wants
</span></span></span><span class="line"><span class="cl"><span class="go">drwxr-xr-x 2 root root  60 Apr 26 14:24 multi-user.target.wants
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root   0 Apr 26 14:24 netplan.stamp
</span></span></span><span class="line"><span class="cl"><span class="go">drwxr-xr-x 2 root root  60 Apr 26 14:24 network-online.target.wants
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 345 Apr 26 14:24 root.mount
</span></span></span><span class="line"><span class="cl"><span class="go">drwxr-xr-x 2 root root  60 Apr 26 14:24 swap.target.requires
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 350 Apr 26 14:24 usr-local.mount
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 360 Apr 26 14:24 var-lib-docker.mount
</span></span></span><span class="line"><span class="cl"><span class="go">-rw-r--r-- 1 root root 348 Apr 26 14:24 var-snap.mount
</span></span></span></code></pre></div><p>2 つ中身を見てみると以下のような感じでした。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@beagle:~# cat /run/systemd/generator/usr-local.mount
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> Automatically generated by zfs-mount-generator
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[Unit]
</span></span></span><span class="line"><span class="cl"><span class="go">SourcePath=/etc/zfs/zfs-list.cache/rpool
</span></span></span><span class="line"><span class="cl"><span class="go">Documentation=man:zfs-mount-generator(8)
</span></span></span><span class="line"><span class="cl"><span class="go">Before=local-fs.target zfs-mount.service
</span></span></span><span class="line"><span class="cl"><span class="go">After=zfs-import.target
</span></span></span><span class="line"><span class="cl"><span class="go">Wants=zfs-import.target
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[Mount]
</span></span></span><span class="line"><span class="cl"><span class="go">Where=/usr/local
</span></span></span><span class="line"><span class="cl"><span class="go">What=rpool/usr/local
</span></span></span><span class="line"><span class="cl"><span class="go">Type=zfs
</span></span></span><span class="line"><span class="cl"><span class="go">Options=defaults,atime,relatime,nodev,exec,rw,suid,nomand,zfsutil
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">root@beagle:~# cat /run/systemd/generator/home.mount
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="gp">#</span> Automatically generated by zfs-mount-generator
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[Unit]
</span></span></span><span class="line"><span class="cl"><span class="go">SourcePath=/etc/zfs/zfs-list.cache/rpool
</span></span></span><span class="line"><span class="cl"><span class="go">Documentation=man:zfs-mount-generator(8)
</span></span></span><span class="line"><span class="cl"><span class="go">Before=local-fs.target zfs-mount.service
</span></span></span><span class="line"><span class="cl"><span class="go">After=zfs-import.target
</span></span></span><span class="line"><span class="cl"><span class="go">Wants=zfs-import.target
</span></span></span><span class="line"><span class="cl"><span class="go"></span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">[Mount]
</span></span></span><span class="line"><span class="cl"><span class="go">Where=/home
</span></span></span><span class="line"><span class="cl"><span class="go">What=rpool/home
</span></span></span><span class="line"><span class="cl"><span class="go">Type=zfs
</span></span></span><span class="line"><span class="cl"><span class="go">Options=defaults,atime,relatime,nodev,exec,rw,suid,nomand,zfsutil
</span></span></span></code></pre></div><p>そこで以下のようにファイルを作って、何回か再起動を試してみたのですが、上記のシャットダウン時のエラーは出なくなったり出たりで良く分からない状態でした。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="go">for m in $(cd /run/systemd/generator; ls *.mount); do
</span></span></span><span class="line"><span class="cl"><span class="go">  mkdir -p /etc/systemd/system/${m}.d
</span></span></span><span class="line"><span class="cl"><span class="go">  cat &gt; /etc/systemd/system/${m}.d/override.conf &lt;&lt;&#39;EOF&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">[Unit]
</span></span></span><span class="line"><span class="cl"><span class="go">LazyUnmount=yes
</span></span></span><span class="line"><span class="cl"><span class="go">EOF
</span></span></span><span class="line"><span class="cl"><span class="go">done
</span></span></span></code></pre></div><p>とりあえず実害はなさそうなので、上記の FAILED は一旦諦めることにしました。</p>
<h2 id="おわりに">おわりに</h2>
<p>上記のように気になる点は残るものの、ブートパーティションとルートパーティションを ZFS にして Ubuntu 20.04 LTS をセットアップして動くようにはなりました。</p>
<p>まだ experimental なので壊れても大丈夫なサーバーに限定しておくほうが良いとは思いますが、使ってみたいと思います。</p>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>
  </body>
</html>
