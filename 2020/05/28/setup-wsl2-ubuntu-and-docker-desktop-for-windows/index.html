<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.64.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>WSL2のUbuntuとDocker Desktop for Windowsを試してみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2020. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>WSL2のUbuntuとDocker Desktop for Windowsを試してみた</h1>
  <time datetime=2020-05-28T19:46:07&#43;0900 class="post-date">2020-05-28</time>
  <h2 id="docker-desktop-for-windows-を使わない方法もあります-2020-05-31-追記">Docker Desktop for Windows を使わない方法もあります （2020-05-31 追記）</h2>
<p><a href="/blog/2020/05/30/run-systemd-snapd-and-lxd-on-wsl2-ubuntu/">WSL2のUbuntuでsystemdとsnapdとLXDを動かしてみた · hnakamur&rsquo;s blog</a> の手順で systemd を動かして、あとは WSL2 の Ubuntu 内で docker を動かすという方法もあります。</p>
<p>上記の記事の「Docker Desktop for Windows をアンインストールして docker を動かしてみた」の項に手順を書いています。</p>
<p>私は Docker Desktop for Windows を入れていたのでアンインストールの手順が必要でしたが、最初から入れない場合はその手順を飛ばせば大丈夫だと思います。</p>
<h2 id="はじめに">はじめに</h2>
<p><a href="https://forest.watch.impress.co.jp/docs/news/1255259.html">「Windows 10 May 2020 Update」が一般公開 ～年2回の大規模アップデート - 窓の杜</a> ということで <a href="https://qiita.com/zembutsu/items/22a5cae1d13df0d04e7b">WSL 2 対応 Docker Desktop for Windowsを使うための手順 - Qiita</a> の記事を参考に WSL2 の Ubuntu と Docker Desktop for Windows を試してみました。いつもわかりやすい記事をありがとうございます！</p>
<p>自分用に手順と調査メモを書いておきます。</p>
<h2 id="wsl2-の構築手順メモ">WSL2 の構築手順メモ</h2>
<h3 id="windows-10-may-2020-update-の適用">Windows 10 May 2020 Update の適用</h3>
<p>更新対象が 2 台以上だったのでダウンロードを1回で済ませたいと思い、 <a href="https://www.microsoft.com/ja-jp/software-download/windows10">Windows 10 のダウンロード</a> でメディア作成ツールをダウンロードし、そこから Windows の ISO イメージをダウンロードしました。</p>
<p>DVD-R に焼いたりしなくてもエクスプローラーで ISO イメージを選んでポップアップメニューからマウントし setup.exe を実行すると更新することが出来ました。</p>
<p>更新の途中は何度か再起動するので、これがうまく行ったということは再起動の前に必要なファイルをマウントした ISO イメージから内蔵 SSD にコピーしているのだと推測します。</p>
<h3 id="windows-subsystem-for-linux-2-wsl2-のインストール">Windows Subsystem for Linux 2 (WSL2) のインストール</h3>
<p><a href="https://docs.microsoft.com/ja-jp/windows/wsl/install-win10">Windows Subsystem for Linux (WSL) を Windows 10 にインストールする | Microsoft Docs</a> の手順に沿ってインストールします。</p>
<h4 id="dsimexe-で-windows-の特定の機能が有効か確認する手順">dsim.exe で Windows の特定の機能が有効か確認する手順</h4>
<p><a href="https://superuser.com/questions/700991/how-to-check-if-windows-feature-is-installed-and-enabled-with-dism-exe">How to check if Windows Feature is installed and enabled with DISM.exe? - Super User</a> で知りました。
公式ドキュメントは <a href="https://docs.microsoft.com/en-us/windows-hardware/manufacture/desktop/enable-or-disable-windows-features-using-dism#to-find-available-windows-features-in-an-image">To find available Windows features in an image</a> です。</p>
<p>機能一覧表示。</p>
<pre><code class="language-console" data-lang="console">dism /online /get-features
</code></pre><p>実行例の抜粋です。</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">PS C:\WINDOWS\system32&gt; dism /online /get-features
展開イメージのサービスと管理ツール
バージョン: 10.0.19041.1
イメージのバージョン: 10.0.19041.264
パッケージの機能の一覧 : Microsoft-Windows-Foundation-Package~31bf3856ad364e35~amd64~~10.0.19041.1
…(略)…
機能名 : Microsoft-Windows-Subsystem-Linux
状態 : 有効
機能名 : HypervisorPlatform
状態 : 無効
機能名 : VirtualMachinePlatform
状態 : 有効
…(略)…
</code></pre></div><p>単一の機能の状態・情報表示（下記の XXXXX を適宜置き換えて実行）。</p>
<pre><code class="language-console" data-lang="console">dism /online /get-featureinfo /featurename:XXXXX
</code></pre><p>実行例。</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">PS C:\WINDOWS\system32&gt; dism /online /get-featureinfo /featurename:Microsoft-Windows-Subsystem-Linux
展開イメージのサービスと管理ツール
バージョン: 10.0.19041.1
イメージのバージョン: 10.0.19041.264
機能情報:
機能名 : Microsoft-Windows-Subsystem-Linux
表示名 : Linux 用 Windows サブシステム
説明 : ネイティブなユーザー モードの Linux シェルおよびツールを Windows で実行するためのサービスと環境を提供します。
再起動が必要 : Possible
状態 : 有効
カスタム プロパティ:
ServerComponent\Description : ネイティブなユーザー モードの Linux シェルおよびツールを Windows で実行するためのサービス と環境を提供します。
ServerComponent\DisplayName : Linux 用 Windows サブシステム
ServerComponent\Id : 1033
ServerComponent\Type : Feature
ServerComponent\UniqueName : Microsoft-Windows-Subsystem-Linux
ServerComponent\Deploys\Update\Name : Microsoft-Windows-Subsystem-Linux
操作は正常に完了しました。
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">PS C:\WINDOWS\system32&gt; dism /online /get-featureinfo /featurename:VirtualMachinePlatform
展開イメージのサービスと管理ツール
バージョン: 10.0.19041.1
イメージのバージョン: 10.0.19041.264
機能情報:
機能名 : VirtualMachinePlatform
表示名 : 仮想マシン プラットフォーム
説明 : 仮想マシンのプラットフォーム サポートを有効にします
再起動が必要 : Possible
状態 : 有効
カスタム プロパティ:
(カスタム プロパティが見つかりません)
操作は正常に完了しました。
</code></pre></div><h4 id="windows-subsystem-for-linux-のインストール">Windows Subsystem for Linux のインストール</h4>
<p>管理者権限で PowerShell を開いて以下のコマンドを実行します。</p>
<pre><code class="language-console" data-lang="console">dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
</code></pre><p>実行例を示します。実行前に Microsoft-Windows-Subsystem-Linux の機能が有効でも下記のようにバージョンが上がることがあるので、上記のコマンドは省略せず実行が必要なようです。</p>
<p>前項の状態確認手順の出力でも「バージョン」と「イメージのバージョン」が出ているので違う場合は実行するようにすれば良さそうです。</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">PS C:\WINDOWS\system32&gt; dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
展開イメージのサービスと管理ツール
バージョン: 10.0.19041.1
イメージのバージョン: 10.0.19041.264
機能を有効にしています
[==========================100.0%==========================]
操作は正常に完了しました
</code></pre></div><p>実行後 Windows を再起動するよう書いてありますが、私は次項も実行してから再起動しました。</p>
<h4 id="仮想マシン-プラットフォーム-のオプション-コンポーネントを有効にする">&ldquo;仮想マシン プラットフォーム&rdquo; のオプション コンポーネントを有効にする</h4>
<p>管理者権限で PowerShell を開いて以下のコマンドを実行します。</p>
<pre><code class="language-console" data-lang="console">dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
</code></pre><p>実行例です。</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">PS C:\WINDOWS\system32&gt; dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
展開イメージのサービスと管理ツール
バージョン: 10.0.19041.1
イメージのバージョン: 10.0.19041.264
機能を有効にしています
[==========================100.0%==========================]
操作は正常に完了しました。
</code></pre></div><p>実行後 Windows を再起動します。</p>
<h4 id="wsl-2-を既定のバージョンとして設定する">WSL 2 を既定のバージョンとして設定する</h4>
<p>PowerShell を起動して以下のコマンドを実行します。</p>
<pre><code class="language-console" data-lang="console">wsl --set-default-version 2
</code></pre><p><code>wsl -h</code> を見る限りは設定された既定のバージョンを確認するオプションは <code>wsl.exe</code> には無いようです。</p>
<p>私の環境では実行すると以下のようなメッセージが出力されました。</p>
<div class="highlight"><pre class="chroma"><code class="language-txt" data-lang="txt">PS C:\Users\hnakamur&gt; wsl --set-default-version 2
WSL 2 を実行するには、カーネル コンポーネントの更新が必要です。詳細については https://aka.ms/wsl2kernel を参照してください
</code></pre></div><p>このように表示されたときは上記のリンクから <a href="https://docs.microsoft.com/ja-jp/windows/wsl/wsl2-kernel">WSL 2 Linux カーネルの更新 | Microsoft Docs</a> を開き、Linux カーネル更新プログラム パッケージ（ファイル名： <code>wsl_update_x64.msi</code> ）をダウンロード、インストールします。</p>
<p>その後以下のコマンドをやり直す必要がありました。</p>
<pre><code class="language-console" data-lang="console">wsl --set-default-version 2
</code></pre><p>今度は以下のように表示されました。</p>
<pre><code>PS C:\Users\hnakamur&gt; wsl --set-default-version 2
WSL 2 との主な違いについては、https://aka.ms/wsl2 を参照してください
</code></pre><h4 id="linux-ディストリビューションのインストール">Linux ディストリビューションのインストール</h4>
<p><a href="https://aka.ms/wslstore">Microsoft Store</a> を開いてお好みの Linux ディストリビューションをインストールします。</p>
<p>私は Ubuntu を WSL1 でインストールしていたので、別の環境として Ubuntu 20.04 LTS をインストールしてみました（Ubuntu のほうは最新の LTS に追随するものらしいです）。</p>
<p>WSL2 のウィンドウが開いて以下のように表示されたので、ユーザー名とパスワードを入力すればセットアップが完了し、Ubuntu のプロンプトが表示されます。</p>
<pre><code>Installing, this may take a few minutes...
Please create a default UNIX user account. The username does not need to match your Windows username.
For more information visit: https://aka.ms/wslusers
Enter new UNIX username: hnakamur
New password:
Retype new password:
passwd: password updated successfully
Installation successful!
To run a command as administrator (user &quot;root&quot;), use &quot;sudo &lt;command&gt;&quot;.
See &quot;man sudo_root&quot; for details.

Welcome to Ubuntu 20.04 LTS (GNU/Linux 4.19.104-microsoft-standard x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Thu May 28 22:00:20 JST 2020

  System load:  0.19               Processes:             8
  Usage of /:   0.4% of 250.98GB   Users logged in:       0
  Memory usage: 0%                 IPv4 address for eth0: 172.26.134.224
  Swap usage:   0%

0 updates can be installed immediately.
0 of these updates are security updates.


The list of available updates is more than a week old.
To check for new updates run: sudo apt update


This message is shown once once a day. To disable it please create the
/home/hnakamur/.hushlogin file.
</code></pre><p>（参考） WSL1 の場合は以下のような感じでした（IPv6のグローバルアドレスは伏せています）。</p>
<pre><code>Installing, this may take a few minutes...
Please create a default UNIX user account. The username does not need to match your Windows username.
For more information visit: https://aka.ms/wslusers
Enter new UNIX username: hnakamur
New password:
Retype new password:
passwd: password updated successfully
Installation successful!
To run a command as administrator (user &quot;root&quot;), use &quot;sudo &lt;command&gt;&quot;.
See &quot;man sudo_root&quot; for details.

Welcome to Ubuntu 20.04 LTS (GNU/Linux 4.4.0-19041-Microsoft x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Thu May 28 21:52:05 JST 2020

  System load:           0.52
  Usage of /home:        unknown
  Memory usage:          57%
  Swap usage:            0%
  Processes:             7
  Users logged in:       0
  IPv4 address for eth0: 192.168.2.208
  IPv6 address for eth0: xxxx:xxx:xxx:xxxx:yyyy:yyyy:yyyy:yyyy
  IPv6 address for eth0: xxxx:xxx:xxx:xxxx:zzzz:zzzz:zzzz:zzzz
  IPv4 address for eth1: 172.25.32.1
  IPv4 address for eth3: 192.168.254.1

0 updates can be installed immediately.
0 of these updates are security updates.


The list of available updates is more than a week old.
To check for new updates run: sudo apt update


This message is shown once once a day. To disable it please create the
/home/hnakamur/.hushlogin file.
</code></pre><p>PowerShell を開いて <code>wsl -l -v</code> を実行すると、 Ubuntu-20.04 が WSL2 で作られたことが確認できました。</p>
<pre><code>PS C:\Users\hnakamur&gt; wsl -l -v
  NAME            STATE           VERSION
* Ubuntu          Running         1
  Ubuntu-20.04    Running         2
</code></pre><h2 id="wsl2-の-vm-の調査メモ">WSL2 の VM の調査メモ</h2>
<h3 id="カーネルバージョン">カーネルバージョン</h3>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:~$ uname -r
4.19.104-microsoft-standard
hnakamur@sunshine7:~$ uname -a
Linux sunshine7 4.19.104-microsoft-standard #1 SMP Wed Feb 19 06:37:35 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux
</code></pre><p>WSL2 の Linux カーネルのレポジトリは <a href="https://github.com/microsoft/WSL2-Linux-Kernel">microsoft/WSL2-Linux-Kernel: The source for the Linux kernel used in Windows Subsystem for Linux 2 (WSL2)</a> にあります。</p>
<h3 id="メモリとスワップ">メモリとスワップ</h3>
<p>RAM 16GB のマシンですが、 WSL2 の Ubuntu には 12GB のメモリが割り当てられ、 4GB のスワップファイルが作られていました。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:~$ free -h
              total        used        free      shared  buff/cache   available
Mem:           12Gi        58Mi        12Gi       0.0Ki        62Mi        12Gi
Swap:         4.0Gi          0B       4.0Gi
hnakamur@sunshine7:~$ swapon
NAME       TYPE SIZE USED PRIO
/swap/file file   4G   0B   -2
</code></pre><p>同じく RAM 16GB の別のマシンで WSL1 で作成後 WSL2 に変換した Ubuntu ではメモリ 10GB でスワップファイル 3GB になっていました。</p>
<h3 id="プロセス一覧">プロセス一覧</h3>
<p>PID 1 は <code>/init</code> で <code>systemd</code> は動いていません（ちなみに物理サーバーの Ubuntu では PID 1 は <code>/sbin/init</code> でした）。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:~$ ps auxwwf
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0    892   552 ?        Sl   22:00   0:00 /init
root        49  0.0  0.0    892    84 ?        Ss   22:00   0:00 /init
root        50  0.0  0.0    892    84 ?        S    22:00   0:00  \_ /init
hnakamur    51  0.0  0.0  10036  5056 pts/0    Ss   22:00   0:00      \_ -bash
hnakamur   132  0.0  0.0  10604  3272 pts/0    R+   22:16   0:00          \_ ps auxwwf
</code></pre><h3 id="ネットワークインターフェースとipアドレス">ネットワークインターフェースとIPアドレス</h3>
<p><code>lo</code> と <code>eth0</code> の他に <code>bond0</code>, <code>dummy0</code>, <code>sit0@NONE</code> というインターフェースもありますが、何に使われているか私は分かっていません。</p>
<p><code>eth0</code> の IPv4 アドレスのネットワークは <code>/20</code> になってました。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:~$ ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: bond0: &lt;BROADCAST,MULTICAST,MASTER&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 3a:7c:e0:d3:44:a7 brd ff:ff:ff:ff:ff:ff
3: dummy0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 4a:1b:ad:a2:76:eb brd ff:ff:ff:ff:ff:ff
4: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/sit 0.0.0.0 brd 0.0.0.0
5: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:15:5d:de:27:a0 brd ff:ff:ff:ff:ff:ff
    inet 172.26.134.224/20 brd 172.26.143.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::215:5dff:fede:27a0/64 scope link
       valid_lft forever preferred_lft forever
</code></pre><p>外部のドメインを指定して ping も通りました。</p>
<p>Windows には IPv6 のグローバルアドレスがついているのですが、 WSL2 の仮想マシンには上記の通りついていません。</p>
<p><a href="https://github.com/microsoft/WSL/issues/4518">cannot reach ipv6 only address · Issue #4518 · microsoft/WSL</a> の <a href="https://github.com/microsoft/WSL/issues/4518#issuecomment-534267533">コメント</a> によると現状 WSL2 は IPv6 は使えないそうです。</p>
<p>PowerShell で <code>ipconfig /all</code> で確認すると WSL 用に以下のような仮想のネットワークインタフェースが作成されていました。</p>
<pre><code>イーサネット アダプター vEthernet (WSL):

   接続固有の DNS サフィックス . . . . .:
   説明. . . . . . . . . . . . . . . . .: Hyper-V Virtual Ethernet Adapter #3
   物理アドレス. . . . . . . . . . . . .: 00-15-5D-3E-F8-EE
   DHCP 有効 . . . . . . . . . . . . . .: いいえ
   自動構成有効. . . . . . . . . . . . .: はい
   リンクローカル IPv6 アドレス. . . . .: fe80::fde6:af3f:d161:518d%71(優先)
   IPv4 アドレス . . . . . . . . . . . .: 172.26.128.1(優先)
   サブネット マスク . . . . . . . . . .: 255.255.240.0
   デフォルト ゲートウェイ . . . . . . .:
   DHCPv6 IAID . . . . . . . . . . . . .: 1191187805
   DHCPv6 クライアント DUID. . . . . . .: 00-01-00-01-20-40-55-86-C8-5B-76-D1-3D-7E
   DNS サーバー. . . . . . . . . . . . .: fec0:0:0:ffff::1%1
                                          fec0:0:0:ffff::2%1
                                          fec0:0:0:ffff::3%1
   NetBIOS over TCP/IP . . . . . . . . .: 有効
</code></pre><h3 id="ディスク">ディスク</h3>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:~$ df -h -T
Filesystem     Type      Size  Used Avail Use% Mounted on
/dev/sdb       ext4      251G  1.1G  238G   1% /
tmpfs          tmpfs     6.2G     0  6.2G   0% /mnt/wsl
tools          9p        238G  181G   57G  77% /init
none           devtmpfs  6.2G     0  6.2G   0% /dev
none           tmpfs     6.2G  8.0K  6.2G   1% /run
none           tmpfs     6.2G     0  6.2G   0% /run/lock
none           tmpfs     6.2G     0  6.2G   0% /run/shm
none           tmpfs     6.2G     0  6.2G   0% /run/user
tmpfs          tmpfs     6.2G     0  6.2G   0% /sys/fs/cgroup
C:\            9p        238G  181G   57G  77% /mnt/c
</code></pre><p>WSL2 の Ubuntu のプロンプトで <code>explorer.exe .</code> と実行すると、 <code>\\wsl$\Ubuntu-20.04\home\hnakamur</code> のパスでエクスプローラーが開きます。</p>
<h3 id="procsysfsbinfmt_miscwslinterop"><code>/proc/sys/fs/binfmt_misc/WSLInterop</code></h3>
<p><a href="https://docs.microsoft.com/ja-jp/windows/wsl/interop">Linux との Windows の相互運用性 | Microsoft Docs</a>
の <a href="https://docs.microsoft.com/ja-jp/windows/wsl/interop#disable-interoperability">相互運用性の無効化</a> の項に <code>/proc/sys/fs/binfmt_misc/WSLInterop</code> についての情報がありました。</p>
<p><a href="https://patrickwu.space/wslconf/">Scripting With WSL Interoperability: Tips &amp; Tricks | Listener</a> も参考になりそうです。</p>
<p>初期状態での <code>/proc/sys/fs/binfmt_misc/WSLInterop</code> の内容を確認すると以下のようになっていました。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:~$ ls -l /proc/sys/fs/binfmt_misc/WSLInterop
-rw-r--r-- 1 root root 0 May 28 21:59 /proc/sys/fs/binfmt_misc/WSLInterop
hnakamur@sunshine7:~$ cat /proc/sys/fs/binfmt_misc/WSLInterop
enabled
interpreter /tools/init
flags: F
offset 0
magic 4d5a
</code></pre><h2 id="docker-desktop-for-windows-のインストール手順メモ">Docker Desktop for Windows のインストール手順メモ</h2>
<p><a href="https://www.docker.com/products/docker-desktop">Docker Desktop for Mac and Windows | Docker</a> から Windows の Stable のインストーラーをダウンロードして実行します。</p>
<p>インストーラーの表示によるとバージョンは Docker Desktop 2.3.0.3 (45519) です。</p>
<p>インストーラーの Configuration の画面で以下の2つのチェックボックスが表示されます。</p>
<ul>
<li>Enable WSL 2 Windows Features</li>
<li>Add shortcut to desktop</li>
</ul>
<p>初期状態で両方チェックオンになっていますので、 1 つめはオンのまま OK ボタンを押してインストールします。</p>
<p>インストールが完了したら Windows のスタートメニューから Docker Desktop を起動します。</p>
<p>起動が完了したら &ldquo;Get started with Docker in a few easy steps!&rdquo; という画面が表示されるので Start ボタンを押してチュートリアルを見るか、下の &ldquo;Skip tutorial&rdquo; リンクを押してスキップします。</p>
<p><a href="https://docs.docker.com/docker-for-windows/wsl/#prerequisites">Docker Desktop WSL 2 backend | Docker Documentation</a> の Install の 7. の手順を実行します。</p>
<ol>
<li>Windows のタスクトレイで Docker のポップアップメニューの Settings を選んで設定画面を開きます。</li>
<li>Settings 画面が開いたら、左の Resources を開いて WSL INTEGRATION を選び、右で &ldquo;Enable integration with my default WSL distro&rdquo; のチェックボックスとその下の &ldquo;Enable integration with additional distros:&rdquo; の下のトグルボタンを適宜調整し、右下の [Apply &amp; Restart] ボタンを押します。私の環境ではデフォルトは WSL1 の Ubuntu なので additional distros のほうの Ubuntu-20.04 を有効にしました。</li>
<li>PowerShell を開き <code>wsl -t ubuntu-20.04</code> （ディストリビューションは適宜調整）を実行して、 WSL2 の VM を再起動します。</li>
</ol>
<p>これで WSL2 の VM のプロンプトを開いて <code>docker ps</code> を実行すると正常に動きます。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:/mnt/c/Users/hnakamur$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
</code></pre><p><code>docker run hello-world</code> も正常に動きました。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:/mnt/c/Users/hnakamur$ docker run hello-world
Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
0e03bdcc26d7: Pull complete
Digest: sha256:6a65f928fb91fcfbc963f7aa6d57c8eeb426ad9a20c7ee045538ef34847f44f1
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.
    (amd64)
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/
</code></pre><h2 id="docker-desktop-for-windows-の調査メモ">Docker Desktop for Windows の調査メモ</h2>
<p>この状態で <code>df -h -T</code> を実行してみると Docker Desktop for Windows 用のマウントが追加されていました。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:/mnt/c/Users/hnakamur$ df -h -T
Filesystem     Type      Size  Used Avail Use% Mounted on
/dev/sdb       ext4      251G  1.1G  238G   1% /
tmpfs          tmpfs     6.2G     0  6.2G   0% /mnt/wsl
/dev/sdd       ext4      251G  949M  238G   1% /mnt/wsl/docker-desktop-data/isocache
none           tmpfs     6.2G   12K  6.2G   1% /mnt/wsl/docker-desktop/shared-sockets/host-services
/dev/sdc       ext4      251G  117M  239G   1% /mnt/wsl/docker-desktop/docker-desktop-proxy
/dev/loop0     iso9660   244M  244M     0 100% /mnt/wsl/docker-desktop/cli-tools
tools          9p        238G  185G   53G  78% /init
none           devtmpfs  6.2G     0  6.2G   0% /dev
none           tmpfs     6.2G  8.0K  6.2G   1% /run
none           tmpfs     6.2G     0  6.2G   0% /run/lock
none           tmpfs     6.2G     0  6.2G   0% /run/shm
none           tmpfs     6.2G     0  6.2G   0% /run/user
tmpfs          tmpfs     6.2G     0  6.2G   0% /sys/fs/cgroup
C:\            9p        238G  185G   53G  78% /mnt/c
</code></pre><p><code>docker</code> と <code>docker-compose</code> はマウント先のファイルへのシンボリックリンクになっていました。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:/mnt/c/Users/hnakamur$ which docker
/usr/bin/docker
hnakamur@sunshine7:/mnt/c/Users/hnakamur$ which docker-compose
/usr/bin/docker-compose
hnakamur@sunshine7:/mnt/c/Users/hnakamur$ ls -l /usr/bin/docker*
lrwxrwxrwx 1 root root 48 May 28 23:08 /usr/bin/docker -&gt; /mnt/wsl/docker-desktop/cli-tools/usr/bin/docker
lrwxrwxrwx 1 root root 56 May 28 23:08 /usr/bin/docker-compose -&gt; /mnt/wsl/docker-desktop/cli-tools/usr/bin/docker-compose
</code></pre><p>Ubuntu の docker コンテナーも試してみました。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:/mnt/c/Users/hnakamur$ docker run -it ubuntu bash
root@a0f4ec92b72f:/# apt update &amp;&amp; apt -y install iproute2 iputils-ping
…(略)…
root@a0f4ec92b72f:/# ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: sit0@NONE: &lt;NOARP&gt; mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/sit 0.0.0.0 brd 0.0.0.0
9: eth0@if10: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0
       valid_lft forever preferred_lft forever
</code></pre><p>外部のドメインへの ping も通りました。</p>
<p>このとき WSL2 の VM の <code>ip a</code> と Windows での <code>ipconfig /all</code> は変更無しでした。</p>
<p><code>/var/run/</code> に <code>docker.sock</code> というソケットファイルと <code>docker-desktop-proxy.pid</code> という PID ファイルがありました。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:/mnt/c/Users/hnakamur$ ls -l /var/run/docker*
-rw-r--r-- 1 root root   2 May 28 23:08 /var/run/docker-desktop-proxy.pid
srw-rw---- 1 root docker 0 May 28 23:08 /var/run/docker.sock
</code></pre><p><code>docker-desktop-proxy.pid</code> の PID のプロセスは以下のようなコマンドでした。</p>
<pre><code class="language-console" data-lang="console">hnakamur@sunshine7:/mnt/c/Users/hnakamur$ ps ww -p $(cat /var/run/docker-desktop-proxy.pid)
  PID TTY      STAT   TIME COMMAND
   47 pts/1    Ssl+   0:00 /mnt/wsl/docker-desktop/docker-desktop-proxy --distro-name Ubuntu-20.04 --docker-desktop-root /mnt/wsl/docker-desktop
</code></pre><h2 id="docker-desktop-data-と-docker-desktop-は-wsl2-のディストリビューションだった-2020-05-29-追記">docker-desktop-data と docker-desktop は WSL2 のディストリビューションだった (2020-05-29 追記)</h2>
<p>Docker Desktop for Windows のセットアップ後に PowerShell で <code>wsl -l -v</code> でディストリビューション一覧を表示してみると以下のようになりました。</p>
<pre><code class="language-console" data-lang="console">PS C:\Users\hnakamur&gt; wsl -l -v
  NAME                   STATE           VERSION
* Ubuntu                 Running         2
  docker-desktop-data    Running         2
  docker-desktop         Running         2
</code></pre><p>上記で <code>df -h -T</code> を実行したときに <code>/mnt/wsl/docker-desktop-data</code> と <code>/mnt/wsl/docker-desktop</code> というのがありましたが、これは WSL2 のディストリビューションとして作られたものがマウントされているようです。</p>
<h2 id="wsl2-の記事-2020-05-30-追記">WSL2 の記事 (2020-05-30 追記)</h2>
<p>WSL2 についての詳しい記事を見つけたのでリンクを貼っておきます。</p>
<ul>
<li><a href="https://ascii.jp/elem/000/004/007/4007561/">ASCII.jp：20H1の完成とともにWindows Subsystem for Linux 2が来る (1/2)</a></li>
<li><a href="https://ascii.jp/elem/000/004/012/4012149/">ASCII.jp：20H1とともに正式に来るWindows Subsystem for Linux 2の実力を見る (1/2)</a></li>
</ul>
<p>1 つめの記事内に他の記事へのリンクも貼ってあってそちらもためになりました。</p>

</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
