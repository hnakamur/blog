<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.89.4" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>ksarでsysstatのメトリックをグラフで表示 &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/copy-button.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://hnakamur.github.io/blog/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://hnakamur.github.io/blog/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2021. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>ksarでsysstatのメトリックをグラフで表示</h1>
  <time datetime=2020-08-09T09:28:33&#43;0900 class="post-date">2020-08-09</time>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#はじめに">はじめに</a></li>
    <li><a href="#sysstat-のインストールと設定">sysstat のインストールと設定</a>
      <ul>
        <li><a href="#sysstat-のインストール">sysstat のインストール</a></li>
        <li><a href="#1分単位に記録するように設定変更">1分単位に記録するように設定変更</a></li>
        <li><a href="#sysstatを有効にする">sysstatを有効にする</a></li>
      </ul>
    </li>
    <li><a href="#sar-コマンドで出力する際に時刻を24時間制にする方法">sar コマンドで出力する際に時刻を24時間制にする方法</a></li>
    <li><a href="#ksarのforkのセットアップと使い方">ksarのforkのセットアップと使い方</a>
      <ul>
        <li></li>
        <li><a href="#ksarの使い方">ksarの使い方</a></li>
      </ul>
    </li>
    <li><a href="#横道-sysstat-を毎秒記録する">(横道) sysstat を毎秒記録する</a>
      <ul>
        <li><a href="#2020-08-11追記-sysstat-で毎秒記録したときのファイルサイズ">2020-08-11追記: sysstat で毎秒記録したときのファイルサイズ</a></li>
      </ul>
    </li>
  </ul>
</nav>
  <h2 id="はじめに">はじめに</h2>
<p>サーバーのメトリックを確認するのに <a href="http://sebastien.godard.pagesperso-orange.fr/">sysstat</a> の sar コマンドが便利ですが、 ksar でグラフで見るほうがさらに便利です。</p>
<p>ということで手順をメモしておきます。</p>
<h2 id="sysstat-のインストールと設定">sysstat のインストールと設定</h2>
<h3 id="sysstat-のインストール">sysstat のインストール</h3>
<p>Ubuntu では以下のように sysstat パッケージをインストールします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">sudo apt install sysstat
</span></code></pre></div><h3 id="1分単位に記録するように設定変更">1分単位に記録するように設定変更</h3>
<p>パッケージに含まれる sysstat の cron 用の設定ファイル <code>/etc/cron.d/sysstat</code> は以下のように10分ごとにメトリックを記録するようになっています。</p>
<pre tabindex="0"><code># The first element of the path is a directory where the debian-sa1
# script is located
PATH=/usr/lib/sysstat:/usr/sbin:/usr/sbin:/usr/bin:/sbin:/bin

# Activity reports every 10 minutes everyday
5-55/10 * * * * root command -v debian-sa1 &gt; /dev/null &amp;&amp; debian-sa1 1 1

# Additional run at 23:59 to rotate the statistics file
59 23 * * * root command -v debian-sa1 &gt; /dev/null &amp;&amp; debian-sa1 60 2
</code></pre><p>以下のコマンドを実行して1分単位に記録するように変更します
（横道の補足ですが <code>sed -i</code> を使って上書きする場合は事前に <code>-i</code> 無しで実行して期待通りの出力になっているか確認してから <code>-i</code> 付きで実行して上書きするのが確実です）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">sudo sed -i &#39;s/every 10 minutes/every minute/;s|5-55/10|*|&#39; /etc/cron.d/sysstat
</span></code></pre></div><h3 id="sysstatを有効にする">sysstatを有効にする</h3>
<p>パッケージに含まれる <code>/etc/default/sysstat</code> は以下のようになっています。</p>
<pre tabindex="0"><code>#
# Default settings for /etc/init.d/sysstat, /etc/cron.d/sysstat
# and /etc/cron.daily/sysstat files
#

# Should sadc collect system activity informations? Valid values
# are &quot;true&quot; and &quot;false&quot;. Please do not put other values, they
# will be overwritten by debconf!
ENABLED=&quot;false&quot;
</code></pre><p>以下のコマンドを実行して有効にします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">sudo sed -i &#39;s/^ENABLED=&#34;false&#34;/ENABLED=&#34;true&#34;/&#39; /etc/default/sysstat
</span></code></pre></div><h2 id="sar-コマンドで出力する際に時刻を24時間制にする方法">sar コマンドで出力する際に時刻を24時間制にする方法</h2>
<p>sar では様々なメトリックが出力できます（詳しくは <code>man sar</code> を参照）。
ksar でグラフを見るためには <code>sar -A</code> で全ての種類のメトリックを出力します。</p>
<p>単に <code>sar -A</code> とすると時刻が <code>12:01:01 AM</code> のような12時間制になってしまいます。
以下のように <code>LC_TIME=C</code> をつけて実行すれば24時間制になります
（<a href="https://stackoverflow.com/questions/28092728/how-to-get-sar-command-value-in-24-hour-format-from-000000-to-235959-in-li">time - How to get sar command value in 24 hour format (from 00:00:00 to 23:59:59) in Linux? - Stack Overflow</a> で知りました）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">LC_TIME=C sar -A
</span></code></pre></div><p>前日以前のメトリックを見たい場合は <code>-f</code> でファイルを指定します。
下記の saDD の DD の部分は日付をゼロパディングして指定します。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">LC_TIME=C sar -A -f /var/log/sysstat/saDD
</span></code></pre></div><p>事前に <code>ls -l /var/log/sysstat/</code> でどのファイルがあるか確認してから実行すると良いです。とあるサーバーでは以下のようになっていました。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp"># </span>ls -l /var/log/sysstat/
<span class="go">total 51576
</span><span class="go">-rw-r--r-- 1 root root 3657616 Aug  2 00:00 sa01
</span><span class="go">-rw-r--r-- 1 root root 3660152 Aug  3 00:00 sa02
</span><span class="go">-rw-r--r-- 1 root root 3657616 Aug  4 00:00 sa03
</span><span class="go">-rw-r--r-- 1 root root 3660152 Aug  5 00:00 sa04
</span><span class="go">-rw-r--r-- 1 root root 3660152 Aug  6 00:00 sa05
</span><span class="go">-rw-r--r-- 1 root root 3660152 Aug  7 00:00 sa06
</span><span class="go">-rw-r--r-- 1 root root 3660152 Aug  8 00:00 sa07
</span><span class="go">-rw-r--r-- 1 root root 3660152 Aug  9 00:00 sa08
</span><span class="go">-rw-r--r-- 1 root root 1534984 Aug  9 10:03 sa09
</span><span class="go">-rw-r--r-- 1 root root 2744272 Aug  2 00:06 sar01
</span><span class="go">-rw-r--r-- 1 root root 2744272 Aug  3 00:09 sar02
</span><span class="go">-rw-r--r-- 1 root root 2744272 Aug  4 00:09 sar03
</span><span class="go">-rw-r--r-- 1 root root 2744272 Aug  5 00:09 sar04
</span><span class="go">-rw-r--r-- 1 root root 2744272 Aug  6 00:06 sar05
</span><span class="go">-rw-r--r-- 1 root root 2744272 Aug  7 00:08 sar06
</span><span class="go">-rw-r--r-- 1 root root 2744272 Aug  8 00:07 sar07
</span><span class="go">-rw-r--r-- 1 root root 2744272 Aug  9 00:08 sar08
</span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp"># </span>ls -lh /var/log/sysstat/
<span class="go">total 51M
</span><span class="go">-rw-r--r-- 1 root root 3.5M Aug  2 00:00 sa01
</span><span class="go">-rw-r--r-- 1 root root 3.5M Aug  3 00:00 sa02
</span><span class="go">-rw-r--r-- 1 root root 3.5M Aug  4 00:00 sa03
</span><span class="go">-rw-r--r-- 1 root root 3.5M Aug  5 00:00 sa04
</span><span class="go">-rw-r--r-- 1 root root 3.5M Aug  6 00:00 sa05
</span><span class="go">-rw-r--r-- 1 root root 3.5M Aug  7 00:00 sa06
</span><span class="go">-rw-r--r-- 1 root root 3.5M Aug  8 00:00 sa07
</span><span class="go">-rw-r--r-- 1 root root 3.5M Aug  9 00:00 sa08
</span><span class="go">-rw-r--r-- 1 root root 1.7M Aug  9 11:05 sa09
</span><span class="go">-rw-r--r-- 1 root root 2.7M Aug  2 00:06 sar01
</span><span class="go">-rw-r--r-- 1 root root 2.7M Aug  3 00:09 sar02
</span><span class="go">-rw-r--r-- 1 root root 2.7M Aug  4 00:09 sar03
</span><span class="go">-rw-r--r-- 1 root root 2.7M Aug  5 00:09 sar04
</span><span class="go">-rw-r--r-- 1 root root 2.7M Aug  6 00:06 sar05
</span><span class="go">-rw-r--r-- 1 root root 2.7M Aug  7 00:08 sar06
</span><span class="go">-rw-r--r-- 1 root root 2.7M Aug  8 00:07 sar07
</span><span class="go">-rw-r--r-- 1 root root 2.7M Aug  9 00:08 sar08
</span></code></pre></div><p>中身を見てみると <code>sarDD</code> のほうはテキスト形式で時刻も24時間制になっていました。</p>
<p>これは <code>/etc/cron.daily/sysstat</code> で実行される <a href="http://manpages.ubuntu.com/manpages/focal/en/man8/sa2.8.html">sa2 (8)</a> で作成されることが分かりました。</p>
<p>ということで既に作成済みであれば <code>sarDD</code> ファイルを見れば良いです。</p>
<p>未作成の場合は以下のように実行して手動で作成します。
/var/log/sysstat/<code>で作成すると紛らわしいので</code>/var/log/sysstat/` 以外の作業ディレクトリで作成するようにします。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="go">LC_TIME=C sar -A -f /var/log/sysstat/saDD &gt; sarDD
</span></code></pre></div><h2 id="ksarのforkのセットアップと使い方">ksarのforkのセットアップと使い方</h2>
<h4 id="openjdk-のダウンロードとセットアップ">OpenJDK のダウンロードとセットアップ</h4>
<p>職場のPCがWindowsなので、Windows用の手順を書いておきます。
<a href="https://openjdk.java.net/">OpenJDK</a> から <a href="https://jdk.java.net/14/">https://jdk.java.net/14/</a> を開いてWindows/x64のzipのリンクをクリックしてダウンロードします。</p>
<p>2020-08-09時点の最新版は 14.0.2 でした。
ダウンロードした zip ファイルをエクスプローラーで見ると中に <code>jdk-14.0.2</code> というディレクトリーがあるのでこれをお好みの場所に展開します。
ここでは <code>C:\jdk-14.0.2</code> とします。</p>
<h4 id="ksarのforkのダウンロードとセットアップ">ksarのforkのダウンロードとセットアップ</h4>
<p>ここではksarのforkである
<a href="https://github.com/vlsi/ksar">vlsi/ksar: fork of http://sourceforge.net/projects/ksar/</a>
を使います
（<a href="https://sourceforge.net/projects/ksar/">ksar : a sar grapher download | SourceForge.net</a> の UserReviews のコメントで知りました）。</p>
<p><a href="https://github.com/vlsi/ksar/releases">Releases · vlsi/ksar</a> から最新のリリースのAssetsから
<code>ksar-5.2.4-b369_g27d96e71-SNAPSHOT-all.jar</code> のような jar ファイルをダウンロードします。</p>
<p>ダウンロード後お好みのディレクトリーに移動します。
ここでは <code>C:\ksar</code> というディレクトリーを作成してそこに移動したとします。</p>
<p>エクスプローラーで jar ファイルを選んでポップアップメニューの[ショートカットの作成]を選びます。</p>
<p>作成されたショートカットをエクスプローラーで選んで名前を ksar などお好みで変更します。</p>
<p>そしてポップアップメニューの[プロパティ]を選んでリンク先を以下のように変更します。</p>
<pre tabindex="0"><code>C:\jdk-14.0.2\bin\javaw.exe -jar C:\ksar\ksar-5.2.4-b369_g27d96e71-SNAPSHOT-all.jar
</code></pre><h3 id="ksarの使い方">ksarの使い方</h3>
<p>対象のサーバーで上記で作成された sarDD ファイルををサーバーからksarをセットアップしたPCに転送します。</p>
<p>上記で作成したショートカットをダブルクリックして起動します。</p>
<figure><img src="/blog/images/2020/08/09/ksar-launched.png"/><figcaption>
            <h4>ksar launched</h4>
        </figcaption>
</figure>

<p>ksar は Java の <a href="https://ja.wikipedia.org/wiki/Swing">Swing - Wikipedia</a> という GUI ツールキットで作成されています。</p>
<p>内側のウィンドウの [Data]/[Load from file&hellip;] メニューを選び、ファイル選択ダイアログで上記で PC に転送してきた sarDD ファイルを選択します。</p>
<p>ダイアログが表示されたら [Select date format:] のドロップダウンはデフォルトの [Automatic Detection] のままで [Ok] ボタンを押します。</p>
<figure><img src="/blog/images/2020/08/09/ksar-file-loaded.png"/><figcaption>
            <h4>ksar file loaded</h4>
        </figcaption>
</figure>

<p>左のツリーでメトリックの種類を選ぶとグラフが表示されます。例として Swap を選んだ時のグラフを以下に示します。</p>
<figure><img src="/blog/images/2020/08/09/ksar-swap.png"/><figcaption>
            <h4>ksar swap</h4>
        </figcaption>
</figure>

<p>グラフ内でドラッグして矩形選択するとズームインできます。
横軸（時間軸）のみズームインしたい場合は縦方向は全体を選ぶようにします。</p>
<p>グラフ内でポップアップメニューを開き[ズームアップ]の[両軸]メニューなどでズームアウトできますが、[自動サイジング]/[両軸] で初期状態に戻るほうが使いやすいと思います。</p>
<h2 id="横道-sysstat-を毎秒記録する">(横道) sysstat を毎秒記録する</h2>
<p>この記事を書くにあたって改めて確認していたらsysstatを毎秒記録することも出来ることが分かったのでメモしておきます。</p>
<p><code>/etc/cron.d/sysstat</code> から <code>/usr/lib/sysstat/</code> の <code>debian-sa1</code> と <code>sa1</code> （<a href="https://manpages.ubuntu.com/manpages/focal/en/man8/sa1.8.html">sa1 (8)</a> 参照）を見ると <code>sa1</code> まではシェルスクリプトでそこから
<a href="https://manpages.ubuntu.com/manpages/focal/en/man8/sadc.8.html">sadc (8)</a>
を <code>exec ${ENDIR}/sadc -F -L ${SADC_OPTIONS} $* ${SA_DIR}</code> で実行しています。</p>
<p><code>sadc</code> に渡される2つの数値は秒単位の interval と count となっています。</p>
<p>また <code>-D</code> オプションを指定すると saDD の代わりに saYYYYMMDD というファイルが作成されるようになり、上書きされずにずっと保管しておくことができるんですね。</p>
<p>というわけで <code>/etc/cron.d/sysstat</code> を以下のように変えて試してみることにしました。</p>
<pre tabindex="0"><code># The first element of the path is a directory where the debian-sa1
# script is located
PATH=/usr/lib/sysstat:/usr/sbin:/usr/sbin:/usr/bin:/sbin:/bin

# Activity reports every second everyday
* * * * * root command -v debian-sa1 &gt; /dev/null &amp;&amp; debian-sa1 -D 1 60
</code></pre><p>元の設定ではログローテートのために23:59にも別途起動していましたが、下記の設定で出来るか試してみます。
また作成されるファイルサイズも気になるところです。後日確認して追記しようと思います。</p>
<h3 id="2020-08-11追記-sysstat-で毎秒記録したときのファイルサイズ">2020-08-11追記: sysstat で毎秒記録したときのファイルサイズ</h3>
<p>2つの環境で試してみたのですが以下のサイズになりました。</p>
<ul>
<li>256MiB (268328120バイト)</li>
<li>425MiB (444787904バイト)</li>
</ul>

</div>


<script src="https://hnakamur.github.io/blog/js/copy-button.js"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
