<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="730px" preserveAspectRatio="none" style="width:1321px;height:730px;" version="1.1" viewBox="0 0 1321 730" width="1321px" zoomAndPan="magnify"><defs><filter height="300%" id="f13bdqr3xeb7e9" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="87.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="412" y="117.2969"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="87.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="412" y="408.625"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="100.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="412" y="525.1563"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="146.4297"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="437.7578"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="57.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="554.2891"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="14.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1130" y="583.4219"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1246" y="233.8281"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1246" y="292.0938"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1246" y="350.3594"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="27" x2="27" y1="86.2969" y2="643.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="416.5" x2="416.5" y1="86.2969" y2="643.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="873" x2="873" y1="86.2969" y2="643.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1134.5" x2="1134.5" y1="86.2969" y2="643.5547"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1250.5" x2="1250.5" y1="86.2969" y2="643.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="8" y="82.9951">User</text><ellipse cx="27" cy="13" fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M27,21 L27,48 M14,29 L40,29 M27,48 L14,63 M27,48 L40,63 " fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="32" x="8" y="655.5498">User</text><ellipse cx="27" cy="668.8516" fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M27,676.8516 L27,703.8516 M14,684.8516 L40,684.8516 M27,703.8516 L14,718.8516 M27,703.8516 L40,718.8516 " fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="389.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="396.5" y="70.9951">nginx</text><rect fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="51" x="389.5" y="642.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="37" x="396.5" y="662.5498">nginx</text><rect fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="156" x="793" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="142" x="800" y="70.9951">Service Provider (SP)</text><rect fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="156" x="793" y="642.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="142" x="800" y="662.5498">Service Provider (SP)</text><rect fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="81" x="1092.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="67" x="1099.5" y="70.9951">Upstream</text><rect fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="81" x="1092.5" y="642.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="67" x="1099.5" y="662.5498">Upstream</text><rect fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="123" x="1187.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="109" x="1194.5" y="70.9951">ID Provider (IdP)</text><rect fill="#FEFECE" filter="url(#f13bdqr3xeb7e9)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="123" x="1187.5" y="642.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="109" x="1194.5" y="662.5498">ID Provider (IdP)</text><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="87.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="412" y="117.2969"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="87.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="412" y="408.625"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="100.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="412" y="525.1563"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="146.4297"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="437.7578"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="57.2656" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="868" y="554.2891"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="14.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1130" y="583.4219"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1246" y="233.8281"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1246" y="292.0938"/><rect fill="#FFFFFF" filter="url(#f13bdqr3xeb7e9)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1246" y="350.3594"/><polygon fill="#A80036" points="400,113.2969,410,117.2969,400,121.2969,404,117.2969" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="27" x2="406" y1="117.2969" y2="117.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="366" x="34" y="112.3638">Try to access protected page without valid session cookie</text><polygon fill="#A80036" points="856,142.4297,866,146.4297,856,150.4297,860,146.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="422" x2="862" y1="146.4297" y2="146.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="429" y="141.4966">Request to create SAML Request</text><polygon fill="#A80036" points="433,171.5625,423,175.5625,433,179.5625,429,175.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="427" x2="872" y1="175.5625" y2="175.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="439" y="170.6294">Return SAML Request</text><polygon fill="#A80036" points="38,200.6953,28,204.6953,38,208.6953,34,204.6953" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="32" x2="416" y1="204.6953" y2="204.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="44" y="199.7622">Redirect to IdP login page</text><polygon fill="#A80036" points="1234,229.8281,1244,233.8281,1234,237.8281,1238,233.8281" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="27" x2="1240" y1="233.8281" y2="233.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="34" y="228.895">Open login page with SAML Request</text><polygon fill="#A80036" points="38,258.9609,28,262.9609,38,266.9609,34,262.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="32" x2="1250" y1="262.9609" y2="262.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="104" x="44" y="258.0278">Show login page</text><polygon fill="#A80036" points="1234,288.0938,1244,292.0938,1234,296.0938,1238,292.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="27" x2="1240" y1="292.0938" y2="292.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="187" x="34" y="287.1606">Submit user ID and password</text><polygon fill="#A80036" points="38,317.2266,28,321.2266,38,325.2266,34,321.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="32" x2="1250" y1="321.2266" y2="321.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="170" x="44" y="316.2935">Show two factor auth page</text><polygon fill="#A80036" points="1234,346.3594,1244,350.3594,1234,354.3594,1238,350.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="27" x2="1240" y1="350.3594" y2="350.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="34" y="345.4263">Submit two factor information</text><polygon fill="#A80036" points="38,375.4922,28,379.4922,38,383.4922,34,379.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="32" x2="1250" y1="379.4922" y2="379.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="44" y="374.5591">Return SAML Response and redirect to SP after login finihes</text><polygon fill="#A80036" points="400,404.625,410,408.625,400,412.625,404,408.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="27" x2="406" y1="408.625" y2="408.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="34" y="403.6919">Send SAML Response</text><polygon fill="#A80036" points="856,433.7578,866,437.7578,856,441.7578,860,437.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="422" x2="862" y1="437.7578" y2="437.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="429" y="432.8247">Verify SAML Response, create session, and save user mail address</text><polygon fill="#A80036" points="433,462.8906,423,466.8906,433,470.8906,429,466.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="427" x2="872" y1="466.8906" y2="466.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="439" y="461.9575">Return session cookie</text><polygon fill="#A80036" points="38,492.0234,28,496.0234,38,500.0234,34,496.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="32" x2="416" y1="496.0234" y2="496.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="44" y="491.0903">Return session cookie and redirect to protected page</text><polygon fill="#A80036" points="400,521.1563,410,525.1563,400,529.1563,404,525.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="27" x2="406" y1="525.1563" y2="525.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="34" y="520.2231">Access to protected page with session cookie</text><polygon fill="#A80036" points="856,550.2891,866,554.2891,856,558.2891,860,554.2891" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="422" x2="862" y1="554.2891" y2="554.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="389" x="429" y="549.356">Check session exists and get user mail address from session</text><polygon fill="#A80036" points="1118,579.4219,1128,583.4219,1118,587.4219,1122,583.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="878" x2="1124" y1="583.4219" y2="583.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="885" y="578.4888">Send request with user mail address</text><polygon fill="#A80036" points="889,593.5547,879,597.5547,889,601.5547,885,597.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="883" x2="1134" y1="597.5547" y2="597.5547"/><polygon fill="#A80036" points="433,607.5547,423,611.5547,433,615.5547,429,611.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="427" x2="872" y1="611.5547" y2="611.5547"/><polygon fill="#A80036" points="38,621.5547,28,625.5547,38,629.5547,34,625.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="32" x2="416" y1="625.5547" y2="625.5547"/><!--
@startuml
actor User
participant nginx
participant "Service Provider (SP)" as SP
participant Upstream
participant "ID Provider (IdP)" as IdP

User -> nginx : Try to access protected page without valid session cookie
activate nginx
nginx -> SP : Request to create SAML Request
activate SP
SP -> nginx : Return SAML Request
deactivate SP
nginx -> User : Redirect to IdP login page
deactivate nginx

User -> IdP : Open login page with SAML Request
activate IdP
IdP -> User : Show login page
deactivate IdP

User -> IdP : Submit user ID and password
activate IdP
IdP -> User : Show two factor auth page
deactivate IdP

User -> IdP : Submit two factor information
activate IdP
IdP -> User : Return SAML Response and redirect to SP after login finihes
deactivate IdP

User -> nginx : Send SAML Response
activate nginx
nginx -> SP : Verify SAML Response, create session, and save user mail address
activate SP
SP -> nginx : Return session cookie
deactivate SP
nginx -> User : Return session cookie and redirect to protected page
deactivate nginx

User -> nginx : Access to protected page with session cookie
activate nginx
nginx -> SP : Check session exists and get user mail address from session
activate SP
SP -> Upstream : Send request with user mail address
activate Upstream
Upstream -> SP
deactivate Upstream
SP -> nginx
deactivate SP
nginx -> User
deactivate nginx

@enduml

PlantUML version 1.2017.15(Tue Jul 04 01:45:34 JST 2017)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 10.0.1+10-Ubuntu-3ubuntu1
Operating System: Linux
OS Version: 4.15.0-29-generic
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>