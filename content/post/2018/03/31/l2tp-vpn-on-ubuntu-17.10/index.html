<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-jp" lang="ja-jp">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.62.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Ubuntu 17.10でL2TPのVPN接続を試してみた &middot; hnakamur&#39;s blog</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-53263855-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53263855-1');
</script>



</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog</h1></a>
      <p class="lead">
       my tech memo 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://hnakamur.github.io/blog/"> blog home </a></li><li><a href="https://github.com/hnakamur"> github @hnakamur </a></li><li><a href="https://twitter.com/hnakamur2"> twitter @hnakamur2 </a></li>
      </ul>
    </nav>

    <p>powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://pages.github.com/">GitHub Pages</a></p>
    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Ubuntu 17.10でL2TPのVPN接続を試してみた</h1>
  <time datetime=2018-03-31T08:40:00&#43;0900 class="post-date">2018-03-31</time>
  <h1 id="heading">はじめに</h1>
<p>Ubuntu 17.10でL2TPのVPN接続を試してみたのでメモです。
以下の手順の一部は接続先の設定に依存して変動がありえます。</p>
<h1 id="heading-1">セットアップ</h1>
<h2 id="heading-2">必要なソフトウェアをインストール</h2>
<p>network-manager-l2tp-gnomeをインストール。依存関係でnetwork-manager-l2tpやxl2tpdも入ります。</p>
<pre><code class="language-console" data-lang="console">sudo apt install -y network-manager-l2tp-gnome
</code></pre><p>xl2tpdはVPN接続するときに起動されるのでOS起動時に起動しないようにしておきます。</p>
<pre><code class="language-console" data-lang="console">sudo systemctl stop xl2tpd
sudo systemctl disable xl2tpd
</code></pre><h2 id="vpn">VPN設定を追加</h2>
<ol>
<li>「設定」→「ネットワーク」→「VPN」の右上の「＋」ボタンを押します。</li>
</ol>
<p>.. image:: {attach}/images/2018/03/31/l2tp-vpn-on-ubuntu-17.10/start-adding-vpn.png
:width: 490px
:height: 355px
:alt: start adding vpn</p>
<ol start="2">
<li>「VPNの追加」ダイアログで「Layer 2 Tunneling Protocol (L2TP)」を選択します。</li>
</ol>
<p>.. image:: {attach}/images/2018/03/31/l2tp-vpn-on-ubuntu-17.10/select-l2tp-protocol.png
:width: 500px
:height: 341px
:alt: select l2tp</p>
<ol start="3">
<li>
<p>「VPNの追加」ダイアログの「Identity」タブの項目設定</p>
<ul>
<li>名前: (任意)</li>
<li>ゲートウェイ: 接続先のホスト名</li>
<li>ユーザー名: 接続に必要なユーザ名</li>
<li>パスワード: 空のまま</li>
</ul>
</li>
</ol>
<p>.. image:: {attach}/images/2018/03/31/l2tp-vpn-on-ubuntu-17.10/vpn-identity.png
:width: 556px
:height: 409px
:alt: vpn identity</p>
<ol start="4">
<li>
<p>「VPNの追加」ダイアログの「IPSec Settings」ボタンを押して以下の項目を設定。</p>
<ul>
<li>「Enable IPsec tunnel to L2TP host」チェックボックスをオン。</li>
<li>Pre-shared keyに接続先で設定されている事前共有キーの値を設定。</li>
<li>「Advanced」を展開して「Phase1 Algorithms」に aes256-sha1-modp1536 と設定。アルゴリズムの設定値の調べ方については後述。</li>
</ul>
</li>
</ol>
<p>.. image:: {attach}/images/2018/03/31/l2tp-vpn-on-ubuntu-17.10/ipsec-options.png
:width: 364px
:height: 333px
:alt: ipsec options</p>
<ol start="5">
<li>
<p>「VPNの追加」ダイアログの「PPP Settings」ボタンを押して以下の項目を設定。</p>
<ol>
<li>「MPPE暗号を使用する」チェックボックスをオン。</li>
<li>認証方式の「MSCHAP」と「MSCHAPｖ２」の2つのみがチェックされた状態になるので「MSCHAP」のチェックを外す。</li>
<li>「PPP Echoパケットを送信する」チェックボックスをオン（これは絶対に必要かは不明ですが試行錯誤した感じではオンにしたほうが良さそうな感じ）。</li>
</ol>
</li>
</ol>
<p>2018-05-06追記。その後他の環境やUbuntu 18.04でもVPN接続の設定を試した感じでは「PPP Echoパケットを送信する」は不要なようでした。</p>
<p>.. image:: {attach}/images/2018/03/31/l2tp-vpn-on-ubuntu-17.10/ppp-options.png
:width: 401px
:height: 669px
:alt: ppp options</p>
<ol start="6">
<li>
<p>Ubuntuを再起動。</p>
<ul>
<li>再起動は不要かもしれませんが、何回か試行錯誤したときの挙動にばらつきがあったので、確実にするために再起動しておきます。</li>
</ul>
</li>
</ol>
<h1 id="vpn-1">VPN接続の手順</h1>
<ol>
<li>
<p>パスワードマネージャ KeePassX で接続先の自分のユーザー名に対応するパスワードをコピーします。</p>
</li>
<li>
<p>デスクトップ右上のWifiのアイコンをクリックし、「VPNオフ」メニューを展開して「接続」のメニューを選択。</p>
</li>
</ol>
<p>.. image:: {attach}/images/2018/03/31/l2tp-vpn-on-ubuntu-17.10/start-connecting.png
:width: 387px
:height: 462px
:alt: start connecting</p>
<ol start="3">
<li>パスワードダイアログがモーダルで表示されるのでコピーしておいたパスワードをペースト。</li>
</ol>
<p>接続中</p>
<p>.. image:: {attach}/images/2018/03/31/l2tp-vpn-on-ubuntu-17.10/connecting.png
:width: 456px
:height: 80px
:alt: connecting</p>
<p>接続完了</p>
<p>.. image:: {attach}/images/2018/03/31/l2tp-vpn-on-ubuntu-17.10/connected.png
:width: 405px
:height: 84px
:alt: connected</p>
<h1 id="vpn-2">VPN切断の手順</h1>
<ol>
<li>デスクトップ右上のVPNのアイコンをクリックし、上記設定で追加したVPN名のメニューを展開して「オフにする」メニューを選択。</li>
</ol>
<p>.. image:: {attach}/images/2018/03/31/l2tp-vpn-on-ubuntu-17.10/start-disconnecting.png
:width: 366px
:height: 469px
:alt: start disconnecting</p>
<ol start="2">
<li>デスクトップ右上のVPN接続のアイコンが消えたら切断完了ですが、ウェブブラウザでインターネットのどこかのサイトを開いてアクセスできない場合Wifiを一旦オフにしてからオンにします。</li>
</ol>
<p>2018-05-06追記。Wifiを一旦オフにしてからオンにするよりはマシな回避策を見つけました。 <a href="/blog/2018/05/06/workaround-to-get-dns-working-after-vpn-disconnection-on-ubuntu-18.04/">Ubuntu 18.04でVPN切断後にホスト名解決が動くようにするための回避策</a></p>
<h1 id="heading-3">デバッグ</h1>
<h2 id="heading-4">接続のデバッグ</h2>
<p>接続がうまく行かないときは
<a href="https://github.com/nm-l2tp/network-manager-l2tp#debian-and-ubuntu">network-manager-l2tpのDebuggingのDebian and Ubuntuの手順</a>
でデバッグします。</p>
<pre><code class="language-console" data-lang="console">sudo killall -TERM nm-l2tp-service
sudo /usr/lib/NetworkManager/nm-l2tp-service --debug
</code></pre><p>例えば上記の「PPP Echoパケットを送信する」チェックボックスをオンにしていなかったときは以下のようなエラーが出ていました。</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">xl2tpd[3698]: control_finish: sending ICRQ
xl2tpd[3698]: check_control: Received out of order control packet on tunnel 61298 (got 0, expected 1)
xl2tpd[3698]: handle_packet: bad control packet!
xl2tpd[3698]: network_thread: bad packet
</code></pre></div><p>2018-05-06追記。接続のデバッグは上記の手順以外に、以下のコマンドでjournaldのログを見るのでも十分でした。</p>
<pre><code class="language-console" data-lang="console">journalctl -f
</code></pre><h2 id="ipsec">IPsecのアルゴリズムのスキャン</h2>
<p>IPsec Optionsダイアログに設定したAlgorithmは以下のようにして検出しました。</p>
<ol>
<li>ike-scan パッケージをインストール</li>
</ol>
<pre><code class="language-console" data-lang="console">sudo apt install -y ike-scan
</code></pre><ol start="2">
<li>
<p>検出用スクリプトを作成</p>
<p><a href="https://github.com/nm-l2tp/network-manager-l2tp/wiki/Known-Issues#querying-vpn-server-for-its-ikev1-algorithm-proposals">https://github.com/nm-l2tp/network-manager-l2tp/wiki/Known-Issues#querying-vpn-server-for-its-ikev1-algorithm-proposals</a></p>
<p>以下のスクリプトを ike-scan.sh という名前で保存。</p>
</li>
</ol>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span> 
<span class="c1"># Encryption algorithms: 3des=5, aes128=7/128, aes192=7/192, aes256=7/256</span>
<span class="nv">ENCLIST</span><span class="o">=</span><span class="s2">&#34;5 7/128 7/192 7/256&#34;</span>
<span class="c1"># Hash algorithms: md5=1, sha1=2, sha256=5, sha384=6, sha512=7</span>
<span class="nv">HASHLIST</span><span class="o">=</span><span class="s2">&#34;1 2 5 6 7&#34;</span>
<span class="c1"># Diffie-Hellman groups: 1, 2, 5, 14, 15, 19, 20, 21</span>
<span class="nv">GROUPLIST</span><span class="o">=</span><span class="s2">&#34;1 2 5 14 15 19 20 21&#34;</span>
<span class="c1"># Authentication method: Preshared Key=1</span>
<span class="nv">AUTH</span><span class="o">=</span><span class="m">1</span>
 
<span class="k">for</span> ENC in <span class="nv">$ENCLIST</span><span class="p">;</span> <span class="k">do</span>
   <span class="k">for</span> HASH in <span class="nv">$HASHLIST</span><span class="p">;</span> <span class="k">do</span>
       <span class="k">for</span> GROUP in <span class="nv">$GROUPLIST</span><span class="p">;</span> <span class="k">do</span>
	  <span class="nb">echo</span> ike-scan --trans<span class="o">=</span><span class="nv">$ENC</span>,<span class="nv">$HASH</span>,<span class="nv">$AUTH</span>,<span class="nv">$GROUP</span> -M <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
	  ike-scan --trans<span class="o">=</span><span class="nv">$ENC</span>,<span class="nv">$HASH</span>,<span class="nv">$AUTH</span>,<span class="nv">$GROUP</span> -M <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
      <span class="k">done</span>
   <span class="k">done</span>
<span class="k">done</span>
</code></pre></div><ol start="3">
<li>実行パーミションを付与。</li>
</ol>
<pre><code class="language-console" data-lang="console">chmod +x ike-scan.sh
</code></pre><p>LT2Pの接続先を引数に指定して実行し、利用可能なアルゴリズム一覧を表示。下記の「接続先のホスト」は実際のホスト名に置き換えてください。</p>
<pre><code class="language-console" data-lang="console">./ike-scan.sh 接続先のホスト | grep 'SA='
</code></pre><p>実行例は以下の通りです。</p>
<pre><code class="language-console" data-lang="console">$ ./scan-vpn-algo 接続先のホスト | grep 'SA='
	SA=(Enc=3DES Hash=SHA1 Auth=PSK Group=2:modp1024 LifeType=Seconds LifeDuration(4)=0x00007080)
	SA=(Enc=3DES Hash=SHA1 Auth=PSK Group=5:modp1536 LifeType=Seconds LifeDuration(4)=0x00007080)
	SA=(Enc=AES Hash=SHA1 Auth=PSK Group=2:modp1024 KeyLength=256 LifeType=Seconds LifeDuration(4)=0x00007080)
	SA=(Enc=AES Hash=SHA1 Auth=PSK Group=5:modp1536 KeyLength=256 LifeType=Seconds LifeDuration(4)=0x00007080)
</code></pre><p>上記の内容をIPsec Optionsにフルで指定する場合は以下のように書くことになります。</p>
<ul>
<li>Phase1 Algorithms: aes256-sha1-modp1536,aes256-sha1-modp1024</li>
<li>Phase2 Algorithms: 3des-sha1-modp1536,3des-sha1-modp1024</li>
</ul>
<p>ですが、わざわざ弱いアルゴリズムを指定する必要もないので、上記では一番強い aes256-sha1-modp1536 のみを指定する手順としました。</p>

</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-53263855-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
