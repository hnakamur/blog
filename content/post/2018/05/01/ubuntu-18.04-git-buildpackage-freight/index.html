<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja-JP" lang="ja-JP">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.61.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Ubuntu 18.04でgit-buildpackageとfreightを使うときのメモ &middot; hnakamur&#39;s blog at github</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://hnakamur.github.io/blog/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://hnakamur.github.io/blog/"><h1>hnakamur&#39;s blog at github</h1></a>
      <p class="lead">
       my tech memo 
      </p>
      <p>powered by <a href="http://gohugo.io">Hugo</a></p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        
      </ul>
    </nav>

    <p>&copy; 2019. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>Ubuntu 18.04でgit-buildpackageとfreightを使うときのメモ</h1>
  <time datetime=2018-05-01T12:35:00&#43;0900 class="post-date">2018-05-01</time>
  <h2 id="heading">はじめに</h2>
<ul>
<li><a href="/blog/2017/07/05/how-to-build-deb-with-git-buildpackage/">git-buildpackageでdebパッケージをビルドしてPPAにアップロードする手順</a></li>
<li><a href="/blog/2017/08/05/create-private-deb-repository-with-freight/">freightでプライベートdebレポジトリ作成</a></li>
<li><a href="/blog/2017/08/28/use-passphrase-file-in-git-buildpackage-and-freight/">git-buildpacakgeとfreightでパスフレーズをファイルから入力させる</a></li>
</ul>
<p>に書いた git-buildpackage と freight の環境を Ubuntu 18.04 でも作ったのですが、少し変更が必要だったのでメモです。</p>
<h2 id="gbp-buildpacakge-d">gbp buildpacakgeには-dオプションを指定</h2>
<p>Ubuntu 16.04 のときには以下のコマンドでソースパッケージをビルドしていました。</p>
<pre><code class="language-console" data-lang="console">gbp buildpackage --git-export-dir=../build-area -p/home/hnakamur/bin/gpg-passphrase -S -sa
</code></pre><p>が、Ubuntu 18.04ではgit-buildpackageのバージョンが変わった影響で <code>gbp buildpackage</code> でのソースパッケージの作成時にdebパッケージの依存関係のエラーが出るようになりました。</p>
<p>調べてみたところ <code>gbp</code> が呼び出している <code>dpkg-buildpackage</code> に依存関係をチェックする <code>-D</code> オプションとチェックしない <code>-d</code> オプションがあることがわかりました。</p>
<p><a href="http://manpages.ubuntu.com/manpages/bionic/en/man1/dpkg-buildpackage.1.html">Ubuntu Manpage: dpkg-buildpackage - build binary or source packages from sources</a></p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">-D, --check-builddeps
       Check build dependencies and conflicts; abort if unsatisfied (long option since dpkg 1.18.8).  This is the default behavior.

-d, --no-check-builddeps
       Do not check build dependencies and conflicts (long option since dpkg 1.18.8).
</code></pre></div><p>Ubuntu 16.04 で gbp buildpackage を実行していたときは dpkg-buildpackage を呼ぶ時に -d が指定されていましたが、Ubuntu 18.04 では指定されなくなっていました。 gbp buildpackage のソースを見るとオプションを指定するとそのまま dpkg-buildpackage に渡すようになっていました。</p>
<p>ということで以下のように -d を指定することで解決しました。</p>
<pre><code class="language-console" data-lang="console">gbp buildpackage --git-export-dir=../build-area -p/home/hnakamur/bin/gpg-passphrase -S -sa -d
</code></pre><h2 id="gnupg-2x">GnuPG 2.xでパスフレーズをファイルから読み込ませるための対応</h2>
<p>Ubuntu 16.04では /usr/bin/gpg は gnupg という GnuPG 1.x のパッケージに含まれる実行ファイルでした。
で gnupg2 という GnuPG 2.x のパッケージの実行ファイルは /usr/bin/gpg2 という名前でした。</p>
<pre><code class="language-console" data-lang="console">$ ls -l /usr/bin/gpg{,2}
-rwxr-xr-x 1 root root 1008632 Aug 18  2016 /usr/bin/gpg
-rwxr-xr-x 1 root root  917032 Apr  8  2016 /usr/bin/gpg2
</code></pre><p>.. code-block:: console</p>
<pre><code>    $ dpkg -l gnupg gnupg2 gnupg-agent
    Desired=Unknown/Install/Remove/Purge/Hold
    | Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
    |/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
    ||/ Name                    Version          Architecture     Description
    +++-=======================-================-================-====================================================
    ii  gnupg                   1.4.20-1ubuntu3. amd64            GNU privacy guard - a free PGP replacement
    ii  gnupg-agent             2.1.11-6ubuntu2  amd64            GNU privacy guard - cryptographic agent
    ii  gnupg2                  2.1.11-6ubuntu2  amd64            GNU privacy guard - a free PGP replacement (new v2.x
</code></pre>
<p>Ubuntu 18.04では /usr/bin/gpg は gnupg2 パッケージのファイルになり、gnupg1 パッケージの実行ファイルは /usr/bin/gpg1 という名前に変えられています。また、 /usr/bin/gpg2 は /usr/bin/gpg へのシンボリックリンクになりました。</p>
<pre><code class="language-console" data-lang="console">$ ls -l /usr/bin/gpg{,1,2}
-rwxr-xr-x 1 root root 1021480 Jan 11 22:33 /usr/bin/gpg
-rwxr-xr-x 1 root root  889720 Nov 11 23:41 /usr/bin/gpg1
lrwxrwxrwx 1 root root       3 Jan 11 22:33 /usr/bin/gpg2 -&gt; gpg
</code></pre><p>.. code-block:: console</p>
<pre><code>    $ dpkg -l gnupg gnupg2 gnupg1
    Desired=Unknown/Install/Remove/Purge/Hold
    | Status=Not/Inst/Conf-files/Unpacked/halF-conf/Half-inst/trig-aWait/Trig-pend
    |/ Err?=(none)/Reinst-required (Status,Err: uppercase=bad)
    ||/ Name                    Version          Architecture     Description
    +++-=======================-================-================-====================================================
    ii  gnupg                   2.2.4-1ubuntu1   amd64            GNU privacy guard - a free PGP replacement
    ii  gnupg1                  1.4.22-3ubuntu2  amd64            GNU privacy guard - a PGP implementation (deprecated
    ii  gnupg2                  2.2.4-1ubuntu1   all              GNU privacy guard - a free PGP replacement (dummy tr
</code></pre>
<p>GnuPG 2.xでは
<a href="/blog/2017/08/28/use-passphrase-file-in-git-buildpackage-and-freight/">git-buildpacakgeとfreightでパスフレーズをファイルから入力させる</a>
に書いた <code>--passphrase-fd</code> を使った手法はそのままでは使えませんでした。</p>
<p>ArchWikiのGnuPGのページの <a href="https://wiki.archlinux.org/index.php/GnuPG#Unattended_passphrase">Unattended passphrase</a>  に回避策が書かれていました。元のオプションに <code>--pinentry-mode loopback</code> を追加すれば良いとのことです。</p>
<h4 id="gbp-buildpackage-p">gbp buildpackageの-pオプションに指定するファイルの修正</h4>
<pre><code class="language-console" data-lang="console">gbp buildpackage --git-export-dir=../build-area -p/home/hnakamur/bin/gpg-passphrase -S -sa -d
</code></pre><p>の -p オプションで指定している /home/hnakamur/bin/gpg-passphrase の中身は以下のように書き換えました。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="nb">exec</span> &lt;/home/hnakamur/.gpg-passphrase /usr/bin/gpg --batch --pinentry-mode loopback --passphrase-fd <span class="m">0</span> <span class="s2">&#34;</span><span class="nv">$@</span><span class="s2">&#34;</span>
</code></pre></div><h4 id="fright-p">frightの-pオプションを使うには修正が必要</h4>
<p>freightのほうはfreightのソースを変更する必要があったので、変更してプルリクエストを送りました。
<a href="https://github.com/freight-team/freight/pull/84">Support gpg2 in freight cache passphrase file option by hnakamur · Pull Request #84 · freight-team/freight</a>
（2018-05-29追記。マージされました！）</p>
<p>この変更を加えた状態ですと、以前と同じ以下のコマンドでOKです。</p>
<pre><code class="language-console" data-lang="console">sudo freight cache -p /home/hnakamur/.gpg-passphrase
</code></pre>
</div>


    </main>

    
  </body>
</html>
