<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Posts on hnakamur&#39;s blog at github</title>
    <link>/blog/post/</link>
    <description>Recent content in Posts on hnakamur&#39;s blog at github</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja-JP</language>
    <lastBuildDate>Mon, 15 Jun 2015 20:24:16 +0900</lastBuildDate>
    <atom:link href="/blog/post/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Cybozu Garoon APIのファイル管理の部分だけのgoライブラリを書いた</title>
      <link>/blog/2015/06/15/garoon_go_client/</link>
      <pubDate>Mon, 15 Jun 2015 20:24:16 +0900</pubDate>
      
      <guid>/blog/2015/06/15/garoon_go_client/</guid>
      <description>

&lt;h1 id=&#34;はじめに:3036273db89ecc435ad43fdf2cd8cfa3&#34;&gt;はじめに&lt;/h1&gt;

&lt;p&gt;Cybozu &lt;a href=&#34;https://cybozudev.zendesk.com/hc/ja/categories/200157760-Garoon-API&#34;&gt;Garoon API&lt;/a&gt;のファイル管理のうち、フォルダ一覧取得、フォルダ内のファイル一覧取得、ファイルダウンロードのAPIを呼び出すライブラリをGoで書いてみました。&lt;/p&gt;

&lt;p&gt;ただし、汎用的なライブラリではなく、自分が必要な機能のみを実装しています。レスポンスの中の項目も自分が必要な部分だけ取り出して残りは破棄しています。
&lt;a href=&#34;http://blog.sigbus.info/2015/01/p1.html&#34;&gt;sigbus.info: コードを書くことは無限の可能性を捨てて一つのやり方を選ぶということ&lt;/a&gt;を読んでから、汎用性をあまり気にせず自分の用途に合わせて書くようになって楽で良いです。&lt;/p&gt;

&lt;h1 id=&#34;実装方法についてのメモ:3036273db89ecc435ad43fdf2cd8cfa3&#34;&gt;実装方法についてのメモ&lt;/h1&gt;

&lt;p&gt;まず、Garoon APIの手動での呼び出し方は&lt;a href=&#34;http://qiita.com/yamasaki-masahide/items/fff1c84e65043ac4caf7&#34;&gt;garoon - Cybozu ガルーン API を使ってみる - Qiita&lt;/a&gt;を参考にして試してみました。&lt;/p&gt;

&lt;h2 id=&#34;リクエストのxml組み立て:3036273db89ecc435ad43fdf2cd8cfa3&#34;&gt;リクエストのXML組み立て&lt;/h2&gt;

&lt;p&gt;Garoon APIはSOAPなので、リクエストやレスポンスはXMLになります。&lt;/p&gt;

&lt;p&gt;リクエストを送るところは&lt;a href=&#34;http://qiita.com/yamasaki-masahide/items/03dfa6cd70ff20607b58&#34;&gt;Cybozu ガルーン API を golang で叩いてみる - Qiita&lt;/a&gt;を見たのですが、&lt;a href=&#34;http://qiita.com/ono_matope/items/70080cc33b75152c5c2a&#34;&gt;Goのencoding/xmlを使いこなす - Qiita&lt;/a&gt;を参考にMarshalXMLを実装する方式にしてみました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://golang.org/pkg/encoding/xml/#Marshaler&#34;&gt;xml.Marshaler&lt;/a&gt;の &lt;code&gt;MarshalXML(e *Encoder, start StartElement) error&lt;/code&gt; は &lt;code&gt;start&lt;/code&gt; をエンコードするのが本来の使い方だとは思うのですが、下記の例のように &lt;code&gt;CabinetGetFolderInfo&lt;/code&gt; といったリクエスト本体を渡すと &lt;code&gt;soap:Envelope&lt;/code&gt; でラップしてエンコードしてくれる方が使うときに楽なので、 &lt;code&gt;MarshalXML&lt;/code&gt; 内でデータ構造を組み立ててエンコードするようにしてみました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;lt;soap:Envelope xmlns:soap=&amp;quot;http://www.w3.org/2003/05/soap-envelope&amp;quot;&amp;gt;
  &amp;lt;soap:Header&amp;gt;
    &amp;lt;Action&amp;gt;CabinetGetFolderInfo&amp;lt;/Action&amp;gt;
    &amp;lt;Security&amp;gt;
      &amp;lt;UsernameToken&amp;gt;
        &amp;lt;Username&amp;gt;foo&amp;lt;/Username&amp;gt;
        &amp;lt;Password&amp;gt;password&amp;lt;/Password&amp;gt;
      &amp;lt;/UsernameToken&amp;gt;
    &amp;lt;/Security&amp;gt;
    &amp;lt;Timestamp&amp;gt;
      &amp;lt;Created&amp;gt;2010-08-12T14:45:00Z&amp;lt;/Created&amp;gt;
      &amp;lt;Expires&amp;gt;2037-08-12T14:45:00Z&amp;lt;/Expires&amp;gt;
    &amp;lt;/Timestamp&amp;gt;
    &amp;lt;Locale&amp;gt;jp&amp;lt;/Locale&amp;gt;
  &amp;lt;/soap:Header&amp;gt;
  &amp;lt;soap:Body&amp;gt;
    &amp;lt;CabinetGetFolderInfo&amp;gt;
      &amp;lt;parameters&amp;gt;&amp;lt;/parameters&amp;gt;
    &amp;lt;/CabinetGetFolderInfo&amp;gt;
  &amp;lt;/soap:Body&amp;gt;
&amp;lt;/soap:Envelope&amp;gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;soap:Envelope&lt;/code&gt; でラップした構造を作るところは、&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/request.go#L44-L62&#34;&gt;https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/request.go#L44-L62&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;
func buildRequestStruct(h RequestHeader, apiName string, parameters interface{}) envelope {
	return envelope{
		Xmlns: &amp;quot;http://www.w3.org/2003/05/soap-envelope&amp;quot;,
		Header: header{
			Action:   apiName,
			Username: h.Username,
			Password: h.Password,
			Created:  h.Created,
			Expires:  h.Expires,
			Locale:   h.Locale,
		},
		Body: body{
			Content: bodyContent{
				XMLName:    xml.Name{Local: apiName},
				Parameters: parameters,
			},
		},
	}
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で共通処理として実装し、各API用のリクエストの構造体では&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/cabinet.go#L16-L26&#34;&gt;https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/cabinet.go#L16-L26&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;type CabinetGetFolderInfoRequest struct {
	Header RequestHeader
}

func (r CabinetGetFolderInfoRequest) MarshalXML(e *xml.Encoder, start xml.StartElement) error {
	return e.Encode(buildRequestStruct(
		r.Header,
		&amp;quot;CabinetGetFolderInfo&amp;quot;,
		struct{}{},
	))
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のようにして呼び出しています。&lt;/p&gt;

&lt;p&gt;また、日時の項目は構造体側では &lt;code&gt;time.Time&lt;/code&gt; にしたいところですが、&lt;a href=&#34;https://code.google.com/p/go/issues/detail?id=2771#c2&#34;&gt;Issue 2771 - go - encoding/xml: MarshalXML interface is not good enough - The Go Programming Language - Google Project Hosting&lt;/a&gt;の&lt;a href=&#34;https://code.google.com/p/go/issues/detail?id=2771#c2&#34;&gt;コメント#2&lt;/a&gt;を読んで &lt;code&gt;string&lt;/code&gt; にしました。&lt;/p&gt;

&lt;h2 id=&#34;レスポンスのパース処理:3036273db89ecc435ad43fdf2cd8cfa3&#34;&gt;レスポンスのパース処理&lt;/h2&gt;

&lt;p&gt;レスポンスのパースは&lt;a href=&#34;http://qiita.com/yamasaki-masahide/items/f20a2ca4700e00777303&#34;&gt;Cybozu ガルーン API のレスポンスのXMLを golang でパースする - Qiita&lt;/a&gt;を見たのですが、&lt;a href=&#34;http://blog.davidsingleton.org/parsing-huge-xml-files-with-go/&#34;&gt;Parsing huge XML files with Go - david singleton&lt;/a&gt;の方法のほうが楽なのでこちらを参考にしました。&lt;/p&gt;

&lt;p&gt;共通のユーテリティ関数としては
&lt;a href=&#34;https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/response.go&#34;&gt;https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/response.go&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;var ResponseTagNotFoundError = errors.New(&amp;quot;response tag not found&amp;quot;)

func parseResponse(r io.Reader, localName string, v interface{}) error {
	decoder := xml.NewDecoder(r)
	for {
		t, _ := decoder.Token()
		if t == nil {
			break
		}
		switch se := t.(type) {
		case xml.StartElement:
			if se.Name.Local == localName {
				return decoder.DecodeElement(v, &amp;amp;se)
			}
		}
	}
	return ResponseTagNotFoundError
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のように定義して、&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/cabinet.go#L115-L127&#34;&gt;https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/cabinet.go#L115-L127&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;func parseCabinetGetFolderInfoResponse(r io.Reader) (*CabinetGetFolderInfoResponse, error) {
	exclude := NewExclude(func(b byte) bool {
		return b == 0x08 || b == 0x0B
	})
	r2 := transform.NewReader(r, exclude)
	var resp CabinetGetFolderInfoResponse
	err := parseResponse(r2, &amp;quot;CabinetGetFolderInfoResponse&amp;quot;, &amp;amp;resp)
	if err != nil {
		return nil, err
	}
	resp.fillPath()
	return &amp;amp;resp, err
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;という感じで呼び出しています。&lt;/p&gt;

&lt;h2 id=&#34;レスポンスからu-0008などの制御文字を除去:3036273db89ecc435ad43fdf2cd8cfa3&#34;&gt;レスポンスからU+0008などの制御文字を除去&lt;/h2&gt;

&lt;p&gt;あと、レスポンスのXMLをそのまま&lt;a href=&#34;http://golang.org/pkg/encoding/xml/#Decoder&#34;&gt;xml.Decoder&lt;/a&gt;に渡すとUTF-8の不正なバイト列といったエラーが出ました。U+0008やU+000Bというデータが入っていたので、これを除去するようにしました。&lt;/p&gt;

&lt;p&gt;日本語の文字コード変換用のライブラリ&lt;a href=&#34;https://godoc.org/golang.org/x/text/encoding/japanese&#34;&gt;golang.org/x/text/encoding/japanese&lt;/a&gt;で使っているインターフェース&lt;a href=&#34;https://godoc.org/golang.org/x/text/transform#Transformer&#34;&gt;golang.org/x/text/transform/Transformer&lt;/a&gt;に合わせて実装しました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/cabinet.go#L28-L50&#34;&gt;https://github.com/hnakamur/garoonclient/blob/d8aceb8ae09c6094dd65a1623fc99ca89a1ccebd/cabinet.go#L28-L50&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;type exclude struct {
	transform.NopResetter
	excluder func(byte) bool
}

func NewExclude(excluder func(byte) bool) transform.Transformer {
	return exclude{excluder: excluder}
}

func (e exclude) Transform(dst, src []byte, atEOF bool) (nDst, nSrc int, err error) {
	for nSrc = 0; nSrc &amp;lt; len(src); nSrc++ {
		b := src[nSrc]
		if !e.excluder(b) {
			if nDst &amp;gt;= len(dst) {
				err = transform.ErrShortDst
				return
			}
			dst[nDst] = b
			nDst++
		}
	}
	return
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;利用するときは&lt;a href=&#34;https://godoc.org/golang.org/x/text/transform#NewReader&#34;&gt;golang.org/x/text/transform/NewReader&lt;/a&gt;を使います。&lt;/p&gt;

&lt;h1 id=&#34;まとめ:3036273db89ecc435ad43fdf2cd8cfa3&#34;&gt;まとめ&lt;/h1&gt;

&lt;p&gt;Cybozu Garoon APIの一部のクライアントライブラリをGoで実装しました。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;MarshalXMLを実装することで、構造体とXMLの構造がかなり違う場合でも、XMLに合わせて一々構造体を定義することなく楽に対応出来ました。&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://golang.org/pkg/encoding/xml/#Decoder.Token&#34;&gt;xml.DecoderのToken&lt;/a&gt;を使うことでXMLの一部だけをパースしました。&lt;/li&gt;
&lt;li&gt;制御文字除去の処理を&lt;a href=&#34;https://godoc.org/golang.org/x/text/transform#Transformer&#34;&gt;golang.org/x/text/transform/Transformer&lt;/a&gt;インタフェースに合わせて実装しました。&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
    <item>
      <title>mecab-ipadicでconfigure実行したらmatrix.defが無いというエラー</title>
      <link>/blog/2015/06/14/mecab-ipadic-matrix.def-missing/</link>
      <pubDate>Sun, 14 Jun 2015 16:40:05 +0900</pubDate>
      
      <guid>/blog/2015/06/14/mecab-ipadic-matrix.def-missing/</guid>
      <description>

&lt;h1 id=&#34;tl-dr:ab08cbd6b60f870d79d44f56fdfdead3&#34;&gt;TL;DR&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/taku910/mecab/tree/master/mecab-ipadic&#34;&gt;https://github.com/taku910/mecab/tree/master/mecab-ipadic&lt;/a&gt; を取得して
&lt;code&gt;./configure --with-charset=&amp;quot;utf-8&amp;quot;&lt;/code&gt; と実行したら
&lt;code&gt;configure: error: cannot find sources (matrix.def) in . or ..&lt;/code&gt; というエラーが出て困ってます。解決策を知っている方ぜひ教えてください。&lt;/p&gt;

&lt;h1 id=&#34;経緯と詳細な手順:ab08cbd6b60f870d79d44f56fdfdead3&#34;&gt;経緯と詳細な手順&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;https://sites.google.com/site/rmecab/&#34;&gt;rmecab&lt;/a&gt;をインストールしたくて、&lt;a href=&#34;http://rmecab.jp/wiki/index.php?RMeCab&#34;&gt;RMeCab - RとLinuxと&amp;hellip;&lt;/a&gt;に沿ってまずはMeCabをインストールしました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://ja.wikipedia.org/wiki/MeCab&#34;&gt;MeCab - Wikipedia&lt;/a&gt;によると公式サイトはsourceforge.netだったようですが、実際のページは&lt;a href=&#34;http://mecab.googlecode.com/svn/trunk/mecab/doc/index.html&#34;&gt;MeCab: Yet Another Part-of-Speech and Morphological Analyzer&lt;/a&gt;とgooglecodeにあり、ソースをダウンロードしようと探すと&lt;a href=&#34;https://code.google.com/hosting/moved?project=mecab&#34;&gt;Google Project Hosting&lt;/a&gt;とあり、githubに移ったようです。&lt;/p&gt;

&lt;p&gt;ということで&lt;a href=&#34;https://github.com/taku910/mecab&#34;&gt;taku910/mecab&lt;/a&gt;からソースを取得してビルドしてみました。確認した環境はOS X 10.10.3です。&lt;/p&gt;

&lt;p&gt;mecabのconfigureオプションは&lt;a href=&#34;http://rmecab.jp/wiki/index.php?RMeCab#content_1_2&#34;&gt;Mac OS X 版バイナリ のインストール方法&lt;/a&gt;の手順に合わせて &lt;code&gt;--with-charset=&amp;quot;utf8&amp;quot;&lt;/code&gt; をつけました。mecabは無事ビルド、インストール出来ました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;git clone https://github.com/taku910/mecab
cd mecab
./configure --with-charset=&amp;quot;utf8&amp;quot;
make
make check
sudo make install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;次はmecab-ipadicをビルドしようとしたのですが、configureでエラーになりました。configureのオプションは上記のリンクの「c. 辞書もインストールします」の説明に合わせて &lt;code&gt;--with-charset=&amp;quot;utf-8&amp;quot;&lt;/code&gt; をつけています。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cd ../mecab-ipadic
$ ./configure --with-charset=&amp;quot;utf-8&amp;quot;
configure: error: cannot find sources (matrix.def) in . or ..
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;matrix.defがどういうものか私は全く知らないのですが、mecab-jumandicにも同名のファイルがあったので、それを使ってビルドしてみたら通ることは通りました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ln -s ../mecab-jumandic/matrix.def
./configure --with-charset=&amp;quot;utf-8&amp;quot;
make
sudo make install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ただ、「すもももももももものうち」で試してみると「すもも」「も」の後の「もも」が正しく切り出せていません。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ mecab
すもももももももものうち
すもも  名詞,一般,*,*,*,*,すもも,スモモ,スモモ
も  助詞,係助詞,*,*,*,*,も,モ,モ
も  助詞,係助詞,*,*,*,*,も,モ,モ
も  助詞,係助詞,*,*,*,*,も,モ,モ
も  助詞,係助詞,*,*,*,*,も,モ,モ
も  助詞,係助詞,*,*,*,*,も,モ,モ
もの  名詞,非自立,一般,*,*,*,もの,モノ,モノ
うち  名詞,非自立,副詞可能,*,*,*,うち,ウチ,ウチ
EOS
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ということで、mecab-ipadicの正しいビルド方法をご存知のかたはぜひ教えてください！&lt;/p&gt;

&lt;p&gt;と書いてたら、イシュー立てるべきと気づいたので立てました。&lt;a href=&#34;https://github.com/taku910/mecab/issues/18&#34;&gt;mecab-ipadicでconfigure実行したらmatrix.defが無いというエラーが出る · Issue #18 · taku910/mecab&lt;/a&gt; ぜひそちらにコメントお願いします！&lt;/p&gt;

&lt;h1 id=&#34;2015-06-17追記:ab08cbd6b60f870d79d44f56fdfdead3&#34;&gt;2015-06-17追記&lt;/h1&gt;

&lt;p&gt;イシューにコメントを頂きました。
&lt;a href=&#34;https://github.com/taku910/mecab/issues/18#issuecomment-112474144&#34;&gt;https://github.com/taku910/mecab/issues/18#issuecomment-112474144&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;IPA辞書は &lt;a href=&#34;http://taku910.github.io/mecab/#download&#34;&gt;http://taku910.github.io/mecab/#download&lt;/a&gt;  からtarballをダウンロードするのが推奨とのことです。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Homebrewを辞めてMacPorts 2.3.3を入れてpkgngをビルドしてみた</title>
      <link>/blog/2015/06/11/tried_macports/</link>
      <pubDate>Thu, 11 Jun 2015 01:09:08 +0900</pubDate>
      
      <guid>/blog/2015/06/11/tried_macports/</guid>
      <description>

&lt;h1 id=&#34;はじめに:ad84efa08756126882b8b191ef8a11ed&#34;&gt;はじめに&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;https://twitter.com/shibu_jp/status/598332736638582785&#34;&gt;https://twitter.com/shibu_jp/status/598332736638582785&lt;/a&gt; と &lt;a href=&#34;http://gihyo.jp/admin/serial/01/bsd-yomoyama/0002&#34;&gt;第2回　パッケージ管理システム「pkg 1.5」と基本的な使い方：BSD界隈四方山話｜gihyo.jp … 技術評論社&lt;/a&gt;で、実験段階ですがOS Xもサポート対象となったという話を見て &lt;code&gt;pkg&lt;/code&gt; と &lt;code&gt;MacPorts&lt;/code&gt; をシームレスに組み合わせて使えるかが気になっていました。&lt;/p&gt;

&lt;p&gt;FreeBSDではpkgコマンドでバイナリパッケージをインストールし、Ports Collectionでソースからビルドというのが簡単にできるようになっているのですが、上記の記事によるとpkgとPorts Collectionがシームレスに連動しているそうです。&lt;/p&gt;

&lt;p&gt;なので、OS X上では &lt;code&gt;pkg&lt;/code&gt; と &lt;code&gt;MacPorts&lt;/code&gt; が連動するのかな、するといいなあ、と思って、まずは &lt;code&gt;MacPorts&lt;/code&gt; を試してみます。&lt;/p&gt;

&lt;p&gt;私はだいぶ前に MacPorts から Homebrew に切り替えていたので、MacPortsは久々に試します。&lt;/p&gt;

&lt;h2 id=&#34;確認した環境:ad84efa08756126882b8b191ef8a11ed&#34;&gt;確認した環境&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;MacBook Pro (Retina, Mid 2012)&lt;/li&gt;
&lt;li&gt;OS X Yosemite 10.10.3&lt;/li&gt;
&lt;/ul&gt;

&lt;h1 id=&#34;homebrewのアンインストール:ad84efa08756126882b8b191ef8a11ed&#34;&gt;Homebrewのアンインストール&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;http://qiita.com/UmedaTakefumi/items/dc52f008586cbf06582f&#34;&gt;Homebrewをアンインストールするには - Qiita&lt;/a&gt;を参考にといいつつ、いきなりバッサリ消すとなにかあったときに戻れないので、アンインストールはせずにHomebrewでインストールしたパッケージのサービスを停止して、/usr/localディレクトリを/usr/local.bakに退避しておくことにします。移行が無事完了したらアンインストールするということで。&lt;/p&gt;

&lt;p&gt;以下のコマンドを実行して~/Library/LaunchAgents/にシンボリックリンクを張ったサービスを停止・解除します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;for f in ~/Library/LaunchAgents/homebrew.*; do launchctl unload $f; done
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;/usr/localを/usr/local.bakに退避します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo mv /usr/local /usr/local.bak
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;macportsのインストール:ad84efa08756126882b8b191ef8a11ed&#34;&gt;MacPortsのインストール&lt;/h1&gt;

&lt;p&gt;MacPortsのバイナリパッケージをダウンロードしてインストールします。MacPorts-2.3.3-10.10-Yosemite.pkgをFinderでダブルクリックしてもいいのですが、将来スクリプトで自動化することを見据えて、OS Xの &lt;code&gt;installer&lt;/code&gt; コマンドでインストールしてみます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd ~/Downloads
curl -O https://distfiles.macports.org/MacPorts/MacPorts-2.3.3-10.10-Yosemite.pkg
sudo installer -pkg MacPorts-2.3.3-10.10-Yosemite.pkg -target /
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href=&#34;https://guide.macports.org/#installing.shell&#34;&gt;2.5.1. The Postflight Script&lt;/a&gt;の説明に従って、環境変数PATHとMANPATHの設定を追加します。以下はシェルはbashを使っていて~/.bash_profileに追加する場合の例です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;&#39;EOF&#39; &amp;gt;&amp;gt; ~/.bash_profile
export PATH=/opt/local/bin:/opt/local/sbin:$PATH
export MANPATH=/opt/local/share/man:$MANPATH
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以下のコマンドを実行して、上で追加した設定を有効にします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;exec $SHELL -l
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;portコマンドにPATHが通ったことを確認します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ which port
/opt/local/bin/port
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href=&#34;https://www.macports.org/install.php#pkg&#34;&gt;Mac OS X Package (.pkg) Installer&lt;/a&gt;の説明に従って、MacPorts自体のアップデートを行います。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo port -v selfupdate
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;出力の最後に以下のように表示されたので、既に最新版になっていたそうです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;---&amp;gt;  MacPorts base is already the latest version

The ports tree has been updated. To upgrade your installed ports, you should run
  port upgrade outdated
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記の説明によるとインストールしたportsをアップグレードするときは &lt;code&gt;ports upgrade outdated&lt;/code&gt; と実行すればよいそうです。&lt;/p&gt;

&lt;h1 id=&#34;pkgngをソースからビルド:ad84efa08756126882b8b191ef8a11ed&#34;&gt;pkgngをソースからビルド&lt;/h1&gt;

&lt;p&gt;FreeBSDのpkgはpkgngと呼ばれることもあります。&lt;a href=&#34;https://wiki.freebsd.org/pkgng&#34;&gt;pkgng - FreeBSD Wiki&lt;/a&gt;によるとngはNext Generationの略のようです。&lt;/p&gt;

&lt;p&gt;githubにソースレポジトリ &lt;a href=&#34;https://github.com/freebsd/pkg&#34;&gt;freebsd/pkg&lt;/a&gt;があったので、ソースからビルドして入れてみます。&lt;/p&gt;

&lt;p&gt;ホームディレクトリ直下にpkgディレクトリを作るようにして入れてみました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd
git clone https://github.com/freebsd/pkg
cd pkg
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;git tag&lt;/code&gt; で確認すると最新のリリースは 1.5.3 でしたので、それにしてみます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;git checkout 1.5.3
git checkout -b 1.5.3
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/freebsd/pkg#building-pkg-using-sources-from-git&#34;&gt;freebsd/pkg&lt;/a&gt;を参考にやってみました。この手順ではビルドに必要なパッケージをFreeBSDにインストール済みの古いバージョンの &lt;code&gt;pkg&lt;/code&gt; コマンドで入れていますが、OS Xの場合は無いのでMacPortsで入れます。&lt;/p&gt;

&lt;p&gt;また &lt;code&gt;pkgconf&lt;/code&gt; はMacPortsでは &lt;code&gt;pkgconfig&lt;/code&gt; という名前なのでそこも変えています。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo port install autoconf automake libtool pkgconfig
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;./autogen.sh
./configure
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;./configure&lt;/code&gt; が以下のようにエラーになってしまいました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;…(略)…
checking for library containing archive_read_open... -larchive
checking archive.h usability... no
checking archive.h presence... no
checking for archive.h... no
configure: error: Unable to find the libarchive headers
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;そこでlibarchiveをMacPortsでインストールしました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo port install libarchive
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;MacPortsでインストールしたパッケージを見つけてもらうため、&lt;a href=&#34;http://blog.francoismaillet.com/compile-against-libraries-installed-with-macports/&#34;&gt;Compile against libraries installed with MacPorts | Blog de François Maillet&lt;/a&gt;を参考に以下のようにオプションをつけて &lt;code&gt;./configure&lt;/code&gt; を再度実行しました。pkgのsrcディレクトリを見ると、pkgはC++ではなくCで実装されていますので、 &lt;code&gt;configure&lt;/code&gt; の引数もCPPFLAGSではなくCFLAGSにしています。
今度は &lt;code&gt;configure&lt;/code&gt; が成功しました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;./configure CFLAGS=&amp;quot;-I/opt/local/include&amp;quot; LDFLAGS=&amp;quot;-L/opt/local/lib&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;configure&lt;/code&gt; の次は &lt;code&gt;make&lt;/code&gt; を実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;make
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;1つ警告が出ました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;…(略)…
  CCLD     pkg-static
libtool: warning: complete static linking is impossible in this configuration
  CCLD     pkg
…(略)…
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;./configure --help&lt;/code&gt; してみると&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;  --with-staticonly       Only build the static version (default is no)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;というオプションがあり、デフォルトではスタティックリンクするバージョンとしないバージョンの両方を作るようになっているようです。&lt;/p&gt;

&lt;p&gt;とりあえずスタティックリンクしないバージョンはビルドできているのでとりあえず先に進みます。&lt;/p&gt;

&lt;p&gt;以下のコマンドを実行してインストールします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo make install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;/usr/localに以下のようなファイルとディレクトリが作られました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ find /usr/local
/usr/local
/usr/local/etc
/usr/local/etc/bash_completion.d
/usr/local/etc/bash_completion.d/_pkg.bash
/usr/local/etc/periodic
/usr/local/etc/periodic/daily
/usr/local/etc/periodic/daily/411.pkg-backup
/usr/local/etc/periodic/daily/490.status-pkg-changes
/usr/local/etc/periodic/security
/usr/local/etc/periodic/security/410.pkg-audit
/usr/local/etc/periodic/security/460.pkg-checksum
/usr/local/etc/periodic/weekly
/usr/local/etc/periodic/weekly/400.status-pkg
/usr/local/etc/pkg.conf.sample
/usr/local/include
/usr/local/include/pkg.h
/usr/local/lib
/usr/local/lib/libpkg.3.dylib
/usr/local/lib/libpkg.dylib
/usr/local/lib/libpkg.la
/usr/local/lib/libpkg_static.a
/usr/local/lib/libpkg_static.la
/usr/local/libdata
/usr/local/libdata/pkgconfig
/usr/local/libdata/pkgconfig/pkg.pc
/usr/local/man
/usr/local/man/man3
/usr/local/man/man3/pkg_printf.3
/usr/local/man/man3/pkg_repos.3
/usr/local/man/man5
/usr/local/man/man5/pkg-repository.5
/usr/local/man/man5/pkg.conf.5
/usr/local/man/man8
/usr/local/man/man8/pkg-add.8
/usr/local/man/man8/pkg-alias.8
/usr/local/man/man8/pkg-annotate.8
/usr/local/man/man8/pkg-audit.8
/usr/local/man/man8/pkg-autoremove.8
/usr/local/man/man8/pkg-backup.8
/usr/local/man/man8/pkg-check.8
/usr/local/man/man8/pkg-clean.8
/usr/local/man/man8/pkg-config.8
/usr/local/man/man8/pkg-convert.8
/usr/local/man/man8/pkg-create.8
/usr/local/man/man8/pkg-delete.8
/usr/local/man/man8/pkg-fetch.8
/usr/local/man/man8/pkg-info.8
/usr/local/man/man8/pkg-install.8
/usr/local/man/man8/pkg-lock.8
/usr/local/man/man8/pkg-query.8
/usr/local/man/man8/pkg-register.8
/usr/local/man/man8/pkg-remove.8
/usr/local/man/man8/pkg-repo.8
/usr/local/man/man8/pkg-rquery.8
/usr/local/man/man8/pkg-search.8
/usr/local/man/man8/pkg-set.8
/usr/local/man/man8/pkg-shell.8
/usr/local/man/man8/pkg-shlib.8
/usr/local/man/man8/pkg-ssh.8
/usr/local/man/man8/pkg-static.8
/usr/local/man/man8/pkg-stats.8
/usr/local/man/man8/pkg-unlock.8
/usr/local/man/man8/pkg-update.8
/usr/local/man/man8/pkg-updating.8
/usr/local/man/man8/pkg-upgrade.8
/usr/local/man/man8/pkg-version.8
/usr/local/man/man8/pkg-which.8
/usr/local/man/man8/pkg.8
/usr/local/sbin
/usr/local/sbin/pkg
/usr/local/sbin/pkg-static
/usr/local/sbin/pkg2ng
/usr/local/share
/usr/local/share/zsh
/usr/local/share/zsh/site-functions
/usr/local/share/zsh/site-functions/_pkg
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;pkgコマンドとpkg-staticコマンドは/usr/local/sbinにインストールされていました。
&lt;code&gt;otool -L&lt;/code&gt; で確認すると両方ともダイナミックリンクになっていました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ otool -L /usr/local/sbin/pkg
/usr/local/sbin/pkg:
        /usr/local/lib/libpkg.3.dylib (compatibility version 4.0.0, current version 4.0.0)
        /opt/local/lib/libssl.1.0.0.dylib (compatibility version 1.0.0, current version 1.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1213.0.0)
        /usr/lib/libutil.dylib (compatibility version 1.0.0, current version 1.0.0)
        /opt/local/lib/libcrypto.1.0.0.dylib (compatibility version 1.0.0, current version 1.0.0)
        /usr/lib/libresolv.9.dylib (compatibility version 1.0.0, current version 1.0.0)
        /opt/local/lib/libarchive.13.dylib (compatibility version 15.0.0, current version 15.2.0)
        /opt/local/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.8)
        /opt/local/lib/libbz2.1.0.dylib (compatibility version 1.0.0, current version 1.0.6)
        /opt/local/lib/liblzma.5.dylib (compatibility version 8.0.0, current version 8.1.0)
$ otool -L /usr/local/sbin/pkg-static
/usr/local/sbin/pkg-static:
        /usr/lib/libutil.dylib (compatibility version 1.0.0, current version 1.0.0)
        /opt/local/lib/libssl.1.0.0.dylib (compatibility version 1.0.0, current version 1.0.0)
        /opt/local/lib/libcrypto.1.0.0.dylib (compatibility version 1.0.0, current version 1.0.0)
        /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1213.0.0)
        /usr/lib/libresolv.9.dylib (compatibility version 1.0.0, current version 1.0.0)
        /opt/local/lib/libarchive.13.dylib (compatibility version 15.0.0, current version 15.2.0)
        /opt/local/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.8)
        /opt/local/lib/libbz2.1.0.dylib (compatibility version 1.0.0, current version 1.0.6)
        /opt/local/lib/liblzma.5.dylib (compatibility version 8.0.0, current version 8.1.0)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;/usr/local/sbinにはPATHが通っていなかったので、設定を変更して有効にしました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;echo &#39;export PATH=/usr/local/sbin:$PATH&#39; &amp;gt;&amp;gt; ~/.bash_profile
exec $SHELL -l
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;$ which pkg
/usr/local/sbin/pkg
$ pkg --version
1.5.3-cfa5423
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;というわけでビルドは出来ました。が OS X用のバイナリパッケージレポジトリの情報は見つけられず。&lt;/p&gt;

&lt;p&gt;pkgコマンドの使い方については&lt;a href=&#34;https://github.com/freebsd/pkg#a-quick-usage-introduction-to-pkg&#34;&gt;freebsd/pkg&lt;/a&gt;のREADMEに&lt;a href=&#34;https://github.com/freebsd/pkg#a-quick-usage-introduction-to-pkg&#34;&gt;A quick usage introduction to pkg&lt;/a&gt;というセクションがありました。&lt;/p&gt;

&lt;h1 id=&#34;情報収集中:ad84efa08756126882b8b191ef8a11ed&#34;&gt;情報収集中&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;https://news.ycombinator.com/item?id=8828866&#34;&gt;Baseline Mac OS X Support merged into FreeBSD package manager | Hacker News&lt;/a&gt;にいくつか有用な情報がありました。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://news.ycombinator.com/item?id=8829040&#34;&gt;This change was written by Landon Fuller, one of the founders of MacPorts. There&amp;hellip; | Hacker News&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;pkgngをOS X対応にするプルリクエスト &lt;a href=&#34;https://github.com/freebsd/pkg/pull/1113&#34;&gt;Baseline Mac OS X Support by landonf · Pull Request #1113 · freebsd/pkg&lt;/a&gt;はMacPorts創始者の1人によるもので、&lt;a href=&#34;https://github.com/freebsd/pkg/pull/1113#issuecomment-68063964&#34;&gt;Baseline Mac OS X Support by landonf · Pull Request #1113 · freebsd/pkg&lt;/a&gt;のコメントによるとMacPortsのtclで書いている部分をlibpkgを使って書き直すことが出来るかを模索するつもりらしいです。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://news.ycombinator.com/item?id=8829179&#34;&gt;You can already have that with pkgsrc for osx - joyent maintains the osx binary &amp;hellip; | Hacker News&lt;/a&gt;

&lt;ul&gt;
&lt;li&gt;このスレッドによるとpkgngがOS X対応する前から&lt;a href=&#34;http://pkgsrc.joyent.com/&#34;&gt;pkgsrc&lt;/a&gt;というパッケージ管理システムがあるそうです。Node.jsのJoyent, Inc.が作ってるんですね。&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.saveosx.org/&#34;&gt;saveosx&lt;/a&gt;にYosemite 64bit用のバイナリパッケージがあるようです。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ということで、今後どうなっていくか要注目です。&lt;/p&gt;

&lt;h1 id=&#34;2015-06-13追記-pkgsrcについて訂正:ad84efa08756126882b8b191ef8a11ed&#34;&gt;2015-06-13追記 pkgsrcについて訂正&lt;/h1&gt;

&lt;p&gt;&lt;a href=&#34;https://www.pkgsrc.org/&#34;&gt;pkgsrc&lt;/a&gt;自体はFreeBSDのportsからフォークしてNetBSDで開発されているもので、Joyent, Inc.が提供しているのはSmartOS/illumos, Mac OS X, and Linux用のバイナリバッケージでした。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://pkgsrc.joyent.com/&#34;&gt;pkgsrc&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://en.wikipedia.org/wiki/Pkgsrc&#34;&gt;pkgsrc - Wikipedia, the free encyclopedia&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;また &lt;a href=&#34;http://www.saveosx.org/&#34;&gt;saveosx&lt;/a&gt;は&lt;a href=&#34;https://github.com/cmacrae/saveosx&#34;&gt;cmacrae/saveosx&lt;/a&gt;を見るとOS X用のpkgsrcをインストールするためのスクリプトでした。パッケージ自体はJoyentが提供しているそうです。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>xhyveを試してみました</title>
      <link>/blog/2015/06/11/tried_xhyve/</link>
      <pubDate>Thu, 11 Jun 2015 00:45:38 +0900</pubDate>
      
      <guid>/blog/2015/06/11/tried_xhyve/</guid>
      <description>

&lt;p&gt;&lt;a href=&#34;http://www.pagetable.com/?p=831&#34;&gt;xhyve – Lightweight Virtualization on OS X Based on bhyve | pagetable.com&lt;/a&gt;に沿って試してみました。&lt;/p&gt;

&lt;h2 id=&#34;確認した環境:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;確認した環境&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;MacBook Pro (Retina, Mid 2012)&lt;/li&gt;
&lt;li&gt;OS X Yosemite 10.10.3&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;ソースからビルド:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;ソースからビルド&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;cd お好みの作業ディレクトリ
git clone https://github.com/mist64/xhyve
cd xhyve
make
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;tiny-core-linuxを起動:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;Tiny Core Linuxを起動&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;./xhyverun.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;起動メッセージが流れた後、画面がクリアされて以下のように表示されたら起動完了です。ここまで3〜4秒です。速い！&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;(�-
 //\   Core is distributed with ABSOLUTELY NO WARRANTY.
 v_/_           www.tinycorelinux.com

tc@box:~$ Switched to clocksource tsc
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;プロンプトにかぶってメッセージが出ていますが、enterを押せばプロンプトが出ます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tc@box:~$
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;シャットダウンするには以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo halt
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ubuntu-server-14-04-2のディスクイメージ作成:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;Ubuntu Server 14.04.2のディスクイメージ作成&lt;/h2&gt;

&lt;p&gt;Ubuntu ServerのISOイメージをダウンロードして、ディスクイメージを作成するための準備を行います。元記事によると、OS Xがハイブリッドファイルシステムを認識しないので、Linux kernelとinitrdを取り出しているそうです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir ubuntu
cd ubuntu
curl -O ftp://ftp.kddilabs.jp/Linux/packages/ubuntu/releases-cd/14.04.2/ubuntu-14.04.2-server-amd64.iso
dd if=/dev/zero bs=2k count=1 of=/tmp/tmp.iso
dd if=ubuntu-14.04.2-server-amd64.iso bs=2k skip=1 &amp;gt;&amp;gt; /tmp/tmp.iso
hdiutil attach /tmp/tmp.iso
cp /Volumes/Ubuntu-Server\ 14/install/vmlinuz .
cp /Volumes/Ubuntu-Server\ 14/install/initrd.gz .
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以下のコマンドでディスクイメージを作成します。ここでは &lt;code&gt;bs=1g count=8&lt;/code&gt; でディスクサイズを8GBとしていますが、お好みで調整してください。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;dd if=/dev/zero of=hdd.img bs=1g count=8
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;xhyve/ubuntuディレクトリではなくxhyveディレクトリにディスクイメージ作成用のスクリプトを作ります。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd ..
cat &amp;lt;&amp;lt;&#39;EOF&#39; &amp;gt; xhyverun_ubuntu_install.sh
#!/bin/sh

KERNEL=&amp;quot;ubuntu/vmlinuz&amp;quot;
INITRD=&amp;quot;ubuntu/initrd.gz&amp;quot;
CMDLINE=&amp;quot;earlyprintk=serial console=ttyS0 acpi=off&amp;quot;

MEM=&amp;quot;-m 1G&amp;quot;
#SMP=&amp;quot;-c 2&amp;quot;
NET=&amp;quot;-s 2:0,virtio-net&amp;quot;
IMG_CD=&amp;quot;-s 3,ahci-cd,ubuntu/ubuntu-14.04.2-server-amd64.iso&amp;quot;
IMG_HDD=&amp;quot;-s 4,virtio-blk,ubuntu/hdd.img&amp;quot;
PCI_DEV=&amp;quot;-s 0:0,hostbridge -s 31,lpc&amp;quot;
LPC_DEV=&amp;quot;-l com1,stdio&amp;quot;

build/xhyve $MEM $SMP $PCI_DEV $LPC_DEV $NET $IMG_CD $IMG_HDD -f kexec,$KERNEL,$INITRD,&amp;quot;$CMDLINE&amp;quot;
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;スクリプトに実行パーミションをつけてsudo付きで実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;chmod +x xhyverun_ubuntu_install.sh
sudo ./xhyverun_ubuntu_install.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;テキストインストーラが起動しますので、以下のように選択してインストールしました。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Select a language: English&lt;/li&gt;
&lt;li&gt;Select your location: other -&amp;gt; Asia -&amp;gt; Japan&lt;/li&gt;
&lt;li&gt;Configure locales: United Status - en_US.UTF-8&lt;/li&gt;
&lt;li&gt;Hostname: お好みの名前&lt;/li&gt;
&lt;li&gt;Set up users and passwords: お好みのIDとパスワードで作成&lt;/li&gt;
&lt;li&gt;time zone: Asia/Tokyo&lt;/li&gt;
&lt;li&gt;Partition disks: Guided - use entire disk&lt;/li&gt;
&lt;li&gt;HTTP proxy: 無し&lt;/li&gt;
&lt;li&gt;manage upgrades: No automatic updates&lt;/li&gt;
&lt;li&gt;Software selection:

&lt;ul&gt;
&lt;li&gt;Basic Ubuntu Server&lt;/li&gt;
&lt;li&gt;OpenSSH server&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Install GRUB to the master boot record: Yes&lt;/li&gt;
&lt;li&gt;Is the system clock set to UTC: No&lt;/li&gt;
&lt;li&gt;Installation complete: Go Back -&amp;gt; Execute a shell&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Installation completeのところでContinueではなくGo Backでメニューに戻りExecute a shellを選んで進み、シェルが起動したら以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd /target
sbin/ifconfig
tar c boot | nc -l -p 1234
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記のコマンド実行のうちsbin/ifconfigで表示されたIPアドレスをメモしておきます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/target # sbin/ifconfig
eth0      Link encap:Ethernet  HWaddr e6:0d:f2:6b:cf:32
          inet addr:192.168.64.3  Bcast:192.168.64.255  Mask:255.255.255.0
          inet6 addr: fe80::e40d:f2ff:fe6b:cf32/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:25405 errors:0 dropped:0 overruns:0 frame:85
          TX packets:13601 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:38179647 (38.1 MB)  TX bytes:931189 (931.1 KB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Mac側では以下のコマンドを実行します。IPアドレスはifconfigで表示されたものに置き換えて実行してください。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd ubuntu
nc 192.168.64.3 1234 | tar x
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;VMのシェルのプロンプトで以下のように入力してシェルを終了します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;exit
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;メニューに戻ったら &lt;code&gt;Finish the installation&lt;/code&gt; を選びます。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;Is the system clock set to UTC?: No&lt;/li&gt;
&lt;li&gt;Installation complete: Continue&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;ubuntu-server-14-04-2の起動:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;Ubuntu Server 14.04.2の起動&lt;/h2&gt;

&lt;p&gt;Macでxhyve/ubuntuではなくxhyveのディレクトリで起動用のスクリプトを作成します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;&#39;EOF&#39; &amp;gt; ./xhyverun_ubuntu.sh
#!/bin/sh

KERNEL=&amp;quot;ubuntu/boot/vmlinuz-3.16.0-30-generic&amp;quot;
INITRD=&amp;quot;ubuntu/boot/initrd.img-3.16.0-30-generic&amp;quot;
CMDLINE=&amp;quot;earlyprintk=serial console=ttyS0 acpi=off root=/dev/vda1 ro&amp;quot;

MEM=&amp;quot;-m 1G&amp;quot;
#SMP=&amp;quot;-c 2&amp;quot;
NET=&amp;quot;-s 2:0,virtio-net&amp;quot;
IMG_HDD=&amp;quot;-s 4,virtio-blk,ubuntu/hdd.img&amp;quot;
PCI_DEV=&amp;quot;-s 0:0,hostbridge -s 31,lpc&amp;quot;
LPC_DEV=&amp;quot;-l com1,stdio&amp;quot;

build/xhyve $MEM $SMP $PCI_DEV $LPC_DEV $NET $IMG_CD $IMG_HDD -f kexec,$KERNEL,$INITRD,&amp;quot;$CMDLINE&amp;quot;
EOF
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;スクリプトに実行パーミションをつけてsudo付きで実行してUbuntuを起動します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;chmod +x ./xhyverun_ubuntu.sh
sudo ./xhyverun_ubuntu.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;起動してログインプロンプトが出たらインストール時に作成したユーザでログインします。IPアドレスはDHCPで取得する設定にしたのですが、確認してみると、ディスクイメージ作成時とは違う値になっていました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ ip a s eth0
2: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 62:ca:c1:25:cf:32 brd ff:ff:ff:ff:ff:ff
    inet 192.168.64.4/24 brd 192.168.64.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::60ca:c1ff:fe25:cf32/64 scope link
       valid_lft forever preferred_lft forever
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Macからsshでログインも出来ました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh ubuntu@192.168.64.4
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;sshでログインすると初回だけ表示が24行に限定され、リターンを押しても24行の範囲でスクロールされるようになってしまいました。Mac側ではiTermで65行にしていました。と、この説明を書くためにiTermのウィンドウで高さを変えて行数を変えて戻してとやっていたら、次のsshログインからはiTermの行数で表示されるようになりました。&lt;/p&gt;

&lt;p&gt;Ubuntuを停止するにはVM内で以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo shutdown -h now
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ubuntuの起動に必要なファイル:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;Ubuntuの起動に必要なファイル&lt;/h2&gt;

&lt;p&gt;ubuntuフォルダにはビルドに使用したファイルも含まれていますが、起動スクリプトで参照されているファイル以外のファイルを別ディレクトリに移動して起動してみたら起動出来ました。ということで、起動には以下の4つのファイルだけあればOKです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;./xhyverun_ubuntu.sh
ubuntu/boot/initrd.img-3.16.0-30-generic
ubuntu/boot/vmlinuz-3.16.0-30-generic
ubuntu/hdd.img
&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;まとめ:dcbb8845ff06345c06bbfce39966bf55&#34;&gt;まとめ&lt;/h1&gt;

&lt;p&gt;xhyveをソースからビルドして、Tiny Core LinuxとUbuntu Server 14.04.2を動かしてみました。&lt;a href=&#34;https://github.com/mist64/xhyve#todo&#34;&gt;TODO&lt;/a&gt;によると、まだいろいろ対応予定の項目があるようです。今後が楽しみです！&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Go言語用のメモリマップトファイルのライブラリを探してみた</title>
      <link>/blog/2015/06/03/go_mmap_libraries/</link>
      <pubDate>Wed, 03 Jun 2015 06:29:01 +0900</pubDate>
      
      <guid>/blog/2015/06/03/go_mmap_libraries/</guid>
      <description>

&lt;p&gt;ふとGo言語でメモリマップトファイルを扱えるライブラリってあるのかなと気になったので探してみました。&lt;/p&gt;

&lt;h2 id=&#34;標準ライブラリ:b86aa234eea6d3f9f1ee4426bc5adf77&#34;&gt;標準ライブラリ&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://golang.org/&#34;&gt;Goのホームページ&lt;/a&gt;で&lt;a href=&#34;http://golang.org/search?q=mmap&#34;&gt;mmapで検索してみる&lt;/a&gt;とUnix系では実装があるみたいです。&lt;/p&gt;

&lt;p&gt;Did you mean: &lt;a href=&#34;http://golang.org/search?q=Mmap&#34;&gt;Mmap&lt;/a&gt; と表示されているのでクリックしてみるとsyscallパッケージに&lt;a href=&#34;http://golang.org/pkg/syscall/#Mmap&#34;&gt;Mmap&lt;/a&gt;があることがわかりました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://golang.org/search?q=Munmap&#34;&gt;Munmapで検索してみる&lt;/a&gt;とこちらはMmapよりは実装されているOSが少ないです。syscallパッケージに&lt;a href=&#34;http://golang.org/pkg/syscall/#Munmap&#34;&gt;Mummap&lt;/a&gt;もあります。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://golang.org/search?q=Msync&#34;&gt;Msyncで検索してみる&lt;/a&gt;と5件ヒットしますが、未実装となっていました。&lt;/p&gt;

&lt;p&gt;また、syscallパッケージにMmapとMunmapがあるといっても、Windowsでは実装されていません。&lt;/p&gt;

&lt;h2 id=&#34;github-com-edsrzf-mmap-go:b86aa234eea6d3f9f1ee4426bc5adf77&#34;&gt;github.com/edsrzf/mmap-go&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;ソース: &lt;a href=&#34;https://github.com/edsrzf/mmap-go&#34;&gt;edsrzf/mmap-go&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;GoDoc:  &lt;a href=&#34;https://godoc.org/github.com/edsrzf/mmap-go&#34;&gt;mmap - GoDoc&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;ライセンス: 3項BSD&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/edsrzf/mmap-go&#34;&gt;README&lt;/a&gt;によるとポータブルなAPIで、Linux (386, amd64), OS X, Windows (386)でテスト済みとのことです。&lt;/p&gt;

&lt;p&gt;mprotect, mincoreなどはサポートしていないのでそういうUnix特有の機能を使いたい場合はGustavo Niemeyerさんの&lt;a href=&#34;http://labix.org/gommap&#34;&gt;gommap&lt;/a&gt;がおすすめとのことです。&lt;/p&gt;

&lt;h2 id=&#34;github-com-tysontate-gommap:b86aa234eea6d3f9f1ee4426bc5adf77&#34;&gt;github.com/tysontate/gommap&lt;/h2&gt;

&lt;p&gt;Gustavo Niemeyerさんの&lt;a href=&#34;http://labix.org/gommap&#34;&gt;gommap&lt;/a&gt;はプロジェクトがlaunchpat.netにホスティングされているので、github.comにミラーリングされていないかなと調べると&lt;a href=&#34;https://github.com/tysontate/gommap&#34;&gt;tysontate/gommap&lt;/a&gt;がありました。&lt;/p&gt;

&lt;p&gt;READMEによるとOS X用のパッチも適用済みとのことです。 &lt;code&gt;mmap_*.go&lt;/code&gt; のファイル名から判断すると対応OSはLinux (386, amd64), OS Xのようです。&lt;/p&gt;

&lt;h2 id=&#34;まとめ:b86aa234eea6d3f9f1ee4426bc5adf77&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/edsrzf/mmap-go&#34;&gt;edsrzf/mmap-go&lt;/a&gt;の機能で足りる場合はそちらを、Unix限定になってもいいからmprotectとかを使いたい場合は&lt;a href=&#34;https://github.com/tysontate/gommap&#34;&gt;tysontate/gommap&lt;/a&gt;を使うのがよさそうです。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>LuaのGo実装GopherLuaを試してみた</title>
      <link>/blog/2015/06/03/tried_gopher_lua/</link>
      <pubDate>Wed, 03 Jun 2015 05:29:03 +0900</pubDate>
      
      <guid>/blog/2015/06/03/tried_gopher_lua/</guid>
      <description>

&lt;h2 id=&#34;はじめに:e98f672e065a63864e9866ed6b15e563&#34;&gt;はじめに&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://inforno.net/articles/2015/02/15/gopher-lua-released&#34;&gt;inforno :: LuaのGo言語実装を公開しました&lt;/a&gt;を以前読んでましたが、試してなかったので試しました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://www.lua.org/about.html&#34;&gt;Lua: about&lt;/a&gt;の&amp;rdquo;What is Lua?&amp;ldquo;に&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;making it ideal for configuration, scripting, and rapid prototyping.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;とあるようにLuaは設定ファイルとして使うことも想定されています。&lt;/p&gt;

&lt;p&gt;ということで試してみました。&lt;/p&gt;

&lt;h2 id=&#34;gopherluaの利用例:e98f672e065a63864e9866ed6b15e563&#34;&gt;GopherLuaの利用例&lt;/h2&gt;

&lt;p&gt;hello.lua&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;print(&amp;quot;hello&amp;quot;)

a = 2
b = {
    c = 4,
    d = a + 3
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;main.go&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;package main

import (
	&amp;quot;fmt&amp;quot;

	&amp;quot;github.com/yuin/gopher-lua&amp;quot;
)

func main() {
	l := lua.NewState()
	defer l.Close()

	if err := l.DoFile(&amp;quot;hello.lua&amp;quot;); err != nil {
		panic(err)
	}

	a := l.GetGlobal(&amp;quot;a&amp;quot;)
	fmt.Printf(&amp;quot;a=%v\n&amp;quot;, a)

	b := l.GetGlobal(&amp;quot;b&amp;quot;).(*lua.LTable)
	b.ForEach(func(key, value lua.LValue) {
		fmt.Printf(&amp;quot;b.%v=%v\n&amp;quot;, key, value)
	})
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;実行結果&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ go run main.go
hello
a=2
b.c=4
b.d=5
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;hello.luaに &lt;code&gt;print(&amp;quot;hello&amp;quot;)&lt;/code&gt; を入れているのはLuaからの出力を試してみたかったからで、実際に設定ファイルとして使うときは変数設定だけの使い方になるでしょう。&lt;/p&gt;

&lt;p&gt;上記では単に値を出力していますが、変数の値がプリミティブの場合は&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://godoc.org/github.com/yuin/gopher-lua#LVAsBool&#34;&gt;LVAsBool&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://godoc.org/github.com/yuin/gopher-lua#LVAsString&#34;&gt;LVAsString&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://godoc.org/github.com/yuin/gopher-lua#LVAsNumber&#34;&gt;LVAsNumber&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;を使えばbool, string, LNumberに変換できます。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://godoc.org/github.com/yuin/gopher-lua#LNumber&#34;&gt;LNumberの定義&lt;/a&gt; を見ると&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;type LNumber float64
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;となっているので、Goでも数値として扱えます。&lt;/p&gt;

&lt;p&gt;なお、&lt;a href=&#34;http://www.lua.org/manual/5.3/manual.html#8.1&#34;&gt;Luaは5.3で数値に整数型が追加されています&lt;/a&gt;が、&lt;a href=&#34;https://github.com/yuin/gopher-lua&#34;&gt;gopher-lua&lt;/a&gt;はLua 5.1相当なので数値型は64bit浮動小数点数のみです。&lt;/p&gt;

&lt;p&gt;で、table (ハッシュテーブル) 型は &lt;code&gt;lua.LValue&lt;/code&gt; から &lt;code&gt;.(*lua.Table)&lt;/code&gt; でTableに変換できます。&lt;/p&gt;

&lt;p&gt;ちなみに、&lt;a href=&#34;http://www.lua.org/manual/5.1/manual.html#2.2&#34;&gt;2.2 – Values and Type - sLua 5.1 Reference Manual&lt;/a&gt;にあるようにLuaのtable型は連想配列と整数インデクスでの配列を兼用したデータ型となっています。&lt;/p&gt;

&lt;h2 id=&#34;まとめ:e98f672e065a63864e9866ed6b15e563&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;設定ファイルをLuaで書くようにすると、上記の hello.lua で &lt;code&gt;b.d&lt;/code&gt; を &lt;code&gt;a + 3&lt;/code&gt; としているように変数や式が使えます。&lt;/p&gt;

&lt;p&gt;table型があるのでネストしたデータ構造も表現できます。&lt;/p&gt;

&lt;p&gt;ということで、Goのプログラムの設定ファイルをluaで書いて&lt;a href=&#34;https://github.com/yuin/gopher-lua&#34;&gt;gopher-lua&lt;/a&gt;で解釈するというのは、かなり便利そうですね。今後活用していきたいです。yuinさん、便利なライブラリをありがとうございます！&lt;/p&gt;

&lt;h2 id=&#34;2015-06-03-21-35-頃追記:e98f672e065a63864e9866ed6b15e563&#34;&gt;2015-06-03 21:35 頃追記&lt;/h2&gt;

&lt;p&gt;作者の方からご指摘頂いたのですが、LValueからTableへの変換方法はREADMEの&lt;a href=&#34;https://github.com/yuin/gopher-lua#data-model&#34;&gt;Data model&lt;/a&gt;に書いてありました。失礼いたしました。&lt;/p&gt;

&lt;p&gt;またLuaを設定ファイルとして使う場合は、そのためのライブラリも書かれているので、そちらを使うほうがよいそうです。
&lt;a href=&#34;http://inforno.net/articles/2015/03/23/gluamapper-released&#34;&gt;inforno :: GopherLuaを設定ファイルで使うライブラリを書きました&lt;/a&gt;をご参照ください。Goのstructの各フィールドの値をLuaのtableのデータに応じて設定してくれます。ますます便利ですね！&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Vagrant &#43; Virtualboxでのディスク追加</title>
      <link>/blog/2015/06/01/add_secondary_disk_to_vagrant_virtualbox/</link>
      <pubDate>Mon, 01 Jun 2015 06:04:04 +0900</pubDate>
      
      <guid>/blog/2015/06/01/add_secondary_disk_to_vagrant_virtualbox/</guid>
      <description>

&lt;p&gt;Vagrant + Virtualboxでのディスク追加についてのメモです。&lt;/p&gt;

&lt;h2 id=&#34;ディスク追加の設定:40c70228a5a6466de34e77416297a27f&#34;&gt;ディスク追加の設定&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://stackoverflow.com/questions/21050496/vagrant-virtualbox-second-disk-path/26743144#26743144&#34;&gt;http://stackoverflow.com/questions/21050496/vagrant-virtualbox-second-disk-path/26743144#26743144&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://gist.github.com/leifg/4713995#comment-1206250&#34;&gt;https://gist.github.com/leifg/4713995#comment-1206250&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;を参考に以下のようにしました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure(2) do |config|
  config.vm.box = &#39;base&#39;

  config.vm.provider &amp;quot;virtualbox&amp;quot; do |p|
    vagrant_root = File.dirname(File.expand_path(__FILE__))
    file_to_disk = File.join(vagrant_root, &#39;ad1.vdi&#39;)
    unless File.exist?(file_to_disk)
      vb.customize [&#39;createhd&#39;, &#39;--filename&#39;, file_to_disk, &#39;--size&#39;, 500 * 1024]
    end
    vb.customize [&#39;storageattach&#39;, :id, &#39;--storagectl&#39;, &#39;SATA Controller&#39;, &#39;--port&#39;, 1, &#39;--device&#39;, 0, &#39;--type&#39;, &#39;hdd&#39;, &#39;--medium&#39;, file_to_disk]
  end
end
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記の後者のリンク先では &lt;code&gt;Vagrantfile&lt;/code&gt; のあるディレクトリを &lt;code&gt;VAGRANT_ROOT&lt;/code&gt; と大文字で定数に設定していますが、私は &lt;code&gt;vagrant_root&lt;/code&gt; と小文字で変数にしました。&lt;/p&gt;

&lt;p&gt;デバッグプリントを入れてみてわかったのですが、このブロックは1度ではなく複数回呼ばれます。定数だと既に初期化済みの警告が出るので変数にしたというわけです。&lt;/p&gt;

&lt;h2 id=&#34;sata-controllerの作成はpackerで行っておく:40c70228a5a6466de34e77416297a27f&#34;&gt;SATA Controllerの作成はpackerで行っておく&lt;/h2&gt;

&lt;p&gt;上の設定だけでは &lt;a href=&#34;https://github.com/hnakamur/freebsd-packer/tree/ef57aff51b02a03e658f0348eb5e463ed08735aa&#34;&gt;https://github.com/hnakamur/freebsd-packer/tree/ef57aff51b02a03e658f0348eb5e463ed08735aa&lt;/a&gt; で作ったFreeBSD 10.1 amd64のboxではSATA Controllerが無いためうまく行きませんでした。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://gist.github.com/leifg/4713995#comment-1374268&#34;&gt;https://gist.github.com/leifg/4713995#comment-1374268&lt;/a&gt; でVagrantにモンキーパッチで対応しようとしているがうまくいかない例がありました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/mitchellh/vagrant/issues/4015#issuecomment-45930125&#34;&gt;Rescue customization exception · Issue #4015 · mitchellh/vagrant&lt;/a&gt;のVagrant開発者のコメントで、Vagrantfileの設定は手続き型ではなく宣言型なので、Vagrantfileの設定では無理でVagrantプラグインを作る必要があると書かれています。&lt;/p&gt;

&lt;p&gt;結局 &lt;a href=&#34;https://github.com/hnakamur/freebsd-packer/commit/fc041427ffd9de330d390036ebd0948f01e707fe&#34;&gt;https://github.com/hnakamur/freebsd-packer/commit/fc041427ffd9de330d390036ebd0948f01e707fe&lt;/a&gt; のようにpackerのテンプレートを作る際にSATA Controllerも作っておくのがお手軽だったのでそうしました。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>goでglogを使うときのメモ</title>
      <link>/blog/2015/05/31/how_to_use_glog/</link>
      <pubDate>Sun, 31 May 2015 02:30:02 +0900</pubDate>
      
      <guid>/blog/2015/05/31/how_to_use_glog/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;http://blog.satotaichi.info/logging-frameworks-for-go/&#34;&gt;go言語におけるロギングについて&lt;/a&gt;の記事と&lt;a href=&#34;http://godoc.org/github.com/golang/glog&#34;&gt;glog - GoDoc&lt;/a&gt;を読んで試してみました。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;flag.Parse()&lt;/code&gt; を呼ぶ必要があり、最後に &lt;code&gt;glog.Flush()&lt;/code&gt; を呼ぶ必要があるので &lt;code&gt;main&lt;/code&gt; で &lt;code&gt;defer&lt;/code&gt; で書いておきます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;package main

import (
	&amp;quot;flag&amp;quot;

	&amp;quot;github.com/golang/glog&amp;quot;
)

func main() {
	flag.Parse()
	defer glog.Flush()

	if glog.V(0) {
		glog.Info(&amp;quot;Hello, glog&amp;quot;)
	}

	glog.V(0).Info(&amp;quot;exiting&amp;quot;)
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ログレベルは &lt;code&gt;-v&lt;/code&gt; オプションで指定できるのですがデフォルト値は0なので、デフォルトで出力したいログはレベル0で書くようにします。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://godoc.org/github.com/golang/glog#Verbose&#34;&gt;Verbose&lt;/a&gt;の説明によると、上の2つの書き方では前者のほうが実行時負荷が安上がりとのことです。これはログレベルの設定で出力を抑止した時に、 &lt;code&gt;Info&lt;/code&gt; の引数の評価をしなくて済むからです。&lt;/p&gt;

&lt;p&gt;使い分けるのも面倒なので、常に前者を使うことにします。&lt;/p&gt;

&lt;p&gt;ログファイル名は非公開関数 &lt;a href=&#34;https://github.com/golang/glog/blob/44145f04b68cf362d9c4df2182967c2275eaefed/glog_file.go#L83-L97&#34;&gt;glog.logName()&lt;/a&gt; の形式になります。&lt;/p&gt;

&lt;p&gt;ログのディレクトリは &lt;code&gt;-log_dir&lt;/code&gt; オプションで指定可能ですが、デフォルトでは &lt;a href=&#34;http://golang.org/pkg/os/#TempDir&#34;&gt;os.TempDir()&lt;/a&gt; になっています。&lt;/p&gt;

&lt;p&gt;OS Xの場合は環境変数 &lt;code&gt;$TMPDIR&lt;/code&gt; になります。セキュリティ上 &lt;code&gt;/tmp&lt;/code&gt; ではなくランダムは文字列のディレクトリになっています。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ echo $TMPDIR
/var/folders/9p/r7jylfyd163bszlxvp0wk36h0000gn/T/
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ということで、ログファイルを見るときは &lt;code&gt;less $TMPDIR/${プログラム名}.INFO&lt;/code&gt; とすればOKです。&lt;code&gt;go build&lt;/code&gt; でビルドしてプログラムを実行した時はその名前ですが、 &lt;code&gt;go run main.go&lt;/code&gt; のときは &lt;code&gt;main&lt;/code&gt; になるようで &lt;code&gt;$TMPDIR/main.INFO&lt;/code&gt; というファイルが出来ていました。&lt;/p&gt;

&lt;p&gt;このファイルはプログラム実行のたびに上書きされます。過去のログを見たいときは &lt;code&gt;less $TMPDIR/${プログラム名}&lt;/code&gt; まで入力しTABでファイル名補完して見るようにします。&lt;/p&gt;

&lt;p&gt;上記のサンプルで出力されたログは以下のようになっていました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Log file created at: 2015/05/31 02:22:07
Running on machine: sunshine5
Binary: Built with gc go1.4.2 for darwin/amd64
Log line format: [IWEF]mmdd hh:mm:ss.uuuuuu threadid file:line] msg
I0531 02:22:07.343002   54353 main.go:14] Hello, glog
I0531 02:22:07.343897   54353 main.go:18] exiting
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ログの行フォーマットは4行目に書いてありますが、 &lt;a href=&#34;https://github.com/golang/glog/blob/44145f04b68cf362d9c4df2182967c2275eaefed/glog.go#L518-L534&#34;&gt;glog.header()のコメント&lt;/a&gt; に詳細な説明があります。&lt;/p&gt;

&lt;p&gt;各行の日付には年がないのですが、行のフォーマットは固定なので諦めましょう。ログファイルサイズ削減のために年は付けないようにしているのでしょう。先頭行に作成日時が年つきで書いてあるのでそちらを見れば良いです。&lt;/p&gt;

&lt;p&gt;スレッドIDやログ出力したファイル名と行番号が出るのが便利です。&lt;/p&gt;

&lt;p&gt;ということで開発時のデバッグログとしてはglog便利そうです。逆にシステムの運用ログとしては別のログライブラリのようが良いかもしれません。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>FreeBSD 10.1 amd64でRustをビルドしてみた</title>
      <link>/blog/2015/05/17/build_rust_on_freebsd/</link>
      <pubDate>Sun, 17 May 2015 07:51:14 +0900</pubDate>
      
      <guid>/blog/2015/05/17/build_rust_on_freebsd/</guid>
      <description>&lt;p&gt;&lt;a href=&#34;http://www.rust-lang.org/install.html&#34;&gt;Install · The Rust Programming Language&lt;/a&gt;
を見ると現在のところRustのバイナリが提供されているのはLinux, Mac, Windowsのみです。&lt;/p&gt;

&lt;p&gt;FreeBSD 10.1 amd64でソースからビルドしてみました。
&lt;a href=&#34;https://github.com/rust-lang/rust#building-from-source&#34;&gt;Building from Source&lt;/a&gt;に従ってビルドするとすんなり行けました。&lt;/p&gt;

&lt;p&gt;FreeBSDでの手順は以下のとおりです。標準でclangとcurlがインストールされていたのでそれを使っています。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo pkg install -y python gmake git
git clone https://github.com/rust-lang/rust.git
cd rust
./configure
gmake
sudo gmake install
&lt;/code&gt;&lt;/pre&gt;
</description>
    </item>
    
    <item>
      <title>さくらのVPSにFreeBSD 10.1をクリーンインストールした時のメモ</title>
      <link>/blog/2015/05/16/install_freebsd10.1_on_sakura_vps/</link>
      <pubDate>Sat, 16 May 2015 11:39:29 +0900</pubDate>
      
      <guid>/blog/2015/05/16/install_freebsd10.1_on_sakura_vps/</guid>
      <description>

&lt;h2 id=&#34;はじめに:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;はじめに&lt;/h2&gt;

&lt;p&gt;さくらのVPSにFreeBSD 10.1をクリーンインストールしてみましたので、手順をメモしておきます。作業した環境は MacBook Pro (USキーボード) です。
インストール後以下の設定を行います。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;ファイルシステムはZFSを選択&lt;/li&gt;
&lt;li&gt;sshの鍵認証の設定&lt;/li&gt;
&lt;li&gt;sudoのインストールと設定&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;なお、インストールには下記のページを参考にしました。ありがとうございます！&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.emaita.jp/2015/03/06/freebsd10_1.html&#34;&gt;FreeBSD 10.1 導入 — emaita 備忘録&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.livedoor.jp/saba_nano/archives/28363307.html&#34;&gt;[FreeBSD] さくらのVPSに FreeBSD 9.1 amd64 をインストールする方法 (1) : saba nano - へっぽこ管理者のサーバ管理日誌（LV.2）&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;インストール準備:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;インストール準備&lt;/h2&gt;

&lt;h3 id=&#34;isoイメージをミラーから取得してvpsにsftpでアップロード:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ISOイメージをミラーから取得してVPSにsftpでアップロード&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;http://www.jp.freebsd.org/mirror.html&#34;&gt;FreeBSD-related Sites in Japan&lt;/a&gt;を見てftp3.jp.FreeBSD.org (ftp.sakura.ad.jp)からダウンロードすることにしました。&lt;/p&gt;

&lt;p&gt;ブラウザで
&lt;a href=&#34;ftp://ftp3.jp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.1/&#34;&gt;ftp://ftp3.jp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.1/&lt;/a&gt;
を開き
&lt;a href=&#34;ftp://ftp3.jp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.1/FreeBSD-10.1-RELEASE-amd64-bootonly.iso&#34;&gt;ftp://ftp3.jp.freebsd.org/pub/FreeBSD/releases/ISO-IMAGES/10.1/FreeBSD-10.1-RELEASE-amd64-bootonly.iso&lt;/a&gt;
をダウンロードします。&lt;/p&gt;

&lt;p&gt;これを&lt;a href=&#34;https://help.sakura.ad.jp/app/answers/detail/a_id/2405&#34;&gt;ISOイメージインストール｜さくらインターネット公式サポートサイト&lt;/a&gt;の手順を参考にアップロードします。&lt;/p&gt;

&lt;p&gt;OS Xにはsftpコマンドが標準で入っているのでそれを使います。接続情報は、さくらのVPSのコントロールパネルで確認します。
ここでは、ユーザ名をvpsXXXXXXXXXXXX, ホスト名をvps-isoY.sakura.ad.jpとして説明します。&lt;/p&gt;

&lt;p&gt;isoファイルのあるディレクトリでsftpを実行し、以下の手順で上記のisoファイルをアップロードします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sftp vpsXXXXXXXXXXXX@vps-isoY.sakura.ad.jp
vpsXXXXXXXXXXXX@vps-isoY.sakura.ad.jp&#39;s password: (パスワードを入力)
sftp&amp;gt; cd iso
sftp&amp;gt; put FreeBSD-10.1-RELEASE-amd64-bootonly.iso
sftp&amp;gt; quit
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;アップロードが完了したらsftpコマンドは終了します。さくらのVPSのコントロールパネルの「ISOイメージインストール」のポップアップの「ISOイメージ情報」に今アップロードしたisoファイルが表示されたことを確認し、「マウント設定」の「設定内容を確認する」ボタンを押し、「インストールを実行する」ボタンを押します。&lt;/p&gt;

&lt;h2 id=&#34;インストール:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;インストール&lt;/h2&gt;

&lt;p&gt;「VNCコンソール(HTML5版)を起動」ボタンを押してコンソールで作業します。&lt;/p&gt;

&lt;h3 id=&#34;キーマップの確認:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;キーマップの確認&lt;/h3&gt;

&lt;p&gt;HTML5版のVNCコンソールは、どうも日本語キーボードを想定しているようで、USキーボードだと以下のように一部の記号の配置が異なっています。
なお、キーマップはデフォルト(US配列)を選択しています。&lt;/p&gt;

&lt;p&gt;押したキーを左、入力された文字を右に示します。&lt;/p&gt;

&lt;table border=&#34;1&#34;&gt;
&lt;tr&gt;&lt;th style=&#34;padding:4px&#34;&gt;押したキー&lt;/th&gt;&lt;th style=&#34;padding:4px&#34;&gt;入力された文字&lt;/th&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;`&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;[&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;~ (Shift+`)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;+&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;@ (Shift+2)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;{&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;^ (Shift+6)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;+&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;&amp; (Shift+7)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;^&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;* (Shift+8)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;&#34;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;( (Shift+9)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;*&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;) (Shift+0)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;(&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;_ (Shift+-)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;何も入力されない&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;=&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;-&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;+ (Shift+=)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;:&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;[&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;]&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;{ (Shift+[)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;}&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;]&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;\&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;} (Shift+})&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;|&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;\&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;何も入力されない&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;| (Shift+\)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;何も入力されない&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;: (Shift+;)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;&#34;&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;&#39;&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;7&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&#34;padding:4px&#34;&gt;&#34; (Shift+&#39;)&lt;/td&gt;&lt;td style=&#34;padding:4px&#34;&gt;@&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;

&lt;h3 id=&#34;ホスト名設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ホスト名設定&lt;/h3&gt;

&lt;p&gt;&amp;ldquo;Please choose a hostname for this machine.&amp;ldquo;の画面ではVPSのコンソールの標準ホスト名を入力します。&lt;/p&gt;

&lt;h3 id=&#34;インストールするコンポーネントの選択:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;インストールするコンポーネントの選択&lt;/h3&gt;

&lt;p&gt;初期選択状態は以下のようになっていました。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;[ ] doc: Additional documentation&lt;/li&gt;
&lt;li&gt;[*] games: Games (fortune, etc.)&lt;/li&gt;
&lt;li&gt;[*] lib32: 32-bit compatiblity libraries&lt;/li&gt;
&lt;li&gt;[*] ports: Ports tree&lt;/li&gt;
&lt;li&gt;[ ] src: System source code&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;gamesとlib32を外して、docとsrcを追加しました。&lt;/p&gt;

&lt;h3 id=&#34;ネットワーク設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ネットワーク設定&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;「Network Configuration」では「vtnet0」を選び「OK」を押します。&lt;/li&gt;
&lt;li&gt;&amp;ldquo;Would you like to configure IPv4 for this interface&amp;rdquo; → [Yes]を押す&lt;/li&gt;
&lt;li&gt;&amp;ldquo;Would you like to use DHCP to configure this interface?&amp;rdquo; → [No]を押す&lt;/li&gt;
&lt;li&gt;「Static Netowrk Interface Configuration」の画面でIP Address, Subnet Mask, Default Routerを入力します。VPSのコントロールパネルのIPv4のアドレス、ネットマスク、ゲートウェイの値をそれぞれ入力します。&lt;/li&gt;
&lt;li&gt;&amp;ldquo;Would you like to configure IPv6 for this interface?&amp;rdquo; → NoYes]を押す&lt;/li&gt;
&lt;li&gt;「Resolver Configuration」の画面でSearch, IPv4 DNS #1, IPv4 DNS #2を入力します。順にVPSコントロールパネルの標準ホスト名のドメイン部分(私の場合はvs.sakura.ne.jp)、IPv4のプライマリDNS、セカンダリDNSを入力します。&lt;/li&gt;
&lt;/ul&gt;

&lt;h4 id=&#34;ボツ-ipv6を有効にすると失敗しました:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;(ボツ) IPv6を有効にすると失敗しました&lt;/h4&gt;

&lt;ul&gt;
&lt;li&gt;&amp;ldquo;Would you like to configure IPv6 for this interface?&amp;rdquo; → [Yes]を押す&lt;/li&gt;
&lt;li&gt;&amp;ldquo;Would you like to try stateless address autoconfiguration (SLAAC)?&amp;rdquo; → [No]を押す&lt;/li&gt;
&lt;li&gt;「Static IPv6 Network Interface Configuration」の画面でIPv6 AddressとDefault RouterにVPSのコントロールパネルのIPv6のアドレスとゲートウェイを入力します。上記のキーマップの確認に書いたように:を入力するにはUSキーボードではShift+=を押してください。&lt;/li&gt;
&lt;li&gt;「Resolver Configuration」の画面でSearch, IPv6 DNS #1, IPv6 DNS #2, IPv4 DNS #1, IPv4 DNS #2を入力します。順にVPSコントロールパネルの標準ホスト名のドメイン部分(私の場合はvs.sakura.ne.jp)、IPv6のDNS、空欄、IPv4のプライマリDNS、セカンダリDNSを入力します。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;ダウンロードは無事に進んだようなのですが、その後以下のエラーが出ました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Abort
Distribution extract failed

An installation step has been aborted. Would you
like to restart the installation or exit
the installer?
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;ミラーサイト選択:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ミラーサイト選択&lt;/h3&gt;

&lt;p&gt;「Mirror Selection」の画面では「&lt;a href=&#34;ftp://ftp3.jp.freebsd.org&#34;&gt;ftp://ftp3.jp.freebsd.org&lt;/a&gt; Japan #3」を選択します。&lt;/p&gt;

&lt;h3 id=&#34;パーティション作成:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;パーティション作成&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;Auto (UFS): Guided Disk Setup&lt;/li&gt;
&lt;li&gt;Manual: Manual Disk Setup (experts)&lt;/li&gt;
&lt;li&gt;Shell: Open a shell and partition by hand&lt;/li&gt;
&lt;li&gt;Auto (ZFS): Guided Root-on-ZFS&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;今回は「Auto (ZFS)」にしました。
「ZFS Configuration」ではそのまま「&amp;gt;&amp;gt;&amp;gt; Install     Proceed with Installation」を選びます。&lt;/p&gt;

&lt;h3 id=&#34;zfsの仮想デバイスタイプ:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ZFSの仮想デバイスタイプ&lt;/h3&gt;

&lt;ul&gt;
&lt;li&gt;stripe: Stripe - No Redundancy&lt;/li&gt;
&lt;li&gt;mirror: Mirror - n-Way Mirroring&lt;/li&gt;
&lt;li&gt;raidz1: RAID-Z1 - Single Redundant RAID&lt;/li&gt;
&lt;li&gt;raidz2: RAID-Z2 - Single Redundant RAID&lt;/li&gt;
&lt;li&gt;raidz3: RAID-Z3 - Single Redundant RAID&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;「stripe」を選びました。&lt;/p&gt;

&lt;h3 id=&#34;ブロックデバイス選択:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ブロックデバイス選択&lt;/h3&gt;

&lt;p&gt;「vtbd0 VirtIO Block Device」をスペースキーを押して選択します。&lt;/p&gt;

&lt;p&gt;&amp;ldquo;Last Chance! Are you sure you want to destroy the current contents of the following disks: vtbd0&amp;rdquo; では[YES]を選びます。&lt;/p&gt;

&lt;h3 id=&#34;rootユーザのパスワード設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;rootユーザのパスワード設定&lt;/h3&gt;

&lt;p&gt;以下のようにrootユーザのパスワードを設定します。なぜかreturnキーが効かないようなのでCtrl-Jで代用しました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Please select a password for the system management account (root):
Changing local password for root
New Password: (パスワードを入力してCtrl-Jを押す)
Retype New Password: (パスワードを入力してCtrl-Jを押す)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;表示も変で、Ctrl-Jを押した時に行が次の行に進みますが、行頭には戻らず続きのカラムから表示されていました。&lt;/p&gt;

&lt;h3 id=&#34;タイムゾーン設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;タイムゾーン設定&lt;/h3&gt;

&lt;p&gt;&amp;ldquo;Is this machine&amp;rsquo;s CMOS clock set to UTC?  If it is set to local time, or you don&amp;rsquo;t know, please choose NO here!&amp;rdquo; ではハードウェアの設定はわからないので「No」を選びます。&lt;/p&gt;

&lt;p&gt;「Select a region」では「5 Asia」を選び、「Select a country or region」では「18 Japan」を選びます。
&amp;ldquo;Does the abbreviation `JST&amp;rsquo; look reasonable?&amp;ldquo;に「Yes」を選びます。&lt;/p&gt;

&lt;h3 id=&#34;自動起動するサービス選択:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;自動起動するサービス選択&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;Choose the services you would like to be started at boot:
  [ ] local_unbound  Local caching validating resolver
  [*] sshd           Secure shell daemon
  [ ] moused         PS/2 mouse pointer on console
  [ ] ntpd           Synchronize system and network time
  [ ] powerd         Adjust CPU frequency dynamically if supported
  [*] dumpev         Enable kernel crash dumps to /var/crash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ntpdを追加選択します。&lt;/p&gt;

&lt;h3 id=&#34;ユーザ追加:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;ユーザ追加&lt;/h3&gt;

&lt;p&gt;sshでログインする管理用のユーザとして「admin」という名前のユーザを追加することにします。あとでsudoersに追加するのでadminユーザのセカンダリグループにwheelを追加します。&lt;/p&gt;

&lt;p&gt;&amp;ldquo;Would you like to add users to the installed systems now?&amp;ldquo;に「Yes」を選びます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Add Users
Username: admin
Full name: admin
Uid (Leave empty for default): (Ctrl-Jを押す)
Login group [admin]: (Ctrl-Jを押す)
Login group is admin. Invite admin into other groups? []: (wheelと入力してCtrl-Jを押す)
Login class [default]: (Ctrl-Jを押す)
Shell (ch csh tcsh nologin) [sh]: (Ctrl-Jを押す)
Home directory [/home/admin]: (Ctrl-Jを押す)
Home directory permissions (Leave empty for default): (Ctrl-Jを押す)
Use password-based authentication? [yes]: (Ctrl-Jを押す)
Use an empty password? (yes/no) [no]: (Ctrl-Jを押す)
Use a random password? (yes/no) [no]: (Ctrl-Jを押す)
Enter password: (パスワードを入力してCtrl-Jを押す)
Enter password again: (パスワードを入力してCtrl-Jを押す)
Lock out the accout after creation? [no]: (Ctrl-Jを押す)
OK? (yes/no): (yesと入力してCtrl-Jを押す)
adduser: INFO Successfully added (admin) to the user database.
Add another user? (yes/no): (noと入力してCtrl-Jを押す)
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;インストールの終了:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;インストールの終了&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;Setup of you FreeBSD system is nearly complete.  You can now
modify your configuration choices. After this screen, you will
have an opportunity to make more complex changes using a shell.
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記の画面では「Exit」を選択して「OK」を押します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;The installation is now finished.
Before exiting the installer, yould
you like to open a shell in the new
system to make any final manual
modifications?
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記の画面では「No」を選択します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Installation of FreeBSD
complete! Would you like
to reboot into the
installed system now?
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記の画面では「Reboot」を押しても、またインストーラの画面が起動してしまいます。
そこで、さくらのVPSのコンソールで「OSインストール」→「ISOイメージインストール」を選び、「ISOイメージアップロード情報」の「アカウントの削除」ボタンを押します。
「アカウントを削除してよろしいですか？アップロードしたファイルも削除されます。」と表示されたら「削除する」ボタンを押します。&lt;/p&gt;

&lt;p&gt;その後「ISOイメージインストール」のポップアップで「キャンセル」を押してVPSのコンソールに戻りツールバーの「強制停止」ボタンを押して停止した後「起動」ボタンを押して起動します。&lt;/p&gt;

&lt;h2 id=&#34;インストール後の設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;インストール後の設定&lt;/h2&gt;

&lt;h3 id=&#34;adminユーザの公開鍵の設置:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;adminユーザの公開鍵の設置&lt;/h3&gt;

&lt;p&gt;ここでは、OS X側で秘密鍵・公開鍵を作成済みとし、秘密鍵は ~/.ssh/id_rsa、公開鍵は ~/.ssh/id_rsa.pub とします。&lt;/p&gt;

&lt;p&gt;OSX上で以下の操作を行い、公開鍵をサーバに転送します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;scp ~/.ssh/id_rsa.pub admin@サーバのIPアドレス:
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;adminユーザのパスワードを聞かれるので入力します。&lt;/p&gt;

&lt;p&gt;その後sshでサーバにログインします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh admin@サーバのIPアドレス
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;パスワードを入力すると以下のようなメッセージが表示されます。アドレスのXXX.XXX.XXX.XXXとRSA鍵のフィンガープリントはここでは伏せていますが実際は異なる値になります。「yes」と入力してログインしてください。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;The authenticity of host &#39;XXX.XXX.XXX.XXX (XXX.XXX.XXX.XXX)&#39; can&#39;t be established.
RSA key fingerprint is yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy:yy.
Are you sure you want to continue connecting (yes/no)?
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;パスワードを入力してサーバにログインしたらサーバ上で以下のコマンドを実行し、カギ認証でログインできるようにします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;mkdir ~/.ssh
chmod 700 ~/.ssh
mv id_rsa.pub ~/.ssh/authorized_keys
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;今度はOS X側で ~/.ssh/configというファイルが無い場合は新規作成した上で、以下の内容を追加します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Host 接続に使用するお好みのホスト名エイリアス
  Hostname サーバのIPアドレス
  User admin
  PasswordAuthentication no
  IdentityFile ~/.ssh/id_rsa
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;IdentityFileの行は ~/.ssh/id_rsa はデフォルト値なので、この場合はこの行自体不要です。別のファイル名にしていた場合は設定が必要です。&lt;/p&gt;

&lt;p&gt;この設定を加えた状態で、OS Xから以下のようにコマンドを実行しパスワードを聞かれずにログインできれば成功です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh ホスト名エイリアス
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;sshパスワード認証の無効化:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;sshパスワード認証の無効化&lt;/h3&gt;

&lt;p&gt;鍵認証でssh接続できるようになったら、悪意を持った第三者の攻撃でパスワードを当ててログインされてしまうのを防ぐため、パスワードでのログインを無効にします。&lt;/p&gt;

&lt;p&gt;サーバ上で以下の手順を実行します。まず以下のコマンドを実行してrootユーザになります。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;su -
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;rootユーザのパスワードを聞かれますので入力します(1行が長いのでブラウザでコピペする際は右の方までスクロールしてください)。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sed -i .orig -e &#39;s/^#\(PasswordAuthentication no\)/\1/;s/^#\(UsePAM\) yes/\1 no/;s/^#\(X11Forwarding\) yes/\1 no/&#39; /etc/ssh/sshd_config
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;less /etc/ssh/sshd_config
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で設定内容を確認します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;…(略)…
PasswordAuthentication no
…(略)…
UsePAM no
…(略)…
X11Forwarding no
…(略)…
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;となっていればOKですのでqを押してlessを終了します。&lt;/p&gt;

&lt;p&gt;以下のコマンドを実行してsshdを再起動します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;/etc/rc.d/sshd restart
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;次に実際にパスワード認証が無効化されたことを確認します。&lt;/p&gt;

&lt;p&gt;一旦このrootユーザの接続は残しておいて、OS X上で別のターミナルを開き、~/.ssh/configを以下のように編集します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Host 接続に使用するお好みのホスト名エイリアス
  Hostname サーバのIPアドレス
  User admin
  PasswordAuthentication yes
  PubkeyAuthentication no
  #PasswordAuthentication no
  #IdentityFile ~/.ssh/id_rsa
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;この状態で&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ssh ホスト名エイリアス
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のようにコマンドを実行した時にパスワードを聞かれることなく以下のように表示されれば、パスワード認証は正しく無効化できています。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;Permission denied (publickey,keyboard-interactive).
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記の確認ができたらOS Xの~/.ssh/configは元の内容に戻しておいてください。&lt;/p&gt;

&lt;h3 id=&#34;セキュリティパッチの適用:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;セキュリティパッチの適用&lt;/h3&gt;

&lt;p&gt;先ほどのrootで接続していたターミナルに戻ってセキュリティパッチを適用します。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://www.freebsd.org/doc/ja_JP.eucJP/books/handbook/updating-upgrading-freebsdupdate.html&#34;&gt;18.2. FreeBSD Update&lt;/a&gt;の「セキュリティパッチの適用」の項を参考にします。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=198030&#34;&gt;Bug 198030 – /usr/src/crypto/openssl/util/mkbuildinf.pl: No such file or directory on freebsd-update install&lt;/a&gt;のバグを回避するため
&lt;a href=&#34;https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=198030#c7&#34;&gt;Comment 7&lt;/a&gt;の手順を実行してから、パッチを適用します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# freebsd-update fetch
# mkdir -p /usr/src/crypto/openssl/util
# freebsd-update install
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;&lt;code&gt;freebsd-update patch&lt;/code&gt; を実行すると、アップデートを取得後moreコマンドが起動して更新されたファイル一覧を確認できます。スペースキーを押してページを進め、確認したらqを押して終了します。&lt;/p&gt;

&lt;h3 id=&#34;sudoのインストールと設定:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;sudoのインストールと設定&lt;/h3&gt;

&lt;p&gt;rootユーザで以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;pkg install -y sudo
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;すると以下のようにpkgコマンド自体をインストールするか聞かれますので、yと入力します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;The package management tool is not yet installed on your system.
Do you want to fetch and install it now? [y/N]:
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;pkgとsudoのインストールが終わったら、以下のコマンドを実行してsudoの設定を変更します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;visudo
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;ここではwheelグループにsudoを許可します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# %wheel ALL=(ALL) ALL
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;の行を&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;%wheel ALL=(ALL) ALL
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のように変更して:wqで保存して終了します。&lt;/p&gt;

&lt;p&gt;sudoの設定を確認するため、rootのターミナルは一旦置いておいて、OS Xからsshでadminユーザでログインし、以下のコマンドを実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo -i
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以下のようにメッセージが表示されますので、adminユーザのパスワードを入力します。
rootユーザのプロンプトが出れば成功です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo -i

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

Password:
root@ホスト名からドメインを除いたもの:~ #
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;確認できたら、このターミナルでCtrl-Dを押してadminユーザに戻り、さらにCtrl-Dを押してログアウトします。
先程残しておいたrootユーザのターミナルも同様にしてログアウトします。&lt;/p&gt;

&lt;h2 id=&#34;おわりに:a3e5dd67b515369d483f860a8ed67c3c&#34;&gt;おわりに&lt;/h2&gt;

&lt;p&gt;いくつかハマりどころがありましたが、さくらのVPSにFreeBSD 10.1をクリーンインストールできました。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>mithril.jsを試してみた</title>
      <link>/blog/2015/05/12/tried_mithril_js/</link>
      <pubDate>Tue, 12 May 2015 22:02:03 +0900</pubDate>
      
      <guid>/blog/2015/05/12/tried_mithril_js/</guid>
      <description>

&lt;h2 id=&#34;はじめに:1b95d5ba24f1660fe99511183f8577c8&#34;&gt;はじめに&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;/blog/blog/2015/05/12/cgoroonga_wikipedia_search_webapp/&#34;&gt;groongaのgoバインディングでWikipedia全文検索のサンプルウェブアプリを作ってみた · hnakamur&amp;rsquo;s blog at github&lt;/a&gt;のフロントエンドを&lt;a href=&#34;https://lhorie.github.io/mithril/&#34;&gt;Mithril&lt;/a&gt;で書いてみました。&lt;/p&gt;

&lt;h2 id=&#34;参考にした記事:1b95d5ba24f1660fe99511183f8577c8&#34;&gt;参考にした記事&lt;/h2&gt;

&lt;p&gt;mithril.jsについてはまず以下の記事&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://qiita.com/shibukawa/items/890d24874655439932ec&#34;&gt;最速MVCフレームワークMithril.jsの速度の秘密 - Qiita&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://qiita.com/mmyoji/items/211679de86f567e741f4&#34;&gt;JavaScript - 速くて軽いらしいMithril.jsを試してみた - Qiita&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;を読み、その後本家の&lt;a href=&#34;https://lhorie.github.io/mithril/getting-started.html&#34;&gt;Guide&lt;/a&gt;の左のリンクから辿れる記事と&lt;a href=&#34;http://lhorie.github.io/mithril-blog/&#34;&gt;Learn Mithril&lt;/a&gt;の記事をひと通り読みました。&lt;/p&gt;

&lt;p&gt;今回は試していませんが、
&lt;a href=&#34;http://lhorie.github.io/mithril-blog/velocity-animations-in-mithril.html&#34;&gt;Velocity.js animations in Mithril&lt;/a&gt;の記事で、&lt;a href=&#34;http://julian.com/research/velocity/&#34;&gt;Velocity.js&lt;/a&gt;を組み合わせてアニメーションを実現する方法も紹介されていました。&lt;/p&gt;

&lt;h2 id=&#34;データバインディングの仕組み:1b95d5ba24f1660fe99511183f8577c8&#34;&gt;データバインディングの仕組み&lt;/h2&gt;

&lt;p&gt;mithril.jsを読み込むと &lt;code&gt;m&lt;/code&gt; というグローバル変数にmithrilのモジュールが定義されます。モジュールと言ってもビューの関数としても使いますし、他の関数の名前空間としても使っています。&lt;/p&gt;

&lt;p&gt;まずモデルの定義ですが、&lt;a href=&#34;https://lhorie.github.io/mithril/getting-started.html#model&#34;&gt;Getting Started&lt;/a&gt;の&lt;a href=&#34;https://lhorie.github.io/mithril/getting-started.html#model&#34;&gt;Model&lt;/a&gt;のところにあるように、&lt;a href=&#34;https://lhorie.github.io/mithril/mithril.prop.html&#34;&gt;m.prop&lt;/a&gt;を使って&lt;/p&gt;

&lt;p&gt;&lt;code&gt;プロパティ = m.prop(初期値)&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;と書くことで、プロパティが作られます。プロパティは値ではなくてgetter-setterの関数になっていて、 &lt;code&gt;プロパティ()&lt;/code&gt; で値を取得、 &lt;code&gt;プロパティ(値)&lt;/code&gt; で値を設定します。&lt;/p&gt;

&lt;p&gt;モデル層はドメインモデルに限定して、UIの状態は&lt;a href=&#34;https://lhorie.github.io/mithril/getting-started.html#view-model&#34;&gt;View-Model&lt;/a&gt;として定義します。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://lhorie.github.io/mithril/getting-started.html#controller&#34;&gt;Controller&lt;/a&gt;はビューモデルを保持し、ビューでのイベントハンドラやビューを操作する関数を定義します。&lt;/p&gt;

&lt;p&gt;HTMLの構造は&lt;a href=&#34;https://lhorie.github.io/mithril/getting-started.html#view&#34;&gt;View&lt;/a&gt;の例にあるように、 &lt;a href=&#34;https://lhorie.github.io/mithril/mithril.html&#34;&gt;m&lt;/a&gt; という関数を使って記述します。JavaScriptで書くのですが宣言的に書けるので、見やすいです。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;第一引数にCSSクエリ文字列を書くと、そのタグ名や属性を持った要素が作られます。&lt;/li&gt;
&lt;li&gt;第二引数は省略可能ですが、属性のハッシュを指定できます。&lt;/li&gt;
&lt;li&gt;最後の引数で子要素を指定します。複数の場合は配列、単一の子要素なら &lt;code&gt;m&lt;/code&gt; の呼び出し、テキスト要素なら文字列を指定します。&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;あとは&lt;a href=&#34;https://lhorie.github.io/mithril/mithril.mount.html&#34;&gt;m.mount&lt;/a&gt;か&lt;a href=&#34;https://lhorie.github.io/mithril/mithril.component.html&#34;&gt;m.component&lt;/a&gt;でマウントすると、モデルの値が変わったらビューの表示もmithrilが更新してくれます。&lt;/p&gt;

&lt;h2 id=&#34;今回作成したソース:1b95d5ba24f1660fe99511183f8577c8&#34;&gt;今回作成したソース&lt;/h2&gt;

&lt;p&gt;基本的な構造は&lt;a href=&#34;https://lhorie.github.io/mithril/components.html&#34;&gt;Components&lt;/a&gt;の&lt;a href=&#34;https://lhorie.github.io/mithril/components.html#classic-mvc&#34;&gt;Classic MVC&lt;/a&gt;のパターンを真似しました。&lt;/p&gt;

&lt;p&gt;ソースは&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/8fd6f566f84fd2564a17e38bc96d8a346d2a120a/examples/search_wikipedia_webapp/public/index.html&#34;&gt;cgoroonga/index.html&lt;/a&gt;にあります。お手軽に試していたレベルなのでstyleタグやscriptタグもhtml内に書いちゃってます。&lt;/p&gt;

&lt;p&gt;コンポーネントの階層は以下のようになっています。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;SearchWidget: 検索画面全体のウィジェット

&lt;ul&gt;
&lt;li&gt;SearchForm: 検索フォーム

&lt;ul&gt;
&lt;li&gt;SelectWidget: ドロップダウンウィジェット（検索期間選択用）&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;SearchResultWidget: 検索結果表示ウィジェット&lt;/li&gt;
&lt;li&gt;PaginationWidget: ページネーションウィジェット&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;検索フォームをサブミットした時とページネーションのリンクをクリックした時は、
&lt;a href=&#34;https://lhorie.github.io/mithril/components.html#the-observer-pattern&#34;&gt;The observer pattern&lt;/a&gt;の &lt;code&gt;Observable&lt;/code&gt; 経由で検索処理を実行しています。&lt;/p&gt;

&lt;p&gt;一方、検索期間のSelectWidgetの選択を切り替えた時は、SelectWidgetのコントローラの &lt;code&gt;onchange&lt;/code&gt; →SelectWidgetのビューモデルの &lt;code&gt;onchange&lt;/code&gt; →SearchWidgetのコントローラの &lt;code&gt;onchangetimespan&lt;/code&gt; と呼び出しを連鎖して検索処理を実行するようにしてみました。&lt;/p&gt;

&lt;p&gt;ビューの定義時に &lt;code&gt;m.component&lt;/code&gt; でサブコンポーネントを埋め込むときに引数でビューモデルやイベントハンドラを渡しておいて、ビューではそのビューモデルを参照し、イベントが起きたら引数で渡されていたイベントハンドラを呼び出すというパターンです。&lt;/p&gt;

&lt;h2 id=&#34;おわりに:1b95d5ba24f1660fe99511183f8577c8&#34;&gt;おわりに&lt;/h2&gt;

&lt;p&gt;mithril.jsを使うとコンポーネントごとにMVCパターンで実装できて、コンポーネント間はObservableで連携するか、ビューでサブコンポーネントを利用する際に引数で渡したビューモデルとイベントハンドラで連携することが出来、見通しが良いと感じました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/lhorie/mithril.js/blob/next/mithril.js&#34;&gt;mithril.jsのソース&lt;/a&gt;も現時点で1161行とコンパクトなのも魅力です。まだバージョン v0.2.0 ですが、今後が楽しみなフレームワークですね。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>groongaのgoバインディングでWikipedia全文検索のサンプルウェブアプリを作ってみた</title>
      <link>/blog/2015/05/12/cgoroonga_wikipedia_search_webapp/</link>
      <pubDate>Tue, 12 May 2015 21:24:11 +0900</pubDate>
      
      <guid>/blog/2015/05/12/cgoroonga_wikipedia_search_webapp/</guid>
      <description>

&lt;p&gt;&lt;a href=&#34;http://hnakamur.github.io/blog/2015/04/27/cgoroonga/&#34;&gt;データ登録用にgroongaのC APIのgoバインディングを書いてみた · hnakamur&amp;rsquo;s blog at github&lt;/a&gt;の続きで、APIを追加実装し、Wikipedia全文検索のサンプルウェブアプリを作ってみました。&lt;/p&gt;

&lt;h2 id=&#34;ソースコード:4c3e94caa0d90f3caef8e5ee8fd93962&#34;&gt;ソースコード&lt;/h2&gt;

&lt;p&gt;ウェブアプリのソースは
&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/tree/master/examples/search_wikipedia_webapp&#34;&gt;https://github.com/hnakamur/cgoroonga/tree/master/examples/search_wikipedia_webapp&lt;/a&gt;
にあります。&lt;/p&gt;

&lt;p&gt;GroongaのC APIについては&lt;a href=&#34;http://groonga.org/ja/docs/reference/api.html&#34;&gt;7.20. API — Groonga v5.0.3ドキュメント&lt;/a&gt;を見つつ、ドキュメント化されていないものは&lt;a href=&#34;https://github.com/groonga/groonga&#34;&gt;groongaのソース&lt;/a&gt;を見て、goバインディングを作りました。&lt;/p&gt;

&lt;p&gt;goバインディングもウェブアプリもとりあえず全文検索の動作確認ができればいいやということで、ゆるい感じで書いています。&lt;/p&gt;

&lt;p&gt;ウェブアプリのサーバサイドのソースは
&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/master/examples/search_wikipedia_webapp/main.go&#34;&gt;https://github.com/hnakamur/cgoroonga/blob/master/examples/search_wikipedia_webapp/main.go&lt;/a&gt;
で、groongaのgoバインディングのソースは
&lt;a href=&#34;https://github.com/hnakamur/cgoroonga&#34;&gt;https://github.com/hnakamur/cgoroonga&lt;/a&gt;
の &lt;code&gt;*.go&lt;/code&gt; です。&lt;/p&gt;

&lt;h2 id=&#34;フロントエンドについては別記事で:4c3e94caa0d90f3caef8e5ee8fd93962&#34;&gt;フロントエンドについては別記事で&lt;/h2&gt;

&lt;p&gt;フロントエンドは&lt;a href=&#34;http://qiita.com/shibukawa/items/890d24874655439932ec&#34;&gt;最速MVCフレームワークMithril.jsの速度の秘密 - Qiita&lt;/a&gt;の記事を見て気になっていたので、&lt;a href=&#34;https://lhorie.github.io/mithril/&#34;&gt;Mithril&lt;/a&gt;で書いてみました。こちらについては別記事&lt;a href=&#34;/blog/blog/2015/05/12/tried_mithril_js/&#34;&gt;mithril.jsを試してみた&lt;/a&gt;に書きました。&lt;/p&gt;

&lt;h2 id=&#34;インデクスの作成:4c3e94caa0d90f3caef8e5ee8fd93962&#34;&gt;インデクスの作成&lt;/h2&gt;

&lt;p&gt;groongaコマンドで以下のようにして作成しました。約27分かかりました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ echo &#39;column_create --table ArticleIndexes --name article_index --flags COLUMN_INDEX|WITH_POSITION|WITH_SECTION --type Articles --source _key,text&#39; | time groonga ~/work/groonga/db/wikipedia.db
[[0,1431052924.67975,1555.13576507568],true]
     1660.80 real      1135.40 user       146.29 sys
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Wikipediaのページタイトルと本文の両方を対象に検索したいので、 &lt;code&gt;--source&lt;/code&gt; には _keyカラム (タイトル) と text カラム (本文) の両方を指定しました。&lt;/p&gt;

&lt;h2 id=&#34;検索の応答は約80-250ms程度と満足な早さ:4c3e94caa0d90f3caef8e5ee8fd93962&#34;&gt;検索の応答は約80〜250ms程度と満足な早さ&lt;/h2&gt;

&lt;ul&gt;
&lt;li&gt;動作環境

&lt;ul&gt;
&lt;li&gt;マシン: MacBook Pro 15inch (Retina, Mid 2012) SSD&lt;/li&gt;
&lt;li&gt;CPU: Intel Core i7 2.6GHz&lt;/li&gt;
&lt;li&gt;RAM: 16GB 1600MHz DDR3&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;データサイズ

&lt;ul&gt;
&lt;li&gt;データファイルの合計サイズ: 188MB&lt;/li&gt;
&lt;li&gt;データ件数: 約193万件&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code&gt;$ du -sm ~/work/groonga/db
18848 /Users/hnakamur/work/groonga/db
$ echo &#39;select Articles --limit 0&#39; | groonga ~/work/groonga/db/wikipedia.db
[[0,1431434283.68242,0.00117397308349609],[[[1932736],[[&amp;quot;_id&amp;quot;,&amp;quot;UInt32&amp;quot;],[&amp;quot;_key&amp;quot;,&amp;quot;ShortText&amp;quot;],[&amp;quot;text&amp;quot;,&amp;quot;Text&amp;quot;],[&amp;quot;updated_at&amp;quot;,&amp;quot;Time&amp;quot;]]]]]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;JSON形式の検索APIの応答が約80〜250ms程度で、快適に検索できました。
Groongaすごいですね！&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Goでdeferの処理中のエラーを返す書き方を工夫してみた</title>
      <link>/blog/2015/04/27/write_function_for_go_defer/</link>
      <pubDate>Mon, 27 Apr 2015 02:06:02 +0900</pubDate>
      
      <guid>/blog/2015/04/27/write_function_for_go_defer/</guid>
      <description>&lt;p&gt;go-nutsのメーリングリストの記事
&lt;a href=&#34;https://groups.google.com/d/msg/golang-nuts/qTTBENO_Em0/Y4MCVZZ3c5sJ&#34;&gt;https://groups.google.com/d/msg/golang-nuts/qTTBENO_Em0/Y4MCVZZ3c5sJ&lt;/a&gt;
によるとdeferで呼ばれた関数の戻り値は捨てられるそうです。
&lt;a href=&#34;https://groups.google.com/d/msg/golang-nuts/qTTBENO_Em0/UlI77BM2PUkJ&#34;&gt;https://groups.google.com/d/msg/golang-nuts/qTTBENO_Em0/UlI77BM2PUkJ&lt;/a&gt;
で戻り値の変数に代入するという方法が紹介されていました。&lt;/p&gt;

&lt;p&gt;これを参考に、deferでの後処理でエラーが起きた時はそのエラーを返す、ただし複数のエラーが起きた時は最初のエラーを返したいというときの書き方を考えてみました。&lt;/p&gt;

&lt;p&gt;最初に書いたのは、上の記事で紹介されていたように無名関数を即時呼び出しする方式です。
&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/70aafdeb2eb754505efe60afa1ae6d995831a063/examples/add_record/main.go&#34;&gt;https://github.com/hnakamur/cgoroonga/blob/70aafdeb2eb754505efe60afa1ae6d995831a063/examples/add_record/main.go&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;func run() (err error) {
	err = grn.Init()
	if err != nil {
		return
	}
	defer func() {
		err2 := grn.Fin()
		if err2 != nil &amp;amp;&amp;amp; err == nil {
			err = err2
		}
	}()

	ctx, err := grn.CtxOpen(0)
	if err != nil {
		return
	}
	defer func() {
		err2 := ctx.Close()
		if err2 != nil &amp;amp;&amp;amp; err == nil {
			err = err2
		}
	}()

	var db *grn.Obj
	db, err = ctx.DBOpenOrCreate(&amp;quot;hello.db&amp;quot;, nil)
	if err != nil {
		return
	}
	defer func() {
		err2 := ctx.ObjClose(db)
		if err2 != nil &amp;amp;&amp;amp; err == nil {
			err = err2
		}
	}()

	keyType := ctx.At(grn.DB_SHORT_TEXT)
	table, err := ctx.TableOpenOrCreate(&amp;quot;table1&amp;quot;, &amp;quot;&amp;quot;,
		grn.OBJ_TABLE_HASH_KEY|grn.OBJ_PERSISTENT, keyType, nil)
	if err != nil {
		return
	}
	fmt.Printf(&amp;quot;table=%x\n&amp;quot;, table)
	defer func() {
		err2 := ctx.ObjClose(table)
		if err2 != nil &amp;amp;&amp;amp; err == nil {
			err = err2
		}
	}()
…(略)…
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;これでやりたいことは実現できているのですが、deferのところの行数が多すぎて読みにくいコードになっています。&lt;/p&gt;

&lt;p&gt;そこでこの部分を関数として定義するようにしてみました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/add_record/main.go&#34;&gt;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/add_record/main.go&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;func run() (err error) {
	err = grn.Init()
	if err != nil {
		return
	}
	defer grn.FinDefer(&amp;amp;err)

	ctx, err := grn.CtxOpen(0)
	if err != nil {
		return
	}
	defer ctx.CloseDefer(&amp;amp;err)

	var db *grn.Obj
	db, err = ctx.DBOpenOrCreate(&amp;quot;hello.db&amp;quot;, nil)
	if err != nil {
		return
	}
	defer ctx.ObjCloseDefer(&amp;amp;err, db)

	keyType := ctx.At(grn.DB_SHORT_TEXT)
	table, err := ctx.TableOpenOrCreate(&amp;quot;table1&amp;quot;, &amp;quot;&amp;quot;,
		grn.OBJ_TABLE_HASH_KEY|grn.OBJ_PERSISTENT, keyType, nil)
	if err != nil {
		return
	}
	fmt.Printf(&amp;quot;table=%x\n&amp;quot;, table)
	defer ctx.ObjCloseDefer(&amp;amp;err, table)
…(略)…
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;関数定義は例えば &lt;code&gt;FinDefer&lt;/code&gt; なら
&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/master/init.go#L25-L30&#34;&gt;https://github.com/hnakamur/cgoroonga/blob/master/init.go#L25-L30&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;func FinDefer(err *error) {
	err2 := Fin()
	if err2 != nil &amp;amp;&amp;amp; *err == nil {
		*err = err2
	}
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のようになります。他の関数も同様です。&lt;/p&gt;

&lt;p&gt;書き換えた &lt;code&gt;run()&lt;/code&gt; のほうが読みやすくていい感じです。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>データ登録用にgroongaのC APIのgoバインディングを書いてみた</title>
      <link>/blog/2015/04/27/cgoroonga/</link>
      <pubDate>Mon, 27 Apr 2015 00:44:23 +0900</pubDate>
      
      <guid>/blog/2015/04/27/cgoroonga/</guid>
      <description>

&lt;h2 id=&#34;groongaで大量のデータを登録する方法を調べてみた:bd398b25ed8a2de22905a814e81be387&#34;&gt;groongaで大量のデータを登録する方法を調べてみた&lt;/h2&gt;

&lt;h3 id=&#34;方法1-loadコマンドの文字列を組み立ててgroongaコマンドの標準入力に流し込む:bd398b25ed8a2de22905a814e81be387&#34;&gt;方法1: loadコマンドの文字列を組み立ててgroongaコマンドの標準入力に流し込む&lt;/h3&gt;

&lt;p&gt;groongaのデータの登録はチュートリアルの&lt;a href=&#34;http://groonga.org/ja/docs/tutorial/introduction.html#load-records&#34;&gt;データのロード&lt;/a&gt;にあるように&lt;a href=&#34;http://groonga.org/ja/docs/reference/commands/load.html&#34;&gt;loadコマンド&lt;/a&gt;を使えば出来ます。&lt;/p&gt;

&lt;p&gt;外部ファイルから大量のデータを登録するときはどうするのかなと思って調べてみると、 groongaのソースの examples/dictionary/eijiro/ の例では &lt;code&gt;load&lt;/code&gt; コマンドの文字列を組み立てて &lt;code&gt;groonga&lt;/code&gt; コマンドの標準入力に流し込んでいました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/groonga/groonga/blob/59ef5d1d26b4ba47d163019a21a20519d349489b/examples/dictionary/eijiro/eijiro-import.sh#L10-L12&#34;&gt;https://github.com/groonga/groonga/blob/59ef5d1d26b4ba47d163019a21a20519d349489b/examples/dictionary/eijiro/eijiro-import.sh#L10-L12&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;if iconv -f UCS2 -t UTF8 $2 | ${base_dir}/eijiro2grn.rb | groonga $1 &amp;gt; /dev/null; then
  echo &amp;quot;eijiro data loaded.&amp;quot;
fi
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;方法2-groongaのc-apiを使う:bd398b25ed8a2de22905a814e81be387&#34;&gt;方法2: groongaのC APIを使う&lt;/h3&gt;

&lt;p&gt;この方法はお手軽ですが、エラー処理が難しそうと重い、さらに調べてみると、groongaのC APIを使ってデータ登録する例を見つけました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;http://createfield.com/C%E8%A8%80%E8%AA%9E%E3%81%A7Groonga%E3%81%AEAPI%E3%82%92%E4%BD%BF%E3%81%86%E6%96%B9%E6%B3%95&#34;&gt;C言語でGroongaのAPIを使う方法 - CreateField&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&#34;go言語用のライブラリを作ってみました:bd398b25ed8a2de22905a814e81be387&#34;&gt;go言語用のライブラリを作ってみました&lt;/h2&gt;

&lt;p&gt;折角なのでCのライブラリのgo言語バインディングを作る練習を兼ねてgo言語用のライブラリを作ってみました。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hnakamur/cgoroonga&#34;&gt;hnakamur/cgoroonga&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&#34;テーブルとカラムを作ってレコードを1件登録するサンプルコード:bd398b25ed8a2de22905a814e81be387&#34;&gt;テーブルとカラムを作ってレコードを1件登録するサンプルコード&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/add_record/main.go&#34;&gt;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/add_record/main.go&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;OSX + homebrewという環境で試しました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;brew install groonga
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でgroongaをインストールして、以下の手順で実行します。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;go get github.com/hnakamur/cgoroonga
cd $GOPATH/src/github.com/hnakamur/cgoroonga/examples/add_record
go build
./add_record
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;wikipedia日本語版の記事データを登録するサンプルコード:bd398b25ed8a2de22905a814e81be387&#34;&gt;Wikipedia日本語版の記事データを登録するサンプルコード&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/import_wikipedia/main.go&#34;&gt;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/import_wikipedia/main.go&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;データファイルは
&lt;a href=&#34;http://dumps.wikimedia.org/jawiki/20150422/&#34;&gt;jawiki dump progress on 20150422&lt;/a&gt;
から以下の4つのファイルをダウンロードしました。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;jawiki-20150422-pages-articles1.xml.bz2&lt;/li&gt;
&lt;li&gt;jawiki-20150422-pages-articles2.xml.bz2&lt;/li&gt;
&lt;li&gt;jawiki-20150422-pages-articles3.xml.bz2&lt;/li&gt;
&lt;li&gt;jawiki-20150422-pages-articles4.xml.bz2&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Wikipediaのデータファイルはxmlをbzip2で圧縮した形式になっているので、Goの標準ライブラリの&lt;a href=&#34;http://golang.org/pkg/compress/bzip2/&#34;&gt;bzip2&lt;/a&gt;と&lt;a href=&#34;http://golang.org/pkg/encoding/xml/&#34;&gt;xml&lt;/a&gt;パッケージを使って読み込むようにしています。&lt;/p&gt;

&lt;p&gt;サイズの大きいXMLファイルを読み込んで処理するときにおすすめの方法が
&lt;a href=&#34;http://blog.davidsingleton.org/parsing-huge-xml-files-with-go/&#34;&gt;Parsing huge XML files with Go - david singleton&lt;/a&gt;で紹介されていたので、それを真似しました。ありがとうございます！&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd $GOPATH/src/github.com/hnakamur/cgoroonga/examples/import_wikipedia
go build
./import_wikipedia jawiki-20150422-pages-articles1.xml.bz2
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のように実行します。&lt;/p&gt;

&lt;h2 id=&#34;cライブラリのgoバインディングを書くときのtips:bd398b25ed8a2de22905a814e81be387&#34;&gt;Cライブラリのgoバインディングを書くときのtips&lt;/h2&gt;

&lt;p&gt;基本的には&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://golang.org/cmd/cgo/&#34;&gt;cgo - The Go Programming Language&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://github.com/golang/go/wiki/cgo&#34;&gt;cgo · golang/go Wiki&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;を読めばOKなのですが、ハマった点をメモしておきます。&lt;/p&gt;

&lt;h3 id=&#34;import-c-の上に空行を入れないように注意:bd398b25ed8a2de22905a814e81be387&#34;&gt;import &amp;ldquo;C&amp;rdquo;の上に空行を入れないように注意&lt;/h3&gt;

&lt;p&gt;たとえば
&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/column.go#L7&#34;&gt;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/column.go#L7&lt;/a&gt;
で &lt;code&gt;import &amp;quot;C&amp;quot;&lt;/code&gt; の上に空行を入れて &lt;code&gt;go build&lt;/code&gt; を実行すると以下の様なエラーになります。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ go build
# github.com/hnakamur/cgoroonga
could not determine kind of name for C.free
could not determine kind of name for C.grn_column_create
could not determine kind of name for C.grn_obj_column
could not determine kind of name for C.grn_obj_flags
could not determine kind of name for C.strlen
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;cのマクロはgoから呼べないのでcの関数でラップする:bd398b25ed8a2de22905a814e81be387&#34;&gt;Cのマクロはgoから呼べないのでCの関数でラップする&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/cgoroonga.c&#34;&gt;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/cgoroonga.c&lt;/a&gt;
のようにマクロをラップしたCの関数を書いて、それをgoから呼ぶようにします。&lt;/p&gt;

&lt;h3 id=&#34;エラーコードが有るエラーと無いエラーを統一的に扱うようにした:bd398b25ed8a2de22905a814e81be387&#34;&gt;エラーコードが有るエラーと無いエラーを統一的に扱うようにした&lt;/h3&gt;

&lt;p&gt;groongaのC APIはほとんどが&lt;a href=&#34;http://groonga.org/ja/docs/reference/api/grn_table.html&#34;&gt;7.20.21. grn_table — Groonga v5.0.2ドキュメント&lt;/a&gt;の &lt;a href=&#34;http://groonga.org/ja/docs/reference/api/grn_table.html#c.grn_table_delete&#34;&gt;grn_table_delete&lt;/a&gt;  のように &lt;a href=&#34;https://github.com/groonga/groonga/blob/v5.0.2/include/groonga/groonga.h#L44-L125&#34;&gt;grn_rc&lt;/a&gt; を返します。&lt;/p&gt;

&lt;p&gt;が、 &lt;a href=&#34;http://groonga.org/ja/docs/reference/api/grn_table.html#c.grn_table_create&#34;&gt;grn_table_create&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;grn_obj *grn_table_create(grn_ctx *ctx, const char *name, unsigned int name_size, const char *path, grn_obj_flags flags, grn_obj *key_type, grn_obj *value_type)
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のように &lt;code&gt;grn_rc&lt;/code&gt; を返さないAPIもあります。ドキュメントには明記されていませんが、Cの慣例としてエラーのときはおそらく戻り値が &lt;code&gt;NULL&lt;/code&gt; になるのだと予想します。&lt;/p&gt;

&lt;p&gt;&lt;a href=&#34;https://github.com/groonga/groonga/blob/v5.0.2/lib/db.c#L744-L930&#34;&gt;https://github.com/groonga/groonga/blob/v5.0.2/lib/db.c#L744-L930&lt;/a&gt; を見るとやはりNULLを返すケースが有りました。&lt;/p&gt;

&lt;p&gt;そこで、
&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/error.go&#34;&gt;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/error.go&lt;/a&gt;
のようにエラーコードが有るエラーと無いエラーを全てGoの変数として定義するようにしてみました。&lt;/p&gt;

&lt;p&gt;これにより
&lt;a href=&#34;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/import_wikipedia/main.go#L59-L63&#34;&gt;https://github.com/hnakamur/cgoroonga/blob/5eb6e092c4f6d53257b499cffacd51b8dd194ca3/examples/import_wikipedia/main.go#L59-L63&lt;/a&gt;&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;	table, err := ctx.TableOpenOrCreate(&amp;quot;Articles&amp;quot;, &amp;quot;&amp;quot;,
		grn.OBJ_TABLE_HASH_KEY|grn.OBJ_PERSISTENT, keyType, nil)
	if err != nil {
		return
	}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のようにエラーを常に戻り値で受け取るように統一することができ、見通しのよいコードが実現できました。&lt;/p&gt;

&lt;h2 id=&#34;まとめ:bd398b25ed8a2de22905a814e81be387&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;データ登録用にgroongaのC APIのgoバインディングを書きました。
C APIがエラーコードを返さない場合でもGo側ではエラーを返し &lt;code&gt;if err != nil&lt;/code&gt; というのようにエラーチェックの方式を統一することで、エラー処理の漏れに気づきやすくする事が出来ました。&lt;/p&gt;
</description>
    </item>
    
    <item>
      <title>Groongaのチュートリアルを試してみた</title>
      <link>/blog/2015/04/26/tried_groonga_tutorial/</link>
      <pubDate>Sun, 26 Apr 2015 23:53:06 +0900</pubDate>
      
      <guid>/blog/2015/04/26/tried_groonga_tutorial/</guid>
      <description>

&lt;p&gt;Groongaのチュートリアルを試してみたメモです。
試した環境は Groonga 5.0.2, Ubuntu 14.04.2 です。&lt;/p&gt;

&lt;h2 id=&#34;セットアップ手順:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;セットアップ手順&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://groonga.org/ja/docs/install/ubuntu.html#ppa-personal-package-archive&#34;&gt;2.4. Ubuntu — Groonga v5.0.2ドキュメント&lt;/a&gt;にそってセットアップしました。&lt;/p&gt;

&lt;p&gt;セットアップ手順は&lt;a href=&#34;https://github.com/hnakamur/groonga-dockerfiles/blob/b4d64e23eaf9afda47c31bc34794eb2e56b7614d/dockerfiles/trusty/Dockerfile&#34;&gt;Dockerfile&lt;/a&gt;にまとめておきました。&lt;/p&gt;

&lt;p&gt;さらにVirtualBox + VagrantでUbuntuにdockerとdocker-composeをインストールして、上のDockerfileでコンテナを作る手順を自動化するVagrantfileを作成して
&lt;a href=&#34;https://github.com/hnakamur/groonga-dockerfiles&#34;&gt;hnakamur/groonga-dockerfiles&lt;/a&gt;
で公開しています。&lt;/p&gt;

&lt;p&gt;VirtualBoxとVagrantをインストールしてあれば、以下の手順ですぐ試せます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;git clone https://github.com/hnakamur/groonga-dockerfiles
cd groonga-dockerfiles
vagrant up
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;起動後コンテナを作って起動するまでには結構時間がかかります。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ vagrant ssh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でVMにログインして、以下のようにCommandでgroonga-httpdが実行されたら起動完了です。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ cd /vagrant/dockerfiles
$ sudo docker-compose ps
      Name             Command             State              Ports
-------------------------------------------------------------------------
dockerfiles_groo   /usr/sbin          Up                 0.0.0.0:80-&amp;gt;1004
ngatrusty_1        /groonga-httpd                        1/tcp
                   -g ...
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;管理画面とgroongaコマンドの起動方法:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;管理画面とgroongaコマンドの起動方法&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://192.168.33.12/&#34;&gt;http://192.168.33.12/&lt;/a&gt; でgroongaの管理画面にアクセスできます。&lt;/p&gt;

&lt;p&gt;groongaコマンドの起動方法は以下の通りです。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vagrant ssh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でVMにログインし、&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo docker exec -it dockerfiles_groongatrusty_1 /bin/bash
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でコンテナ内に入り&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;sudo -u groonga groonga /var/lib/groonga/db/db
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でgroongaコマンドを実行します。&lt;/p&gt;

&lt;h3 id=&#34;groongaコマンドの実行ユーザをrootにするとハマるので注意:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;groongaコマンドの実行ユーザをrootにするとハマるので注意&lt;/h3&gt;

&lt;p&gt;groongaコマンドはgroongaで実行するのが重要です。&lt;/p&gt;

&lt;p&gt;rootユーザで実行してしまうとエラーにはならないのですが、テーブルなどを作成してもgroongaの管理画面で表示されずハマりました。&lt;/p&gt;

&lt;p&gt;groongaのデータベースは最初は1つのファイルですが、テーブルなどを作るとファイルが追加で作成されます。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;root@b95446c72160:/# cd /var/lib/groonga/db
root@b95446c72160:/var/lib/groonga/db# ll
total 15332
drwxr-xr-x 2 groonga groonga     4096 Apr 26 14:34 ./
drwxr-xr-x 3 groonga groonga     4096 Apr 26 01:49 ../
-rw-r--r-- 1 groonga groonga     4096 Apr 26 14:33 db
-rw-r--r-- 1 groonga groonga 21245952 Apr 26 14:33 db.0000000
-rw-r--r-- 1 groonga groonga 16842752 Apr 26 14:34 db.0000100
-rw-r--r-- 1 groonga groonga 12857344 Apr 26 14:26 db.0000101
-rw-r--r-- 1 groonga groonga  8437760 Apr 26 14:28 db.0000102
-rw-r--r-- 1 groonga groonga  1085440 Apr 26 14:28 db.0000103
-rw-r--r-- 1 groonga groonga  4198400 Apr 26 14:28 db.0000103.c
-rw-r--r-- 1 groonga groonga  8437760 Apr 26 14:34 db.0000104
-rw-r--r-- 1 groonga groonga  4198400 Apr 26 14:34 db.0000105
-rw-r--r-- 1 groonga groonga  1085440 Apr 26 14:34 db.0000106
-rw-r--r-- 1 groonga groonga  4198400 Apr 26 14:34 db.0000106.c
-rw-r--r-- 1 groonga groonga  1048576 Apr 26 14:34 db.001
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;rootユーザでgroongaコマンドを実行すると作成されたファイルの所有者がrootユーザになり、groonga-httpdから見えないようです。&lt;/p&gt;

&lt;p&gt;&lt;code&gt;chown groonga: /var/lib/groonga/db/db*&lt;/code&gt; で所有者をgroongaユーザに変更すれば見えるようになりました。&lt;/p&gt;

&lt;p&gt;ということで、上記のようにgroongaユーザでgroongaコマンドを実行するのが良いです。&lt;/p&gt;

&lt;h2 id=&#34;チュートリアルの一部手順でエラーが出てハマった:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;チュートリアルの一部手順でエラーが出てハマった&lt;/h2&gt;

&lt;p&gt;&lt;a href=&#34;http://groonga.org/ja/docs/tutorial.html&#34;&gt;4. チュートリアル — Groonga v5.0.2ドキュメント&lt;/a&gt;の手順で試してみました。ほとんどはすんなり実行できましたが、1箇所ハマりました。&lt;/p&gt;

&lt;h3 id=&#34;インデックス付きジオサーチのところでnonexistent-sourceというエラー:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;インデックス付きジオサーチのところでnonexistent sourceというエラー&lt;/h3&gt;

&lt;p&gt;&lt;a href=&#34;http://groonga.org/ja/docs/tutorial/index.html#geo-location-search-with-index&#34;&gt;4.6.3. インデックス付きジオサーチ&lt;/a&gt;のところで以下の様なエラーが出ました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt; table_create --name GeoIndex --flags TABLE_PAT_KEY --key_type WGS84GeoPoint
[[0,1429178015.01179,0.00191092491149902],true]
&amp;gt; column_create --table GeoIndex --name index_point --type Site --flags COLUMN_INDEX --source location
[[-22,1429178020.73797,0.00554323196411133,&amp;quot;[column][create] nonexistent source: &amp;lt;location&amp;gt;&amp;quot;,[[&amp;quot;proc_column_create_resolve_source_name&amp;quot;,&amp;quot;proc.c&amp;quot;,1774]]],false]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Siteテーブルは&lt;a href=&#34;http://groonga.org/ja/docs/tutorial/introduction.html#create-a-table&#34;&gt;4.1.5. テーブルの作成&lt;/a&gt;で&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;table_create --name Site --flags TABLE_HASH_KEY --key_type ShortText
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;として作成していますが、その後 &lt;code&gt;location&lt;/code&gt; カラムを作る箇所がなかったようです。&lt;/p&gt;

&lt;p&gt;2015-04-28追記 &lt;a href=&#34;https://twitter.com/kenhys/status/592901925089189889&#34;&gt;https://twitter.com/kenhys/status/592901925089189889&lt;/a&gt; でご指摘いただいたのですが、実は&lt;a href=&#34;http://groonga.org/ja/docs/tutorial/search.html#narrow-down-sort-by-using-location-information&#34;&gt;4.4.3. 位置情報を用いた絞込・ソート&lt;/a&gt;で &lt;code&gt;location&lt;/code&gt; カラムを作っているのを私が見落としていました。失礼いたしました。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;column_create --table Site --name location --type WGS84GeoPoint
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;のようにカラムを作成すれば大丈夫でした。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;table_create --name GeoIndex --flags TABLE_PAT_KEY --key_type WGS84GeoPoint
column_create --table GeoIndex --name index_point --type Site --flags COLUMN_INDEX --source location
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;でインデクス用のテーブルとカラムを作成して、&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;load --table Site
[
 {&amp;quot;_key&amp;quot;:&amp;quot;http://example.org/&amp;quot;,&amp;quot;location&amp;quot;:&amp;quot;128452975x503157902&amp;quot;},
 {&amp;quot;_key&amp;quot;:&amp;quot;http://example.net/&amp;quot;,&amp;quot;location&amp;quot;:&amp;quot;128487316x502920929&amp;quot;}
]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で、データをロードします。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;&amp;gt; select --table Site --filter &#39;geo_in_circle(location, &amp;quot;128515259x503187188&amp;quot;, 5000)&#39; --output_columns _key,location
[[0,1430061299.24235,0.00105690956115723],[[[1],[[&amp;quot;_key&amp;quot;,&amp;quot;ShortText&amp;quot;],[&amp;quot;location&amp;quot;,&amp;quot;WGS84GeoPoint&amp;quot;]],[&amp;quot;http://example.org/&amp;quot;,&amp;quot;128452975x503157902&amp;quot;]]]]
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;で検索できました。&lt;/p&gt;

&lt;h2 id=&#34;まとめ:f8779f2a67f29f8720bb9e60ed791493&#34;&gt;まとめ&lt;/h2&gt;

&lt;p&gt;2箇所ハマりましたが解決してとりあえず使えるようになりました。今後さらに調査していきたいと思います。&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>